---
title: "2023-02-02_b6d0a47294ac_jobs.py"
---

## High-level description
This code defines an Alembic migration script for creating two new database tables: `jobs_history` and `jobs`. These tables are designed to store information about job execution and scheduling within the MindsDB system.

## Code Structure
The code consists of two main functions: `upgrade()` and `downgrade()`. The `upgrade()` function creates the new tables, while the `downgrade()` function removes them. These functions are used by Alembic to manage database schema changes.

## Symbols

### `upgrade()`
#### Description
This function creates two new tables in the database: `jobs_history` and `jobs`.

#### Internal Logic
1. Creates the `jobs_history` table with columns for tracking job execution history.
2. Creates the `jobs` table with columns for storing job definitions and scheduling information.

### `downgrade()`
#### Description
This function removes the `jobs` and `jobs_history` tables from the database.

#### Internal Logic
1. Drops the `jobs` table.
2. Drops the `jobs_history` table.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| alembic | Database migration tool |
| sqlalchemy | SQL toolkit and ORM |
| mindsdb.interfaces.storage.db | Custom database interface for MindsDB |

## Table Definitions

### `jobs_history`
This table stores the execution history of jobs.

| Column | Type | Description |
|:-------|:-----|:------------|
| id | Integer | Primary key |
| company_id | Integer | Company identifier |
| job_id | Integer | Reference to the job |
| start_at | DateTime | Job start time |
| end_at | DateTime | Job end time |
| error | String | Error message, if any |
| created_at | DateTime | Record creation time |

The table has a unique constraint on `job_id` and `start_at` to prevent duplicate entries for the same job execution.

### `jobs`
This table stores job definitions and scheduling information.

| Column | Type | Description |
|:-------|:-----|:------------|
| id | Integer | Primary key |
| company_id | Integer | Company identifier |
| name | String | Job name |
| project_id | Integer | Associated project ID |
| query_str | String | Query to be executed |
| start_at | DateTime | Job start time |
| end_at | DateTime | Job end time |
| next_run_at | DateTime | Next scheduled run time |
| schedule_str | String | Job schedule definition |
| deleted_at | DateTime | Deletion timestamp |
| updated_at | DateTime | Last update timestamp |
| created_at | DateTime | Record creation time |

## Notes
- The migration script uses SQLAlchemy's `op` object to perform database operations, which provides a database-agnostic way to define schema changes.
- The `jobs_history` table includes a unique constraint to ensure that there's only one history entry per job start time.
- The `jobs` table includes fields for scheduling (e.g., `next_run_at`, `schedule_str`), which suggests that this system supports recurring or scheduled jobs.
- Both tables include timestamps for creation, updating, and (in the case of `jobs`) deletion, which is useful for auditing and managing the lifecycle of jobs.