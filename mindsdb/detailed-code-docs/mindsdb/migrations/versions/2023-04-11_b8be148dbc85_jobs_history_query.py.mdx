---
title: "2023-04-11_b8be148dbc85_jobs_history_query.py"
---

## High-level description
This code defines an Alembic migration script to modify the `jobs_history` table in a database. It adds two new columns: `query_str` to store query strings and `updated_at` to track when records are updated.

## Symbols

### `upgrade()`
#### Description
This function defines the changes to be applied to the database schema when upgrading to this revision.

#### Internal Logic
1. Uses `op.batch_alter_table()` to modify the `jobs_history` table.
2. Adds a new column `query_str` of type String.
3. Adds a new column `updated_at` of type DateTime with a default value of the current timestamp.

### `downgrade()`
#### Description
This function defines the changes to be applied to the database schema when downgrading from this revision.

#### Internal Logic
1. Uses `op.batch_alter_table()` to modify the `jobs_history` table.
2. Drops the `updated_at` column.
3. Drops the `query_str` column.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| alembic | Database migration tool used for managing schema changes |
| sqlalchemy | SQL toolkit and ORM used for database operations |
| mindsdb.interfaces.storage.db | Custom module, likely containing database-related code for MindsDB |

## Configuration
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| revision | string | 'b8be148dbc85' | Unique identifier for this migration |
| down_revision | string | 'ef04cdbe51ed' | Identifier of the previous migration |
| branch_labels | None | None | Used for branching in migration history |
| depends_on | None | None | Dependencies on other migrations |

## References
This migration script references the `jobs_history` table, which is likely defined in another part of the codebase. Based on the related code snippet, we can see that the `JobsHistory` class in `mindsdb/interfaces/storage/db.py` corresponds to this table:

```python
class JobsHistory(Base):
    __tablename__ = "jobs_history"
    id = Column(Integer, primary_key=True)
    company_id = Column(Integer)
    job_id = Column(Integer)
    query_str = Column(String)
    start_at = Column(DateTime)
    end_at = Column(DateTime)
    error = Column(String)
    created_at = Column(DateTime, default=datetime.datetime.now)
    updated_at = Column(DateTime, default=datetime.datetime.now)

    __table_args__ = (
        UniqueConstraint("job_id", "start_at", name="uniq_job_history_job_id_start"),
    )
```

This migration adds the `query_str` and `updated_at` columns to align with the ORM model definition.