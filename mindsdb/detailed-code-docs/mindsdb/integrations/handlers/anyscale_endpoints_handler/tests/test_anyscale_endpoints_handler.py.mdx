---
title: "test_anyscale_endpoints_handler.py"
---

## High-level description
This file contains integration tests for the Anyscale Endpoints AI engine in MindsDB. It tests various scenarios including model creation, sentiment analysis, and question answering using both single and bulk queries.

## Code Structure
The code defines a test class `TestAnyscaleEndpoints` that inherits from `BaseMLAPITest`. It contains multiple test methods that create models, execute queries, and verify the results.

## References
- `BaseMLAPITest` from `tests.unit.ml_handlers.base_ml_test`
- `pytest` for test execution and assertions
- `pandas` for data manipulation
- `unittest.mock.patch` for mocking

## Symbols

### TestAnyscaleEndpoints
#### Description
A test class that contains integration tests for the Anyscale Endpoints AI engine.

#### Internal Logic
1. Sets up the test environment by creating a project and an Anyscale Endpoints engine.
2. Defines multiple test methods to cover various scenarios:
   - Invalid model parameters
   - Invalid operation mode
   - Sentiment analysis (single and bulk)
   - Question answering (single and bulk)
3. Uses SQL queries to create models and execute predictions.
4. Verifies the results of predictions.

### setup_method
#### Description
Sets up the test environment by creating a project and an Anyscale Endpoints engine.

#### Internal Logic
1. Calls the parent class's `setup_method`.
2. Creates a database named "proj".
3. Creates an ML engine named "anyscale_endpoints_engine" using the Anyscale Endpoints integration and an API key.

### test_create_model_raises_exception_with_invalid_model_parameter
#### Description
Tests that an exception is raised when creating a model with an invalid model parameter.

#### Internal Logic
1. Attempts to create a model with a non-existent model name.
2. Expects an exception to be raised when waiting for the predictor.

### test_create_model_raises_exception_with_invalid_operation_mode
#### Description
Tests that an exception is raised when creating a model with an invalid operation mode.

#### Internal Logic
1. Attempts to create a model with an invalid mode parameter.
2. Expects an exception to be raised when waiting for the predictor.

### test_select_runs_no_errors_on_completion_sentiment_analysis_single
#### Description
Tests sentiment analysis for a single input using completion mode.

#### Internal Logic
1. Creates a sentiment analysis model.
2. Executes a query to predict sentiment for a single text input.
3. Asserts that the result contains "positive" sentiment.

### test_select_runs_no_errors_on_completion_sentiment_analysis_bulk
#### Description
Tests sentiment analysis for bulk inputs using completion mode.

#### Internal Logic
1. Creates a mock PostgreSQL handler with sample data.
2. Creates a sentiment analysis model.
3. Executes a query to predict sentiments for multiple text inputs.
4. Asserts that the results contain expected sentiments for each input.

### test_select_runs_no_errors_on_chat_completion_question_answering_single
#### Description
Tests question answering for a single input using chat completion mode.

#### Internal Logic
1. Creates a question answering model.
2. Executes a query to answer a single question.
3. Asserts that the answer contains the expected response.

### test_select_runs_no_errors_on_chat_completion_question_answering_bulk
#### Description
Tests question answering for bulk inputs using chat completion mode.

#### Internal Logic
1. Creates a mock PostgreSQL handler with sample questions.
2. Creates a question answering model.
3. Executes a query to answer multiple questions.
4. Asserts that the answers contain the expected responses for each question.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| os | Accessing environment variables |
| pytest | Test execution and assertions |
| pandas | Data manipulation for bulk tests |
| unittest.mock | Mocking PostgreSQL handler |

## TODOs
There is a commented-out test method `test_create_model_raises_exception_with_unknown_model_argument` that is intended to test the handling of unknown arguments during model creation. This test is currently disabled and should be uncommented once the handler is updated to handle unknown arguments.