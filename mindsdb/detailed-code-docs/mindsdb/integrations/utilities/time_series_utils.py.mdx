---
title: "time_series_utils.py"
---

## High-level description
This code implements utility functions for time series forecasting, including data transformation, frequency inference, model selection, and hierarchical reconciliation. It provides support for various forecasting libraries and handles different data formats and structures.

## Code Structure
The code defines several utility functions and classes that work together to support time series forecasting tasks. The main components include functions for data transformation, frequency inference, model selection, and hierarchical reconciliation. These functions are used by different forecasting handlers to prepare data, train models, and generate predictions.

## Symbols

### `transform_to_nixtla_df`
#### Description
Transforms dataframes into the specific format required by StatsForecast.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| df | DataFrame | Input dataframe |
| settings_dict | dict | Dictionary containing settings |
| exog_vars | list | List of exogenous variables |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| nixtla_df | DataFrame | Transformed dataframe |

#### Internal Logic
1. Copies the input dataframe
2. Resamples data for each group if necessary
3. Transforms group columns into a single unique_id column
4. Renames columns to match StatsForecast requirements
5. Ensures datetime format for the 'ds' column

### `get_results_from_nixtla_df`
#### Description
Transforms dataframes generated by StatsForecast back to their original format.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| nixtla_df | DataFrame | Input dataframe from StatsForecast |
| model_args | dict | Dictionary containing model arguments |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| return_df | DataFrame | Transformed dataframe in original format |

#### Internal Logic
1. Resets the index of the input dataframe
2. Handles group columns based on the model arguments
3. Renames columns to match the original format

### `infer_frequency`
#### Description
Infers the frequency of a time series from a given dataframe and time column.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| df | DataFrame | Input dataframe |
| time_column | str | Name of the time column |
| default | str | Default frequency if inference fails |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| inferred_freq | str | Inferred frequency |

#### Internal Logic
1. Attempts to infer frequency using pandas' infer_freq function
2. If that fails, calculates the most common time difference between consecutive dates
3. Returns the inferred frequency or the default if inference fails

### `get_model_accuracy_dict`
#### Description
Calculates accuracy for each model in the nixtla results dataframe.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| nixtla_results_df | DataFrame | Results dataframe from Nixtla |
| metric | function | Metric function to calculate accuracy |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| accuracy_dict | dict | Dictionary of model accuracies |

### `get_best_model_from_results_df`
#### Description
Gets the best model based on lowest error from a results dataframe with a column for each nixtla model.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| nixtla_results_df | DataFrame | Results dataframe from Nixtla |
| metric | function | Metric function to calculate accuracy |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| best_model | str | Name of the best performing model |

### `spec_hierarchy_from_list`
#### Description
Gets the hierarchy spec from the list of hierarchy columns.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| col_list | list | List of hierarchy columns |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| spec | list | Hierarchy specification |

### `get_hierarchy_from_df`
#### Description
Extracts hierarchy from the raw dataframe, using the provided spec and args.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| df | DataFrame | Input dataframe |
| model_args | dict | Dictionary containing model arguments |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| nixtla_df | DataFrame | Transformed dataframe for Nixtla |
| hier_df | DataFrame | Hierarchy matrix |
| hier_dict | dict | Hierarchy dictionary |

### `reconcile_forecasts`
#### Description
Reconciles forecast results according to the hierarchy.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| nixtla_df | DataFrame | Input dataframe |
| forecast_df | DataFrame | Forecast dataframe |
| hierarchy_df | DataFrame | Hierarchy matrix |
| hierarchy_dict | dict | Hierarchy dictionary |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| reconciled_df | DataFrame | Reconciled forecast dataframe |

### `get_results_from_reconciled_df`
#### Description
Formats the reconciled dataframe into a normal Nixtla results dataframe.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| reconciled_df | DataFrame | Reconciled forecast dataframe |
| hierarchy_df | DataFrame | Hierarchy matrix |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| results_df | DataFrame | Formatted results dataframe |

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| numpy | Numerical computations |
| pandas | Data manipulation and analysis |
| sklearn.metrics | Evaluation metrics |
| hierarchicalforecast | Hierarchical forecasting (optional) |

## Error Handling
The code includes basic error handling, such as checking for the availability of the optional `hierarchicalforecast` library and logging warnings when certain functions are called without the required dependencies.

## Performance Considerations
The code includes resampling and data transformation operations, which may impact performance for large datasets. The hierarchical reconciliation process may also be computationally intensive for complex hierarchies.