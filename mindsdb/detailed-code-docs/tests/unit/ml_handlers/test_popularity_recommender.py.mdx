---
title: "test_popularity_recommender.py"
---

## High-level description
This file contains unit tests for the popularity recommender model in a machine learning system. It specifically tests the creation, execution, and output of a popularity-based recommendation model using a mock PostgreSQL database and a sample dataset.

## Code Structure
The main class `TestPopularityRecommender` inherits from `BaseExecutorTest` and contains helper methods and a test method `test_popularity_handler`. The test method sets up a mock database, creates a model, and verifies the model's output.

## Symbols

### TestPopularityRecommender
#### Description
A test class that inherits from `BaseExecutorTest` to test the functionality of the popularity recommender model.

#### Internal Logic
1. Sets up a mock PostgreSQL database
2. Creates a project and a model
3. Executes the model
4. Verifies the model's output

### wait_predictor
#### Description
A helper method that waits for a predictor to complete its creation process.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| project | str | The project name |
| name | str | The model name |

#### Internal Logic
1. Polls the model status every 0.5 seconds
2. Checks if the model status is "complete" or "error"
3. Raises a RuntimeError if the model creation doesn't complete within 100 seconds

### run_sql
#### Description
A helper method that executes SQL commands and returns the result as a DataFrame.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| sql | str | The SQL command to execute |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | DataFrame | The result of the SQL command |

#### Internal Logic
1. Parses the SQL command
2. Executes the command using the command executor
3. Asserts that there's no error
4. Returns the result as a DataFrame if data is available

### test_popularity_handler
#### Description
The main test method that verifies the functionality of the popularity recommender model.

#### Internal Logic
1. Creates a project database
2. Sets up a mock PostgreSQL handler with sample data
3. Creates a popularity recommender model
4. Waits for the model to complete
5. Executes a JOIN query between the sample data and the model predictions
6. Verifies that the result is not empty
7. Checks that each user has the correct number of recommendations
8. Ensures that predictions are made for all unique user IDs in the sample data

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| unittest.mock | For mocking the PostgreSQL handler |
| mindsdb_sql | For parsing SQL queries |
| time | For implementing wait functionality |

## Error Handling
The code uses assertions to check for errors in SQL execution and to verify the correctness of the model's output.

## TODOs
The class is marked with a "wip" (work in progress) comment, indicating that it may be subject to further changes or additions.