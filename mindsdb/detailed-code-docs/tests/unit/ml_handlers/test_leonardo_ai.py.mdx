---
title: "test_leonardo_ai.py"
---

## High-level description
This file contains unit tests for the LeonardoAI integration in MindsDB. It tests various aspects of the LeonardoAI handler, including API key retrieval, model creation, error handling, and both single and bulk image generation queries.

## Code Structure
The main class `TestLeonardoAI` inherits from `BaseMLAPITest`. It contains several test methods that set up the test environment, create models, and execute queries to test different functionalities of the LeonardoAI integration.

## References
- `BaseMLAPITest` from `tests/unit/ml_handlers/base_ml_test.py`
- `mindsdb.integrations.handlers.postgres_handler.Handler` (mocked in the bulk test)

## Symbols

### TestLeonardoAI
#### Description
A test class for LeonardoAI integration testing. It inherits from `BaseMLAPITest` and includes methods to test various aspects of the LeonardoAI handler.

#### Internal Logic
The class sets up a test environment, creates a Leonardo AI engine, and runs various tests to check the functionality of the integration.

___

### get_api_key
#### Description
A static method that retrieves the Leonardo API key from environment variables.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| API key | str | The Leonardo API key |

___

### setup_method
#### Description
Sets up the test environment by creating a project and a Leonardo AI engine.

#### Internal Logic
1. Calls the parent class's setup method
2. Creates a database named "proj"
3. Creates a Leonardo AI engine using the API key

___

### test_invalid_model_parameter
#### Description
Tests the behavior when an invalid model parameter is provided.

#### Internal Logic
1. Creates a model with an invalid model parameter
2. Attempts to wait for the predictor and expects an exception to be raised

___

### test_unknown_model_argument
#### Description
Tests the behavior when an unknown argument is provided when creating a Leonardo model.

#### Internal Logic
1. Creates a model with an unknown argument
2. Attempts to wait for the predictor and expects an exception to be raised

___

### test_single_qa
#### Description
Tests single image generation using the Leonardo AI model.

#### Internal Logic
1. Creates a Leonardo AI model
2. Waits for the predictor to be ready
3. Executes a query to generate a single image
4. Asserts that the result contains the expected keyword

___

### test_bulk_qa
#### Description
Tests bulk image processing using the Leonardo AI model.

#### Internal Logic
1. Mocks the Postgres handler
2. Creates a test dataframe with prompts
3. Creates a Leonardo AI model
4. Waits for the predictor to be ready
5. Executes a query to generate multiple images
6. Asserts that the results contain the expected keywords

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| pytest | Testing framework |
| pandas | Data manipulation |
| unittest.mock | Mocking for tests |

## Error Handling
The tests use `pytest.raises(Exception)` to check for expected exceptions when invalid parameters or arguments are provided.

## TODOs
None present in the code.