---
title: "test_writer.py"
---

## High-level description
This file contains unit tests for the Writer integration in MindsDB. It tests various scenarios including error handling, configuration validation, and functionality of the Writer handler.

## Code Structure
The code defines a `TestWriter` class that inherits from `BaseExecutorTest`. It contains multiple test methods that check different aspects of the Writer integration, such as handling missing arguments, unsupported configurations, and actual question-answering functionality.

## Symbols

### TestWriter
#### Description
A test class that contains various test methods for the Writer integration in MindsDB.

#### Internal Logic
The class sets up the testing environment, executes SQL commands, and verifies the results. It uses environment variables for API key and organization ID.

### wait_predictor
#### Description
A helper method that waits for a predictor to be created and completed.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| project | str | The project name |
| name | str | The predictor name |

#### Internal Logic
It polls the status of the predictor every 0.5 seconds for up to 100 seconds (200 attempts). It checks if the status is "complete" or "error" and raises a RuntimeError if the predictor isn't created within the time limit.

### run_sql
#### Description
A helper method that executes SQL commands and returns the result as a DataFrame.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| sql | str | The SQL command to execute |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | DataFrame | The result of the SQL command |

### test_missing_required_keys
#### Description
Tests the behavior when required configuration keys are missing.

#### Internal Logic
1. Creates a database
2. Attempts to create a model without required arguments
3. Expects an exception to be raised

### test_unsupported_vector_store
#### Description
Tests the behavior when an unsupported vector store is specified.

#### Internal Logic
1. Creates a database
2. Attempts to create a model with an unsupported vector store
3. Expects an exception to be raised

### test_unknown_arguments
#### Description
Tests the behavior when unknown arguments are provided in the model creation.

#### Internal Logic
1. Creates a database
2. Attempts to create a model with an unknown argument
3. Expects an exception to be raised

### test_qa
#### Description
Tests the question-answering functionality of the Writer integration.

#### Internal Logic
1. Creates a database and sets up mock data
2. Creates a model using the Writer engine
3. Waits for the predictor to be ready
4. Executes a question-answering query
5. Asserts that the answer contains the expected keyword

Note: This test is marked as expected to fail due to a potential bug in the mock handler.

### test_invalid_prompt_template
#### Description
Tests the behavior when an invalid prompt template is provided.

#### Internal Logic
1. Creates a database
2. Attempts to create a model with an invalid prompt template
3. Expects an exception to be raised

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| os | For accessing environment variables |
| time | For implementing wait functionality |
| unittest.mock | For mocking the Postgres handler |
| pandas | For working with DataFrames |
| pytest | For test assertions and decorators |
| mindsdb_sql | For parsing SQL queries |

## Configuration
The tests use environment variables for configuration:
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| WRITER_API_KEY | str | None | API key for Writer service |
| WRITER_ORG_ID | str | None | Organization ID for Writer service |

## Error Handling
The tests use pytest's exception handling to check for expected errors in various scenarios, such as missing required keys, unsupported configurations, and invalid inputs.

## TODOs
There is a known issue with the `test_qa` method, which is marked with `@pytest.mark.xfail`. The comment suggests there might be a bug in the mock handler when running inner queries.