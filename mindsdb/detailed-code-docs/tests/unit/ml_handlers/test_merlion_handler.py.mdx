---
title: "test_merlion_handler.py"
---

## High-level description
This file contains unit tests for the Merlion handler in MindsDB. It tests various forecasting and anomaly detection models provided by the Merlion library, including both direct API calls and SQL-based interactions through MindsDB.

## Code Structure
The main class `TestMerlion` inherits from `BaseExecutorTest` and contains multiple test methods for different forecasting and anomaly detection models. It also includes helper methods for data preparation, SQL execution, and waiting for model training completion.

## Symbols

### TestMerlion
#### Description
A test class that contains various unit tests for the Merlion handler in MindsDB.

#### Internal Logic
1. Sets up a project in the database.
2. Prepares datasets for forecasting (M4 dataset) and anomaly detection (NAB dataset).
3. Tests different forecasting models (Default, SARIMA, Prophet, MSES) using direct API calls.
4. Tests forecasting models using SQL commands through MindsDB.
5. Tests different anomaly detection models (Isolation Forest, WindStats, Prophet) using direct API calls.
6. Tests anomaly detection models using SQL commands through MindsDB.

### set_project
#### Description
Sets up a 'mindsdb' project in the database.

### get_m4_df
#### Description
Retrieves and prepares the M4 dataset for forecasting tests.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| df | pd.DataFrame | Prepared M4 dataset |

### get_nab_df
#### Description
Retrieves and prepares the NAB dataset for anomaly detection tests.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| df | pd.DataFrame | Prepared NAB dataset |

### run_mindsdb_sql
#### Description
Executes a SQL command using MindsDB's command executor.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| sql | str | SQL command to execute |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | object | Result of the SQL execution |

### test_merlion_forecaster
#### Description
Tests various forecasting models (Default, SARIMA, Prophet, MSES) using direct API calls.

### test_merlion_forecaster_sql
#### Description
Tests forecasting models using SQL commands through MindsDB.

### exec_train_and_forecast
#### Description
Executes the training and forecasting process for a given model using SQL commands.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| mock_handler | MagicMock | Mocked PostgreSQL handler |
| model_name | str | Name of the model to test |
| using | str | Additional parameters for the model |

### test_merlion_detector
#### Description
Tests various anomaly detection models (Isolation Forest, WindStats, Prophet) using direct API calls.

### test_merlion_detector_sql
#### Description
Tests anomaly detection models using SQL commands through MindsDB.

### exec_train_and_detect
#### Description
Executes the training and anomaly detection process for a given model using SQL commands.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| mock_handler | MagicMock | Mocked PostgreSQL handler |
| model_name | str | Name of the model to test |
| using_model | str | Additional parameters for the model |

### wait_training
#### Description
Waits for the completion of model training.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| model_name | str | Name of the model to wait for |

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| unittest.mock | Used for mocking the PostgreSQL handler |
| pandas | Used for data manipulation and analysis |
| mindsdb_sql | Used for parsing SQL queries |
| mindsdb.integrations.handlers.merlion_handler.adapters | Provides various forecasting and anomaly detection model adapters |

## Error Handling
The code uses assertions to check for expected outcomes in the test cases. If an assertion fails, it will raise an AssertionError.

## TODOs
There are no explicit TODOs in the code, but it's worth noting that only a subset of the available models are tested in the SQL-based tests (DefaultForecaster for forecasting and IsolationForest for anomaly detection). Future improvements could include testing more models using SQL commands.