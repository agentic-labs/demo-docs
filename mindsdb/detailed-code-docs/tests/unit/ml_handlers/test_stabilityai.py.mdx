---
title: "test_stabilityai.py"
---

## High-level description
This file contains unit tests for the Stability AI integration in MindsDB. It tests various scenarios of creating and using a Stability AI model, including handling invalid parameters, missing arguments, and performing text-to-image generation tasks.

## Code Structure
The main class `TestStabilityAI` inherits from `BaseMLAPITest` and contains several test methods. Each test method focuses on a specific scenario, such as invalid model parameters, missing task arguments, or text-to-image generation.

## Symbols

### TestStabilityAI
#### Description
A test class for Stability AI integration testing. It inherits from `BaseMLAPITest` and includes setup methods and various test cases.

#### Internal Logic
1. Sets up a test environment by creating a database and ML engine.
2. Tests various scenarios including invalid parameters, missing arguments, and text-to-image generation.
3. Uses SQL queries to create models and retrieve results.
4. Utilizes pytest for test assertions and exception handling.

### setup_method
#### Description
Sets up the test environment by creating a database and ML engine for Stability AI.

#### Internal Logic
1. Calls the parent class's setup method.
2. Creates a database named "proj".
3. Creates an ML engine named "stability_engine" using the Stability AI API key.

### test_invalid_model_parameter
#### Description
Tests the behavior when an invalid Stability AI model parameter is provided.

#### Internal Logic
1. Attempts to create a model with an invalid engine_id.
2. Expects an exception to be raised when waiting for the predictor.

### test_missing_task_argument
#### Description
Tests the behavior when the required 'task' argument is missing during model creation.

#### Internal Logic
1. Attempts to create a model without specifying the 'task' argument.
2. Expects an exception to be raised when waiting for the predictor.

### test_unknown_task_argument
#### Description
Tests the behavior when an unknown task argument is provided during model creation.

#### Internal Logic
1. Attempts to create a model with an unknown task value.
2. Expects an exception to be raised when waiting for the predictor.

### test_text_image_single
#### Description
Tests the text-to-image generation for a single text input.

#### Internal Logic
1. Creates a model for text-to-image generation.
2. Waits for the predictor to be ready.
3. Runs a SQL query to generate an image for the text "A blue lagoon".
4. Asserts that the result contains one answer.

### test_bulk_text
#### Description
Tests the text-to-image generation for multiple text inputs.

#### Internal Logic
1. Mocks a PostgreSQL handler with a DataFrame containing multiple text inputs.
2. Creates a model for text-to-image generation.
3. Waits for the predictor to be ready.
4. Runs a SQL query to generate images for all text inputs.
5. Asserts that the result contains two answers.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| pytest | Testing framework |
| pandas | Data manipulation and analysis |
| unittest.mock | Mocking objects for testing |

## Configuration
The tests rely on the presence of a Stability AI API key in the environment variables. The tests are skipped if the API key is not available.

| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| STABILITY_API_KEY | str | None | API key for Stability AI |

## Error Handling
The tests use pytest's `raises` context manager to check for expected exceptions in certain scenarios, such as invalid parameters or missing arguments.

Your response should not exceed 3000 words or 4000 tokens. Focus on providing clear, concise information that can be directly inferred from the code. Include optional sections only when they provide significant value for understanding the code.