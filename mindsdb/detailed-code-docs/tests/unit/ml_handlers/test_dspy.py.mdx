---
title: "test_dspy.py"
---

## High-level description
This file contains unit tests for the DSPy integration in MindsDB. It tests the functionality of creating and using ML models with DSPy, specifically focusing on conversational models using OpenAI's GPT models.

## Code Structure
The main class `TestDSPy` inherits from `BaseExecutorTest` and contains test methods for different scenarios of using DSPy with OpenAI models. The tests create ML engines, models, and execute queries to verify the model's responses.

## Symbols

### `ollama_model_exists`
#### Description
This function checks if a specific Ollama model exists.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| model_name | str | The name of the Ollama model to check |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| exists | bool | True if the model exists, False otherwise |

#### Internal Logic
The function uses the `ollama.show()` method to check if the model exists. If an exception is raised, it returns False, indicating the model doesn't exist.

### `TestDSPy`
#### Description
This class contains unit tests for DSPy integration in MindsDB.

#### Internal Logic
The class sets up the test environment, creates a database, and defines test methods for different scenarios.

### `TestDSPy.setup_method`
#### Description
This method sets up the test environment before each test method is run.

#### Internal Logic
It calls the parent class's `setup_method` and creates a new database named "proj".

### `TestDSPy.test_default_provider`
#### Description
This test method checks the functionality of creating and using a DSPy model with OpenAI's GPT-4.

#### Internal Logic
1. Creates a DSPy ML engine with OpenAI API key.
2. Creates a conversational model using the engine.
3. Waits for the predictor to be ready.
4. Executes a query to get an answer from the model.
5. Asserts that the answer contains "stockholm" (case-insensitive).

### `TestDSPy.test_default_provider2`
#### Description
This test method is similar to `test_default_provider` but uses GPT-3.5-turbo instead of GPT-4.

#### Internal Logic
1. Creates a DSPy ML engine with OpenAI API key.
2. Creates a conversational model using the engine with GPT-3.5-turbo.
3. Waits for the predictor to be ready.
4. Executes a query to get an answer for a simple math question.
5. Asserts that the answer contains "7".

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| os | Accessing environment variables |
| ollama | Checking for Ollama model existence |
| pytest | Test framework and decorators |
| BaseExecutorTest | Base class for executor tests |

## Error Handling
The tests use `pytest.mark.skipif` to skip tests if the OpenAI API key is not available in the environment variables.

## TODOs
There are no explicit TODOs in the code.