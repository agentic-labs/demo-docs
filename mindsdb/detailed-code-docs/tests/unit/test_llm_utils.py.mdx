---
title: "test_llm_utils.py"
---

## High-level description
This file contains unit tests for various utility functions related to LLM (Large Language Model) operations, particularly focusing on data formatting and validation for fine-tuning tasks. The tests cover functions for chat formatting, JSON validation, code formatting, and question-answer formatting.

## Code Structure
The code is structured as a single test class `TestLLM` that inherits from `unittest.TestCase`. It contains multiple test methods, each focusing on a specific utility function from the `mindsdb.integrations.libs.llm.utils` module.

## Symbols

### TestLLM
#### Description
A test class that contains various unit tests for LLM utility functions.

#### Internal Logic
The class sets up test data in the `setUpClass` method and defines multiple test methods to verify the functionality of different LLM utility functions.

### test_get_completed_prompts
#### Description
Tests the `get_completed_prompts` function, which generates formatted prompts from a template and a DataFrame.

#### Internal Logic
1. Sets up a placeholder and prefix for the prompt template.
2. Creates a DataFrame with user inputs.
3. Calls `get_completed_prompts` with the template and DataFrame.
4. Asserts that the function correctly detects missing values and generates the expected prompts.
5. Tests an edge case with an invalid template.

### test_ft_chat_format_validation
#### Description
Tests the `ft_chat_format_validation` function, which validates the format of chat data for fine-tuning.

#### Internal Logic
1. Iterates through valid chat examples and asserts that they pass validation.
2. Iterates through invalid chat examples and asserts that they raise exceptions.

### test_ft_chat_formatter
#### Description
Tests the `ft_chat_formatter` function, which formats chat data for fine-tuning.

#### Internal Logic
1. Tests formatting with a DataFrame containing required columns (role and content).
2. Tests formatting with additional chat_id column.
3. Tests formatting with both chat_id and message_id columns.
4. Tests formatting with JSON format input.

### test_ft_jsonl_validation
#### Description
Tests the `ft_jsonl_validation` function, which validates the format of JSONL data for fine-tuning.

#### Internal Logic
1. Creates a valid chat format using `ft_chat_formatter`.
2. Asserts that valid data passes validation without raising an exception.
3. Modifies the data to be invalid and asserts that it raises an exception.

### test_ft_code_formatter
#### Description
Tests the `ft_code_formatter` function, which formats code data for fine-tuning.

#### Internal Logic
1. Creates a DataFrame with a code column containing Python code.
2. Calls `ft_code_formatter` with different format options (chat and fim).
3. Asserts that the resulting DataFrame has the expected structure and content.

### test_ft_cqa_formatter
#### Description
Tests the `ft_cqa_formatter` function, which formats context-question-answer data for fine-tuning.

#### Internal Logic
1. Creates a DataFrame with instruction, context, question, and answer columns.
2. Calls `ft_cqa_formatter` with the DataFrame.
3. Asserts that the resulting DataFrame has the expected structure and content.

## Dependencies
The test file depends on the following modules:
| Dependency | Purpose |
|:-----------|:--------|
| unittest | Provides the testing framework |
| textwrap | Used for text manipulation in test data |
| pandas | Used for creating and manipulating DataFrames |
| mindsdb.integrations.libs.llm.utils | Contains the utility functions being tested |

This test suite ensures that the LLM utility functions in the MindsDB project are working correctly, particularly for tasks related to fine-tuning and data formatting for various LLM operations.