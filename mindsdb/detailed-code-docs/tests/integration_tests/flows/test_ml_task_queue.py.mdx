---
title: "test_ml_task_queue.py"
---

## High-level description
This file contains integration tests for the ML task queue functionality in MindsDB. It tests the creation of models, prediction, and fine-tuning using a Redis-based task queue system. The tests ensure that the ML tasks are properly queued, executed, and their statuses are correctly updated.

## Code Structure
The main test class `TestMLTaskQueue` inherits from `HTTPHelperMixin`, which provides utility methods for making HTTP requests and handling SQL queries. The tests use fixtures for Redis, PostgreSQL, and the MindsDB application.

## Symbols

### TestMLTaskQueue
#### Description
A test class that contains integration tests for the ML task queue functionality.

#### Internal Logic
1. `test_redis_connection`: Verifies the Redis connection.
2. `test_create_model`: Tests the creation of ML models in both async and sync modes.
3. `test_predict`: Tests prediction queries on the trained models.
4. `test_finetune`: Tests the fine-tuning of existing models.

### test_redis_connection
#### Description
Verifies that the Redis connection is working properly.

#### Internal Logic
1. Creates a Redis database connection.
2. Pings the database to ensure connectivity.

### test_create_model
#### Description
Tests the creation of ML models in both asynchronous and synchronous modes.

#### Internal Logic
1. Creates a PostgreSQL database connection.
2. Creates a test dataset.
3. Starts training a model in async mode and checks its status.
4. Starts training a model in sync mode and checks its status.
5. Waits for the async model to finish training.
6. Verifies that the Redis stream is empty after task completion.

### test_predict
#### Description
Tests prediction queries on the trained models.

#### Internal Logic
1. Executes prediction queries on both async and sync models.
2. Verifies the response structure and data.
3. Checks that the Redis stream is empty after predictions.

### test_finetune
#### Description
Tests the fine-tuning of existing models.

#### Internal Logic
1. Initiates fine-tuning for both async and sync models.
2. Checks the status of fine-tuning operations.
3. Waits for the async model to complete fine-tuning.
4. Verifies that the Redis stream is empty after fine-tuning.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| pytest | Testing framework |
| walrus | Redis client library |
| mindsdb | MindsDB library |

## Configuration
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| OVERRIDE_CONFIG | dict | See code | Configuration overrides for MindsDB |
| ML_TASK_QUEUE_CONSUMER | bool | True | Enables ML task queue consumer |
| API_LIST | list | ["http"] | List of API types to test |

## Error Handling
The tests use assertions to check for expected outcomes. If any assertion fails, the test will raise an AssertionError.

## API/Interface Reference
| Endpoint | Method | Request | Response | Description |
|:---------|:-------|:--------|:---------|:------------|
| /sql/query | POST | SQL query | JSON response | Executes SQL queries |

The tests primarily interact with MindsDB through SQL queries sent via HTTP requests.