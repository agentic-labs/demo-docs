---
title: "render-async-node.spec.tsx"
---

## High-level description
This file contains unit tests for the `renderAsync` function in a Node.js environment. It tests the function's ability to render React components into HTML and plain text, handle Suspense boundaries, and work with mocked React DOM server APIs.

## Code Structure
The file consists of a single `describe` block containing multiple test cases (`it` blocks) that cover different aspects of the `renderAsync` function's behavior.

## References
- `renderAsync` function from "./render-async"
- `Template` component from "../shared/utils/template"
- `Preview` component from "../shared/utils/preview"
- `usePromise` from "react-promise-suspense"
- `Suspense` from "react"

## Symbols

### `describe("renderAsync on node environments", ...)`
#### Description
This is the main test suite for the `renderAsync` function in Node.js environments.

#### Internal Logic
The suite contains multiple test cases that cover different scenarios and functionalities of the `renderAsync` function.

### `it("converts a React component into HTML with Next 14 error stubs", ...)`
#### Description
This test case mocks the `react-dom/server` module to simulate Next.js 14 error behavior and checks if `renderAsync` can still render HTML correctly.

#### Internal Logic
1. Mocks `react-dom/server` to throw errors for legacy APIs.
2. Calls `renderAsync` with a `Template` component.
3. Asserts that the output matches the expected HTML snapshot.

### `it("that it properly waits for Suepsense boundaries to resolve before resolving", ...)`
#### Description
This test case verifies that `renderAsync` correctly handles Suspense boundaries and waits for them to resolve before completing the rendering.

#### Internal Logic
1. Defines an `EmailTemplate` component that uses `usePromise` to fetch content.
2. Wraps `EmailTemplate` in a `Suspense` boundary.
3. Calls `renderAsync` with the wrapped component.
4. Asserts that the rendered output matches the expected snapshot.

### `it("converts a React component into HTML", ...)`
#### Description
This test case checks if `renderAsync` correctly converts a React component into HTML.

#### Internal Logic
1. Calls `renderAsync` with a `Template` component.
2. Asserts that the output matches the expected HTML snapshot.

### `it("converts a React component into PlainText", ...)`
#### Description
This test case verifies that `renderAsync` can convert a React component into plain text when the `plainText` option is set to `true`.

#### Internal Logic
1. Calls `renderAsync` with a `Template` component and `{ plainText: true }` option.
2. Asserts that the output matches the expected plain text snapshot.

### `it("converts to plain text and removes reserved ID", ...)`
#### Description
This test case checks if `renderAsync` correctly converts to plain text and removes elements with reserved IDs.

#### Internal Logic
1. Calls `renderAsync` with a `Preview` component and `{ plainText: true }` option.
2. Asserts that the output matches the expected plain text snapshot, which should not include the content of the element with the reserved ID.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| react-promise-suspense | Used for handling asynchronous operations in React components |
| react | Used for React components and Suspense |
| vitest | Testing framework (implied by the use of `vi` and `describe`/`it` syntax) |

## Error Handling
The tests include error handling scenarios, particularly in the first test case where legacy React DOM server APIs are mocked to throw errors.

Your response should not exceed 3000 words or 4000 tokens. Focus on providing clear, concise information that can be directly inferred from the code. Include optional sections only when they provide significant value for understanding the code.