---
title: "start-dev-server.ts"
---

## High-level description
This code implements a development server for React Email, providing functionality to start a server, handle requests, and manage hot reloading. It uses Next.js for rendering and includes error handling, logging, and configuration options.

## Code Structure
The main function `startDevServer` sets up an HTTP server, configures Next.js, and handles various server events. It also includes utility functions for safe server listening and error handling. The code interacts with other modules for static file serving, environment variable setup, and logging.

## Symbols

### `startDevServer`
#### Description
Starts a development server for React Email preview.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| emailsDirRelativePath | string | Relative path to the emails directory |
| staticBaseDirRelativePath | string | Relative path to the static base directory |
| port | number | Port number to run the server on |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| devServer | http.Server | The created HTTP server instance |

#### Internal Logic
1. Creates an HTTP server with request handling logic.
2. Attempts to listen on the specified port, retrying with the next port if it's in use.
3. Sets up Next.js for rendering.
4. Configures environment variables for the preview app.
5. Prepares the Next.js app and handles requests.
6. Logs server information and readiness.

### `safeAsyncServerListen`
#### Description
Safely attempts to start the server on a given port, handling potential "address in use" errors.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| server | http.Server | The HTTP server instance |
| port | number | Port number to listen on |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | Promise&lt;{ portAlreadyInUse: boolean }&gt; | Indicates if the port is already in use |

### `makeExitHandler`
#### Description
Creates an exit handler function to gracefully shut down the server on various process events.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| options | Object | Configuration options for the exit handler |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| exitHandler | Function | The created exit handler function |

## Side Effects
- Modifies `process.env` to set environment variables for the preview app.
- Sets up process event listeners for graceful shutdown.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| next | Used for rendering and handling requests |
| ora | Provides a terminal spinner for visual feedback |
| chalk | Used for colorful console output |
| log-symbols | Provides symbols for logging |

## Configuration
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| isDev | boolean | Determined at runtime | Indicates if running in development mode |

## Error Handling
The code includes error handling for server startup, request processing, and graceful shutdown. It uses `try-catch` blocks and event listeners to manage potential errors.

## Logging
The code uses `console.log` and `console.error` for basic logging. It also employs the `ora` library for displaying a loading spinner during server preparation.

Your response should not exceed 3000 words or 4000 tokens. Focus on providing clear, concise information that can be directly inferred from the code. Include optional sections only when they provide significant value for understanding the code.