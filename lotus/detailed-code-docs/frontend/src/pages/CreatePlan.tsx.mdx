---
title: "CreatePlan.tsx"
---

## High-level description
The `CreatePlan` component is responsible for rendering a form that allows users to create new pricing plans. It handles the collection of plan information, version information, charges, features, and discounts, and submits the data to the API to create the plan. The component also manages the display of modals for adding and editing components, features, and recurring charges.

## Code Structure
The `CreatePlan` component uses a multi-step form approach, with each step represented by an object in the `STEPS` array. Each step object defines the title, slug, component to render, and validation function for that step. The component uses the `currentStep` state variable to track the current step in the form and renders the corresponding component. The `Form` component from Ant Design is used to manage the form data and validation.

## References
- `Plan` API: Used to fetch existing plans, create new plans, and manage plan versions.
- `Organization` API: Used to fetch available currencies and the default currency for the organization.
- `Metrics` API: Used to fetch available metrics for usage-based components.
- `Features` API: Used to fetch existing features and create new features.

## Symbols

### `CreatePlan`
#### Description
This function is the main component for creating a new pricing plan. It handles the form submission, state management, and rendering of the multi-step form.

#### Inputs
This function does not have any explicit inputs.

#### Outputs
This function does not have any explicit outputs. It renders the multi-step form for creating a new pricing plan.

#### Internal Logic
1. **Initialization:**
    - Fetches existing plans and available currencies from the API.
    - Sets the default currency based on the organization's settings.
    - Initializes state variables for managing the form, modals, and plan data.
2. **Form Rendering:**
    - Renders a multi-step form using the `STEPS` array.
    - Each step is represented by a component that collects specific plan information.
    - The `BreadCrumbs` component displays the current step and allows navigation between steps.
3. **Form Validation:**
    - Each step component has a validation function that is called when the form data changes.
    - The `isCurrentStepValid` state variable is updated based on the validation result.
4. **Form Submission:**
    - When the user clicks the "Publish" button, the form data is validated.
    - If valid, the data is transformed into the required format for the API request.
    - The `createPlan` API call is made to create the new plan.
    - On success, a success message is displayed, and the user is redirected to the plans page.
    - On error, an error message is displayed.
5. **Modal Management:**
    - The component manages the display of modals for adding and editing components, features, and recurring charges.
    - State variables are used to track the visibility of each modal and the data being edited.

#### Side Effects
- Modifies the application state by updating the plan data, modal visibility, and current step.
- Makes API calls to fetch and create plan data.
- Redirects the user to the plans page after successful plan creation.

## Dependencies
- Ant Design: Used for UI components such as forms, buttons, modals, and tables.
- React: Used for building the component and managing its state.
- React Router DOM: Used for navigation between pages.
- React Query: Used for managing API requests and caching data.
- React Toastify: Used for displaying toast notifications.
- Moment: Used for date and time formatting.

## Error Handling
The component uses basic exception handling for API calls and form validation. Error messages are displayed using toast notifications.

## API/Interface Reference
The component interacts with the following API endpoints:
- `/app/plans/`: Used to fetch existing plans and create new plans.
- `/app/organizations/`: Used to fetch available currencies and the default currency.
- `/app/metrics/`: Used to fetch available metrics for usage-based components.
- `/app/features/`: Used to fetch existing features and create new features.

## TODOs
- The code contains a `@ts-expect-error` comment related to the `transition_to_plan_id` field. This needs to be addressed by fixing the type mismatch.
- The code has commented-out sections related to separate properties and proration granularity. These features may need to be implemented in the future.
