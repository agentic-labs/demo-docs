---
title: "test_metrics.py"
---

Here's a high-level description and documentation of the target file:

## High-level description

This file contains a set of unit tests for the metrics functionality in the metering_billing application. It tests various aspects of metric creation, calculation, and usage across different metric types (counter, gauge, rate, custom) and scenarios (with filters, different granularities, etc.).

## Code Structure

The file is organized into several test classes, each focusing on a specific aspect of metric functionality:

1. TestInsertMetric: Tests for creating new metrics
2. TestArchiveMetric: Tests for archiving metrics
3. TestCalculateMetric: Tests for calculating metric usage
4. TestCalculateMetricProrationForGauge: Tests for calculating prorated gauge metrics
5. TestCalculateMetricWithFilters: Tests for calculating metrics with filters applied
6. TestCustomSQLMetrics: Tests for custom SQL metrics
7. TestRegressions: Tests for specific regression cases

Each test class contains multiple test methods that set up specific scenarios, execute the relevant functionality, and assert the expected outcomes.

## Symbols

### `@pytest.fixture`
#### Description
Decorators used to define fixture functions that provide test data or objects.

### `@pytest.mark.django_db(transaction=True)`
#### Description
Decorator that enables database access and transaction management for tests.

### Test Classes (e.g., `TestInsertMetric`, `TestArchiveMetric`, etc.)
#### Description
Classes containing groups of related test methods.

### Test Methods (e.g., `test_api_key_can_create_billable_metric_empty_before`, `test_cant_archive_with_active_plan_version`, etc.)
#### Description
Individual test cases that set up scenarios, execute functionality, and assert expected outcomes.

## Dependencies
- pytest: Testing framework
- django: Web framework
- model_bakery: Tool for generating test data
- rest_framework: API framework

## Error Handling
The tests use assertions to verify expected outcomes and raise exceptions for unexpected behavior.

## Logging
No explicit logging is implemented in this test file.

This test suite is crucial for ensuring the correct functionality of the metrics system in the metering_billing application, covering various scenarios and edge cases.