---
title: "conftest.py"
---

Here's a detailed documentation of the provided code file:

## High-level description
This file contains pytest fixtures and utility functions for setting up test environments and generating test data for the metering and billing system. It provides a set of reusable components that can be used across different test cases to create organizations, customers, events, metrics, plans, and other related objects.

## Code Structure
The file defines several pytest fixtures that can be used to set up test environments and generate test data. These fixtures are designed to work together to create a complete test scenario. The main fixtures include:

- `run_around_tests`: Runs before and after each test
- `use_dummy_cache_backend`: Sets up a dummy cache backend for testing
- `turn_off_stripe_connection`: Temporarily disables Stripe connection
- `api_client_with_api_key_auth`: Creates an API client with API key authentication
- `generate_org_and_api_key`: Generates an organization and API key
- Various fixtures for adding and retrieving customers, users, events, billable metrics, subscription records, products, plans, and plan versions

## Symbols

### `run_around_tests`
#### Description
This fixture runs before and after each test. It disables Posthog tracking.

### `use_dummy_cache_backend`
#### Description
This fixture sets up a dummy cache backend and configures Celery to use in-memory broker and SQLite result backend.

### `turn_off_stripe_connection`
#### Description
This fixture temporarily disables the Stripe connection by setting the test secret key to None.

### `api_client_with_api_key_auth`
#### Description
This fixture creates an API client with API key authentication.

### `generate_org_and_api_key`
#### Description
This fixture generates an organization and an API key for testing purposes.

### `add_customers_to_org`
#### Description
This fixture adds a specified number of customers to an organization.

### `get_customers_in_org`
#### Description
This fixture retrieves all customers in an organization.

### `add_users_to_org`
#### Description
This fixture adds a specified number of users to an organization.

### `create_events_with_org_customer`
#### Description
This fixture creates a specified number of events for a given organization and customer.

### `get_events_with_org_customer_id`
#### Description
This fixture retrieves events for a given organization and customer ID.

### `get_events_with_org`
#### Description
This fixture retrieves all events for a given organization.

### `add_billable_metrics_to_org`
#### Description
This fixture adds a specified number of billable metrics to an organization.

### `get_billable_metrics_in_org`
#### Description
This fixture retrieves all billable metrics in an organization.

### `add_subscription_record_to_org`
#### Description
This fixture adds a subscription record to an organization.

### `get_subscription_records_in_org`
#### Description
This fixture retrieves all subscription records in an organization.

### `add_product_to_org`
#### Description
This fixture adds a product to an organization.

### `add_plan_to_product`
#### Description
This fixture adds a plan to a product.

### `add_plan_version_to_plan`
#### Description
This fixture adds a plan version to a plan.

## Dependencies
- pytest
- django.core.cache
- metering_billing.utils
- metering_billing.utils.enums
- model_bakery
- rest_framework.test

## Configuration
The fixtures use various configuration settings from the Django settings module, such as `CACHES`, `CELERY_BROKER_URL`, and `CELERY_RESULT_BACKEND`.

## Error Handling
The fixtures do not implement specific error handling mechanisms. Any exceptions raised during the fixture execution will be caught by pytest and reported as test failures.

## Performance Considerations
These fixtures are designed for testing purposes and may not be optimized for performance in production environments. They create and manipulate database objects, which can be time-consuming for large datasets.

This documentation provides an overview of the main components and functionality of the conftest.py file. It can be used as a reference for understanding the test setup and available fixtures for the metering and billing system tests.