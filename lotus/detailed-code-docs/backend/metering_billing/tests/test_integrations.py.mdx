---
title: "test_integrations.py"
---

Here's a comprehensive documentation for the target file `backend/metering_billing/tests/test_integrations.py`:

## High-level description
This file contains integration tests for payment processors, specifically Stripe. It tests various functionalities related to customer creation, invoice generation, and subscription management in the context of Stripe integration with the application.

## Code Structure
The file defines a pytest fixture `integration_test_common_setup` and a test class `TestStripeIntegration`. The fixture sets up common test data, while the test class contains individual test methods for different Stripe integration scenarios.

## Symbols

### `integration_test_common_setup`
#### Description
A pytest fixture that sets up common test data for integration tests.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| generate_org_and_api_key | function | Generates an organization and API key |
| add_customers_to_org | function | Adds customers to an organization |
| add_users_to_org | function | Adds users to an organization |
| add_product_to_org | function | Adds a product to an organization |
| add_plan_to_product | function | Adds a plan to a product |
| add_plan_version_to_plan | function | Adds a plan version to a plan |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| setup_dict | dict | A dictionary containing setup data for tests |

#### Internal Logic
1. Creates an organization and associated data (customer, product, plan, plan version)
2. Sets up an API client and authenticates a user
3. Configures Stripe and Braintree connectors
4. Returns a dictionary with all the setup data

### `TestStripeIntegration`
#### Description
A test class containing methods to test various Stripe integration scenarios.

#### Test Methods

1. `test_stripe_self_hosted_working_and_connected`
   - Checks if Stripe is working and connected in self-hosted mode

2. `test_stripe_org_not_connected_withjout_oauth`
   - Verifies that the organization is not connected without OAuth

3. `test_stripe_customer_not_initially_connected`
   - Ensures that customers are not initially connected to Stripe

4. `test_create_customer_in_stripe_from_lotus`
   - Tests creating a customer in Stripe from Lotus

5. `test_create_customer_in_lotus_from_stripe`
   - Tests importing a customer from Stripe to Lotus

6. `test_generate_invoice_for_customer`
   - Tests generating an invoice for a customer

7. `test_update_invoice_status`
   - Tests updating the status of an invoice

8. `test_update_invoice_status_2`
   - Another test for updating invoice status, focusing on payment intents

9. `test_external_plan_link_and_transfer_subs`
   - Tests external plan linking and transferring subscriptions

Each test method sets up necessary data, performs actions, and asserts expected outcomes related to Stripe integration.

## Dependencies
- pytest
- stripe
- django.conf.settings
- django.db.models
- rest_framework.test.APIClient
- Various application models and utilities

## Error Handling
The tests use pytest's assertion mechanisms to check for expected outcomes. Specific error handling is not implemented within the test methods themselves.

## Notes
- The file includes commented-out code for Braintree integration tests, which are not currently active.
- The tests make use of Stripe's test mode and API keys for simulating Stripe interactions.
- Some tests involve time-sensitive operations and include sleep statements to allow for propagation of changes.

This documentation provides an overview of the integration tests for Stripe in the application. It covers the main components, test scenarios, and the overall structure of the test suite.