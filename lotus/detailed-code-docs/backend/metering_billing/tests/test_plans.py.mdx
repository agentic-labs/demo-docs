---
title: "test_plans.py"
---

Here's a detailed documentation of the target file:

## High-level description
This file contains a set of pytest test cases for the Plan and PlanVersion models in the metering_billing application. The tests cover various operations such as creating plans, adding versions, managing tags, and handling features.

## Code Structure
The code is organized into several test classes, each focusing on a specific aspect of plan and plan version functionality. The tests use a common setup fixture (`plan_test_common_setup`) to create the necessary objects for testing.

## Symbols

### `plan_test_common_setup`
#### Description
A pytest fixture that sets up common objects and data for plan-related tests.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| generate_org_and_api_key | function | Function to generate an organization and API key |
| add_product_to_org | function | Function to add a product to an organization |
| add_users_to_org | function | Function to add users to an organization |
| add_customers_to_org | function | Function to add customers to an organization |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| setup_dict | dict | Dictionary containing setup data for tests |

#### Internal Logic
1. Creates an organization and API key
2. Sets up an API client and authenticates a user
3. Creates a customer and product
4. Prepares payloads for plan creation, update, and version creation

### `TestCreatePlan`
#### Description
A test class for plan creation functionality.

#### `test_create_plan_basic`
Tests basic plan creation.

#### `test_plan_dont_specify_version_fails_doesnt_create_plan`
Tests that plan creation fails when no initial version is specified.

### `TestCreatePlanVersion`
#### Description
A test class for plan version creation functionality.

#### `test_create_new_version_as_active_works`
Tests creating a new active version for an existing plan.

### `TestPlanOperations`
#### Description
A test class for various plan operations.

#### `test_add_tags_empty_before`
Tests adding tags to a plan with no existing tags.

#### `test_add_tags_different_capitalization_doesnt_duplicate`
Tests that adding tags with different capitalization doesn't create duplicates.

#### `test_remove_tags_including_nonexistent`
Tests removing tags from a plan, including nonexistent tags.

#### `test_set_tags`
Tests setting tags for a plan.

#### `test_add_new_feature`
Tests adding a new feature to a plan.

#### `test_update_plan_name_description_works`
Tests updating a plan's name and description.

#### `test_delete_including_fail_with_subscription`
Tests plan deletion, including the case where deletion should fail due to an active subscription.

### `TestPlanVersionOperations`
#### Description
A test class for various plan version operations.

#### `test_add_target_customer_to_version_plain`
Tests adding a target customer to a plan version.

#### `test_add_target_customer_to_version_subscriptionrecord_exists`
Tests adding a target customer to a plan version when a subscription record exists.

#### `test_remove_target_customer_plain`
Tests removing a target customer from a plan version.

#### `test_remove_target_customer_subscriptionrecord_exists`
Tests removing a target customer from a plan version when a subscription record exists.

#### `test_make_public_works`
Tests making a plan version public.

#### `test_add_feature_to_plan_version`
Tests adding a feature to a plan version.

#### `test_set_replacement_for_plan`
Tests setting a replacement for a plan version.

#### `test_make_replacement_for_plan`
Tests making a plan version a replacement for another version.

#### `test_delete_plan_version_including_subscription`
Tests deleting a plan version, including the case where deletion should fail due to an active subscription.

#### `test_edit_active_to_no_longer_in_list_plans`
Tests editing an active plan version to no longer appear in the list of plans.

#### `test_edit_active_from_no_longer_in_list_plans`
Tests editing a plan version's active_from date to no longer appear in the list of plans.

## Dependencies
- pytest
- django
- rest_framework
- metering_billing models and utilities

The tests rely on various utility functions and fixtures to set up the test environment and perform assertions.