---
title: "test_customer.py"
---

Here's a comprehensive documentation for the target file `backend/metering_billing/tests/test_customer.py`:

## High-level description
This file contains unit tests for the Customer API endpoints in a Django application. It tests various operations such as creating, retrieving, and deleting customers, as well as handling edge cases and different authentication methods.

## Code Structure
The file is organized into several test classes, each focusing on a specific aspect of the Customer API:
1. `TestGetCustomers`: Tests for retrieving customers
2. `TestInsertCustomer`: Tests for creating new customers
3. `TestDeleteCustomer`: Tests for deleting customers

Each class contains multiple test methods that cover different scenarios and edge cases.

## Symbols

### `customer_test_common_setup`
#### Description
A fixture that sets up the common test environment for customer-related tests.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| num_customers | int | Number of customers to create |
| auth_method | str | Authentication method to use |
| user_org_and_api_key_org_different | bool | Whether the user's organization is different from the API key's organization |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| setup_dict | dict | A dictionary containing the setup information |

#### Internal Logic
1. Creates organizations and API keys
2. Sets up the client with the appropriate authentication method
3. Creates customers if required
4. Creates a premium support feature and a flat fee addon
5. Returns a dictionary with all the setup information

### `TestGetCustomers`
#### Description
A test class for the GET endpoint of the Customer API.

#### Test Methods
1. `test_api_key_can_access_customers_empty`: Tests retrieving customers with an empty database using API key authentication
2. `test_session_auth_can_access_customers_multiple`: Tests retrieving multiple customers using session authentication

### `TestInsertCustomer`
#### Description
A test class for the POST endpoint of the Customer API.

#### Test Methods
1. `test_api_key_can_create_customer_empty_before`: Tests creating a customer with an empty database using API key authentication
2. `test_session_auth_can_create_customer_nonempty_before`: Tests creating a customer with existing customers using session authentication
3. `test_customer_id_already_exists_within_org_reject_creation`: Tests rejection of customer creation when the customer ID already exists in the organization
4. `test_customer_id_already_exists_not_in_org_accept_creation`: Tests acceptance of customer creation when the customer ID exists in a different organization

### `TestDeleteCustomer`
#### Description
A test class for the DELETE endpoint of the Customer API.

#### Test Methods
1. `test_can_delete_customer_with_subscriptions`: Tests deleting a customer with active subscriptions

## Dependencies
- pytest
- django
- rest_framework
- metering_billing models and utilities

## Error Handling
The tests use assertions to verify the expected behavior of the API endpoints. They check for correct HTTP status codes and data integrity after operations.

## Performance Considerations
These are unit tests and are not designed with performance in mind. However, they use fixtures to set up common test environments, which can improve test execution speed.

## TODOs
There are no explicit TODOs in the code.

This documentation provides a comprehensive overview of the test file, its structure, and the various test cases it covers for the Customer API endpoints.