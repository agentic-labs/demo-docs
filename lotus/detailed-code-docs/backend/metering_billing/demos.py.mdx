---
title: "demos.py"
---

## High-level description
The `demos.py` file contains functions for setting up demo environments for the metering and billing platform. These functions create sample data for various use cases, including a text generation service, an analytics platform, and a database service. They populate the database with organizations, customers, metrics, plans, subscriptions, and events, simulating real-world usage scenarios.

## Code Structure
The code consists of several functions, each responsible for setting up a specific demo environment. These functions are independent of each other and can be called individually to create the desired demo setup. They primarily interact with the Django ORM to create and manipulate database objects.

## References
The code references various models from the `metering_billing` app, including `Organization`, `Customer`, `Metric`, `Plan`, `PlanVersion`, `SubscriptionRecord`, and `Event`. It also utilizes the `METRIC_HANDLER_MAP` from the `metering_billing.aggregation.billable_metrics` module to create metrics based on their type.

## Symbols

### `setup_demo3`
#### Description
Sets up a demo environment for a text generation service. It creates sample data for customers, metrics, plans, and subscriptions, simulating usage of a text generation API.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| organization_name | str | The name of the organization to create. |
| username | str | The username of the user to create. |
| email | str | The email address of the user to create. |
| password | str | The password of the user to create. |
| mode | str | The mode of operation, either "create" or "regenerate". |
| org_type | Organization.OrganizationType | The type of organization to create. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| user | User | The created user object. |

#### Internal Logic
1. **Handles existing organization:** If `mode` is "create", deletes any existing organization with the same name. If `mode` is "regenerate", deletes all related data for the existing organization.
2. **Creates user:** Creates a new user with the provided credentials if it doesn't exist.
3. **Creates organization:** Creates a new organization with the provided name and type, and associates it with the user.
4. **Creates customers:** Creates three sets of customers: big, medium, and small, simulating different usage patterns.
5. **Creates metrics:** Creates metrics for tracking API calls, words generated, compute time, unique languages used, and content types generated.
6. **Creates plans:** Creates four plans: Free, 10K Words, 25K Words, and 50K Words, each with different pricing tiers based on the defined metrics.
7. **Creates subscriptions:** Creates subscriptions for each customer, assigning them to different plans based on their size and usage patterns.
8. **Generates events:** Generates events for each customer, simulating usage of the text generation API based on their assigned plan and usage patterns.
9. **Runs invoice generation:** Triggers the `run_generate_invoice` task to generate invoices for the created subscriptions.
10. **Creates backtest:** Creates a backtest to compare the revenue of different plans.
11. **Runs backtest:** Triggers the `run_backtest` task to execute the backtest.

### `setup_demo4`
#### Description
Sets up a demo environment for an analytics platform. It creates sample data for customers, metrics, plans, and subscriptions, simulating usage of an analytics service.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| organization_name | str | The name of the organization to create. |
| username | str | The username of the user to create. |
| email | str | The email address of the user to create. |
| password | str | The password of the user to create. |
| mode | str | The mode of operation, either "create" or "regenerate". |
| org_type | Organization.OrganizationType | The type of organization to create. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| user | User | The created user object. |

#### Internal Logic
1. **Handles existing organization:** If `mode` is "create", deletes any existing organization with the same name. If `mode` is "regenerate", deletes all related data for the existing organization.
2. **Creates user:** Creates a new user with the provided credentials if it doesn't exist.
3. **Creates organization:** Creates a new organization with the provided name and type, and associates it with the user.
4. **Creates customers:** Creates three sets of customers: big, medium, and small, simulating different usage patterns.
5. **Creates metrics:** Creates metrics for tracking analytics events, unique users tracked, session recordings, session recording time, and user seats.
6. **Creates plans:** Creates seven plans: Free, Events-only - Basic, Events-only - Pro, Events + Recordings - Basic, Events + Recordings - Pro, Experimental - Events + Recording Time, each with different pricing tiers based on the defined metrics.
7. **Creates subscriptions:** Creates subscriptions for each customer, assigning them to different plans based on their size and usage patterns.
8. **Generates events:** Generates events for each customer, simulating usage of the analytics service based on their assigned plan and usage patterns.
9. **Runs invoice generation:** Triggers the `run_generate_invoice` task to generate invoices for the created subscriptions.

### `setup_paas_demo`
#### Description
Sets up a demo environment for a PaaS (Platform as a Service) offering. It creates sample data for customers, metrics, plans, and subscriptions, simulating usage of a PaaS platform.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| organization_name | str | The name of the organization to create. |
| username | str | The username of the user to create. |
| email | str | The email address of the user to create. |
| password | str | The password of the user to create. |
| org_type | Organization.OrganizationType | The type of organization to create. |

#### Outputs
None

#### Internal Logic
1. **Handles existing organization:** Deletes any existing organization with the same name.
2. **Creates user:** Creates a new user with the provided credentials if it doesn't exist.
3. **Creates organization:** Creates a new organization with the provided name and type, and associates it with the user.
4. **Creates customers:** Creates three sets of customers: big, medium, and small, simulating different usage patterns.
5. **Creates metrics:** Creates metrics for tracking validator nodes, RPC nodes, indexer nodes, event indexer nodes, testnet transactions, mainnet transactions, rate-limited testnet transactions, and rate-limited mainnet transactions.
6. **Creates plans:** Creates two plans: Basic and Professional, each with different pricing tiers based on the defined metrics.
7. **Generates events:** Generates events for each customer, simulating usage of the PaaS platform based on their assigned plan and usage patterns.

### `setup_database_demo`
#### Description
Sets up a demo environment for a database service. It creates sample data for customers, metrics, plans, and subscriptions, simulating usage of a database platform.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| organization_name | str | The name of the organization to create. |
| username | str | The username of the user to create. |
| email | str | The email address of the user to create. |
| password | str | The password of the user to create. |
| mode | str | The mode of operation, either "create" or "regenerate". |
| org_type | Organization.OrganizationType | The type of organization to create. |
| size | str | The size of the demo environment, either "small" or "large". |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| user | User | The created user object. |

#### Internal Logic
1. **Handles existing organization:** If `mode` is "create", deletes any existing organization with the same name. If `mode` is "regenerate", deletes all related data for the existing organization.
2. **Creates user:** Creates a new user with the provided credentials if it doesn't exist.
3. **Creates organization:** Creates a new organization with the provided name and type, and associates it with the user.
4. **Creates customers:** Creates three sets of customers: big, medium, and small, simulating different usage patterns. The number of customers in each set depends on the `size` parameter.
5. **Creates metrics:** Creates metrics for tracking GB months, GB hours, data egress, insert rate, server costs, GB RAM months, and CPU months.
6. **Creates plans:** Creates four plans: Free, Basic, Pay As You Go, and Pro, each with different pricing tiers based on the defined metrics.
7. **Creates subscriptions:** Creates subscriptions for each customer, assigning them to different plans based on their size and usage patterns.
8. **Generates events:** Generates events for each customer, simulating usage of the database service based on their assigned plan and usage patterns.
9. **Runs invoice generation:** Triggers the `generate_invoice` function to generate invoices for the created subscriptions.
10. **Creates analysis:** Creates an analysis object with sample data for revenue, cost, and profit.

### `create_pc_and_tiers`
#### Description
Creates a `PlanComponent` object and its associated `PriceTier` objects for a given plan version and billable metric.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| organization | Organization | The organization object. |
| plan_version | PlanVersion | The plan version object. |
| billable_metric | Metric | The billable metric object. |
| max_units | Decimal | The maximum units for the price tier. |
| free_units | Decimal | The number of free units for the price tier. |
| cost_per_batch | Decimal | The cost per batch for the price tier. |
| metric_units_per_batch | Decimal | The number of metric units per batch for the price tier. |

#### Outputs
None

#### Internal Logic
1. **Creates PlanComponent:** Creates a `PlanComponent` object for the given plan version and billable metric.
2. **Creates Free Tier:** If `free_units` is provided, creates a free `PriceTier` object with a range from 0 to `free_units`.
3. **Creates Per-Unit Tier:** If `cost_per_batch` is provided, creates a per-unit `PriceTier` object with a range from `range_start` (either 0 or `free_units`) to `max_units`.

### `random_date`
#### Description
Generates a random datetime between two given dates.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| start | datetime.date or datetime.datetime | The start date. |
| end | datetime.date or datetime.datetime | The end date. |
| n | int | The number of random datetimes to generate. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| dt | datetime.datetime | A random datetime between `start` and `end`. |

#### Internal Logic
1. **Converts dates to datetime:** If `start` or `end` are dates, converts them to datetime objects with minimum and maximum time respectively.
2. **Generates random datetime:** Calculates a random number of seconds between `start` and `end` and adds it to `start` to generate a random datetime.

### `gaussian_raise_issue`
#### Description
Generates a list of dictionaries, each containing a random stacktrace length and latency, simulating issue data with a Gaussian distribution.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| n | int | The number of dictionaries to generate. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| dictionary | dict | A dictionary containing a random stacktrace length and latency. |

#### Internal Logic
1. **Generates random values:** Generates random values for stacktrace length and latency using a Gaussian distribution.
2. **Creates dictionary:** Creates a dictionary with the generated values and a random project name.

### `gaussian_users`
#### Description
Generates a list of dictionaries, each containing a random number of users, simulating user data with a Gaussian distribution.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| n | int | The number of dictionaries to generate. |
| mean | float | The mean of the Gaussian distribution. |
| sd | float | The standard deviation of the Gaussian distribution. |
| mx | int | The maximum number of users. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| dictionary | dict | A dictionary containing a random number of users. |

#### Internal Logic
1. **Generates random value:** Generates a random value for the number of users using a Gaussian distribution.
2. **Caps value:** If `mx` is provided, caps the generated value to `mx`.
3. **Creates dictionary:** Creates a dictionary with the generated value.

### `make_subscription_record`
#### Description
Creates a `SubscriptionRecord` object for a given customer and plan.

#### Inputs
| Name || Name | Type | Description |
|:-----|:-----|:------------|
| organization | Organization | The organization object. |
| customer | Customer | The customer object. |
| plan | PlanVersion | The plan version object. |
| start_date | datetime.datetime | The start date of the subscription. |
| is_new | bool | Whether this is a new subscription. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| sr | SubscriptionRecord | The created subscription record object. |

#### Internal Logic
1. **Creates SubscriptionRecord:** Calls the `create_subscription_record` method of the `SubscriptionRecord` model to create a new subscription record with the provided parameters.
2. **Sets additional parameters:** Sets the end date to None, subscription filters to None, quantity to 1, and disables invoice generation.

### `create_pc_plus_tiers_new`
#### Description
Creates `PlanComponent` objects and their associated `PriceTier` objects for multiple plan versions based on a provided dictionary of metrics and their pricing configurations.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| plan_versions | list[PlanVersion] | A list of plan version objects. |
| pcs_dict | dict | A dictionary containing metric configurations and pricing tiers. |

#### Outputs
None

#### Internal Logic
1. **Iterates through plan versions:** For each plan version in the input list:
   a. **Iterates through metrics:** For each metric in the `pcs_dict`:
      - Creates a `PlanComponent` object for the metric and plan version.
      - Creates `PriceTier` objects for each tier defined in the metric's configuration.
      - If specified, creates a `ComponentFixedCharge` object for the plan component.

## Dependencies
The code relies on various Django models from the `metering_billing` app, as well as utility functions and enums from the same app. It also uses external libraries such as `numpy` for random number generation and `pytz` for timezone handling.

## Error Handling
The code does not implement extensive error handling. It assumes that the necessary models and dependencies are available and that the database operations will succeed. In a production environment, additional error handling and logging would be advisable.

## Performance Considerations
The demo setup functions create a large number of database objects and generate numerous events. This can be resource-intensive and time-consuming, especially for larger demo sizes. In a production environment, it may be necessary to optimize these operations or run them asynchronously.

## TODOs
There are no explicit TODOs in the code. However, potential improvements could include:
1. Adding more robust error handling and logging.
2. Optimizing database operations for better performance with large datasets.
3. Adding more configuration options to customize the demo setups.
4. Implementing data cleanup functions to easily remove demo data.