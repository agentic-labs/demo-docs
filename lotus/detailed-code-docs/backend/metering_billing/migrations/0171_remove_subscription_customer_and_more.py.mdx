---
title: "0171_remove_subscription_customer_and_more.py"
---

## High-level description
This Django migration script removes the `Subscription` model and refactors the `Invoice` model to directly relate to `SubscriptionRecord` objects. This suggests a shift in the data model where subscriptions are no longer directly linked to invoices, and instead, individual subscription records are used for billing.

## Code Structure
This migration script primarily modifies the models related to subscriptions and invoices. It removes the `Subscription` model and its relationships with `Customer` and `Organization`. It also removes the `subscription` field from the `Invoice` model and replaces it with a many-to-many relationship to `SubscriptionRecord`.

## References
This migration references the following models:
- `Subscription`
- `Customer`
- `Organization`
- `Invoice`
- `HistoricalInvoice`
- `SubscriptionRecord`

## Symbols
### `Migration`
#### Description
This class defines a Django migration that modifies the database schema by removing the `Subscription` model and refactoring the `Invoice` model.

#### Inputs
N/A - This is a migration script, not a function or method.

#### Outputs
N/A - This is a migration script, not a function or method.

#### Internal Logic
The migration performs the following operations:
1. **Removes fields:**
    - `customer` and `organization` fields from the `Subscription` model.
    - `subscription` field from the `HistoricalInvoice` and `Invoice` models.
2. **Removes index:**
    - `metering_bi_organiz_af373b_idx` from the `Invoice` model.
3. **Adds field:**
    - `subscription_records` (many-to-many field) to the `Invoice` model, linking it to `SubscriptionRecord`.
4. **Adds index:**
    - `metering_bi_organiz_943e95_idx` to the `Invoice` model, indexing `organization` and `-issue_date`.
5. **Deletes model:**
    - `Subscription` model.

## Side Effects
This migration will modify the database schema, removing the `Subscription` table and altering the `Invoice` table. Existing data in the `Subscription` table will be deleted.

## Dependencies
- `django.db.migrations`
- `django.db.models`

## Error Handling
This migration script does not implement specific error handling. Any errors during the migration process will be handled by Django's migration framework.
