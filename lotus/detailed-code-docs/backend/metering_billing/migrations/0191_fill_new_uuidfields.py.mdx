---
title: "0191_fill_new_uuidfields.py"
---

## High-level description
This Django migration file adds and populates new UUID fields to the `metering_billing_usageevent` table, creates an index, and sets up a trigger for automatically updating these fields. It's designed to enhance the database structure with UUIDv5 hashes of existing fields for improved querying and data integrity.

## Code Structure
The migration consists of several SQL operations executed in sequence:
1. Creating a UUID extension
2. Adding and populating new UUID columns
3. Creating an index
4. Defining a function for updating UUID fields
5. Setting up a trigger to automatically update UUID fields

## Symbols

### Migration
#### Description
This Django migration class defines database operations to modify the `metering_billing_usageevent` table and add related functionality.

#### Dependencies
- Previous migration: `0190_alter_customer_uuidv5_customer_id_and_more`

#### Operations
1. Create UUID extension
2. Add and populate UUID columns
3. Create an index
4. Define a function for updating UUID fields
5. Set up a trigger

#### Internal Logic
1. Ensures the UUID extension is available in PostgreSQL.
2. Adds three new UUID columns to the `metering_billing_usageevent` table:
   - `uuidv5_customer_id`
   - `uuidv5_event_name`
   - `uuidv5_idempotency_id`
3. Populates these new columns with UUIDv5 hashes of existing fields.
4. Creates an index on `time_created`, `uuidv5_event_name`, and `uuidv5_customer_id`.
5. Defines a PostgreSQL function to update the UUID fields.
6. Sets up a trigger to automatically update UUID fields before insert or update operations.

## Side Effects
- Modifies the structure of the `metering_billing_usageevent` table.
- Adds a new index to the table.
- Introduces a new trigger on the table.

## Performance Considerations
- The new index on `time_created`, `uuidv5_event_name`, and `uuidv5_customer_id` may improve query performance for certain operations.
- The trigger added to the table will slightly increase the overhead of insert and update operations.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| uuid-ossp | PostgreSQL extension for UUID generation |

## Error Handling
The migration uses SQL transactions to ensure atomicity of operations. If any part of the migration fails, the entire operation will be rolled back.