---
title: "0099_remove_historicalsubscriptionrecord_flat_fee_already_billed_and_more.py"
---

## High-level description
This Django migration script removes deprecated fields related to flat fee billing from various models and introduces new fields for handling flat fee behavior and usage charges in subscription records. It also modifies relationships between invoices, subscriptions, and line items to improve data structure and accuracy.

## Code Structure
This code doesn't define any new symbols, but it does modify existing models by adding, removing, and altering fields and relationships. The changes primarily affect the `HistoricalSubscriptionRecord`, `SubscriptionRecord`, `Invoice`, `HistoricalInvoice`, and `InvoiceLineItem` models.

## References
This migration references the following models:

- `HistoricalSubscriptionRecord`
- `SubscriptionRecord`
- `Invoice`
- `HistoricalInvoice`
- `InvoiceLineItem`
- `Subscription`

## Symbols
This code does not define any new symbols. It modifies existing models defined in other files.

## Side Effects
This migration will modify the database schema by:

- Removing the `flat_fee_already_billed` and `prorated_flat_costs_dict` fields from `HistoricalSubscriptionRecord` and `SubscriptionRecord`.
- Removing the `associated_plan_version` field from `InvoiceLineItem`.
- Adding the `flat_fee_behavior` and `invoice_usage_charges` fields to `HistoricalSubscriptionRecord` and `SubscriptionRecord`.
- Adding the `associated_subscription_record` and `chargeable_item_type` fields to `InvoiceLineItem`.
- Modifying the relationship between `HistoricalInvoice` and `Subscription`.
- Modifying the relationship between `Invoice` and `Subscription`.
- Modifying the `billing_type` and `invoice` fields of `InvoiceLineItem`.

## Dependencies
This code depends on the Django framework for database migrations.

## Error Handling
This code does not implement specific error handling beyond the basic exception handling provided by Django migrations.
