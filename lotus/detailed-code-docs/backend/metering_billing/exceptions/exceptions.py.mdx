---
title: "exceptions.py"
---

Here's a high-level description of the exceptions.py file:

The file defines a set of custom exception classes that extend Django's APIException. These exceptions are used throughout the Lotus application to handle various error scenarios related to authentication, data integrity, and business logic. The exceptions are designed to provide specific error messages and HTTP status codes for different types of errors that can occur during API operations.

Code Structure:
The file contains multiple exception classes, each inheriting from Django's APIException. Each exception class defines a specific status code and default error message. The exceptions are organized by their purpose and the type of error they represent.

Symbols:

1. OrganizationMismatch
   Description: Raised when there's a mismatch between the organization associated with an API key and the user's session.
   Status Code: 401
   Default Message: "Provided both API key and session authentication but organization didn't match"

2. CRMNotSupported
   Description: Raised when an unsupported CRM operation is attempted.
   Status Code: 400
   Default Message: "CRM not supported"

3. EnvironmentNotConnected
   Description: Raised when an environment is not connected to the Unified CRM API.
   Status Code: 400
   Default Message: "Environment not connected to Unified CRM API"

4. CRMIntegrationNotAllowed
   Description: Raised when CRM integration is not allowed for a team.
   Status Code: 400
   Default Message: "CRM Integration not allowed for Team"

5. SubscriptionAlreadyEnded
   Description: Raised when attempting to perform an operation on a subscription that has already ended.
   Status Code: 400
   Default Message: "Subscription already ended"

6. InvalidOperation
   Description: Raised for general invalid operations.
   Status Code: 400
   Default Message: "Invalid operation"

7. UserNoOrganization
   Description: Raised when a user does not have an associated organization.
   Status Code: 401
   Default Message: "User does not have an organization"

8. RepeatedOperation
   Description: Raised when an operation is repeated unnecessarily.
   Status Code: 401
   Default Message: "repeated_operation"

9. NoMatchingAPIKey
   Description: Raised when no matching API key is found.
   Status Code: 401
   Default Message: "API Key not known"

10. NoAPIKeyProvided
    Description: Raised when no API key is provided in the request.
    Status Code: 401
    Default Message: "No API key provided"

11. DuplicateWebhookEndpoint
    Description: Raised when attempting to create a duplicate webhook endpoint.
    Status Code: 400
    Default Message: "Webhook endpoint already exists"

12. DuplicateCustomer
    Description: Raised when attempting to create a duplicate customer.
    Status Code: 400
    Default Message: "Customer with that customer_id already exists"

13. DuplicateMetric
    Description: Raised when attempting to create a duplicate metric.
    Status Code: 400
    Default Message: "Metric with that name already exists"

14. DuplicateUser
    Description: Raised when attempting to create a duplicate user.
    Status Code: 400
    Default Message: "User with that email already exists"

15. DuplicateOrganization
    Description: Raised when attempting to create a duplicate organization.
    Status Code: 400
    Default Message: "Organization with that name already exists"

16. RepeatedEventIdempotency
    Description: Raised when an event with the same idempotency key is repeated.
    Status Code: 400
    Default Message: "Idempotency key already exists"

17. SwitchPlanDurationMismatch
    Description: Raised when attempting to switch to a plan with a mismatched duration.
    Status Code: 400
    Default Message: "Switch plan duration does not match current plan duration"

18. SwitchPlanSamePlanException
    Description: Raised when attempting to switch to the same plan.
    Status Code: 400
    Default Message: "Switch plan is the same as current plan"

19. NotFoundException
    Description: Raised when a requested resource is not found.
    Status Code: 404
    Default Message: "Resource was not found"

20. DatabaseOperationFailed
    Description: Raised when a database operation fails.
    Status Code: 500
    Default Message: "Database operation failed. Please double-check your metrics/events and make sure you're not using a text field where you should be using a numeric field."

21. AggregationEngineFailure
    Description: Raised when the aggregation engine fails to perform aggregation.
    Status Code: 500
    Default Message: "Aggregation engine failed to perform aggregation"

22. MetricValidationFailed
    Description: Raised when metric validation fails.
    Status Code: 400
    Default Message: "Metric validation failed"

23. ExternalConnectionInvalid
    Description: Raised when an external connection is invalid.
    Status Code: 400
    Default Message: "External connection invalid"

24. ExternalConnectionFailure
    Description: Raised when an external connection fails.
    Status Code: 500
    Default Message: "External connection failed"

25. NotEditable
    Description: Raised when attempting to edit a non-editable resource.
    Status Code: 400
    Default Message: "This resource is not editable"

26. RegistrationFailure
    Description: Raised when user registration fails.
    Status Code: 400
    Default Message: "Registration failed"

27. ServerError
    Description: Raised for general server errors.
    Status Code: 500
    Default Message: "Internal server error"

28. PrepaymentMissingUnits
    Description: Raised when prepayment units are missing.
    Status Code: 400
    Default Message: "Input error"

29. InvalidRequest
    Description: Raised for general invalid requests.
    Status Code: 400
    Default Message: "Invalid request"

30. MethodNotAllowed
    Description: Raised when an HTTP method is not allowed for a resource.
    Status Code: 405
    Default Message: "Method not allowed"

31. StripeWebhookFailure
    Description: Raised when a Stripe webhook is invalid.
    Status Code: 400
    Default Message: "Stripe webhook invalid"

32. OverlappingPlans
    Description: Raised when there are overlapping plans.
    Status Code: 400
    Default Message: "Overlapping plans"

33. AlignmentEngineFailure
    Description: Raised when the alignment engine fails to perform alignment.
    Status Code: 500
    Default Message: "Alignment engine failed to perform alignment"

34. IntermediateBillingEngineFailure
    Description: Raised when the intermediate billing engine encounters an unexpected state.
    Status Code: 500
    Default Message: "Intermediate billing engine ran into an unexpected state"

These exceptions provide a structured way to handle and communicate errors in the Lotus application, allowing for consistent error reporting and handling across different parts of the system.