---
title: "middleware.py"
---

## High-level description
This code defines a Django middleware called `OrganizationInsertMiddleware` that intercepts incoming requests and attempts to determine the organization associated with the request. It handles both authenticated users and API key authentication.

## Code Structure
The `OrganizationInsertMiddleware` class is initialized with a `get_response` callable, which represents the next middleware in the chain or the view function. The `__call__` method is executed for each request and attempts to retrieve the organization based on the authenticated user or API key. It then adds the organization to the request object (`request.organization`) before passing the request to the next middleware or view.

## Symbols
### `OrganizationInsertMiddleware`
#### Description
This class is a Django middleware that intercepts incoming requests and attempts to determine the organization associated with the request. It handles both authenticated users and API key authentication.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| get_response | callable | The next middleware in the chain or the view function. |
| request | HttpRequest | The incoming HTTP request. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| response | HttpResponse | The HTTP response generated by the next middleware or view function. |

#### Internal Logic
1. **Check for authenticated user:** If the request has an authenticated user (`request.user.is_authenticated`), retrieve the organization from the user object (`request.user.organization`).
2. **Check for API key:** If the user is not authenticated, check for an API key in the request headers (`request.META.get("HTTP_X_API_KEY")`).
3. **Retrieve organization from API key:** If an API key is found, attempt to retrieve the organization from the cache using the API key. If not found in the cache, retrieve the `APIToken` object from the database, cache the organization ID, and retrieve the organization object.
4. **Attach organization to request:** Set the `request.organization` attribute to the retrieved organization object. If no organization is found, set it to `None`.
5. **Pass request to next middleware/view:** Call the `get_response` callable with the modified request object.
6. **Return response:** Return the response object returned by the next middleware or view function.

## Error Handling
The middleware catches any exceptions that occur during organization retrieval and logs the error. In case of an error, `request.organization` is set to `None`.

## Logging
The middleware logs the retrieved organization and the authenticated user for debugging purposes. It also logs any errors encountered during organization retrieval.
