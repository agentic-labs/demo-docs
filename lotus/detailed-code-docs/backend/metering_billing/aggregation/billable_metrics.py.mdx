---
title: "billable_metrics.py"
---

## High-level description
The `billable_metrics.py` file defines a set of classes that handle the calculation of billable usage for different types of metrics. It provides a framework for defining, validating, and calculating usage for counter, gauge, rate, and custom metrics. These classes are used to determine the amount a customer should be billed based on their usage of a particular metric.

## Code Structure
The code defines an abstract base class `MetricHandler` which outlines the interface for all metric handlers. Concrete classes like `CounterHandler`, `GaugeHandler`, `RateHandler`, and `CustomHandler` inherit from this base class and implement the specific logic for their respective metric types. Each handler class provides methods for validating metric data, creating metrics, calculating total billable usage, current usage, and daily billable usage for a billing record.

## References
The code references several other modules and classes within the `metering_billing` application, including:

* `metering_billing.models`: This module contains the models for various entities like `Metric`, `Customer`, `Event`, `BillingRecord`, and `Organization`.
* `metering_billing.utils`: This module provides utility functions for date manipulation, UUID generation, and other common operations.
* `metering_billing.utils.enums`: This module defines enums for various constants used in the application, such as `METRIC_AGGREGATION`, `METRIC_GRANULARITY`, `METRIC_TYPE`, and `PLAN_DURATION`.
* `metering_billing.aggregation.counter_query_templates`, `metering_billing.aggregation.gauge_query_templates`, `metering_billing.aggregation.rate_query_templates`: These modules contain SQL query templates used for calculating usage for different metric types.

## Symbols

### `MetricHandler`
#### Description
This is an abstract base class that defines the interface for all metric handlers. It provides abstract methods that need to be implemented by concrete handler classes for specific metric types.

#### Inputs
None

#### Outputs
None

#### Internal Logic
This class does not have any internal logic as it is an abstract base class.

### `CounterHandler`
#### Description
This class handles the calculation of billable usage for counter metrics. Counter metrics track the number of times an event occurs.

#### Inputs
None

#### Outputs
None

#### Internal Logic
This class implements the abstract methods defined in `MetricHandler` for counter metrics. It uses SQL queries to calculate the total billable usage, current usage, and daily billable usage for a billing record. It also provides methods for validating counter metric data and creating counter metrics.

### `CustomHandler`
#### Description
This class handles the calculation of billable usage for custom metrics. Custom metrics are defined using custom SQL queries.

#### Inputs
None

#### Outputs
None

#### Internal Logic
This class implements the abstract methods defined in `MetricHandler` for custom metrics. It executes the custom SQL query provided for the metric to calculate the total billable usage, current usage, and daily billable usage for a billing record. It also provides methods for validating custom metric data and creating custom metrics.

### `GaugeHandler`
#### Description
This class handles the calculation of billable usage for gauge metrics. Gauge metrics track the value of a property over time.

#### Inputs
None

#### Outputs
None

#### Internal Logic
This class implements the abstract methods defined in `MetricHandler` for gauge metrics. It uses SQL queries to calculate the total billable usage, current usage, and daily billable usage for a billing record. It also provides methods for validating gauge metric data and creating gauge metrics.

### `RateHandler`
#### Description
This class handles the calculation of billable usage for rate metrics. Rate metrics track the rate at which an event occurs.

#### Inputs
None

#### Outputs
None

#### Internal Logic
This class implements the abstract methods defined in `MetricHandler` for rate metrics. It uses SQL queries to calculate the total billable usage, current usage, and daily billable usage for a billing record. It also provides methods for validating rate metric data and creating rate metrics.

### `METRIC_HANDLER_MAP`
#### Description
This is a dictionary that maps metric types to their corresponding handler classes. It is used to dynamically select the appropriate handler class based on the metric type.

#### Inputs
None

#### Outputs
None

#### Internal Logic
This dictionary does not have any internal logic. It simply maps metric types to their corresponding handler classes.
