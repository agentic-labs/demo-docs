---
title: "update_invoice_grace_period_service_spec.rb"
---

## High-level description
This code is a RSpec test suite for the `Customers::UpdateInvoiceGracePeriodService` class. It verifies the functionality of updating a customer's invoice grace period, finalizing draft invoices, and updating issuing dates and payment due dates for draft invoices.

## Code Structure
The test suite is organized into a single `describe` block for the `#call` method of the service. It includes several test cases that cover different scenarios and edge cases.

## Symbols

### RSpec.describe Customers::UpdateInvoiceGracePeriodService
#### Description
This is the main describe block for the test suite, focusing on the `UpdateInvoiceGracePeriodService` class.

### #call
#### Description
This describe block contains all the test cases for the `call` method of the service.

#### Internal Logic
The tests cover the following scenarios:
1. Updating the invoice grace period on the customer
2. Finalizing corresponding draft invoices
3. Updating issuing dates on draft invoices
4. Handling customers with net payment terms
5. Behavior when the grace period remains the same

### let statements
#### Description
These statements set up the test data and dependencies used across the test cases.

| Name | Type | Description |
|:-----|:-----|:------------|
| membership | Membership | A factory-created membership |
| organization | Organization | The organization associated with the membership |
| customer | Customer | A factory-created customer associated with the organization |
| grace_period | Integer | The new grace period to be set (default: 2) |
| invoice_to_be_finalized | Invoice | A draft invoice created on '19 Jun 2022' |
| invoice_to_not_be_finalized | Invoice | A draft invoice created on '21 Jun 2022' |

### before block
#### Description
This block sets up the test environment by creating the invoices and stubbing the `Invoices::RefreshDraftAndFinalizeService.call` method.

### Individual test cases
#### Description
Each `it` block represents a specific test case that checks a particular aspect of the service's behavior.

## Dependencies
The test suite relies on the following dependencies:
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Provides the necessary setup for Rails-specific testing |
| FactoryBot | Used for creating test data |
| ActiveSupport::Testing::TimeHelpers | Provides time manipulation methods for testing |

## Notes
- The tests make use of RSpec's `travel_to` method to manipulate the current date for testing purposes.
- The service interacts with `Invoices::RefreshDraftAndFinalizeService`, which is stubbed in the tests.
- The tests cover various scenarios, including different grace periods, net payment terms, and edge cases.

This test suite ensures that the `UpdateInvoiceGracePeriodService` correctly updates the customer's grace period, finalizes the appropriate invoices, and updates the issuing and payment due dates as expected.