---
title: "void_service_spec.rb"
---

## High-level description
This code defines a test suite for the `Integrations::Aggregator::Taxes::Invoices::VoidService` class. It tests the functionality of voiding invoices through an integration with Anrok, a tax provider. The tests cover various scenarios including successful and failed void operations, error handling, and webhook delivery.

## Code Structure
The main test suite is defined using RSpec. It includes several nested contexts to test different scenarios. The tests use mocks and stubs to simulate external dependencies and API calls.

## Symbols

### `RSpec.describe Integrations::Aggregator::Taxes::Invoices::VoidService`
#### Description
This is the main describe block for the test suite, focusing on the `VoidService` class.

#### Internal Logic
The tests are organized into contexts and examples that cover different scenarios for the `#call` method of the service.

### `subject(:service_call)`
#### Description
Defines the subject of the test, which is calling the `VoidService` with an invoice.

### `let` statements
#### Description
These statements define various test doubles and fixtures used throughout the tests.

### `describe '#call'`
#### Description
This describe block focuses on testing the `#call` method of the `VoidService`.

#### Internal Logic
It includes contexts for successful and unsuccessful service calls, testing different response scenarios and error handling.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails testing environment |
| LagoHttpClient::Client | Mocked for simulating HTTP requests |

## Error Handling
The tests cover various error scenarios, including:
- Failed void invoice sync
- Server errors
- Invalid responses

## API/Interface Reference
The tests simulate API calls to the Anrok service for voiding invoices. The endpoint and headers are defined in the test setup.

| Endpoint | Method | Request | Response | Description |
|:---------|:-------|:--------|:---------|:------------|
| https://api.nango.dev/v1/anrok/void_invoices | POST | Invoice data | Success/Failure response | Void invoice in Anrok |

## Logging
The tests check for webhook delivery in case of errors, which is a form of logging/notification.

This test suite ensures that the `VoidService` correctly handles various scenarios when voiding invoices through the Anrok integration, including successful operations, error handling, and proper communication with external services.