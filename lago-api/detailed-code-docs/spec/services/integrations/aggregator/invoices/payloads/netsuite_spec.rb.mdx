---
title: "netsuite_spec.rb"
---

## High-level description
This RSpec test file is designed to test the `Integrations::Aggregator::Invoices::Payloads::Netsuite` class, specifically its `body` method. The test focuses on verifying the correct generation of the payload body for Netsuite integration, including various invoice components such as fees, taxes, and mappings.

## Code Structure
The test file contains a single `describe` block for the `#body` method, which includes multiple `let` statements to set up the test environment and a `context` block to test different scenarios based on tax item mapping.

## Symbols

### `RSpec.describe Integrations::Aggregator::Invoices::Payloads::Netsuite`
#### Description
This is the main describe block that encapsulates all tests for the `Integrations::Aggregator::Invoices::Payloads::Netsuite` class.

### `describe '#body'`
#### Description
This describe block focuses on testing the `body` method of the `Netsuite` class.

### `subject(:body_call)`
#### Description
Defines the subject of the test, which is the result of calling the `body` method on the payload object.

### `let` statements
#### Description
These statements set up the test environment by creating various objects and defining their attributes. They include:
- `payload`: The main object under test
- `integration_customer`, `integration`, `customer`, `organization`: Related objects for the integration and customer
- `add_on`, `billable_metric`, `charge`: Objects related to the invoice items
- `integration_collection_mapping1` to `integration_collection_mapping6`: Various mapping objects for different types of invoice items
- `integration_mapping_add_on`, `integration_mapping_bm`: Mapping objects for add-ons and billable metrics
- `invoice`: The invoice object with specific attributes
- `fee_sub`, `minimum_commitment_fee`, `charge_fee`, `charge_fee2`: Different types of fees associated with the invoice
- `invoice_link`, `due_date`: Additional invoice details
- `body`: The expected payload body structure

### `before` block
#### Description
Sets up the test environment by creating necessary objects and associations.

### `context 'when tax item is mapped'`
#### Description
Tests the scenario where a tax item is mapped in the integration.

#### Internal Logic
1. Defines the expected columns including tax-related fields
2. Creates the tax mapping object
3. Expects the `body` method to return the payload with tax columns

### `context 'when tax item is not mapped'`
#### Description
Tests the scenario where a tax item is not mapped in the integration.

#### Internal Logic
1. Defines the expected columns without tax-related fields
2. Expects the `body` method to return the payload without tax columns

## Dependencies
The test file depends on the following:
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Provides the necessary setup for Rails-based RSpec tests |
| FactoryBot | Used for creating test objects |

## Configuration
The test uses various FactoryBot factories to create test objects. These factories are not defined in this file but are assumed to exist in the project's factory definitions.

## TODOs
There are no explicit TODOs in this test file.