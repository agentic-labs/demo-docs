---
title: "create_service_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Plans::CreateService` class. It tests the functionality of creating a new plan with various attributes, charges, and usage thresholds. The tests cover different scenarios, including premium features and validation errors.

## Code Structure
The main test suite is defined for `Plans::CreateService`. It includes several nested contexts and examples to test different aspects of plan creation. The tests use FactoryBot to create test data and mock objects.

## Symbols

### `RSpec.describe Plans::CreateService, type: :service`
#### Description
This is the main describe block for the `Plans::CreateService` tests.

### `subject(:plans_service)`
#### Description
Defines the subject of the tests as an instance of `Plans::CreateService`.

### `describe 'create'`
#### Description
This describe block focuses on testing the `create` method of the service.

### `let` statements
#### Description
These statements define various test data and parameters used throughout the tests.

### `it 'creates a plan'`
#### Description
This test ensures that a plan is created with the correct attributes.

### `it 'does not create minimum commitment'`
#### Description
This test verifies that minimum commitment is not created by default.

### `context 'without premium license'`
#### Description
Tests behavior when the premium license is not active.

### `context 'with premium license'`
#### Description
Tests behavior when the premium license is active.

### `it 'creates charges'`
#### Description
Verifies that charges are created correctly for the plan.

### `it 'calls SegmentTrackJob'`
#### Description
Ensures that the SegmentTrackJob is called with the correct parameters after plan creation.

### `context 'with validation error'`
#### Description
Tests error handling when there are validation failures.

### `context 'with metrics from other organization'`
#### Description
Tests error handling when using metrics from a different organization.

## Dependencies
- RSpec
- FactoryBot
- SegmentTrackJob (mocked)

## Configuration
The tests use various configuration options, including:
- `lago_premium!`: A helper method to simulate premium license features
- `allow(SegmentTrackJob).to receive(:perform_later)`: Mocking the SegmentTrackJob

## Error Handling
The tests cover various error scenarios, including validation errors and using metrics from other organizations.

## Notes
- The tests cover both standard and premium features of the plan creation service.
- There are specific tests for progressive billing thresholds when the premium license is active.
- The tests ensure that the created plan has the correct attributes, charges, and usage thresholds.