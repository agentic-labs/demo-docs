---
title: "destroy_service_spec.rb"
---

## High-level description
This RSpec test file describes the behavior of the `Plans::DestroyService` class. It tests various scenarios related to destroying a plan, including soft deletion, handling active and pending subscriptions, finalizing draft invoices, and tracking the event using Segment.

## Symbols

### `RSpec.describe Plans::DestroyService`
#### Description
This is the main describe block for the `Plans::DestroyService` class, setting up the context for all the tests within.

### `subject(:destroy_service)`
#### Description
Defines the subject of the test, which is an instance of `Plans::DestroyService` initialized with a plan.

### `describe '#call'`
#### Description
This describe block focuses on testing the `call` method of the `Plans::DestroyService`.

#### Internal Logic
The tests within this block cover various scenarios:
1. Soft deleting the plan
2. Setting `pending_deletion` to false
3. Handling cases when the plan is not found
4. Calling `SegmentTrackJob` to track the plan deletion event
5. Handling active subscriptions
6. Handling pending subscriptions
7. Finalizing draft invoices

### `it 'soft deletes the plan'`
#### Description
Tests that calling the service results in a soft deletion of the plan.

#### Internal Logic
- Arranges: Sets up a plan with `pending_deletion: true`
- Acts: Calls the destroy service
- Asserts: 
  - The count of Plans decreases by 1
  - The `deleted_at` timestamp of the plan is set to the current time

### `it 'sets pending_deletion to false'`
#### Description
Verifies that the `pending_deletion` flag is set to false after calling the service.

### `context 'when plan is not found'`
#### Description
Tests the behavior when the plan to be destroyed is not found.

#### Internal Logic
- Arranges: Sets the plan to nil
- Acts: Calls the destroy service
- Asserts: 
  - The result is not successful
  - The error code is 'plan_not_found'

### `it 'calls SegmentTrackJob'`
#### Description
Ensures that the `SegmentTrackJob` is called with the correct parameters after destroying a plan.

#### Internal Logic
- Arranges: Sets up a spy on `SegmentTrackJob`
- Acts: Calls the destroy service
- Asserts: Verifies that `SegmentTrackJob` is called with the correct event and properties

### `context 'with active subscriptions'`
#### Description
Tests the behavior when the plan has active subscriptions.

#### Internal Logic
- Arranges: Creates active subscriptions for the plan
- Acts: Calls the destroy service
- Asserts: Verifies that all associated subscriptions are terminated

### `context 'with pending subscriptions'`
#### Description
Tests the behavior when the plan has pending subscriptions.

#### Internal Logic
- Arranges: Creates pending subscriptions for the plan
- Acts: Calls the destroy service
- Asserts: Verifies that all associated pending subscriptions are canceled

### `context 'with draft invoices'`
#### Description
Tests the behavior when there are draft invoices associated with the plan's subscriptions.

#### Internal Logic
- Arranges: Creates draft invoices linked to the plan's subscription
- Acts: Calls the destroy service
- Asserts: Verifies that all associated draft invoices are finalized

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads the Rails testing environment and configuration |
| FactoryBot | Used for creating test data (plans, subscriptions, invoices) |
| RSpec | The testing framework used for writing and running the tests |

## Error Handling
The service is expected to return an error result with the error code 'plan_not_found' when the plan to be destroyed is not found.