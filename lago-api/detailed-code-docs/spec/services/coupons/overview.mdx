---
title: "Overview"
---

## High-level description
This directory contains RSpec test files for various services related to coupon management in a Rails application. The services tested include creation, destruction, termination, updating, and validation of coupons. These tests ensure that the coupon-related operations work correctly under different scenarios and handle errors appropriately.

## What does it do?
The test suite in this directory verifies the functionality of several coupon-related services:

1. Coupon Creation: Tests the process of creating new coupons, including different types (e.g., percentage-based), handling validation errors, and checking limitations based on plans and billable metrics.

2. Coupon Destruction: Verifies the soft deletion of coupons and related coupon plans, as well as the termination of applied coupons.

3. Coupon Termination: Checks the termination of individual coupons and the bulk termination of expired coupons within an organization.

4. Coupon Updating: Tests various scenarios for updating existing coupons, including handling validation errors and managing different types of coupon limitations.

5. Coupon Validation: Ensures that the validation logic for coupon creation works correctly, particularly focusing on expiration date validation.

These tests simulate real-world scenarios to ensure that the coupon management system behaves correctly and handles edge cases appropriately.

## Key Files

1. `create_service_spec.rb`: Tests the `Coupons::CreateService` class, covering various scenarios for coupon creation.

2. `destroy_service_spec.rb`: Verifies the behavior of the `Coupons::DestroyService` class when destroying coupons.

3. `terminate_service_spec.rb`: Tests the `Coupons::TerminateService` class for terminating individual and expired coupons.

4. `update_service_spec.rb`: Checks the functionality of the `Coupons::UpdateService` class for updating existing coupons.

5. `validate_service_spec.rb`: Tests the `Coupons::ValidateService` class, focusing on validation logic for coupon creation.

Each of these files contains comprehensive test suites that cover both successful operations and error handling scenarios for their respective services.

## Dependencies
The test files in this directory rely on the following dependencies:

1. RSpec: The testing framework used for writing and running the tests.
2. FactoryBot: Used for creating test data and objects throughout the test suites.
3. Rails testing environment: Loaded via `rails_helper` in each test file.

Additionally, the tests interact with various models and services from the main application, such as `Coupon`, `CouponPlan`, and `SegmentTrackJob`.

## Configuration
While there are no explicit configuration files in this directory, the tests rely on the broader RSpec and Rails test configurations. Some key points about the test setup:

1. Time manipulation: Many tests use `freeze_time` to control time-based assertions, especially for testing expiration and deletion timestamps.

2. Factory usage: The tests extensively use FactoryBot factories to create test data, suggesting that these factories are defined elsewhere in the application.

3. Mocking: Some tests mock external services, such as `SegmentTrackJob`, to isolate the behavior of the coupon services.

4. Shared contexts: The tests often use shared contexts and `let` statements to set up common test data and conditions across multiple test cases.

These tests play a crucial role in ensuring the reliability and correctness of the coupon management system in the application. They cover a wide range of scenarios and edge cases, providing confidence in the robustness of the coupon-related services.

Code Example:
Here's an example from `create_service_spec.rb` that demonstrates how these tests are structured:

```ruby
RSpec.describe Coupons::CreateService do
  subject(:create_service) { described_class.new(membership.user, **args) }

  let(:membership) { create(:membership) }
  let(:organization) { membership.organization }

  describe 'create' do
    let(:args) do
      {
        name: 'Super Coupon',
        code: 'SUPER_COUPON',
        coupon_type: 'fixed_amount',
        frequency: 'once',
        amount_cents: 1000,
        amount_currency: 'EUR',
        organization_id: organization.id
      }
    end

    it 'creates a coupon' do
      expect { create_service.call }.to change(Coupon, :count).by(1)
    end

    it 'calls SegmentTrackJob' do
      allow(SegmentTrackJob).to receive(:perform_later)

      result = create_service.call

      expect(SegmentTrackJob).to have_received(:perform_later).with(
        membership_id: membership.id,
        event: 'coupon_created',
        properties: {
          code: result.coupon.code,
          coupon_type: result.coupon.coupon_type,
          amount_cents: result.coupon.amount_cents,
          amount_currency: result.coupon.amount_currency
        }
      )
    end

    # ... more test cases ...
  end
end
```

This example shows how the tests are structured to verify the creation of coupons and the associated side effects, such as tracking events.