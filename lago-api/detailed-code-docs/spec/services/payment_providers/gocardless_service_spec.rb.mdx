---
title: "gocardless_service_spec.rb"
---

## High-level description
This file contains RSpec tests for the `PaymentProviders::GocardlessService` class. It tests the functionality of creating or updating GoCardless providers, handling incoming webhooks, and processing GoCardless events for payments and refunds.

## Code Structure
The test suite is organized into three main describe blocks, each focusing on a specific method of the `GocardlessService`: `.create_or_update`, `.handle_incoming_webhook`, and `.handle_event`. Within each block, various scenarios and edge cases are tested.

## Symbols

### `PaymentProviders::GocardlessService`
#### Description
This is the main class being tested. It handles operations related to the GoCardless payment provider.

### `describe '.create_or_update'`
#### Description
Tests the creation and updating of GoCardless providers.

#### Internal Logic
- Tests creation of a new GoCardless provider
- Tests updating an existing GoCardless provider
- Tests handling of validation errors

### `describe '.handle_incoming_webhook'`
#### Description
Tests the handling of incoming webhooks from GoCardless.

#### Internal Logic
- Tests successful parsing and handling of webhook events
- Tests error handling for invalid payloads and signatures

### `describe '.handle_event'`
#### Description
Tests the processing of GoCardless events for payments and refunds.

#### Internal Logic
- Tests routing of payment events to the appropriate service
- Tests routing of refund events to the appropriate service

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails testing environment |
| OAuth2::Client | Mocked for OAuth operations |
| GoCardlessPro::Webhook | Mocked for webhook parsing |
| Invoices::Payments::GocardlessService | Mocked for payment status updates |
| CreditNotes::Refunds::GocardlessService | Mocked for refund status updates |

## Error Handling
The tests cover various error scenarios, including:
- Validation errors when creating or updating providers
- JSON parsing errors for webhook payloads
- Invalid signature errors for webhooks

## Logging
No specific logging mechanisms are implemented in these tests.

## TODOs
There are no explicit TODOs in this test file.

This test suite provides comprehensive coverage for the `GocardlessService`, ensuring that it correctly handles provider creation/updates, webhook processing, and event routing for both payments and refunds. The tests use mocking and stubbing to isolate the service's behavior and verify its interactions with other components of the system.