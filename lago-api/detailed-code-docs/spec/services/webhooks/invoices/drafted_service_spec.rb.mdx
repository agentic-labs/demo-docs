---
title: "drafted_service_spec.rb"
---

## High-level description
This RSpec test file describes the behavior of the `Webhooks::Invoices::DraftedService` class. It focuses on testing the `.call` method of the service, which is expected to create a webhook for a drafted invoice event.

## Code Structure
The test file defines a single describe block for the `Webhooks::Invoices::DraftedService` class, with a nested context for the `.call` method. It uses FactoryBot to create test data and shared examples to test webhook creation.

## Symbols

### `RSpec.describe Webhooks::Invoices::DraftedService`
#### Description
This is the main describe block for the `Webhooks::Invoices::DraftedService` class.

#### Internal Logic
1. Sets up the subject of the test as an instance of `Webhooks::Invoices::DraftedService` with an invoice object.
2. Creates test data using FactoryBot, including an organization, customer, subscription, and invoice.
3. Sets up associated fees and credits for the invoice.
4. Tests the `.call` method using a shared example.

### `let` statements
#### Description
These statements define lazy-loaded test data using FactoryBot.

#### Inputs
- `:organization` - Creates an organization
- `:customer` - Creates a customer associated with the organization
- `:subscription` - Creates a subscription associated with the organization
- `:invoice` - Creates an invoice associated with the customer and organization

### `before` block
#### Description
This block sets up additional test data before each test.

#### Internal Logic
Creates two fees and two credits associated with the invoice.

### `describe '.call'`
#### Description
This nested describe block focuses on testing the `.call` class method of the service.

#### Internal Logic
Uses a shared example `'creates webhook'` to test the webhook creation for the 'invoice.drafted' event.

## Dependencies
The test file depends on the following:
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails testing environment and configuration |
| FactoryBot | Creates test data |
| Shared examples | Provides reusable test scenarios |

## Notes
1. There's a commented-out `let` statement for `webhook_endpoint`, which might be used in future tests or in the shared example.
2. The test uses shared examples, which are not defined in this file. The shared example `'creates webhook'` is likely defined in a support file.
3. The test is focused on ensuring that the service creates a webhook with the correct event type ('invoice.drafted'), object type ('invoice'), and includes fees and credits in the payload.

This test file provides a good starting point for testing the `Webhooks::Invoices::DraftedService`, but it might benefit from additional tests to cover edge cases or different scenarios.