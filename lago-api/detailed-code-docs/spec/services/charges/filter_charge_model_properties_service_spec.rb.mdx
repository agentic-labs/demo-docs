---
title: "filter_charge_model_properties_service_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Charges::FilterChargeModelPropertiesService` class. It tests the service's ability to filter charge model properties based on different charge models and billable metrics.

## Code Structure
The test suite is organized around the `#call` method of the `FilterChargeModelPropertiesService`. It uses various contexts to test different charge models and their corresponding property filters.

## Symbols

### `RSpec.describe Charges::FilterChargeModelPropertiesService`
#### Description
This is the main describe block for the `FilterChargeModelPropertiesService` test suite.

#### Internal Logic
- Sets up the subject as an instance of the service with charge and properties
- Defines shared variables like `charge_model`, `billable_metric`, and `charge`
- Defines a `properties` hash with various charge-related properties

### `describe '#call'`
#### Description
This describe block focuses on testing the `#call` method of the service.

#### Internal Logic
It contains multiple contexts to test different scenarios:
1. Without a charge model
2. With a standard charge model
3. With a graduated charge model
4. With a graduated percentage charge model
5. With a package charge model
6. With a percentage charge model
7. With a volume charge model
8. With a custom billable metric

Each context tests the expected keys in the filtered properties based on the charge model or billable metric type.

### Context: `'without charge_model'`
#### Description
Tests the service's behavior when no charge model is specified.

#### Internal Logic
Expects the service to return an empty hash of properties.

### Context: `'with standard charge_model'`
#### Description
Tests the service's behavior with a standard charge model.

#### Internal Logic
- Checks if the filtered properties include 'amount' and 'grouped_by'
- Tests handling of empty strings in the 'grouped_by' property

### Context: `'with graduated charge_model'`
#### Description
Tests the service's behavior with a graduated charge model.

#### Internal Logic
Checks if the filtered properties include 'graduated_ranges'.

### Context: `'with graduated_percentage charge_model'`
#### Description
Tests the service's behavior with a graduated percentage charge model.

#### Internal Logic
Checks if the filtered properties include 'graduated_percentage_ranges'.

### Context: `'with package charge_model'`
#### Description
Tests the service's behavior with a package charge model.

#### Internal Logic
Checks if the filtered properties include 'amount', 'free_units', and 'package_size'.

### Context: `'with percentage charge_model'`
#### Description
Tests the service's behavior with a percentage charge model.

#### Internal Logic
Checks if the filtered properties include various percentage-related properties.

### Context: `'with volume charge_model'`
#### Description
Tests the service's behavior with a volume charge model.

#### Internal Logic
Checks if the filtered properties include 'volume_ranges'.

### Context: `'with custom billable metric'`
#### Description
Tests the service's behavior with a custom billable metric.

#### Internal Logic
Checks if the filtered properties include 'custom_properties'.

## Dependencies
The test file depends on the following:
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Provides the testing environment and configuration |
| FactoryBot | Used for creating test objects (e.g., `build(:charge)`) |

Note: The `rails_helper` file is included in the related code snippets and sets up the testing environment, including RSpec configuration, SimpleCov for code coverage, and various testing helpers.