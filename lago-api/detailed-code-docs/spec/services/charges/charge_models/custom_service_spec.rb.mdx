---
title: "custom_service_spec.rb"
---

## High-level description
This code is a RSpec test suite for the `Charges::ChargeModels::CustomService` class. It tests the `apply` method of the service, which is responsible for calculating charges based on custom aggregation results.

## Symbols

### `Charges::ChargeModels::CustomService.apply`
#### Description
This is the main method being tested. It applies a custom charge model to aggregation results.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| charge | CustomCharge | The charge object containing properties for calculation |
| aggregation_result | BaseService::Result | The result of aggregation containing various metrics |
| properties | Hash | Properties of the charge (passed from the charge object) |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result | Object | An object containing the calculated amount and unit_amount |

### `apply_custom_service`
#### Description
This is the subject of the test, which calls the `apply` method of `Charges::ChargeModels::CustomService`.

### `aggregation_result`
#### Description
An instance of `BaseService::Result` that holds various aggregation metrics used in the charge calculation.

### `charge`
#### Description
A `CustomCharge` object created for testing purposes, associated with a `billable_metric`.

### `billable_metric`
#### Description
A `CustomBillableMetric` object created for testing purposes, associated with the `charge`.

## Internal Logic
1. The test sets up necessary objects and data:
   - Creates a `CustomCharge` and associated `CustomBillableMetric`
   - Prepares an `aggregation_result` with various metrics
2. It then calls the `apply` method of `Charges::ChargeModels::CustomService`
3. Finally, it asserts that the resulting `amount` and `unit_amount` match expected values

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails and RSpec configuration |
| FactoryBot | Used for creating test objects (charge, billable_metric) |

## Notes
- The test uses `let` statements to define variables and objects used in the test.
- The `before` block is used to set up the `aggregation_result` with specific values before each test.
- The test checks both the total `amount` and the `unit_amount` calculated by the service.