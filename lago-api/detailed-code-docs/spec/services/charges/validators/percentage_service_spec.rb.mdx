---
title: "percentage_service_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Charges::Validators::PercentageService` class. It validates the behavior of the service for various scenarios related to percentage-based charges, including input validation for rate, fixed amount, and other properties.

## Symbols

### `RSpec.describe Charges::Validators::PercentageService`
#### Description
This is the main test suite for the `Charges::Validators::PercentageService` class. It contains multiple test cases to verify the service's behavior under different conditions.

#### Internal Logic
The test suite uses a subject `percentage_service` which is an instance of the `Charges::Validators::PercentageService` class. It tests the `valid?` method of this service with various input scenarios.

### `.valid?`
#### Description
This is the main method being tested in the `PercentageService`. It checks if the given charge properties are valid according to the service's rules.

#### Internal Logic
The tests cover various scenarios:
1. Valid input
2. Invalid billable metric type (latest_agg)
3. Missing rate
4. Invalid rate format
5. Negative rate
6. Zero rate
7. Invalid free_units_per_events
8. Invalid fixed_amount and free_units_per_total_aggregation
9. Negative values for fixed_amount, free_units_per_events, and free_units_per_total_aggregation
10. Premium features like per_transaction_min_amount and per_transaction_max_amount

Each test case sets up specific charge properties and expectations for the `valid?` method's result.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Provides the testing environment and configuration |
| FactoryBot | Used for creating test objects (e.g., `build(:percentage_charge)`) |

## Configuration
The tests use `let` statements to set up the test data:
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| charge | FactoryBot | build(:percentage_charge, properties: percentage_properties) | The charge object being validated |
| percentage_properties | Hash | { rate: '0.25', fixed_amount: '2' } | The properties of the percentage charge |

## Error Handling
The tests check for specific error messages and types when validation fails. They use `BaseService::ValidationFailure` to represent validation errors.

## API/Interface Reference
| Method | Input | Output | Description |
|:-------|:------|:-------|:------------|
| valid? | None | Boolean | Checks if the charge properties are valid |

## Notes
- The tests use `aggregate_failures` to group multiple expectations together.
- Some tests are wrapped in `lago_premium!` blocks, indicating they are for premium features.
- The test file uses `frozen_string_literal: true` to freeze all string literals in the file.

This test suite thoroughly covers various scenarios for validating percentage-based charges, ensuring that the `PercentageService` correctly handles different input cases and provides appropriate error messages for invalid inputs.