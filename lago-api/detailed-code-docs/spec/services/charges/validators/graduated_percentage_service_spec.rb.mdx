---
title: "graduated_percentage_service_spec.rb"
---

## High-level description
This code is a RSpec test suite for the `Charges::Validators::GraduatedPercentageService` class. It validates the behavior of the service, which is responsible for validating graduated percentage charges in a billing system. The tests cover various scenarios including range validation, rate validation, and flat amount validation.

## Code Structure
The main structure is a RSpec `describe` block for the `Charges::Validators::GraduatedPercentageService` class. Within this block, there are several nested `context` and `it` blocks that test different aspects of the service's validation logic.

## Symbols

### `Charges::Validators::GraduatedPercentageService`
#### Description
This is the main class being tested. It's a service responsible for validating graduated percentage charges.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| charge | Object | A charge object with properties including graduated percentage ranges |

### `.valid?`
#### Description
This is the main method being tested. It checks if the graduated percentage charge is valid based on various criteria.

#### Internal Logic
The method validates:
1. The billable metric type
2. The presence and structure of graduated percentage ranges
3. The validity of rates and flat amounts in each range

## Test Cases

### Billable Metric Validation
#### Description
Tests that the service is invalid when the billable metric is of type 'latest_agg'.

#### Internal Logic
- Creates a charge with a 'latest_agg' billable metric
- Expects the service to be invalid
- Checks for specific error messages

### Ranges Validation
#### Description
Tests various scenarios related to the structure of graduated percentage ranges.

#### Internal Logic
- Checks for presence of ranges
- Validates that ranges start at 0
- Ensures ranges end at infinity
- Checks for gaps between ranges
- Verifies ranges are not overlapping

### Rate Validation
#### Description
Tests the validity of rates in the graduated percentage ranges.

#### Internal Logic
- Checks that rates are present
- Validates that rates are numeric
- Ensures rates are non-negative

### Flat Amount Validation
#### Description
Tests the validity of flat amounts in the graduated percentage ranges.

#### Internal Logic
- Checks that flat amounts are present
- Validates that flat amounts are numeric
- Ensures flat amounts are non-negative

### Valid Scenario
#### Description
Tests a scenario where all validations pass.

#### Internal Logic
- Creates a charge with valid ranges, rates, and flat amounts
- Expects the service to be valid

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails testing environment |
| FactoryBot | Used for creating test objects |

## Error Handling
The service returns a `BaseService::ValidationFailure` object with specific error messages when validations fail. The tests check for these error messages to ensure proper error handling.

This test suite provides comprehensive coverage of the `Charges::Validators::GraduatedPercentageService` class, ensuring that it correctly validates graduated percentage charges under various scenarios.