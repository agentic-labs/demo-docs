---
title: "Overview"
---

## High-level description
This directory contains RSpec test files for various credit-related services in a billing or invoicing system. The services tested include applying coupons, prepaid credits, credit notes, and progressive billing to invoices. These tests ensure the correct behavior of credit application, invoice updates, and related operations in different scenarios.

## What does it do?
The tests in this directory verify the functionality of several credit-related services:

1. Applied Coupon Service: Checks if coupons are correctly applied to invoices, handling different coupon types (fixed amount, percentage), frequencies (one-time, recurring, forever), and limitations (plan-specific, billable metric-specific).

2. Applied Coupons Service: Verifies the application of multiple coupons to invoices, including scenarios with different coupon types, currency handling, and plan limitations.

3. Applied Prepaid Credit Service: Ensures that prepaid credits are correctly applied to invoices, including creating wallet transactions, updating wallet balances, and enqueueing webhook jobs.

4. Credit Note Service: Tests the creation of credits from credit notes for invoices, handling various scenarios such as different invoice amounts and credit note balances.

5. Progressive Billing Service: Verifies the application of progressive billing credits to invoices, including cases with single and multiple progressive billing invoices and different subscription configurations.

These tests simulate various real-world scenarios to ensure that the credit application process works correctly in all cases, maintaining the integrity of the billing system.

## Key Files

1. `applied_coupon_service_spec.rb`: Tests the `Credits::AppliedCouponService` class, focusing on applying individual coupons to invoices.

2. `applied_coupons_service_spec.rb`: Tests the `Credits::AppliedCouponsService` class, which handles applying multiple coupons to invoices.

3. `applied_prepaid_credit_service_spec.rb`: Tests the `Credits::AppliedPrepaidCreditService` class, verifying the application of prepaid credits to invoices.

4. `credit_note_service_spec.rb`: Tests the `Credits::CreditNoteService` class, which creates credits from credit notes for invoices.

5. `progressive_billing_service_spec.rb`: Tests the `Credits::ProgressiveBillingService` class, focusing on applying progressive billing credits to invoices.

Each file contains comprehensive test cases covering various scenarios and edge cases for their respective services.

## Dependencies
The test files in this directory rely on the following dependencies:

1. RSpec: The testing framework used for writing and running the tests.
2. FactoryBot: Used for creating test data (invoices, coupons, credit notes, etc.).
3. Rails testing environment: Loaded through the `rails_helper`, which includes additional configuration for the test environment, such as database cleaner settings and SimpleCov for code coverage.

## Configuration
While there are no explicit configuration files in this directory, the tests rely on the Rails testing environment configuration, which is typically set up in the `rails_helper` file. This configuration may include settings for database cleaning, test coverage reporting, and other testing-related configurations.

The tests make extensive use of FactoryBot for creating test data. The factories for creating various objects (invoices, coupons, credit notes, etc.) are defined elsewhere in the project and are used throughout these test files.

These tests play a crucial role in ensuring the reliability and correctness of the credit-related services in the billing system. They cover a wide range of scenarios, including edge cases, to maintain the integrity of the credit application process across different types of credits and invoicing situations.