---
title: "invoiced_usages_service_spec.rb"
---

## High-level description
This code is a RSpec test suite for the `Analytics::InvoicedUsagesService` class. It tests the behavior of the service's `call` method under different license conditions (premium and non-premium).

## Symbols

### `RSpec.describe Analytics::InvoicedUsagesService, type: :service`
#### Description
This is the main describe block for the test suite, focusing on the `Analytics::InvoicedUsagesService` class and specifying it as a service type test.

### `let(:service)`
#### Description
Creates a new instance of the `Analytics::InvoicedUsagesService` for each test.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| organization | Organization | An instance of the Organization model |

### `let(:customer)`
#### Description
Creates a new customer associated with the organization for testing purposes.

### `let(:organization)`
#### Description
Creates a new organization for testing purposes.

### `describe '#call'`
#### Description
Focuses on testing the `call` method of the `Analytics::InvoicedUsagesService`.

### `subject(:service_call)`
#### Description
Defines the subject of the test as the result of calling the `call` method on the service instance.

### `context 'when licence is premium'`
#### Description
Tests the behavior of the service when the license is premium.

#### Internal Logic
1. Uses the `lago_premium!` method to set up a premium license environment.
2. Expects the `service_call` to be successful.

### `context 'when licence is not premium'`
#### Description
Tests the behavior of the service when the license is not premium.

#### Internal Logic
1. Expects the `service_call` not to be successful.
2. Checks that the error code is 'feature_unavailable'.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads the Rails testing environment and configuration |
| FactoryBot | Used for creating test data (customer and organization) |

## References
- The `lago_premium!` method is referenced but not defined in this file. It's likely defined in a helper or support file.
- The `Analytics::InvoicedUsagesService` class is being tested but is not defined in this file.

## Notes
- The test uses RSpec's `aggregate_failures` to group multiple expectations together.
- The `around` block in the premium license context suggests that the premium status is temporarily set for the duration of the test.