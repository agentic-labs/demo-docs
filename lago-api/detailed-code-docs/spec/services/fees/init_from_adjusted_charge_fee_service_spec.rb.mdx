---
title: "init_from_adjusted_charge_fee_service_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Fees::InitFromAdjustedChargeFeeService` class. It tests the initialization of fees based on adjusted charges, covering scenarios with adjusted units and adjusted amounts, as well as error handling for charge model failures.

## Code Structure
The test suite is organized into three main contexts: "with adjusted units", "with adjusted amount", and "with charge model error". Each context tests different aspects of the `InitFromAdjustedChargeFeeService`.

## Symbols

### `RSpec.describe Fees::InitFromAdjustedChargeFeeService`
#### Description
This is the main describe block for the test suite, focusing on the `Fees::InitFromAdjustedChargeFeeService` class.

### `subject(:init_service)`
#### Description
Defines the subject of the test, which is an instance of `Fees::InitFromAdjustedChargeFeeService`.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| adjusted_fee | AdjustedFee | The adjusted fee object |
| boundaries | Hash | Time boundaries for charges |
| properties | Hash | Properties of the charge |

### `let` blocks
#### Description
These blocks define various objects and data used throughout the tests, such as `subscription`, `invoice`, `billable_metric`, `charge`, and `adjusted_fee`.

### `context 'with adjusted units'`
#### Description
Tests the scenario where the fee has adjusted units.

#### Internal Logic
1. Calls the `init_service`
2. Expects the result to be successful
3. Verifies that the initialized fee has the correct attributes

### `context 'with adjusted amount'`
#### Description
Tests the scenario where the fee has an adjusted amount.

#### Internal Logic
1. Creates an adjusted fee with specific properties
2. Calls the `init_service`
3. Expects the result to be successful
4. Verifies that the initialized fee has the correct attributes

### `context 'with charge model error'`
#### Description
Tests the error handling when the charge model service fails.

#### Internal Logic
1. Mocks the `Charges::ChargeModels::StandardService` to return an error
2. Calls the `init_service`
3. Expects the result to be unsuccessful
4. Verifies that the error is properly captured and returned

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads the Rails testing environment |

## Error Handling
The test suite includes a specific context for testing error handling when the charge model service fails. It verifies that the service properly captures and returns the error.