---
title: "charge_service_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Fees::ChargeService` class. It tests various scenarios of charge calculation for different types of charges, aggregation methods, and filters. The tests cover the creation of fees, current usage calculation, and error handling.

## Code Structure
The main test suite is defined for `Fees::ChargeService`. It includes tests for the `call` and `current_usage` methods. The tests are organized into different contexts based on charge types, aggregation methods, and the presence of filters.

## Symbols

### `RSpec.describe Fees::ChargeService`
#### Description
This is the main test suite for the `Fees::ChargeService` class.

#### Internal Logic
- Sets up various test scenarios with different charge types, billable metrics, and filters.
- Tests the `call` method for fee creation and the `current_usage` method for current usage calculation.
- Checks for correct fee attributes, handling of filters, and error scenarios.

### `describe '.call'`
#### Description
Tests the `call` method of the `Fees::ChargeService` class.

#### Internal Logic
- Tests fee creation for different charge types (standard, package, percentage, graduated, volume, graduated percentage).
- Checks fee creation with and without filters.
- Verifies correct handling of adjusted fees and true-up fees.
- Tests different aggregation types (count, sum, max, unique count, weighted sum, custom).

### `describe '.current_usage'`
#### Description
Tests the `current_usage` method of the `Fees::ChargeService` class.

#### Internal Logic
- Checks current usage calculation for different aggregation types.
- Tests current usage for graduated charge models.
- Verifies error handling for aggregation failures.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Provides RSpec configuration for Rails |
| FactoryBot | Used for creating test data |

## Error Handling
The tests include scenarios for handling aggregation errors, verifying that the service returns appropriate error responses.

Your response should not exceed 3000 words or 4000 tokens. Focus on providing clear, concise information that can be directly inferred from the code. Include optional sections only when they provide significant value for understanding the code.