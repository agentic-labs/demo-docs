---
title: "apply_taxes_service_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Fees::ApplyTaxesService` class. It tests various scenarios of applying taxes to fees, including different fee types (commitment, add-on, charge, subscription) and different tax sources (customer, organization, plan, charge).

## Code Structure
The test suite is organized into multiple contexts, each testing a specific scenario or condition for applying taxes. The main `describe` block focuses on the `call` method of the `ApplyTaxesService`.

## Symbols

### `RSpec.describe Fees::ApplyTaxesService`
#### Description
This is the main describe block for the `Fees::ApplyTaxesService` test suite.

#### Internal Logic
- Sets up common test data (customer, organization, invoice, fee, taxes)
- Defines various contexts to test different scenarios of tax application

### `describe 'call'`
#### Description
This describe block focuses on testing the `call` method of the `ApplyTaxesService`.

#### Internal Logic
- Tests various scenarios including:
  - Applying taxes based on tax codes
  - Applying taxes to different fee types (commitment, add-on, charge, subscription)
  - Applying taxes based on customer applied taxes
  - Handling coupon amounts
  - Applying organization-level taxes
  - Handling fees that already have taxes applied

### Context: `'when tax_codes parameter'`
#### Description
Tests the scenario where specific tax codes are provided to the service.

#### Internal Logic
- Creates a fee and applies taxes based on provided tax codes
- Verifies that the correct taxes are applied and the fee's tax attributes are updated

### Context: `'when fee is commitment type with taxes'`
#### Description
Tests tax application for commitment-type fees.

#### Internal Logic
- Sets up a commitment fee with associated taxes
- Verifies that the correct taxes are applied based on the commitment's taxes

### Context: `'when fee is add_on type with taxes'`
#### Description
Tests tax application for add-on type fees.

#### Internal Logic
- Sets up an add-on fee with associated taxes
- Verifies that the correct taxes are applied based on the add-on's taxes

### Context: `'when fee is a charge type with taxes applied to the plan'`
#### Description
Tests tax application for charge-type fees with plan-level taxes.

#### Internal Logic
- Sets up a charge fee with plan-level taxes
- Verifies that the correct taxes are applied based on the plan's taxes
- Includes a sub-context for when taxes are applied to the charge itself

### Context: `'when customer has applied_taxes'`
#### Description
Tests tax application when the customer has specific applied taxes.

#### Internal Logic
- Sets up customer-specific applied taxes
- Verifies that the correct taxes are applied based on the customer's applied taxes

### Context: `'when a coupon amount is applied to the fee'`
#### Description
Tests tax application when a coupon discount is applied to the fee.

#### Internal Logic
- Sets up a fee with a coupon discount
- Verifies that taxes are correctly calculated after applying the coupon discount

## Dependencies
The test file depends on the following:
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Provides the testing environment and configuration |
| FactoryBot | Used for creating test data |

## Error Handling
The test suite doesn't explicitly test error handling. It focuses on verifying the correct behavior of the `ApplyTaxesService` under various scenarios.

## Notes
- The test suite uses FactoryBot extensively to create test data.
- It uses RSpec's `aggregate_failures` to group multiple expectations together.
- The tests cover a wide range of scenarios, ensuring comprehensive coverage of the `ApplyTaxesService` functionality.