---
title: "update_ongoing_service_spec.rb"
---

## High-level description
This RSpec file contains unit tests for the `Wallets::Balance::UpdateOngoingService` class. It verifies the service's functionality in updating a wallet's ongoing balance, handling cases where the usage amount exceeds the available balance, and triggering appropriate actions when the balance is depleted.

## Code Structure
The test suite is organized around the `#call` method of the `UpdateOngoingService` class. It includes multiple contexts to test different scenarios and their expected outcomes.

## Symbols

### `RSpec.describe Wallets::Balance::UpdateOngoingService`
#### Description
This is the main describe block for the test suite, focusing on the `Wallets::Balance::UpdateOngoingService` class.

### `subject(:update_service)`
#### Description
Defines the subject of the test, which is an instance of the `UpdateOngoingService` class.

### `let(:wallet)`
#### Description
Creates a test wallet with predefined balance values.

### `let(:usage_credits_amount)`
#### Description
Defines the amount of usage credits to be applied in the test.

### `describe '#call'`
#### Description
Groups tests for the `#call` method of the service.

#### Internal Logic
1. Tests the normal case where the wallet balance is updated correctly.
2. Tests the case where the usage amount exceeds the available balance.
3. Verifies that the `depleted_ongoing_balance` flag is set correctly.
4. Checks if the appropriate webhook is triggered when the balance is depleted.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads the Rails testing environment |
| Wallets::Balance::UpdateOngoingService | The service being tested |
| SendWebhookJob | Job for sending webhooks, used to verify webhook triggering |

## Error Handling
The test suite doesn't explicitly test error handling. It focuses on the expected behavior of the service under normal and edge case scenarios.

## Performance Considerations
The tests use `change` expectations, which are generally efficient for checking state changes. However, multiple `change` expectations in a single test might impact performance if run frequently.

## TODOs
There are no explicit TODOs in this test file.

This test suite provides comprehensive coverage for the `UpdateOngoingService`, ensuring that wallet balances are correctly updated and appropriate actions are taken when balances are depleted. It helps maintain the integrity of the wallet balance management system.