---
title: "decrease_service_spec.rb"
---

## High-level description
This code is a RSpec test suite for the `Wallets::Balance::DecreaseService` class. It verifies that the service correctly updates a wallet's balance, consumed status, and ongoing balance when decreasing the wallet's credits.

## Symbols

### `RSpec.describe Wallets::Balance::DecreaseService`
#### Description
This is the main describe block for the `Wallets::Balance::DecreaseService` test suite. It sets up the context for testing the service's functionality.

### `subject(:create_service)`
#### Description
Defines the subject of the test, which is an instance of the `Wallets::Balance::DecreaseService` class, initialized with a wallet and a credits amount.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| wallet | Wallet | The wallet object to be updated |
| credits_amount | BigDecimal | The amount of credits to decrease |

### `let(:wallet)`
#### Description
Creates a test wallet with predefined balance values using FactoryBot.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| wallet | Wallet | A wallet object with initial balance values |

### `let(:credits_amount)`
#### Description
Defines the amount of credits to be decreased from the wallet.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| credits_amount | BigDecimal | The amount of credits to decrease (4.5) |

### `describe '.call'`
#### Description
Groups tests that verify the behavior of the `call` method of the `DecreaseService`.

#### Internal Logic
The tests in this block check three main aspects of the service:
1. Updates to the wallet's balance
2. Updates to the wallet's consumed status
3. Refreshing of the wallet's ongoing balance

Each test uses the `expect { ... }.to change(...)` syntax to verify that the service call results in the expected changes to the wallet's attributes.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads the Rails testing environment and configuration |
| FactoryBot | Used for creating test objects (wallet in this case) |
| RSpec | The testing framework used for writing and running the tests |

## Notes
- The test suite uses `BigDecimal` for precise decimal calculations, which is important for financial operations.
- The wallet factory is not shown in the provided code, but it's assumed to be defined elsewhere in the project.
- The tests cover both the main balance (in cents) and the credits balance, ensuring that both are updated correctly.
- The ongoing balance is also tested, which suggests that the service maintains a separate ongoing balance in addition to the main balance.

This test suite ensures that the `Wallets::Balance::DecreaseService` correctly updates all relevant wallet attributes when decreasing the balance, providing confidence in the service's functionality for handling wallet balance reductions.