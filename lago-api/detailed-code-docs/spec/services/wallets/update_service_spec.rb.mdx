---
title: "update_service_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Wallets::UpdateService` class. It tests various scenarios for updating a wallet, including handling of parameters, error cases, and interactions with recurring transaction rules.

## Code Structure
The test suite is organized around the `#call` method of the `Wallets::UpdateService` class. It includes multiple contexts to test different scenarios and edge cases.

## Symbols

### `RSpec.describe Wallets::UpdateService`
#### Description
This is the main describe block for the `Wallets::UpdateService` test suite.

### `describe '#call'`
#### Description
This describe block focuses on testing the `#call` method of the `Wallets::UpdateService`.

#### Internal Logic
The tests cover various scenarios:
1. Successful wallet update
2. Calling of `Wallets::Balance::RefreshOngoingService`
3. Handling of non-existent wallet
4. Validation of `expiration_at` parameter
5. Handling of recurring transaction rules (in premium version)

### `let` statements
#### Description
These statements set up the test environment by creating necessary objects and defining parameters.

### `it 'updates the wallet'`
#### Description
This test ensures that the wallet is updated correctly with the provided parameters.

#### Internal Logic
1. Calls the update service
2. Checks if the result is successful
3. Verifies that the wallet's attributes are updated correctly

### `it "calls Wallets::Balance::RefreshOngoingService"`
#### Description
This test verifies that the `Wallets::Balance::RefreshOngoingService` is called after updating the wallet.

### `context 'when wallet is not found'`
#### Description
This context tests the scenario where the wallet to be updated doesn't exist.

### `context 'with invalid expiration_at'`
#### Description
This context tests various scenarios with invalid `expiration_at` values.

### `context 'with recurring transaction rules'`
#### Description
This context tests the handling of recurring transaction rules in the premium version.

#### Internal Logic
It includes tests for:
1. Creating a new rule and removing the old one
2. Editing an existing interval rule
3. Changing a rule from interval to threshold
4. Removing all rules
5. Handling invalid number of rules
6. Handling invalid trigger
7. Handling invalid threshold credits value

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads the Rails testing environment |
| Wallets::UpdateService | The service being tested |
| Wallets::Balance::RefreshOngoingService | Called after wallet update |

## Error Handling
The tests cover various error scenarios, including:
- Wallet not found
- Invalid expiration date
- Invalid recurring transaction rules

These errors are expected to be returned as part of the service's result object.

## TODOs
There are no explicit TODOs in the code.