---
title: "create_service_spec.rb"
---

## High-level description
This RSpec test file describes the behavior of the `Wallets::RecurringTransactionRules::CreateService` class. It tests the creation of recurring transaction rules for wallets, focusing on different scenarios such as freemium and premium plans, and various rule configurations.

## Code Structure
The test file defines a single RSpec describe block for the `Wallets::RecurringTransactionRules::CreateService` class. Within this block, it defines multiple contexts and examples to test different aspects of the service's behavior.

## Symbols

### `Wallets::RecurringTransactionRules::CreateService`
#### Description
This is the main class being tested. It is responsible for creating recurring transaction rules for wallets.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| wallet | Wallet | The wallet object for which rules are being created |
| wallet_params | Hash | Parameters for creating the wallet and its rules |

### `#call`
#### Description
This is the main method being tested in the service. It creates recurring transaction rules based on the provided parameters.

#### Internal Logic
The method creates recurring transaction rules with different attributes based on the wallet parameters and the plan type (freemium or premium).

## Test Cases

### Freemium Context
#### Description
Tests the behavior of the service when the plan is freemium.

#### Internal Logic
Verifies that no recurring transaction rules are created for freemium plans.

### Premium Context
#### Description
Tests the behavior of the service when the plan is premium.

#### Internal Logic
1. Verifies that a rule is created with expected attributes for the default case.
2. Tests rule creation when the method is "fixed".
3. Tests rule creation when `invoice_requires_successful_payment` is present.
4. Tests rule creation when transaction metadata is present.
5. Tests rule creation when `invoice_requires_successful_payment` is blank but set on the wallet.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails and RSpec configuration |
| FactoryBot | Used for creating test data |

## Configuration
The test file uses the `lago_premium!` method to simulate a premium plan environment. This method is likely defined in a helper file (not shown in the provided code).

## Error Handling
The test file doesn't explicitly test error handling scenarios. It focuses on successful rule creation under different conditions.

## Notes
1. The test file uses RSpec's `expect` syntax for assertions.
2. It uses FactoryBot to create test data (e.g., `create(:wallet)`).
3. The `lago_premium!` method is used to simulate a premium plan environment, but its implementation is not provided in the given code.
4. The test file covers various scenarios for rule creation, including different methods (target, fixed), triggers (interval, threshold), and additional parameters like `invoice_requires_successful_payment` and `transaction_metadata`.