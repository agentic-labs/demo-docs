---
title: "weekly_service_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Subscriptions::Dates::WeeklyService` class. It tests various methods related to date calculations for weekly subscription billing, including handling different billing times (calendar and anniversary), customer timezones, and pay-in-advance scenarios.

## Code Structure
The test suite is organized into several describe blocks, each focusing on a specific method of the `WeeklyService` class. Within each describe block, there are multiple context blocks that test different scenarios and edge cases.

## Symbols

### `RSpec.describe Subscriptions::Dates::WeeklyService`
#### Description
This is the main describe block for the `WeeklyService` class. It sets up the subject and common let variables used throughout the tests.

#### Internal Logic
- Sets up a subscription with various attributes
- Creates a customer with a timezone
- Creates a plan with weekly interval
- Defines common date variables used in tests

### `describe 'from_datetime'`
#### Description
Tests the `from_datetime` method of the `WeeklyService` class.

#### Internal Logic
- Tests different scenarios for calendar and anniversary billing times
- Checks timezone handling
- Verifies behavior when the subscription is terminated or the plan is pay-in-advance

### `describe 'to_datetime'`
#### Description
Tests the `to_datetime` method of the `WeeklyService` class.

#### Internal Logic
- Tests different scenarios for calendar and anniversary billing times
- Checks timezone handling
- Verifies behavior when the subscription is terminated or the plan is pay-in-advance

### `describe 'charges_from_datetime'`
#### Description
Tests the `charges_from_datetime` method of the `WeeklyService` class.

#### Internal Logic
- Tests different scenarios for calendar and anniversary billing times
- Checks timezone handling
- Verifies behavior when the subscription started mid-period or the plan is pay-in-advance

### `describe 'charges_to_datetime'`
#### Description
Tests the `charges_to_datetime` method of the `WeeklyService` class.

#### Internal Logic
- Tests different scenarios for calendar and anniversary billing times
- Checks timezone handling
- Verifies behavior when the subscription is terminated mid-period or the plan is pay-in-advance

### `describe 'next_end_of_period'`
#### Description
Tests the `next_end_of_period` method of the `WeeklyService` class.

#### Internal Logic
- Tests different scenarios for calendar and anniversary billing times
- Checks timezone handling

### `describe 'compute_previous_beginning_of_period'`
#### Description
Tests the `previous_beginning_of_period` method of the `WeeklyService` class.

#### Internal Logic
- Tests different scenarios for calendar and anniversary billing times
- Checks timezone handling
- Verifies behavior with and without the `current_period` argument

### `describe 'single_day_price'`
#### Description
Tests the `single_day_price` method of the `WeeklyService` class.

#### Internal Logic
- Verifies the calculation of the price for a single day

### `describe 'charges_duration_in_days'`
#### Description
Tests the `charges_duration_in_days` method of the `WeeklyService` class.

#### Internal Logic
- Verifies the duration of the charging period in days

## Dependencies
The test file depends on the following:
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Provides the testing environment and configuration |
| FactoryBot | Used for creating test data |

## Configuration
The test file uses the following configuration:
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| type: :service | Symbol | N/A | Specifies that this is a service test |

## Error Handling
This test file doesn't explicitly test error handling. It focuses on verifying the correct behavior of the `WeeklyService` class methods under various scenarios.

## Logging
There is no specific logging implemented in this test file.