---
title: "yearly_service_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Subscriptions::Dates::YearlyService` class. It tests various date-related calculations for yearly subscriptions, including handling different billing times (calendar and anniversary), timezones, and pay-in-advance scenarios.

## Code Structure
The test suite is organized into several describe blocks, each focusing on a specific method of the `YearlyService` class. These methods include `from_datetime`, `to_datetime`, `charges_from_datetime`, `charges_to_datetime`, `next_end_of_period`, `compute_previous_beginning_of_period`, `single_day_price`, and `charges_duration_in_days`.

## Symbols

### RSpec.describe Subscriptions::Dates::YearlyService
#### Description
This is the main describe block for the `Subscriptions::Dates::YearlyService` class. It sets up the test environment and defines shared variables used across multiple tests.

#### Internal Logic
- Creates a subscription with various attributes (plan, customer, subscription_at, billing_time, started_at)
- Sets up customer, plan, and other related objects
- Defines default values for commonly used variables

### describe 'from_datetime'
#### Description
Tests the `from_datetime` method of the service, which calculates the start date of the billing period.

#### Internal Logic
- Tests different scenarios for calendar and anniversary billing
- Checks timezone handling
- Verifies behavior for terminated subscriptions and pay-in-advance plans

### describe 'to_datetime'
#### Description
Tests the `to_datetime` method, which calculates the end date of the billing period.

#### Internal Logic
- Tests different scenarios for calendar and anniversary billing
- Checks timezone handling
- Verifies behavior for terminated subscriptions and pay-in-advance plans

### describe 'charges_from_datetime'
#### Description
Tests the `charges_from_datetime` method, which determines the start date for charge calculations.

#### Internal Logic
- Tests different scenarios for calendar and anniversary billing
- Checks behavior for subscriptions started mid-period
- Verifies handling of pay-in-advance plans and monthly charge billing

### describe 'charges_to_datetime'
#### Description
Tests the `charges_to_datetime` method, which determines the end date for charge calculations.

#### Internal Logic
- Tests different scenarios for calendar and anniversary billing
- Checks behavior for terminated subscriptions
- Verifies handling of pay-in-advance plans and monthly charge billing

### describe 'next_end_of_period'
#### Description
Tests the `next_end_of_period` method, which calculates the end date of the next billing period.

#### Internal Logic
- Tests different scenarios for calendar and anniversary billing
- Checks timezone handling

### describe 'compute_previous_beginning_of_period'
#### Description
Tests the `previous_beginning_of_period` method, which calculates the start date of the previous billing period.

#### Internal Logic
- Tests different scenarios for calendar and anniversary billing
- Checks timezone handling
- Verifies behavior with and without the `current_period` argument

### describe 'single_day_price'
#### Description
Tests the `single_day_price` method, which calculates the price for a single day of the subscription.

#### Internal Logic
- Tests calculation for regular years and leap years
- Checks for both calendar and anniversary billing

### describe 'charges_duration_in_days'
#### Description
Tests the `charges_duration_in_days` method, which calculates the duration of the charging period in days.

#### Internal Logic
- Tests calculation for regular years and leap years
- Checks for both calendar and anniversary billing
- Verifies behavior when billing charges monthly

## Dependencies
The test file depends on the following:
- Rails testing framework (RSpec)
- FactoryBot for creating test objects
- Various helper modules (not shown in the provided code)

## Configuration
The test file uses the following RSpec configuration:
- `type: :service` to indicate that this is a service test

## TODOs
There are no explicit TODOs in the code.