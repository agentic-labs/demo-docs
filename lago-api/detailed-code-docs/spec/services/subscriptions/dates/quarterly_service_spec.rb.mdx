---
title: "quarterly_service_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Subscriptions::Dates::QuarterlyService` class. It tests various date-related calculations for quarterly subscriptions, including handling different billing times (calendar and anniversary), timezones, and pay-in-advance scenarios.

## Code Structure
The test suite is organized into several describe blocks, each focusing on a specific method of the `QuarterlyService` class. Within these blocks, various contexts are defined to test different scenarios and edge cases.

## Symbols

### RSpec.describe Subscriptions::Dates::QuarterlyService
#### Description
This is the main describe block for the `QuarterlyService` class. It sets up the subject and common let variables used throughout the tests.

#### Internal Logic
- Sets up a subscription with various attributes
- Creates a customer with a timezone
- Creates a plan with interval and pay_in_advance options
- Defines common variables like subscription_at, billing_at, started_at, and timezone

### describe 'from_datetime'
#### Description
Tests the `from_datetime` method of the service.

#### Internal Logic
- Tests calendar and anniversary billing times
- Checks timezone handling
- Verifies behavior when the date is before the start date
- Handles terminated subscriptions

### describe 'to_datetime'
#### Description
Tests the `to_datetime` method of the service.

#### Internal Logic
- Tests calendar and anniversary billing times
- Checks timezone handling
- Verifies behavior for pay-in-advance plans
- Handles terminated subscriptions

### describe 'charges_from_datetime'
#### Description
Tests the `charges_from_datetime` method of the service.

#### Internal Logic
- Tests calendar and anniversary billing times
- Checks timezone handling
- Verifies behavior when the subscription started mid-period
- Handles pay-in-advance plans

### describe 'charges_to_datetime'
#### Description
Tests the `charges_to_datetime` method of the service.

#### Internal Logic
- Tests calendar and anniversary billing times
- Checks timezone handling
- Verifies behavior for terminated subscriptions
- Handles pay-in-advance plans

### describe 'next_end_of_period'
#### Description
Tests the `next_end_of_period` method of the service.

#### Internal Logic
- Tests calendar and anniversary billing times
- Checks timezone handling
- Verifies behavior when the end of the billing month is in the next year

### describe 'previous_beginning_of_period'
#### Description
Tests the `previous_beginning_of_period` method of the service.

#### Internal Logic
- Tests calendar and anniversary billing times
- Checks timezone handling
- Verifies behavior with and without the current_period argument

### describe 'single_day_price'
#### Description
Tests the `single_day_price` method of the service.

#### Internal Logic
- Tests calendar and anniversary billing times
- Handles leap year calculations

### describe 'charges_duration_in_days'
#### Description
Tests the `charges_duration_in_days` method of the service.

#### Internal Logic
- Tests calendar and anniversary billing times
- Handles leap year calculations

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Provides Rails-specific configuration for RSpec |
| FactoryBot | Used for creating test data |

## Error Handling
The test suite doesn't explicitly test error handling, but it does cover various edge cases and scenarios that could potentially cause errors in the service.

## Performance Considerations
The tests don't specifically address performance, but they do cover a wide range of scenarios which helps ensure the service performs correctly under various conditions.

This test suite provides comprehensive coverage for the `QuarterlyService` class, ensuring it handles various billing scenarios, timezones, and date calculations correctly for quarterly subscriptions.