---
title: "update_service_spec.rb"
---

## High-level description
This RSpec test file describes the behavior of the `Subscriptions::UpdateService` class. It tests various scenarios for updating a subscription, including changing its attributes, handling future subscriptions, and dealing with plan overrides.

## Symbols

### `RSpec.describe Subscriptions::UpdateService`
#### Description
This is the main describe block for the `Subscriptions::UpdateService` class, setting up the context for all the tests within.

### `describe '#call'`
#### Description
This describe block focuses on testing the `#call` method of the `Subscriptions::UpdateService` class.

### `subject(:update_service)`
#### Description
Defines the subject of the test as an instance of `Subscriptions::UpdateService` with the given subscription and params.

### `let(:membership)`
#### Description
Creates a test membership using FactoryBot.

### `let(:subscription)`
#### Description
Creates a test subscription using FactoryBot, set to have started one year ago.

### `let(:params)`
#### Description
Defines the parameters to be passed to the update service, including a new name, ending date, and subscription date.

### `it 'updates the subscription'`
#### Description
Tests that the update service successfully updates the subscription with the given parameters.

#### Internal Logic
1. Calls the update service
2. Checks if the result is successful
3. Verifies that the subscription's name, ending date, and subscription date are updated correctly

### `context 'when subscription_at is not passed at all'`
#### Description
Tests the scenario where the `subscription_at` parameter is not provided in the update params.

### `context 'when subscription is starting in the future'`
#### Description
Tests scenarios related to updating a subscription that hasn't started yet.

### `context 'when subscription is nil'`
#### Description
Tests the error handling when trying to update a non-existent subscription.

### `context 'when plan_overrides'`
#### Description
Tests scenarios related to overriding the subscription's plan.

#### Internal Logic
- Uses `lago_premium!` to simulate a premium license
- Tests creating a new plan and updating an existing overridden plan

### `context 'when License is free and plan_overrides is passed'`
#### Description
Tests the error handling when trying to use plan overrides with a free license.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails and RSpec configuration |
| FactoryBot | Creates test data |

## Error Handling
The test suite checks for error scenarios, such as:
- Attempting to update a non-existent subscription
- Trying to use plan overrides with a free license

## Notes
- The test file uses RSpec's `let` syntax for defining variables and `context` blocks for different scenarios.
- It uses FactoryBot for creating test data.
- The `lago_premium!` method is used to simulate a premium license for certain tests.
- The test file covers various edge cases and scenarios, ensuring comprehensive testing of the `Subscriptions::UpdateService`.