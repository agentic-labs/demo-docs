---
title: "create_pay_in_advance_charge_service_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Invoices::CreatePayInAdvanceChargeService` class. It tests the functionality of creating an invoice for a pay-in-advance charge, including fee creation, invoice finalization, and various associated actions like webhook sending and PDF generation.

## Code Structure
The test suite is organized around the `describe 'call'` block, which tests the main functionality of the service. It uses let statements to set up test data and mocks various service calls. The tests cover different scenarios, including creating a new invoice and updating an existing one.

## Symbols

### `RSpec.describe Invoices::CreatePayInAdvanceChargeService`
#### Description
This is the main describe block for the test suite, focusing on the `Invoices::CreatePayInAdvanceChargeService` class.

### `subject(:invoice_service)`
#### Description
Defines the subject of the test, which is an instance of the `Invoices::CreatePayInAdvanceChargeService` class.

### `describe 'call'`
#### Description
This block contains the main tests for the `call` method of the service.

#### Internal Logic
1. Sets up test data and mocks service calls.
2. Tests invoice creation, including attributes, fees, and associated objects.
3. Checks for side effects like webhook sending and PDF generation.
4. Tests scenarios with existing invoices and different customer settings.

## Dependencies
- RSpec
- FactoryBot
- Various application services and models

## Error Handling
The tests check for successful execution and correct attribute values. They don't explicitly test error scenarios.

## Side Effects
The tests verify several side effects of the service call:
- Invoice creation and updates
- Fee creation
- Webhook sending
- PDF generation and email notification
- Payment creation

## Performance Considerations
There are no specific performance tests, but the service involves database transactions and external service calls, which could impact performance in a production environment.

## TODOs
There are no explicit TODOs in the code.

This test file provides comprehensive coverage of the `Invoices::CreatePayInAdvanceChargeService`, ensuring that it correctly creates or updates invoices for pay-in-advance charges, handles fees and taxes, and triggers necessary side effects like webhooks and notifications.