---
title: "update_service_spec.rb"
---

## High-level description
This RSpec file contains unit tests for the `Invoices::UpdateService` class. It tests various scenarios for updating an invoice, including payment status changes, metadata updates, and handling of different invoice types and statuses.

## Code Structure
The test suite is organized around the `call` method of the `Invoices::UpdateService` class. It uses RSpec's `describe` and `context` blocks to group related tests and `let` statements to set up test data.

## Symbols

### `RSpec.describe Invoices::UpdateService`
#### Description
This is the main describe block for the `Invoices::UpdateService` class tests.

### `subject(:invoice_service)`
#### Description
Defines the subject of the test, which is an instance of `Invoices::UpdateService`.

### `let(:invoice)`
#### Description
Creates a test invoice using FactoryBot.

### `let(:update_args)`
#### Description
Defines the parameters to be used for updating the invoice.

### `let(:result)`
#### Description
Stores the result of calling the `call` method on the `invoice_service`.

### `describe 'call'`
#### Description
Groups all tests related to the `call` method of the service.

#### Internal Logic
1. Sets up test doubles for `SegmentTrackJob` and `Invoices::PrepaidCreditJob`.
2. Tests various scenarios for updating invoices, including:
   - Basic invoice updates
   - Payment status updates for different invoice statuses
   - Metadata updates
   - Handling of credit invoices
   - Webhook notifications
   - Error cases

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails testing environment |
| FactoryBot | Creates test data |
| RSpec | Testing framework |

## Error Handling
The tests cover various error scenarios, including:
- Updating payment status on draft invoices
- Invalid payment statuses
- Exceeding metadata limit
- Non-existent invoices
- Validation errors

## Logging
The tests mock `SegmentTrackJob`, which is likely used for analytics logging in the actual service.

## TODOs
None explicitly mentioned in the code.

This test suite provides comprehensive coverage for the `Invoices::UpdateService`, ensuring that it handles various scenarios correctly, including both successful updates and error cases.