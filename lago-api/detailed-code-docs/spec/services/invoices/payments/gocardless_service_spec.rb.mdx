---
title: "gocardless_service_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Invoices::Payments::GocardlessService` class. It tests the creation of GoCardless payments and updating of payment statuses, including various edge cases and error scenarios.

## Code Structure
The test suite is organized into two main describe blocks: `.create` and `.update_payment_status`. Each block contains multiple test cases that cover different scenarios and edge cases for the respective methods.

## Symbols

### `described_class.new(argument)`
#### Description
Creates a new instance of the `Invoices::Payments::GocardlessService` class for testing.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| argument | Invoice | The invoice object to be used in the service |

### `.create`
#### Description
Tests the creation of a GoCardless payment.

#### Internal Logic
1. Sets up necessary mocks and stubs for GoCardless API interactions.
2. Calls the `create` method on the service instance.
3. Verifies the result, including invoice and payment attributes.
4. Checks for specific behaviors in different scenarios (e.g., no payment provider, zero amount, errors).

### `.update_payment_status`
#### Description
Tests the updating of a payment status.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| provider_payment_id | String | The ID of the payment in the provider's system |
| status | String | The new status of the payment |

#### Internal Logic
1. Sets up a payment object with initial status.
2. Calls the `update_payment_status` method on the service instance.
3. Verifies the updated payment and invoice statuses.
4. Checks for specific behaviors in different scenarios (e.g., already succeeded payments, invalid statuses).

## Side Effects
- Creates and updates database records (invoices, payments, customers, etc.).
- Enqueues background jobs (e.g., `SendWebhookJob`).

## Dependencies
- RSpec
- FactoryBot
- GoCardlessPro (mocked)

## Error Handling
The tests cover various error scenarios, including GoCardless API errors and validation failures.

## TODOs
None explicitly mentioned in the code.