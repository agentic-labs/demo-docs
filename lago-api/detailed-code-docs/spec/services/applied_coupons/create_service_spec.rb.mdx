---
title: "create_service_spec.rb"
---

## High-level description
This file contains RSpec tests for the `AppliedCoupons::CreateService` class. It tests various scenarios for creating and applying coupons to customers, including successful applications, error cases, and specific coupon types like percentage-based coupons.

## Code Structure
The test suite is organized into a main `describe` block for the `AppliedCoupons::CreateService`, with nested `context` blocks for different scenarios. It uses RSpec's `let` statements to set up test data and `before` blocks for common setup actions.

## Symbols

### RSpec.describe AppliedCoupons::CreateService
#### Description
This is the main test suite for the `AppliedCoupons::CreateService` class.

#### Internal Logic
The test suite covers various scenarios:
1. Basic coupon application
2. Percentage-based coupons
3. Multiple coupon applications
4. Overridden coupon amounts
5. Error cases (customer not found, coupon not found, etc.)
6. Currency matching
7. Coupon reusability
8. Plan and billable metric limitations

### describe 'create'
#### Description
This nested describe block focuses on testing the `call` method of the `CreateService`.

#### Internal Logic
1. Sets up test data using `let` statements
2. Uses `before` blocks to create necessary database records and stub external service calls
3. Tests different scenarios using `it` blocks and expectations
4. Checks for changes in the database, correct attribute assignments, and error handling

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails testing environment |
| SegmentTrackJob | Mocked for tracking events |

## Error Handling
The tests cover various error scenarios, including:
- Customer not found
- Coupon not found
- Currency mismatch
- Non-reusable coupon reapplication
- Plan and billable metric limitations

## Performance Considerations
The tests use factory methods to create test data, which may impact test performance for large test suites. Consider using `build_stubbed` for non-persisted objects where possible to improve test speed.

## TODOs
There are no explicit TODOs in the code.

This test file provides comprehensive coverage for the `AppliedCoupons::CreateService`, ensuring that coupon application works correctly under various conditions and handles errors appropriately.