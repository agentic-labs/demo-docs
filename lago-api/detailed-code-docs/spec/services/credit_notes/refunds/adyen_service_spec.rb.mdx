---
title: "adyen_service_spec.rb"
---

## High-level description
This file contains RSpec tests for the `CreditNotes::Refunds::AdyenService` class. It tests the functionality of creating and updating refunds through the Adyen payment provider, including error handling and various edge cases.

## Code Structure
The test suite is organized into two main describe blocks: `#create` and `#update_status`, each testing a different method of the `AdyenService` class. Within these blocks, various scenarios are tested using different contexts and expectations.

## Symbols

### `RSpec.describe CreditNotes::Refunds::AdyenService`
#### Description
This is the main describe block for the `CreditNotes::Refunds::AdyenService` class. It sets up the test environment and defines shared variables used across multiple tests.

#### Internal Logic
- Sets up test data including customer, organization, invoice, payment provider, and credit note.
- Creates doubles for Adyen API client and related objects.

### `describe '#create'`
#### Description
Tests the `create` method of the `AdyenService` class.

#### Internal Logic
- Sets up expectations for API calls and external service interactions.
- Tests successful refund creation and various edge cases.
- Checks for proper error handling and webhook delivery in case of Adyen errors.

### `describe '#update_status'`
#### Description
Tests the `update_status` method of the `AdyenService` class.

#### Internal Logic
- Tests updating refund status for various scenarios.
- Checks error handling for invalid statuses and missing refunds.
- Verifies proper webhook delivery and segment tracking.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails testing environment |
| Adyen::Client | Mocked for simulating Adyen API interactions |
| SegmentTrackJob | Mocked for tracking events |
| SendWebhookJob | Mocked for sending webhooks |

## Error Handling
The test suite covers various error scenarios, including:
- Adyen API errors
- Invalid refund statuses
- Missing refunds

## Logging
The test suite doesn't explicitly test logging, but it does verify that certain jobs (like `SegmentTrackJob`) are called with the correct parameters.

## TODOs
There are no explicit TODOs in this test file.