---
title: "create_from_progressive_billing_invoice_spec.rb"
---

## High-level description
This file contains RSpec tests for the `CreditNotes::CreateFromProgressiveBillingInvoice` service. It tests the functionality of creating credit notes from progressive billing invoices, including various scenarios such as zero amount, non-progressive billing invoices, and valid credit note creation.

## Code Structure
The test suite is organized around the `#call` method of the `CreditNotes::CreateFromProgressiveBillingInvoice` service. It sets up a complex scenario with customers, organizations, taxes, invoices, and fees, then tests different outcomes based on varying input parameters.

## Symbols

### RSpec.describe CreditNotes::CreateFromProgressiveBillingInvoice
#### Description
This is the main describe block for the test suite, focusing on the `CreditNotes::CreateFromProgressiveBillingInvoice` service.

### subject(:credit_service)
#### Description
Defines the subject of the test, which is an instance of the `CreditNotes::CreateFromProgressiveBillingInvoice` service.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| progressive_billing_invoice | Invoice | The invoice to create a credit note from |
| amount | Integer | The amount for the credit note |
| reason | Symbol | The reason for creating the credit note |

### let blocks
#### Description
These blocks set up the test environment by creating various objects needed for the tests, such as customers, organizations, taxes, invoices, and fees.

### describe "#call"
#### Description
This describe block focuses on testing the `#call` method of the service.

#### Internal Logic
1. Tests that nothing happens when the amount is zero.
2. Tests the behavior when the amount is greater than zero.
3. Tests the failure case when a non-progressive billing invoice is used.
4. Tests the successful creation of a credit note with the correct amounts and items.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads the Rails testing environment |
| FactoryBot | Used for creating test objects (implied by the use of `create` method) |

## Error Handling
The test suite checks for failure cases, such as when a non-progressive billing invoice is used, by expecting the result not to be successful.

## API/Interface Reference
| Method | Inputs | Outputs | Description |
|:-------|:-------|:--------|:------------|
| #call | None | Result object | Creates a credit note based on the service's initialization parameters |

This test suite provides comprehensive coverage for the `CreditNotes::CreateFromProgressiveBillingInvoice` service, ensuring it behaves correctly under various scenarios and with different input parameters.