---
title: "Overview"
---

## High-level description
This directory contains RSpec test files for various services related to billable metrics in a subscription billing system. The services tested include aggregation factories, different types of aggregation services (count, sum, unique count, etc.), breakdown services, and CRUD operations (create, update, destroy) for billable metrics.

## What does it do?
The tests in this directory verify the functionality of services that handle billable metrics in a subscription-based billing system. These services are responsible for:

1. Creating, updating, and destroying billable metrics
2. Calculating various types of aggregations (count, sum, max, latest, unique count, weighted sum, custom)
3. Providing detailed breakdowns of billable metrics for different aggregation types
4. Handling prorated aggregations for partial billing periods
5. Managing filters and groupings for metric calculations
6. Dealing with different charge types (standard, package, graduated, percentage)
7. Handling pay-in-advance and regular billing scenarios
8. Processing events and calculating metrics for different subscription statuses (e.g., active, terminated, upgraded)

The tests ensure that these services accurately calculate charges based on various metrics and events, handle edge cases, and correctly apply business rules for different billing scenarios.

## Key Files
1. `aggregation_factory_spec.rb`: Tests the factory responsible for creating appropriate aggregation service instances based on billable metric types and charge configurations.

2. `aggregations/` directory: Contains tests for various aggregation services (count, sum, max, latest, unique count, weighted sum, custom).

3. `breakdown/` directory: Tests services that provide detailed breakdowns of billable metrics for sum and unique count aggregations.

4. `prorated_aggregations/` directory: Verifies services that handle prorated aggregations for sum and unique count metrics.

5. `create_service_spec.rb`: Tests the service responsible for creating new billable metrics.

6. `update_service_spec.rb`: Verifies the functionality of updating existing billable metrics.

7. `destroy_service_spec.rb`: Ensures proper handling of billable metric deletion, including soft deletion of related entities.

## Dependencies
The test files rely on the following main dependencies:

1. RSpec: The testing framework used for writing and running the tests.
2. FactoryBot: Used for creating test objects and data.
3. Rails testing helpers: Provides additional testing utilities specific to Rails applications.
4. Various application models and services (e.g., Subscription, BillableMetric, Charge, Event).

## Configuration
The tests use various configuration options to set up different scenarios:

1. Time travel: Many tests use `travel_to` to simulate different time periods for event aggregation.
2. Factory methods: Test objects are created using FactoryBot factories.
3. Premium features: Some tests use `lago_premium!` to enable premium features for testing.
4. Event store class: Most tests use `Events::Stores::PostgresStore` as the event store class.

These configurations allow the tests to cover a wide range of scenarios and ensure the services work correctly under different conditions.

In conclusion, this directory contains a comprehensive set of tests for the billable metrics services, ensuring the accuracy and reliability of the billing calculations across various business models and pricing strategies in a subscription-based system.