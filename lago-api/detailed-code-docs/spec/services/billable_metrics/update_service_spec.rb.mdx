---
title: "update_service_spec.rb"
---

## High-level description
This RSpec test file is for the `BillableMetrics::UpdateService` class. It tests various scenarios for updating a billable metric, including successful updates, handling of validation errors, and specific cases like updating metrics linked to plans or with custom aggregation.

## Code Structure
The test file defines a set of examples using RSpec's `describe` and `context` blocks. It uses FactoryBot to create test data and focuses on testing the `call` method of the `BillableMetrics::UpdateService` class.

## Symbols

### `BillableMetrics::UpdateService#call`
#### Description
This is the main method being tested. It updates a billable metric with the provided parameters.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| billable_metric | BillableMetric | The billable metric to be updated |
| params | Hash | The parameters for updating the metric |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | ServiceResult | The result of the update operation |

#### Internal Logic
The test cases cover various scenarios:
1. Successful update of a billable metric
2. Updating filters
3. Handling validation errors
4. Handling cases where the billable metric is not found
5. Handling custom aggregation attempts
6. Updating metrics linked to plans

## Test Cases

### Successful Update
#### Description
Tests that the service successfully updates a billable metric with valid parameters.

#### Internal Logic
1. Arrange: Set up a billable metric and update parameters
2. Act: Call the update service
3. Assert: Check that the result is successful and the metric attributes are updated correctly

### Updating Filters
#### Description
Tests the ability to update filters for a billable metric.

#### Internal Logic
1. Arrange: Set up a billable metric and filter parameters
2. Act: Call the update service
3. Assert: Check that the number of filters has increased

### Validation Errors
#### Description
Tests the service's response to invalid update parameters.

#### Internal Logic
1. Arrange: Set up invalid parameters (nil name)
2. Act: Call the update service
3. Assert: Check that the result is not successful and contains appropriate error messages

### Billable Metric Not Found
#### Description
Tests the service's response when the billable metric to be updated doesn't exist.

#### Internal Logic
1. Arrange: Set billable_metric to nil
2. Act: Call the update service
3. Assert: Check that the result is not successful and contains a "not found" error

### Custom Aggregation
#### Description
Tests that attempting to update to a custom aggregation type is forbidden.

#### Internal Logic
1. Arrange: Set aggregation_type to 'custom_agg'
2. Act: Call the update service
3. Assert: Check that the result is not successful and contains a forbidden error

### Updating Metric Linked to Plan
#### Description
Tests that only certain attributes can be updated when the metric is linked to a plan.

#### Internal Logic
1. Arrange: Create a plan and charge linked to the billable metric
2. Act: Call the update service with various parameters
3. Assert: Check that only name and description are updated, while other attributes remain unchanged

## Dependencies
The test file depends on the following:
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails and RSpec configuration |
| FactoryBot | Creates test data |

Note: The related `rails_helper.rb` file shows additional dependencies and configurations used across all tests in the project.