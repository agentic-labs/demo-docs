---
title: "Overview"
---

## High-level description
This directory contains RSpec test files for various aggregation services within the BillableMetrics module. These services are responsible for calculating different types of aggregations on billable metrics, such as count, custom, latest, max, sum, unique count, and weighted sum. The tests cover a wide range of scenarios, including different charge types, event configurations, and aggregation methods.

## What does it do?
The test files in this directory verify the correct functionality of different aggregation services used in a billing system. These services are crucial for accurately calculating charges based on various metrics and events. The tests ensure that:

1. Events are correctly counted, summed, or aggregated based on specific rules.
2. Different charge types (e.g., standard, package, graduated, percentage) are handled properly.
3. Pay-in-advance and regular billing scenarios are correctly processed.
4. Grouped aggregations work as expected.
5. Time boundaries and filters are applied correctly to events.
6. Edge cases, such as missing data or out-of-bounds events, are handled gracefully.

By thoroughly testing these services, the system can ensure accurate billing calculations for various business models and pricing strategies.

## Key Files
1. `count_service_spec.rb`: Tests the CountService, which handles event counting for different charge types.
2. `custom_service_spec.rb`: Verifies the CustomService, which allows for user-defined aggregation logic.
3. `latest_service_spec.rb`: Checks the LatestService, which returns the most recent value of a specified field.
4. `max_service_spec.rb`: Tests the MaxService, which finds the maximum value of a specified field.
5. `sum_service_spec.rb`: Verifies the SumService, which calculates the sum of a specified field across events.
6. `unique_count_service_spec.rb`: Tests the UniqueCountService, which counts unique occurrences of a specified field.
7. `weighted_sum_service_spec.rb`: Checks the WeightedSumService, which calculates a weighted sum based on event values and durations.

Each of these files contains comprehensive tests for their respective services, covering various scenarios and edge cases.

## Dependencies
The test files rely on the following dependencies:

1. RSpec: The testing framework used for writing and running the tests.
2. FactoryBot: Used for creating test objects and data.
3. Rails testing helpers: Provides additional testing utilities specific to Rails applications.

These dependencies are typically specified in the project's Gemfile and are loaded through the `rails_helper` in each test file.

## Configuration
The tests use various configuration options to set up different scenarios:

1. Time travel: Many tests use `travel_to` to simulate different time periods for event aggregation.
2. Factory methods: Test objects are created using FactoryBot factories (e.g., `create(:subscription)`, `create(:billable_metric)`).
3. Premium features: Some tests use `lago_premium!` to enable premium features for testing.
4. Event store class: Most tests use `Events::Stores::PostgresStore` as the event store class.

These configurations allow the tests to cover a wide range of scenarios and ensure the services work correctly under different conditions.

In conclusion, this directory contains a comprehensive set of tests for the aggregation services used in the billing system. These tests are crucial for maintaining the accuracy and reliability of the billing calculations across various business models and pricing strategies.