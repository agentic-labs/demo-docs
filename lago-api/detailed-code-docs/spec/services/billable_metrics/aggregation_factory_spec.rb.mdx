---
title: "aggregation_factory_spec.rb"
---

## High-level description
This file contains RSpec tests for the `BillableMetrics::AggregationFactory` service. It tests the factory's ability to create appropriate aggregation service instances based on different billable metric types, charge configurations, and usage scenarios.

## Code Structure
The test suite is organized around the `#new_instance` method of the `BillableMetrics::AggregationFactory` class. It uses various contexts to test different combinations of billable metric types, charge configurations, and usage scenarios.

## Symbols

### `RSpec.describe BillableMetrics::AggregationFactory`
#### Description
This is the main describe block for the `BillableMetrics::AggregationFactory` service. It sets up the test environment and defines the subject of the tests.

### `#new_instance`
#### Description
This method is the main focus of the tests. It creates and returns an instance of the appropriate aggregation service based on the input parameters.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| charge | Object | The charge object containing billable metric and configuration |
| current_usage | Boolean | Indicates if it's for current usage calculation |
| subscription | Object | The subscription object |
| boundaries | Hash | Contains charge period boundaries |

#### Internal Logic
The tests check the type of the returned instance for different combinations of:
1. Billable metric aggregation types (count, latest, max, sum, unique count, weighted sum, custom)
2. Charge configurations (pay in advance, prorated)
3. Usage scenarios (current usage)

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads the Rails testing environment |

## Error Handling
The tests check for `NotImplementedError` in specific scenarios, particularly for pay-in-advance charges that are not current usage calculations.

## Test Cases

### Count Aggregation
Tests that a `BillableMetrics::Aggregations::CountService` instance is returned for count aggregation.

### Latest Aggregation
Tests that a `BillableMetrics::Aggregations::LatestService` instance is returned for latest aggregation. It also checks for `NotImplementedError` when pay-in-advance is true and not current usage.

### Max Aggregation
Similar to Latest Aggregation, it tests for `BillableMetrics::Aggregations::MaxService` instance and `NotImplementedError` scenarios.

### Sum Aggregation
Tests for `BillableMetrics::Aggregations::SumService` instance. When prorated and recurring, it checks for `BillableMetrics::ProratedAggregations::SumService` instance.

### Unique Count Aggregation
Similar to Sum Aggregation, it tests for regular and prorated service instances.

### Weighted Sum Aggregation
Tests for `BillableMetrics::Aggregations::WeightedSumService` instance and `NotImplementedError` scenarios similar to Latest and Max Aggregations.

### Custom Aggregation
Tests that a `BillableMetrics::Aggregations::CustomService` instance is returned for custom aggregation.

This test suite ensures that the `AggregationFactory` correctly instantiates the appropriate service based on the billable metric type and charge configuration, handling special cases like prorated charges and pay-in-advance scenarios.