---
title: "postgres_store_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Events::Stores::PostgresStore` class, which is responsible for handling event-related operations in a PostgreSQL database. The tests cover various methods of the class, including event retrieval, counting, aggregation, and grouping functionalities.

## Code Structure
The test file is organized into several describe blocks, each focusing on a specific method or functionality of the `PostgresStore` class. The tests use FactoryBot to create test data and RSpec expectations to verify the behavior of the class methods.

## Symbols

### `Events::Stores::PostgresStore`
#### Description
This is the main class being tested. It handles event storage and retrieval operations for a PostgreSQL database.

#### Inputs
- `code`: The code of the billable metric
- `subscription`: The subscription object
- `boundaries`: A hash containing time boundaries for event queries
- `filters`: A hash containing various filtering options

#### Internal Logic
The class provides methods for querying and aggregating event data based on various criteria such as grouping, filtering, and time boundaries.

### `#events`
#### Description
Retrieves events based on the provided filters and boundaries.

#### Internal Logic
- Returns a list of events
- Handles grouping and filtering of events

### `#count`
#### Description
Counts the number of unique events.

### `#grouped_count`
#### Description
Counts the number of unique events grouped by specified attributes.

### `#active_unique_property?`
#### Description
Checks if a given event property is active (not removed).

### `#unique_count`
#### Description
Counts the number of unique active event properties.

### `#prorated_unique_count`
#### Description
Calculates the prorated count of unique active event properties.

### `#grouped_unique_count`
#### Description
Calculates the unique count of event properties grouped by specified attributes.

### `#grouped_prorated_unique_count`
#### Description
Calculates the prorated unique count of event properties grouped by specified attributes.

### `#prorated_unique_count_breakdown`
#### Description
Provides a breakdown of add and remove operations for unique event properties.

### `#events_values`
#### Description
Retrieves the values attached to each event.

### `#last_event`
#### Description
Returns the last event in the store.

### `#grouped_last_event`
#### Description
Returns the last events grouped by specified attributes.

### `#prorated_events_values`
#### Description
Calculates the prorated values of event properties.

### `#max`
#### Description
Finds the maximum value among event properties.

### `#grouped_max`
#### Description
Finds the maximum values grouped by specified attributes.

### `#last`
#### Description
Returns the value of the last event.

### `#grouped_last`
#### Description
Returns the last values grouped by specified attributes.

### `#sum`
#### Description
Calculates the sum of event property values.

### `#grouped_sum`
#### Description
Calculates the sum of event property values grouped by specified attributes.

### `#prorated_sum`
#### Description
Calculates the prorated sum of event property values.

### `#grouped_prorated_sum`
#### Description
Calculates the prorated sum of event property values grouped by specified attributes.

### `#sum_date_breakdown`
#### Description
Provides a breakdown of the sum of event property values by date.

### `#weighted_sum`
#### Description
Calculates the weighted sum of event property values.

### `#grouped_weighted_sum`
#### Description
Calculates the weighted sum of event property values grouped by specified attributes.

## Dependencies
The test file depends on the following:
- RSpec testing framework
- FactoryBot for creating test data
- Rails helper methods and configurations

## Configuration
The tests use various configurations for creating test data, including:
- Billable metrics
- Organizations
- Customers
- Subscriptions
- Events with different properties and timestamps

## Error Handling
The tests cover various scenarios, including edge cases and potential error conditions, to ensure the robustness of the `PostgresStore` class.

## Performance Considerations
Some tests, particularly those involving prorated calculations and weighted sums, may have performance implications for large datasets. The actual performance would need to be evaluated in a production-like environment.