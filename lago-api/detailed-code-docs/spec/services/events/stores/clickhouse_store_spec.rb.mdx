---
title: "clickhouse_store_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Events::Stores::ClickhouseStore` class, which is responsible for handling event data stored in Clickhouse. The tests cover various methods for querying and aggregating event data, including filtering, grouping, and performing calculations like sum, max, and weighted sum.

## Code Structure
The test file is organized into multiple describe blocks, each focusing on a specific method or functionality of the `ClickhouseStore` class. The tests use FactoryBot to create test data and mock Clickhouse events.

## Symbols

### RSpec.describe Events::Stores::ClickhouseStore
#### Description
This is the main describe block for the `Events::Stores::ClickhouseStore` class. It sets up the test environment and defines shared variables and methods used across multiple tests.

#### Internal Logic
- Sets up a subject `event_store` with various parameters
- Creates test data using FactoryBot
- Defines helper methods for creating test events
- Skips tests if Clickhouse is not enabled

### .events
#### Description
Tests the `events` method of the `ClickhouseStore` class, which retrieves events based on given filters and groupings.

#### Internal Logic
- Checks the count of returned events
- Tests filtering with `grouped_by_values`
- Tests filtering with `matching_filters` and `ignored_filters`

### .count
#### Description
Tests the `count` method, which returns the number of unique events.

### .grouped_count
#### Description
Tests the `grouped_count` method, which returns the number of unique events grouped by provided groups.

### #active_unique_property?
#### Description
Tests the `active_unique_property?` method, which checks if an event property is active.

#### Internal Logic
- Tests various scenarios with different event configurations
- Checks for active and removed events

### #unique_count
#### Description
Tests the `unique_count` method, which returns the number of unique active event properties.

### #prorated_unique_count
#### Description
Tests the `prorated_unique_count` method, which returns the prorated number of unique active event properties.

### #grouped_unique_count
#### Description
Tests the `grouped_unique_count` method, which returns the unique count of event properties grouped by provided groups.

### #grouped_prorated_unique_count
#### Description
Tests the `grouped_prorated_unique_count` method, which returns the prorated unique count of event properties grouped by provided groups.

### #prorated_unique_count_breakdown
#### Description
Tests the `prorated_unique_count_breakdown` method, which returns the breakdown of add and remove operations for unique event properties.

### .events_values
#### Description
Tests the `events_values` method, which returns the values attached to each event.

### .last_event
#### Description
Tests the `last_event` method, which returns the last event.

### .grouped_last_event
#### Description
Tests the `grouped_last_event` method, which returns the last events grouped by provided groups.

### .prorated_events_values
#### Description
Tests the `prorated_events_values` method, which returns the values attached to each event with prorata on period duration.

### .max
#### Description
Tests the `max` method, which returns the maximum value of event properties.

### .grouped_max
#### Description
Tests the `grouped_max` method, which returns the maximum values grouped by provided groups.

### .last
#### Description
Tests the `last` method, which returns the value of the last event.

### .grouped_last
#### Description
Tests the `grouped_last` method, which returns the last value for each provided group.

### .sum
#### Description
Tests the `sum` method, which returns the sum of event properties.

### .grouped_sum
#### Description
Tests the `grouped_sum` method, which returns the sum of values grouped by provided groups.

### .prorated_sum
#### Description
Tests the `prorated_sum` method, which returns the prorated sum of event properties.

### .grouped_prorated_sum
#### Description
Tests the `grouped_prorated_sum` method, which returns the prorated sum of event properties grouped by provided groups.

### .sum_date_breakdown
#### Description
Tests the `sum_date_breakdown` method, which returns the sum grouped by day.

### .weighted_sum
#### Description
Tests the `weighted_sum` method, which returns the weighted sum of event properties.

### .grouped_weighted_sum
#### Description
Tests the `grouped_weighted_sum` method, which returns the weighted sum of event properties grouped by provided groups.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Provides Rails-specific test configurations and helpers |
| FactoryBot | Used for creating test data |
| Clickhouse::EventsRaw | Represents the Clickhouse events table |

## Configuration
The tests use various configuration options, including:
- `type: :service`: Specifies the type of test
- `clickhouse: true`: Indicates that these tests are for Clickhouse-specific functionality

## Error Handling
The tests include error handling by skipping the entire test suite if Clickhouse is not enabled (`ENV['LAGO_CLICKHOUSE_ENABLED'].blank?`).

## Logging
No specific logging mechanisms are implemented in these tests.

This test file provides comprehensive coverage for the `Events::Stores::ClickhouseStore` class, ensuring that all its methods work correctly with various input scenarios and edge cases.