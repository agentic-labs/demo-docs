---
title: "latest_query_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Events::Stores::Clickhouse::PreAggregated::LatestQuery` service. It tests the functionality of retrieving the latest units for charges, including scenarios with grouped_by and filters, using ClickHouse as the data store.

## Code Structure
The test suite is organized around the `described_class.new(subscription:, boundaries:).call` method, with various contexts testing different scenarios such as basic usage, grouped_by, and filters.

## Symbols

### `RSpec.describe Events::Stores::Clickhouse::PreAggregated::LatestQuery`
#### Description
This is the main describe block for the test suite, focusing on the `LatestQuery` service.

#### Internal Logic
The tests are structured to cover various scenarios:
1. Basic usage without grouping or filters
2. Usage with grouped_by
3. Usage with filters
4. Usage with both grouped_by and filters

### `describe '.call'`
#### Description
This describe block focuses on testing the `call` method of the `LatestQuery` service.

#### Internal Logic
Each test within this block:
1. Sets up the necessary data (subscriptions, charges, events)
2. Calls the `pre_aggregated_query.call` method
3. Asserts the expected results

### `context 'with grouped_by'`
#### Description
This context block tests the scenario where charges are grouped by certain attributes.

#### Internal Logic
- Sets up charges with grouped_by properties
- Creates events with grouped_by attributes
- Asserts that the results are correctly grouped

### `context 'with filters'`
#### Description
This context block tests the scenario where charges have filters applied.

#### Internal Logic
- Sets up billable metric filters and charge filters
- Creates events with filter attributes
- Asserts that the results are correctly filtered

### `context 'with grouped_by and filters'`
#### Description
This context block tests the scenario where both grouping and filtering are applied.

#### Internal Logic
- Sets up charges with both grouped_by properties and filters
- Creates events with both grouped_by and filter attributes
- Asserts that the results are correctly grouped and filtered

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails testing environment and configuration |
| FactoryBot | Used for creating test data |

## Configuration
The test suite uses ClickHouse as the data store, indicated by the `clickhouse: true` metadata on the main describe block.

## Error Handling
The tests primarily focus on successful scenarios. Error handling is not explicitly tested in this file.

## Logging
No specific logging mechanisms are implemented in these tests.