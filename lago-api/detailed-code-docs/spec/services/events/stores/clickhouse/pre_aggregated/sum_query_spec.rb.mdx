---
title: "sum_query_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Events::Stores::Clickhouse::PreAggregated::SumQuery` class. It tests the functionality of aggregating pre-aggregated and enriched events for sum billable metrics, including scenarios with grouped events and filtered events.

## Code Structure
The test suite is organized around the `described_class.new(subscription:, boundaries:).call` method. It sets up various scenarios with different combinations of pre-aggregated events, enriched events, grouped events, and filtered events to test the aggregation logic.

## Symbols

### `RSpec.describe Events::Stores::Clickhouse::PreAggregated::SumQuery`
#### Description
This is the main describe block for the test suite, focusing on the `SumQuery` class within the `Events::Stores::Clickhouse::PreAggregated` module.

### `describe '.call'`
#### Description
This describe block focuses on testing the `call` method of the `SumQuery` class.

#### Internal Logic
1. Sets up test data including organizations, customers, billable metrics, plans, charges, and events.
2. Creates pre-aggregated events and enriched events.
3. Calls the `pre_aggregated_query.call` method.
4. Asserts the expected results, checking the aggregated units for different charges.

### Various `context` blocks
#### Description
These blocks set up different scenarios to test the `call` method under various conditions:
1. With enriched events before and after the boundaries
2. With grouped events
3. With filtered events
4. With both grouped and filtered events

#### Internal Logic
For each context:
1. Sets up specific test data relevant to the scenario.
2. Calls the `pre_aggregated_query.call` method.
3. Asserts the expected results, checking for correct aggregation of units, proper grouping, and filtering.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads the Rails testing environment |

## Configuration
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| type: :service | Symbol | N/A | Specifies the type of test |
| clickhouse: true | Boolean | N/A | Indicates that this test requires Clickhouse |

## Error Handling
The tests use RSpec's `expect` syntax to check for successful results and correct aggregation of units. No specific error handling mechanisms are implemented in the test suite itself.

## Logging
No explicit logging mechanisms are implemented in this test suite.

This test suite provides comprehensive coverage for the `SumQuery` class, ensuring it correctly aggregates pre-aggregated and enriched events for sum billable metrics under various scenarios, including grouping and filtering. The tests are well-structured and cover different edge cases, making it easier to maintain and extend the functionality of the `SumQuery` class.