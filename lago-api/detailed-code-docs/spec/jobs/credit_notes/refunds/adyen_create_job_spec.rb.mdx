---
title: "adyen_create_job_spec.rb"
---

## High-level description
This code defines a RSpec test for the `CreditNotes::Refunds::AdyenCreateJob` job. The test verifies that the job correctly delegates the refund creation process to the `CreditNotes::Refunds::AdyenService`.

## Symbols

### `RSpec.describe CreditNotes::Refunds::AdyenCreateJob, type: :job`
#### Description
This is the main RSpec test block for the `CreditNotes::Refunds::AdyenCreateJob` job.

### `let(:credit_note)`
#### Description
Creates a test `credit_note` object using FactoryBot.

### `let(:refund_service)`
#### Description
Creates a double (mock) of the `CreditNotes::Refunds::AdyenService`.

### `it 'delegates to the adyen refund service'`
#### Description
This test case verifies that the job delegates the refund creation to the Adyen refund service.

#### Internal Logic
1. Sets up expectations for the `CreditNotes::Refunds::AdyenService.new` method to return the mock `refund_service`.
2. Sets up expectations for the `refund_service.create` method to return a `BaseService::Result` object.
3. Executes the job with the `credit_note` as an argument.
4. Verifies that the `CreditNotes::Refunds::AdyenService.new` method was called with the `credit_note`.
5. Verifies that the `refund_service.create` method was called.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads the Rails testing environment and RSpec configuration |
| FactoryBot | Used for creating test objects (credit_note) |

## References
- `CreditNotes::Refunds::AdyenService`: The service class that the job delegates to for creating refunds.
- `BaseService::Result`: A result object returned by the refund service.

This test ensures that the `CreditNotes::Refunds::AdyenCreateJob` correctly initializes the `CreditNotes::Refunds::AdyenService` with the provided credit note and calls its `create` method to process the refund. The test uses doubles and expectations to isolate the job's behavior and verify its interactions with the refund service.