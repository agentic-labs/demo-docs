---
title: "gocardless_create_job_spec.rb"
---

## High-level description
This code defines a RSpec test for the `CreditNotes::Refunds::GocardlessCreateJob` job. The test ensures that the job correctly delegates the refund creation process to the `CreditNotes::Refunds::GocardlessService`.

## Symbols

### `RSpec.describe CreditNotes::Refunds::GocardlessCreateJob, type: :job`
#### Description
This is the main RSpec test block for the `CreditNotes::Refunds::GocardlessCreateJob`. It specifies that we're testing a job.

### `let(:credit_note)`
#### Description
This creates a factory-generated credit note for use in the test.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| credit_note | CreditNote | A factory-created credit note instance |

### `let(:refund_service)`
#### Description
This creates a double (mock) of the `CreditNotes::Refunds::GocardlessService` for use in the test.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| refund_service | Double | A mock of the GocardlessService |

### `it 'delegates to the gocardless refund service'`
#### Description
This is the main test case that verifies the job's behavior.

#### Internal Logic
1. Set up expectations for the `CreditNotes::Refunds::GocardlessService.new` method to return the mock service.
2. Set up expectations for the `create` method on the mock service to return a `BaseService::Result` instance.
3. Execute the job with the created credit note.
4. Verify that the service was initialized with the correct credit note.
5. Verify that the `create` method was called on the service.

## References
- `CreditNotes::Refunds::GocardlessService`
- `BaseService::Result`

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads the Rails testing environment |
| factory_bot | Implied use for creating the credit note (via `create(:credit_note)`) |

This test ensures that the `GocardlessCreateJob` correctly initializes the `GocardlessService` with the provided credit note and calls its `create` method. It uses RSpec's mocking capabilities to isolate the job's behavior and verify its interactions with the service.