---
title: "Overview"
---

## High-level description
This directory contains RSpec test files for various invoice-related jobs in a Rails application. These jobs handle different aspects of invoice processing, including payment creation, PDF generation, finalization, and fee updates. The tests ensure that each job correctly interacts with its corresponding service or performs the expected operations.

## What does it do?
The test files in this directory verify the behavior of background jobs related to invoice processing. Here's a breakdown of the functionality being tested:

1. Creating payments using different providers (Adyen, GoCardless, Stripe)
2. Retrying failed payments
3. Generating PDF versions of invoices
4. Finalizing invoices
5. Refreshing draft invoices
6. Handling prepaid credit invoices
7. Updating fee payment statuses
8. Creating pay-in-advance charges
9. Voiding provider taxes

These tests are crucial for maintaining the reliability and correctness of the invoice processing system, especially when dealing with multiple payment providers, complex retry logic, and various invoice states.

## Key Files

1. `create_pay_in_advance_charge_job_spec.rb`: Tests the job that creates pay-in-advance charges.
2. `finalize_all_job_spec.rb`: Verifies the job that finalizes all invoices in a batch.
3. `finalize_job_spec.rb`: Tests the job responsible for finalizing individual invoices.
4. `generate_pdf_job_spec.rb`: Checks the job that generates PDF versions of invoices.
5. `prepaid_credit_job_spec.rb`: Tests the job that processes prepaid credit invoices.
6. `refresh_draft_job_spec.rb`: Verifies the job that refreshes draft invoices.
7. `retry_all_job_spec.rb`: Tests the job that retries processing for a batch of invoices.
8. `update_fees_payment_status_job_spec.rb`: Checks the job that updates payment statuses for invoice fees.

Additionally, there are subdirectories:
- `payments/`: Contains tests for payment-related jobs (Adyen, GoCardless, Stripe, and retry).
- `provider_taxes/`: Includes tests for provider tax-related jobs (e.g., voiding taxes).

Each test file follows a similar structure:
1. Setting up test data using FactoryBot
2. Creating doubles (mocks) for the respective services when necessary
3. Defining expectations for service initialization and method calls
4. Executing the job
5. Verifying that the expectations were met or the correct changes were made

## Dependencies
The test files rely on the following dependencies:

1. RSpec: The testing framework used for writing and running the tests.
2. FactoryBot: Used for creating test objects (invoices, customers, organizations, etc.).
3. Rails: The tests are written for a Rails application, as evidenced by the use of `rails_helper`.

## Configuration
While there are no explicit configuration files mentioned in the provided summaries, the tests likely rely on the broader RSpec and Rails test configurations. These would typically be found in files like:

- `spec/rails_helper.rb`
- `spec/spec_helper.rb`

These files would set up the testing environment, including FactoryBot configurations and any necessary test database setup.

In conclusion, this directory contains a comprehensive set of tests for the invoice processing jobs in the application. These tests ensure that each job correctly interacts with its corresponding service or performs the expected operations, which is crucial for maintaining the integrity and reliability of the invoice processing workflow.