---
title: "retry_all_job_spec.rb"
---

## High-level description
This file contains a RSpec test suite for the `Invoices::RetryAllJob` job. It verifies that the job correctly calls the `Invoices::RetryBatchService` to retry processing a batch of invoices.

## Symbols

### `RSpec.describe Invoices::RetryAllJob, type: :job`
#### Description
This is the main RSpec describe block that groups all tests related to the `Invoices::RetryAllJob` job.

### `subject(:retry_all_job)`
#### Description
Defines the subject of the test as the `Invoices::RetryAllJob` class.

### `let` blocks
#### Description
These blocks set up the test environment by creating doubles, stubs, and test data:

1. `retry_batch_service`: A double of the `Invoices::RetryBatchService`.
2. `result`: An instance of `BaseService::Result`.
3. `organization`: A factory-created organization.
4. `invoice`: A factory-created invoice associated with the organization.

### `before` block
#### Description
Sets up expectations for the `Invoices::RetryBatchService`:
- Expects `new` to return the `retry_batch_service` double.
- Expects `call` on the `retry_batch_service` to return the `result`.

### `it 'calls the retry batch service'`
#### Description
This is the main test case that verifies the behavior of the `RetryAllJob`.

#### Internal Logic
1. Arrange: The test environment is set up using the `let` and `before` blocks.
2. Act: Calls `perform_now` on the `retry_all_job` with the organization and invoice ID.
3. Assert: 
   - Verifies that `Invoices::RetryBatchService.new` was called.
   - Verifies that `call` was invoked on the `retry_batch_service`.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads the Rails testing environment |
| FactoryBot | Implied by the use of `create` method for generating test data |

## References
The test file references the following components that are not defined within it:
- `Invoices::RetryAllJob`
- `Invoices::RetryBatchService`
- `BaseService::Result`

These components are likely defined in other parts of the application.