---
title: "create_job_spec.rb"
---

## High-level description
This code defines a RSpec test for the `Integrations::Aggregator::CreditNotes::CreateJob` job. It verifies that the job correctly calls the `Integrations::Aggregator::CreditNotes::CreateService` to create a credit note in an aggregator system.

## Symbols

### `RSpec.describe Integrations::Aggregator::CreditNotes::CreateJob, type: :job`
#### Description
This is the main RSpec test group for the `Integrations::Aggregator::CreditNotes::CreateJob`. It specifies that this is a job test.

### `subject(:create_job)`
#### Description
Defines the subject of the test as the described class (`Integrations::Aggregator::CreditNotes::CreateJob`).

### `let(:service)`
#### Description
Creates a double (mock) of the `Integrations::Aggregator::CreditNotes::CreateService`.

### `let(:credit_note)`
#### Description
Creates a test credit note using FactoryBot.

### `let(:result)`
#### Description
Creates a new instance of `BaseService::Result` to be used as the return value of the service call.

### `before` block
#### Description
Sets up the test environment by configuring the mock service to return the predefined result.

#### Internal Logic
1. Configures the `Integrations::Aggregator::CreditNotes::CreateService` to return the mock service when instantiated.
2. Configures the mock service to return the predefined result when its `call` method is invoked.

### `it 'calls the aggregator create credit_note service'`
#### Description
The main test case that verifies the job's behavior.

#### Internal Logic
1. Executes the job with the created credit note.
2. Uses `aggregate_failures` to group multiple expectations.
3. Verifies that the `CreateService` was instantiated.
4. Verifies that the `call` method of the service was invoked.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads the Rails testing environment and configuration |
| FactoryBot | Used for creating test data (credit_note) |
| RSpec | The testing framework used |

## References
- `Integrations::Aggregator::CreditNotes::CreateService`: The service class that the job is expected to use.
- `BaseService::Result`: A class used to represent the result of the service call.

This test ensures that the `CreateJob` correctly delegates the credit note creation to the appropriate service, without testing the actual implementation of the service itself. It focuses on the job's responsibility of invoking the service with the correct parameters.