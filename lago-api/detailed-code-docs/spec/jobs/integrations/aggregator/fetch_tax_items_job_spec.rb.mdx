---
title: "fetch_tax_items_job_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Integrations::Aggregator::FetchTaxItemsJob` job. It verifies that the job correctly calls the `Integrations::Aggregator::TaxItemsService` to fetch tax items for a given integration.

## Symbols

### `RSpec.describe Integrations::Aggregator::FetchTaxItemsJob`
#### Description
This is the main RSpec test suite for the `Integrations::Aggregator::FetchTaxItemsJob` class. It sets up the necessary test environment and defines the test cases for the job.

### `subject(:fetch_tax_items_job)`
#### Description
Defines the subject of the test suite, which is the `Integrations::Aggregator::FetchTaxItemsJob` class.

### `let(:tax_items_service)`
#### Description
Creates a double (mock) of the `Integrations::Aggregator::TaxItemsService` class for testing purposes.

### `let(:integration)`
#### Description
Creates a test instance of a NetSuite integration using FactoryBot.

### `let(:result)`
#### Description
Creates an instance of `BaseService::Result` to simulate the result returned by the tax items service.

### `before` block
#### Description
Sets up the test environment by configuring the mock objects and their expected behavior.

#### Internal Logic
1. Configures the `Integrations::Aggregator::TaxItemsService` to return the mock `tax_items_service` when instantiated.
2. Sets up the `tax_items_service` mock to return the `result` object when its `call` method is invoked.

### Test: "calls the tax items service"
#### Description
Verifies that the `FetchTaxItemsJob` correctly calls the `TaxItemsService` when performed.

#### Internal Logic
1. Arranges: The test environment is set up by the `before` block.
2. Acts: Calls `described_class.perform_now(integration:)` to execute the job.
3. Asserts:
   - Checks if `Integrations::Aggregator::TaxItemsService.new` was called.
   - Verifies that the `call` method of the `tax_items_service` was invoked.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads the Rails testing environment and RSpec configuration |
| FactoryBot | Used to create test data (NetSuite integration) |

## Notes
- The test file uses RSpec's `let` syntax for lazy-loaded test data.
- It employs test doubles (mocks) to isolate the job's behavior from the actual `TaxItemsService` implementation.
- The test focuses on ensuring that the job correctly interacts with the `TaxItemsService` without testing the service's internal logic.