---
title: "perform_sync_job_spec.rb"
---

## High-level description
This code defines an RSpec test suite for the `Integrations::Aggregator::PerformSyncJob` job. It tests the job's behavior when synchronizing data with an external aggregator service, focusing on different scenarios based on the `sync_tax_items` parameter.

## Code Structure
The test suite is organized into two main contexts: when `sync_tax_items` is true and when it's false. Each context tests the interaction with three services: `SyncService`, `ItemsService`, and `TaxItemsService`.

## Symbols

### `RSpec.describe Integrations::Aggregator::PerformSyncJob`
#### Description
This is the main describe block for the `PerformSyncJob` test suite.

### `subject(:perform_sync_job)`
#### Description
Defines the subject of the test, which is the execution of the `PerformSyncJob`.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| integration | NetsuiteIntegration | The integration object for the job |
| sync_tax_items | Boolean | Flag to determine if tax items should be synced |

### `let` statements
#### Description
These statements define variables and doubles used throughout the tests.

| Name | Type | Description |
|:-----|:-----|:------------|
| sync_service | Double | Mock for SyncService |
| items_service | Double | Mock for ItemsService |
| tax_items_service | Double | Mock for TaxItemsService |
| integration | NetsuiteIntegration | A created Netsuite integration |
| result | BaseService::Result | A result object |

### `before` block
#### Description
Sets up the test environment by configuring mock objects and their expected behaviors.

### `context 'when sync_tax_items is true'`
#### Description
Tests the job's behavior when `sync_tax_items` is set to true.

#### Internal Logic
1. Checks if the `SyncService` is called
2. Verifies that the `ItemsService` is called
3. Ensures that the `TaxItemsService` is called

### `context 'when sync_tax_items is false'`
#### Description
Tests the job's behavior when `sync_tax_items` is set to false.

#### Internal Logic
1. Checks if the `SyncService` is called
2. Verifies that the `ItemsService` is called
3. Ensures that the `TaxItemsService` is not called

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails-specific test configurations |
| RSpec | Testing framework |
| FactoryBot | Used for creating test objects (e.g., `create(:netsuite_integration)`) |

## Error Handling
The test suite uses RSpec's `aggregate_failures` to group related expectations, allowing all expectations within a block to be evaluated even if one fails.

This comprehensive test suite ensures that the `PerformSyncJob` correctly interacts with the necessary services based on the `sync_tax_items` parameter, providing confidence in the job's behavior under different scenarios.