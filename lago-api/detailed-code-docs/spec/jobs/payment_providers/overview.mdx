---
title: "Overview"
---

## High-level description

This directory contains RSpec test files for jobs related to payment provider integrations in the application. The tests cover jobs for three payment providers: Adyen, GoCardless, and Stripe. These tests ensure that the jobs correctly interact with their respective services and perform their intended functions for handling events, refreshing webhooks, and registering webhooks.

## What does it do?

The tests in this directory verify the behavior of several important jobs related to payment provider integrations:

1. Adyen HandleEventJob: This job processes Adyen webhook events. The test ensures that when the job is executed, it correctly calls the AdyenService to handle the event for a given organization.

2. GoCardless HandleEventJob: This job processes GoCardless webhook events. The test verifies that the job properly interacts with the GocardlessService to handle events for a given organization.

3. Stripe HandleEventJob: This job processes Stripe webhook events. The test checks that the job correctly delegates event handling to the StripeService.

4. Stripe RefreshWebhookJob: This job is tasked with refreshing Stripe webhooks. The test verifies that the job properly interacts with the StripeService to refresh a webhook for a given Stripe provider.

5. Stripe RegisterWebhookJob: This job is responsible for registering new Stripe webhooks. The test checks that the job correctly calls the RegisterWebhookService when performed.

These tests are crucial for maintaining the integrity of the payment provider integrations, ensuring that webhook events are properly handled, and that webhooks are correctly registered and refreshed as needed.

## Key Files

1. `adyen/handle_event_job_spec.rb`:
   Tests the `PaymentProviders::Adyen::HandleEventJob`. It verifies that the job correctly delegates event handling to the `PaymentProviders::AdyenService`.

2. `gocardless/handle_event_job_spec.rb`:
   Contains tests for the `PaymentProviders::Gocardless::HandleEventJob`. It checks that the job properly interacts with the `PaymentProviders::GocardlessService` to handle events.

3. `stripe/handle_event_job_spec.rb`:
   Tests the `PaymentProviders::Stripe::HandleEventJob`. It ensures that the job correctly calls the `PaymentProviders::StripeService` to handle Stripe events.

4. `stripe/refresh_webhook_job_spec.rb`:
   Contains tests for the `PaymentProviders::Stripe::RefreshWebhookJob`. It verifies that the job properly interacts with the `PaymentProviders::StripeService` to refresh a Stripe webhook.

5. `stripe/register_webhook_job_spec.rb`:
   Tests the `PaymentProviders::Stripe::RegisterWebhookJob`. It ensures that the job correctly calls the `PaymentProviders::Stripe::RegisterWebhookService` when performed.

## Dependencies

The tests in this directory rely on the following dependencies:

1. RSpec: The testing framework used for writing and running the tests.
2. FactoryBot: Used for creating test data, such as organizations and payment provider-specific models.
3. Rails: The tests are written in the context of a Rails application, using the `rails_helper` to load the Rails testing environment and configuration.

## Configuration

The tests use RSpec's configuration and mocking capabilities. Some common patterns used across the test files include:

1. Using `let` blocks to define test data and mock objects.
2. Using `before` blocks to set up test environments and configure mock objects.
3. Using RSpec's `allow` and `expect` methods for stubbing and verifying method calls.

Here's an example of how the tests are typically structured:

```ruby
RSpec.describe PaymentProviders::SomeProvider::SomeJob, type: :job do
  subject(:job) { described_class }

  let(:service) { instance_double(PaymentProviders::SomeService) }
  let(:result) { instance_double(BaseService::Result) }
  let(:organization) { create(:organization) }
  let(:event_data) { { some: 'data' } }

  before do
    allow(PaymentProviders::SomeService).to receive(:new).and_return(service)
    allow(service).to receive(:handle_event).and_return(result)
  end

  it 'calls the appropriate service method' do
    job.perform_now(organization, event_data)
    expect(PaymentProviders::SomeService).to have_received(:new).with(organization)
    expect(service).to have_received(:handle_event).with(event_data)
  end
end
```

This structure allows for isolated testing of the job's behavior, ensuring that it correctly interacts with the associated services without actually executing the service logic.

The tests in this directory play a crucial role in maintaining the reliability of the payment provider integrations within the application. They ensure that the jobs responsible for handling events, refreshing webhooks, and registering new webhooks are functioning correctly, which is essential for proper payment processing and webhook management across multiple payment providers.