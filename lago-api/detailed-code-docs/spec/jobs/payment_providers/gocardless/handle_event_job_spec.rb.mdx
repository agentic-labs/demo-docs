---
title: "handle_event_job_spec.rb"
---

## High-level description
This code defines an RSpec test for the `PaymentProviders::Gocardless::HandleEventJob` job. It verifies that the job correctly calls the `handle_event` method of the `PaymentProviders::GocardlessService` with the provided events JSON.

## Code Structure
The test file contains a single `RSpec.describe` block for the `PaymentProviders::Gocardless::HandleEventJob`. Within this block, it sets up the necessary doubles and stubs, and defines a single test case.

## Symbols

### `RSpec.describe PaymentProviders::Gocardless::HandleEventJob, type: :job`
#### Description
This is the main describe block for the job test. It sets up the context for testing the `HandleEventJob`.

### `subject(:handle_event_job)`
#### Description
Defines the subject of the test as the described class (`HandleEventJob`).

### `let(:gocardless_service)`
#### Description
Creates a double of the `PaymentProviders::GocardlessService`.

### `let(:result)`
#### Description
Creates a new instance of `BaseService::Result`.

### `let(:organization)`
#### Description
Creates a new organization using FactoryBot.

### `let(:gocardless_events)`
#### Description
Defines an empty array to represent Gocardless events.

### `before` block
#### Description
Sets up the test environment by stubbing the `PaymentProviders::GocardlessService.new` method to return the double, and stubbing the `handle_event` method on the service double to return the result.

### `it 'calls the handle event service'`
#### Description
The main test case that verifies the job calls the correct service method with the provided events.

#### Internal Logic
1. Calls the `perform_now` method on the job with the events JSON.
2. Expects that `PaymentProviders::GocardlessService.new` was called.
3. Expects that `handle_event` was called on the service double.

## Dependencies
- RSpec
- FactoryBot (implied by the use of `create(:organization)`)
- Rails (implied by the use of `type: :job`)

## Error Handling
This test file does not explicitly test error handling scenarios.

Your response should not exceed 3000 words or 4000 tokens. Focus on providing clear, concise information that can be directly inferred from the code. Include optional sections only when they provide significant value for understanding the code.