---
title: "can_require_permissions_spec.rb"
---

## High-level description
This code defines a RSpec test suite for the `CanRequirePermissions` module, which is used in GraphQL mutations to enforce permission checks. The test suite verifies that the mutation behaves correctly when the required permissions are present and when they are missing.

## Code Structure
The code is structured into two main parts:
1. A test module `CanRequirePermissionsSpec` that defines mock GraphQL types and mutations.
2. RSpec tests that use the mock schema to test the `CanRequirePermissions` module's behavior.

## References
- `CanRequirePermissions` module
- `LagoApiSchema`
- `Permission::EMPTY_PERMISSIONS_HASH`

## Symbols

### `CanRequirePermissionsSpec` module
#### Description
This module contains mock GraphQL types and mutations used for testing the `CanRequirePermissions` module.

#### Internal Logic
- Defines a `ThingType` with `name` and `count` fields.
- Defines a `RenameThingMutation` that includes `CanRequirePermissions` and requires the 'things:rename' permission.
- Sets up a `ThingsMutationType` and a `TestApiSchema` for testing purposes.

### `RSpec.describe CanRequirePermissions` block
#### Description
This block contains the actual test cases for the `CanRequirePermissions` module.

#### Internal Logic
- Defines a GraphQL mutation query string for renaming a thing.
- Tests two scenarios:
  1. With correct permissions: Verifies that the mutation succeeds.
  2. Without required permissions: Checks that an appropriate error is returned.

### `context 'with a the correct permissions'` block
#### Description
Tests the behavior when the required permission is present.

#### Internal Logic
- Executes the mutation with the required permission in the context.
- Asserts that the mutation returns the expected result.

### `context 'without a current user'` block
#### Description
Tests the behavior when the required permission is missing.

#### Internal Logic
- Executes the mutation without the required permission in the context.
- Asserts that an error with the correct message and extensions is returned.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads the Rails testing environment and configuration |
| CanRequirePermissions | The module being tested |
| LagoApiSchema | Base schema class used for creating the test schema |
| Permission::EMPTY_PERMISSIONS_HASH | Used to simulate a context without permissions |

## Error Handling
The test suite specifically checks for error handling when permissions are missing. It verifies that:
- An error is returned with the message "Missing permissions".
- The error includes extensions with status, code, and required permissions.