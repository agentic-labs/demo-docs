---
title: "create_spec.rb"
---

## High-level description
This code is a RSpec test suite for the `Mutations::AdjustedFees::Create` GraphQL mutation. It verifies the behavior of creating an adjusted fee, including permission checks and handling of different invoice states.

## Code Structure
The test suite is organized as a single RSpec describe block with multiple test cases and contexts. It uses shared examples for common behavior and sets up necessary test data using FactoryBot.

## Symbols

### RSpec.describe Mutations::AdjustedFees::Create
#### Description
This is the main describe block for the test suite, focusing on the `Create` mutation for adjusted fees.

### let(:required_permission)
#### Description
Defines the required permission for the mutation.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| required_permission | String | The permission required to execute the mutation |

### let(:membership)
#### Description
Creates a test membership using FactoryBot.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| membership | Membership | A test membership object |

### let(:fee)
#### Description
Creates a test charge fee using FactoryBot.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| fee | ChargeFee | A test charge fee object |

### let(:input)
#### Description
Defines the input data for the GraphQL mutation.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| input | Hash | Input data for the createAdjustedFee mutation |

### let(:mutation)
#### Description
Defines the GraphQL mutation query string.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| mutation | String | GraphQL mutation query for createAdjustedFee |

### before
#### Description
Sets the associated invoice of the fee to draft state before each test.

### around
#### Description
Wraps each test in a lago_premium! block, likely enabling premium features for testing.

### it_behaves_like
#### Description
Includes shared examples for common behavior checks.

### it 'creates an adjusted fee'
#### Description
Tests the successful creation of an adjusted fee.

#### Internal Logic
1. Executes the GraphQL mutation with necessary context and input.
2. Verifies that the returned ID matches the original fee ID.

### context 'with finalized invoice'
#### Description
Tests the behavior when trying to create an adjusted fee for a finalized invoice.

#### Internal Logic
1. Sets the invoice to finalized state.
2. Executes the GraphQL mutation.
3. Expects a forbidden error to be returned.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails testing environment and configurations |
| FactoryBot | Creates test data objects |
| GraphQL | Defines and executes GraphQL queries |

## Error Handling
The test suite checks for forbidden errors when attempting to create an adjusted fee for a finalized invoice.