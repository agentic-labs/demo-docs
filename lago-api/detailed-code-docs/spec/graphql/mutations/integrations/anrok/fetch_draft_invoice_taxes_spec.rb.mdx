---
title: "fetch_draft_invoice_taxes_spec.rb"
---

## High-level description
This RSpec test file describes the behavior of the `Mutations::Integrations::Anrok::FetchDraftInvoiceTaxes` GraphQL mutation. It tests the functionality of fetching draft invoice taxes from the Anrok integration, ensuring that the mutation correctly processes the input and returns the expected tax results.

## Code Structure
The test file defines a set of let variables to set up the test environment, including creating necessary database records and mocking external HTTP requests. It then defines the GraphQL mutation and tests its behavior under different conditions.

## Symbols

### RSpec.describe Mutations::Integrations::Anrok::FetchDraftInvoiceTaxes
#### Description
This is the main test suite for the FetchDraftInvoiceTaxes mutation. It sets up the test environment and defines the test cases.

#### Internal Logic
1. Sets up necessary database records (membership, organization, integration, customer, add-ons, etc.)
2. Mocks the HTTP client and response
3. Defines the GraphQL mutation
4. Tests the mutation's behavior

### let variables
#### Description
These variables set up the test environment by creating necessary database records and defining test data.

### before block
#### Description
This block sets up the test environment before each test is run. It creates necessary records and mocks the HTTP client and response.

### it_behaves_like shared examples
#### Description
These shared examples test common behaviors across different mutations, such as requiring a current user, current organization, and specific permissions.

### it 'fetches tax results'
#### Description
This is the main test case that verifies the mutation's behavior when fetching tax results.

#### Internal Logic
1. Executes the GraphQL mutation with test input
2. Verifies the structure and content of the returned data
3. Checks specific fields in the response, including item details and tax breakdown

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Provides Rails-specific test configurations and helpers |
| LagoHttpClient::Client | Used to mock HTTP requests to the Anrok API |

## Error Handling
The test doesn't explicitly test error handling, but it implicitly checks for successful execution of the mutation.

## API/Interface Reference
| Endpoint | Method | Request | Response | Description |
|:---------|:-------|:--------|:---------|:------------|
| /graphql | POST | GraphQL mutation with input | Collection of tax results | Fetches draft invoice taxes from Anrok |

The mutation takes a `FetchDraftInvoiceTaxesInput` and returns a collection of tax results, including item details and tax breakdown.