---
title: "create_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Mutations::Customers::Create` GraphQL mutation. It verifies the functionality of creating a customer through the GraphQL API, including various input parameters, permissions, and validation checks.

## Code Structure
The test suite is organized into several contexts and examples, testing different aspects of the customer creation mutation. It uses shared examples for common checks and includes tests for both standard and premium features.

## Symbols

### RSpec.describe Mutations::Customers::Create
#### Description
This is the main describe block for the test suite, focusing on the `Mutations::Customers::Create` GraphQL mutation.

#### Internal Logic
The test suite sets up necessary data using let statements, defines the GraphQL mutation, and includes various test cases to verify the mutation's behavior.

### let statements
#### Description
These statements define variables and objects used throughout the test suite, such as `required_permissions`, `membership`, `organization`, `stripe_provider`, and `tax`.

### mutation
#### Description
Defines the GraphQL mutation for creating a customer, including all the fields to be returned in the response.

### before block
#### Description
Sets up a stub for the Stripe API call to create a checkout session.

### Shared examples
#### Description
The test suite includes shared examples for checking required permissions and current user/organization.

### Main test case: 'creates a customer'
#### Description
This test case verifies that a customer can be successfully created with all the provided input parameters.

#### Internal Logic
1. Sets up necessary data (stripe_provider)
2. Executes the GraphQL mutation with various input parameters
3. Verifies the response data matches the input and expected values

### Context: 'with premium feature'
#### Description
Tests the creation of a customer with premium features enabled.

#### Internal Logic
1. Enables premium features using `lago_premium!`
2. Executes the GraphQL mutation with premium-specific parameters
3. Verifies the response includes premium-specific fields

### Context: 'with validation errors'
#### Description
Tests the behavior of the mutation when invalid input is provided.

#### Internal Logic
1. Executes the GraphQL mutation with invalid input (country: 0)
2. Verifies that the response contains errors

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Provides Rails-specific test configuration |
| RSpec | Testing framework |
| FactoryBot | Used for creating test data |
| WebMock | Used for stubbing HTTP requests (Stripe API) |

## Error Handling
The test suite includes a specific context for testing validation errors, ensuring that the mutation properly handles and returns errors for invalid input.