---
title: "update_spec.rb"
---

## High-level description
This RSpec test file describes the behavior of the `Mutations::Coupons::Update` GraphQL mutation. It verifies that the mutation correctly updates a coupon's attributes, including its name, code, description, amount, expiration, and associated plans or billable metrics.

## Code Structure
The test file contains two main contexts: one for updating a coupon with plan limitations and another for updating a coupon with billable metric limitations. Each context includes a test that executes the GraphQL mutation and verifies the expected results.

## Symbols

### RSpec.describe Mutations::Coupons::Update
#### Description
This is the main test suite for the `Mutations::Coupons::Update` GraphQL mutation. It sets up the necessary test data and defines the GraphQL mutation query.

#### Internal Logic
1. Sets up test data using FactoryBot (membership, coupon, plan, billable metric).
2. Defines the GraphQL mutation query.
3. Includes shared examples for permission checks.
4. Contains individual test cases for updating a coupon.

### it 'updates a coupon'
#### Description
This test case verifies that the mutation successfully updates a coupon with new attributes, including plan limitations.

#### Internal Logic
1. Executes the GraphQL mutation with updated coupon attributes.
2. Verifies that the returned data matches the expected values for all updated fields.

### context 'with billable metric limitations'
#### Description
This context focuses on testing the mutation when updating a coupon with billable metric limitations instead of plan limitations.

#### Internal Logic
1. Redefines the GraphQL mutation query to include billable metric-related fields.
2. Contains a test case similar to the plan limitation test, but with billable metric limitations.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads the Rails testing environment and configuration |
| FactoryBot | Creates test data (membership, coupon, plan, billable metric) |
| GraphQL | Defines and executes the GraphQL mutation |

## Error Handling
The test file doesn't explicitly test error handling scenarios. It focuses on the successful update of a coupon.

## API/Interface Reference
| Mutation | Input | Response | Description |
|:---------|:------|:---------|:------------|
| updateCoupon | UpdateCouponInput | Updated coupon fields | Updates a coupon with the provided attributes |

The `UpdateCouponInput` includes fields such as `id`, `name`, `couponType`, `frequency`, `code`, `description`, `amountCents`, `amountCurrency`, `expiration`, `expirationAt`, `reusable`, and `appliesTo` (which can contain `planIds` or `billableMetricIds`).

The response includes the updated coupon fields such as `id`, `name`, `code`, `description`, `status`, `amountCents`, `amountCurrency`, `expiration`, `expirationAt`, `limitedPlans`, `plans`, `limitedBillableMetrics`, `billableMetrics`, and `reusable`.