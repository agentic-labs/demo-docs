---
title: "retry_all_payments_spec.rb"
---

## High-level description
This RSpec test file describes the behavior of the `Mutations::Invoices::RetryAllPayments` GraphQL mutation. It verifies that the mutation requires proper authentication, authorization, and correctly schedules failed invoices for payment retry.

## Code Structure
The test file defines a set of shared examples for common requirements and a main context for testing the mutation's behavior with valid preconditions.

## Symbols

### RSpec.describe Mutations::Invoices::RetryAllPayments
#### Description
This is the main describe block for the test suite, focusing on the RetryAllPayments mutation.

#### Internal Logic
1. Sets up necessary test data using let statements.
2. Defines the GraphQL mutation query.
3. Includes shared examples for common requirements.
4. Tests the mutation's behavior with valid preconditions.

### let statements
#### Description
These statements define the test data and setup required for the tests.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| membership | Membership | A factory-created membership |
| organization | Organization | The organization associated with the membership |
| user | User | The user associated with the membership |
| gocardless_payment_provider | GocardlessProvider | A factory-created Gocardless provider for the organization |
| customer_first, customer_second | Customer | Factory-created customers for the organization |
| gocardless_customer_first, gocardless_customer_second | GocardlessCustomer | Factory-created Gocardless customers associated with the customers |
| invoice_first, invoice_second | Invoice | Factory-created invoices with failed payment status |

### context 'with valid preconditions'
#### Description
This context block tests the mutation's behavior when all preconditions are met.

#### Internal Logic
1. Sets up the test environment with necessary data.
2. Executes the GraphQL mutation.
3. Verifies that the returned data includes the IDs of the invoices scheduled for retry.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails testing environment and configurations |
| FactoryBot | Used for creating test data |
| GraphQL | Used for defining and executing the mutation |

## Error Handling
The test implicitly checks for error handling by expecting the mutation to return specific data when executed successfully.

## API/Interface Reference
| Endpoint | Method | Request | Response | Description |
|:---------|:-------|:--------|:---------|:------------|
| retryAllInvoicePayments | Mutation | RetryAllInvoicePaymentsInput | Collection of invoice IDs | Retries payments for all failed invoices |

This test file ensures that the RetryAllPayments mutation for invoices works correctly, requiring proper authentication and authorization, and successfully scheduling failed invoices for payment retry when all preconditions are met.