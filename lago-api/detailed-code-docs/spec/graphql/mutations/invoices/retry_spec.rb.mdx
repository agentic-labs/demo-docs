---
title: "retry_spec.rb"
---

## High-level description
This RSpec test file describes the behavior of the `Mutations::Invoices::Retry` GraphQL mutation. It tests the functionality of retrying a failed invoice, including the necessary permissions, data setup, and expected outcomes.

## Code Structure
The test file is structured as an RSpec describe block for the `Mutations::Invoices::Retry` mutation. It includes several let blocks for setting up test data, a before block for common setup, and example blocks for testing different scenarios.

## Symbols

### RSpec.describe Mutations::Invoices::Retry
#### Description
This is the main describe block for the test suite, focusing on the `Mutations::Invoices::Retry` GraphQL mutation.

### let blocks
#### Description
These blocks set up the test data and dependencies needed for the tests.

#### Internal Logic
- Creates necessary database records (membership, organization, customer, invoice, subscription, plan, fee, integration, etc.)
- Sets up mock objects for HTTP client and response
- Defines the GraphQL mutation query

### before block
#### Description
Sets up common preconditions for the tests.

#### Internal Logic
- Creates integration_collection_mapping and fee_subscription
- Sets up mocks for LagoHttpClient and its response

### it_behaves_like shared examples
#### Description
These shared examples test common behaviors across different GraphQL mutations.

#### Internal Logic
- 'requires current user': Ensures the mutation requires a current user
- 'requires current organization': Ensures the mutation requires a current organization
- 'requires permission': Checks if the mutation requires the 'invoices:update' permission

### context 'with valid preconditions'
#### Description
Tests the behavior of the mutation when all preconditions are met.

#### Internal Logic
- Executes the GraphQL mutation with valid inputs
- Checks if the returned invoice has the expected ID and status

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails testing environment |
| LagoHttpClient::Client | Mocked for HTTP requests |

## Error Handling
The test doesn't explicitly test error handling, but it implicitly checks for successful execution of the mutation.

## API/Interface Reference
| Endpoint | Method | Request | Response | Description |
|:---------|:-------|:--------|:---------|:------------|
| retryInvoice | Mutation | {id: invoice.id} | {id: String, status: String} | Retries a failed invoice |

## Performance Considerations
This test file doesn't directly address performance considerations, as it's focused on functionality testing.