---
title: "retry_tax_provider_voiding_spec.rb"
---

## High-level description
This code defines an RSpec test for the `Mutations::Invoices::RetryTaxProviderVoiding` GraphQL mutation. It verifies the behavior of retrying tax provider voiding for an invoice, focusing on the mutation's ability to handle the retry process and return the updated invoice status.

## Code Structure
The test file is structured as an RSpec describe block for the `Mutations::Invoices::RetryTaxProviderVoiding` mutation. It sets up necessary test data, mocks external dependencies, and defines test cases to verify the mutation's behavior.

## Symbols

### RSpec.describe Mutations::Invoices::RetryTaxProviderVoiding
#### Description
This is the main describe block for the test suite, focusing on the RetryTaxProviderVoiding mutation.

#### Internal Logic
1. Sets up test data (user, organization, customer, invoice, etc.)
2. Mocks external dependencies (LagoHttpClient)
3. Defines shared examples for permission checks
4. Tests the mutation's behavior with valid preconditions

### let blocks
#### Description
These blocks define the test data and mocks used throughout the test suite.

#### Inputs
Various test data such as user, organization, customer, invoice, etc.

#### Outputs
Instantiated test objects and mocked responses

### before block
#### Description
Sets up the test environment before running the tests.

#### Internal Logic
1. Creates necessary database records
2. Mocks the LagoHttpClient to return a predefined response

### it_behaves_like blocks
#### Description
These blocks include shared examples to test common behaviors.

#### Internal Logic
Verifies that the mutation requires a current user, current organization, and specific permissions.

### context 'with valid preconditions'
#### Description
Tests the mutation's behavior when all preconditions are met.

#### Internal Logic
1. Executes the GraphQL mutation with valid inputs
2. Verifies that the returned data matches the expected invoice status

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails testing environment and configurations |
| LagoHttpClient::Client | Mocked to simulate external API calls |

## Error Handling
The test implicitly checks for error handling by expecting successful execution of the mutation. Explicit error handling tests are not present in this snippet.

## API/Interface Reference
| Endpoint | Method | Request | Response | Description |
|:---------|:-------|:--------|:---------|:------------|
| retryTaxProviderVoiding | Mutation | `{input: {id: invoice.id}}` | `{id: String, status: String}` | Retries tax provider voiding for an invoice |

This test suite ensures that the RetryTaxProviderVoiding mutation correctly handles the retry process for tax provider voiding and returns the updated invoice status.