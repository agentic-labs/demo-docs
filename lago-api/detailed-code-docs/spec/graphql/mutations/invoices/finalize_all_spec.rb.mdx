---
title: "finalize_all_spec.rb"
---

## High-level description
This code is a RSpec test suite for the `Mutations::Invoices::FinalizeAll` GraphQL mutation. It verifies the behavior of finalizing all invoices, including permission checks and the correct return of finalized invoice IDs.

## Code Structure
The test suite is organized around a single describe block for the `Mutations::Invoices::FinalizeAll` mutation. It sets up necessary test data using let blocks and includes shared examples for common checks. The main test case verifies the mutation's functionality when given valid preconditions.

## Symbols

### RSpec.describe Mutations::Invoices::FinalizeAll
#### Description
This is the main describe block that groups all tests related to the FinalizeAll mutation for invoices.

### let blocks
#### Description
These blocks set up the test data and dependencies needed for the tests. They define objects such as membership, organization, user, customer, invoice, subscription, and plan.

### mutation
#### Description
This block defines the GraphQL mutation query string used in the test.

### it_behaves_like shared examples
#### Description
These lines include shared example groups that test common behaviors such as requiring a current user, current organization, and specific permissions.

### context 'with valid preconditions'
#### Description
This context block contains the main test case for the mutation when all preconditions are met.

#### Internal Logic
1. Executes the GraphQL mutation with the necessary context (organization, user, permissions).
2. Retrieves the result data from the mutation response.
3. Extracts the invoice IDs from the returned collection.
4. Asserts that the returned invoice IDs include the ID of the invoice created in the test setup.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails and RSpec configuration |
| FactoryBot | Used for creating test data |
| GraphQL | Testing GraphQL mutations |

## Error Handling
The test implicitly checks for errors by expecting the mutation to return successfully with the correct data. Any unexpected errors would cause the test to fail.

## API/Interface Reference
| Endpoint | Method | Request | Response | Description |
|:---------|:-------|:--------|:---------|:------------|
| finalizeAllInvoices | Mutation | FinalizeAllInvoicesInput | Collection of invoice IDs | Finalizes all draft invoices |

Note: This is a GraphQL mutation, not a REST API endpoint.