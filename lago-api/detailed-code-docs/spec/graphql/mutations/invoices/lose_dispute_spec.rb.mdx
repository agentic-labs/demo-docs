---
title: "lose_dispute_spec.rb"
---

## High-level description
This code is a RSpec test suite for the `Mutations::Invoices::LoseDispute` GraphQL mutation. It verifies that the mutation correctly marks an invoice's payment dispute as lost, ensuring proper authorization and data updates.

## Code Structure
The test suite defines a set of let variables to set up the test environment and a GraphQL mutation query. It then uses shared examples for common authorization checks and includes a specific test case for the mutation's functionality.

## Symbols

### RSpec.describe Mutations::Invoices::LoseDispute
#### Description
This is the main describe block for the test suite, focusing on the `Mutations::Invoices::LoseDispute` GraphQL mutation.

### let variables
#### Description
These variables set up the test environment with necessary objects and data.

| Name | Type | Description |
|:-----|:-----|:------------|
| required_permission | String | The permission required to execute the mutation |
| membership | Membership | A factory-created membership object |
| organization | Organization | The organization associated with the membership |
| customer | Customer | A factory-created customer associated with the organization |
| invoice | Invoice | A factory-created invoice with specific attributes |
| mutation | String | The GraphQL mutation query |

### Shared examples
#### Description
These are reusable test cases for common authorization checks.

| Name | Description |
|:-----|:------------|
| 'requires current user' | Ensures the mutation requires a current user |
| 'requires current organization' | Ensures the mutation requires a current organization |
| 'requires permission' | Ensures the mutation requires the 'invoices:update' permission |

### Main test case
#### Description
This test case verifies that the mutation correctly marks the payment dispute as lost.

#### Internal Logic
1. Freezes time to ensure consistent timestamps
2. Executes the GraphQL mutation with necessary inputs and context
3. Checks the result data for the presence of an ID and a `paymentDisputeLostAt` timestamp

## Dependencies
The test suite relies on the following dependencies:
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails and RSpec configuration |
| FactoryBot | Creates test objects |
| GraphQL | Executes and tests GraphQL queries |

## Configuration
The test uses the following configuration:
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| type | Symbol | :graphql | Specifies the type of test for RSpec |

## Error Handling
The test doesn't explicitly handle errors but relies on RSpec's built-in error handling and reporting mechanisms.

## API/Interface Reference
The test focuses on the following GraphQL mutation:
| Mutation | Input | Output | Description |
|:---------|:------|:-------|:------------|
| loseInvoiceDispute | LoseInvoiceDisputeInput | id, paymentDisputeLostAt | Marks an invoice's payment dispute as lost |