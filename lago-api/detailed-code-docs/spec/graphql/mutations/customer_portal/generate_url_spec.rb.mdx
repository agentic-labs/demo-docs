---
title: "generate_url_spec.rb"
---

## High-level description
This RSpec test file describes the behavior of the `Mutations::CustomerPortal::GenerateUrl` GraphQL mutation. It verifies that the mutation requires a current user and organization, and when given a valid input, it returns a customer portal URL for premium license holders.

## Code Structure
The test file defines a set of let variables to set up the test environment and a GraphQL mutation query. It then uses shared examples for common checks and defines a specific test case for premium license holders.

## Symbols

### RSpec.describe Mutations::CustomerPortal::GenerateUrl
#### Description
This is the main describe block for the test suite, focusing on the `Mutations::CustomerPortal::GenerateUrl` GraphQL mutation.

### let variables
#### Description
These variables set up the test environment by creating necessary objects:
- `membership`: A factory-created membership object
- `organization`: The organization associated with the membership
- `customer`: A factory-created customer associated with the organization
- `user`: The user associated with the membership
- `mutation`: A GraphQL mutation query string for generating a customer portal URL

### it_behaves_like 'requires current user'
#### Description
This shared example ensures that the mutation requires a current user to be present.

### it_behaves_like 'requires current organization'
#### Description
This shared example ensures that the mutation requires a current organization to be present.

### context 'when licence is premium'
#### Description
This context block tests the behavior of the mutation when the license is premium.

#### Internal Logic
1. Uses the `lago_premium!` method to set up a premium license environment.
2. Executes the GraphQL mutation with the necessary inputs.
3. Verifies that the returned URL includes '/customer-portal/'.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails and RSpec configuration |
| FactoryBot | Used for creating test objects |
| GraphQL | Used for defining and executing the mutation |

## Error Handling
The test implicitly checks for error handling by expecting a successful response from the mutation. Any errors would cause the test to fail.

## Notes
1. The test file uses shared examples, which are likely defined in a separate file.
2. The `lago_premium!` method is used to simulate a premium license environment, but its implementation is not shown in the provided code.
3. The `execute_graphql` method is likely a helper method defined elsewhere to simplify GraphQL query execution in tests.

This test ensures that the `GenerateUrl` mutation works correctly for premium license holders, returning a valid customer portal URL when given proper inputs.