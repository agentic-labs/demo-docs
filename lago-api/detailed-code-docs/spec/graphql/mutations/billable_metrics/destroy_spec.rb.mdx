---
title: "destroy_spec.rb"
---

## High-level description
This code defines a RSpec test suite for the `Mutations::BillableMetrics::Destroy` GraphQL mutation. It verifies that the mutation correctly deletes a billable metric, and checks for proper user authentication and permission requirements.

## Code Structure
The test suite is organized as a single RSpec describe block, containing several test cases and shared examples. It sets up necessary test data and defines a GraphQL mutation query for testing.

## Symbols

### RSpec.describe Mutations::BillableMetrics::Destroy
#### Description
This is the main describe block for the test suite, focusing on the `Destroy` mutation for billable metrics.

#### Internal Logic
1. Sets up test data (membership, organization, billable metric)
2. Defines the GraphQL mutation query
3. Includes shared examples for user authentication and permission checks
4. Tests the successful deletion of a billable metric

### let(:required_permission)
#### Description
Defines the required permission for executing the billable metric deletion.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| required_permission | String | The permission required to delete billable metrics |

### let(:membership)
#### Description
Creates a test membership using FactoryBot.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| membership | Membership | A test membership object |

### let(:organization)
#### Description
Retrieves the organization associated with the test membership.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| organization | Organization | The organization associated with the test membership |

### let(:billable_metric)
#### Description
Creates a test billable metric associated with the test organization.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| billable_metric | BillableMetric | A test billable metric object |

### let(:mutation)
#### Description
Defines the GraphQL mutation query for destroying a billable metric.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| mutation | String | The GraphQL mutation query for destroying a billable metric |

### it_behaves_like 'requires current user'
#### Description
Includes a shared example that tests if the mutation requires a current user.

### it_behaves_like 'requires permission', 'billable_metrics:delete'
#### Description
Includes a shared example that tests if the mutation requires the correct permission.

### it 'deletes a billable metric'
#### Description
Tests the successful deletion of a billable metric using the GraphQL mutation.

#### Internal Logic
1. Executes the GraphQL mutation with the necessary inputs
2. Verifies that the returned ID matches the ID of the deleted billable metric

## Dependencies
The test suite relies on the following dependencies:
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails testing environment and configurations |
| rspec | Testing framework |
| graphql | GraphQL implementation for Ruby |
| FactoryBot | Test data generation |

## References
This test file references and depends on:
1. The `Mutations::BillableMetrics::Destroy` GraphQL mutation (not shown in the provided code)
2. Shared examples for user authentication and permission checks (not shown in the provided code)
3. The `execute_graphql` helper method (likely defined in a support file, not shown in the provided code)

Note: The related `spec/rails_helper.rb` file provides additional context about the test environment setup, but doesn't directly impact the understanding of this specific test file.