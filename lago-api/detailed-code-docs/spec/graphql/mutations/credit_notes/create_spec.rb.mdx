---
title: "create_spec.rb"
---

## High-level description
This RSpec test file describes the behavior of the `Mutations::CreditNotes::Create` GraphQL mutation. It verifies that the mutation correctly creates a credit note with the provided input, including validation of permissions and handling of error cases.

## Code Structure
The test file defines a set of shared contexts and examples, followed by specific test cases for the credit note creation mutation. It uses FactoryBot to create test data and RSpec's `describe` and `it` blocks to structure the tests.

## Symbols

### RSpec.describe Mutations::CreditNotes::Create
#### Description
This is the main describe block for the `Mutations::CreditNotes::Create` GraphQL mutation tests.

#### Internal Logic
1. Sets up test data using FactoryBot (organization, membership, customer, invoice, fees).
2. Defines the GraphQL mutation query.
3. Uses shared examples to test common behaviors (user authentication, organization presence, and permission checks).
4. Defines specific test cases for credit note creation and error handling.

### let blocks
#### Description
These blocks define the test data and setup used across multiple test cases.

#### Inputs
N/A (These are not functions, but RSpec helpers for lazy-loading test data)

#### Outputs
Various test objects (organization, membership, customer, invoice, fees, etc.)

### it 'creates a credit note'
#### Description
This test case verifies that the mutation successfully creates a credit note with the provided input.

#### Internal Logic
1. Executes the GraphQL mutation with specific input data.
2. Verifies the returned data matches the expected output, including credit note details and item information.

### context 'when invoice is not found'
#### Description
This test case checks the error handling when an invalid invoice ID is provided.

#### Internal Logic
1. Executes the GraphQL mutation with an invalid invoice ID.
2. Verifies that a "not found" error is returned.

## Side Effects
The tests create and manipulate database records as part of the test setup and execution.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails testing environment and configuration |
| FactoryBot | Creates test data |
| RSpec | Testing framework |

## Error Handling
The test suite includes a specific test case for handling the scenario where an invoice is not found, expecting a "not found" error to be returned.

## TODOs
None present in the provided code.