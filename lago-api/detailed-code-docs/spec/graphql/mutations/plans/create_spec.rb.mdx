---
title: "create_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Mutations::Plans::Create` GraphQL mutation. It verifies the functionality of creating a new plan with various configurations, including charges, taxes, and usage thresholds.

## Code Structure
The test suite is organized around a single `RSpec.describe` block for the `Mutations::Plans::Create` mutation. It includes several let statements for setting up test data, a GraphQL mutation query, and a main test case that creates a plan with multiple charges and configurations.

## Symbols

### `RSpec.describe Mutations::Plans::Create, type: :graphql`
#### Description
This is the main describe block for the test suite, focusing on the `Mutations::Plans::Create` GraphQL mutation.

#### Internal Logic
- Sets up test data using `let` statements
- Defines a GraphQL mutation query
- Includes shared examples for permission and authentication checks
- Contains a main test case that creates a plan with various configurations

### `let` statements
#### Description
These statements define test data and variables used throughout the test suite.

#### Inputs
Various test data including membership, organization, taxes, billable metrics, and configuration options.

### `mutation`
#### Description
Defines the GraphQL mutation query used to create a plan.

#### Outputs
A GraphQL query string for creating a plan with all possible fields and nested objects.

### Main test case: 'creates a plan'
#### Description
This test case verifies that a plan can be created with all supported configurations.

#### Internal Logic
1. Executes the GraphQL mutation with a complex input
2. Verifies the response data for the created plan
3. Checks various aspects of the plan, including charges, taxes, and usage thresholds

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails testing environment and configurations |
| RSpec | Testing framework |
| FactoryBot | Used for creating test data |
| GraphQL | The API technology being tested |

## Error Handling
The test case uses `aggregate_failures` to group multiple expectations, allowing all assertions to be checked even if some fail.

## API/Interface Reference
| Endpoint | Method | Request | Response | Description |
|:---------|:-------|:--------|:---------|:------------|
| createPlan | Mutation | CreatePlanInput | Plan object | Creates a new plan with specified configurations |

Note: This is a GraphQL mutation, not a REST API endpoint.