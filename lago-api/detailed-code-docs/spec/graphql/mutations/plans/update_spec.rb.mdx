---
title: "update_spec.rb"
---

## High-level description
This RSpec test file describes the behavior of the `Mutations::Plans::Update` GraphQL mutation. It tests the functionality of updating a plan, including various charge models, minimum commitment, and usage thresholds. The test covers both premium and non-premium license scenarios.

## Code Structure
The test file is structured as an RSpec describe block for the `Mutations::Plans::Update` mutation. It includes several let blocks to set up test data, a GraphQL mutation query, and test cases for different scenarios.

## Symbols

### RSpec.describe Mutations::Plans::Update
#### Description
This is the main describe block for the `Mutations::Plans::Update` mutation test suite.

#### Internal Logic
1. Sets up test data using `let` blocks
2. Defines the GraphQL mutation query
3. Tests different scenarios for updating a plan

### let blocks
#### Description
These blocks define various test data and variables used throughout the test suite.

#### Inputs
- None (these are RSpec let blocks)

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| required_permission | String | The required permission for the mutation |
| membership | Membership | A test membership object |
| organization | Organization | The organization associated with the membership |
| plan | Plan | A test plan object |
| minimum_commitment_invoice_display_name | String | Display name for minimum commitment |
| minimum_commitment_amount_cents | Integer | Amount in cents for minimum commitment |
| commitment_tax | Tax | A test tax object |
| mutation | String | The GraphQL mutation query |
| billable_metrics | Array | A list of test billable metric objects |
| billable_metric_filter | BillableMetricFilter | A test billable metric filter |
| minimum_commitment | Commitment | A test minimum commitment object |
| graphql | Hash | The GraphQL input data for the mutation |

### context 'with premium license'
#### Description
This context block tests the behavior of the mutation when a premium license is active.

#### Internal Logic
1. Sets up a premium license environment
2. Tests updating a plan with various charge models, minimum commitment, and usage thresholds
3. Verifies the updated plan data in the response

### context 'without premium license'
#### Description
This context block tests the behavior of the mutation when a premium license is not active.

#### Internal Logic
1. Tests updating a plan with various charge models
2. Verifies that minimum commitment is not updated without a premium license

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails testing environment and configuration |
| RSpec | Testing framework |
| FactoryBot | Test data generation |
| GraphQL | API query language |

## Error Handling
The test suite uses RSpec's `aggregate_failures` to group multiple expectations together, allowing all failures to be reported at once.

## API/Interface Reference
| Endpoint | Method | Request | Response | Description |
|:---------|:-------|:--------|:---------|:------------|
| updatePlan | Mutation | UpdatePlanInput | Plan data | Updates a plan with the given input data |

The test file provides a comprehensive set of expectations to verify the correct behavior of the `updatePlan` mutation, including checking the updated plan attributes, charges, minimum commitment, and usage thresholds.