---
title: "Overview"
---

## High-level description
This file contains RSpec tests for the `Resolvers::CreditNotes::EstimateResolver` GraphQL resolver. It tests the functionality of estimating credit note creation based on an invoice and a list of credit note items.

## Code Structure
The test suite is organized around a single GraphQL query that estimates credit note creation. It sets up necessary test data, executes the query, and verifies the response.

## Symbols

### RSpec.describe Resolvers::CreditNotes::EstimateResolver
#### Description
This is the main test suite for the `EstimateResolver`. It contains various test cases to ensure the resolver functions correctly.

#### Internal Logic
1. Sets up test data including membership, organization, customer, invoice, fees, coupon, and credit.
2. Defines a GraphQL query for credit note estimation.
3. Executes the query with test data and verifies the response.
4. Includes test cases for both valid and invalid scenarios.

### let(:query)
#### Description
Defines the GraphQL query used for credit note estimation.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| query | String | GraphQL query for credit note estimation |

### let(:membership), let(:organization), let(:customer), let(:invoice), let(:fees), let(:coupon), let(:applied_coupon), let(:credit)
#### Description
These `let` blocks set up the test data required for the credit note estimation tests.

### around { |test| lago_premium!(&test) }
#### Description
Ensures that the tests are run in the context of a premium Lago account.

### it 'returns the estimate for the credit note creation'
#### Description
Tests the happy path scenario where a valid credit note estimate is returned.

#### Internal Logic
1. Executes the GraphQL query with valid input.
2. Verifies various fields in the response, including currency, amounts, and items.

### context 'with invalid invoice'
#### Description
Tests the scenario where an invalid invoice ID is provided.

#### Internal Logic
1. Executes the GraphQL query with an invalid invoice ID.
2. Expects a "not found" error in the response.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails testing environment and configurations |

## Error Handling
The test suite includes a scenario to verify error handling when an invalid invoice ID is provided.

## Notes
- The test suite uses shared examples for checking current user and organization requirements.
- The `lago_premium!` method is used to simulate a premium account environment for the tests.
- The test data setup is quite extensive, creating various related objects to simulate a realistic scenario for credit note estimation.