---
title: "billable_metric_resolver_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Resolvers::BillableMetricResolver` GraphQL resolver. It tests the functionality of querying a single billable metric, including its associated counts for subscriptions, active subscriptions, draft invoices, and plans.

## Code Structure
The test suite is organized around a single GraphQL query, testing various aspects of the billable metric resolver, including permission checks, data retrieval, and error handling.

## Symbols

### `RSpec.describe Resolvers::BillableMetricResolver, type: :graphql`
#### Description
This is the main describe block for the test suite, focusing on the `BillableMetricResolver`.

### `graphql_request`
#### Description
A subject that executes a GraphQL query to fetch a billable metric.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| current_user | User | The user making the request |
| current_organization | Organization | The organization context |
| permissions | String | Required permission for the request |
| query | String | GraphQL query |
| variables | Hash | Query variables |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| GraphQL response | Hash | The response from the GraphQL query |

### `query`
#### Description
Defines the GraphQL query used to fetch a billable metric.

### `it_behaves_like` shared examples
#### Description
These shared examples test common behaviors:
- 'requires current user'
- 'requires current organization'
- 'requires permission'

### Individual test cases
#### Description
Several `it` blocks that test specific aspects of the billable metric resolver:
1. Returning a single billable metric
2. Counting active subscriptions
3. Counting draft invoices
4. Handling errors when the billable metric is not found

#### Internal Logic
Each test case sets up the necessary data (e.g., creating subscriptions, charges, invoices) and then makes a GraphQL request. The response is then checked against expected values.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails and RSpec configuration |
| FactoryBot | Used for creating test data |

## Error Handling
The test suite includes a case for handling errors when a billable metric is not found, expecting a "Resource not found" error message.