---
title: "plans_resolver_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Resolvers::PlansResolver` GraphQL resolver. It verifies the resolver's behavior, including permission checks, query execution, and the structure of the returned data for plans in an organization.

## Code Structure
The test suite is organized as an RSpec describe block for `Resolvers::PlansResolver`. It sets up necessary test data, defines shared examples for common checks, and includes a main test case for verifying the plans query result.

## Symbols

### RSpec.describe Resolvers::PlansResolver
#### Description
This is the main describe block for the test suite, focusing on the `Resolvers::PlansResolver` GraphQL resolver.

#### Internal Logic
1. Sets up test data including a membership, plan, organization, and customer.
2. Creates subscriptions for the customer and plan.
3. Includes shared examples for common checks.
4. Defines a test case to verify the plans query result.

### let blocks
#### Description
These blocks define variables and objects used throughout the test suite.

#### Inputs
N/A (These are variable definitions)

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| required_permission | String | The permission required to view plans |
| query | String | The GraphQL query for fetching plans |
| membership | Membership | A test membership object |
| plan | Plan | A test plan object |
| organization | Organization | The organization associated with the membership |
| customer | Customer | A test customer object |

### before block
#### Description
Sets up the test environment by creating a plan, a customer, and two subscriptions.

#### Internal Logic
1. Creates a plan and a customer.
2. Creates two subscriptions associating the customer with the plan.

### it_behaves_like shared examples
#### Description
These lines include shared examples to test common behaviors.

#### Internal Logic
- Checks if the query requires a current user
- Checks if the query requires a current organization
- Checks if the query requires the 'plans:view' permission

### 'returns a list of plans' test
#### Description
This test verifies that the plans query returns the expected data structure and content.

#### Internal Logic
1. Executes the GraphQL query with the necessary context (current user, organization, and permissions).
2. Verifies the structure and content of the returned data, including:
   - The number of plans in the collection
   - The ID of the first plan
   - The customers count for the first plan
   - The current page and total count in the metadata

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Provides Rails-specific testing utilities |
| FactoryBot | Used implicitly for creating test objects (e.g., `create(:membership)`) |

## Error Handling
This test file doesn't explicitly handle errors, as it's focused on testing the happy path of the plans resolver.

## API/Interface Reference
| Endpoint | Method | Request | Response | Description |
|:---------|:-------|:--------|:---------|:------------|
| plans | Query | GraphQL query with optional limit | List of plans with their details and metadata | Fetches plans for the current organization |

The test verifies that the plans query returns the following structure:
```graphql
{
  plans(limit: 5) {
    collection { 
      id 
      chargesCount 
      customersCount 
    }
    metadata { 
      currentPage
      totalCount 
    }
  }
}
```