---
title: "invoiced_usages_resolver_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Resolvers::Analytics::InvoicedUsagesResolver` GraphQL resolver. It tests the behavior of the `invoicedUsages` query, including permission checks, premium feature requirements, and the expected response format.

## Code Structure
The test suite is organized into several contexts, testing different scenarios and requirements for the `invoicedUsages` query.

## Symbols

### RSpec.describe Resolvers::Analytics::InvoicedUsagesResolver
#### Description
This is the main test suite for the `InvoicedUsagesResolver`. It includes various test cases to ensure the resolver behaves correctly under different conditions.

#### Internal Logic
1. Sets up necessary test data (membership, organization)
2. Defines the GraphQL query to be tested
3. Includes shared examples for common checks
4. Tests behavior without and with premium features
5. Verifies error responses and successful query results

### let(:required_permission)
#### Description
Defines the required permission for accessing the `invoicedUsages` query.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| required_permission | String | The permission required to access the invoicedUsages query |

### let(:query)
#### Description
Defines the GraphQL query used in the tests.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| query | String | The GraphQL query for invoicedUsages |

### let(:membership)
#### Description
Creates a test membership object.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| membership | Membership | A test membership object |

### let(:organization)
#### Description
Retrieves the organization associated with the test membership.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| organization | Organization | The organization associated with the test membership |

### context 'without premium feature'
#### Description
Tests the behavior of the query when the premium feature is not enabled.

#### Internal Logic
1. Executes the GraphQL query
2. Expects a GraphQL error with the message 'unauthorized'

### context 'with premium feature'
#### Description
Tests the behavior of the query when the premium feature is enabled.

#### Internal Logic
1. Uses the `lago_premium!` method to enable premium features for the test
2. Executes the GraphQL query
3. Expects an empty collection in the response

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails testing environment and configuration |

## Error Handling
The test suite checks for proper error responses when required conditions are not met, such as missing permissions or premium features.

Your response should not exceed 3000 words or 4000 tokens. Focus on providing clear, concise information that can be directly inferred from the code. Include optional sections only when they provide significant value for understanding the code.