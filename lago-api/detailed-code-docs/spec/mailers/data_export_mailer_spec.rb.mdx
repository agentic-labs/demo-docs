---
title: "data_export_mailer_spec.rb"
---

## High-level description
This file contains RSpec tests for the `DataExportMailer` class. It specifically tests the `completed` method of the mailer, verifying the email content, recipients, and behavior under different scenarios such as completed exports, expired exports, and exports without attached files.

## Symbols

### `RSpec.describe DataExportMailer, type: :mailer`
#### Description
This is the main describe block for testing the `DataExportMailer` class. It sets up the context for all the tests related to this mailer.

### `describe '#completed'`
#### Description
This describe block focuses on testing the `completed` method of the `DataExportMailer` class. It contains various test cases to verify the behavior of the mailer under different conditions.

### `let(:data_export_mailer)`
#### Description
This let block creates a subject for the tests, which is the `DataExportMailer` class itself.

### `let(:data_export)`
#### Description
This let block creates a factory instance of a completed data export, which is used as the primary test data.

### `let(:mailer)`
#### Description
This let block creates an instance of the mailer with the data export, specifically calling the `completed` method.

### `let(:file_url)`
#### Description
This let block defines a sample file URL used in the tests.

### `before` block
#### Description
This block sets up a stub for the `file_url` method on the `data_export` object, returning the predefined `file_url`.

### `specify` block (main test)
#### Description
This test verifies the basic functionality of the completed mailer, checking the recipient email, subject, and body content.

#### Internal Logic
1. Checks if the recipient email matches the data export user's email.
2. Verifies the email subject.
3. Checks if the email body contains expected phrases and the file URL.

### `context "when the resource type is invoice_fees"`
#### Description
This context block tests the mailer behavior when the data export resource type is 'invoice_fees'.

#### Internal Logic
Verifies that the email subject and body content are specific to invoice fees.

### `context 'when data export is expired'`
#### Description
This context block tests the mailer behavior when the data export is expired.

#### Internal Logic
Checks if the mailer's 'to' field is nil for an expired data export.

### `context 'when data export is not completed'`
#### Description
This context block tests the mailer behavior when the data export is still processing.

#### Internal Logic
Verifies that the mailer's 'to' field is nil for a processing data export.

### `context 'when data export has no attached file'`
#### Description
This context block tests the mailer behavior when the completed data export has no attached file.

#### Internal Logic
Checks if the mailer's 'to' field is nil when there's no attached file.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads the Rails testing environment and RSpec configurations |
| FactoryBot | Implied usage for creating test data (`:data_export` factory) |

Note: The use of FactoryBot is implied by the `create` method calls in the test file.