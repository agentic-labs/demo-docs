---
title: "events_max_aggs.rb"
---

## High-level description
This code defines a factory for creating test instances of the `Clickhouse::EventsMaxAgg` model using FactoryBot. It sets up default attributes and associations for the model, which represents aggregated event data in a Clickhouse database.

## Symbols

### `:clickhouse_events_max_agg` factory
#### Description
This factory defines how to create a `Clickhouse::EventsMaxAgg` instance for testing purposes. It sets up transient attributes to create associated objects and defines default values for the model's attributes.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| subscription | Subscription | Transient attribute to create an associated subscription |
| customer | Customer | Transient attribute to create an associated customer |
| organization | Organization | Derived from the customer's organization |
| billable_metric | BillableMetric | Transient attribute to create an associated billable metric |
| plan | Plan | Transient attribute to create an associated plan |
| charge | Charge | Transient attribute to create an associated charge |

#### Outputs
An instance of `Clickhouse::EventsMaxAgg` with the following attributes:

| Name | Type | Description |
|:-----|:-----|:------------|
| organization_id | String | ID of the associated organization |
| external_subscription_id | String | External ID of the associated subscription |
| code | String | Code of the associated billable metric |
| timestamp | Time | Current time at the beginning of the hour |
| value | Float | Default value of 4.0 |
| charge_id | String | ID of the associated charge |
| filters | Hash | Empty hash for filters |
| grouped_by | Hash | Empty hash for grouping |

#### Internal Logic
1. Creates transient associations (subscription, customer, organization, billable_metric, plan, and charge) using FactoryBot's `create` method.
2. Sets the `organization_id` to the ID of the associated organization.
3. Sets the `external_subscription_id` to the external ID of the associated subscription.
4. Sets the `code` to the code of the associated billable metric.
5. Sets the `timestamp` to the current time at the beginning of the hour.
6. Sets a default `value` of 4.0.
7. Sets the `charge_id` to the ID of the associated charge.
8. Initializes empty hashes for `filters` and `grouped_by`.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| FactoryBot | Used to define and create test data factories |

## References
- `Clickhouse::EventsMaxAgg`: The model class for which this factory is defined (from `app/models/clickhouse/events_max_agg.rb`).
- `Subscription`: Referenced to create an associated subscription.
- `Customer`: Referenced to create an associated customer.
- `Organization`: Indirectly referenced through the customer's organization.
- `BillableMetric`: Referenced to create an associated billable metric.
- `Plan`: Referenced to create an associated plan.
- `Charge`: Referenced to create an associated charge.

This factory is likely used in test suites to create sample `Clickhouse::EventsMaxAgg` instances with realistic associations, making it easier to set up test scenarios involving aggregated event data from Clickhouse.