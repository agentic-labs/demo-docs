---
title: "plan_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Plan` model in a Ruby on Rails application. It tests various aspects of the `Plan` model, including associations, validations, and custom methods, ensuring that the model behaves as expected in different scenarios.

## Code Structure
The test file is organized into several describe blocks, each focusing on a specific aspect of the `Plan` model. It uses RSpec's `describe` and `context` blocks to group related tests, and `it` blocks for individual test cases.

## Symbols

### `RSpec.describe Plan, type: :model`
#### Description
This is the main describe block for the `Plan` model tests. It sets up the subject for the tests and includes various test cases.

#### Internal Logic
- Sets up a subject `plan` using FactoryBot
- Tests associations, validations, and enum definitions
- Includes shared examples for paper_trail traceability

### `describe 'Validations'`
#### Description
Tests the validation requirements for the `Plan` model.

#### Internal Logic
- Checks if the `pay_in_advance` attribute is required

### `describe '.has_trial?'`
#### Description
Tests the `has_trial?` method of the `Plan` model.

#### Internal Logic
- Checks if the method returns true when `trial_period` is set
- Checks if the method returns false when `trial_period` is 0

### `describe '.yearly_amount_cents'`
#### Description
Tests the `yearly_amount_cents` method of the `Plan` model.

#### Internal Logic
- Checks the calculated yearly amount for different plan intervals (yearly, monthly, weekly, quarterly)

### `describe '#invoice_name'`
#### Description
Tests the `invoice_name` method of the `Plan` model.

#### Internal Logic
- Checks if the method returns the correct name based on the presence or absence of `invoice_display_name`

### `describe '#active_subscriptions_count'`
#### Description
Tests the `active_subscriptions_count` method of the `Plan` model.

#### Internal Logic
- Creates subscriptions and checks if the count is correct, including subscriptions for overridden plans

### `describe '#customers_count'`
#### Description
Tests the `customers_count` method of the `Plan` model.

#### Internal Logic
- Creates customers and subscriptions, and checks if the count of impacted customers is correct

### `describe '#draft_invoices_count'`
#### Description
Tests the `draft_invoices_count` method of the `Plan` model.

#### Internal Logic
- Creates draft invoices for subscriptions and checks if the count is correct, including invoices for overridden plans

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails environment and RSpec configuration |
| FactoryBot | Used for creating test data |

## Error Handling
This test file doesn't implement specific error handling beyond the standard RSpec expectations and matchers.

## API/Interface Reference
| Method | Description |
|:-------|:------------|
| has_trial? | Checks if the plan has a trial period |
| yearly_amount_cents | Calculates the yearly amount in cents based on the plan's interval |
| invoice_name | Returns the invoice name for the plan |
| active_subscriptions_count | Returns the count of active subscriptions for the plan |
| customers_count | Returns the count of customers impacted by the plan |
| draft_invoices_count | Returns the count of draft invoices associated with the plan |

This test file provides comprehensive coverage for the `Plan` model, ensuring that its associations, validations, and custom methods work as expected in various scenarios.