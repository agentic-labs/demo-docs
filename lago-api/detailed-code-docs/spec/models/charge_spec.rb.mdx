---
title: "charge_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Charge` model. It tests various validation methods for different charge types (graduated, standard, package, percentage, volume, and graduated percentage) and other charge-related validations.

## Code Structure
The tests are organized into several `describe` blocks, each focusing on a specific validation method or aspect of the `Charge` model. The tests use RSpec's `let` statements to set up test data and mock objects, and employ RSpec's expectation syntax to assert the behavior of the `Charge` model under different conditions.

## Symbols

### `RSpec.describe Charge, type: :model`
#### Description
This is the main describe block for the `Charge` model tests.

### `describe '#validate_graduated'`
#### Description
Tests the validation of graduated charges.

#### Internal Logic
- Creates a graduated charge with specific properties
- Mocks the `Charges::Validators::GraduatedService`
- Checks if the charge is invalid when the validation service returns errors
- Verifies that the validation is not applied to non-graduated charges

### `describe '#validate_amount'`
#### Description
Tests the validation of standard charges.

#### Internal Logic
- Similar to `#validate_graduated`, but for standard charges
- Uses `Charges::Validators::StandardService` for validation

### `describe '#validate_package'`
#### Description
Tests the validation of package charges.

#### Internal Logic
- Similar to previous validation tests, but for package charges
- Uses `Charges::Validators::PackageService` for validation

### `describe '#validate_percentage'`
#### Description
Tests the validation of percentage charges.

#### Internal Logic
- Similar to previous validation tests, but for percentage charges
- Uses `Charges::Validators::PercentageService` for validation

### `describe '#validate_volume'`
#### Description
Tests the validation of volume charges.

#### Internal Logic
- Similar to previous validation tests, but for volume charges
- Uses `Charges::Validators::VolumeService` for validation

### `describe '#validate_graduated_percentage'`
#### Description
Tests the validation of graduated percentage charges.

#### Internal Logic
- Similar to previous validation tests, but for graduated percentage charges
- Uses `Charges::Validators::GraduatedPercentageService` for validation

### `describe '#validate_pay_in_advance'`
#### Description
Tests the validation of pay-in-advance charges.

#### Internal Logic
- Checks for invalid combinations of billable metric types and charge models with pay-in-advance

### `describe '#validate_regroup_paid_fees'`
#### Description
Tests the validation of the `regroup_paid_fees` attribute.

#### Internal Logic
- Checks various combinations of `pay_in_advance`, `invoiceable`, and `regroup_paid_fees` values

### `describe '#validate_min_amount_cents'`
#### Description
Tests the validation of the `min_amount_cents` attribute.

#### Internal Logic
- Checks that `min_amount_cents` is not compatible with pay-in-advance charges

### `describe '#validate_prorated'`
#### Description
Tests the validation of the `prorated` attribute.

#### Internal Logic
- Checks various combinations of charge types, payment terms, and billable metric types with the `prorated` attribute

### `describe '#validate_custom_model'`
#### Description
Tests the validation of custom charge models.

#### Internal Logic
- Checks that custom charge models are not valid for certain billable metric types

## Dependencies
The test file depends on various factory definitions (e.g., `:standard_charge`, `:graduated_charge`) and validation services (e.g., `Charges::Validators::GraduatedService`, `Charges::Validators::StandardService`).

## Error Handling
The tests check for various validation errors by examining the `errors` hash on the `Charge` model after validation.