---
title: "billable_metric_spec.rb"
---

## High-level description
This file contains RSpec tests for the `BillableMetric` model. It verifies the model's associations, validations, and specific behaviors related to aggregation types, recurring metrics, and payable-in-advance functionality.

## Code Structure
The test suite is organized into several describe blocks, each focusing on a specific aspect of the `BillableMetric` model. It uses RSpec's shared examples, expectations, and context blocks to structure the tests.

## Symbols

### `RSpec.describe BillableMetric`
#### Description
This is the main describe block for the `BillableMetric` model tests.

#### Internal Logic
- Uses `create(:billable_metric)` to create a test instance
- Includes shared examples for 'paper_trail traceable'
- Tests associations and validations
- Contains nested describe blocks for specific methods and behaviors

### `describe '#aggregation_type='`
#### Description
Tests the behavior of the `aggregation_type=` method.

#### Internal Logic
- Tests assigning a valid aggregation type
- Tests assigning an invalid aggregation type
- Verifies error messages for invalid assignments

### `describe '#validate_recurring'`
#### Description
Tests the validation of the `recurring` attribute in relation to aggregation types.

#### Internal Logic
- Tests various combinations of `recurring` and aggregation types
- Verifies error messages for incompatible combinations

### `describe '#payable_in_advance?'`
#### Description
Tests the `payable_in_advance?` method for different aggregation types.

#### Internal Logic
- Iterates through aggregation types defined in `AGGREGATION_TYPES_PAYABLE_IN_ADVANCE`
- Verifies the method returns the expected boolean value for each aggregation type

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails testing environment and configuration |
| FactoryBot | Used for creating test instances of `BillableMetric` |

## Configuration
The test suite uses RSpec configuration from the `rails_helper.rb` file, which sets up the testing environment, including database cleaner, SimpleCov for code coverage, and various RSpec configurations.

## Error Handling
The tests verify error handling in the `BillableMetric` model, particularly for invalid aggregation types and incompatible recurring settings.