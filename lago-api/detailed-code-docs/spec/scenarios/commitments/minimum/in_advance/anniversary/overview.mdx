---
title: "Overview"
---

## High-level description
This directory contains RSpec test files for a billing scenario involving minimum commitments in advance for a subscription-based service. The tests cover different billing frequencies (weekly, monthly, quarterly, and yearly) and focus on how minimum commitment fees are applied across various billing periods, both with and without coupons.

## What does it do?
These tests simulate a complex subscription billing system that includes:
1. Setting up organizations, customers, and subscription plans
2. Defining different types of billable metrics (metered and recurring)
3. Creating minimum commitments for plans
4. Generating events and invoices over multiple billing periods
5. Applying coupons to subscriptions
6. Calculating and verifying minimum commitment fees

The tests ensure that the billing system correctly handles minimum commitments in various scenarios, such as:
- Different billing frequencies (weekly, monthly, quarterly, yearly)
- Billing periods with and without reaching the minimum commitment
- The impact of coupons on minimum commitment calculations
- Anniversary billing (where the billing date is based on the subscription start date)
- Monthly billing for charges in yearly plans

## Key Files
1. `weekly_spec.rb`: Tests weekly billing scenarios
2. `monthly_spec.rb`: Tests monthly billing scenarios
3. `quarterly_spec.rb`: Tests quarterly billing scenarios
4. `yearly_spec.rb`: Tests yearly billing scenarios with monthly charge billing

Each file follows a similar structure:
- Setting up the test environment with necessary objects
- Creating a subscription and initial events
- Testing billing behavior across multiple periods
- Verifying the correct application of minimum commitment fees
- Testing scenarios with and without applied coupons

## Dependencies
The test files rely on the following key dependencies:
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails testing environment and configuration |
| FactoryBot | Used for creating test objects |
| RSpec | Testing framework |
| ActiveSupport::Testing::TimeHelpers | Used for time manipulation in tests |

## Configuration
The tests use various configuration settings to simulate different billing scenarios:
- Billing frequencies (weekly, monthly, quarterly, yearly)
- Minimum commitment amounts
- Coupon amounts and types
- Billable metric types (metered, recurring)
- Charge models (standard, package)

Example configuration for a minimum commitment:
```ruby
create(
  :commitment,
  plan:,
  commitment_type: 'minimum',
  amount_cents: 10_000,
  invoice_display_name: 'Minimum commitment fee'
)
```

Example configuration for a charge:
```ruby
create(
  :standard_charge,
  plan:,
  billable_metric: billable_metric_metered,
  properties: { amount: '0.01' }
)
```

These tests are crucial for ensuring the correct behavior of the billing system, especially when dealing with complex scenarios involving minimum commitments and various billing frequencies. They help validate that the system accurately calculates fees, applies coupons, and handles different time periods correctly.