---
title: "yearly_spec.rb"
---

## High-level description
This code is a RSpec test file that describes a scenario for billing minimum commitments in advance. It tests the behavior of a subscription billing system, focusing on yearly plans with anniversary billing and minimum commitments, particularly how these are handled when charges are billed monthly.

## Code Structure
The test file sets up a complex scenario with an organization, customer, plan, and various billable metrics. It then creates a subscription and simulates events over time to test the billing behavior, especially the application of minimum commitment fees.

## Symbols

### Main describe block
#### Description
This is the main test suite for the "Billing Minimum Commitments In Advance Scenario". It sets up the test environment and defines shared variables used across multiple tests.

#### Internal Logic
1. Sets up an organization, customer, and plan
2. Defines billable metrics (metered and recurring)
3. Creates a minimum commitment for the plan
4. Sets up charges for the billable metrics
5. Creates a subscription and initial events

### Context: "when billed monthly"
#### Description
This context focuses on testing the billing behavior when charges are billed monthly for a yearly plan.

#### Internal Logic
1. Sets `bill_charges_monthly` to true

### Context: "when subscription is billed for the first period"
#### Description
Tests the behavior of the first billing period after subscription creation.

#### Internal Logic
1. Checks that no minimum commitment fee is applied in the first invoice

### Context: "when subscription is billed for the last period"
#### Description
Tests the behavior of the last billing period of the subscription year.

#### Internal Logic
1. Simulates 12 months of billing cycles
2. Creates additional events in specific months
3. Checks that a minimum commitment fee is applied in the final invoice

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails testing environment and configuration |
| FactoryBot | Used for creating test data |
| RSpec | Testing framework |

## Error Handling
The test relies on RSpec's built-in error handling and assertion mechanisms.

## Performance Considerations
The test uses time travel (`travel_to`) to simulate the passage of time without actually waiting, which is crucial for efficient testing of time-dependent behavior.

## TODOs
There are no explicit TODOs in the code.

This test file is part of a larger test suite for a subscription billing system. It specifically tests the behavior of minimum commitments for yearly plans with monthly billing. The test ensures that no minimum commitment fee is applied in the first billing period, but is correctly applied at the end of the year if the total billed amount is less than the commitment.