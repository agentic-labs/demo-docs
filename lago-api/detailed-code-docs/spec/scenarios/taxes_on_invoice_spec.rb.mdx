---
title: "taxes_on_invoice_spec.rb"
---

## High-level description
This file contains RSpec tests for scenarios related to taxes on invoices in a billing system. It tests various scenarios including different tax rates, coupons, and multiple subscriptions to ensure correct calculation of fees, taxes, and total amounts on invoices.

## Code Structure
The test file is organized into three main contexts, each testing different scenarios of tax and coupon applications on invoices. The tests use a combination of helper methods to set up the test environment, create necessary data, and perform billing operations.

## Symbols

### `describe 'Taxes on Invoice Scenarios'`
#### Description
This is the main describe block that groups all the tests related to taxes on invoices.

#### Internal Logic
- Sets up common variables and mocks for all tests
- Uses `around` hook to enable premium features for all tests

### Context: 'when timezone is negative and not the same day as UTC'
#### Description
Tests the creation of an invoice with various taxes, charges, and a coupon applied.

#### Internal Logic
1. Sets up taxes, customer, metrics, plan, subscription, and coupon
2. Creates events for the subscription
3. Performs billing
4. Checks the resulting invoice for correct fee calculations, tax applications, and coupon discounts

### Context: 'when coupons amount is greater than fees total amount'
#### Description
Tests the scenario where the total coupon amount exceeds the total fee amount.

#### Internal Logic
1. Sets up a tax, customer, plan, subscription, and two coupons
2. Performs billing
3. Checks the resulting invoice to ensure correct application of coupons and taxes

### Context: 'when there are multiple subscriptions and coupons are covering total amount'
#### Description
Tests the scenario with multiple subscriptions and coupons that cover the total amount.

#### Internal Logic
1. Sets up a tax, customer, two plans, two subscriptions, and two coupons
2. Performs billing
3. Checks the resulting invoice to ensure correct distribution of coupon discounts across subscriptions

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails environment and RSpec configuration |
| Utils::PdfGenerator | Mocked for PDF generation in tests |

## Configuration
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| lago_premium! | Method | N/A | Enables premium features for tests |

## Side Effects
The tests create various database records (taxes, customers, plans, subscriptions, coupons, events) and perform billing operations, which may affect the test database state.

## Performance Considerations
The tests use time travel (`travel_to`) to simulate different time periods, which may impact test execution time.