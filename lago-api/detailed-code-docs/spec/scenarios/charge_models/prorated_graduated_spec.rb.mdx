---
title: "prorated_graduated_spec.rb"
---

## High-level description
This file contains a comprehensive set of RSpec tests for prorated graduated charge models in a billing system. It tests various scenarios involving subscriptions, events, and usage calculations for different aggregation types (sum_agg and unique_count_agg) with graduated pricing tiers.

## Code Structure
The test suite is organized into two main describe blocks, one for 'sum_agg' and another for 'unique_count_agg' aggregation types. Within each block, there are multiple test cases covering different scenarios such as multiple ranges, upgrades, and handling of old events.

## Symbols

### `describe 'Charge Models - Prorated Graduated Scenarios'`
#### Description
This is the main describe block that sets up the context for all the tests in this file. It creates necessary objects like organization, customer, tax, plan, and billable metric.

### `describe 'with sum_agg'`
#### Description
This describe block contains tests specific to the sum aggregation type.

### `describe 'with unique_count_agg'`
#### Description
This describe block contains tests specific to the unique count aggregation type.

### `it 'returns the expected invoice and usage amounts'`
#### Description
This is the main test case that runs through a series of events and checks the calculated usage and invoice amounts at various points in time.

#### Internal Logic
1. Set up the subscription and charge model
2. Create events at different time points
3. Check the current usage after each event
4. Perform billing at the end of the period
5. Verify the invoice amounts and usage calculations

### `context 'when there are old events before first invoice'`
#### Description
This context tests the scenario where there are events created before the first invoice is generated.

### `context 'when there are old events before first invoice and subscription is terminated'`
#### Description
This context tests the scenario where there are old events and the subscription is terminated before the first invoice.

### `context 'when upgrade is performed'`
#### Description
This context tests the scenario where a plan upgrade is performed mid-cycle.

### `context 'with multiple events on the same day'`
#### Description
This context tests the scenario where multiple events occur on the same day.

## Dependencies
The test file relies on various helper methods and factories, which are likely defined in support files or FactoryBot definitions.

## Configuration
The tests use time travel to simulate different dates and times for event creation and billing cycles.

## Error Handling
The tests use RSpec's expectation syntax to check for correct calculations and behavior. Any mismatches will result in test failures.

## Performance Considerations
These tests involve complex calculations and multiple database operations. They may be slower compared to simpler unit tests.

This test suite provides comprehensive coverage for prorated graduated charge models, ensuring that the billing system correctly handles various scenarios and edge cases.