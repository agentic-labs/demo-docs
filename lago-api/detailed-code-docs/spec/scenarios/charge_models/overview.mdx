---
title: "Overview"
---

## High-level description
This directory contains RSpec test scenarios for various charge models in a billing system. The tests cover different aspects of charge model functionality, including editing charge models with filters, percentage-based charges, and prorated graduated charge models. These tests ensure the accuracy and reliability of the billing system's core charging mechanisms.

## What does it do?
The test scenarios in this directory simulate real-world usage of the billing system and verify that it correctly calculates charges under various conditions. Here's a breakdown of the main functionalities tested:

1. Editing charge models with filters: This tests the system's ability to update a plan's charge model from standard to graduated, including modifying charge filters and their properties.

2. Percentage-based charges: These tests verify the correct calculation of customer usage and charges for percentage-based charge models. They cover scenarios with free units, fixed amounts, and per-transaction limits.

3. Prorated graduated charge models: These tests ensure accurate calculations for prorated graduated pricing tiers across different aggregation types (sum and unique count). They cover scenarios such as multiple ranges, plan upgrades, and handling of old events.

The tests create simulated environments with organizations, customers, plans, and billable metrics. They then generate events and check if the system calculates the correct usage and charges based on the defined charge models.

## Key Files

1. `edit_with_filter_spec.rb`: 
   - Tests the functionality of editing a charge model with filters.
   - Verifies the ability to update a plan's charge model from standard to graduated.
   - Checks the correct modification of charge filters and their properties.

2. `percentage_spec.rb`:
   - Contains tests for percentage-based charge models.
   - Covers scenarios with free units per event, fixed amounts, and per-transaction limits.
   - Verifies correct calculation of customer usage and charges for various percentage-based configurations.

3. `prorated_graduated_spec.rb`:
   - Provides comprehensive tests for prorated graduated charge models.
   - Tests different aggregation types (sum and unique count) with graduated pricing tiers.
   - Covers scenarios such as multiple ranges, plan upgrades, and handling of old events.

## Dependencies
The test files rely on the following dependencies:

1. RSpec: The testing framework used for writing and running the tests.
2. FactoryBot: Used for creating test data and objects.
3. Rails testing environment: Loaded via `rails_helper` to provide the necessary Rails configuration for testing.

## Configuration
The tests use various configuration techniques to set up the testing environment:

1. Time manipulation: The `travel_to` method is used to simulate different dates and times for event creation and billing cycles.
2. FactoryBot factories: Used to create test objects such as organizations, customers, plans, and billable metrics.
3. RSpec let blocks: Employed for lazy-loading of test data and improving test performance.

The tests are designed to be comprehensive and cover a wide range of scenarios, ensuring the robustness and accuracy of the billing system's charge model implementations. They simulate real-world usage patterns and verify that the system behaves correctly under various conditions, including edge cases and complex pricing structures.