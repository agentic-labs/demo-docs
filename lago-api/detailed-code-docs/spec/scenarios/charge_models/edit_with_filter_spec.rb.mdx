---
title: "edit_with_filter_spec.rb"
---

## High-level description
This code is a RSpec test scenario that verifies the functionality of editing a charge model with filters in a billing system. It tests the ability to update a plan's charge model from standard to graduated, including the modification of charge filters and their properties.

## Code Structure
The test scenario is structured as a single RSpec describe block containing one test case (it block). It uses FactoryBot to create test data and makes assertions about the state of the plan and its charges after an update operation.

## Symbols

### `describe 'Change charge model with filters'`
#### Description
This is the main describe block that encapsulates the entire test scenario for changing a charge model with filters.

#### Internal Logic
1. Sets up the test environment by creating necessary objects (organization, customer, plan, billable metric, charge, filters).
2. Executes the update_plan method to modify the charge model and its filters.
3. Reloads the plan and makes assertions about the updated state of the plan and its charges.

### `let` blocks
#### Description
These blocks define the test data used throughout the scenario.

#### Inputs
N/A (These are lazy-loaded variables)

#### Outputs
Various test objects (organization, customer, plan, billable_metric, charge, filters)

### `it 'allows the edition of the charge filter'`
#### Description
This is the main test case that verifies the ability to edit a charge filter.

#### Internal Logic
1. Calls the `update_plan` method with new charge model details.
2. Reloads the plan to get the latest data.
3. Makes assertions about the updated state of the plan and its charges:
   - Checks if the charge model has been changed to 'graduated'.
   - Verifies the number of filters.
   - Checks the properties of the graduated ranges in the filter.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads the Rails testing environment and configuration |
| FactoryBot | Used for creating test data |

## References
- The `update_plan` method is referenced but not defined in this file. It's likely defined in a helper module (possibly `ScenariosHelper`).
- FactoryBot methods (`create`) are used to generate test data.

## Notes
- The test is marked with `:scenarios` and `type: :request` tags, indicating it's a scenario-based request spec.
- The code uses lazy-loaded let blocks for better performance and readability.
- The test focuses on verifying the charge model change from standard to graduated and the correct application of filters.