---
title: "coupons_breakdown_spec.rb"
---

## High-level description
This code is a RSpec test file that describes a scenario for coupons breakdown in an invoicing system. It tests the creation of an invoice with multiple subscriptions and coupons of different types, verifying the correct calculation of fees, taxes, and coupon applications.

## Code Structure
The test file defines a single context with one test case. It sets up an organization, creates multiple billable metrics, plans, subscriptions, coupons, and events. Then it performs billing and checks the resulting invoice for correct fee calculations, tax applications, and coupon deductions.

## Symbols

### `describe 'Coupons breakdown Spec'`
#### Description
This is the main describe block for the coupons breakdown scenario test.

#### Internal Logic
1. Sets up the test environment with an organization and mocks PDF generation.
2. Creates multiple billable metrics, plans, subscriptions, and coupons.
3. Generates events for the subscriptions.
4. Performs billing and verifies the resulting invoice details.

### `let(:organization)`
#### Description
Creates an organization for the test scenario.

### `let(:pdf_generator)` and `let(:pdf_file)`
#### Description
Sets up mocks for PDF generation, which is not the focus of this test but needs to be present.

### `before` block
#### Description
Sets up the organization and mocks PDF generation.

### `around { |test| lago_premium!(&test) }`
#### Description
Ensures the test runs in the context of a premium Lago account.

### `it 'creates an invoice for the expected period'`
#### Description
The main test case that sets up the scenario and verifies the invoice details.

#### Internal Logic
1. Creates billable metrics, taxes, customer, plans, and subscriptions.
2. Creates and applies multiple coupons.
3. Generates events for both subscriptions.
4. Performs billing and retrieves the generated invoice.
5. Verifies fee calculations, tax applications, and coupon deductions for each charge.
6. Checks the overall invoice totals.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Provides Rails-specific test configurations and helpers |
| Utils::PdfGenerator | Mocked for PDF generation (not directly tested) |

## Configuration
The test uses various helper methods (e.g., `create_metric`, `create_tax`, `create_plan`) that are likely defined in a support file or module.

## Performance Considerations
This test creates a complex scenario with multiple database objects and calculations. It may be relatively slow compared to simpler unit tests.

## TODOs
There are no explicit TODOs in the code.