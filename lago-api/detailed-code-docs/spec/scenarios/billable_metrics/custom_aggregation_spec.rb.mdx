---
title: "custom_aggregation_spec.rb"
---

## High-level description
This file contains RSpec tests for custom aggregation scenarios in a billing system. It tests various charge models, filters, and event processing for different currencies and payment schemes. The tests cover both in-arrears and in-advance aggregations, ensuring correct fee calculations and usage reporting.

## Code Structure
The test file defines multiple contexts and scenarios, each testing different aspects of the custom aggregation system. It uses factory methods to create test data and helper methods to simulate events and fetch usage information.

## Symbols

### RSpec.describe 'Aggregation - Custom Aggregation Scenarios'
#### Description
This is the main test suite for custom aggregation scenarios. It sets up the test environment and defines various test cases.

#### Internal Logic
- Sets up test data including organization, customer, plan, and billable metric
- Defines custom aggregator logic
- Creates charge filters for different currencies and payment schemes
- Tests both in-arrears and in-advance aggregations
- Simulates events and verifies fee calculations and usage reporting

### let(:custom_aggregator)
#### Description
Defines the custom aggregation logic used in the tests.

#### Internal Logic
- Calculates aggregated units and amounts based on event properties and aggregation rules
- Handles different pricing models including fixed amounts, rates, and ranges
- Applies currency conversion using fx_rate

### context 'with first aggregation scenario'
#### Description
Tests the first aggregation scenario with standard and custom charges.

#### Internal Logic
- Creates standard and custom charges with specific properties
- Tests in-arrears and in-advance aggregations
- Simulates events and verifies fee calculations and usage reporting

### context 'with second aggregation scenario'
#### Description
Tests the second aggregation scenario with more complex charge filters and currency-specific rules.

#### Internal Logic
- Creates charge filters for different currencies (EUR, CHF, GBP) and payment schemes (SEPA, SWIFT, FPS, BACS)
- Simulates events for various payment types and verifies fee calculations
- Tests usage reporting with multiple filters applied

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails testing environment and configurations |
| rspec | Testing framework |

## Configuration
The test file uses various RSpec configurations and helper methods defined in the `rails_helper.rb` file.

## Error Handling
The tests use RSpec expectations to verify correct behavior and will fail if the expected results don't match the actual outcomes.

## TODOs
There are no explicit TODOs in the code.

This test file is crucial for ensuring the correct functioning of the custom aggregation system, covering various scenarios and edge cases in billing and usage calculation.