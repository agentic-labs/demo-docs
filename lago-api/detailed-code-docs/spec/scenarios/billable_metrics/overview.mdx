---
title: "Overview"
---

## High-level description
This directory contains RSpec test scenarios for various billable metric aggregation methods in a billing system. The tests cover custom aggregation, sum aggregation, unique count aggregation, and weighted sum aggregation. These scenarios are designed to ensure the correct functioning of the billing system's core features, including fee calculation, usage tracking, and invoice generation across different subscription models and time periods.

## What does it do?
The test scenarios in this directory simulate real-world usage of a billing system, focusing on different aggregation methods for billable metrics. Here's a breakdown of what each file tests:

1. Custom Aggregation: Tests complex scenarios with custom aggregation logic, including different currencies, payment schemes, and both in-arrears and in-advance billing.

2. Sum Aggregation: Verifies the behavior of sum aggregation for in-advance charges with grouped properties and multiple subscriptions attached to the same plan.

3. Unique Count Aggregation: Examines various aspects of unique count aggregation, including basic fee creation, unit persistence, in-advance charges with group-by functionality, and both prorated and non-prorated in-advance charges.

4. Weighted Sum Aggregation: Simulates a subscription lifecycle with events and billing cycles, verifying the correct calculation of fees, usage, and invoices for a weighted sum billable metric.

These tests ensure that the billing system accurately calculates fees, tracks usage, and generates invoices across different scenarios and edge cases. They simulate events, time travel through billing periods, and verify the system's behavior under various conditions.

## Key Files
1. `custom_aggregation_spec.rb`: Tests custom aggregation scenarios with complex charge models, filters, and event processing for different currencies and payment schemes.

2. `sum_spec.rb`: Focuses on sum aggregation scenarios, particularly for in-advance charges with grouped properties and multiple subscriptions.

3. `unique_count_spec.rb`: Covers unique count aggregation scenarios, testing various aspects of billable metrics, charges, and usage calculations for different subscription and event scenarios.

4. `weighted_sum_spec.rb`: Tests the weighted sum aggregation feature, simulating a subscription lifecycle with events and billing cycles.

Each file contains detailed test cases that cover different aspects of the respective aggregation method, ensuring comprehensive coverage of the billing system's functionality.

## Dependencies
The test files rely on the following key dependencies:

| Dependency | Purpose |
|:-----------|:--------|
| RSpec | Testing framework used for writing and running the tests |
| FactoryBot | Used for creating test data (organizations, customers, plans, etc.) |
| rails_helper | Loads Rails testing environment and configurations |

These dependencies are crucial for setting up the test environment, creating test data, and running the tests effectively.

## Configuration
The test files use the following common configuration options:

| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| :scenarios | Symbol | N/A | Tags the tests as scenarios |
| type: :request | Symbol | N/A | Specifies that these are request specs |
| transaction: false | Boolean | false | Disables transactional tests |

These configuration options ensure that the tests are properly categorized and run in the appropriate environment.

The tests also make use of time manipulation techniques, such as `travel_to`, to simulate the passage of time without waiting for actual time to pass. This improves test performance and reliability when dealing with time-sensitive operations.

In summary, this directory contains a comprehensive suite of tests that ensure the correct functioning of various aggregation methods in the billing system. These tests cover a wide range of scenarios and edge cases, providing confidence in the system's ability to handle complex billing situations accurately.