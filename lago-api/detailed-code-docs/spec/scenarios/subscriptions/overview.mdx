---
title: "Overview"
---

## High-level description
This directory contains RSpec test scenarios for various subscription-related functionalities in a billing system. The tests cover a wide range of scenarios including subscription activation, billing boundaries, free trials, upgrades, downgrades, and terminations. These tests ensure that the subscription system behaves correctly under different conditions, timezones, and billing configurations.

## What does it do?
The test scenarios in this directory simulate real-world subscription processes and verify that the billing system handles them correctly. Here's a breakdown of the main functionalities tested:

1. Subscription Activation: Ensures that subscriptions transition from pending to active state at the correct time.
2. Billing Boundaries: Verifies that invoices are created with correct billing periods for different plan types.
3. Billing Cycles: Tests invoice creation for various billing intervals (weekly, monthly, quarterly, yearly) and billing types (calendar, anniversary).
4. Free Trials: Checks the correct handling of free trial periods, including billing after trial end and plan upgrades during trials.
5. Subscription Upgrades and Downgrades: Simulates plan changes and verifies correct invoice and credit note generation.
6. Subscription Termination: Tests the termination process across different timezones and billing configurations.

These tests ensure that the subscription system can handle complex scenarios such as timezone differences, mid-cycle plan changes, and various billing models accurately.

## Key Files

1. `activation_spec.rb`: Tests the activation of subscriptions at their scheduled start date.
2. `billing_boundaries_spec.rb`: Verifies correct calculation of billing periods for invoices.
3. `billing_spec.rb`: Comprehensive tests for billing cycles across different plan intervals and timezones.
4. `free_trial_billing_spec.rb`: Tests various scenarios involving free trial periods.
5. `upgrade_spec.rb` and `downgrade_spec.rb`: Simulate and verify the process of changing subscription plans.
6. `multiple_upgrade_spec.rb`: Tests scenarios where a subscription is upgraded multiple times within a billing period.
7. `terminate_ended_spec.rb`: Verifies the correct termination of subscriptions across different timezones and billing configurations.

Each of these files contains detailed test scenarios that cover various edge cases and ensure the robustness of the subscription and billing system.

## Dependencies
The test files rely on several key dependencies:

| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads the Rails testing environment and RSpec configuration |
| FactoryBot | Used for creating test data (organizations, customers, plans) |
| ActiveSupport::Testing::TimeHelpers | Provides time manipulation methods like `travel_to` for simulating time progression |
| Various internal services (e.g., Subscriptions::BillingService, Subscriptions::TerminateService) | Core services being tested |

## Configuration
The tests use various configuration options to set up different scenarios:

| Option | Type | Description |
|:-------|:-----|:------------|
| plan_interval | Symbol | Defines the billing interval for the plan (e.g., :monthly, :yearly) |
| plan_pay_in_advance | Boolean | Determines if the plan is billed in advance |
| billing_time | String | Specifies the billing time strategy (e.g., 'anniversary', 'calendar') |
| timezone | String | Sets the timezone for testing (e.g., 'Europe/Paris', 'America/Bogota') |

These configuration options allow the tests to cover a wide range of scenarios and ensure the system works correctly under different conditions.

The test suite provides comprehensive coverage of the subscription lifecycle, from creation and activation through billing cycles, plan changes, and termination. It helps maintain the integrity of the billing system by catching potential issues related to time-sensitive operations, complex billing scenarios, and timezone handling.