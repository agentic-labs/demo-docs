---
title: "terminate_ended_spec.rb"
---

## High-level description
This code is a RSpec test file that describes various scenarios for terminating subscriptions. It tests the behavior of subscription termination across different timezones, billing times, and plan configurations, ensuring that the system correctly handles subscription endings and generates appropriate invoices.

## Code Structure
The test file is organized into several nested contexts, each testing different aspects of subscription termination. The main scenarios include:
1. Termination in different timezones (Europe/Paris, Asia/Bangkok, America/Bogota)
2. Termination when the ending date coincides with the billing date
3. Termination with different billing times (anniversary and calendar)
4. Termination with pay-in-advance plans

## Symbols

### `describe 'Subscriptions Termination Scenario'`
#### Description
This is the main describe block that encapsulates all the subscription termination tests.

#### Internal Logic
- Sets up common test data (organization, customer, plan)
- Defines various contexts for different termination scenarios

### Context: `when timezone is Europe/Paris`
#### Description
Tests subscription termination in the Europe/Paris timezone.

#### Internal Logic
1. Creates a subscription with a specific ending date
2. Advances time to after the ending date
3. Runs the termination job
4. Verifies that the subscription is terminated and the correct invoice is generated

### Context: `when timezone is Asia/Bangkok`
#### Description
Similar to the Europe/Paris context, but tests termination in the Asia/Bangkok timezone.

### Context: `when timezone is America/Bogota`
#### Description
Tests termination in the America/Bogota timezone, highlighting differences in invoice issuing dates due to timezone differences.

### Context: `when ending at is the same as billing date`
#### Description
Tests scenarios where the subscription ends on the same date as the billing cycle.

#### Internal Logic
1. Tests regular termination and billing
2. Tests termination with pay-in-advance plans
3. Tests termination on the day of creation
4. Tests termination in different timezones (America/Bogota, Asia/Bangkok)

### Context: `when billing time is calendar`
#### Description
Tests termination scenarios with calendar-based billing.

#### Internal Logic
1. Tests regular termination and billing
2. Tests termination with pay-in-advance plans
3. Tests termination with already triggered subscription jobs

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails testing environment and configurations |
| FactoryBot | Used for creating test data (organizations, customers, plans) |
| Clock::TerminateEndedSubscriptionsJob | Job being tested for terminating subscriptions |
| Subscriptions::TerminateService | Service used for manual termination in some tests |
| Subscriptions::BillingService | Service used for billing in some tests |

## Error Handling
The tests use `aggregate_failures` to group multiple expectations, allowing all assertions to be checked even if one fails.

## Performance Considerations
The tests use `travel_to` to manipulate time, which is crucial for testing time-dependent behaviors without waiting for actual time to pass.

This documentation provides a comprehensive overview of the subscription termination tests, highlighting the various scenarios and conditions being tested to ensure robust handling of subscription endings across different timezones and billing configurations.