---
title: "Overview"
---

## High-level description
This directory contains RSpec test scenarios for various aspects of a subscription-based billing system. The tests cover a wide range of functionalities including customer usage, credit notes, coupons, invoices, plans, subscriptions, taxes, and wallet transactions. These scenarios are designed to ensure the correct behavior of the billing system under different conditions and edge cases.

## What does it do?
The test scenarios in this directory simulate real-world usage of a billing system, focusing on different aspects such as:

1. Customer usage calculation and retrieval
2. Credit note creation and management
3. Coupon application and breakdown
4. Invoice generation, including taxes and grace periods
5. Plan creation, editing, and deletion
6. Subscription lifecycle management (creation, upgrades, downgrades, termination)
7. Tax calculation on invoices
8. Wallet transactions and their interaction with invoices

These tests ensure that the billing system accurately handles complex scenarios such as:
- Timezone differences in billing cycles
- Pro-ration of charges during subscription changes
- Application of coupons and taxes
- Handling of free trials
- Pay-in-advance and pay-in-arrears billing models
- Minimum commitments and spending limits

## Entry points
The main entry points for understanding the test suite are:

1. `spec/scenarios/customers/`: Tests for customer-related operations, including usage calculation and invoice grace periods.
2. `spec/scenarios/invoices/`: Comprehensive tests for invoice generation under various conditions.
3. `spec/scenarios/subscriptions/`: Tests covering the entire subscription lifecycle.
4. `spec/scenarios/plans/`: Scenarios for plan management and charge filters.
5. `spec/scenarios/fees/`: Tests for different types of fees and charges.

The test suite is organized to cover different aspects of the billing system, with each subdirectory focusing on a specific area of functionality.

## Key Files
1. `customer_usage_spec.rb`: Tests retrieval of customer usage information for subscriptions with different timezones.
2. `credit_note_spec.rb`: Verifies the creation of credit notes under various conditions.
3. `coupons_breakdown_spec.rb`: Tests the application of coupons to invoices and their breakdown.
4. `taxes_on_invoice_spec.rb`: Ensures correct tax calculation on invoices under different scenarios.
5. `pay_in_advance_charges_spec.rb`: Tests the creation of fees for pay-in-advance charges.
6. `terminate_pay_in_advance_spec.rb`: Verifies the termination process for pay-in-advance subscriptions.
7. `spending_minimum_spec.rb`: Tests scenarios involving spending minimums and grace periods.

These files contain detailed test cases that cover different aspects of the billing system, ensuring comprehensive coverage of its functionality.

## Dependencies
The test files rely on several key dependencies:

| Dependency | Purpose |
|:-----------|:--------|
| RSpec | Testing framework used for writing and running the tests |
| FactoryBot | Used for creating test data (organizations, customers, plans, etc.) |
| ActiveSupport::Testing::TimeHelpers | Provides time manipulation methods for simulating different dates and times |
| WebMock | Used for stubbing HTTP requests, particularly for webhook calls |
| Stripe | Simulated for payment processing in some tests |

These dependencies are crucial for setting up the test environment, creating test data, and simulating various conditions required for comprehensive testing of the billing system.

## Configuration
The tests use various configuration options to set up different scenarios:

| Option | Type | Description |
|:-------|:-----|:------------|
| timezone | String | Sets the timezone for testing (e.g., 'UTC', 'Europe/Paris') |
| billing_time | String | Specifies the billing time strategy (e.g., 'anniversary', 'calendar') |
| plan_interval | Symbol | Defines the billing interval for plans (e.g., :weekly, :monthly, :yearly) |
| lago_premium! | Method | Enables premium features for certain tests |

These configuration options allow the tests to cover a wide range of scenarios and ensure the system works correctly under different conditions.

The test suite provides extensive coverage of the billing system's functionality, simulating complex real-world scenarios to ensure reliability and accuracy across various billing models, subscription types, and edge cases. This comprehensive approach helps maintain the integrity of the billing system by catching potential issues related to time-sensitive operations, complex pricing structures, and intricate billing rules.