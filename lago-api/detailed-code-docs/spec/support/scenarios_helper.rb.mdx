---
title: "scenarios_helper.rb"
---

## High-level description
This code defines a module `ScenariosHelper` that provides helper methods for interacting with various API endpoints in a billing system. It includes methods for creating, updating, and deleting resources such as billable metrics, customers, plans, subscriptions, invoices, coupons, taxes, wallets, events, and credit notes. It also includes utility methods for performing background jobs and billing operations.

## Code Structure
The `ScenariosHelper` module contains multiple methods grouped by resource type (e.g., billable metrics, customers, plans). These methods typically make API calls using `post_with_token`, `put_with_token`, or `delete_with_token` helpers. The module also includes utility methods for job processing and billing operations.

## Symbols

### `create_metric`
#### Description
Creates a new billable metric by sending a POST request to the API.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| params | Hash | Parameters for creating the billable metric |

### `update_metric`
#### Description
Updates an existing billable metric by sending a PUT request to the API.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| metric | Object | The metric to be updated |
| params | Hash | Parameters for updating the billable metric |

### `create_or_update_customer`
#### Description
Creates or updates a customer by sending a POST request to the API and performs all enqueued jobs.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| params | Hash | Parameters for creating or updating the customer |

### `delete_customer`
#### Description
Deletes a customer by sending a DELETE request to the API.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| customer | Object | The customer to be deleted |

### `fetch_current_usage`
#### Description
Retrieves the current usage for a customer and subscription by sending a GET request to the API.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| customer | Object | The customer whose usage is being fetched |
| subscription | Object | The subscription for which usage is being fetched (default: customer's first subscription) |

### `create_plan`, `update_plan`, `delete_plan`
#### Description
These methods create, update, and delete plans by sending POST, PUT, and DELETE requests to the API, respectively.

### `create_subscription`, `terminate_subscription`
#### Description
These methods create and terminate subscriptions by sending POST and DELETE requests to the API, respectively. They also perform all enqueued jobs after the operation.

### `refresh_invoice`, `finalize_invoice`, `update_invoice`
#### Description
These methods refresh, finalize, and update invoices by sending PUT requests to the API.

### `create_coupon`, `apply_coupon`
#### Description
These methods create coupons and apply them by sending POST requests to the API.

### `create_tax`
#### Description
Creates a new tax by sending a POST request to the API.

### `create_wallet`, `create_wallet_transaction`
#### Description
These methods create wallets and wallet transactions by sending POST requests to the API and perform all enqueued jobs.

### `create_event`
#### Description
Creates an event by sending a POST request to the API, performs all enqueued jobs, and returns the parsed response body.

### `create_credit_note`, `estimate_credit_note`
#### Description
These methods create and estimate credit notes by sending POST requests to the API.

### `setup_stripe_for`
#### Description
Sets up Stripe payment provider for a customer.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| customer | Object | The customer for whom Stripe is being set up |

### `perform_all_enqueued_jobs`
#### Description
Performs all enqueued jobs until the queue is empty, including jobs that enqueue other jobs.

### `perform_billing`
#### Description
Performs billing operations by enqueuing and executing billing jobs.

### `perform_invoices_refresh`
#### Description
Performs invoice refresh operations by enqueuing and executing the refresh job.

### `perform_finalize_refresh`
#### Description
Performs invoice finalization operations by enqueuing and executing the finalization job.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| Sidekiq | Used for background job processing |

## Error Handling
The code does not implement specific error handling mechanisms. It relies on the underlying API request methods (`post_with_token`, `put_with_token`, etc.) to handle errors.

## Logging
The code does not implement explicit logging mechanisms.

## API/Interface Reference
This module provides helper methods for interacting with various API endpoints. The API structure follows RESTful conventions, with endpoints for different resources (e.g., `/api/v1/billable_metrics`, `/api/v1/customers`, etc.).

## TODOs
There are no explicit TODOs in the code.