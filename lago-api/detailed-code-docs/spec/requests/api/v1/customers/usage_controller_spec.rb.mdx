---
title: "usage_controller_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Api::V1::Customers::UsageController`, specifically testing the endpoints for retrieving current and past usage data for customers. The tests cover various scenarios including different charge models, filters, and multiple filter values.

## Code Structure
The test file is organized into two main describe blocks, one for each endpoint: `GET /customers/:customer_id/current_usage` and `GET /customers/:customer_id/past_usage`. Within each block, there are multiple contexts and examples testing different scenarios and edge cases.

## Symbols

### RSpec.describe Api::V1::Customers::UsageController
#### Description
This is the main describe block for the controller tests. It sets up common let variables used across multiple tests.

#### Internal Logic
- Sets up common test data such as customer, organization, plan, and subscription.
- Defines two main describe blocks for testing different endpoints.

### describe 'GET /customers/:customer_id/current_usage'
#### Description
Tests the endpoint for retrieving current usage data for a customer.

#### Internal Logic
- Sets up additional test data including tax, metric, and charge.
- Creates events for the customer.
- Tests the response structure and content for current usage.
- Includes additional contexts for testing with filters and multiple filter values.

### describe 'GET /customers/:customer_id/past_usage'
#### Description
Tests the endpoint for retrieving past usage data for a customer.

#### Internal Logic
- Sets up test data including invoice subscription, billable metrics, charges, and fees.
- Tests the response structure and content for past usage.
- Includes additional contexts for testing error cases.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Provides Rails-specific testing configurations and helpers |
| FactoryBot | Used for creating test data |

## Error Handling
The tests cover error scenarios such as:
- Customer not belonging to the organization (returns 404 Not Found)
- Missing external_subscription_id (returns 422 Unprocessable Entity)
- Invalid billable metric code (returns 404 Not Found)

## API/Interface Reference
| Endpoint | Method | Request | Response | Description |
|:---------|:-------|:--------|:---------|:------------|
| /customers/:customer_id/current_usage | GET | customer_id, external_subscription_id | Current usage data | Retrieves current usage for a customer |
| /customers/:customer_id/past_usage | GET | customer_id, external_subscription_id, periods_count | Past usage data | Retrieves past usage for a customer |

Note: The actual implementation of these endpoints is not provided in this test file, but the expected response structure and content are described in the tests.