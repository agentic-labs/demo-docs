---
title: "overdue_balances_controller_spec.rb"
---

## High-level description
This code is a RSpec test suite for the `Api::V1::Analytics::OverdueBalancesController`. It specifically tests the GET request to the `/analytics/overdue_balances` endpoint, verifying that the API correctly returns overdue balance information for a given organization.

## Symbols

### `RSpec.describe Api::V1::Analytics::OverdueBalancesController, type: :request`
#### Description
This is the main describe block for the test suite, specifying that we're testing the `Api::V1::Analytics::OverdueBalancesController` with request specs.

### `describe "GET /analytics/overdue_balances"`
#### Description
This nested describe block focuses on testing the GET request to the `/analytics/overdue_balances` endpoint.

### `let(:customer)` and `let(:organization)`
#### Description
These are let statements that set up the test data. They create a customer and an organization using FactoryBot factories.

### `it "returns the overdue balance"`
#### Description
This is the main test case that verifies the behavior of the overdue balances endpoint.

#### Internal Logic
1. Uses `travel_to` to set a specific date for the test (January 15, 2024).
2. Creates several invoices with different overdue statuses and amounts.
3. Makes a GET request to the `/api/v1/analytics/overdue_balance` endpoint.
4. Checks the response status and the structure of the returned JSON.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads the Rails testing environment and configuration |
| FactoryBot | Used for creating test data (customer, organization, invoices) |
| travel_to | Allows time manipulation in tests |

## References
- `get_with_token`: This seems to be a custom helper method for making authenticated GET requests in tests.
- `create`: This is likely a FactoryBot method for creating test objects.
- `have_http_status`: An RSpec matcher for checking HTTP response status.
- `match_array`: An RSpec matcher for comparing arrays regardless of order.

## Notes
1. The test creates invoices with specific overdue conditions and amounts.
2. It checks if the API correctly aggregates overdue balances by month.
3. The test uses time travel to set a specific date context for the test.
4. The response is expected to include overdue balances for two months: November 2023 and January 2024.
5. The test verifies both the structure and the content of the API response.

This test ensures that the overdue balances controller correctly calculates and returns overdue balance information, grouped by month, for a given organization. It checks for correct amounts, currencies, and associated invoice IDs in the response.