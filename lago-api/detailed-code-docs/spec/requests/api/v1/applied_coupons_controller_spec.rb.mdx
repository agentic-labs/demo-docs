---
title: "applied_coupons_controller_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Api::V1::AppliedCouponsController`. It tests the 'apply' and 'index' actions of the controller, verifying the correct behavior when applying coupons to customers and retrieving lists of applied coupons.

## Code Structure
The test suite is organized into two main describe blocks: one for the 'apply' action and another for the 'index' action. Each block contains multiple test cases that cover different scenarios and edge cases.

## Symbols

### RSpec.describe Api::V1::AppliedCouponsController
#### Description
This is the main describe block for the `Api::V1::AppliedCouponsController` tests. It sets up the context for all the tests within this file.

### describe 'apply'
#### Description
This describe block focuses on testing the 'apply' action of the controller, which is responsible for applying a coupon to a customer.

#### Internal Logic
1. Sets up necessary data (organization, customer, coupon, subscription)
2. Defines parameters for the API call
3. Tests successful coupon application
4. Tests error handling for invalid parameters

### describe 'index'
#### Description
This describe block tests the 'index' action of the controller, which retrieves a list of applied coupons.

#### Internal Logic
1. Sets up necessary data (customer, coupon, credit, applied coupon)
2. Tests the retrieval of applied coupons
3. Verifies the response structure and pagination metadata

### let(:organization)
#### Description
Creates a factory instance of an organization for use in the tests.

### let(:customer)
#### Description
Creates a factory instance of a customer associated with the organization.

### let(:coupon)
#### Description
Creates a factory instance of a coupon associated with the organization.

### let(:params)
#### Description
Defines the parameters used for the API call in the 'apply' action test.

### it 'returns a success'
#### Description
Tests the successful application of a coupon to a customer.

#### Internal Logic
1. Makes a POST request to apply the coupon
2. Checks for a successful HTTP status
3. Verifies the structure and content of the response JSON

### context 'with invalid params'
#### Description
Tests the error handling when invalid parameters are provided for coupon application.

#### Internal Logic
1. Defines invalid parameters
2. Makes a POST request with invalid parameters
3. Checks for a 'not found' HTTP status

### it 'returns applied coupons'
#### Description
Tests the retrieval of applied coupons in the 'index' action.

#### Internal Logic
1. Makes a GET request to retrieve applied coupons
2. Checks for a successful HTTP status
3. Verifies the structure and content of the response JSON, including pagination metadata

## Dependencies
The test file relies on the following dependencies:
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Provides the necessary setup for Rails-specific testing |
| FactoryBot | Used for creating test data through factories |

## Error Handling
The test suite includes a scenario for testing error handling when invalid parameters are provided for coupon application. It expects a 'not found' HTTP status in this case.