---
title: "customers_controller_spec.rb"
---

## High-level description
This file contains RSpec tests for the Api::V1::CustomersController, focusing on the create, show, index, delete, and checkout URL generation actions. It tests various scenarios including creating customers with different parameters, retrieving customer information, and generating portal and checkout URLs.

## Code Structure
The test suite is organized into several describe blocks, each focusing on a specific API endpoint or functionality. Within each describe block, there are multiple test cases (it blocks) that cover different scenarios and edge cases.

## Symbols

### RSpec.describe Api::V1::CustomersController
#### Description
This is the main describe block for the Api::V1::CustomersController tests. It groups all the tests related to this controller.

### describe 'create'
#### Description
This block tests the customer creation functionality.

#### Internal Logic
- Tests creating a customer with basic parameters
- Tests creating a customer with premium features
- Tests creating a customer with billing configuration
- Tests creating a customer with metadata
- Tests handling of invalid parameters

### describe 'GET /customers/:customer_external_id/portal_url'
#### Description
This block tests the generation of a customer portal URL.

#### Internal Logic
- Tests successful portal URL generation for premium licenses
- Tests error handling for non-premium licenses
- Tests error handling for customers not belonging to the organization

### describe 'GET /customers'
#### Description
This block tests the retrieval of all customers for an organization.

#### Internal Logic
- Tests successful retrieval of all customers
- Checks the response format and content

### describe 'GET /customers/:customer_id'
#### Description
This block tests the retrieval of a specific customer's information.

#### Internal Logic
- Tests successful retrieval of a customer's details
- Tests error handling for non-existent customers

### describe 'DELETE /customers/:customer_id'
#### Description
This block tests the deletion of a customer.

#### Internal Logic
- Tests successful deletion of a customer
- Checks the response format and content
- Tests error handling for non-existent customers

### describe 'POST /customers/:external_customer_id/checkout_url'
#### Description
This block tests the generation of a checkout URL for a customer.

#### Internal Logic
- Tests successful generation of a checkout URL
- Checks the response format and content

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Provides RSpec configuration for Rails |
| FactoryBot | Used for creating test data |
| Stripe::Checkout::Session | Mocked for testing checkout URL generation |

## Error Handling
The tests cover various error scenarios, including:
- Invalid parameters during customer creation
- Attempting to access premium features without a premium license
- Attempting to retrieve or delete non-existent customers

## API/Interface Reference
| Endpoint | Method | Description |
|:---------|:-------|:------------|
| /api/v1/customers | POST | Create a new customer |
| /api/v1/customers/:customer_external_id/portal_url | GET | Generate a portal URL for a customer |
| /api/v1/customers | GET | Retrieve all customers for an organization |
| /api/v1/customers/:customer_id | GET | Retrieve a specific customer's information |
| /api/v1/customers/:customer_id | DELETE | Delete a customer |
| /api/v1/customers/:external_customer_id/checkout_url | POST | Generate a checkout URL for a customer |

This test suite provides comprehensive coverage of the Api::V1::CustomersController, ensuring that all major functionalities and edge cases are tested.