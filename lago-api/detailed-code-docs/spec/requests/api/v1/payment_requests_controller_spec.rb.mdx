---
title: "payment_requests_controller_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Api::V1::PaymentRequestsController`. It focuses on testing the `create` and `index` actions of the controller, verifying the correct behavior when creating payment requests and retrieving them for an organization or a specific customer.

## Code Structure
The test suite is organized into two main describe blocks: one for the `create` action and another for the `index` action. Each block contains one or more examples (it blocks) that test specific scenarios and expected outcomes.

## Symbols

### RSpec.describe Api::V1::PaymentRequestsController
#### Description
This is the main describe block for the `Api::V1::PaymentRequestsController` tests. It sets up the context for testing the controller's actions.

### describe "create"
#### Description
This block tests the `create` action of the controller.

#### Internal Logic
1. Sets up test data (organization, customer, and params).
2. Mocks the `PaymentRequests::CreateService` to return a successful result.
3. Sends a POST request to create a payment request.
4. Verifies that the service was called with correct parameters.
5. Checks the response status and content.

### describe "index"
#### Description
This block tests the `index` action of the controller.

#### Internal Logic
1. Tests retrieving all payment requests for an organization.
2. Tests the scenario with a non-existent customer.
3. Tests retrieving payment requests for a specific customer.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails testing environment and configuration |
| FactoryBot | Used for creating test data |

## Error Handling
The tests implicitly check for error handling by verifying the response status codes and content.

## API/Interface Reference
| Endpoint | Method | Request | Response | Description |
|:---------|:-------|:--------|:---------|:------------|
| /api/v1/payment_requests | POST | payment_request params | Created payment request | Creates a new payment request |
| /api/v1/payment_requests | GET | Optional: external_customer_id | List of payment requests | Retrieves payment requests |

## Performance Considerations
The tests use `create` method for setting up test data, which might be slower than using `build_stubbed` or other FactoryBot methods for large datasets. Consider using faster methods if test performance becomes an issue.

## References
- `PaymentRequests::CreateService`: The controller delegates the creation of payment requests to this service.
- `BaseService::Result`: Used to wrap the result of the create service call.
- `FactoryBot`: Used to create test data (organization, customer, payment_request, invoice).
- `post_with_token` and `get_with_token`: Custom helper methods for making authenticated requests.

This test file ensures that the `PaymentRequestsController` correctly handles the creation and retrieval of payment requests, including proper parameter passing, service delegation, and response formatting.