---
title: "plans_controller_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Api::V1::PlansController`, focusing on the create, update, show, destroy, and index actions. It tests various scenarios including handling of premium features, minimum commitments, usage thresholds, and error cases.

## Code Structure
The test file is organized into describe blocks for each controller action (create, update, show, destroy, index). Within each block, various contexts and scenarios are tested using it blocks. The tests use factory-created objects and helper methods for API requests.

## Symbols

### `RSpec.describe Api::V1::PlansController, type: :request`
#### Description
This is the main describe block for the PlansController tests. It sets up common let variables used across multiple tests.

### `describe 'create'`
#### Description
Tests the create action of the PlansController.

#### Internal Logic
- Tests creation of plans with various parameters
- Checks handling of premium features
- Verifies error responses for invalid inputs
- Tests creation of plans with graduated charges and without charges

### `describe 'update'`
#### Description
Tests the update action of the PlansController.

#### Internal Logic
- Verifies updating of plan details
- Tests handling of minimum commitments
- Checks premium feature updates
- Verifies error responses for invalid updates

### `describe 'show'`
#### Description
Tests the show action of the PlansController.

#### Internal Logic
- Verifies correct plan details are returned
- Tests inclusion of minimum commitments and usage thresholds
- Checks error response for non-existent plans

### `describe 'destroy'`
#### Description
Tests the destroy action of the PlansController.

#### Internal Logic
- Verifies plan is marked as pending_deletion
- Checks that child plans are also marked for deletion
- Tests error response for non-existent plans

### `describe 'index'`
#### Description
Tests the index action of the PlansController.

#### Internal Logic
- Verifies correct listing of plans
- Tests pagination of results

## Dependencies
The test file relies on:
- Rails testing framework (RSpec)
- FactoryBot for object creation
- Custom helper methods (e.g., `post_with_token`, `get_with_token`)

## Configuration
The tests use various helper methods and factories defined in other files (not shown in the provided snippets).

## Error Handling
The tests check for appropriate error responses in various scenarios, such as invalid inputs or non-existent resources.

## API/Interface Reference
The tests cover the following API endpoints:
- POST /api/v1/plans
- PUT /api/v1/plans/:code
- GET /api/v1/plans/:code
- DELETE /api/v1/plans/:code
- GET /api/v1/plans

Each endpoint is tested for successful operations and error cases.