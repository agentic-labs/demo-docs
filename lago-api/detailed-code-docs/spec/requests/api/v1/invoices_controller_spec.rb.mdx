---
title: "invoices_controller_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Api::V1::InvoicesController`, focusing on various API endpoints related to invoice management. The tests cover creating, updating, retrieving, and performing actions on invoices, ensuring proper functionality and error handling.

## Code Structure
The test file is organized into several `describe` blocks, each corresponding to a specific API endpoint or action. Within these blocks, various test scenarios are defined using `context` and `it` blocks. The tests use factory-created objects and mock certain service calls to isolate the controller behavior.

## Symbols

### `RSpec.describe Api::V1::InvoicesController, type: :request`
#### Description
This is the main describe block for the `Api::V1::InvoicesController` tests. It sets up the context for testing API requests related to invoice management.

### `describe 'POST /invoices'`
#### Description
Tests the creation of new invoices through the API.

#### Internal Logic
- Tests successful invoice creation with various parameters
- Checks error handling for non-existent customers and add-ons

### `describe 'PUT /invoices/:id'`
#### Description
Tests updating existing invoices, including payment status and metadata.

#### Internal Logic
- Verifies successful invoice updates
- Checks error handling for non-existent invoices
- Tests metadata updates

### `describe 'GET /invoices/:id'`
#### Description
Tests retrieving a single invoice by its ID.

#### Internal Logic
- Verifies correct invoice details are returned
- Checks error handling for non-existent or unauthorized invoices
- Tests handling of invoices with deleted related resources

### `describe 'GET /invoices'`
#### Description
Tests listing invoices with various filter and pagination options.

#### Internal Logic
- Verifies correct pagination
- Tests filtering by issuing date, customer, status, payment status, and other attributes
- Checks search functionality

### `describe 'PUT /invoices/:id/refresh'`
#### Description
Tests the refresh action for draft invoices.

#### Internal Logic
- Verifies that draft invoices can be refreshed
- Checks that finalized invoices are not modified

### `describe 'PUT /invoices/:id/finalize'`
#### Description
Tests the finalization of draft invoices.

#### Internal Logic
- Verifies successful finalization of draft invoices
- Checks error handling for non-draft invoices

### `describe 'POST /invoices/:id/void'`
#### Description
Tests voiding finalized invoices.

#### Internal Logic
- Verifies successful voiding of eligible invoices
- Checks error handling for ineligible invoices (e.g., draft, already voided, or paid)

### `describe 'POST /invoices/:id/lose_dispute'`
#### Description
Tests marking an invoice as lost in a payment dispute.

#### Internal Logic
- Verifies successful marking of finalized invoices as lost in dispute
- Checks error handling for ineligible invoice statuses

### `describe 'POST /invoices/:id/download'`
#### Description
Tests the invoice download functionality.

#### Internal Logic
- Checks error handling for draft invoices

### `describe 'GET /invoices/:id/retry_payment'`
#### Description
Tests retrying payment for an invoice.

#### Internal Logic
- Verifies the retry service is called
- Checks error handling for non-existent or unauthorized invoices

### `describe 'GET /invoices/:id/retry'`
#### Description
Tests retrying an invoice.

#### Internal Logic
- Verifies the retry service is called
- Checks error handling for non-existent or unauthorized invoices

### `describe 'POST /invoices/:id/payment_url'`
#### Description
Tests generating a payment URL for an invoice.

#### Internal Logic
- Verifies successful generation of payment URL
- Mocks Stripe API call for URL creation

## Dependencies
The test file relies on Rails testing frameworks, RSpec, and various helper modules defined in the project's test suite.

## Configuration
The tests use factory-created objects and mocked service calls to isolate controller behavior and test specific scenarios.