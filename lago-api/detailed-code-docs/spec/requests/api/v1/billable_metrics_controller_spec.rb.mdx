---
title: "billable_metrics_controller_spec.rb"
---

## High-level description
This file contains RSpec tests for the `Api::V1::BillableMetricsController`, focusing on CRUD operations (create, update, show, destroy, and index) for billable metrics. It tests various scenarios, including successful operations, error handling, and specific cases like weighted sum aggregation.

## Code Structure
The test suite is organized into describe blocks for each API endpoint (create, update, show, destroy, and index). Within each block, there are multiple test cases (it blocks) that cover different scenarios and edge cases.

## Symbols

### `RSpec.describe Api::V1::BillableMetricsController, type: :request`
#### Description
This is the main describe block for the BillableMetricsController tests. It sets up the context for all the tests within this file.

### `describe 'create'`
#### Description
Tests the creation of billable metrics through the API.

#### Internal Logic
1. Tests successful creation of a billable metric
2. Tests creation with weighted sum aggregation

### `describe 'update'`
#### Description
Tests the updating of existing billable metrics through the API.

#### Internal Logic
1. Tests successful update of a billable metric
2. Tests error handling for non-existent billable metrics
3. Tests validation error when updating with a duplicate code
4. Tests update with weighted sum aggregation

### `describe 'show'`
#### Description
Tests retrieving a single billable metric through the API.

#### Internal Logic
1. Tests successful retrieval of a billable metric
2. Tests error handling for non-existent billable metrics
3. Tests error handling for deleted billable metrics

### `describe 'destroy'`
#### Description
Tests the deletion of billable metrics through the API.

#### Internal Logic
1. Tests successful deletion of a billable metric
2. Tests error handling for non-existent billable metrics

### `describe 'index'`
#### Description
Tests listing billable metrics through the API.

#### Internal Logic
1. Tests successful listing of billable metrics
2. Tests pagination of billable metrics

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails testing environment and configuration |
| FactoryBot | Used for creating test data |

## Error Handling
The tests cover various error scenarios, including:
- Attempting to update or delete non-existent billable metrics (expects 404 Not Found)
- Attempting to update a billable metric with a duplicate code (expects 422 Unprocessable Entity)

## API/Interface Reference
| Endpoint | Method | Description |
|:---------|:-------|:------------|
| /api/v1/billable_metrics | POST | Create a new billable metric |
| /api/v1/billable_metrics/:code | PUT | Update an existing billable metric |
| /api/v1/billable_metrics/:code | GET | Retrieve a single billable metric |
| /api/v1/billable_metrics/:code | DELETE | Delete a billable metric |
| /api/v1/billable_metrics | GET | List billable metrics (with pagination) |

Note: The tests use helper methods like `post_with_token`, `put_with_token`, `get_with_token`, and `delete_with_token`, which are likely defined in a support file to handle authentication and API requests.