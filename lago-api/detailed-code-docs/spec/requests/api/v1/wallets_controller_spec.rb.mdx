---
title: "wallets_controller_spec.rb"
---

## High-level description
This file contains RSpec tests for the Api::V1::WalletsController, focusing on the create, update, show, terminate, and index actions. It tests various scenarios for wallet creation, updating, retrieval, termination, and listing, including handling of recurring transaction rules and transaction metadata.

## Code Structure
The test suite is organized into describe blocks for each action (create, update, show, terminate, index). Within each block, various scenarios are tested using it blocks. The tests use factory-created objects and make HTTP requests to the API endpoints using helper methods like post_with_token, put_with_token, get_with_token, and delete_with_token.

## Symbols

### RSpec.describe Api::V1::WalletsController
#### Description
This is the main describe block for the WalletsController tests. It sets up common let variables and a before block to create a subscription.

#### Internal Logic
- Sets up factory objects for organization, customer, and subscription
- Defines common variables like expiration_at

### describe 'create'
#### Description
Tests the wallet creation endpoint.

#### Internal Logic
- Tests successful wallet creation
- Tests creation with transaction metadata
- Tests creation with recurring transaction rules (in premium mode)

### describe 'update'
#### Description
Tests the wallet update endpoint.

#### Internal Logic
- Tests successful wallet update
- Tests updating non-existent wallets
- Tests updating with recurring transaction rules (in premium mode)
- Tests various scenarios for invoice_requires_successful_payment flag

### describe 'show'
#### Description
Tests the wallet retrieval endpoint.

#### Internal Logic
- Tests successful wallet retrieval
- Tests retrieval of non-existent wallets

### describe 'terminate'
#### Description
Tests the wallet termination endpoint.

#### Internal Logic
- Tests successful wallet termination
- Tests termination of non-existent wallets
- Tests termination of wallets from other organizations

### describe 'index'
#### Description
Tests the wallet listing endpoint.

#### Internal Logic
- Tests successful wallet listing
- Tests pagination
- Tests listing wallets for non-existent customers

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Provides testing setup and utilities |
| FactoryBot | Used for creating test objects |

## Configuration
The tests use various configuration options set in the rails_helper.rb file, including:
- Setting up the test environment
- Configuring SimpleCov for code coverage
- Setting up database cleaner
- Configuring RSpec

## Error Handling
The tests check for appropriate error responses in various scenarios, such as:
- Attempting to access non-existent wallets
- Attempting to access wallets from other organizations

## Performance Considerations
The tests use factory objects and database transactions, which can impact test performance. However, these are standard practices for Rails testing and provide a good balance between test fidelity and speed.

## TODOs
There are no explicit TODOs in the code.

This test suite provides comprehensive coverage of the WalletsController functionality, including edge cases and premium features. It ensures that the wallet-related API endpoints behave correctly under various scenarios.