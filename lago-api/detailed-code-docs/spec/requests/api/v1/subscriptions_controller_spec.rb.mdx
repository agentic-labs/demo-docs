---
title: "subscriptions_controller_spec.rb"
---

## High-level description
This file contains RSpec tests for the Api::V1::SubscriptionsController, focusing on the create, delete, update, show, and index actions. It tests various scenarios for subscription management, including creating subscriptions with different parameters, updating existing subscriptions, and retrieving subscription information.

## Code Structure
The test suite is organized into describe blocks for each action (create, delete, update, show, and index). Within each block, various scenarios are tested using it blocks. The tests use let statements to set up test data and context blocks to test specific conditions.

## Symbols

### RSpec.describe Api::V1::SubscriptionsController
#### Description
This is the main describe block for the SubscriptionsController tests. It sets up common test data and wraps all tests in a lago_premium! context.

#### Internal Logic
- Sets up test data using let statements (organization, customer, plan, etc.)
- Uses around block to ensure tests run in a premium context

### describe 'create'
#### Description
Tests the create action of the SubscriptionsController.

#### Internal Logic
- Tests successful subscription creation with various parameters
- Tests error cases (missing external_customer_id, invalid plan code, etc.)
- Tests creation with legacy subscription_date

### describe 'delete /subscriptions/:id'
#### Description
Tests the delete action of the SubscriptionsController.

#### Internal Logic
- Tests successful subscription termination
- Tests error case for non-existent subscription

### describe 'update'
#### Description
Tests the update action of the SubscriptionsController.

#### Internal Logic
- Tests successful subscription update with various parameters
- Tests error cases (non-existent subscription)
- Tests update behavior with multiple subscriptions

### describe 'show'
#### Description
Tests the show action of the SubscriptionsController.

#### Internal Logic
- Tests successful retrieval of a subscription
- Tests error case for non-existent subscription
- Tests retrieval with specific status

### describe 'index'
#### Description
Tests the index action of the SubscriptionsController.

#### Internal Logic
- Tests successful retrieval of subscriptions
- Tests pagination
- Tests filtering by plan code and status

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Provides testing setup and utilities |
| FactoryBot | Used for creating test data |

## Configuration
The tests use various configuration options set up in the rails_helper.rb file, including:
- SimpleCov for code coverage
- DatabaseCleaner for managing test database state
- FactoryBot for creating test data
- Custom helpers (ApiHelper, LicenseHelper, etc.)

## Error Handling
The tests check for appropriate error responses in various scenarios, such as:
- Missing required parameters (e.g., external_customer_id)
- Invalid input data (e.g., invalid plan code)
- Non-existent resources (e.g., trying to update or delete a non-existent subscription)

## TODOs
There are no explicit TODOs in the code.

This test suite provides comprehensive coverage for the SubscriptionsController, ensuring that all main actions (create, delete, update, show, and index) function correctly under various scenarios, including error cases and different parameter combinations.