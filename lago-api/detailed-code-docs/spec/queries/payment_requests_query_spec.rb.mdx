---
title: "payment_requests_query_spec.rb"
---

## High-level description
This code is a RSpec test suite for the `PaymentRequestsQuery` class. It verifies the functionality of querying payment requests, including pagination and filtering by customer ID.

## Symbols

### `RSpec.describe PaymentRequestsQuery, type: :query`
#### Description
This is the main describe block for the `PaymentRequestsQuery` test suite. It sets up the context for testing the query functionality.

### `subject(:result)`
#### Description
Defines the subject of the test, which is the result of calling the `PaymentRequestsQuery.call` method with specified parameters.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| organization | Organization | The organization associated with the payment requests |
| pagination | Hash or nil | Pagination parameters (optional) |
| filters | Hash | Filtering parameters (optional) |

### `let` statements
#### Description
These statements define variables used throughout the tests, including:
- `pagination`: Pagination parameters (default: nil)
- `filters`: Filtering parameters (default: empty hash)
- `membership`: A created membership
- `organization`: The organization associated with the membership
- `customer`: A created customer associated with the organization
- `payment_request_first`: A created payment request for the organization
- `payment_request_second`: Another created payment request for the organization and customer

### Main test case
#### Description
Verifies that the query returns all payment requests for the organization.

#### Internal Logic
1. Calls the `PaymentRequestsQuery.call` method
2. Checks if the result is successful
3. Verifies that the returned payment requests match the expected IDs

### Context: "with pagination"
#### Description
Tests the pagination functionality of the query.

#### Internal Logic
1. Sets pagination parameters (page 2, limit 1)
2. Verifies various pagination attributes of the result

### Context: "when filtering by customer_id"
#### Description
Tests the filtering functionality of the query based on customer ID.

#### Internal Logic
1. Sets the filter to use the customer's external ID
2. Verifies that only the payment request associated with the specified customer is returned

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails testing environment and configuration |
| RSpec | Testing framework used for writing and running tests |
| FactoryBot | Used for creating test data (memberships, customers, payment requests) |

## Notes
- The test suite uses FactoryBot to create test data.
- Aggregate failures are used to group multiple expectations together.
- The test covers basic querying, pagination, and filtering scenarios for payment requests.