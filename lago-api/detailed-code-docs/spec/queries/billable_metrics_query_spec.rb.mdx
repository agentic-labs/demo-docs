---
title: "billable_metrics_query_spec.rb"
---

## High-level description
This code is a RSpec test suite for the `BillableMetricsQuery` class. It tests various scenarios of querying billable metrics, including pagination, filtering by recurring metrics and aggregation types, and searching by term.

## Code Structure
The test suite is organized into a main describe block for `BillableMetricsQuery`, with several contexts testing different query scenarios. Each context sets up specific conditions and expectations for the query results.

## Symbols

### `RSpec.describe BillableMetricsQuery`
#### Description
This is the main describe block for the `BillableMetricsQuery` test suite. It sets up the basic test environment and defines the subject of the tests.

#### Internal Logic
- Sets up the subject as the result of calling `BillableMetricsQuery.call` with various parameters.
- Defines let variables for pagination, search term, filters, organization, and several billable metrics.
- Creates billable metrics before running the tests.

### Main "it" block
#### Description
Tests the basic functionality of the query without any filters or search terms.

#### Internal Logic
- Checks if the result is successful.
- Verifies that all four created billable metrics are returned.

### Context: "with pagination"
#### Description
Tests the pagination functionality of the query.

#### Internal Logic
- Sets up pagination parameters (page 2, limit 3).
- Checks various pagination-related attributes of the result.

### Context: "when filtering by recurring billable metrics"
#### Description
Tests filtering the query results to only include recurring billable metrics.

#### Internal Logic
- Creates an additional recurring billable metric.
- Applies a filter for recurring metrics.
- Verifies that only the recurring metric is returned.

### Context: "when filtering by count_agg aggregation type"
#### Description
Tests filtering the query results by the "count_agg" aggregation type.

#### Internal Logic
- Applies a filter for the "count_agg" aggregation type.
- Verifies that only the metrics with this aggregation type are returned.

### Context: "when filtering by max_agg aggregation type"
#### Description
Tests filtering the query results by the "max_agg" aggregation type.

#### Internal Logic
- Applies a filter for the "max_agg" aggregation type.
- Verifies that no metrics are returned (as none have this aggregation type).

### Context: "when searching for /de/ term"
#### Description
Tests the search functionality of the query.

#### Internal Logic
- Sets a search term "de".
- Verifies that only the metrics with names containing "de" are returned.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads the Rails testing environment and configuration |

## Error Handling
This test suite doesn't explicitly test error handling. It focuses on testing the successful execution of queries under various conditions.