---
title: "subscriptions_query_spec.rb"
---

## High-level description
This file contains RSpec tests for the `SubscriptionsQuery` class. It tests various scenarios of querying subscriptions, including pagination and filtering by customer, plan, and subscription status.

## Code Structure
The test suite is organized around the `call` method of the `SubscriptionsQuery` class, with different contexts testing various filtering and pagination scenarios.

## Symbols

### `RSpec.describe SubscriptionsQuery`
#### Description
This is the main describe block for the `SubscriptionsQuery` test suite.

#### Internal Logic
- Sets up the necessary test data (organization, customer, plan, and subscription)
- Defines various contexts to test different query scenarios

### `describe 'call'`
#### Description
This describe block focuses on testing the `call` method of the `SubscriptionsQuery` class.

#### Internal Logic
- Tests the basic functionality of returning a list of subscriptions
- Tests pagination
- Tests filtering by customer
- Tests filtering by plan
- Tests filtering by multiple subscription statuses
- Tests filtering by individual subscription statuses (pending, canceled, terminated)
- Tests the default behavior when no status filter is applied

### `context 'with pagination'`
#### Description
Tests the pagination functionality of the query.

#### Internal Logic
- Sets up pagination parameters (page 2, limit 10)
- Verifies that the pagination is applied correctly

### `context 'with customer filter'`
#### Description
Tests filtering subscriptions by customer.

#### Internal Logic
- Applies a filter using the customer's external ID
- Verifies that the correct number of subscriptions is returned

### `context 'with plan filter'`
#### Description
Tests filtering subscriptions by plan.

#### Internal Logic
- Applies a filter using the plan's code
- Verifies that the correct number of subscriptions is returned

### `context 'with multiple status filter'`
#### Description
Tests filtering subscriptions by multiple statuses.

#### Internal Logic
- Creates subscriptions with different statuses
- Applies a filter for active and pending statuses
- Verifies that only subscriptions with the specified statuses are returned

### `context 'with pending status filter'`
#### Description
Tests filtering subscriptions by pending status.

#### Internal Logic
- Creates subscriptions with different statuses
- Applies a filter for pending status
- Verifies that only pending subscriptions are returned

### `context 'with canceled status filter'`
#### Description
Tests filtering subscriptions by canceled status.

#### Internal Logic
- Creates subscriptions with different statuses
- Applies a filter for canceled status
- Verifies that only canceled subscriptions are returned

### `context 'with terminated status filter'`
#### Description
Tests filtering subscriptions by terminated status.

#### Internal Logic
- Creates subscriptions with different statuses
- Applies a filter for terminated status
- Verifies that only terminated subscriptions are returned

### `context 'with no status filter'`
#### Description
Tests the default behavior when no status filter is applied.

#### Internal Logic
- Creates both active and pending subscriptions
- Verifies that only active subscriptions are returned by default

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails testing environment and configuration |
| FactoryBot | Used for creating test data |

Note: The `rails_helper` file is included in the related code snippets and sets up the testing environment, including SimpleCov for code coverage, database cleaner, and various RSpec configurations.