---
title: "coupons_query_spec.rb"
---

## High-level description
This file contains RSpec tests for the `CouponsQuery` class. It tests various scenarios including retrieving all coupons, applying pagination, searching by term, and filtering by status. The tests ensure that the query returns the expected results under different conditions.

## Code Structure
The test suite is organized around the `CouponsQuery.call` method, with different contexts testing various input parameters and expected outcomes. The tests use FactoryBot to create test data and RSpec's `let` statements to define variables used across multiple tests.

## Symbols

### `RSpec.describe CouponsQuery, type: :query`
#### Description
This is the main describe block for the `CouponsQuery` tests. It sets up the test environment and defines the subject of the tests.

#### Internal Logic
- Sets up the subject as the result of calling `CouponsQuery.call` with various parameters.
- Defines default values for pagination, search_term, filters, and test data.
- Creates test coupons with different attributes for testing various scenarios.

### `it 'returns all coupons'`
#### Description
Tests that the query returns all coupons when no filters or search terms are applied.

#### Internal Logic
- Checks that the result contains 3 coupons.
- Verifies that the returned coupons include the IDs of all created test coupons.

### `context 'with pagination'`
#### Description
Tests the pagination functionality of the query.

#### Internal Logic
- Sets pagination parameters (page 2 with a limit of 2).
- Checks various pagination-related attributes of the result, such as current page, total pages, and total count.

### `context 'when searching for /de/ term'`
#### Description
Tests the search functionality of the query.

#### Internal Logic
- Sets a search term 'de'.
- Verifies that only coupons with names or codes containing 'de' are returned.

### `context 'when filtering by terminated status'`
#### Description
Tests the filtering functionality of the query.

#### Internal Logic
- Sets a filter for 'terminated' status.
- Checks that only coupons with 'terminated' status are returned.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| rails_helper | Loads Rails testing environment and configuration |
| FactoryBot | Used for creating test data |
| RSpec | Testing framework used for writing and running tests |

Note: The `rails_helper` file includes additional configurations and dependencies for the entire test suite, including SimpleCov for code coverage, DatabaseCleaner, and various custom helpers.