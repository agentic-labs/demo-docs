---
title: "20221128132620_change_fees_boundaries.rb"
---

## High-level description
This migration file changes the boundaries of fees in the database. It updates the `properties` column of the `fees` table, converting date-based fields to datetime-based fields and adjusting the end times to be inclusive of the entire day.

## Symbols

### `ChangeFeesBoundaries`
#### Description
This is a Rails migration class that inherits from `ActiveRecord::Migration[7.0]`. It defines a change to be applied to the database schema.

#### Internal Logic
The migration uses a reversible block with an `up` direction, indicating that this change is only defined for migrating forward. Inside the `up` block, it executes a SQL statement to update the `fees` table.

The SQL statement does the following:
1. Updates the `properties` column, which is assumed to be a JSON or JSONB type.
2. Converts `from_date` to `from_datetime` without changing the time.
3. Converts `to_date` to `to_datetime`, setting the time to the end of the day (23:59:59.999).
4. Conditionally converts `charges_from_date` to `charges_from_datetime` if it exists.
5. Conditionally converts `charges_to_date` to `charges_to_datetime` if it exists, setting the time to the end of the day.
6. The update is only applied to rows where `properties` contains a `from_date` key.

#### Performance Considerations
This migration performs a bulk update on the `fees` table, which could be slow for large datasets. The `safety_assured` block suggests that this migration might be run using the `strong_migrations` gem, which typically warns against such operations but allows them when explicitly marked as safe.

## Side Effects
This migration will modify the `properties` column of all rows in the `fees` table that have a `from_date` property. It changes the structure of the JSON data stored in this column, which may affect any code that relies on the previous date-based format.

## Error Handling
There is no explicit error handling in this migration. If an error occurs during the SQL execution, it will likely cause the migration to fail and roll back.

## TODOs
The migration does not include a `down` method for reverting the changes. This might be intentional if the change is not meant to be reversible, but it's worth noting as a potential area for improvement.