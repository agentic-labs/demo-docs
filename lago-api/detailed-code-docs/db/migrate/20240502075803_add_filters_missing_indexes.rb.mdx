---
title: "20240502075803_add_filters_missing_indexes.rb"
---

## High-level description
This migration adds missing indexes to improve query performance for active (non-deleted) records in the `charge_filters`, `charge_filter_values`, and `billable_metric_filters` tables. It specifically targets the foreign key columns and includes a condition to exclude soft-deleted records.

## Symbols

### AddFiltersMissingIndexes
#### Description
This class is an ActiveRecord migration that adds three partial indexes to different tables in the database. It inherits from `ActiveRecord::Migration[7.0]`, indicating it's compatible with Rails 7.0.

#### Internal Logic
1. Disables DDL transactions for this migration using `disable_ddl_transaction!`.
2. Defines a `change` method that wraps the index creation in a `safety_assured` block.
3. Creates three partial indexes using `add_index`:
   - On `charge_filters.charge_id`
   - On `charge_filter_values.charge_filter_id`
   - On `billable_metric_filters.billable_metric_id`
   Each index is created only for records where `deleted_at IS NULL`.

## Side Effects
This migration will create new indexes in the database, which may temporarily lock the affected tables during the index creation process. However, the use of `disable_ddl_transaction!` allows the database to release locks between each index creation, minimizing the impact on concurrent operations.

## Performance Considerations
The added indexes are designed to improve query performance for active records in the respective tables. By including the `where` clause, the indexes will be smaller and more efficient than full indexes on these columns, as they only include non-deleted records.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| ActiveRecord::Migration | Provides the framework for database migrations in Rails |

## Error Handling
The migration uses `safety_assured` to bypass Strong Migrations checks. This indicates that the migration has been manually reviewed and deemed safe to run, even though it might normally trigger warnings from the Strong Migrations gem.

## TODOs
There are no explicit TODOs in this migration file.