---
title: "20221107151038_add_vat_rates_to_credit_note.rb"
---

## High-level description
This migration adds VAT (Value Added Tax) rate-related columns to the `credit_notes` table in a Ruby on Rails application. It introduces fields for credit VAT amount, refund VAT amount, and overall VAT amount, each with corresponding currency fields.

## Symbols

### `AddVatRatesToCreditNote`
#### Description
This class is a Rails migration that extends the `credit_notes` table with new columns related to VAT rates. It inherits from `ActiveRecord::Migration[7.0]`, indicating it's compatible with Rails 7.0.

#### Internal Logic
The migration uses the `change` method to define the changes to be applied to the database. It employs the `safety_assured` block, which is likely a custom method to bypass certain safety checks during the migration process.

Inside the `change_table` block, six new columns are added to the `credit_notes` table:

1. `credit_vat_amount_cents`: A `bigint` column to store the credit VAT amount in cents.
2. `credit_vat_amount_currency`: A `string` column to store the currency of the credit VAT amount.
3. `refund_vat_amount_cents`: A `bigint` column to store the refund VAT amount in cents.
4. `refund_vat_amount_currency`: A `string` column to store the currency of the refund VAT amount.
5. `vat_amount_cents`: A `bigint` column to store the overall VAT amount in cents.
6. `vat_amount_currency`: A `string` column to store the currency of the overall VAT amount.

The `_cents` columns are set with a default value of 0 and are not nullable, ensuring that they always have a value. The currency columns don't have default values and are nullable.

## Performance Considerations
The migration uses `bulk: true` in the `change_table` call, which can improve performance by combining multiple ALTER TABLE statements into a single operation, reducing the time required for the migration to complete.

## Dependencies
This migration relies on the ActiveRecord framework, which is part of Ruby on Rails.

## Configuration
The migration is configured to work with Rails version 7.0, as indicated by `ActiveRecord::Migration[7.0]`.

## Error Handling
No explicit error handling is implemented in this migration. It relies on the default error handling provided by ActiveRecord migrations.