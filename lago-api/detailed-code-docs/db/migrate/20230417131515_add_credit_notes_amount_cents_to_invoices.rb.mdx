---
title: "20230417131515_add_credit_notes_amount_cents_to_invoices.rb"
---

## High-level description
This migration adds a new column `credit_notes_amount_cents` to the `invoices` table and populates it with the sum of credit note amounts associated with each invoice. The migration is designed to be reversible and uses a safety assurance mechanism.

## Symbols

### `AddCreditNotesAmountCentsToInvoices`
#### Description
This class is an ActiveRecord migration that adds a new column to the `invoices` table and populates it with data from related credit notes.

#### Internal Logic
1. Adds a new column `credit_notes_amount_cents` to the `invoices` table.
2. Uses a `safety_assured` block to indicate that the migration has been reviewed for safety.
3. Implements a reversible migration using the `reversible` method.
4. In the `up` direction, executes a SQL query to:
   a. Calculate the sum of `amount_cents` for credit notes associated with each invoice.
   b. Update the `credit_notes_amount_cents` column in the `invoices` table with the calculated sums.

## Side Effects
- Modifies the `invoices` table schema by adding a new column.
- Updates existing records in the `invoices` table with calculated credit note amounts.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| ActiveRecord::Migration | Provides the migration framework for database schema changes |

## Error Handling
The migration uses `safety_assured` to bypass Strong Migrations checks, indicating that the migration has been manually reviewed for safety.

## SQL Query Explanation
The SQL query used in the `up` direction performs the following steps:
1. Creates a CTE (Common Table Expression) named `credit_notes_total` that:
   - Selects `invoice_id` and calculates the sum of `amount_cents` from the `credits` table.
   - Only includes credits with a non-null `credit_note_id`.
   - Groups the results by `invoice_id`.
2. Updates the `invoices` table by:
   - Setting the `credit_notes_amount_cents` column to the calculated sum from the CTE.
   - Joining the `invoices` table with the CTE based on matching `id` and `invoice_id`.

This approach efficiently calculates and updates the credit note amounts for all invoices in a single query.