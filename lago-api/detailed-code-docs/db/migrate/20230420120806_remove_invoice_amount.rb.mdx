---
title: "20230420120806_remove_invoice_amount.rb"
---

## High-level description
This migration removes the `amount_cents` column from the `invoices` table. It provides methods for both removing the column (`up`) and adding it back with calculated values (`down`), ensuring reversibility of the migration.

## Symbols

### `RemoveInvoiceAmount`
#### Description
This class is an ActiveRecord migration that removes the `amount_cents` column from the `invoices` table and provides a way to revert this change if needed.

#### Internal Logic
The migration consists of two main methods:

1. `up`: Removes the `amount_cents` column from the `invoices` table.
2. `down`: Adds the `amount_cents` column back to the `invoices` table and populates it with calculated values from the `fees` table.

### `up`
#### Description
This method removes the `amount_cents` column from the `invoices` table.

#### Internal Logic
The method uses `safety_assured` to bypass Strong Migrations checks, indicating that the developer has considered the implications of this potentially dangerous operation. It then calls `remove_column` to remove the `amount_cents` column from the `invoices` table.

### `down`
#### Description
This method adds the `amount_cents` column back to the `invoices` table and populates it with calculated values from the `fees` table.

#### Internal Logic
1. Adds the `amount_cents` column to the `invoices` table as a `bigint` with a default value of 0.
2. Executes a SQL statement to update the `amount_cents` column with calculated values:
   - Creates a CTE (Common Table Expression) named `fee_amount` that calculates the sum of `amount_cents` for each `invoice_id` from the `fees` table.
   - Updates the `invoices` table, setting the `amount_cents` column to the calculated sum from the `fee_amount` CTE.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| ActiveRecord::Migration | Provides the migration framework for database schema changes |

## Performance Considerations
The `down` method involves a potentially expensive operation, as it performs a sum calculation across the `fees` table and updates the `invoices` table. This operation may be slow on large datasets and should be monitored for performance impact if executed on a production database.

## Error Handling
This migration does not implement explicit error handling. It relies on the default error handling provided by ActiveRecord migrations.

## Side Effects
- Removing the `amount_cents` column from the `invoices` table will permanently delete this data unless it's backed up elsewhere.
- Any code or queries that previously relied on the `amount_cents` column in the `invoices` table will need to be updated to reflect this change.