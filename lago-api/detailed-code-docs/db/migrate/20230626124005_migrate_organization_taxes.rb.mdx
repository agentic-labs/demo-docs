---
title: "20230626124005_migrate_organization_taxes.rb"
---

## High-level description
This migration file, `MigrateOrganizationTaxes`, is designed to migrate tax-related data from various models (Organization, Customer, Fee, Invoice, and CreditNote) to a new Tax model and its associated join tables. It creates new Tax records and establishes relationships between these taxes and the relevant entities.

## Code Structure
The migration defines several ActiveRecord models at the top to prevent schema issues. The main logic is contained within a reversible `change` method, which includes an `up` block for the migration process. The migration is divided into sections, each handling a specific aspect of the tax data migration.

## Symbols

### `MigrateOrganizationTaxes`
#### Description
This is the main migration class that inherits from `ActiveRecord::Migration[7.0]`. It contains the logic for migrating tax data from various models to the new Tax model and associated join tables.

#### Internal Logic
1. Migrate organization taxes
2. Migrate customer taxes
3. Migrate fees taxes
4. Migrate invoices taxes
5. Migrate credit notes taxes

For each migration step, the code follows a similar pattern:
- Query the relevant data
- Create Tax records if they don't exist
- Create join table records (e.g., CustomersTax, FeesTax, etc.) to associate the new Tax records with the original entities

### `change`
#### Description
This method contains the reversible migration logic, with an `up` block that performs the actual migration.

#### Internal Logic
1. Migrate organization taxes:
   - Create Tax records for organizations with a positive VAT rate
2. Migrate customer taxes:
   - Create Tax records for customers with a VAT rate
   - Create CustomersTax join records
3. Migrate fees taxes:
   - Use a complex SQL query to fetch relevant fee data
   - Create Tax records for each unique organization and tax rate combination
   - Create FeesTax join records
4. Migrate invoices taxes:
   - Use a complex SQL query to fetch relevant invoice data
   - Create Tax records for each unique organization and tax rate combination
   - Create InvoicesTax join records
5. Migrate credit notes taxes:
   - Use a complex SQL query to fetch relevant credit note data
   - Create Tax records for each unique organization and tax rate combination
   - Create CreditNotesTax join records

## Side Effects
This migration creates new records in the `taxes` table and various join tables (`customers_taxes`, `fees_taxes`, `invoices_taxes`, and `credit_notes_taxes`). It does not modify or delete existing data.

## Performance Considerations
The migration uses `find_each` for iterating over large collections of records, which is more memory-efficient than loading all records at once. For complex queries, it uses raw SQL to optimize performance. The migration also uses indexing to group and process data efficiently.

## Dependencies
This migration depends on the existence of several models and their associated tables: Organization, Tax, Customer, CustomersTax, FeesTax, InvoicesTax, and CreditNotesTax.

## Error Handling
The migration does not implement explicit error handling. It relies on Rails' default behavior for handling errors during migrations.

## Logging
The migration does not implement any custom logging. It relies on Rails' default migration logging.

## TODOs
There is a commented-out condition in the fees taxes SQL query:
```sql
--HAVING COUNT(fees_taxes.id) = 0
```
This might be intentional, but it's worth noting for future reference or potential optimization.