---
title: "20230221070501_create_customer_metadata.rb"
---

## High-level description
This migration file creates a new table called `customer_metadata` in the database. It establishes a relationship between customers and their associated metadata, allowing for the storage of key-value pairs with additional attributes such as visibility on invoices.

## Code Structure
The code defines a single class `CreateCustomerMetadata` that inherits from `ActiveRecord::Migration[7.0]`. This class contains a `change` method that specifies the structure of the new table.

## Symbols

### CreateCustomerMetadata
#### Description
This class is an ActiveRecord migration that defines the structure for the `customer_metadata` table. It creates the table with specific columns and indexes to store metadata associated with customers.

#### Internal Logic
The `change` method uses the `create_table` method to define the structure of the `customer_metadata` table:

1. Creates a table named `customer_metadata` with UUID as the primary key.
2. Adds a foreign key reference to the `customers` table.
3. Defines columns for `key`, `value`, and `display_in_invoice`.
4. Adds timestamps for record creation and update times.
5. Creates a unique composite index on `customer_id` and `key`.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| ActiveRecord | Provides the migration framework and database abstraction |

## API/Interface Reference
| Column | Type | Constraints | Description |
|:-------|:-----|:------------|:------------|
| id | uuid | primary key | Unique identifier for each metadata record |
| customer_id | uuid | foreign key, not null | References the associated customer |
| key | string | not null | The metadata key |
| value | string | not null | The metadata value |
| display_in_invoice | boolean | default: false, not null | Indicates if the metadata should be displayed on invoices |
| created_at | datetime | not null | Timestamp of record creation |
| updated_at | datetime | not null | Timestamp of last record update |

Indexes:
- `index_customer_metadata_on_customer_id`: Improves lookup performance for customer-related queries
- `index_customer_metadata_on_customer_id_and_key`: Ensures uniqueness of key per customer and improves lookup performance

This migration creates a flexible structure for storing customer-specific metadata, with the ability to control its visibility on invoices and ensure uniqueness of keys per customer.