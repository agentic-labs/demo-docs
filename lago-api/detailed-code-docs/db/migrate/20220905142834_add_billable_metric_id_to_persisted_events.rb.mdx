---
title: "20220905142834_add_billable_metric_id_to_persisted_events.rb"
---

## High-level description
This migration adds a `billable_metric_id` column to the `persisted_events` table and updates the indexing strategy. It's designed to associate persisted events with billable metrics and optimize the search functionality for these events.

## Symbols

### `AddBillableMetricIdToPersistedEvents`
#### Description
This is a Rails migration class that inherits from `ActiveRecord::Migration[7.0]`. It defines changes to be applied to the database schema, specifically for the `persisted_events` table.

#### Internal Logic
The migration performs the following steps:
1. Adds a new column `billable_metric_id` of type UUID to the `persisted_events` table.
2. Removes an existing index named `index_search_persisted_events`.
3. Creates a new composite index on `customer_id`, `external_subscription_id`, and `billable_metric_id` columns.

### `change`
#### Description
This method defines the changes to be applied to the database schema. It uses the `safety_assured` block, which is likely a custom method to bypass certain safety checks during migration.

#### Internal Logic
1. Adds a reference column:
   ```ruby
   add_reference :persisted_events, :billable_metric, type: :uuid
   ```
   This adds a `billable_metric_id` column of type UUID to the `persisted_events` table.

2. Removes an existing index:
   ```ruby
   remove_index :persisted_events, name: :index_search_persisted_events
   ```
   This drops the existing index named `index_search_persisted_events`.

3. Adds a new composite index:
   ```ruby
   add_index :persisted_events,
     [:customer_id, :external_subscription_id, :billable_metric_id],
     name: :index_search_persisted_events
   ```
   This creates a new index on the combination of `customer_id`, `external_subscription_id`, and `billable_metric_id` columns.

## Side Effects
- Adds a new column `billable_metric_id` to the `persisted_events` table.
- Removes an existing index on the `persisted_events` table.
- Adds a new composite index on the `persisted_events` table.

## Performance Considerations
The new composite index on `customer_id`, `external_subscription_id`, and `billable_metric_id` is likely to improve query performance for searches involving these fields. However, the removal of the old index might affect existing queries that relied on it.

## TODOs
The code includes a `rubocop:disable Rails/ReversibleMigration` comment, indicating that this migration is not easily reversible. In a production environment, it's generally recommended to write reversible migrations. This could be addressed in future refactoring.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| ActiveRecord::Migration | Provides the framework for defining database schema changes |

## Error Handling
This migration does not implement any specific error handling. If any step fails, the entire migration will be rolled back by default Rails behavior.