---
title: "20240801134833_add_index_on_payment_requests_payable_id_and_payable_type.rb"
---

## High-level description
This migration file adds two non-blocking indexes to improve query performance on the `payment_requests` and `payments` tables in a Rails application. It specifically targets the polymorphic association columns in `payment_requests` and the foreign key in `payments`.

## Symbols

### `AddIndexOnPaymentRequestsPayableIdAndPayableType`
#### Description
This class is a Rails migration that adds two indexes to improve database performance for queries related to payment requests and payments.

#### Internal Logic
1. Disables DDL transactions for this migration to allow concurrent index creation.
2. Adds a composite index on `payment_requestable_type` and `payment_requestable_id` columns of the `payment_requests` table.
3. Adds an index on the `payment_request_id` column of the `payments` table.
4. Both indexes are created concurrently and only if they don't already exist.

## Side Effects
- Improves query performance for lookups on the indexed columns.
- Slightly increases database size due to the addition of indexes.
- May temporarily increase database load during index creation, but impact is minimized by using concurrent creation.

## Performance Considerations
- The `algorithm: :concurrently` option ensures that the indexes are created without blocking reads and writes on the affected tables.
- The `if_not_exists: true` option prevents errors if the indexes already exist, making the migration idempotent.
- Adding these indexes can significantly improve query performance for operations involving joins or lookups on the indexed columns, especially for large tables.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| ActiveRecord::Migration | Provides the migration framework for database schema changes |

## Error Handling
The migration uses `if_not_exists: true` to gracefully handle situations where the indexes might already exist, preventing potential errors during repeated migrations.

## Notes
- The migration class name suggests it's adding an index on `payable_id` and `payable_type`, but the actual implementation uses `payment_requestable_type` and `payment_requestable_id`. This discrepancy in naming might be confusing and should be addressed for clarity.
- The `disable_ddl_transaction!` call is crucial for allowing concurrent index creation, which is a best practice for adding indexes to tables that may contain a large amount of data or are frequently accessed.