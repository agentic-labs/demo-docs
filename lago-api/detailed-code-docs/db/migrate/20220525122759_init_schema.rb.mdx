---
title: "20220525122759_init_schema.rb"
---

## High-level description
This code defines an ActiveRecord migration that initializes the database schema for a billing and subscription management system. It creates multiple tables to handle various aspects of the system, including add-ons, coupons, billable metrics, charges, customers, events, invoices, and subscriptions.

## Code Structure
The code is structured as a single ActiveRecord migration class named `InitSchema`. It contains a `change` method that uses the `safety_assured` block to create tables and define their structures, indexes, and foreign key relationships.

## Symbols

### InitSchema
#### Description
This class is an ActiveRecord migration that sets up the initial database schema for the billing and subscription management system.

#### Internal Logic
1. Enables the 'pgcrypto' PostgreSQL extension for UUID generation.
2. Creates multiple tables with their respective columns, indexes, and foreign key relationships.
3. Uses UUID as the primary key for most tables.
4. Sets up indexes for efficient querying.
5. Establishes foreign key relationships between tables.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| ActiveRecord::Migration | Provides the framework for database migrations |
| pgcrypto | PostgreSQL extension for UUID generation |

## Tables Created
1. `add_ons`
2. `applied_coupons`
3. `billable_metrics`
4. `charges`
5. `coupons`
6. `credits`
7. `customers`
8. `events`
9. `fees`
10. `invoices`
11. `memberships`
12. `organizations`
13. `plans`
14. `subscriptions`
15. `users`

Each table is created with specific columns, indexes, and foreign key relationships relevant to its purpose in the billing and subscription management system.

## Notable Features
1. Use of UUID as primary keys for most tables.
2. Extensive use of indexes for performance optimization.
3. Monetary amounts are stored as cents in bigint columns with separate currency columns.
4. Timestamps (created_at, updated_at) are included in most tables.
5. Use of jsonb columns for storing properties in some tables (e.g., events, charges).
6. Implementation of soft delete patterns with columns like `terminated_at` and `canceled_at`.

This migration sets up a comprehensive schema for a complex billing and subscription system, with attention to performance, data integrity, and flexibility for handling various billing scenarios.