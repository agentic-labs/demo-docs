---
title: "20240705080709_create_events_enriched.rb"
---

## High-level description
This code defines a database migration for creating a table named `events_enriched` in ClickHouse. The migration uses ActiveRecord's migration framework to define the table structure with specific columns and options, including a ReplacingMergeTree engine with a custom order.

## Symbols

### `CreateEventsEnriched`
#### Description
This class is a database migration that inherits from `ActiveRecord::Migration[7.1]`. It defines the structure for the `events_enriched` table in ClickHouse.

#### Internal Logic
The migration uses the `change` method to define the table creation:

1. It sets up the table options using a heredoc SQL string, specifying the ReplacingMergeTree engine and the ORDER BY clause.
2. It calls `create_table` with the name `:events_enriched`, setting `id: false` to prevent the automatic creation of an ID column, and passing the options defined earlier.
3. Within the `create_table` block, it defines the columns for the table using various data types and constraints.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| ActiveRecord | Provides the migration framework and database abstraction |

## Configuration
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| ReplacingMergeTree | ClickHouse engine | N/A | Specifies the table engine for efficient data replacement and merging |

## Symbols

### `change`
#### Description
This method defines the changes to be applied to the database schema, specifically creating the `events_enriched` table.

#### Internal Logic
1. Defines the table options using a SQL string that specifies the ReplacingMergeTree engine and ORDER BY clause.
2. Creates the `events_enriched` table with the following columns:
   - `organization_id`: string, not null
   - `external_subscription_id`: string, not null
   - `code`: string, not null
   - `timestamp`: datetime with 3-digit precision, not null
   - `transaction_id`: string, not null
   - `properties`: string, map type, not null
   - `value`: string
   - `charge_id`: string, not null
   - `aggregation_type`: string
   - `filters`: string, array of maps, not null
   - `grouped_by`: string, map type, not null

The table is created without an ID column, and the ORDER BY clause is set to use `organization_id`, `external_subscription_id`, `code`, `charge_id`, and `transaction_id`.

## Performance Considerations
The use of the ReplacingMergeTree engine and the specified ORDER BY clause are important for the performance of this table in ClickHouse. This engine allows for efficient data replacement and merging, which can be beneficial for updating and querying events data.