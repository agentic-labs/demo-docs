---
title: "20240709135506_create_events_max_agg.rb"
---

## High-level description
This migration file creates a new table called `events_max_agg` in ClickHouse database. The table is designed to store aggregated event data with a maximum value aggregation function, using an AggregatingMergeTree engine for efficient data storage and retrieval.

## Symbols

### `CreateEventsMaxAgg`
#### Description
This class is a migration that inherits from `ActiveRecord::Migration[7.1]`. It defines the structure and properties of the `events_max_agg` table in ClickHouse.

#### Internal Logic
The migration performs the following steps:
1. Defines the table options, specifying the AggregatingMergeTree engine and the primary key.
2. Creates the `events_max_agg` table with various columns.
3. Adds a special `value` column using the `AggregateFunction(max, Decimal(38, 26))` type.

### `change`
#### Description
This method defines the changes to be applied to the database schema. It creates the `events_max_agg` table and adds its columns.

#### Internal Logic
1. Sets up the table options with the AggregatingMergeTree engine and primary key.
2. Creates the `events_max_agg` table with the following columns:
   - `organization_id` (string, not null)
   - `external_subscription_id` (string, not null)
   - `code` (string, not null)
   - `charge_id` (string, not null)
   - `timestamp` (datetime with 3 decimal places precision, not null)
   - `filters` (string array mapped as a ClickHouse array, not null)
   - `grouped_by` (string mapped as a ClickHouse map, not null)
3. Adds the `value` column with a special ClickHouse type `AggregateFunction(max, Decimal(38, 26))`, which is used for storing the maximum value aggregation.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| ActiveRecord::Migration | Provides the migration framework for database schema changes |

## Configuration
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| `options` | SQL string | N/A | Defines the table engine (AggregatingMergeTree) and primary key for the `events_max_agg` table |

## Performance Considerations
The use of the AggregatingMergeTree engine in ClickHouse is optimized for aggregating data efficiently. The primary key definition (`organization_id, external_subscription_id, code, charge_id, timestamp, filters, grouped_by`) is crucial for query performance and data organization within the table.

## TODOs
The code includes a `rubocop:disable Rails/NotNullColumn` comment, indicating that there might be a need to review the `null: false` constraint on the `value` column in the future or justify its usage.