---
title: "past_usage_query.rb"
---

## High-level description
The `PastUsageQuery` class is responsible for retrieving past usage data for a specific customer and subscription. It queries invoice subscriptions, applies filters, and returns usage periods with associated fees. The class also handles pagination of the results.

## Code Structure
The main method `call` orchestrates the query process, while private methods handle specific tasks such as querying, validating filters, and retrieving billable metrics. The class inherits from `BaseQuery`, which provides common functionality for queries.

## Symbols

### `PastUsageQuery#call`
#### Description
This method executes the main query logic, validates filters, and prepares the result with usage periods and pagination information.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | OpenStruct | Contains usage periods and pagination details |

#### Internal Logic
1. Validates filters
2. Executes the main query
3. Maps query results to usage periods with associated fees
4. Adds pagination attributes if pagination is enabled
5. Returns the result

### `PastUsageQuery#query` (private)
#### Description
Constructs and executes the base query for retrieving invoice subscriptions.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| base_query | ActiveRecord::Relation | Filtered and paginated query result |

#### Internal Logic
1. Builds the base query using InvoiceSubscription model
2. Applies filters for customer, subscription, and organization
3. Orders results by charges_from_datetime in descending order
4. Includes invoice association
5. Applies pagination
6. Limits results if periods_count filter is present

### `PastUsageQuery#fees_query(invoice)` (private)
#### Description
Retrieves fees associated with a given invoice, optionally filtered by billable metric.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| invoice | Invoice | The invoice to query fees for |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| query | ActiveRecord::Relation | Filtered fees query result |

### `PastUsageQuery#validate_filters` (private)
#### Description
Validates the presence of required filters and the existence of the billable metric if specified.

#### Internal Logic
1. Checks for presence of external_customer_id and external_subscription_id
2. Validates billable_metric_code if present

### `PastUsageQuery#billable_metric` (private)
#### Description
Retrieves the billable metric associated with the given code for the organization.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| billable_metric | BillableMetric | The found billable metric or nil |

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| BaseQuery | Parent class providing common query functionality |

## Error Handling
The class uses the `result` object to handle validation errors, setting appropriate error messages and codes.

Your response should not exceed 3000 words or 4000 tokens. Focus on providing clear, concise information that can be directly inferred from the code. Include optional sections only when they provide significant value for understanding the code.