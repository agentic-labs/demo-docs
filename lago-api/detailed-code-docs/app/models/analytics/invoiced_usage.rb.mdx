---
title: "invoiced_usage.rb"
---

## High-level description
The `Analytics::InvoicedUsage` module defines an abstract class for querying and caching invoiced usage data for an organization. It provides a `query` method to fetch usage data based on specified filters and a `cache_key` method to generate a unique cache key for the query.

## Code Structure
The `Analytics::InvoicedUsage` class uses a class method `query` to build and execute a SQL query. The `query` method dynamically constructs the query based on optional arguments like `months` and `currency`. The `cache_key` method is used to generate a unique key for caching the results of the query.

## References
This class references the following database tables:
- `organizations`
- `fees`
- `invoices`
- `subscriptions`
- `customers`
- `charges`
- `billable_metrics`

## Symbols

### `Analytics::InvoicedUsage`
#### Description
An abstract class that provides methods for querying and caching invoiced usage data for an organization.

#### Inputs
This class doesn't accept any direct inputs.

#### Outputs
This class doesn't return any direct outputs.

#### Internal Logic
This class defines two class methods:

- `query(organization_id, **args)`: This method constructs and executes a SQL query to fetch invoiced usage data for the given organization ID and optional filters. The filters include:
    - `months`: Number of months to retrieve data for.
    - `currency`: Currency to filter the data by.
- `cache_key(organization_id, **args)`: This method generates a unique cache key based on the organization ID, current date, and provided arguments.

## Side Effects
This class doesn't have any direct side effects. The `query` method interacts with the database to fetch data.

## Dependencies
This class depends on the following:
| Dependency | Purpose |
|:-----------|:--------|
| `ActiveRecord::Base` | Provides database interaction methods. |
| `License` | Used to check for premium license. |

## Error Handling
This class doesn't implement specific error handling.

## Logging
This class doesn't implement logging.
