---
title: "mrr.rb"
---

## High-level description
The `Analytics::Mrr` module defines a method `query` that generates a SQL query to calculate the Monthly Recurring Revenue (MRR) for a given organization. It takes into account various factors like invoice details, plan intervals, payment schedules, and currency to provide an accurate MRR breakdown over time.

## Code Structure
The `Analytics::Mrr` module defines a class method `query` that constructs a complex SQL query. This query utilizes several CTEs (Common Table Expressions) to break down the calculation into smaller, more manageable steps. The CTEs include `organization_creation_date`, `all_months`, `invoice_details`, `quarterly_advance`, `quarterly_arrears`, `yearly_advance`, `yearly_arrears`, `monthly`, `weekly`, and `consolidated_mrr`. Each CTE serves a specific purpose in preparing and aggregating data for the final MRR calculation.

## References
- This code references the `sanitize_sql` method, which is likely a helper method to sanitize SQL queries and prevent SQL injection vulnerabilities.
- It also references several database tables like `organizations`, `fees`, `invoices`, `customers`, `subscriptions`, and `plans`.

## Symbols

### `Analytics::Mrr`
#### Description
This module encapsulates the logic for calculating Monthly Recurring Revenue (MRR) for a given organization.

#### Inputs
This module doesn't accept direct inputs. The inputs are handled by the `query` class method.

#### Outputs
This module doesn't directly return any outputs. The output is generated by the `query` class method.

### `Analytics::Mrr.query`
#### Description
This class method constructs and returns a SQL query to calculate the MRR for a given organization. It takes into account various factors like invoice details, plan intervals, payment schedules, and currency to provide an accurate MRR breakdown over time.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| organization_id | Integer | The ID of the organization for which to calculate MRR. |
| **args | Hash | Optional arguments for filtering the MRR calculation. |

The `args` hash accepts the following optional keys:
- `months`: The number of months for which to calculate MRR.
- `currency`: The currency in which to calculate MRR.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| sql | String | A sanitized SQL query string that can be executed to retrieve the MRR data. |

#### Internal Logic
The `query` method constructs a complex SQL query using several CTEs (Common Table Expressions). Here's a breakdown of the key steps:

1. **Organization Creation Date:** The `organization_creation_date` CTE retrieves the month and year of the organization's creation date.
2. **All Months:** The `all_months` CTE generates a series of months from the organization's creation date to 10 years into the future.
3. **Invoice Details:** The `invoice_details` CTE retrieves relevant information from invoices, fees, customers, subscriptions, and plans for the given organization. It calculates the billed months based on the invoice period and extracts data related to payment schedules and plan intervals.
4. **Quarterly/Yearly Advance/Arrears:** The `quarterly_advance`, `quarterly_arrears`, `yearly_advance`, and `yearly_arrears` CTEs calculate the MRR for invoices with quarterly and yearly billing cycles, considering both pay-in-advance and arrears payment methods.
5. **Monthly/Weekly:** The `monthly` and `weekly` CTEs calculate the MRR for invoices with monthly and weekly billing cycles.
6. **Consolidated MRR:** The `consolidated_mrr` CTE combines the MRR data from all the previous CTEs.
7. **Final Query:** The final part of the query joins the `all_months` CTE with the `consolidated_mrr` CTE to retrieve the MRR for each month. It applies optional filters based on the provided `months` and `currency` arguments.

### `Analytics::Mrr.cache_key`
#### Description
This class method generates a cache key for the MRR data based on the provided parameters.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| organization_id | Integer | The ID of the organization. |
| **args | Hash | Optional arguments for filtering the MRR calculation. |

The `args` hash accepts the same optional keys as the `query` method: `months` and `currency`.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| cache_key | String | A string representing the cache key for the MRR data. |

## Side Effects
This code doesn't have any direct side effects as it only constructs and returns a SQL query string. The actual execution of the query and any subsequent data manipulation are handled elsewhere.

## Dependencies
- This code depends on the `sanitize_sql` method, which is assumed to be a helper method for sanitizing SQL queries.
- It also depends on the database connection and schema for accessing the required tables like `organizations`, `fees`, `invoices`, `customers`, `subscriptions`, and `plans`.

## Error Handling
This code doesn't implement any specific error handling mechanisms. It assumes that the database connection and schema are valid and that the provided input parameters are correct. Any errors encountered during query execution will be handled by the calling code.
