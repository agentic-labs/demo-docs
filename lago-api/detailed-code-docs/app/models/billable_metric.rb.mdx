---
title: "billable_metric.rb"
---

## High-level description
This code defines the `BillableMetric` model, which represents a metric used for billing purposes in a subscription-based system. It includes various associations, validations, and methods for managing billable metrics, their aggregation types, and related functionality.

## Code Structure
The `BillableMetric` class inherits from `ApplicationRecord` and includes several modules for additional functionality. It has associations with other models such as `Organization`, `Charge`, `Plan`, `Coupon`, `Group`, and `Filter`. The class defines constants for aggregation types and intervals, and includes various validations and scopes.

## Symbols

### `BillableMetric` (class)
#### Description
Represents a billable metric in the system, used for calculating charges based on various aggregation types.

#### Inputs
N/A (This is a model class)

#### Outputs
N/A (This is a model class)

#### Internal Logic
- Defines associations with other models
- Sets up validations for various attributes
- Defines scopes and enums for aggregation types and intervals
- Implements methods for checking if the metric is attached to subscriptions and if it's payable in advance

### `AGGREGATION_TYPES` (constant)
#### Description
Defines the available aggregation types for billable metrics.

### `AGGREGATION_TYPES_PAYABLE_IN_ADVANCE` (constant)
#### Description
Specifies which aggregation types are payable in advance.

### `WEIGHTED_INTERVAL` (constant)
#### Description
Defines the interval types for weighted sum aggregation.

### `attached_to_subscriptions?` (method)
#### Description
Checks if the billable metric is attached to any active subscriptions.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | Boolean | True if attached to subscriptions, false otherwise |

### `aggregation_type=` (method)
#### Description
Custom setter for the aggregation_type attribute, ensuring only valid types are set.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| value | String/Symbol | The aggregation type to set |

### `payable_in_advance?` (method)
#### Description
Checks if the billable metric's aggregation type is payable in advance.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | Boolean | True if payable in advance, false otherwise |

## Side Effects
The model interacts with the database to persist and retrieve billable metric data.

## Dependencies
- PaperTrailTraceable
- Discard::Model
- IntegrationMappable

This model is a crucial part of the billing system, defining how different metrics are aggregated and used for charging customers in a subscription-based model.