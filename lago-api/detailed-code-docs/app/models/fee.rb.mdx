---
title: "fee.rb"
---

## High-level description
The `Fee` model represents a single charge within the billing system, linked to various billing entities like invoices, subscriptions, or add-ons. It handles different fee types, payment statuses, and provides methods for calculating amounts, managing taxes, and accessing related billing information.

## Code Structure
The `Fee` model has several key relationships:
- It `belongs_to` an `Invoice`, indicating the invoice this fee is associated with.
- It `belongs_to` a `Charge`, representing the specific charge that generated this fee.
- It `belongs_to` an `AddOn`, linking the fee to an optional add-on purchase.
- It `belongs_to` a `Subscription`, connecting the fee to a recurring subscription.
- It `has_many` `CreditNoteItems`, allowing for the application of credit notes to the fee.

The model also defines several scopes for querying fees based on type, status, and associated entities. It includes methods for calculating the total amount, creditable amount, and refundable amount, taking into account taxes and credit notes.

## References
- `Currencies` concern: Provides currency-related methods and constants.
- `Discard::Model` concern: Enables soft-deletion functionality.
- `Fee::AppliedTax` model: Represents taxes applied to the fee.
- `CreditNoteItem` model: Represents an item within a credit note applied to the fee.

## Symbols

### `Fee`
#### Description
Represents a single fee in the billing system. It can be associated with an invoice, a charge, an add-on, or a subscription.

#### Inputs
This section is not applicable to the `Fee` model as it doesn't have a dedicated constructor with defined inputs.

#### Outputs
This section is not applicable to the `Fee` model as it primarily defines data structure and relationships.

#### Internal Logic
The `Fee` model defines several methods for:
- Determining the associated item ID, type, code, name, and description based on the fee type.
- Retrieving the invoice name based on the associated entity.
- Calculating the sub-total, total amount, and creditable amount, considering taxes and credit notes.
- Accessing the associated `AddOn` record, handling both direct and indirect relationships.
- Checking for the presence of charge filters.

## Side Effects
This section is not applicable to the `Fee` model as it doesn't have methods with significant side effects beyond data persistence.

#### Performance Considerations
This section is not applicable to the `Fee` model as it doesn't contain performance-critical code.

## Dependencies
- `Currencies` concern
- `Discard::Model` concern

## Configuration
This section is not applicable to the `Fee` model as it doesn't define any configuration options.

## Error Handling
This section is not applicable to the `Fee` model as error handling is primarily handled through validations and database constraints.

## Logging
This section is not applicable to the `Fee` model as it doesn't implement any specific logging mechanisms.

## API/Interface Reference
This section is not applicable to the `Fee` model as it doesn't expose a public API.

## TODOs
- Deprecate `add_on` type in the near future.
