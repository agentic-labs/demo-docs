---
title: "Overview"
---

## High-level description
This directory contains services related to credit management in a billing system. The services handle various aspects of applying credits, coupons, and prepaid amounts to invoices, as well as managing credit notes and progressive billing.

## What does it do?
The services in this directory work together to manage different types of credits and discounts applied to customer invoices:

1. Apply coupons to invoices, calculating discounts based on coupon types (percentage or fixed amount) and limitations.
2. Apply prepaid credits from customer wallets to reduce invoice amounts.
3. Apply credit notes to invoices, reducing the invoice amount and updating credit note balances.
4. Handle progressive billing credits, adjusting invoice amounts based on previously issued progressive billing invoices.

These services ensure that various types of credits and discounts are correctly applied to invoices, maintaining accurate billing records and customer balances.

## Key Files

### applied_coupon_service.rb
This service applies a single coupon to an invoice. It handles different types of coupons (percentage-based, fixed amount, recurring, one-time) and ensures proper application based on various conditions. The service calculates the credit amount, creates a new credit record, updates fees to reflect the applied coupon, and manages the coupon's remaining frequency if it's recurring.

Key features:
- Computes credit amount based on coupon type and limitations
- Handles recurring, forever, and one-time coupons
- Updates fees, applied coupon records, and invoice records

### applied_coupons_service.rb
This service applies all active coupons to an invoice. It iterates through each active coupon for the invoice's customer, creating credit entries and adjusting the invoice's total amount.

Key features:
- Processes multiple coupons for a single invoice
- Updates invoice coupon amount and subtotal
- Handles errors and validation failures

### applied_prepaid_credit_service.rb
This service applies prepaid credit from a customer's wallet to an invoice. It reduces the invoice's total amount and updates the wallet balance accordingly.

Key features:
- Computes the amount to be applied from the wallet
- Creates a wallet transaction record
- Updates wallet balance and invoice prepaid credit amount
- Triggers a webhook for the created wallet transaction

### credit_note_service.rb
This service applies credit notes to an invoice. It calculates and applies credits from available credit notes to reduce the invoice amount, updating both the invoice and the credit notes accordingly.

Key features:
- Fetches available credit notes for the customer
- Applies credit notes until the invoice amount is covered or all notes are used
- Creates new credit entries for each applied credit note
- Updates remaining balances of used credit notes

### progressive_billing_service.rb
This service handles progressive billing credits for invoices. It calculates and applies credits based on previously issued progressive billing invoices, adjusting the current invoice's amounts accordingly.

Key features:
- Iterates through invoice subscriptions to find relevant progressive billing invoices
- Calculates and applies credits based on previous progressive billing
- Creates credit notes when necessary
- Applies credits to invoice fees proportionally

## Dependencies
These services rely on various models and other services within the application, including:

- ActiveRecord for database interactions
- BaseService as a parent class providing common functionality
- Invoice, Credit, Fee, AppliedCoupon, WalletTransaction, and CreditNote models
- Wallets::Balance::DecreaseService for updating wallet balances
- SendWebhookJob for notifying external systems
- CreditNotes::CreateFromProgressiveBillingInvoice for creating credit notes in progressive billing scenarios

## Configuration
These services do not appear to rely on external configuration files or environment variables. However, they may be influenced by system-wide settings related to billing and credit management, which would be defined elsewhere in the application.

The services in this directory form a crucial part of the billing system, handling complex logic for applying various types of credits and discounts to customer invoices. They ensure accurate billing, maintain proper records, and handle different scenarios such as coupons, prepaid credits, credit notes, and progressive billing.