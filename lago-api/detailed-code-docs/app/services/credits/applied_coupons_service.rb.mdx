---
title: "applied_coupons_service.rb"
---

## High-level description
This code defines the `AppliedCouponsService` class within the `Credits` module. Its primary purpose is to apply active coupons to an invoice, calculating and creating credit entries for each applicable coupon.

## Code Structure
The main `call` method processes each active coupon for the invoice's customer. It creates credit entries, updates fee amounts, and adjusts the invoice's total. The service interacts with other parts of the system, such as the `AppliedCouponService` and various database models (Invoice, Credit, Fee).

## Symbols

### `AppliedCouponsService`
#### Description
This service applies active coupons to an invoice, creating credit entries and adjusting the invoice's total amount.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| invoice | Invoice | The invoice to which coupons will be applied |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | Result | An object containing the operation's result, including any created credits |

#### Internal Logic
1. Check if there are any applied coupons and if the invoice has fees.
2. Iterate through each active applied coupon.
3. For each coupon, call the `AppliedCouponService` to create a credit.
4. Update the invoice's coupon amount and subtotal.
5. Return the result with the created credits.

### `initialize`
#### Description
Initializes the service with the given invoice.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| invoice | Invoice | The invoice to process |

### `call`
#### Description
The main method that processes the coupons and applies them to the invoice.

#### Internal Logic
1. Check for the presence of applied coupons and invoice fees.
2. Iterate through each applied coupon.
3. Call `AppliedCouponService` for each coupon.
4. Update the invoice with the new credit amounts.
5. Return the result with the created credits.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| Credits::AppliedCouponService | Used to process individual coupons |
| BaseService | Parent class providing common functionality |

## Error Handling
The service uses the `raise_if_error!` method to propagate errors from the `AppliedCouponService`. It also catches `ActiveRecord::RecordInvalid` exceptions and records them as validation failures.

## Performance Considerations
The service processes coupons sequentially, which could be a performance bottleneck for invoices with many applied coupons. Consider batch processing or parallelization for optimization if needed.