---
title: "terminate_service.rb"
---

## High-level description
This code defines the `Subscriptions::TerminateService` class, which is responsible for terminating subscriptions in a billing system. It handles various scenarios such as immediate termination, termination with a pending next subscription, and creating credit notes for prepaid subscriptions.

## Code Structure
The main class `TerminateService` inherits from `BaseService` and contains two primary methods: `call` for immediate termination and `terminate_and_start_next` for handling downgrades. These methods interact with other services and models to manage the subscription lifecycle, billing, and related operations.

## Symbols

### Subscriptions::TerminateService
#### Description
This service class handles the termination of subscriptions, including immediate termination and termination with a pending next subscription.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| subscription | Subscription | The subscription to be terminated |
| async | Boolean | Whether to perform billing asynchronously (default: true) |
| upgrade | Boolean | Whether the termination is part of an upgrade process (default: false) |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | BaseService::Result | The result object containing the terminated subscription and any errors |

#### Internal Logic
1. Checks if the subscription exists and is not already terminated.
2. Handles different termination scenarios (pending, active, pay-in-advance).
3. Creates credit notes for prepaid subscriptions if necessary.
4. Bills the subscription for any remaining charges.
5. Cancels any pending next subscriptions.
6. Sends webhooks for subscription termination.

### terminate_and_start_next
#### Description
This method handles the termination of a subscription and the activation of its pending next subscription, typically used for downgrades.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| timestamp | Integer | The Unix timestamp for the termination/activation |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | BaseService::Result | The result object containing the new active subscription and any errors |

#### Internal Logic
1. Retrieves the next pending subscription.
2. Terminates the current subscription and activates the next one.
3. Bills the terminated subscription and the new subscription if necessary.
4. Sends webhooks for subscription termination and start.

## Side Effects
- Modifies subscription statuses in the database.
- Creates credit notes for prepaid subscriptions.
- Generates invoices for terminated subscriptions.
- Enqueues jobs for billing and webhook sending.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| BillSubscriptionJob | Handles billing for terminated subscriptions |
| BillNonInvoiceableFeesJob | Bills non-invoiceable fees for terminated subscriptions |
| SendWebhookJob | Sends webhooks for subscription events |
| CreditNotes::CreateFromTermination | Creates credit notes for prepaid subscriptions |

## Error Handling
The service uses a `BaseService::Result` object to handle and propagate errors. It checks for various conditions (e.g., subscription not found) and sets appropriate error messages.

## Logging
The code doesn't implement explicit logging, but it uses webhooks to notify external systems about subscription events.

## Performance Considerations
- The service uses database transactions to ensure data consistency when terminating and activating subscriptions.
- Asynchronous job processing is used for billing and webhook sending to improve performance and reduce response times.

This service is a critical component in managing subscription lifecycles, handling various scenarios, and ensuring proper billing and notification processes are followed during subscription termination.