---
title: "free_trial_billing_service.rb"
---

## High-level description
This code defines a `FreeTrialBillingService` within the `Subscriptions` module. Its primary purpose is to handle the billing process for subscriptions that are ending their free trial period. It identifies subscriptions whose trial is ending, bills them if necessary, updates their trial status, and sends a webhook notification.

## Code Structure
The main class `FreeTrialBillingService` inherits from `BaseService`. It contains a `call` method that processes ending trial subscriptions, and several private methods that handle specific aspects of the billing process, such as SQL queries and checking for previous billings.

## Symbols

### `FreeTrialBillingService`
#### Description
This service class handles the billing process for subscriptions that are ending their free trial period.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| timestamp | Time | The current timestamp (default: `Time.current`) |

#### Internal Logic
1. Retrieves subscriptions whose trial is ending.
2. For each subscription:
   - If the plan is pay-in-advance, not already billed today, and not billed on day one:
     - Enqueues a `BillSubscriptionJob` to bill the subscription.
   - Updates the subscription's `trial_ended_at` timestamp.
   - Enqueues a `SendWebhookJob` to notify about the ended trial.

### `call`
#### Description
The main method that processes subscriptions with ending trials.

#### Internal Logic
1. Iterates through `ending_trial_subscriptions`.
2. Checks billing conditions and enqueues billing job if necessary.
3. Updates the subscription's trial end timestamp.
4. Enqueues a webhook job to notify about the ended trial.

### `already_billed_on_day_one?`
#### Description
Checks if a subscription was already billed on the first day of its trial.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| subscription | Subscription | The subscription to check |

#### Internal Logic
Queries the database for any subscription fees associated with invoices created on the subscription's start date.

### `ending_trial_subscriptions`
#### Description
Retrieves subscriptions whose trial period is ending.

#### Internal Logic
Executes a complex SQL query that joins several tables to find subscriptions meeting specific criteria:
- Active subscriptions
- With plans that have a trial period
- Where the trial hasn't ended yet
- And the trial end date is less than or equal to the current timestamp

### `initial_started_at`, `trial_end_date`, `already_billed_today`
#### Description
These methods define SQL subqueries used in the `ending_trial_subscriptions` method.

## Side Effects
- Enqueues `BillSubscriptionJob` for eligible subscriptions.
- Updates `trial_ended_at` for processed subscriptions.
- Enqueues `SendWebhookJob` for each processed subscription.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| BillSubscriptionJob | To bill subscriptions |
| SendWebhookJob | To send webhook notifications |
| Subscription | To query and update subscription records |
| Fee | To check for existing fees |

## Error Handling
The code doesn't implement explicit error handling. It relies on the underlying ActiveRecord error handling mechanisms.

## Performance Considerations
The `already_billed_on_day_one?` method introduces an N+1 query, which could potentially impact performance for a large number of subscriptions. The method itself acknowledges this limitation in a comment.