---
title: "count_query.rb"
---

## High-level description
This code defines a `CountQuery` class within the `Events::Stores::Clickhouse::PreAggregated` module. It is designed to handle pre-aggregated count queries for events stored in Clickhouse, specifically for the `events_count_agg` table.

## Code Structure
The `CountQuery` class inherits from a `Base` class and overrides several protected methods to customize the behavior for count aggregation queries.

## Symbols

### `CountQuery`
#### Description
This class is responsible for handling count aggregation queries on pre-aggregated event data stored in Clickhouse.

#### Internal Logic
The class overrides four protected methods from its parent class:

1. `aggregation_type`: Returns the string 'count_agg' to identify the type of aggregation.
2. `pre_aggregated_model`: Returns the `Clickhouse::EventsCountAgg` model, which represents the pre-aggregated count data in the Clickhouse database.
3. `clickhouse_aggregation`: Returns the string 'sum', indicating that the aggregation operation in Clickhouse should be a sum of the pre-aggregated counts.
4. `assign_units`: A method to update the `units` value in a given bucket by adding the provided units.

## References
- `::Clickhouse::EventsCountAgg`: This class is referenced in the `pre_aggregated_model` method, indicating that it's the model used for querying the pre-aggregated count data.

## Dependencies
The code depends on the `Clickhouse::EventsCountAgg` model, which is defined in a separate file (`app/models/clickhouse/events_count_agg.rb`).

## Related Code
The `Clickhouse::EventsCountAgg` model is defined in the related code snippet. It inherits from `BaseRecord` and sets its table name to 'events_count_agg'. The table schema includes fields for code, filters, grouped_by, timestamp, value, charge_id, external_subscription_id, and organization_id.

This related model provides context for the data structure that the `CountQuery` class is working with, showing that it's dealing with pre-aggregated count data for events, grouped by various dimensions and associated with specific organizations and subscriptions.