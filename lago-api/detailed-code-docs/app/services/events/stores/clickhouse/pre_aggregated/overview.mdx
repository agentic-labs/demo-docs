---
title: "Overview"
---

## High-level description
This directory contains a set of classes that handle pre-aggregated event data queries in a Clickhouse database. The classes are designed to perform different types of aggregations (count, latest, max, and sum) on event data related to subscriptions. These classes are part of a larger system for managing and analyzing event data, likely in a subscription-based or usage-based billing context.

## What does it do?
The code in this directory provides a framework for querying and processing pre-aggregated event data stored in Clickhouse. It allows for efficient retrieval of aggregated data for different metrics (count, latest value, maximum value, and sum) within specified time boundaries and for specific subscriptions. This functionality is crucial for generating reports, calculating usage-based charges, or providing analytics on user activity.

The workflow typically involves:
1. Initializing a query with a subscription and time boundaries.
2. Executing the query, which may involve both pre-aggregated data and real-time event data.
3. Processing the query results and organizing them into a structured format.
4. Returning the processed data for further use in the application.

## Entry points
The main entry point for this functionality is the `Base` class defined in `base.rb`. This class provides the core logic for querying and processing event data. The other classes (`CountQuery`, `LatestQuery`, `MaxQuery`, and `SumQuery`) inherit from `Base` and specialize the behavior for different types of aggregations.

The data flow typically starts with the `call` method in the `Base` class, which orchestrates the querying process. It uses both pre-aggregated data (if available) and real-time event data to compile the final result.

## Key Files
1. `base.rb`: Defines the `Base` class, which provides the core functionality for querying and processing event data.
2. `count_query.rb`: Implements the `CountQuery` class for handling count aggregations.
3. `latest_query.rb`: Implements the `LatestQuery` class for retrieving the latest event data.
4. `max_query.rb`: Implements the `MaxQuery` class for handling maximum value aggregations.
5. `sum_query.rb`: Implements the `SumQuery` class for handling sum aggregations.

Each of these files defines a specific type of query, customizing the behavior of the `Base` class for different aggregation needs.

## Dependencies
The code relies on several external dependencies and models:

1. Clickhouse: The underlying database system used for storing and querying event data.
2. Clickhouse models:
   - `Clickhouse::EventsEnriched`: Used for querying real-time event data.
   - `Clickhouse::EventsCountAgg`: Used for pre-aggregated count data.
   - `Clickhouse::EventsMaxAgg`: Used for pre-aggregated maximum value data.
   - `Clickhouse::EventsSumAgg`: Used for pre-aggregated sum data.

These dependencies suggest that the system is designed to work with a Clickhouse database optimized for analytical queries on large-scale event data.

## Configuration
The code uses several configuration options, some of which are expected to be defined in subclasses:

1. `aggregation_type`: Defines the type of aggregation (e.g., 'count_agg', 'latest_agg', 'max_agg', 'sum_agg').
2. `pre_aggregated_model`: Specifies the Clickhouse model for pre-aggregated data.
3. `clickhouse_aggregation`: Defines the Clickhouse aggregation function to be used.

Additionally, there's a `ClickhouseStore::DECIMAL_SCALE` constant used for decimal conversions in Clickhouse queries.

In summary, this directory contains a set of classes that provide a flexible and efficient way to query and process pre-aggregated event data stored in Clickhouse. The system is designed to handle various types of aggregations and can be easily extended to support additional aggregation types or customized querying logic.