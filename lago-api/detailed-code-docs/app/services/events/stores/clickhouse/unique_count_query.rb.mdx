---
title: "unique_count_query.rb"
---

## High-level description
This code defines a `UniqueCountQuery` class within the `Events::Stores::Clickhouse` module. It provides methods to generate SQL queries for calculating unique counts and prorated unique counts of events, with support for grouped and non-grouped queries. The class is designed to work with a ClickHouse database and includes various SQL query templates for different aggregation scenarios.

## Code Structure
The `UniqueCountQuery` class contains several public methods that return SQL query strings for different types of aggregations. These methods utilize private helper methods to generate specific parts of the SQL queries. The class is initialized with a `store` object, which provides necessary context and data for building the queries.

## Symbols

### `UniqueCountQuery`
#### Description
This class generates SQL queries for unique count aggregations in ClickHouse.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| store | Object | An object providing context and data for query generation |

### `query`
#### Description
Generates a SQL query for calculating the unique count of events.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| SQL query | String | A SQL query string for unique count calculation |

### `prorated_query`
#### Description
Generates a SQL query for calculating the prorated unique count of events.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| SQL query | String | A SQL query string for prorated unique count calculation |

### `grouped_query`
#### Description
Generates a SQL query for calculating the grouped unique count of events.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| SQL query | String | A SQL query string for grouped unique count calculation |

### `grouped_prorated_query`
#### Description
Generates a SQL query for calculating the grouped prorated unique count of events.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| SQL query | String | A SQL query string for grouped prorated unique count calculation |

### `breakdown_query`
#### Description
Generates a SQL query for debugging purposes, returning detailed event data.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| SQL query | String | A SQL query string for event breakdown |

### `prorated_breakdown_query`
#### Description
Generates a SQL query for prorated event breakdown, with an option to include or exclude remove operations.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| with_remove | Boolean | Whether to include remove operations in the result |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| SQL query | String | A SQL query string for prorated event breakdown |

## Dependencies
The code relies on the ClickHouse database and assumes the existence of a `store` object with specific methods and attributes.

## Performance Considerations
The queries use Common Table Expressions (CTEs) and window functions, which may have performance implications on large datasets. The use of indexes and query optimization in ClickHouse should be considered for production use.