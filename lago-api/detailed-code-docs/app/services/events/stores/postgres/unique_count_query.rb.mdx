---
title: "unique_count_query.rb"
---

## High-level description
This code defines a `UniqueCountQuery` class within the `Events::Stores::Postgres` module. It provides methods to generate SQL queries for calculating unique counts and prorated unique counts of events, with support for grouped and non-grouped queries. The class is designed to work with a PostgreSQL database and includes various SQL snippets for different aggregation scenarios.

## Code Structure
The `UniqueCountQuery` class contains several public methods that return SQL queries as strings. These methods include `query`, `prorated_query`, `grouped_query`, `grouped_prorated_query`, `breakdown_query`, and `prorated_breakdown_query`. The class also has private helper methods for generating specific parts of the SQL queries.

## Symbols

### `UniqueCountQuery`
#### Description
This class generates SQL queries for unique count calculations on event data stored in a PostgreSQL database.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| store | Object | An object that provides methods for accessing event data and configuration |

#### Internal Logic
The class uses Common Table Expressions (CTEs) and window functions to calculate unique counts and prorated unique counts. It handles both grouped and non-grouped scenarios, as well as prorated and non-prorated calculations.

### `query`
#### Description
Generates a SQL query for calculating the unique count of events.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| SQL query | String | A SQL query that calculates the unique count of events |

### `prorated_query`
#### Description
Generates a SQL query for calculating the prorated unique count of events.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| SQL query | String | A SQL query that calculates the prorated unique count of events |

### `grouped_query`
#### Description
Generates a SQL query for calculating the grouped unique count of events.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| SQL query | String | A SQL query that calculates the grouped unique count of events |

### `grouped_prorated_query`
#### Description
Generates a SQL query for calculating the grouped prorated unique count of events.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| SQL query | String | A SQL query that calculates the grouped prorated unique count of events |

### `breakdown_query`
#### Description
Generates a SQL query for debugging purposes, returning detailed event data.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| SQL query | String | A SQL query that returns detailed event data for debugging |

### `prorated_breakdown_query`
#### Description
Generates a SQL query for debugging purposes, returning detailed prorated event data.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| with_remove | Boolean | Whether to include removed events in the result |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| SQL query | String | A SQL query that returns detailed prorated event data for debugging |

## Performance Considerations
The queries use Common Table Expressions (CTEs) and window functions, which can be performance-intensive for large datasets. The class relies on PostgreSQL-specific features, so it may not be portable to other database systems without modifications.

## Dependencies
This class depends on the `store` object passed to its constructor, which should provide methods like `events`, `charges_duration`, and `sanitized_property_name`.