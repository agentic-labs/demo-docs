---
title: "create_service.rb"
---

## High-level description
This code defines the `CreateService` class within the `AdjustedFees` module. Its primary purpose is to create an adjusted fee for a given fee in an invoice, handling various validation checks and updating the invoice accordingly.

## Code Structure
The `CreateService` class inherits from `BaseService` and contains a single public method `call` that orchestrates the creation of an adjusted fee. It also includes a private method `disabled_charge_model?` for validation purposes.

## References
- `BaseService`: The parent class that provides common functionality for service objects.
- `License`: Used to check if the premium feature is available.
- `AdjustedFee`: The model representing an adjusted fee.
- `Invoices::RefreshDraftService`: Used to refresh the draft invoice after creating the adjusted fee.

## Symbols

### `CreateService`
#### Description
This service class is responsible for creating an adjusted fee based on the provided parameters.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| organization | Organization | The organization context |
| fee | Fee | The original fee to be adjusted |
| params | Hash | Parameters for creating the adjusted fee |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | Result | An instance of `BaseService::Result` containing the operation outcome |

#### Internal Logic
1. Perform initial validations:
   - Check if the premium license is active and if the invoice is in draft state.
   - Ensure the fee doesn't already have an adjusted fee.
   - Validate the charge model.
2. Create a new `AdjustedFee` instance with the provided parameters.
3. Save the adjusted fee.
4. Refresh the draft invoice using `Invoices::RefreshDraftService`.
5. Update the result with the created adjusted fee and original fee.
6. Handle any `ActiveRecord::RecordInvalid` errors.

### `disabled_charge_model?`
#### Description
A private method that checks if the charge model is disabled for the given adjustment type.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| charge | Charge | The charge associated with the fee |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| disabled | Boolean | True if the charge model is disabled for the adjustment type |

#### Internal Logic
Determines if the charge model is disabled based on the adjustment type (unit adjustment) and the charge properties (percentage, prorated, or graduated).

## Side Effects
- Creates a new `AdjustedFee` record in the database.
- Refreshes the draft invoice, which may update related records.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| AdjustedFee | Model for creating the adjusted fee |
| Invoices::RefreshDraftService | Service for refreshing the draft invoice |
| License | Checking premium feature availability |

## Error Handling
The service uses the `Result` object from `BaseService` to handle and return errors. It specifically handles:
- Forbidden access (non-premium license or non-draft invoice)
- Validation failures (existing adjusted fee, invalid charge model)
- Record validation errors (via `ActiveRecord::RecordInvalid` rescue)

## Performance Considerations
The service performs database operations within a transaction, which can impact performance for large datasets. The `Invoices::RefreshDraftService` call may also be computationally expensive depending on the invoice complexity.