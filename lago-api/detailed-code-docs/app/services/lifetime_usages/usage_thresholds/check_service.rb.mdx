---
title: "check_service.rb"
---

## High-level description
This code defines a service class `CheckService` within the `LifetimeUsages::UsageThresholds` module. Its primary purpose is to check and determine which usage thresholds have been passed for a given lifetime usage, considering both fixed and recurring thresholds.

## Code Structure
The `CheckService` class inherits from `BaseService` and contains a single public method `call` that performs the main logic. It uses instance variables initialized in the constructor to store the lifetime usage, progressive billed amount, and usage thresholds.

## References
This code references the following external symbols:
- `BaseService`: The parent class from which `CheckService` inherits.
- `LifetimeUsage`: Represents the lifetime usage of a subscription.
- `Subscription`: Associated with the lifetime usage.
- `Plan`: Contains the usage thresholds for a subscription.
- `UsageThreshold`: Represents individual usage thresholds.

## Symbols

### `CheckService`
#### Description
This service checks which usage thresholds have been passed for a given lifetime usage, considering both fixed and recurring thresholds.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| lifetime_usage | LifetimeUsage | The lifetime usage to check thresholds against |
| progressive_billed_amount | Integer | The amount already billed progressively (default: 0) |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | Result | An object containing the passed thresholds |

#### Internal Logic
1. Initialize variables and retrieve thresholds.
2. Calculate the actual current usage by subtracting the progressive billed amount.
3. Return early if the actual current usage is negative.
4. Calculate the invoiced usage and total usage.
5. Check fixed thresholds:
   - If invoiced usage is less than the largest threshold, find passed thresholds.
   - If there's a recurring threshold and total usage exceeds it, add it to passed thresholds.
6. Check recurring threshold (if it exists):
   - Calculate the recurring remainder.
   - If the sum of actual current usage and remainder exceeds the recurring threshold, add it to passed thresholds.
7. Return the result with passed thresholds.

## Performance Considerations
The service uses database queries to retrieve and filter thresholds. It performs calculations in memory, which should be efficient for typical usage scenarios. However, if dealing with a large number of thresholds, the performance might be affected.

___

### `initialize`
#### Description
Initializes the service with the given lifetime usage and progressive billed amount.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| lifetime_usage | LifetimeUsage | The lifetime usage to check thresholds against |
| progressive_billed_amount | Integer | The amount already billed progressively (default: 0) |

___

### `call`
#### Description
Performs the main logic of checking which usage thresholds have been passed.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | Result | An object containing the passed thresholds |

___

## Dependencies
This code relies on the following Ruby on Rails features and conventions:
- ActiveRecord queries and associations
- Rails' `attr_reader` method

## Error Handling
The code doesn't implement explicit error handling. It relies on the error handling mechanisms provided by the `BaseService` class, which is not shown in the provided code.

## TODOs
There are no explicit TODOs in the code. However, potential improvements could include:
1. Adding input validation for the `lifetime_usage` and `progressive_billed_amount`.
2. Implementing more detailed error handling and reporting.
3. Considering edge cases, such as when there are no thresholds defined.