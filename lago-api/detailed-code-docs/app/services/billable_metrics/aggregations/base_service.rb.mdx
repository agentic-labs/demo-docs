---
title: "base_service.rb"
---

## High-level description
This code defines the `BaseService` class within the `BillableMetrics::Aggregations` module. It serves as a foundation for various aggregation services used in billable metric calculations. The class provides a structure for initializing common attributes, handling aggregations, and managing results for both single and grouped aggregations.

## Code Structure
The `BaseService` class inherits from `::BaseService` and defines methods for initialization, aggregation, and result handling. It also includes protected methods and attributes that are used by its subclasses to perform specific aggregation calculations.

## Symbols

### `BillableMetrics::Aggregations::BaseService`
#### Description
This class serves as a base for different aggregation services. It initializes common attributes and provides methods for aggregation calculations.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| event_store_class | Class | The class used for event storage |
| charge | Object | The charge object |
| subscription | Object | The subscription object |
| boundaries | Hash | Time boundaries for the aggregation |
| filters | Hash | Optional filters for the aggregation |

#### Internal Logic
- Initializes common attributes such as event store, charge, subscription, filters, and boundaries.
- Provides methods for single and grouped aggregations.
- Includes helper methods for handling in-advance current usage and finding cached aggregations.

### `#aggregate`
#### Description
This method determines whether to compute a grouped or non-grouped aggregation based on the presence of `grouped_by` attribute.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| options | Hash | Optional parameters for aggregation |

#### Internal Logic
- Checks if `grouped_by` is present.
- Calls either `compute_grouped_by_aggregation` or `compute_aggregation` based on the presence of `grouped_by`.

### `#compute_aggregation`
#### Description
This is an abstract method that should be implemented by subclasses to perform non-grouped aggregation.

### `#compute_grouped_by_aggregation`
#### Description
This is an abstract method that should be implemented by subclasses to perform grouped aggregation.

### `#per_event_aggregation`
#### Description
Computes aggregation on a per-event basis.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| exclude_event | Boolean | Whether to exclude an event from the aggregation |

#### Internal Logic
- Calls `compute_per_event_aggregation` method and stores the result in `event_aggregation` attribute of the result object.

### `#event_store`
#### Description
Lazily initializes and returns an event store object.

#### Internal Logic
- Creates a new instance of the event store class with the billable metric code, subscription, boundaries, and filters.

### `#handle_in_advance_current_usage`
#### Description
Handles the calculation of current usage for pay-in-advance scenarios.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| total_aggregation | Numeric | The total aggregation value |
| target_result | Object | The result object to store the calculation |

#### Internal Logic
- Finds the cached aggregation for the given time range and grouped by values.
- Calculates the aggregation based on the cached values and the total aggregation.
- Updates the target result with the calculated aggregation and current usage units.

### `#find_cached_aggregation`
#### Description
Finds the latest cached aggregation for the given parameters.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| with_from_datetime | DateTime | Start of the time range |
| with_to_datetime | DateTime | End of the time range |
| grouped_by | Hash | Grouped by values |

#### Internal Logic
- Queries the `CachedAggregation` model with the given parameters.
- Returns the latest cached aggregation record.

## Dependencies
The class depends on various models and services within the application, such as `CachedAggregation`, `BillableMetric`, and `Charge`.

## Error Handling
The class includes error handling for cases where aggregation calculations fail, raising a `ServiceFailure` error with an appropriate error code and message.