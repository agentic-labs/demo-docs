---
title: "netsuite.rb"
---

## High-level description
This code defines a `Netsuite` class within the `Integrations::Aggregator::Invoices::Payloads` module. It is responsible for generating a structured payload for Netsuite integration, specifically for invoices. The class inherits from `BasePayload` and provides methods to format invoice data according to Netsuite's requirements.

## Code Structure
The `Netsuite` class extends `BasePayload` and defines methods to construct the invoice payload. The main method `body` generates the overall structure, while private methods handle specific parts of the payload, such as columns, items, and discounts.

## References
This code references other parts of the codebase, including:
- `BasePayload` class (from which it inherits)
- `Invoice` model (referenced as `invoice`)
- `IntegrationCustomer` model (referenced as `integration_customer`)
- Various integration mapping models (referenced in inherited methods from `BasePayload`)

## Symbols

### `Netsuite` class
#### Description
This class is responsible for generating a Netsuite-specific payload for invoices.

#### Internal Logic
The class defines a constant `MAX_DECIMALS` and several methods to construct different parts of the payload:
- `body`: Generates the main structure of the payload
- `columns`: Builds the columns data for the invoice
- `invoice_url`: Constructs the URL for the invoice
- `due_date`: Formats the payment due date
- `item`: Generates item data for fees
- `discounts`: Builds discount data
- `limited_rate`: Limits the decimal places for rates

### `body` method
#### Description
Generates the main structure of the Netsuite payload.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| body | Hash | The complete Netsuite payload structure |

#### Internal Logic
1. Sets the type and dynamic flag
2. Includes columns data
3. Generates line items for fees and discounts
4. Sets options for mandatory fields

### `columns` method
#### Description
Builds the columns data for the invoice.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| columns | Hash | Invoice column data for Netsuite |

#### Internal Logic
1. Sets basic invoice information (ID, customer, tax status, etc.)
2. Adds tax information if a tax item is present
3. Includes custom fields for Lago-specific data

### `invoice_url` method
#### Description
Constructs the URL for the invoice.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| invoice_url | String | Full URL to the invoice in the Lago frontend |

### `due_date` method
#### Description
Formats the payment due date for Netsuite.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| due_date | String | Formatted due date (MM/DD/YYYY) |

### `item` method
#### Description
Generates item data for fees based on their type.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| fee | Fee | The fee object to generate item data for |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| item | Hash | Item data for Netsuite |

#### Internal Logic
1. Determines the item type based on the fee (charge, add-on, credit, commitment, or subscription)
2. Retrieves the appropriate mapped item
3. Constructs the item data with external ID, account code, quantity, and rate

### `discounts` method
#### Description
Builds discount data for coupons, prepaid credits, and credit notes.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| discounts | Array&lt;Hash&gt; | Array of discount items |

#### Internal Logic
1. Checks for coupon discounts and adds them if present
2. Checks for prepaid credit discounts and adds them if present
3. Checks for credit note discounts and adds them if present

### `limited_rate` method
#### Description
Limits the decimal places for rates to a maximum of 15 digits.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| precise_unit_amount | Numeric | The original unit amount |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| limited_rate | Numeric | The rate with limited decimal places |

## Dependencies
This class depends on the `BasePayload` class and various models from the application.

## Configuration
The code uses an environment variable:
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| LAGO_FRONT_URL | String | "https://app.getlago.com" | The base URL for the Lago frontend |

## Error Handling
The code does not implement specific error handling mechanisms beyond what might be inherited from `BasePayload`.

## Performance Considerations
The `limited_rate` method is used to ensure that rates don't exceed 15 digits, which may be important for Netsuite's data handling capabilities.