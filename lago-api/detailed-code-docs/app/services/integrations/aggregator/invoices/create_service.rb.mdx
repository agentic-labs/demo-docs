---
title: "create_service.rb"
---

## High-level description
This code defines a service class `CreateService` within the `Integrations::Aggregator::Invoices` module. Its primary purpose is to create and synchronize invoices with an external aggregator service, handling the HTTP communication, response processing, and error management.

## Code Structure
The `CreateService` class inherits from `BaseService` and contains two main methods: `call` and `call_async`. The `call` method performs the synchronous creation of an invoice, while `call_async` initiates an asynchronous job for invoice creation.

## References
- `BaseService`: The parent class from which `CreateService` inherits.
- `IntegrationResource`: A model used to create a record of the synchronized invoice.
- `LagoHttpClient::HttpError`: An error class used for handling HTTP-related errors.
- `Integrations::Aggregator::Invoices::CreateJob`: A job class used for asynchronous invoice creation.

## Symbols

### `CreateService`
#### Description
This class is responsible for creating and synchronizing invoices with an external aggregator service.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| invoice | Invoice | The invoice to be synchronized |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | Object | An object containing the result of the operation |

#### Internal Logic
1. Checks if the integration exists and is configured to sync invoices.
2. Verifies if the invoice is finalized.
3. Sends a POST request to the external service with the invoice payload.
4. Processes the response, which can be either a hash or a string.
5. Creates an `IntegrationResource` record if successful.
6. Handles errors and delivers error webhooks if necessary.

### `call`
#### Description
This method performs the synchronous creation and synchronization of an invoice.

#### Internal Logic
1. Performs initial checks (integration existence, sync_invoices flag, invoice finalization).
2. Sends HTTP POST request to the external service.
3. Processes the response (either hash or string).
4. Creates an `IntegrationResource` record if successful.
5. Handles errors and delivers error webhooks if necessary.

### `call_async`
#### Description
This method initiates an asynchronous job for invoice creation and synchronization.

#### Internal Logic
1. Checks if the invoice exists.
2. Enqueues a `CreateJob` for asynchronous processing.
3. Sets the invoice_id in the result object.

### `process_hash_result`
#### Description
Private method to process a hash response from the external service.

#### Internal Logic
1. Extracts the external_id from the response.
2. If successful, sets the external_id in the result object.
3. If unsuccessful, prepares an error message and delivers an error webhook.

### `process_string_result`
#### Description
Private method to process a string response from the external service.

#### Internal Logic
Sets the external_id in the result object using the response string.

## Error Handling
The service uses a rescue block to catch `LagoHttpClient::HttpError` exceptions. It delivers error webhooks for all errors and re-raises the exception for server errors (status code &gt;= 500).

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| LagoHttpClient | Used for making HTTP requests to the external service |
| JSON | Used for parsing JSON responses |

## API/Interface Reference
| Endpoint | Method | Request | Response | Description |
|:---------|:-------|:--------|:---------|:------------|
| v1/#{provider}/invoices | POST | Invoice payload | JSON with invoice details | Creates/syncs an invoice with the external service |

This service class provides a robust mechanism for synchronizing invoices with an external aggregator service, handling both synchronous and asynchronous operations, and managing various response formats and potential errors.