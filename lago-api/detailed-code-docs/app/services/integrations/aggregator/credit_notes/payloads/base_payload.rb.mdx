---
title: "base_payload.rb"
---

## High-level description
This code defines a `BasePayload` class within the `Integrations::Aggregator::CreditNotes::Payloads` module. It is responsible for generating a structured payload for credit notes, including customer information, credit note details, and associated items (fees, coupons, etc.).

## Code Structure
The `BasePayload` class inherits from `Integrations::Aggregator::BasePayload` and contains methods to initialize the payload, generate the body of the payload, and handle various types of credit note items.

## Symbols

### `BasePayload`
#### Description
This class represents the base structure for creating credit note payloads in an aggregator integration system.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| integration_customer | Object | Contains customer integration details |
| credit_note | Object | Represents the credit note being processed |

#### Internal Logic
1. Initializes with integration customer and credit note objects.
2. Generates a payload body with customer and credit note details.
3. Processes credit note items, adjusting taxes if necessary.
4. Handles different types of fees (charge, add-on, credit, commitment, subscription).
5. Calculates and includes coupon adjustments if applicable.

### `initialize`
#### Description
Initializes the BasePayload object with the given integration customer and credit note.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| integration_customer | Object | Contains customer integration details |
| credit_note | Object | Represents the credit note being processed |

### `body`
#### Description
Generates the main payload structure for the credit note.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| body | Array of Hashes | Contains structured credit note information |

#### Internal Logic
1. Creates an array with a single hash containing credit note details.
2. Includes customer ID, status, dates, currency, and type.
3. Calls `credit_note_items_with_adjusted_taxes` to process items and adjust taxes.
4. Adds coupons to the fees array.

### `credit_note_items`
#### Description
Generates an array of processed credit note items.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| credit_note_items | Array | Processed credit note items |

### `credit_note_items_with_adjusted_taxes`
#### Description
Adjusts taxes on credit note items if the sum of item taxes doesn't match the credit note's total taxes.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| credit_note_items | Array | Array of credit note items |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| adjusted_items | Array | Credit note items with adjusted taxes |

#### Internal Logic
1. Calculates the sum of taxes from all items.
2. If the sum matches the credit note's total taxes, returns the original items.
3. Otherwise, adjusts the first item with non-zero taxes to account for the difference.

### `item`
#### Description
Processes a single credit note item based on its fee type.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| credit_note_item | Object | Individual credit note item |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| item_hash | Hash | Processed item details |

#### Internal Logic
1. Determines the fee type (charge, add-on, credit, commitment, subscription).
2. Calls the appropriate method to map the item based on its type.
3. Constructs a hash with item details, including external ID, description, units, amount, and taxes.

### `taxes_amount_cents`
#### Description
Calculates the tax amount for a credit note item.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| credit_note_item | Object | Individual credit note item |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| taxes_amount_cents | Integer | Calculated tax amount in cents |

### `coupons`
#### Description
Generates an array of coupon adjustments if applicable.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| output | Array | Array of coupon adjustment hashes |

#### Internal Logic
1. Checks if there are any coupon adjustments.
2. If present, creates a hash with coupon details, including a negative amount for the adjustment.

## Dependencies
This class depends on various other classes and methods that are not defined in this file, such as `billable_metric_item`, `add_on_item`, `credit_item`, `commitment_item`, `subscription_item`, and `coupon_item`. These are likely defined in related files within the project.