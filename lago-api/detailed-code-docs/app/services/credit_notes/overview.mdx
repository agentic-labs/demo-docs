---
title: "Overview"
---

## High-level description
The `app/services/credit_notes` directory contains a collection of service classes responsible for managing various aspects of credit notes within a billing system. These services handle operations such as creating, updating, validating, estimating, and voiding credit notes, as well as managing refunds through different payment providers.

## What does it do?
This directory provides a comprehensive set of services for credit note management:

1. Creation and Updating:
   - `CreateService`: Creates new credit notes
   - `CreateFromTermination`: Generates credit notes when subscriptions are terminated
   - `CreateFromProgressiveBillingInvoice`: Creates credit notes for progressive billing invoices
   - `UpdateService`: Updates existing credit notes, particularly their refund status

2. Validation and Estimation:
   - `ValidateService`: Ensures credit notes meet all required criteria
   - `ValidateItemService`: Validates individual credit note items
   - `EstimateService`: Provides estimates for potential credit notes

3. Tax and Amount Calculation:
   - `ApplyTaxesService`: Calculates and applies taxes to credit notes
   - `RefreshDraftService`: Recalculates amounts and taxes for draft credit notes

4. PDF Generation:
   - `GenerateService`: Creates PDF files for credit notes

5. Refund Processing:
   - `RecreditService`: Handles recrediting of credit notes
   - Refund services for different payment providers (Adyen, GoCardless, Stripe)

6. Voiding:
   - `VoidService`: Manages the process of voiding credit notes

These services work together to provide a robust system for managing credit notes throughout their lifecycle, from creation to finalization and potential refunding or voiding.

## Entry points
The main entry points for this directory are the service classes themselves, which are typically called from controllers, jobs, or other parts of the application. Key entry points include:

1. `CreateService`: Used when a new credit note needs to be created
2. `EstimateService`: Called when estimating potential credit note amounts
3. `ValidateService`: Invoked to ensure credit notes are valid before processing
4. `GenerateService`: Used to generate PDF files for credit notes
5. Refund services (Adyen, GoCardless, Stripe): Called when processing refunds through specific payment providers

The flow of data typically starts with the creation or estimation of a credit note, followed by validation, tax calculation, and potentially refund processing or voiding.

## Key Files
1. `create_service.rb`: Handles the creation of new credit notes
2. `estimate_service.rb`: Provides estimates for potential credit notes
3. `validate_service.rb`: Ensures credit notes meet all required criteria
4. `apply_taxes_service.rb`: Calculates and applies taxes to credit notes
5. `generate_service.rb`: Creates PDF files for credit notes
6. `void_service.rb`: Manages the process of voiding credit notes
7. `refunds/` directory: Contains services for processing refunds through different payment providers

## Dependencies
The credit note services rely on several external libraries and internal modules:

1. Payment provider APIs: Adyen, GoCardless, Stripe
2. PDF generation utilities (likely an internal module)
3. Tax calculation services
4. Segment for analytics tracking
5. Internal models such as `CreditNote`, `Invoice`, and `Fee`

Specific versions of these dependencies are not provided in the code snippets, but they are crucial for the proper functioning of these services.

## Configuration
While specific configuration files are not mentioned, these services likely depend on environment variables or configuration settings for:

1. Payment provider API credentials
2. PDF generation settings
3. Tax calculation parameters
4. Segment API keys for analytics

These would typically be stored securely and accessed within the services as needed.

In summary, the `app/services/credit_notes` directory provides a comprehensive set of services for managing credit notes throughout their lifecycle, handling various aspects such as creation, validation, tax calculation, refund processing, and PDF generation.