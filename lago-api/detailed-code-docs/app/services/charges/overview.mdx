---
title: "Overview"
---

## High-level description
The `app/services/charges` directory contains a collection of service classes responsible for managing various aspects of charge calculation, validation, and processing in a billing or pricing system. These services handle different charge models, tax applications, property filtering, and aggregation for pay-in-advance scenarios.

## What does it do?
This directory provides a comprehensive set of services that work together to:

1. Calculate charges for different pricing models (e.g., standard, graduated, percentage, package, volume).
2. Apply taxes to charges.
3. Filter and validate charge model properties.
4. Handle pay-in-advance charge scenarios.
5. Create and override charges.
6. Validate charge configurations for different models.

These services form the core of the charging logic in the billing system, ensuring accurate calculations, proper tax application, and valid charge configurations.

## Entry points
The main entry points for this directory are:

1. `ChargeModelFactory`: Creates instances of specific charge model services based on the charge type.
2. `ApplyTaxesService`: Applies taxes to charges.
3. `FilterChargeModelPropertiesService`: Filters properties for different charge models.
4. `PayInAdvanceAggregationService`: Handles aggregation for pay-in-advance scenarios.
5. `OverrideService`: Creates new charges based on existing ones with modifications.
6. Various validator services in the `validators` subdirectory.

These services are likely called by higher-level components in the billing system to perform specific charge-related operations.

## Key Files
1. `charge_model_factory.rb`: Factory for creating charge model service instances.
2. `apply_taxes_service.rb`: Applies taxes to charges.
3. `filter_charge_model_properties_service.rb`: Filters charge model properties.
4. `pay_in_advance_aggregation_service.rb`: Handles pay-in-advance aggregation.
5. `override_service.rb`: Creates new charges based on existing ones.
6. `build_default_properties_service.rb`: Builds default properties for charge models.
7. `amount_details` directory: Contains services for calculating detailed charge amounts.
8. `charge_models` directory: Contains services for different charge models.
9. `validators` directory: Contains validator services for different charge types.

## Dependencies
The services in this directory depend on:

1. Ruby's `BigDecimal` for precise decimal calculations.
2. A `License` module for checking premium features.
3. Various helper services within the `Charges` module.
4. `ActiveRecord` for database operations.
5. `BillableMetrics::AggregationFactory` for creating aggregators.

## Configuration
While there are no explicit configuration files, the services rely heavily on:

1. Charge model properties passed as parameters.
2. Charge objects containing model-specific configurations.
3. Tax codes for tax application.
4. Time boundaries and filters for aggregation.

These configurations are typically passed to the services when they are instantiated or called.

In summary, the `app/services/charges` directory provides a robust set of services for handling various aspects of charge calculation, validation, and processing in a flexible and extensible manner, supporting multiple pricing models and complex billing scenarios.