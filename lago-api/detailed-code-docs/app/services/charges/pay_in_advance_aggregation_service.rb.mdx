---
title: "pay_in_advance_aggregation_service.rb"
---

## High-level description
This code defines the `PayInAdvanceAggregationService` class within the `Charges` module. It is responsible for aggregating charge-related data for pay-in-advance scenarios, utilizing various filters and boundaries to calculate the aggregation result.

## Code Structure
The `PayInAdvanceAggregationService` inherits from `BaseService` and uses the `BillableMetrics::AggregationFactory` to create an appropriate aggregator instance. The main functionality is implemented in the `call` method, which performs the aggregation based on the provided charge, boundaries, properties, and filters.

## Symbols

### PayInAdvanceAggregationService
#### Description
This service class handles the aggregation of charge-related data for pay-in-advance scenarios. It initializes with charge, boundaries, properties, event, and an optional charge filter, then uses these to create an aggregator and perform the aggregation.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| charge | Charge | The charge object for which aggregation is performed |
| boundaries | Hash | Time boundaries for the aggregation |
| properties | Hash | Properties related to the charge |
| event | Event | The event triggering the aggregation |
| charge_filter | ChargeFilter | Optional filter for the charge |

#### Outputs
The `call` method returns the result of the aggregation performed by the created aggregator.

#### Internal Logic
1. Creates an aggregator instance using `BillableMetrics::AggregationFactory`.
2. Prepares the boundaries and aggregation filters.
3. Calls the `aggregate` method on the aggregator with the prepared options.

### Private Methods
#### aggregation_options
Prepares options for the aggregation, including free units per events and free units per total aggregation.

#### aggregation_filters
Prepares filters for the aggregation, including event, grouped by values, and charge filter-related information.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| BillableMetrics::AggregationFactory | Creates the appropriate aggregator instance |
| ChargeFilters::MatchingAndIgnoredService | Handles charge filter matching and ignoring |

## Error Handling
The service relies on the error handling mechanisms of the underlying `BaseService` class and the aggregator it creates.

This service plays a crucial role in the pay-in-advance charging system, providing the necessary aggregation logic for calculating charges based on usage and applied filters.