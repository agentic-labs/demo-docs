---
title: "range_graduated_service.rb"
---

## High-level description
The `RangeGraduatedService` class is part of the Charges::AmountDetails module and is responsible for calculating the details of a graduated pricing range for a specific number of units. It computes various pricing components such as flat amounts, per-unit amounts, and total amounts within a given range.

## Code Structure
The `RangeGraduatedService` class inherits from `::BaseService` and contains methods to initialize the service with a range and total units, and to calculate various pricing components. The main functionality is encapsulated in the `call` method, which returns a hash of calculated values.

## References
This code is referenced by the `Charges::ChargeModels::GraduatedService` class, which uses it to calculate graduated ranges for a charge model.

## Symbols

### `RangeGraduatedService`
#### Description
This class calculates the pricing details for a specific range in a graduated pricing model.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| range | Hash | A hash containing the pricing details for a specific range |
| total_units | Numeric | The total number of units to be priced |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Hash | Hash | A hash containing calculated pricing details for the range |

#### Internal Logic
1. Initializes the service with the given range and total units.
2. Calculates various pricing components such as from_value, to_value, flat_unit_amount, per_unit_amount, units, per_unit_total_amount, and total_with_flat_amount.
3. Returns a hash with all calculated values.

### `call`
#### Description
This method performs the main calculation and returns a hash of pricing details.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Hash | Hash | A hash containing all calculated pricing details |

### `units`
#### Description
Calculates the number of units to be billed within the current range.

#### Internal Logic
1. Checks if the total_units exceed the range's to_value.
2. Handles cases where total_units are within the range or at the range boundaries.
3. Returns the calculated number of units for billing.

## Performance Considerations
The class uses memoization (@variable ||=) for several calculations to avoid redundant computations, which can improve performance when these values are accessed multiple times.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| BigDecimal | Used for precise decimal arithmetic in financial calculations |

## Error Handling
The code does not implement specific error handling mechanisms beyond what might be inherited from the BaseService class.

## TODOs
- There is a commented note about computing how many units to bill in the range, which might indicate a potential area for future optimization or clarification.