---
title: "Overview"
---

## High-level description
This directory contains services related to invoice management in the application. It handles various aspects of invoice processing, including creation, updating, finalization, payment processing, and specialized operations like progressive billing and voiding.

## What does it do?
The services in this directory collectively manage the entire lifecycle of invoices:

1. Invoice Creation: Services like `CreateGeneratingService` and `SubscriptionService` handle the initial creation of invoices.

2. Fee Calculation: `CalculateFeesService` computes fees for invoices based on subscriptions and charges.

3. Tax Application: Services like `ApplyTaxesService` and `ApplyProviderTaxesService` handle tax calculations and application to invoices.

4. Invoice Finalization: `RefreshDraftAndFinalizeService` and `FinalizeOpenCreditService` manage the process of finalizing draft invoices.

5. Payment Processing: The `payments` subdirectory contains services for creating payments, retrying failed payments, and handling different payment providers.

6. Specialized Billing: Services like `ProgressiveBillingService` and `PaidCreditService` handle specific billing scenarios.

7. Invoice Updates and Voiding: `UpdateService` and `VoidService` manage invoice modifications and cancellations.

8. PDF Generation: `GeneratePdfService` creates PDF versions of invoices.

9. Webhook and Integration Management: Various services trigger webhooks and integrate with external systems for tasks like tax reporting and payment processing.

## Entry points
The main entry points for invoice processing are:

1. `SubscriptionService`: Initiates the invoice creation process for subscriptions.
2. `CreateGeneratingService`: Creates initial draft invoices.
3. `RefreshDraftAndFinalizeService`: Finalizes draft invoices.
4. `UpdateService`: Handles updates to existing invoices.
5. `VoidService`: Manages the process of voiding invoices.

The flow typically starts with invoice creation, moves through calculation and finalization, and ends with payment processing or voiding.

## Key Files
1. `subscription_service.rb`: Manages the creation of subscription invoices.
2. `calculate_fees_service.rb`: Computes fees for invoices.
3. `apply_taxes_service.rb` and `apply_provider_taxes_service.rb`: Handle tax calculations.
4. `refresh_draft_and_finalize_service.rb`: Finalizes draft invoices.
5. `payments/create_service.rb`: Initiates payment processing for invoices.
6. `void_service.rb`: Handles invoice voiding.
7. `generate_pdf_service.rb`: Creates PDF versions of invoices.

## Dependencies
The services in this directory rely on several external libraries and internal modules:

1. ActiveRecord: For database operations.
2. AASM: For managing invoice state transitions.
3. Various payment provider libraries (Stripe, GoCardless, Adyen).
4. Internal services for tax calculations, credit management, and webhook delivery.

## Configuration
While not explicitly shown in all files, these services likely rely on configuration settings for:

1. Payment provider API keys and endpoints.
2. Tax calculation settings.
3. PDF generation options.
4. Webhook URLs and settings.

These would typically be stored as environment variables or in configuration files.

The services use various constants and settings to maintain consistency across different invoice operations, such as payment statuses, invoice types, and billing scenarios.

This directory plays a crucial role in the application's billing and invoicing system, managing complex processes from invoice creation to payment and integration with external systems.