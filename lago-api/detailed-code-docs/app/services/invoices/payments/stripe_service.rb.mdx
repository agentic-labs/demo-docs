---
title: "stripe_service.rb"
---

## High-level description
This code defines the `StripeService` class within the `Invoices::Payments` module. It handles Stripe-related payment operations for invoices, including creating payments, updating payment statuses, and generating payment URLs. The service interacts with the Stripe API to process payments and manage customer payment methods.

## Code Structure
The `StripeService` class inherits from `BaseService` and includes the `Customers::PaymentProviderFinder` module. It contains methods for creating payments, updating payment statuses, and generating payment URLs. These methods interact with the Stripe API and update the local database accordingly.

## Symbols

### `StripeService`
#### Description
This class handles Stripe-related payment operations for invoices.

#### Internal Logic
- Initializes with an optional invoice
- Defines constants for pending, success, and failed payment statuses
- Implements methods for creating payments, updating payment statuses, and generating payment URLs
- Interacts with the Stripe API to process payments and manage customer payment methods
- Updates local database records based on Stripe API responses

### `create`
#### Description
Creates a Stripe payment for the associated invoice.

#### Inputs
- None (uses the initialized invoice)

#### Outputs
- `result`: A `BaseService::Result` object containing the created payment and updated invoice

#### Internal Logic
1. Checks if payment should be processed
2. Creates a Stripe payment if the invoice amount is positive
3. Creates a local `Payment` record
4. Updates the invoice payment status
5. Enqueues a job to sync the payment with external integrations
6. Handles various Stripe-related errors

### `update_payment_status`
#### Description
Updates the payment status for a given Stripe payment.

#### Inputs
- `organization_id`: ID of the organization
- `provider_payment_id`: Stripe payment ID
- `status`: New payment status
- `metadata`: Additional metadata

#### Outputs
- `result`: A `BaseService::Result` object containing the updated payment and invoice

#### Internal Logic
1. Finds or creates the payment based on the provider payment ID and metadata
2. Updates the payment status
3. Updates the associated invoice's payment status

### `generate_payment_url`
#### Description
Generates a Stripe Checkout Session URL for the invoice payment.

#### Inputs
- None (uses the initialized invoice)

#### Outputs
- `result`: A `BaseService::Result` object containing the generated payment URL

#### Internal Logic
1. Checks if payment should be processed
2. Creates a Stripe Checkout Session
3. Returns the generated URL

## Dependencies
- Stripe API
- `BaseService`
- `Customers::PaymentProviderFinder`
- Various internal services and models (e.g., `Payment`, `Invoice`, `DeliverErrorWebhookService`)

## Error Handling
The service handles various Stripe-related errors, including `Stripe::AuthenticationError`, `Stripe::CardError`, `Stripe::InvalidRequestError`, and `Stripe::PermissionError`. It also handles rate limiting and API connection errors by raising them to allow for automatic retries.

## Side Effects
- Creates and updates `Payment` records in the database
- Updates `Invoice` payment statuses
- Enqueues background jobs for payment synchronization
- Delivers error webhooks in case of payment failures

## Performance Considerations
- Uses background jobs for non-critical operations (e.g., payment synchronization)
- Implements idempotency for Stripe API calls to prevent duplicate payments

This service is crucial for handling Stripe payments within the application, ensuring proper integration between the local database and the Stripe API for invoice payments.