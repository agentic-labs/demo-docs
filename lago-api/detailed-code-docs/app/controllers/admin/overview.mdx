---
title: "Overview"
---

## High-level description
This directory contains controllers for the admin section of the application. It includes controllers for managing invoices, memberships, and organizations, as well as a base controller that handles authentication and sets up the context for admin actions.

## What does it do?
The controllers in this directory provide functionality for administrative tasks:

1. Authentication: The base controller verifies Google ID tokens to ensure only authorized users can access admin features.

2. Invoice Management: Admins can regenerate invoice PDFs and view invoice details in HTML format.

3. Membership Management: Admins can create new memberships, associating users with organizations.

4. Organization Management: Admins can update organization details, specifically the organization's name.

These controllers work together to provide a secure and functional admin interface for managing various aspects of the application.

## Entry points
The main entry points for this directory are:

1. `base_controller.rb`: This is the foundation for all admin controllers, handling authentication and setting up the admin context.

2. `invoices_controller.rb`: Manages invoice-related actions such as regenerating PDFs and displaying invoice details.

3. `memberships_controller.rb`: Handles the creation of new memberships.

4. `organizations_controller.rb`: Manages organization updates.

The flow of control typically starts with the `base_controller.rb`, which authenticates the user. Then, depending on the specific admin action required, one of the other controllers is invoked to handle the request.

## Key Files

1. `base_controller.rb`:
   - Inherits from `ApplicationController`
   - Includes the `ApiErrors` module
   - Implements Google ID token authentication
   - Sets up the admin context

2. `invoices_controller.rb`:
   - Inherits from `BaseController`
   - Provides actions to regenerate invoice PDFs and display invoice details
   - Uses `Invoices::GeneratePdfService` for PDF generation

3. `memberships_controller.rb`:
   - Inherits from `BaseController`
   - Handles the creation of new memberships
   - Uses `Memberships::CreateService` for membership creation
   - Utilizes `V1::MembershipSerializer` for response formatting

4. `organizations_controller.rb`:
   - Inherits from `BaseController`
   - Manages organization updates
   - Uses `Admin::Organizations::UpdateService` for update operations
   - Employs `V1::OrganizationSerializer` for response formatting

## Dependencies
The controllers in this directory rely on several external libraries and services:

1. Google::Auth::IDTokens (version not specified):
   - Used in `base_controller.rb` for verifying Google ID tokens
   - Chosen for its ability to handle Google authentication securely

2. Various service objects:
   - `Invoices::GeneratePdfService`
   - `Memberships::CreateService`
   - `Admin::Organizations::UpdateService`
   - These service objects encapsulate business logic, promoting separation of concerns

3. Serializers:
   - `V1::MembershipSerializer`
   - `V1::OrganizationSerializer`
   - Used for formatting JSON responses consistently

4. ActiveRecord models:
   - `Invoice`
   - `User`
   - `Organization`
   - These models represent the data structures used in the application

## Configuration
The admin controllers use the following configuration:

1. Environment variable:
   - `GOOGLE_AUTH_CLIENT_ID`: Used in `base_controller.rb` for Google ID token verification

2. Authentication:
   - Google ID token authentication is set up in `base_controller.rb`
   - The `authenticate` method is used as a `before_action` hook in the base controller

3. Context:
   - `CurrentContext.source` is set to `'admin'` in the `set_context_source` method of `base_controller.rb`

4. Error handling:
   - The `ApiErrors` module is included in `base_controller.rb` for consistent error handling across admin controllers

Here's an example of how the Google ID token authentication is implemented in `base_controller.rb`:

```ruby
def authenticate
  authorization = request.headers['Authorization']
  unauthorized_error if authorization.blank?

  token = authorization.split(' ').last
  payload = Google::Auth::IDTokens.verify_oidc(token, aud: ENV['GOOGLE_AUTH_CLIENT_ID'])
  CurrentContext.email = payload['email']
  true
rescue Google::Auth::IDTokens::SignatureError
  unauthorized_error
end
```

This code demonstrates how the controller extracts the token from the Authorization header, verifies it using the Google Auth library, and sets the authenticated user's email in the `CurrentContext`.

In summary, this directory provides a set of controllers that work together to create a secure and functional admin interface for managing invoices, memberships, and organizations. The controllers utilize various services and serializers to handle business logic and format responses, while the base controller ensures proper authentication and context setting for all admin actions.