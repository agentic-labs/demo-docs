---
title: "authenticable_user.rb"
---

## High-level description
The `AuthenticableUser` module is a concern in Ruby on Rails that provides user authentication functionality using JSON Web Tokens (JWT). It includes methods for retrieving the current user, decoding and validating tokens, and automatically renewing tokens for authenticated users.

## Code Structure
The module defines several private methods that work together to handle user authentication. The `current_user` method relies on `token`, `decoded_token`, and `valid_token?` to authenticate the user. The `renew_token` method is called before each action to refresh the user's token if necessary.

## Symbols

### `AuthenticableUser`
#### Description
This module is designed to be included in controllers that require user authentication. It extends `ActiveSupport::Concern` and includes a `before_action` to renew the user's token.

#### Internal Logic
- Defines several private methods for token handling and user authentication
- Uses the `included` block to set up a `before_action` for token renewal

### `current_user`
#### Description
Retrieves the current authenticated user based on the JWT payload.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| @current_user | User | The authenticated user or nil if not authenticated |

#### Internal Logic
- Checks for the presence of a token and its validity
- Finds the user by ID from the token payload

### `token`
#### Description
Extracts the JWT from the Authorization header.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| @token | String | The JWT token or nil if not present |

### `decoded_token`
#### Description
Decodes the JWT using the application's secret key.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| @decoded_token | Array | The decoded JWT payload and header |

#### Internal Logic
- Uses the JWT gem to decode the token
- Rescues JWT::DecodeError, re-raising only for expired signatures or in development environment

### `valid_token?`
#### Description
Checks if the token is not expired.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| (boolean) | Boolean | True if the token is not expired, false otherwise |

### `payload_data`
#### Description
Merges the decoded token data into a single hash.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| @payload_data | Hash | The merged JWT payload data |

### `decode_options`
#### Description
Provides options for JWT decoding.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| (hash) | Hash | JWT decode options with the algorithm specified |

### `renew_token`
#### Description
Generates a new token for the current user and sets it in the response header.

#### Internal Logic
- Checks for the presence of a current user
- Uses `UsersService` to generate a new token
- Sets the new token in the 'x-lago-token' response header if successful

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| ActiveSupport::Concern | Provides a way to create modules that can be easily included in classes |
| JWT | Used for encoding and decoding JSON Web Tokens |

## Error Handling
The module implements error handling for JWT decoding, specifically for `JWT::DecodeError`. It re-raises the error only for expired signatures or in the development environment.

## API/Interface Reference
| Endpoint | Method | Request | Response | Description |
|:---------|:-------|:--------|:---------|:------------|
| N/A | N/A | Authorization header with JWT | x-lago-token header with renewed JWT | Automatically renews the user's JWT on each request if a valid current user is present |

This module is designed to be included in controllers that require user authentication, providing a seamless way to handle JWT-based authentication in a Rails application.