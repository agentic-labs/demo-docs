---
title: "applied_coupons_controller.rb"
---

## High-level description
This code defines the `AppliedCouponsController` within the `Api::V1` namespace, which handles API requests related to applied coupons. It provides endpoints for creating new applied coupons and retrieving a list of applied coupons, with proper error handling and serialization of responses.

## Code Structure
The `AppliedCouponsController` inherits from `Api::BaseController` and contains two main actions: `create` and `index`. These actions interact with various services, queries, and serializers to process requests and format responses.

## References
- `Api::BaseController`
- `AppliedCoupons::CreateService`
- `AppliedCouponsQuery`
- `V1::AppliedCouponSerializer`
- `CollectionSerializer`

## Symbols

### `AppliedCouponsController`
#### Description
This controller handles API requests related to applied coupons, providing endpoints for creating and listing applied coupons.

#### Internal Logic
The controller uses the `current_organization` method (inherited from `Api::BaseController`) to scope operations to the authenticated organization.

### `create`
#### Description
Creates a new applied coupon for a customer using the provided coupon code.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| external_customer_id | string | External ID of the customer |
| coupon_code | string | Code of the coupon to be applied |
| Other parameters | various | Additional parameters for creating the applied coupon |

#### Internal Logic
1. Finds the customer and coupon based on the provided parameters and current organization.
2. Calls the `AppliedCoupons::CreateService` to create the applied coupon.
3. If successful, renders the created applied coupon using `V1::AppliedCouponSerializer`.
4. If unsuccessful, renders an error response.

### `index`
#### Description
Retrieves a list of applied coupons based on the provided filters and pagination parameters.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| page | integer | Page number for pagination |
| per_page | integer | Number of items per page |
| external_customer_id | string | (Optional) Filter by external customer ID |
| status | string | (Optional) Filter by status |

#### Internal Logic
1. Calls the `AppliedCouponsQuery` to retrieve the filtered and paginated list of applied coupons.
2. If successful, renders the list of applied coupons using `CollectionSerializer` and `V1::AppliedCouponSerializer`.
3. Includes pagination metadata and associated credits in the response.
4. If unsuccessful, renders an error response.

### `create_params`
#### Description
A private method that defines the allowed parameters for creating an applied coupon.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| permitted_params | ActionController::Parameters | Permitted parameters for creating an applied coupon |

### `index_filters`
#### Description
A private method that defines the allowed filter parameters for the index action.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| permitted_filters | ActionController::Parameters | Permitted filter parameters for the index action |

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| Api::BaseController | Base controller for API endpoints |
| AppliedCoupons::CreateService | Service for creating applied coupons |
| AppliedCouponsQuery | Query object for retrieving applied coupons |
| V1::AppliedCouponSerializer | Serializer for individual applied coupons |
| CollectionSerializer | Serializer for collections of objects |

## Error Handling
The controller uses the `render_error_response` method (likely defined in `Api::BaseController`) to handle and render error responses when operations are unsuccessful.

## API/Interface Reference
| Endpoint | Method | Request | Response | Description |
|:---------|:-------|:--------|:---------|:------------|
| /api/v1/applied_coupons | POST | JSON with applied coupon parameters | JSON with created applied coupon | Creates a new applied coupon |
| /api/v1/applied_coupons | GET | Query parameters for filtering and pagination | JSON with list of applied coupons and metadata | Retrieves a list of applied coupons |