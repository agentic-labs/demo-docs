---
title: "Overview"
---

## High-level description
This directory contains controllers for the API version 1 (v1) endpoints related to customer operations. It includes two main controllers: `AppliedCouponsController` and `UsageController`, which handle operations for applied coupons and usage data respectively. These controllers are part of a larger API structure, likely for a subscription or billing management system.

## What does it do?
The controllers in this directory manage two key aspects of customer interactions:

1. Applied Coupons: It allows the termination of coupons that have been applied to a customer's account. This is useful for scenarios where a coupon needs to be removed before its natural expiration, perhaps due to policy changes or customer requests.

2. Usage Tracking: It provides endpoints to retrieve both current and historical usage data for customers. This is crucial for billing purposes, allowing the system to track how much of a service a customer has used over time.

These controllers act as the interface between the client (which could be a front-end application or another service) and the business logic of the application. They receive requests, validate inputs, call appropriate services to perform operations, and format the responses.

## Key Files

1. `applied_coupons_controller.rb`:
   This controller handles the termination of applied coupons. It provides a single `destroy` action that finds a customer and their applied coupon, then terminates it using a dedicated service.

2. `usage_controller.rb`:
   This controller manages the retrieval of usage data. It offers two main actions:
   - `current`: Fetches the current usage data for a specific customer and subscription.
   - `past`: Retrieves historical usage data with support for pagination and filtering.

Both controllers inherit from `Api::BaseController`, suggesting a common base for API-related controllers in the application.

## Dependencies
While specific versions are not provided, the controllers rely on several internal dependencies:

1. Services:
   - `AppliedCoupons::TerminateService`: Handles the logic for terminating an applied coupon.
   - `::Invoices::CustomerUsageService`: Retrieves current usage data for a customer.
   - `PastUsageQuery`: Fetches historical usage data.

2. Serializers:
   - `V1::AppliedCouponSerializer`: Formats applied coupon data for API responses.
   - `::V1::Customers::UsageSerializer`: Serializes current usage data.
   - `::V1::Customers::PastUsageSerializer`: Serializes historical usage data.
   - `::CollectionSerializer`: Handles serialization of collections, likely used for paginated results.

These dependencies suggest a well-structured application with separation of concerns, where controllers delegate complex operations to dedicated services and use serializers to format data consistently.

## Configuration
While no explicit configuration files are mentioned, the controllers use several parameters that could be considered configurable:

1. In `UsageController`:
   - `page` and `per_page`: Used for pagination in the `past` action.
   - `periods_count`: Determines the number of historical periods to retrieve.

These parameters could potentially be set through environment variables or configuration files to adjust the behavior of the API without changing the code.

## API/Interface Reference

1. Applied Coupons:
   - Endpoint: `/api/v1/customers/:customer_external_id/applied_coupons/:id`
   - Method: DELETE
   - Description: Terminates an applied coupon for a customer
   - Parameters:
     - `customer_external_id`: The external ID of the customer
     - `id`: The ID of the applied coupon to be terminated

2. Current Usage:
   - Endpoint: `/api/v1/customers/:customer_external_id/usage/current`
   - Method: GET
   - Description: Retrieves current usage for a customer and subscription
   - Parameters:
     - `customer_external_id`: External ID of the customer
     - `external_subscription_id`: External ID of the subscription

3. Past Usage:
   - Endpoint: `/api/v1/customers/:customer_external_id/usage/past`
   - Method: GET
   - Description: Retrieves historical usage data for a customer
   - Parameters:
     - `customer_external_id`: External ID of the customer
     - `external_subscription_id`: External ID of the subscription
     - `page`: Page number for pagination
     - `per_page`: Number of items per page
     - `billable_metric_code`: Code of the billable metric
     - `periods_count`: Number of periods to retrieve

These endpoints provide a comprehensive API for managing customer-related operations, particularly focusing on coupon management and usage tracking. The use of external IDs for customers and subscriptions suggests integration with external systems or a microservices architecture.

The controllers demonstrate good practices in API design, such as:
- RESTful endpoint structure
- Pagination support for large datasets
- Error handling and appropriate HTTP status codes
- Use of serializers for consistent data formatting

Overall, this directory contains well-structured controllers that provide essential functionality for customer management in what appears to be a subscription-based or usage-based billing system.