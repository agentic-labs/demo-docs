---
title: "charge_usage_serializer.rb"
---

## High-level description
The `ChargeUsageSerializer` class is responsible for serializing a collection of fee objects, grouping them by `charge_id`, and presenting the aggregated data in a structured JSON format. This serializer is used to display detailed usage information for charges within an invoice.

## Code Structure
The `ChargeUsageSerializer` inherits from `ModelSerializer` and overrides the `serialize` method. It utilizes several private helper methods (`groups`, `filters`, `grouped_usage`) to structure the output based on different grouping and filtering criteria.

## References
- `ModelSerializer`: The parent class providing basic serialization functionality.
- `BigDecimal`: Used for precise decimal arithmetic on unit values.

## Symbols

### `ChargeUsageSerializer`
#### Description
Serializes a collection of fee objects, grouping them by `charge_id`, and calculates aggregated metrics like total units, amount, and event counts. It also structures data for filters, groups, and grouped usage.

#### Inputs
The `ChargeUsageSerializer` doesn't explicitly define input parameters. It operates on the `model` attribute inherited from `ModelSerializer`, which is assumed to be a collection of fee objects.

#### Outputs
Returns an array of hashes. Each hash represents the aggregated data for a single `charge_id` and includes:
- `units`: Total units consumed.
- `events_count`: Total event count.
- `amount_cents`: Total amount in cents.
- `amount_currency`: Currency of the amount.
- `charge`: Details of the charge.
- `billable_metric`: Details of the billable metric.
- `filters`: An array of applied filters with their details.
- `groups`: An array of groups with their details (deprecated).
- `grouped_usage`: An array of grouped usage data.

#### Internal Logic
1. **Grouping by Charge ID:** Groups the fee objects by `charge_id`.
2. **Iterating and Aggregating:** Iterates through each group, extracting a representative `fee` and calculating aggregated values like total units, event counts, and amount.
3. **Structuring Output:** Constructs a hash for each `charge_id` containing:
    - Aggregated metrics.
    - Details of the charge, billable metric.
    - Data from `filters`, `groups`, and `grouped_usage` methods.
4. **Helper Methods:**
    - `groups`: Extracts group information from `charge_filter` (deprecated).
    - `filters`: Extracts filter information from `charge` and `charge_filter`.
    - `grouped_usage`: Processes and aggregates data based on the `grouped_by` attribute of fees.

### `groups`
#### Description
**(Deprecated)** Extracts grouping information from the `charge_filter` associated with each fee.

#### Inputs
- `fees`: An array of fee objects.

#### Outputs
Returns an array of hashes. Each hash represents a group and includes:
- `lago_id`: ID of the group.
- `key`: Comma-separated string of filter keys.
- `value`: Comma-separated string of filter values.
- `units`: Units consumed for this group.
- `amount_cents`: Amount in cents for this group.
- `events_count`: Event count for this group.

#### Internal Logic
1. **Sorting and Filtering:** Sorts fees by `charge_filter.display_name` and filters out those without a `charge_filter`.
2. **Extracting Group Data:** Extracts group information from the `charge_filter` and structures it into a hash.

### `filters`
#### Description
Extracts filter information from the `charge` and `charge_filter` associated with each fee.

#### Inputs
- `fees`: An array of fee objects.

#### Outputs
Returns an array of hashes. Each hash represents a filter and includes:
- `units`: Units consumed for this filter.
- `amount_cents`: Amount in cents for this filter.
- `events_count`: Event count for this filter.
- `invoice_display_name`: Display name of the filter.
- `values`: Key-value pairs representing the filter values.

#### Internal Logic
1. **Checking for Filters:** Returns an empty array if no filters are present.
2. **Sorting and Mapping:** Sorts fees by `charge_filter.display_name` and maps each fee to a hash containing filter details.

### `grouped_usage`
#### Description
Processes and aggregates usage data based on the `grouped_by` attribute of fees.

#### Inputs
- `fees`: An array of fee objects.

#### Outputs
Returns an array of hashes. Each hash represents a group of usage data and includes:
- `amount_cents`: Total amount in cents for the group.
- `events_count`: Total event count for the group.
- `units`: Total units consumed for the group.
- `grouped_by`: The grouping criteria.
- `filters`: Filter information for the group (using the `filters` method).
- `groups`: Group information for the group (using the `groups` method).

#### Internal Logic
1. **Checking for Grouped Data:** Returns an empty array if no fees have a `grouped_by` attribute.
2. **Grouping and Aggregating:** Groups fees by `grouped_by` and calculates aggregated metrics for each group.
3. **Structuring Output:** Constructs a hash for each group, including aggregated metrics, grouping criteria, and data from `filters` and `groups` methods.

## Dependencies
- `BigDecimal`: For precise decimal arithmetic.

## TODOs
- The `groups` method is marked as deprecated and should be removed after migrating to filters and refreshing the cache. 
