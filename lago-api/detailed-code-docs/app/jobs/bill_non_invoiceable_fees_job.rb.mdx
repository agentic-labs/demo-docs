---
title: "bill_non_invoiceable_fees_job.rb"
---

## High-level description
This code defines a background job class `BillNonInvoiceableFeesJob` that handles billing of non-invoiceable fees for given subscriptions at a specified billing time. It uses the `Invoices::AdvanceChargesService` to process the billing and raise any errors that occur during the process.

## Code Structure
The `BillNonInvoiceableFeesJob` class inherits from `ApplicationJob` and defines a single `perform` method that takes two parameters: `subscriptions` and `billing_at`. It uses the `Invoices::AdvanceChargesService` to handle the actual billing process.

## Symbols

### `BillNonInvoiceableFeesJob`
#### Description
This class represents a background job for billing non-invoiceable fees associated with subscriptions.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| subscriptions | Array | An array of subscription objects to be billed |
| billing_at | DateTime | The timestamp at which the billing should occur |

#### Internal Logic
1. The job is queued in the 'billing' queue.
2. It retries on `Sequenced::SequenceError` and `ActiveJob::DeserializationError`.
3. The `perform` method calls the `Invoices::AdvanceChargesService` with the provided subscriptions and billing time.
4. If an error occurs during the service call, it is raised.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| ApplicationJob | Base job class that this job inherits from |
| Invoices::AdvanceChargesService | Service used to process the billing of advance charges |

## Error Handling
The job is configured to retry on `Sequenced::SequenceError` and `ActiveJob::DeserializationError`. Any other errors raised by the `Invoices::AdvanceChargesService` will be propagated.

This job is part of a larger billing system and works in conjunction with other services and jobs to handle subscription billing, particularly for non-invoiceable fees that are paid in advance. It's typically called after other billing operations to ensure all fees are properly accounted for.