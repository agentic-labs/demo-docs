---
title: "retry_all_job.rb"
---

## High-level description
This code defines a background job class `RetryAllJob` within the `Invoices::Payments` module. Its purpose is to retry payments for a batch of invoices associated with a specific organization. The job is designed to be executed asynchronously, leveraging the `RetryBatchService` to process the payment retries.

## Code Structure
The `RetryAllJob` class inherits from `ApplicationJob` and is nested within the `Invoices::Payments` module. It defines a single method `perform` that calls the `RetryBatchService` to process the payment retries.

## References
- `Invoices::Payments::RetryBatchService`
- `ApplicationJob`

## Symbols

### `Invoices::Payments::RetryAllJob`
#### Description
This class represents a background job for retrying payments on a batch of invoices. It utilizes the `RetryBatchService` to process the retries and is queued in the 'invoices' queue.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| organization_id | Integer/String | The ID of the organization associated with the invoices |
| invoice_ids | Array | An array of invoice IDs to be processed for payment retry |

#### Internal Logic
1. The job is enqueued in the 'invoices' queue using `queue_as 'invoices'`.
2. The `perform` method is called with the required parameters.
3. It instantiates a new `RetryBatchService` with the given `organization_id`.
4. The `call` method of the service is invoked with the `invoice_ids`.
5. If the service call results in an error, an exception is raised using `raise_if_error!`.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| ActiveJob | Provides the base class `ApplicationJob` for background job processing |

## Error Handling
The job relies on the `raise_if_error!` method of the `RetryBatchService` result object to handle and propagate any errors that occur during the payment retry process.

## Performance Considerations
This job is designed to be run asynchronously, which helps in offloading the potentially time-consuming task of retrying payments for multiple invoices from the main application thread. This approach can improve the overall responsiveness of the application.

## Related Information
From the related code snippets, we can infer:

1. The `RetryBatchService` is responsible for the actual logic of retrying payments for invoices. It processes invoices in batches and uses `RetryService` for individual invoice payment retries.

2. The `RetryBatchService` has a `call_async` method that enqueues this `RetryAllJob`, suggesting that this job can be triggered as part of a larger asynchronous process.

3. The job inherits from `ApplicationJob`, which sets Sidekiq options to not retry failed jobs (`retry: 0`). This means that if the job fails, it won't be automatically retried by Sidekiq.

4. The associated spec file for `RetryBatchService` provides insight into the expected behavior and error handling of the service that this job relies on.

This job serves as a crucial part of the invoice payment retry system, acting as the entry point for asynchronous batch processing of payment retries.