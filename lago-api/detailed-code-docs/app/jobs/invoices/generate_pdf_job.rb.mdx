---
title: "generate_pdf_job.rb"
---

## High-level description
This code defines a background job class `GeneratePdfJob` within the `Invoices` module. Its primary purpose is to generate PDF files for invoices asynchronously, utilizing Sidekiq for job processing and implementing error handling and retry mechanisms.

## Code Structure
The `GeneratePdfJob` class inherits from `ApplicationJob` and defines the queue to use, retry behavior, and the main `perform` method.

## Symbols

### `Invoices::GeneratePdfJob`
#### Description
This class is responsible for generating PDF files for invoices asynchronously. It determines the appropriate queue based on environment variables and implements retry logic for HTTP errors.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| invoice | Invoice | The invoice object for which the PDF needs to be generated |

#### Internal Logic
1. Determines the queue to use based on the `SIDEKIQ_PDFS` environment variable.
2. Sets up retry behavior for `LagoHttpClient::HttpError`.
3. Calls the `Invoices::GeneratePdfService` to generate the PDF.
4. Raises an error if the PDF generation fails.

### `queue_as`
#### Description
This method determines which queue the job should be processed in based on the `SIDEKIQ_PDFS` environment variable.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| queue_name | Symbol | The name of the queue to use (`:pdfs` or `:invoices`) |

#### Internal Logic
- If `SIDEKIQ_PDFS` is set to a truthy value, it returns `:pdfs`.
- Otherwise, it returns `:invoices`.

### `perform(invoice)`
#### Description
This method is the main entry point for the job. It calls the `Invoices::GeneratePdfService` to generate the PDF for the given invoice.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| invoice | Invoice | The invoice object for which the PDF needs to be generated |

#### Internal Logic
1. Calls `Invoices::GeneratePdfService.call` with the invoice and context set to 'api'.
2. Raises an error if the PDF generation fails.

## Error Handling
The job implements retry logic for `LagoHttpClient::HttpError` using `retry_on`, with polynomial backoff and up to 6 attempts.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| ActiveModel::Type::Boolean | Used to cast the `SIDEKIQ_PDFS` environment variable to a boolean |
| Invoices::GeneratePdfService | Service class responsible for generating the PDF |

## Configuration
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| SIDEKIQ_PDFS | Boolean | N/A | Determines which queue to use for PDF generation jobs |

## Performance Considerations
The use of background job processing allows for asynchronous PDF generation, which can improve the responsiveness of the main application by offloading this potentially time-consuming task.