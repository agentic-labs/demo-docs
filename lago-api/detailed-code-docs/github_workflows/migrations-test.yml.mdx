---
title: "migrations-test.yml"
---

## High-level description
This GitHub Actions workflow, named "Run rails migrations", is designed to run database migrations for a Rails application. It is triggered on pushes to the main branch and on pull request events. The workflow sets up the necessary environment, including PostgreSQL and ClickHouse databases, and runs migrations for both databases.

## Code Structure
The workflow consists of a single job named "run-migrations" with multiple steps that set up the environment, install dependencies, and run the migrations.

## Symbols

### `run-migrations` (job)
#### Description
This job sets up the environment and runs the database migrations for both PostgreSQL and ClickHouse.

#### Internal Logic
1. Sets up a PostgreSQL service container
2. Configures environment variables
3. Checks out the code
4. Installs Ruby and gems
5. Starts a ClickHouse database container
6. Generates RSA keys
7. Performs PostgreSQL migrations
8. Dumps and compares the database schema
9. Performs ClickHouse migrations

### Environment Variables
#### Description
The job sets up various environment variables needed for the application and database connections.

| Name | Description |
|:-----|:------------|
| RAILS_ENV | Set to "test" for the test environment |
| DATABASE_URL | PostgreSQL connection URL |
| RAILS_MASTER_KEY | Rails master key (from secrets) |
| SECRET_KEY_BASE | Secret key base (from secrets) |
| ENCRYPTION_* | Encryption-related keys and salt |
| LAGO_* | Various Lago-specific configuration variables |

### Steps
#### Description
The job consists of several steps that set up the environment and run the migrations.

1. **Checkout code**: Uses `actions/checkout@v4` to fetch the repository code.
2. **Install Ruby and gems**: Uses `ruby/setup-ruby@v1` to install Ruby 3.3.4 and cache the gems.
3. **Start Clickhouse database**: Runs a ClickHouse container using Docker.
4. **Generate RSA keys**: Executes a script to generate RSA keys.
5. **Move db schema for comparison**: Renames the current schema file for later comparison.
6. **Perform Postgres database migrations**: Runs PostgreSQL migrations using `bin/rails db:migrate:primary`.
7. **dump schema**: Generates a new schema dump.
8. **Ensure no changes to schema.rb**: Compares the new schema dump with the original to ensure no unexpected changes.
9. **Perform Clickhouse database migrations**: Runs ClickHouse migrations using `bin/rails db:migrate:clickhouse`.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| postgres:14-alpine | PostgreSQL database service |
| clickhouse/clickhouse-server | ClickHouse database service |
| actions/checkout@v4 | Checking out the repository code |
| ruby/setup-ruby@v1 | Setting up Ruby environment |

## Configuration
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| LAGO_CLICKHOUSE_ENABLED | boolean | true | Enables ClickHouse functionality |
| LAGO_CLICKHOUSE_MIGRATIONS_ENABLED | boolean | true | Enables ClickHouse migrations |
| LAGO_DISABLE_SCHEMA_DUMP | boolean | true | Disables schema dumping (temporarily set to empty string for dumping) |

This workflow is designed to ensure that database migrations are run successfully and that the schema remains consistent. It includes steps for both PostgreSQL and ClickHouse databases, reflecting a multi-database setup in the application. The workflow also includes a schema comparison step to catch any unexpected changes in the database schema.