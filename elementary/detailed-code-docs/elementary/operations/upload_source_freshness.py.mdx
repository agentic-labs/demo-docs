---
title: "upload_source_freshness.py"
---

## High-level description
The `UploadSourceFreshnessOperation` class in `upload_source_freshness.py` handles the process of uploading dbt source freshness results to Elementary's data warehouse. This allows Elementary to monitor data freshness and generate alerts based on the results.

## Code Structure
The `UploadSourceFreshnessOperation` class is responsible for orchestrating the upload process. It interacts with the `Config` class to access configuration settings, reads source freshness results from a JSON file, and utilizes the `create_dbt_runner` factory function to execute dbt operations.

## References
- `elementary.clients.dbt.factory.create_dbt_runner`: Used to create a dbt runner instance for executing dbt operations.
- `elementary.config.config.Config`: Provides access to configuration settings.
- `elementary.monitor.dbt_project_utils`: Offers utility functions for interacting with dbt projects.
- `elementary.utils.ordered_yaml.OrderedYaml`: Used for loading and dumping YAML files with preserved order.

## Symbols

### `UploadSourceFreshnessOperation`
#### Description
This class manages the upload of dbt source freshness results to Elementary's schema.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| config | elementary.config.config.Config | An instance of the `Config` class containing configuration settings. |

#### Internal Logic
The `run` method orchestrates the upload process:
1. **Retrieves source freshness results:** Calls `get_sources_file_contents` to read the `sources.json` file generated by `dbt source freshness`.
2. **Uploads results:** Invokes `upload_results` to upload the results to Elementary's schema.

The `get_sources_file_contents` method locates and loads the `sources.json` file containing the source freshness results.

The `upload_results` method performs the following steps:
1. **Creates a dbt runner:** Uses `create_dbt_runner` to instantiate a dbt runner.
2. **Checks for existing uploads:** Executes a dbt operation to determine if results for the given invocation ID have already been uploaded.
3. **Uploads results in chunks:** Iterates over the results in chunks, adding metadata to each result and uploading them using the `elementary_cli.upload_source_freshness` dbt operation.

The `get_target_path` method determines the target path for the dbt project, either from the `DBT_TARGET_PATH` environment variable or from the `dbt_project.yml` file.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| click | Used for command-line interface interaction. |
| alive-progress | Provides a progress bar for the upload process. |
| json | Enables JSON encoding and decoding. |
| os | Used for interacting with the operating system, such as retrieving environment variables. |
| pathlib | Provides an object-oriented way to interact with the file system. |

## Error Handling
The code raises `click.ClickException` for various error conditions, such as missing configuration values, inability to locate the `sources.json` file, or if source freshness results for a given invocation ID have already been uploaded.
