---
title: "get_models_latest_invocations_data.sql"
---

## High-level description
This macro, `get_models_latest_invocations_data()`, retrieves the latest invocation data for dbt models. It joins run results with model information, identifies the most recent invocations, and returns relevant details about these invocations.

## Symbols

### get_models_latest_invocations_data
#### Description
This macro fetches the latest invocation data for dbt models by joining run results with model information and then selecting the most recent invocations.

#### Inputs
This macro doesn't have any explicit inputs.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | List[Dict] | A list of dictionaries containing the latest invocation data for each model |

#### Internal Logic
1. Sets up references to the `dbt_invocations` and `dbt_run_results` tables.
2. Checks if the `job_url` column exists in the `dbt_invocations` table.
3. Constructs a SQL query that:
   a. Joins `dbt_run_results` with `dbt_models` and ranks the results by generation time.
   b. Selects the most recent invocation for each unique model.
   c. Joins this result with the `dbt_invocations` table to get invocation details.
4. Executes the constructed query.
5. Converts the query result to a list of dictionaries and returns it.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| elementary | Used for utility functions like `column_exists_in_relation`, `run_query`, and `agate_to_dicts` |
| dbt | Implied usage of dbt's `ref` function for referencing tables |

## References
This macro references the following tables:
- `elementary.dbt_invocations`
- `elementary.dbt_run_results`
- `elementary.dbt_models`

## Configuration
The macro adapts its behavior based on the presence of the `job_url` column:
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| job_url | column | N/A | If present in the `dbt_invocations` table, it's included in the output |

## Performance Considerations
The macro uses window functions (`row_number()`) to efficiently identify the latest invocations for each model, which can be performance-intensive for large datasets. The `distinct` operation in the `latest_models_invocations` CTE helps to reduce the data volume for the final join.