---
title: "get_result_rows_agate.sql"
---

## High-level description
This SQL macro, `get_result_rows_agate`, retrieves test result rows from the `elementary.test_result_rows` table. It filters the results based on a specified number of days back and optionally by a set of valid IDs. The macro returns the results grouped by the `elementary_test_results_id`.

## Symbols

### `get_result_rows_agate`
#### Description
This macro constructs and executes a SQL query to fetch test result rows from the `elementary.test_result_rows` table. It filters the results based on the detection date and optionally by a set of valid IDs.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| days_back | Integer | The number of days to look back for test results |
| valid_ids_query | String (optional) | A query that returns a set of valid `elementary_test_results_id` values |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | Agate table | A grouped Agate table containing `elementary_test_results_id` and `result_row` columns |

#### Internal Logic
1. Constructs a SQL query using Jinja templating:
   - Selects `elementary_test_results_id` and `result_row` from the `elementary.test_result_rows` table.
   - Filters results to include only those detected within the specified number of days back.
   - If a `valid_ids_query` is provided, further filters results to include only the specified IDs.
2. Executes the constructed query using `elementary.run_query()`.
3. Groups the results by `elementary_test_results_id` using the `.group_by()` method.
4. Returns the grouped Agate table.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| elementary | Used for various utility functions and table references |

## References
- `elementary.test_result_rows`: Referenced table for querying test result rows.
- `elementary.edr_datediff`: Function used for date difference calculation.
- `elementary.edr_cast_as_timestamp`: Function used to cast 'detected_at' to timestamp.
- `elementary.edr_current_timestamp`: Function to get the current timestamp.
- `elementary.run_query`: Function used to execute the constructed SQL query.

## Notes
- The macro uses Jinja templating to construct a dynamic SQL query.
- The `valid_ids_query` parameter allows for optional filtering of results based on specific test result IDs.
- The result is returned as an Agate table, which is a data structure provided by the Agate library for tabular data manipulation.