---
title: "test_dbt_runner.py"
---

## High-level description
This file contains unit tests for the `BaseDbtRunner`, `SubprocessDbtRunner`, and `APIDbtRunner` classes. It tests various dbt commands such as run_operation, ls, seed, run, and test, ensuring that these runners correctly interact with dbt and handle the results appropriately.

## Code Structure
The code defines a base test class `BaseDbtRunnerTest` with common test methods, which is then inherited by `TestSubprocessDbtRunner` and `TestAPIDbtRunner`. Each test class uses a specific dbt runner implementation.

## Symbols

### `BaseDbtRunnerTest`
#### Description
A base class containing test methods for dbt runners. It defines tests for various dbt commands and utility methods.

#### Internal Logic
- Tests run_operation, ls, seed, run, and test commands
- Verifies the output and side effects of these commands
- Uses a helper method `_run_query` to execute SQL queries through dbt

### `TestSubprocessDbtRunner`
#### Description
A test class for the `SubprocessDbtRunner`, inheriting from `BaseDbtRunnerTest`.

#### Internal Logic
- Defines a fixture `custom_dbt_runner` that creates a `SubprocessDbtRunner` instance for testing

### `TestAPIDbtRunner`
#### Description
A test class for the `APIDbtRunner`, inheriting from `BaseDbtRunnerTest`.

#### Internal Logic
- Defines a fixture `custom_dbt_runner` that creates an `APIDbtRunner` instance for testing

### `test_run_operation`
#### Description
Tests the `run_operation` method of the dbt runner.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| custom_dbt_runner | BaseDbtRunner | The dbt runner instance to test |

#### Internal Logic
- Runs a dummy macro and verifies the output

### `test_ls`
#### Description
Tests the `ls` method of the dbt runner.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| custom_dbt_runner | BaseDbtRunner | The dbt runner instance to test |

#### Internal Logic
- Calls the `ls` method and checks if the result is a list containing expected items

### `test_seed`
#### Description
Tests the `seed` method of the dbt runner.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| custom_dbt_runner | BaseDbtRunner | The dbt runner instance to test |

#### Internal Logic
- Runs the seed command for a specific model and checks if it succeeds

### `test_run`
#### Description
Tests the `run` method of the dbt runner.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| custom_dbt_runner | BaseDbtRunner | The dbt runner instance to test |

#### Internal Logic
- Runs a specific model with a unique test marker
- Verifies the invocation details in the dbt_invocations table
- Tests both successful and failing model runs

### `test_test`
#### Description
Tests the `test` method of the dbt runner.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| custom_dbt_runner | BaseDbtRunner | The dbt runner instance to test |

#### Internal Logic
- Runs tests for a specific model with a unique test marker
- Verifies the invocation details in the dbt_invocations table

### `_run_query`
#### Description
A helper method to run SQL queries through dbt.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| dbt_runner | SubprocessDbtRunner | The dbt runner instance to use |
| query | str | The SQL query to execute |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | list | The query results as a list of dictionaries |

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| pytest | Testing framework |
| elementary.clients.dbt.api_dbt_runner | APIDbtRunner implementation |
| elementary.clients.dbt.base_dbt_runner | BaseDbtRunner abstract base class |
| elementary.clients.dbt.subprocess_dbt_runner | SubprocessDbtRunner implementation |

## Error Handling
The tests use assertions to verify the expected behavior of the dbt runners. If any assertion fails, the test will fail, indicating an issue with the dbt runner implementation or the test setup.