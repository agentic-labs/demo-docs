---
title: "conftest.py"
---

## High-level description
This code defines pytest fixtures and configuration for running integration tests with a dbt project. It sets up the test environment, handles test skipping based on targets and dbt versions, and provides utilities for managing the test project directory and dbt runner.

## Code Structure
The main components of this code are pytest fixtures and configuration functions. These fixtures are used to set up the test environment, manage the dbt project directory, and provide a dbt runner for executing commands. The code also includes custom pytest markers for skipping tests based on specific conditions.

## Symbols

### `pytest_addoption`
#### Description
This function adds custom command-line options to pytest for specifying the target database and skipping initialization.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| parser | pytest.Parser | The pytest command-line options parser |

### `project_dir_copy`
#### Description
This fixture creates a temporary copy of the dbt project directory for testing and cleans it up after the tests are complete.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| dbt_project_copy_dir | str | Path to the temporary dbt project directory |

### `init_tests_env`
#### Description
This fixture initializes the test environment using the provided dbt runner, unless the `--skip-init` option is specified.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| dbt_runner | SubprocessDbtRunner | The dbt runner instance |
| skip_init | bool | Flag to skip initialization |

### `skip_by_targets`
#### Description
This fixture skips tests based on the `skip_targets` marker and the current target database.

### `only_on_targets`
#### Description
This fixture runs tests only on specified targets based on the `only_on_targets` marker.

### `requires_dbt_version`
#### Description
This fixture skips tests that require a specific dbt version if the installed version is lower than required.

### `target`
#### Description
This fixture returns the target database specified by the `--target` command-line option.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| target | str | The target database name |

### `dbt_runner`
#### Description
This fixture creates and returns a `SubprocessDbtRunner` instance for running dbt commands.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| dbt_runner | SubprocessDbtRunner | The dbt runner instance |

### `skip_init`
#### Description
This fixture returns the value of the `--skip-init` command-line option.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| skip_init | bool | Flag to skip initialization |

### `test_id`
#### Description
This fixture generates a unique test ID based on the test class and function name.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| test_id | str | Unique test identifier |

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| pytest | Testing framework |
| dbt | Data build tool for running SQL transformations |
| elementary | Custom library for dbt-related functionality |

## Configuration
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| --target | str | "postgres" | Specifies the target database for tests |
| --skip-init | bool | False | Flag to skip test environment initialization |

## Error Handling
The code uses pytest's built-in error handling and test skipping mechanisms. Custom exceptions are not explicitly handled in this file.

## Performance Considerations
The `project_dir_copy` fixture creates a temporary copy of the dbt project for each test session, which may have performance implications for large projects or numerous test runs.