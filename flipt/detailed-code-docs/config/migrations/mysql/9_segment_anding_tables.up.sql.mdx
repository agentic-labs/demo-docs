---
title: "9_segment_anding_tables.up.sql"
---

## High-level description
This SQL script creates two new tables: `rule_segments` and `rollout_segment_references`. These tables are designed to establish relationships between rules and segments, and rollout segments and segments, respectively. The script also populates these new tables with existing data from the `rules` and `rollout_segments` tables.

## Symbols

### `rule_segments` table
#### Description
This table establishes a many-to-many relationship between rules and segments.

#### Columns
| Name | Type | Description |
|:-----|:-----|:------------|
| rule_id | VARCHAR(255) | The ID of the rule |
| namespace_key | VARCHAR(255) | The namespace key of the segment |
| segment_key | VARCHAR(255) | The key of the segment |

#### Constraints
- A unique constraint `rule_id_namespace_segment` is applied to the combination of `rule_id`, `namespace_key`, and `segment_key`.
- Foreign key constraint on `rule_id` referencing the `rules` table.
- Foreign key constraint on `(namespace_key, segment_key)` referencing the `segments` table.

#### Internal Logic
After creating the table, it is populated with data from the `rules` table using an INSERT statement.

### `rollout_segment_references` table
#### Description
This table establishes a many-to-many relationship between rollout segments and segments.

#### Columns
| Name | Type | Description |
|:-----|:-----|:------------|
| rollout_segment_id | VARCHAR(255) | The ID of the rollout segment |
| namespace_key | VARCHAR(255) | The namespace key of the segment |
| segment_key | VARCHAR(255) | The key of the segment |

#### Constraints
- A unique constraint `rollout_segment_id_namespace_segment` is applied to the combination of `rollout_segment_id`, `namespace_key`, and `segment_key`.
- Foreign key constraint on `rollout_segment_id` referencing the `rollout_segments` table.
- Foreign key constraint on `(namespace_key, segment_key)` referencing the `segments` table.

#### Internal Logic
After creating the table, it is populated with data from the `rollout_segments` table using an INSERT statement.

## References
This script references the following existing tables:
- `rules`
- `segments`
- `rollout_segments`

## Dependencies
This script is designed for MySQL databases, as indicated by the file name.

## Error Handling
The script uses `IF NOT EXISTS` clauses when creating tables to prevent errors if the tables already exist. Foreign key constraints ensure referential integrity and will prevent the insertion of invalid data.

## Performance Considerations
The INSERT statements that populate the new tables may take some time to execute, depending on the amount of data in the `rules` and `rollout_segments` tables. For large datasets, it might be advisable to run this migration during a maintenance window.