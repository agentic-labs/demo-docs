---
title: "namespace_test.go"
---

## High-level description
The file `namespace_test.go` within the `internal/server` package contains unit tests for the namespace-related functionality of the Flipt server. It covers functions like creating, retrieving, updating, deleting, and listing namespaces.

## References
This file references the following symbols from other parts of the codebase:
- `common.StoreMock`: A mock implementation of the storage interface used for testing.
- `flipt.Namespace`: The Protobuf message definition for a namespace.
- `storage.NewNamespace`: A function to create a new namespace object.
- `storage.ListWithOptions`: A function to create list options for storage operations.
- `storage.ReferenceRequest`: A struct representing a request for a reference.

## Symbols
### `TestGetNamespace`
#### Description
Tests the `GetNamespace` function of the server. It verifies that the function correctly retrieves a namespace from the store using a provided key.

#### Inputs
This test function does not take any specific inputs. It uses a predefined `flipt.GetNamespaceRequest` with a key "foo".

#### Outputs
This test function does not return any values. It uses assertions to verify the expected behavior of the `GetNamespace` function.

#### Internal Logic
- **Arrange:**
    - Creates a mock store and sets up an expected call to `GetNamespace` with the key "foo".
    - Creates a new server instance with the mock store and a test logger.
    - Defines a `flipt.GetNamespaceRequest` with the key "foo".
- **Act:**
    - Calls the `GetNamespace` function of the server with the request.
- **Assert:**
    - Asserts that there is no error returned from the function.
    - Asserts that the returned namespace is not nil.
    - Asserts that the key of the returned namespace is "foo".

### `TestListNamespaces_PaginationOffset`
#### Description
Tests the pagination functionality of the `ListNamespaces` function when using an offset. It verifies that the function correctly retrieves a paginated list of namespaces from the store using the provided offset.

#### Inputs
This test function does not take any specific inputs. It uses a predefined `flipt.ListNamespaceRequest` with an offset of 10.

#### Outputs
This test function does not return any values. It uses assertions to verify the expected behavior of the `ListNamespaces` function.

#### Internal Logic
- **Arrange:**
    - Creates a mock store and sets up expected calls to `ListNamespaces` and `CountNamespaces`.
    - Creates a new server instance with the mock store and a test logger.
- **Act:**
    - Calls the `ListNamespaces` function of the server with a request containing an offset of 10.
- **Assert:**
    - Asserts that there is no error returned from the function.
    - Asserts that the returned list of namespaces is not empty.
    - Asserts that the next page token in the response is "YmFy".
    - Asserts that the total count of namespaces is 1.

### `TestListNamespaces_PaginationPageToken`
#### Description
Tests the pagination functionality of the `ListNamespaces` function when using a page token. It verifies that the function correctly retrieves a paginated list of namespaces from the store using the provided page token.

#### Inputs
This test function does not take any specific inputs. It uses a predefined `flipt.ListNamespaceRequest` with a page token "Zm9v" and an offset of 10.

#### Outputs
This test function does not return any values. It uses assertions to verify the expected behavior of the `ListNamespaces` function.

#### Internal Logic
- **Arrange:**
    - Creates a mock store and sets up expected calls to `ListNamespaces` and `CountNamespaces`.
    - Creates a new server instance with the mock store and a test logger.
- **Act:**
    - Calls the `ListNamespaces` function of the server with a request containing a page token "Zm9v" and an offset of 10.
- **Assert:**
    - Asserts that there is no error returned from the function.
    - Asserts that the returned list of namespaces is not empty.
    - Asserts that the next page token in the response is "YmFy".
    - Asserts that the total count of namespaces is 1.

### `TestCreateNamespace`
#### Description
Tests the `CreateNamespace` function of the server. It verifies that the function correctly creates a new namespace in the store using the provided request data.

#### Inputs
This test function does not take any specific inputs. It uses a predefined `flipt.CreateNamespaceRequest` with key "foo", name "name", and description "desc".

#### Outputs
This test function does not return any values. It uses assertions to verify the expected behavior of the `CreateNamespace` function.

#### Internal Logic
- **Arrange:**
    - Creates a mock store and sets up an expected call to `CreateNamespace` with the request data.
    - Creates a new server instance with the mock store and a test logger.
    - Defines a `flipt.CreateNamespaceRequest` with key "foo", name "name", and description "desc".
- **Act:**
    - Calls the `CreateNamespace` function of the server with the request.
- **Assert:**
    - Asserts that there is no error returned from the function.
    - Asserts that the returned namespace is not nil.

### `TestUpdateNamespace`
#### Description
Tests the `UpdateNamespace` function of the server. It verifies that the function correctly updates an existing namespace in the store using the provided request data.

#### Inputs
This test function does not take any specific inputs. It uses a predefined `flipt.UpdateNamespaceRequest` with key "foo", name "name", and description "desc".

#### Outputs
This test function does not return any values. It uses assertions to verify the expected behavior of the `UpdateNamespace` function.

#### Internal Logic
- **Arrange:**
    - Creates a mock store and sets up an expected call to `UpdateNamespace` with the request data.
    - Creates a new server instance with the mock store and a test logger.
    - Defines a `flipt.UpdateNamespaceRequest` with key "foo", name "name", and description "desc".
- **Act:**
    - Calls the `UpdateNamespace` function of the server with the request.
- **Assert:**
    - Asserts that there is no error returned from the function.
    - Asserts that the returned namespace is not nil.

### `TestDeleteNamespace`
#### Description
Tests the `DeleteNamespace` function of the server. It verifies that the function correctly deletes an existing namespace from the store using the provided key.

#### Inputs
This test function does not take any specific inputs. It uses a predefined `flipt.DeleteNamespaceRequest` with the key "foo".

#### Outputs
This test function does not return any values. It uses assertions to verify the expected behavior of the `DeleteNamespace` function.

#### Internal Logic
- **Arrange:**
    - Creates a mock store and sets up expected calls to `GetNamespace`, `CountFlags`, and `DeleteNamespace`.
    - Creates a new server instance with the mock store and a test logger.
    - Defines a `flipt.DeleteNamespaceRequest` with the key "foo".
- **Act:**
    - Calls the `DeleteNamespace` function of the server with the request.
- **Assert:**
    - Asserts that there is no error returned from the function.
    - Asserts that the returned response is not nil.

### `TestDeleteNamespace_NonExistent`
#### Description
Tests the `DeleteNamespace` function of the server when attempting to delete a namespace that does not exist. It verifies that the function does not return an error in this case.

#### Inputs
This test function does not take any specific inputs. It uses a predefined `flipt.DeleteNamespaceRequest` with the key "foo".

#### Outputs
This test function does not return any values. It uses assertions to verify the expected behavior of the `DeleteNamespace` function.

#### Internal Logic
- **Arrange:**
    - Creates a mock store and sets up an expected call to `GetNamespace` that returns a nil namespace.
    - Creates a new server instance with the mock store and a test logger.
    - Defines a `flipt.DeleteNamespaceRequest` with the key "foo".
- **Act:**
    - Calls the `DeleteNamespace` function of the server with the request.
- **Assert:**
    - Asserts that there is no error returned from the function.
    - Asserts that the `CountFlags` and `DeleteNamespace` functions of the mock store were not called.
    - Asserts that the returned response is not nil.

### `TestDeleteNamespace_Protected`
#### Description
Tests the `DeleteNamespace` function of the server when attempting to delete a protected namespace. It verifies that the function returns an error in this case.

#### Inputs
This test function does not take any specific inputs. It uses a predefined `flipt.DeleteNamespaceRequest` with the key "foo".

#### Outputs
This test function does not return any values. It uses assertions to verify the expected behavior of the `DeleteNamespace` function.

#### Internal Logic
- **Arrange:**
    - Creates a mock store and sets up expected calls to `GetNamespace` and `CountFlags`.
    - Creates a new server instance with the mock store and a test logger.
    - Defines a `flipt.DeleteNamespaceRequest` with the key "foo".
- **Act:**
    - Calls the `DeleteNamespace` function of the server with the request.
- **Assert:**
    - Asserts that the function returns an error with the message "namespace \"foo\" is protected".
    - Asserts that the `DeleteNamespace` function of the mock store was not called.
    - Asserts that the returned response is nil.

### `TestDeleteNamespace_HasFlags`
#### Description
Tests the `DeleteNamespace` function of the server when attempting to delete a namespace that contains flags. It verifies that the function returns an error in this case.

#### Inputs
This test function does not take any specific inputs. It uses a predefined `flipt.DeleteNamespaceRequest` with the key "foo".

#### Outputs
This test function does not return any values. It uses assertions to verify the expected behavior of the `DeleteNamespace` function.

#### Internal Logic
- **Arrange:**
    - Creates a mock store and sets up expected calls to `GetNamespace` and `CountFlags`.
    - Creates a new server instance with the mock store and a test logger.
    - Defines a `flipt.DeleteNamespaceRequest` with the key "foo".
- **Act:**
    - Calls the `DeleteNamespace` function of the server with the request.
- **Assert:**
    - Asserts that the function returns an error with the message "namespace \"foo\" cannot be deleted; flags must be deleted first".
    - Asserts that the `DeleteNamespace` function of the mock store was not called.
    - Asserts that the returned response is nil.
