---
title: "grpc.go"
---

## High-level description
The `grpc.go` file in the `internal/server/authn/method/oidc/testing` package provides utilities for testing the OIDC authentication method in Flipt using a GRPC server. It sets up an in-memory store, starts a GRPC server with the OIDC authentication service registered, and provides a client for interacting with the server.

## Code Structure
The `StartGRPCServer` function initializes a new GRPC server, registers the OIDC authentication service, and starts it in a separate goroutine. The `GRPCServer` struct holds references to the server, client connection, and in-memory store. The `Client` method on the `GRPCServer` struct returns a client for interacting with the OIDC authentication service.

## Symbols
### `GRPCServer`
#### Description
The `GRPCServer` struct represents a GRPC server used for testing the OIDC authentication method. It holds references to the underlying GRPC server, a client connection for making requests, an in-memory store for authentication data, and an error channel for capturing server errors.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Client() | `auth.AuthenticationMethodOIDCServiceClient` | Returns a client for interacting with the OIDC authentication service. |

### `StartGRPCServer`
#### Description
The `StartGRPCServer` function initializes and starts a new GRPC server for testing the OIDC authentication method. It creates an in-memory store, sets up a listener, creates a GRPC server with error interceptors, registers the OIDC authentication service, and starts the server in a separate goroutine. It also establishes a client connection to the server and returns a `GRPCServer` instance.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| t | `*testing.T` | The testing object. |
| ctx | `context.Context` | The context for the server. |
| logger | `*zap.Logger` | The logger instance. |
| conf | `config.AuthenticationConfig` | The authentication configuration. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `*GRPCServer` | `*GRPCServer` | A pointer to the initialized `GRPCServer` instance. |

#### Internal Logic
1. **Initialize:** Create an in-memory store, a bufconn listener, and a GRPC server with error interceptors.
2. **Register Service:** Register the OIDC authentication service with the GRPC server.
3. **Start Server:** Start the GRPC server in a separate goroutine.
4. **Create Client:** Establish a client connection to the server using the bufconn listener.
5. **Return Server:** Return the initialized `GRPCServer` instance.

### `(*GRPCServer) Stop`
#### Description
The `Stop` method stops the running GRPC server and closes the client connection. It ensures the server is stopped gracefully and returns any errors encountered during the process.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `error` | `error` | An error object indicating any issues encountered while stopping the server. |

#### Internal Logic
1. **Close Client:** Close the client connection to the server.
2. **Stop Server:** Stop the GRPC server.
3. **Return Error:** Return any error received from the server's error channel.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| `context` | Provides a mechanism for carrying request-scoped values and cancellation signals. |
| `net` | Provides network-related functionalities. |
| `testing` | Provides testing-related functionalities. |
| `github.com/grpc-ecosystem/go-grpc-middleware` | Provides GRPC middleware for intercepting requests and responses. |
| `github.com/stretchr/testify/require` | Provides testing assertions. |
| `go.flipt.io/flipt/internal/config` | Provides access to Flipt's configuration. |
| `go.flipt.io/flipt/internal/server/authn/method/oidc` | Provides the OIDC authentication method implementation. |
| `go.flipt.io/flipt/internal/server/middleware/grpc` | Provides GRPC middleware specific to Flipt's server. |
| `go.flipt.io/flipt/internal/storage/authn/memory` | Provides an in-memory store for authentication data. |
| `go.flipt.io/flipt/rpc/flipt/auth` | Provides the GRPC definitions for authentication services. |
| `go.uber.org/zap` | Provides a structured logging library. |
| `google.golang.org/grpc` | Provides the GRPC framework. |
| `google.golang.org/grpc/test/bufconn` | Provides a buffered connection type for testing GRPC services. |

