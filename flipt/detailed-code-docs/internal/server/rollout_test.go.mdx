---
title: "rollout_test.go"
---

## High-level description
The `rollout_test.go` file contains unit tests for the rollout-related functionality of the Flipt server. It covers functions for getting, listing, creating, updating, deleting, and ordering rollouts.

## References
This file references the following symbols from other parts of the codebase:

* `flipt.GetRolloutRequest`: Represents a request to retrieve a rollout.
* `flipt.Rollout`: Represents a rollout entity.
* `flipt.ListRolloutRequest`: Represents a request to list rollouts.
* `flipt.CreateRolloutRequest`: Represents a request to create a new rollout.
* `flipt.UpdateRolloutRequest`: Represents a request to update an existing rollout.
* `flipt.DeleteRolloutRequest`: Represents a request to delete a rollout.
* `flipt.OrderRolloutsRequest`: Represents a request to order rollouts.
* `common.StoreMock`: A mock implementation of the storage interface.
* `storage.NewNamespace`: Creates a new namespace object.
* `storage.ListWithOptions`: Creates a new list options object.
* `storage.NewResource`: Creates a new resource object.
* `storage.WithPageToken`: Creates a new page token option.
* `storage.WithReference`: Creates a new reference option.

## Symbols

### `TestGetRollout`
#### Description
Tests the `GetRollout` function of the server. It verifies that the function correctly retrieves a rollout from the store using a mock store implementation.

#### Internal Logic
1. **Arrange:**
    * Creates a mock store and sets up an expectation for the `GetRollout` method to return a predefined rollout.
    * Creates a new server instance with the mock store and a test logger.
    * Creates a `GetRolloutRequest` with sample data.
2. **Act:**
    * Calls the `GetRollout` function on the server with the request.
3. **Assert:**
    * Asserts that the function returns no error.
    * Asserts that the returned rollout is not nil.

### `TestListRollouts_PaginationPageToken`
#### Description
Tests the `ListRollouts` function of the server, specifically focusing on pagination using page tokens. It verifies that the function correctly retrieves a list of rollouts from the store with the specified page token and returns the next page token.

#### Internal Logic
1. **Arrange:**
    * Creates a mock store and sets up expectations for the `ListRollouts` and `CountRollouts` methods to return predefined data, including a next page token.
    * Creates a new server instance with the mock store and a test logger.
2. **Act:**
    * Calls the `ListRollouts` function on the server with a `ListRolloutRequest` containing a sample flag key and a page token.
3. **Assert:**
    * Asserts that the function returns no error.
    * Asserts that the returned rollout list is not empty.
    * Asserts that the returned next page token matches the predefined value.
    * Asserts that the returned total count matches the predefined value.

### `TestCreateRollout`
#### Description
Tests the `CreateRollout` function of the server. It verifies that the function correctly creates a new rollout in the store using a mock store implementation. The test covers different types of rollout rules: segment, segments, and threshold.

#### Internal Logic
This test iterates through a set of test cases, each defining a different rollout rule type. For each case:
1. **Arrange:**
    * Defines a test case name and creates a `CreateRolloutRequest` with specific rule data.
    * Sets up an expectation on the mock store for the `CreateRollout` method to return a predefined rollout based on the request.
2. **Act:**
    * Calls the `CreateRollout` function on the server with the request.
3. **Assert:**
    * Asserts that the function returns no error.
    * Asserts that the returned rollout matches the predefined rollout.

### `TestUpdateRollout`
#### Description
Tests the `UpdateRollout` function of the server. It verifies that the function correctly updates an existing rollout in the store using a mock store implementation.

#### Internal Logic
1. **Arrange:**
    * Creates a mock store and sets up an expectation for the `UpdateRollout` method to return the updated rollout.
    * Creates a new server instance with the mock store and a test logger.
    * Creates an `UpdateRolloutRequest` with sample data.
2. **Act:**
    * Calls the `UpdateRollout` function on the server with the request.
3. **Assert:**
    * Asserts that the function returns no error.
    * Asserts that the returned rollout is not nil.

### `TestDeleteRollout`
#### Description
Tests the `DeleteRollout` function of the server. It verifies that the function correctly deletes a rollout from the store using a mock store implementation.

#### Internal Logic
1. **Arrange:**
    * Creates a mock store and sets up an expectation for the `DeleteRollout` method to return no error.
    * Creates a new server instance with the mock store and a test logger.
    * Creates a `DeleteRolloutRequest` with sample data.
2. **Act:**
    * Calls the `DeleteRollout` function on the server with the request.
3. **Assert:**
    * Asserts that the function returns no error.
    * Asserts that the returned empty response is not nil.

### `TestOrderRollouts`
#### Description
Tests the `OrderRollouts` function of the server. It verifies that the function correctly orders rollouts in the store using a mock store implementation.

#### Internal Logic
1. **Arrange:**
    * Creates a mock store and sets up an expectation for the `OrderRollouts` method to return no error.
    * Creates a new server instance with the mock store and a test logger.
    * Creates an `OrderRolloutsRequest` with sample data.
2. **Act:**
    * Calls the `OrderRollouts` function on the server with the request.
3. **Assert:**
    * Asserts that the function returns no error.
    * Asserts that the returned empty response is not nil.
