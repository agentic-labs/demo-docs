---
title: "rule_test.go"
---

## High-level description
The `rule_test.go` file contains unit tests for the rule-related functionality of the Flipt server. It covers functions for creating, retrieving, updating, deleting, and ordering rules, as well as managing distributions associated with rules.

## References
This file references the following packages which are crucial for understanding the code:
- `github.com/stretchr/testify/assert`: Provides assertion functions for testing.
- `github.com/stretchr/testify/mock`: Enables the creation of mock objects for testing.
- `github.com/stretchr/testify/require`: Offers assertion functions that halt test execution on failure.
- `go.flipt.io/flipt/internal/common`: Contains shared data structures and mock implementations.
- `go.flipt.io/flipt/internal/storage`: Provides interfaces for interacting with the storage layer.
- `go.flipt.io/flipt/rpc/flipt`: Defines the gRPC API for Flipt.
- `go.uber.org/zap/zaptest`: Offers a testing logger implementation.

## Symbols

### `TestGetRule`
#### Description
Tests the `GetRule` function of the server. It verifies that the function correctly retrieves a rule from the store using a provided rule ID and flag key.

#### Inputs
This test function does not take any specific inputs. It uses a predefined `GetRuleRequest` struct with hardcoded values for testing.

#### Outputs
This test function does not return any outputs. It uses assertions to verify the expected behavior of the `GetRule` function.

#### Internal Logic
- Mocks the `GetRule` function of the storage interface to return a predefined `flipt.Rule` object.
- Calls the `GetRule` function of the server with a context and the predefined request.
- Asserts that the function returns no error and that the returned `flipt.Rule` object is not nil.

### `TestListRules_PaginationOffset`
#### Description
Tests the pagination functionality of the `ListRules` function when using an offset. It checks if the function correctly applies the offset to the storage layer call and returns the expected results, next page token, and total count.

#### Inputs
This test function does not take any specific inputs. It uses a predefined `ListRuleRequest` struct with a hardcoded flag key and offset for testing.

#### Outputs
This test function does not return any outputs. It uses assertions to verify the expected behavior of the `ListRules` function.

#### Internal Logic
- Mocks the `ListRules` and `CountRules` functions of the storage interface to return predefined data.
- Calls the `ListRules` function of the server with a context and the predefined request.
- Asserts that the function returns no error, the returned `ListRulesResponse` contains the expected rules and next page token, and the total count matches the predefined value.

### `TestListRules_PaginationPageToken`
#### Description
Tests the pagination functionality of the `ListRules` function when using a page token. It checks if the function correctly applies the page token and offset to the storage layer call and returns the expected results, next page token, and total count.

#### Inputs
This test function does not take any specific inputs. It uses a predefined `ListRuleRequest` struct with a hardcoded flag key, page token, and offset for testing.

#### Outputs
This test function does not return any outputs. It uses assertions to verify the expected behavior of the `ListRules` function.

#### Internal Logic
- Mocks the `ListRules` and `CountRules` functions of the storage interface to return predefined data.
- Calls the `ListRules` function of the server with a context and the predefined request.
- Asserts that the function returns no error, the returned `ListRulesResponse` contains the expected rules and next page token, and the total count matches the predefined value.

### `TestCreateRule`
#### Description
Tests the `CreateRule` function of the server. It verifies that the function correctly creates a new rule in the store with the provided data and returns the created rule.

#### Inputs
This test function does not take any specific inputs. It uses a predefined `CreateRuleRequest` struct with hardcoded values for testing.

#### Outputs
This test function does not return any outputs. It uses assertions to verify the expected behavior of the `CreateRule` function.

#### Internal Logic
- Mocks the `CreateRule` function of the storage interface to return a predefined `flipt.Rule` object based on the provided request.
- Calls the `CreateRule` function of the server with a context and the predefined request.
- Asserts that the function returns no error and that the returned `flipt.Rule` object is not nil.

### `TestCreateRule_MultipleSegments`
#### Description
Tests the `CreateRule` function of the server when creating a rule with multiple segments. It verifies that the function correctly handles the segment keys and operator and creates the rule accordingly.

#### Inputs
This test function does not take any specific inputs. It uses a predefined `CreateRuleRequest` struct with hardcoded values, including multiple segment keys and a segment operator, for testing.

#### Outputs
This test function does not return any outputs. It uses assertions to verify the expected behavior of the `CreateRule` function.

#### Internal Logic
- Mocks the `CreateRule` function of the storage interface to return a predefined `flipt.Rule` object based on the provided request, including the multiple segment keys and operator.
- Calls the `CreateRule` function of the server with a context and the predefined request.
- Asserts that the function returns no error and that the returned `flipt.Rule` object is not nil.

### `TestUpdateRule`
#### Description
Tests the `UpdateRule` function of the server. It verifies that the function correctly updates an existing rule in the store with the provided data and returns the updated rule.

#### Inputs
This test function does not take any specific inputs. It uses a predefined `UpdateRuleRequest` struct with hardcoded values for testing.

#### Outputs
This test function does not return any outputs. It uses assertions to verify the expected behavior of the `UpdateRule` function.

#### Internal Logic
- Mocks the `UpdateRule` function of the storage interface to return a predefined `flipt.Rule` object based on the provided request.
- Calls the `UpdateRule` function of the server with a context and the predefined request.
- Asserts that the function returns no error and that the returned `flipt.Rule` object is not nil.

### `TestDeleteRule`
#### Description
Tests the `DeleteRule` function of the server. It verifies that the function correctly deletes an existing rule from the store using a provided rule ID.

#### Inputs
This test function does not take any specific inputs. It uses a predefined `DeleteRuleRequest` struct with a hardcoded rule ID for testing.

#### Outputs
This test function does not return any outputs. It uses assertions to verify the expected behavior of the `DeleteRule` function.

#### Internal Logic
- Mocks the `DeleteRule` function of the storage interface to simulate successful rule deletion.
- Calls the `DeleteRule` function of the server with a context and the predefined request.
- Asserts that the function returns no error.

### `TestOrderRules`
#### Description
Tests the `OrderRules` function of the server. It verifies that the function correctly orders rules for a given flag key in the store according to the provided rule IDs.

#### Inputs
This test function does not take any specific inputs. It uses a predefined `OrderRulesRequest` struct with a hardcoded flag key and rule IDs for testing.

#### Outputs
This test function does not return any outputs. It uses assertions to verify the expected behavior of the `OrderRules` function.

#### Internal Logic
- Mocks the `OrderRules` function of the storage interface to simulate successful rule ordering.
- Calls the `OrderRules` function of the server with a context and the predefined request.
- Asserts that the function returns no error.

### `TestCreateDistribution`
#### Description
Tests the `CreateDistribution` function of the server. It verifies that the function correctly creates a new distribution in the store with the provided flag key, rule ID, and variant ID, and returns the created distribution.

#### Inputs
This test function does not take any specific inputs. It uses a predefined `CreateDistributionRequest` struct with hardcoded values for testing.

#### Outputs
This test function does not return any outputs. It uses assertions to verify the expected behavior of the `CreateDistribution` function.

#### Internal Logic
- Mocks the `CreateDistribution` function of the storage interface to return a predefined `flipt.Distribution` object based on the provided request.
- Calls the `CreateDistribution` function of the server with a context and the predefined request.
- Asserts that the function returns no error and that the returned `flipt.Distribution` object is not nil.

### `TestUpdateDistribution`
#### Description
Tests the `UpdateDistribution` function of the server. It verifies that the function correctly updates an existing distribution in the store with the provided data and returns the updated distribution.

#### Inputs
This test function does not take any specific inputs. It uses a predefined `UpdateDistributionRequest` struct with hardcoded values for testing.

#### Outputs
This test function does not return any outputs. It uses assertions to verify the expected behavior of the `UpdateDistribution` function.

#### Internal Logic
- Mocks the `UpdateDistribution` function of the storage interface to return a predefined `flipt.Distribution` object based on the provided request.
- Calls the `UpdateDistribution` function of the server with a context and the predefined request.
- Asserts that the function returns no error and that the returned `flipt.Distribution` object is not nil.

### `TestDeleteDistribution`
#### Description
Tests the `DeleteDistribution` function of the server. It verifies that the function correctly deletes an existing distribution from the store using the provided flag key, rule ID, and variant ID.

#### Inputs
This test function does not take any specific inputs. It uses a predefined `DeleteDistributionRequest` struct with hardcoded values for testing.

#### Outputs
This test function does not return any outputs. It uses assertions to verify the expected behavior of the `DeleteDistribution` function.

#### Internal Logic
- Mocks the `DeleteDistribution` function of the storage interface to simulate successful distribution deletion.
- Calls the `DeleteDistribution` function of the server with a context and the predefined request.
- Asserts that the function returns no error.
