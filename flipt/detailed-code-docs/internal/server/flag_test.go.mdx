---
title: "flag_test.go"
---

## High-level description
The `flag_test.go` file contains unit tests for the gRPC server methods related to managing feature flags. This includes testing the `GetFlag`, `ListFlags`, `CreateFlag`, `UpdateFlag`, and `DeleteFlag` methods, as well as methods for managing flag variants.

## References
This file references the following symbols from other parts of the codebase:
- `flipt.GetFlagRequest`: Represents a request to retrieve a feature flag.
- `flipt.Flag`: Represents a feature flag.
- `flipt.ListFlagRequest`: Represents a request to list feature flags.
- `flipt.CreateFlagRequest`: Represents a request to create a new feature flag.
- `flipt.UpdateFlagRequest`: Represents a request to update an existing feature flag.
- `flipt.DeleteFlagRequest`: Represents a request to delete a feature flag.
- `flipt.CreateVariantRequest`: Represents a request to create a new variant for a feature flag.
- `flipt.UpdateVariantRequest`: Represents a request to update an existing variant for a feature flag.
- `flipt.DeleteVariantRequest`: Represents a request to delete a variant for a feature flag.
- `common.StoreMock`: A mock implementation of the storage interface.

## Symbols

### `TestGetFlag`
#### Description
This test verifies the functionality of the `GetFlag` method. It ensures that the method correctly retrieves a flag from the store and returns it in the response.

#### Internal Logic
1. **Arrange:**
    - Create a mock store and set up an expected call to `GetFlag` with the flag key "foo".
    - Create a new `Server` instance with the mock store and a logger.
    - Create a `GetFlagRequest` with the key "foo".
2. **Act:**
    - Call the `GetFlag` method on the server with the request.
3. **Assert:**
    - Verify that the call to `GetFlag` on the mock store was made.
    - Assert that the returned error is nil.
    - Assert that the returned `Flag` object is not nil.
    - Assert that the returned `Flag` object has the correct key and enabled status.

### `TestListFlags_PaginationOffset`
#### Description
This test verifies the functionality of the `ListFlags` method with pagination using the `Offset` parameter. It ensures that the method correctly retrieves a list of flags from the store with the specified offset and returns them in the response.

#### Internal Logic
1. **Arrange:**
    - Create a mock store and set up an expected call to `ListFlags` with the specified offset and a blank namespace.
    - Create a new `Server` instance with the mock store and a logger.
2. **Act:**
    - Call the `ListFlags` method on the server with a request containing the desired offset.
3. **Assert:**
    - Verify that the call to `ListFlags` on the mock store was made with the correct parameters.
    - Assert that the returned error is nil.
    - Assert that the returned list of flags is not empty.
    - Assert that the returned next page token is correct.
    - Assert that the returned total count of flags is correct.

### `TestListFlags_PaginationPageToken`
#### Description
This test verifies the functionality of the `ListFlags` method with pagination using the `PageToken` parameter. It ensures that the method correctly retrieves a list of flags from the store with the specified page token and returns them in the response.

#### Internal Logic
1. **Arrange:**
    - Create a mock store and set up an expected call to `ListFlags` with the specified page token and offset.
    - Create a new `Server` instance with the mock store and a logger.
2. **Act:**
    - Call the `ListFlags` method on the server with a request containing the desired page token and offset.
3. **Assert:**
    - Verify that the call to `ListFlags` on the mock store was made with the correct parameters.
    - Assert that the returned error is nil.
    - Assert that the returned list of flags is not empty.
    - Assert that the returned next page token is correct.
    - Assert that the returned total count of flags is correct.

### `TestCreateFlag`
#### Description
This test verifies the functionality of the `CreateFlag` method. It ensures that the method correctly creates a new flag in the store and returns the created flag in the response.

#### Internal Logic
1. **Arrange:**
    - Create a mock store and set up an expected call to `CreateFlag` with the new flag data.
    - Create a new `Server` instance with the mock store and a logger.
    - Create a `CreateFlagRequest` with the new flag data.
2. **Act:**
    - Call the `CreateFlag` method on the server with the request.
3. **Assert:**
    - Verify that the call to `CreateFlag` on the mock store was made with the correct parameters.
    - Assert that the returned error is nil.
    - Assert that the returned `Flag` object is not nil.

### `TestUpdateFlag`
#### Description
This test verifies the functionality of the `UpdateFlag` method. It ensures that the method correctly updates an existing flag in the store and returns the updated flag in the response.

#### Internal Logic
1. **Arrange:**
    - Create a mock store and set up an expected call to `UpdateFlag` with the updated flag data.
    - Create a new `Server` instance with the mock store and a logger.
    - Create an `UpdateFlagRequest` with the updated flag data.
2. **Act:**
    - Call the `UpdateFlag` method on the server with the request.
3. **Assert:**
    - Verify that the call to `UpdateFlag` on the mock store was made with the correct parameters.
    - Assert that the returned error is nil.
    - Assert that the returned `Flag` object is not nil.

### `TestDeleteFlag`
#### Description
This test verifies the functionality of the `DeleteFlag` method. It ensures that the method correctly deletes an existing flag from the store.

#### Internal Logic
1. **Arrange:**
    - Create a mock store and set up an expected call to `DeleteFlag` with the flag key to delete.
    - Create a new `Server` instance with the mock store and a logger.
    - Create a `DeleteFlagRequest` with the flag key to delete.
2. **Act:**
    - Call the `DeleteFlag` method on the server with the request.
3. **Assert:**
    - Verify that the call to `DeleteFlag` on the mock store was made with the correct parameters.
    - Assert that the returned error is nil.

### `TestCreateVariant`
#### Description
This test verifies the functionality of the `CreateVariant` method. It ensures that the method correctly creates a new variant for a flag in the store and returns the created variant in the response.

#### Internal Logic
1. **Arrange:**
    - Create a mock store and set up an expected call to `CreateVariant` with the new variant data.
    - Create a new `Server` instance with the mock store and a logger.
    - Create a `CreateVariantRequest` with the new variant data.
2. **Act:**
    - Call the `CreateVariant` method on the server with the request.
3. **Assert:**
    - Verify that the call to `CreateVariant` on the mock store was made with the correct parameters.
    - Assert that the returned error is nil.
    - Assert that the returned `Variant` object is not nil.

### `TestUpdateVariant`
#### Description
This test verifies the functionality of the `UpdateVariant` method. It ensures that the method correctly updates an existing variant for a flag in the store and returns the updated variant in the response.

#### Internal Logic
1. **Arrange:**
    - Create a mock store and set up an expected call to `UpdateVariant` with the updated variant data.
    - Create a new `Server` instance with the mock store and a logger.
    - Create an `UpdateVariantRequest` with the updated variant data.
2. **Act:**
    - Call the `UpdateVariant` method on the server with the request.
3. **Assert:**
    - Verify that the call to `UpdateVariant` on the mock store was made with the correct parameters.
    - Assert that the returned error is nil.
    - Assert that the returned `Variant` object is not nil.

### `TestDeleteVariant`
#### Description
This test verifies the functionality of the `DeleteVariant` method. It ensures that the method correctly deletes an existing variant for a flag from the store.

#### Internal Logic
1. **Arrange:**
    - Create a mock store and set up an expected call to `DeleteVariant` with the variant ID to delete.
    - Create a new `Server` instance with the mock store and a logger.
    - Create a `DeleteVariantRequest` with the variant ID to delete.
2. **Act:**
    - Call the `DeleteVariant` method on the server with the request.
3. **Assert:**
    - Verify that the call to `DeleteVariant` on the mock store was made with the correct parameters.
    - Assert that the returned error is nil.
