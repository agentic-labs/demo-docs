---
title: "Overview"
---

## High-level description
This directory contains the implementation of an authorization engine for Flipt using Open Policy Agent (OPA). The engine is responsible for verifying if a given request is allowed based on configured authorization policies. It provides a flexible and powerful way to implement complex authorization rules using OPA's policy language.

## What does it do?
The authorization engine in this directory performs the following main functions:

1. Initializes an OPA engine with the provided configuration, including loading policies and data.
2. Evaluates authorization requests against the loaded policies to determine if they are allowed.
3. Provides a clean shutdown mechanism for the OPA engine.

In simpler terms, it acts as a gatekeeper for Flipt, deciding whether a user or system can perform a specific action based on predefined rules. These rules can be complex and consider various factors like user roles, resource types, and custom conditions.

## Key Files

1. `engine.go`: This file contains the core implementation of the authorization engine. It defines the `Engine` struct, which wraps the OPA engine and implements the `authz.Verifier` interface. The main functions in this file are:

   - `NewEngine`: Initializes a new OPA engine with the provided configuration.
   - `IsAllowed`: Evaluates whether a given request is authorized based on the loaded policies.
   - `Shutdown`: Gracefully stops the OPA engine and performs cleanup.

2. `engine_test.go`: This file contains unit tests for the `Engine` struct, specifically targeting the `IsAllowed` method. It sets up a mock OPA server with predefined RBAC policies and data, then runs various test cases to ensure the authorization logic works correctly for different scenarios.

## Dependencies
The authorization engine relies on several external libraries and frameworks:

1. Open Policy Agent (OPA) SDK (github.com/open-policy-agent/opa/sdk): This is the core dependency that provides the OPA engine functionality. It allows the engine to evaluate complex authorization policies efficiently.

2. Uber's Zap logger (go.uber.org/zap): Used for structured logging throughout the engine. It provides high-performance logging capabilities.

3. OPA contrib logging plugin (github.com/open-policy-agent/contrib/logging/plugins/ozap): This plugin integrates OPA's logging with Uber's Zap logger, ensuring consistent logging across the application.

4. OPA in-memory storage (github.com/open-policy-agent/opa/storage/inmem): Provides an in-memory storage implementation for OPA, which is used to store policies and data.

These dependencies were chosen to provide a robust, performant, and flexible authorization solution that integrates well with the existing Flipt architecture.

## Configuration
The authorization engine uses configuration settings from the Flipt configuration (`config.Config`). Key configurable aspects include:

1. Authorization backend: The engine supports different backends for storing authorization policies and data, such as local files or S3 buckets.

2. AWS Region: If using an S3 backend, the AWS region can be specified in the configuration.

3. Policy and data paths: The locations of the authorization policy and data files can be configured.

The exact configuration fields and their meanings are not provided in the given code snippets, but they are likely defined in the `config.Config` struct from the `go.flipt.io/flipt/internal/config` package.

Example configuration (hypothetical, based on the code):

```yaml
authorization:
  backend:
    type: s3
    region: us-west-2
    bucket: my-policy-bucket
  policy:
    path: /policies/authz.rego
  data:
    path: /data/rbac.json
```

This configuration would set up the authorization engine to use policies and data stored in an S3 bucket in the us-west-2 region, with specific paths for the policy and data files.

The engine is designed to be flexible and can adapt to different authorization requirements by modifying the policies and data without changing the core implementation.