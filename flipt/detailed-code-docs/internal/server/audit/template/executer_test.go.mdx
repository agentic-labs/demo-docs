---
title: "executer_test.go"
---

## High-level description
The code defines tests for the `webhookTemplate` struct, which is responsible for executing webhooks with a given template and data. It covers scenarios like successful webhook execution, handling invalid JSON templates, and using the `toJson` function within the template.

## Code Structure
The code consists of multiple test functions, each testing a specific aspect of the `webhookTemplate` struct. The `TestConstructorWebhookTemplate` function tests the constructor of the struct, while the other test functions (`TestExecuter_JSON_Failure`, `TestExecuter_Execute`, `TestExecuter_Execute_toJson_valid_Json`) test the `Execute` method with different inputs and scenarios.

## References
- `go.flipt.io/flipt/internal/server/audit`: Provides the `audit.Event` struct used as data for the webhook template.
- `go.flipt.io/flipt/rpc/flipt`: Provides enum values for `flipt.SubjectFlag`, `flipt.ActionCreate`, and the `flipt.CreateFlagRequest` struct used as payload in one of the tests.

## Symbols
### `TestConstructorWebhookTemplate`
#### Description
This test function verifies the successful creation of a new `webhookTemplate` using the `NewWebhookTemplate` constructor. It asserts that the returned executer is not nil and is of the correct type (`*webhookTemplate`). It also checks if the internal fields of the struct are set correctly based on the provided constructor arguments.

#### Inputs
This function takes no explicit inputs as it's a test function.

#### Outputs
This function has no explicit outputs as it's a test function.

#### Internal Logic
1. **Arrange:** It calls the `NewWebhookTemplate` constructor with specific arguments like URL, template string, headers, and timeout.
2. **Act:** It asserts that the returned error is nil and the executer is not nil.
3. **Assert:** It further asserts that the executer is of type `*webhookTemplate` and its internal fields (url, headers, httpClient) are set correctly based on the constructor arguments.

### `TestExecuter_JSON_Failure`
#### Description
This test function verifies the behavior of the `Execute` method when provided with an invalid JSON template. It expects the `Execute` method to return an error indicating the invalid JSON.

#### Inputs
This function takes no explicit inputs as it's a test function.

#### Outputs
This function has no explicit outputs as it's a test function.

#### Internal Logic
1. **Arrange:** It creates a new `webhookTemplate` with an invalid JSON template string.
2. **Act:** It calls the `Execute` method with a valid `audit.Event` data.
3. **Assert:** It asserts that the returned error is not nil and its message indicates an "invalid JSON" error.

### `TestExecuter_Execute`
#### Description
This test function verifies the successful execution of the `Execute` method with a valid JSON template and a running HTTP server. It expects the webhook to be delivered successfully to the server.

#### Inputs
This function takes no explicit inputs as it's a test function.

#### Outputs
This function has no explicit outputs as it's a test function.

#### Internal Logic
1. **Arrange:** It starts a test HTTP server and creates a new `webhookTemplate` with the server's URL and a valid JSON template.
2. **Act:** It calls the `Execute` method with a valid `audit.Event` data.
3. **Assert:** It asserts that the returned error is nil, indicating successful webhook execution.

### `TestExecuter_Execute_toJson_valid_Json`
#### Description
This test function verifies the successful execution of the `Execute` method with a valid JSON template that uses the `toJson` function to serialize a Go struct into JSON. It expects the webhook to be delivered successfully with the serialized JSON payload.

#### Inputs
This function takes no explicit inputs as it's a test function.

#### Outputs
This function has no explicit outputs as it's a test function.

#### Internal Logic
1. **Arrange:** It starts a test HTTP server and creates a new `webhookTemplate` with the server's URL and a valid JSON template that uses the `toJson` function.
2. **Act:** It calls the `Execute` method with a valid `audit.Event` data that includes a `flipt.CreateFlagRequest` struct as the payload.
3. **Assert:** It asserts that the returned error is nil, indicating successful webhook execution with the serialized JSON payload.

## Dependencies
- `github.com/hashicorp/go-retryablehttp`: Provides retryable HTTP client functionality.
- `github.com/stretchr/testify/assert`: Provides assertion functions for testing.
- `github.com/stretchr/testify/require`: Provides require functions for testing.
- `go.uber.org/zap`: Provides logging functionality.
- `go.uber.org/zap/zaptest`: Provides testing utilities for logging.
- `net/http`: Provides HTTP client and server implementations.
- `net/http/httptest`: Provides utilities for testing HTTP servers.

