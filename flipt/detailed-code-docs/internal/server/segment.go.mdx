---
title: "segment.go"
---

## High-level description
The `segment.go` file houses the implementation of the Flipt server's gRPC API endpoints related to managing segments. These endpoints allow for creating, retrieving, updating, and deleting segments and their associated constraints.

## Code Structure
The file defines a set of functions, all members of the `Server` struct, that correspond to different gRPC API endpoints for managing segments and constraints. Each function interacts with the underlying storage layer (`s.store`) to perform the requested operations.

## References
- `storage` package: Provides the interface for interacting with the storage layer.
- `flipt` package: Defines the gRPC request and response message structures.
- `zap` package: Used for structured logging.
- `empty` package: Used for returning empty responses.

## Symbols

### `(*Server) GetSegment`
#### Description
Retrieves a segment from the storage based on the provided request parameters.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| ctx | context.Context | The context of the request. |
| r | *flipt.GetSegmentRequest | The request message containing the segment key and namespace. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| *flipt.Segment | The retrieved segment. |
| error | An error if the segment retrieval fails. |

#### Internal Logic
1. Logs the request details.
2. Calls the `GetSegment` method of the storage interface to retrieve the segment.
3. Logs the response details.
4. Returns the retrieved segment and any error encountered.

### `(*Server) ListSegments`
#### Description
Retrieves a list of segments from the storage based on the provided request parameters.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| ctx | context.Context | The context of the request. |
| r | *flipt.ListSegmentRequest | The request message containing the namespace and pagination parameters. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| *flipt.SegmentList | The list of retrieved segments and pagination information. |
| error | An error if the segment listing fails. |

#### Internal Logic
1. Logs the request details.
2. Calls the `ListSegments` method of the storage interface to retrieve the segments.
3. Constructs the response message with the retrieved segments and pagination information.
4. Calls the `CountSegments` method of the storage interface to get the total count of segments.
5. Sets the total count and next page token in the response message.
6. Logs the response details.
7. Returns the response message and any error encountered.

### `(*Server) CreateSegment`
#### Description
Creates a new segment in the storage based on the provided request message.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| ctx | context.Context | The context of the request. |
| r | *flipt.CreateSegmentRequest | The request message containing the segment data. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| *flipt.Segment | The created segment. |
| error | An error if the segment creation fails. |

#### Internal Logic
1. Logs the request details.
2. Calls the `CreateSegment` method of the storage interface to create the segment.
3. Logs the response details.
4. Returns the created segment and any error encountered.

### `(*Server) UpdateSegment`
#### Description
Updates an existing segment in the storage based on the provided request message.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| ctx | context.Context | The context of the request. |
| r | *flipt.UpdateSegmentRequest | The request message containing the updated segment data. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| *flipt.Segment | The updated segment. |
| error | An error if the segment update fails. |

#### Internal Logic
1. Logs the request details.
2. Calls the `UpdateSegment` method of the storage interface to update the segment.
3. Logs the response details.
4. Returns the updated segment and any error encountered.

### `(*Server) DeleteSegment`
#### Description
Deletes a segment from the storage based on the provided request parameters.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| ctx | context.Context | The context of the request. |
| r | *flipt.DeleteSegmentRequest | The request message containing the segment key and namespace. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| *empty.Empty | An empty response. |
| error | An error if the segment deletion fails. |

#### Internal Logic
1. Logs the request details.
2. Calls the `DeleteSegment` method of the storage interface to delete the segment.
3. Returns an empty response and any error encountered.

### `(*Server) CreateConstraint`
#### Description
Creates a new constraint associated with a segment based on the provided request message.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| ctx | context.Context | The context of the request. |
| r | *flipt.CreateConstraintRequest | The request message containing the constraint data. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| *flipt.Constraint | The created constraint. |
| error | An error if the constraint creation fails. |

#### Internal Logic
1. Logs the request details.
2. Calls the `CreateConstraint` method of the storage interface to create the constraint.
3. Logs the response details.
4. Returns the created constraint and any error encountered.

### `(*Server) UpdateConstraint`
#### Description
Updates an existing constraint associated with a segment based on the provided request message.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| ctx | context.Context | The context of the request. |
| r | *flipt.UpdateConstraintRequest | The request message containing the updated constraint data. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| *flipt.Constraint | The updated constraint. |
| error | An error if the constraint update fails. |

#### Internal Logic
1. Logs the request details.
2. Calls the `UpdateConstraint` method of the storage interface to update the constraint.
3. Logs the response details.
4. Returns the updated constraint and any error encountered.

### `(*Server) DeleteConstraint`
#### Description
Deletes a constraint associated with a segment based on the provided request parameters.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| ctx | context.Context | The context of the request. |
| r | *flipt.DeleteConstraintRequest | The request message containing the constraint ID and segment key. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| *empty.Empty | An empty response. |
| error | An error if the constraint deletion fails. |

#### Internal Logic
1. Logs the request details.
2. Calls the `DeleteConstraint` method of the storage interface to delete the constraint.
3. Returns an empty response and any error encountered.

## Dependencies
- `go.flipt.io/flipt/internal/storage`: Provides the storage interface.
- `go.flipt.io/flipt/rpc/flipt`: Defines the gRPC request and response messages.
- `go.uber.org/zap`: Used for structured logging.
- `google.golang.org/protobuf/types/known/emptypb`: Used for returning empty responses.

## Logging
Each function logs the request and response details using the `zap` logger.
