---
title: "segment_test.go"
---

## High-level description
The `segment_test.go` file contains unit tests for the segment-related functionality of the Flipt server. It covers functions for creating, retrieving, updating, deleting, and listing segments and their constraints.

## References
This file references the following packages which are crucial for understanding the code:
- `context`: Used for managing the lifecycle of goroutines and requests.
- `testing`: Provides the testing framework for Go.
- `github.com/stretchr/testify/assert`: Used for making assertions in tests.
- `github.com/stretchr/testify/mock`: Provides mocking capabilities for interfaces.
- `github.com/stretchr/testify/require`: Used for making assertions that, if failed, stop the test execution.
- `go.flipt.io/flipt/internal/common`: Contains common data structures and interfaces used across the Flipt codebase.
- `go.flipt.io/flipt/internal/storage`: Defines the interface for interacting with the Flipt storage layer.
- `go.flipt.io/flipt/rpc/flipt`: Contains the protocol buffer definitions for the Flipt RPC API.
- `go.uber.org/zap/zaptest`: Provides a testing logger implementation.

## Symbols

### `TestGetSegment`
#### Description
Tests the `GetSegment` function of the server. It verifies that the function correctly retrieves a segment from the store when provided a valid segment key.

#### Internal Logic
1. **Arrange:**
    - Creates a mock store and sets up an expectation that the `GetSegment` function of the store will be called with the provided segment key.
    - Creates a new `Server` instance with the mock store and a test logger.
    - Creates a `GetSegmentRequest` with the segment key.
2. **Act:**
    - Calls the `GetSegment` function of the server with the request.
3. **Assert:**
    - Asserts that there is no error returned from the function.
    - Asserts that the returned segment is not nil.

### `TestListSegments_PaginationOffset`
#### Description
Tests the pagination functionality of the `ListSegments` function when using the `Offset` parameter. It verifies that the function correctly retrieves a paginated list of segments from the store with the specified offset.

#### Internal Logic
1. **Arrange:**
    - Creates a mock store and sets up expectations for the `ListSegments` and `CountSegments` functions.
    - Creates a new `Server` instance with the mock store and a test logger.
2. **Act:**
    - Calls the `ListSegments` function of the server with a request containing an offset of 10.
3. **Assert:**
    - Asserts that there is no error returned from the function.
    - Asserts that the returned list of segments is not empty.
    - Asserts that the `NextPageToken` in the response is correct.
    - Asserts that the `TotalCount` in the response is correct.

### `TestListSegments_PaginationPageToken`
#### Description
Tests the pagination functionality of the `ListSegments` function when using the `PageToken` parameter. It verifies that the function correctly retrieves a paginated list of segments from the store using the provided page token.

#### Internal Logic
1. **Arrange:**
    - Creates a mock store and sets up expectations for the `ListSegments` and `CountSegments` functions.
    - Creates a new `Server` instance with the mock store and a test logger.
2. **Act:**
    - Calls the `ListSegments` function of the server with a request containing a page token and an offset.
3. **Assert:**
    - Asserts that there is no error returned from the function.
    - Asserts that the returned list of segments is not empty.
    - Asserts that the `NextPageToken` in the response is correct.
    - Asserts that the `TotalCount` in the response is correct.

### `TestCreateSegment`
#### Description
Tests the `CreateSegment` function of the server. It verifies that the function correctly creates a new segment in the store.

#### Internal Logic
1. **Arrange:**
    - Creates a mock store and sets up an expectation that the `CreateSegment` function of the store will be called with the provided segment data.
    - Creates a new `Server` instance with the mock store and a test logger.
    - Creates a `CreateSegmentRequest` with the segment data.
2. **Act:**
    - Calls the `CreateSegment` function of the server with the request.
3. **Assert:**
    - Asserts that there is no error returned from the function.
    - Asserts that the returned segment is not nil.

### `TestUpdateSegment`
#### Description
Tests the `UpdateSegment` function of the server. It verifies that the function correctly updates an existing segment in the store.

#### Internal Logic
1. **Arrange:**
    - Creates a mock store and sets up an expectation that the `UpdateSegment` function of the store will be called with the provided segment data.
    - Creates a new `Server` instance with the mock store and a test logger.
    - Creates an `UpdateSegmentRequest` with the updated segment data.
2. **Act:**
    - Calls the `UpdateSegment` function of the server with the request.
3. **Assert:**
    - Asserts that there is no error returned from the function.
    - Asserts that the returned segment is not nil.

### `TestDeleteSegment`
#### Description
Tests the `DeleteSegment` function of the server. It verifies that the function correctly deletes an existing segment from the store.

#### Internal Logic
1. **Arrange:**
    - Creates a mock store and sets up an expectation that the `DeleteSegment` function of the store will be called with the provided segment key.
    - Creates a new `Server` instance with the mock store and a test logger.
    - Creates a `DeleteSegmentRequest` with the segment key.
2. **Act:**
    - Calls the `DeleteSegment` function of the server with the request.
3. **Assert:**
    - Asserts that there is no error returned from the function.
    - Asserts that the returned empty response is not nil.

### `TestCreateConstraint`
#### Description
Tests the `CreateConstraint` function of the server. It verifies that the function correctly creates a new constraint for a segment.

#### Internal Logic
1. **Arrange:**
    - Creates a mock store and sets up an expectation that the `CreateConstraint` function of the store will be called with the provided constraint data.
    - Creates a new `Server` instance with the mock store and a test logger.
    - Creates a `CreateConstraintRequest` with the constraint data.
2. **Act:**
    - Calls the `CreateConstraint` function of the server with the request.
3. **Assert:**
    - Asserts that there is no error returned from the function.
    - Asserts that the returned constraint is not nil.

### `TestUpdateConstraint`
#### Description
Tests the `UpdateConstraint` function of the server. It verifies that the function correctly updates an existing constraint for a segment.

#### Internal Logic
1. **Arrange:**
    - Creates a mock store and sets up an expectation that the `UpdateConstraint` function of the store will be called with the provided constraint data.
    - Creates a new `Server` instance with the mock store and a test logger.
    - Creates an `UpdateConstraintRequest` with the updated constraint data.
2. **Act:**
    - Calls the `UpdateConstraint` function of the server with the request.
3. **Assert:**
    - Asserts that there is no error returned from the function.
    - Asserts that the returned constraint is not nil.

### `TestDeleteConstraint`
#### Description
Tests the `DeleteConstraint` function of the server. It verifies that the function correctly deletes an existing constraint from a segment.

#### Internal Logic
1. **Arrange:**
    - Creates a mock store and sets up an expectation that the `DeleteConstraint` function of the store will be called with the provided constraint ID.
    - Creates a new `Server` instance with the mock store and a test logger.
    - Creates a `DeleteConstraintRequest` with the constraint ID.
2. **Act:**
    - Calls the `DeleteConstraint` function of the server with the request.
3. **Assert:**
    - Asserts that there is no error returned from the function.
    - Asserts that the returned empty response is not nil.
