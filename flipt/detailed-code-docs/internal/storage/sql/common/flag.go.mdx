---
title: "flag.go"
---

## High-level description
The `flag.go` file provides the SQL implementation for managing flags and variants within the Flipt feature flag system. It defines methods for creating, retrieving, updating, deleting, and listing flags and their associated variants.

## Code Structure
The `Store` struct, defined in a separate file, provides the base for the SQL implementation. The `flag.go` file defines methods on the `Store` struct to interact with flags and variants stored in the SQL database.

## References
This file references the following symbols:

- `storage.ResourceRequest`
- `storage.NamespaceRequest`
- `storage.ListRequest`
- `flipt.Flag`
- `flipt.Variant`
- `fliptsql.Timestamp`
- `fliptsql.JSONField`

## Symbols

### `compactJSONString`
#### Description
This function takes a JSON string as input and returns a compacted version of the same JSON string. It uses the `json.Compact` function to remove unnecessary whitespace from the input JSON string.

#### Inputs
| Name       | Type   | Description                   |
|:-----------|:-------|:------------------------------|
| jsonString | string | The JSON string to compact. |

#### Outputs
| Name       | Type   | Description                                      |
|:-----------|:-------|:--------------------------------------------------|
| string     | string | The compacted JSON string or an empty string. |
| error      | error  | An error if the compaction fails.               |

#### Internal Logic
The function uses a `bytes.Buffer` to store the compacted JSON string. It calls `json.Compact` to compact the input JSON string and write the result to the buffer. If the compaction is successful, it returns the string representation of the buffer's contents. Otherwise, it returns an empty string and the error returned by `json.Compact`.

### `emptyAsNil`
#### Description
This function takes a string as input and returns a pointer to the same string if it's non-empty. If the input string is empty, it returns `nil`.

#### Inputs
| Name | Type   | Description             |
|:-----|:-------|:--------------------------|
| str  | string | The string to check. |

#### Outputs
| Name | Type    | Description                                           |
|:-----|:--------|:---------------------------------------------------|
| *string | *string | A pointer to the input string or `nil`. |

### `GetFlag`
#### Description
This method retrieves a flag and its associated variants from the database based on the provided `storage.ResourceRequest`.

#### Inputs
| Name | Type                      | Description                                                                          |
|:-----|:---------------------------|:----------------------------------------------------------------------------------|
| ctx  | context.Context            | The context for the request.                                                       |
| p    | storage.ResourceRequest | A `storage.ResourceRequest` containing the namespace and key of the flag to get. |

#### Outputs
| Name | Type        | Description                                                    |
|:-----|:------------|:------------------------------------------------------------|
| *flipt.Flag | *flipt.Flag | A pointer to the retrieved flag or `nil` if not found. |
| error        | error       | An error if the retrieval fails.                              |

#### Internal Logic
1. The method constructs a SQL query using the `squirrel` library to select the flag and its metadata from the `flags` table based on the provided namespace and key.
2. It executes the query and scans the results into a `flipt.Flag` struct.
3. If the flag is found, it constructs another query to retrieve all variants associated with the flag from the `variants` table.
4. It iterates over the variant rows, populating `flipt.Variant` structs and appending them to the `Variants` field of the `flipt.Flag` struct.
5. If a default variant ID is set for the flag, it sets the `DefaultVariant` field of the `flipt.Flag` struct to the corresponding variant.
6. Finally, it returns the populated `flipt.Flag` struct.

### `ListFlags`
#### Description
This method retrieves a list of flags and their associated variants from the database based on the provided `storage.ListRequest`.

#### Inputs
| Name | Type                                              | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | Name | Type                                              | Description                                                                                |
|:-----|:--------------------------------------------------|:-------------------------------------------------------------------------------------------|
| ctx  | context.Context                                   | The context for the request.                                                               |
| req  | *storage.ListRequest[storage.NamespaceRequest] | A `storage.ListRequest` containing the namespace and query parameters for listing flags. |

#### Outputs
| Name | Type                                 | Description                                                                |
|:-----|:-------------------------------------|:---------------------------------------------------------------------------|
| storage.ResultSet[*flipt.Flag] | storage.ResultSet[*flipt.Flag] | A result set containing the list of flags and pagination information. |
| error                          | error                          | An error if the retrieval fails.                                        |

#### Internal Logic
1. The method constructs a SQL query using the `squirrel` library to select flags from the `flags` table based on the provided namespace.
2. It applies pagination, ordering, and limit/offset based on the query parameters in the request.
3. It executes the query and scans the results into `flipt.Flag` structs.
4. After retrieving the flags, it calls the `setVariants` method to populate the variants for each flag.
5. If a next page token is required, it generates one based on the last retrieved flag.
6. Finally, it returns the `storage.ResultSet` containing the list of flags and pagination information.

### `CountFlags`
#### Description
This method counts the number of flags in a given namespace.

#### Inputs
| Name | Type                      | Description                                                    |
|:-----|:---------------------------|:---------------------------------------------------------------|
| ctx  | context.Context            | The context for the request.                                   |
| p    | storage.NamespaceRequest | A `storage.NamespaceRequest` containing the namespace to count flags in. |

#### Outputs
| Name  | Type   | Description                                |
|:------|:-------|:-------------------------------------------|
| uint64 | uint64 | The number of flags in the namespace. |
| error  | error  | An error if the counting fails.            |

### `CreateFlag`
#### Description
This method creates a new flag in the database.

#### Inputs
| Name | Type                        | Description                                        |
|:-----|:----------------------------|:---------------------------------------------------|
| ctx  | context.Context              | The context for the request.                       |
| r    | *flipt.CreateFlagRequest | A request containing the details of the flag to create. |

#### Outputs
| Name        | Type        | Description                                    |
|:------------|:------------|:-----------------------------------------------|
| *flipt.Flag | *flipt.Flag | A pointer to the created flag.               |
| error       | error       | An error if the creation fails.                |

#### Internal Logic
1. The method sets the namespace key to the default if not provided.
2. It creates a new `flipt.Flag` struct with the provided details and current timestamp.
3. If metadata is provided, it's converted to a `fliptsql.JSONField`.
4. It constructs an INSERT query using the `squirrel` library to insert the flag into the `flags` table.
5. After executing the query, it returns the created flag.

### `UpdateFlag`
#### Description
This method updates an existing flag in the database.

#### Inputs
| Name | Type                        | Description                                        |
|:-----|:----------------------------|:---------------------------------------------------|
| ctx  | context.Context              | The context for the request.                       |
| r    | *flipt.UpdateFlagRequest | A request containing the details of the flag to update. |

#### Outputs
| Name        | Type        | Description                                    |
|:------------|:------------|:-----------------------------------------------|
| *flipt.Flag | *flipt.Flag | A pointer to the updated flag.               |
| error       | error       | An error if the update fails.                  |

#### Internal Logic
1. The method sets the namespace key to the default if not provided.
2. If a default variant ID is provided, it verifies that the variant exists for the flag.
3. It constructs an UPDATE query using the `squirrel` library to update the flag in the `flags` table.
4. After executing the query, it retrieves the updated flag using the `GetFlag` method and returns it.

### `DeleteFlag`
#### Description
This method deletes a flag from the database.

#### Inputs
| Name | Type                        | Description                                        |
|:-----|:----------------------------|:---------------------------------------------------|
| ctx  | context.Context              | The context for the request.                       |
| r    | *flipt.DeleteFlagRequest | A request containing the details of the flag to delete. |

#### Outputs
| Name  | Type  | Description                   |
|:------|:------|:------------------------------|
| error | error | An error if the deletion fails. |

### `CreateVariant`
#### Description
This method creates a new variant for a flag in the database.

#### Inputs
| Name | Type                           | Description                                           |
|:-----|:-------------------------------|:------------------------------------------------------|
| ctx  | context.Context                 | The context for the request.                          |
| r    | *flipt.CreateVariantRequest | A request containing the details of the variant to create. |

#### Outputs
| Name           | Type           | Description                                    |
|:---------------|:---------------|:-----------------------------------------------|
| *flipt.Variant | *flipt.Variant | A pointer to the created variant.             |
| error          | error          | An error if the creation fails.                |

#### Internal Logic
1. The method sets the namespace key to the default if not provided.
2. It creates a new `flipt.Variant` struct with the provided details and current timestamp.
3. It constructs an INSERT query using the `squirrel` library to insert the variant into the `variants` table.
4. After executing the query, it compacts the attachment JSON if provided.
5. Finally, it returns the created variant.

### `UpdateVariant`
#### Description
This method updates an existing variant in the database.

#### Inputs
| Name | Type                           | Description                                           |
|:-----|:-------------------------------|:------------------------------------------------------|
| ctx  | context.Context                 | The context for the request.                          |
| r    | *flipt.UpdateVariantRequest | A request containing the details of the variant to update. |

#### Outputs
| Name           | Type           | Description                                    |
|:---------------|:---------------|:-----------------------------------------------|
| *flipt.Variant | *flipt.Variant | A pointer to the updated variant.             |
| error          | error          | An error if the update fails.                  |

#### Internal Logic
1. The method sets the namespace key to the default if not provided.
2. It constructs an UPDATE query using the `squirrel` library to update the variant in the `variants` table.
3. After executing the query, it retrieves the updated variant from the database.
4. It compacts the attachment JSON if provided.
5. Finally, it returns the updated variant.

### `DeleteVariant`
#### Description
This method deletes a variant from the database.

#### Inputs
| Name | Type                           | Description                                           |
|:-----|:-------------------------------|:------------------------------------------------------|
| ctx  | context.Context                 | The context for the request.                          |
| r    | *flipt.DeleteVariantRequest | A request containing the details of the variant to delete. |

#### Outputs
| Name  | Type  | Description                   |
|:------|:------|:------------------------------|
| error | error | An error if the deletion fails. |

## Side Effects
Most methods in this file have side effects as they modify the database state by creating, updating, or deleting flags and variants.

## Dependencies
- `database/sql`
- `github.com/Masterminds/squirrel`
- `github.com/gofrs/uuid`
- `google.golang.org/protobuf/types/known/structpb`
- `go.flipt.io/flipt/errors`
- `go.flipt.io/flipt/internal/storage`
- `go.flipt.io/flipt/internal/storage/sql`
- `go.flipt.io/flipt/rpc/flipt`

## Error Handling
The code uses custom error types from the `go.flipt.io/flipt/errors` package to handle specific error cases, such as not found errors. It also propagates database errors and handles them appropriately.

## Logging
This file does not implement explicit logging. Logging is likely handled at a higher level in the application.