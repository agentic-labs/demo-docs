---
title: "store_test.go"
---

## High-level description
The `store_test.go` file contains unit tests for the `fs.Store` struct, which is an implementation of the `storage.Store` interface. The tests cover various methods of the `Store` struct, such as getting, listing, and counting different types of Flipt resources like flags, rules, segments, rollouts, and namespaces.

## Code Structure
The code consists of a series of test functions, each testing a specific method of the `fs.Store` struct. Each test function follows a similar pattern:
1. Create a mock of the `storage.SnapshotStore` interface using `newSnapshotStoreMock()`.
2. Create a new instance of `fs.Store` using the mocked `SnapshotStore`.
3. Define the expected behavior of the mocked `SnapshotStore` using `On` method.
4. Call the method of `fs.Store` being tested.
5. Assert that the method call was successful and the returned values are as expected.

## Symbols

### `TestGetFlag`
#### Description
Tests the `GetFlag` method of the `fs.Store` struct. It verifies that the method calls the `GetFlag` method of the underlying `SnapshotStore` with the correct arguments and returns the expected result.

#### Inputs
This function takes a single argument:
| Name | Type | Description |
|:-----|:-----|:------------|
| t | *testing.T | The testing object used to control the test execution and report results. |

#### Outputs
This function does not return any values.

#### Internal Logic
1. **Arrange:** Creates a mock `SnapshotStore` and a new `fs.Store` instance using the mock. It sets up the mock to expect a call to `GetFlag` with a specific resource and return a dummy `flipt.Flag` and no error.
2. **Act:** Calls the `GetFlag` method of the `fs.Store` with a context and the same resource used in the mock setup.
3. **Assert:** Verifies that there was no error returned by `GetFlag`.

### `TestListFlags`
#### Description
Tests the `ListFlags` method of the `fs.Store` struct. It checks if the method correctly calls the `ListFlags` method of the underlying `SnapshotStore` with the provided arguments and returns the expected result.

#### Inputs
This function takes a single argument:
| Name | Type | Description |
|:-----|:-----|:------------|
| t | *testing.T | The testing object used to control the test execution and report results. |

#### Outputs
This function does not return any values.

#### Internal Logic
1. **Arrange:** Creates a mock `SnapshotStore` and a new `fs.Store` instance using the mock. It sets up the mock to expect a call to `ListFlags` with a specific `ListWithOptions` request for a namespace and return a dummy `storage.ResultSet[*flipt.Flag]` and no error.
2. **Act:** Calls the `ListFlags` method of the `fs.Store` with a context and the same `ListWithOptions` request used in the mock setup.
3. **Assert:** Verifies that there was no error returned by `ListFlags`.

### `TestCountFlags`
#### Description
Tests the `CountFlags` method of the `fs.Store` struct. It ensures that the method calls the `CountFlags` method of the underlying `SnapshotStore` with the correct arguments and returns the expected result.

#### Inputs
This function takes a single argument:
| Name | Type | Description |
|:-----|:-----|:------------|
| t | *testing.T | The testing object used to control the test execution and report results. |

#### Outputs
This function does not return any values.

#### Internal Logic
1. **Arrange:** Creates a mock `SnapshotStore` and a new `fs.Store` instance using the mock. It sets up the mock to expect a call to `CountFlags` with a specific namespace and return a zero count and no error.
2. **Act:** Calls the `CountFlags` method of the `fs.Store` with a context and the same namespace used in the mock setup.
3. **Assert:** Verifies that there was no error returned by `CountFlags`.

### `TestGetRule`
#### Description
Tests the `GetRule` method of the `fs.Store` struct. It verifies that the method calls the `GetRule` method of the underlying `SnapshotStore` with the correct arguments and returns the expected result.

#### Inputs
This function takes a single argument:
| Name | Type | Description |
|:-----|:-----|:------------|
| t | *testing.T | The testing object used to control the test execution and report results. |

#### Outputs
This function does not return any values.

#### Internal Logic
1. **Arrange:** Creates a mock `SnapshotStore` and a new `fs.Store` instance using the mock. It sets up the mock to expect a call to `GetRule` with a specific namespace and rule key and return a dummy `flipt.Rule` and no error.
2. **Act:** Calls the `GetRule` method of the `fs.Store` with a context, the same namespace, and rule key used in the mock setup.
3. **Assert:** Verifies that there was no error returned by `GetRule`.

### `TestListRules`
#### Description
Tests the `ListRules` method of the `fs.Store` struct. It checks if the method correctly calls the `ListRules` method of the underlying `SnapshotStore` with the provided arguments and returns the expected result.

#### Inputs
This function takes a single argument:
| Name | Type | Description |
|:-----|:-----|:------------|
| t | *testing.T | The testing object used to control the test execution and report results. |

#### Outputs
This function does not return any values.

#### Internal Logic
1. **Arrange:** Creates a mock `SnapshotStore` and a new `fs.Store` instance using the mock. It sets up the mock to expect a call to `ListRules` with a specific `ListWithOptions` request for a resource and return a dummy `storage.ResultSet[*flipt.Rule]` and no error.
2. **Act:** Calls the `ListRules` method of the `fs.Store` with a context and the same `ListWithOptions` request used in the mock setup.
3. **Assert:** Verifies that there was no error returned by `ListRules`.

### `TestCountRules`
#### Description
Tests the `CountRules` method of the `fs.Store` struct. It ensures that the method calls the `CountRules` method of the underlying `SnapshotStore` with the correct arguments and returns the expected result.

#### Inputs
This function takes a single argument:
| Name | Type | Description |
|:-----|:-----|:------------|
| t | *testing.T | The testing object used to control the test execution and report results. |

#### Outputs
This function does not return any values.

#### Internal Logic
1. **Arrange:** Creates a mock `SnapshotStore` and a new `fs.Store` instance using the mock. It sets up the mock to expect a call to `CountRules` with a specific resource and return a zero count and no error.
2. **Act:** Calls the `CountRules` method of the `fs.Store` with a context and the same resource used in the mock setup.
3. **Assert:** Verifies that there was no error returned by `CountRules`.

### `TestGetSegment`
#### Description
Tests the `GetSegment` method of the `fs.Store` struct. It verifies that the method calls the `GetSegment` method of the underlying `SnapshotStore` with the correct arguments and returns the expected result.

#### Inputs
This function takes a single argument:
| Name | Type | Description |
|:-----|:-----|:------------|
| t | *testing.T | The testing object used to control the test execution and report results. |

#### Outputs
This function does not return any values.

#### Internal Logic
1. **Arrange:** Creates a mock `SnapshotStore` and a new `fs.Store` instance using the mock. It sets up the mock to expect a call to `GetSegment` with a specific resource and return a dummy `flipt.Segment` and no error.
2. **Act:** Calls the `GetSegment` method of the `fs.Store` with a context and the same resource used in the mock setup.
3. **Assert:** Verifies that there was no error returned by `GetSegment`.

### `TestListSegments`
#### Description
Tests the `ListSegments` method of the `fs.Store` struct. It checks if the method correctly calls the `ListSegments` method of the underlying `SnapshotStore` with the provided arguments and returns the expected result.

#### Inputs
This function takes a single argument:
| Name | Type | Description |
|:-----|:-----|:------------|
| t | *testing.T | The testing object used to control the test execution and report results. |

#### Outputs
This function does not return any values.

#### Internal Logic
1. **Arrange:** Creates a mock `SnapshotStore` and a new `fs.Store` instance using the mock. It sets up the mock to expect a call to `ListSegments` with a specific `ListWithOptions` request for a namespace and return a dummy `storage.ResultSet[*flipt.Segment]` and no error.
2. **Act:** Calls the `ListSegments` method of the `fs.Store` with a context and the same `ListWithOptions` request used in the mock setup.
3. **Assert:** Verifies that there was no error returned by `ListSegments`.

### `TestCountSegments`
#### Description
Tests the `CountSegments` method of the `fs.Store` struct. It ensures that the method calls the `CountSegments` method of the underlying `SnapshotStore` with the correct arguments and returns the expected result.

#### Inputs
This function takes a single argument:
| Name | Type | Description |
|:-----|:-----|:------------|
| t | *testing.T | The testing object used to control the test execution and report results. |

#### Outputs
This function does not return any values.

#### Internal Logic
1. **Arrange:** Creates a mock `SnapshotStore` and a new `fs.Store` instance using the mock. It sets up the mock to expect a call to `CountSegments` with a specific namespace and return a zero count and no error.
2. **Act:** Calls the `CountSegments` method of the `fs.Store` with a context and the same namespace used in the mock setup.
3. **Assert:** Verifies that there was no error returned by `CountSegments`.

### `TestGetRollout`
#### Description
Tests the `GetRollout` method of the `fs.Store` struct. It verifies that the method calls the `GetRollout` method of the underlying `SnapshotStore` with the correct arguments and returns the expected result.

#### Inputs
This function takes a single argument:
| Name | Type | Description |
|:-----|:-----|:------------|
| t | *testing.T | The testing object used to control the test execution and report results. |

#### Outputs
This function does not return any values.

#### Internal Logic
1. **Arrange:** Creates a mock `SnapshotStore` and a new `fs.Store` instance using the mock. It sets up the mock to expect a call to `GetRollout` with a specific namespace and rollout key and return a dummy `flipt.Rollout` and no error.
2. **Act:** Calls the `GetRollout` method of the `fs.Store` with a context, the same namespace, and rollout key used in the mock setup.
3. **Assert:** Verifies that there was no error returned by `GetRollout`.

### `TestListRollouts`
#### Description
Tests the `ListRollouts` method of the `fs.Store` struct. It checks if the method correctly calls the `ListRollouts` method of the underlying `SnapshotStore` with the provided arguments and returns the expected result.

#### Inputs
This function takes a single argument:
| Name | Type | Description |
|:-----|:-----|:------------|
| t | *testing.T | The testing object used to control the test execution and report results. |

#### Outputs
This function does not return any values.

#### Internal Logic
1. **Arrange:** Creates a mock `SnapshotStore` and a new `fs.Store` instance using the mock. It sets up the mock to expect a call to `ListRollouts` with a specific `ListWithOptions` request for a resource and return a dummy `storage.ResultSet[*flipt.Rollout]` and no error.
2. **Act:** Calls the `ListRollouts` method of the `fs.Store` with a context and the same `ListWithOptions` request used in the mock setup.
3. **Assert:** Verifies that there was no error returned by `ListRollouts`.

### `TestCountRollouts`
#### Description
Tests the `CountRollouts` method of the `fs.Store` struct. It ensures that the method calls the `CountRollouts` method of the underlying `SnapshotStore` with the correct arguments and returns the expected result.

#### Inputs
This function takes a single argument:
| Name | Type | Description |
|:-----|:-----|:------------|
| t | *testing.T | The testing object used to control the test execution and report results. |

#### Outputs
This function does not return any values.

#### Internal Logic
1. **Arrange:** Creates a mock `SnapshotStore` and a new `fs.Store` instance usingthe mock. It sets up the mock to expect a call to `CountRollouts` with a specific resource and return a zero count and no error.
2. **Act:** Calls the `CountRollouts` method of the `fs.Store` with a context and the same resource used in the mock setup.
3. **Assert:** Verifies that there was no error returned by `CountRollouts`.

### `TestGetNamespace`
#### Description
Tests the `GetNamespace` method of the `fs.Store` struct. It verifies that the method calls the `GetNamespace` method of the underlying `SnapshotStore` with the correct arguments and returns the expected result.

#### Inputs
This function takes a single argument:
| Name | Type | Description |
|:-----|:-----|:------------|
| t | *testing.T | The testing object used to control the test execution and report results. |

#### Outputs
This function does not return any values.

#### Internal Logic
1. **Arrange:** Creates a mock `SnapshotStore` and a new `fs.Store` instance using the mock. It sets up the mock to expect a call to `GetNamespace` with a specific namespace and return a dummy `flipt.Namespace` and no error.
2. **Act:** Calls the `GetNamespace` method of the `fs.Store` with a context and the same namespace used in the mock setup.
3. **Assert:** Verifies that there was no error returned by `GetNamespace`.

### `TestListNamespaces`
#### Description
Tests the `ListNamespaces` method of the `fs.Store` struct. It checks if the method correctly calls the `ListNamespaces` method of the underlying `SnapshotStore` with the provided arguments and returns the expected result.

#### Inputs
This function takes a single argument:
| Name | Type | Description |
|:-----|:-----|:------------|
| t | *testing.T | The testing object used to control the test execution and report results. |

#### Outputs
This function does not return any values.

#### Internal Logic
1. **Arrange:** Creates a mock `SnapshotStore` and a new `fs.Store` instance using the mock. It sets up the mock to expect a call to `ListNamespaces` with a specific `ListWithOptions` request for a `ReferenceRequest` and return a dummy `storage.ResultSet[*flipt.Namespace]` and no error.
2. **Act:** Calls the `ListNamespaces` method of the `fs.Store` with a context and the same `ListWithOptions` request used in the mock setup.
3. **Assert:** Verifies that there was no error returned by `ListNamespaces`.

### `TestCountNamespaces`
#### Description
Tests the `CountNamespaces` method of the `fs.Store` struct. It ensures that the method calls the `CountNamespaces` method of the underlying `SnapshotStore` with the correct arguments and returns the expected result.

#### Inputs
This function takes a single argument:
| Name | Type | Description |
|:-----|:-----|:------------|
| t | *testing.T | The testing object used to control the test execution and report results. |

#### Outputs
This function does not return any values.

#### Internal Logic
1. **Arrange:** Creates a mock `SnapshotStore` and a new `fs.Store` instance using the mock. It sets up the mock to expect a call to `CountNamespaces` with a specific `ReferenceRequest` and return a zero count and no error.
2. **Act:** Calls the `CountNamespaces` method of the `fs.Store` with a context and the same `ReferenceRequest` used in the mock setup.
3. **Assert:** Verifies that there was no error returned by `CountNamespaces`.

### `TestGetEvaluationRules`
#### Description
Tests the `GetEvaluationRules` method of the `fs.Store` struct. It verifies that the method calls the `GetEvaluationRules` method of the underlying `SnapshotStore` with the correct arguments and returns the expected result.

#### Inputs
This function takes a single argument:
| Name | Type | Description |
|:-----|:-----|:------------|
| t | *testing.T | The testing object used to control the test execution and report results. |

#### Outputs
This function does not return any values.

#### Internal Logic
1. **Arrange:** Creates a mock `SnapshotStore` and a new `fs.Store` instance using the mock. It sets up the mock to expect a call to `GetEvaluationRules` with a specific resource and return an empty slice of `storage.EvaluationRule` and no error.
2. **Act:** Calls the `GetEvaluationRules` method of the `fs.Store` with a context and the same resource used in the mock setup.
3. **Assert:** Verifies that there was no error returned by `GetEvaluationRules`.

### `TestGetEvaluationDistributions`
#### Description
Tests the `GetEvaluationDistributions` method of the `fs.Store` struct. It checks if the method correctly calls the `GetEvaluationDistributions` method of the underlying `SnapshotStore` with the provided arguments and returns the expected result.

#### Inputs
This function takes a single argument:
| Name | Type | Description |
|:-----|:-----|:------------|
| t | *testing.T | The testing object used to control the test execution and report results. |

#### Outputs
This function does not return any values.

#### Internal Logic
1. **Arrange:** Creates a mock `SnapshotStore` and a new `fs.Store` instance using the mock. It sets up the mock to expect a call to `GetEvaluationDistributions` with a specific ID and return an empty slice of `storage.EvaluationDistribution` and no error.
2. **Act:** Calls the `GetEvaluationDistributions` method of the `fs.Store` with a context and the same ID used in the mock setup.
3. **Assert:** Verifies that there was no error returned by `GetEvaluationDistributions`.

### `TestGetEvaluationRollouts`
#### Description
Tests the `GetEvaluationRollouts` method of the `fs.Store` struct. It ensures that the method calls the `GetEvaluationRollouts` method of the underlying `SnapshotStore` with the correct arguments and returns the expected result.

#### Inputs
This function takes a single argument:
| Name | Type | Description |
|:-----|:-----|:------------|
| t | *testing.T | The testing object used to control the test execution and report results. |

#### Outputs
This function does not return any values.

#### Internal Logic
1. **Arrange:** Creates a mock `SnapshotStore` and a new `fs.Store` instance using the mock. It sets up the mock to expect a call to `GetEvaluationRollouts` with a specific resource and return an empty slice of `storage.EvaluationRollout` and no error.
2. **Act:** Calls the `GetEvaluationRollouts` method of the `fs.Store` with a context and the same resource used in the mock setup.
3. **Assert:** Verifies that there was no error returned by `GetEvaluationRollouts`.

### `TestGetVersion`
#### Description
Tests the `GetVersion` method of the `fs.Store` struct. It verifies that the method calls the `GetVersion` method of the underlying `SnapshotStore` with the correct arguments and returns the expected result.

#### Inputs
This function takes a single argument:
| Name | Type | Description |
|:-----|:-----|:------------|
| t | *testing.T | The testing object used to control the test execution and report results. |

#### Outputs
This function does not return any values.

#### Internal Logic
1. **Arrange:** Creates a mock `SnapshotStore` and a new `fs.Store` instance using the mock. It sets up the mock to expect a call to `GetVersion` with a specific namespace and return a version string "x0-y1" and no error.
2. **Act:** Calls the `GetVersion` method of the `fs.Store` with a context and the same namespace used in the mock setup.
3. **Assert:** Verifies that there was no error returned by `GetVersion` and that the returned version matches the expected string "x0-y1".

## Dependencies
The code relies on the following external libraries:
| Dependency | Purpose |
|:-----------|:--------|
| github.com/stretchr/testify/mock | Used for creating mock objects for testing |
| github.com/stretchr/testify/require | Used for test assertions |
| go.flipt.io/flipt/internal/common | Contains common utilities and types |
| go.flipt.io/flipt/internal/storage | Defines storage interfaces and types |
| go.flipt.io/flipt/rpc/flipt | Contains RPC definitions for Flipt |

## Error Handling
The tests in this file primarily use the `require.NoError` function to assert that no errors are returned from the tested methods. If an error occurs, the test will fail with an appropriate error message.

## Notes
- The tests in this file are focused on verifying the correct interaction between the `fs.Store` and its underlying `SnapshotStore`. They do not test the actual implementation of the storage operations.
- The `snapshotStoreMock` struct and its `View` method are defined at the end of the file to provide a mock implementation of the `storage.SnapshotStore` interface for testing purposes.