---
title: "Overview"
---

## High-level description
This directory contains integration tests for the authentication and authorization (authz) functionality in the Flipt system. It includes comprehensive test cases to verify the behavior of different authentication methods and authorization roles across various operations and namespaces.

## What does it do?
The code in this directory performs the following tasks:

1. Sets up a test environment for running integration tests on Flipt's authentication and authorization features.
2. Tests various authentication methods, including StaticToken, JWT, and K8s.
3. Verifies the behavior of different authorization roles (NoRole, Admin, Editor, Viewer, NamespacedViewer) across multiple namespaces.
4. Checks permissions for various operations such as reading, writing, and managing namespaces, flags, segments, rules, and rollouts.
5. Ensures that proper access controls are enforced based on the user's role and the resource's namespace.
6. Tests token expiration to verify that expired tokens are properly handled.

## Entry points
The main entry point for these tests is the `TestAuthz` function in `auth_test.go`. This function uses the `integration.Harness` to set up the test environment and calls the `Common` function defined in `auth.go` to run the actual test cases.

The `Common` function in `auth.go` is the core of the test suite. It orchestrates the execution of various test cases, covering different authentication methods, roles, and operations across namespaces.

## Key Files

1. `auth.go`:
   - Contains the `Common` function, which is the main test suite for authentication and authorization.
   - Defines helper functions for testing specific permissions and operations.
   - Implements the `clientCallSet` type for grouping and executing API calls.

2. `auth_test.go`:
   - Defines the `TestAuthz` function, which serves as the entry point for the integration tests.
   - Uses the `integration.Harness` to set up the test environment.

## Dependencies
The code relies on several external libraries and internal modules:

1. Go standard library:
   - `testing`: For running tests and reporting results.

2. External libraries:
   - `github.com/stretchr/testify/assert` and `github.com/stretchr/testify/require`: For test assertions.
   - `google.golang.org/grpc/codes` and `google.golang.org/grpc/status`: For handling gRPC status codes.

3. Internal Flipt packages:
   - `go.flipt.io/flipt/rpc/flipt`: Flipt's RPC package.
   - `go.flipt.io/flipt/rpc/flipt/auth`: Flipt's authentication package.
   - `go.flipt.io/flipt/sdk/go`: Flipt's Go SDK.
   - `go.flipt.io/build/testing/integration`: Custom integration testing package for Flipt.

These dependencies were chosen to provide robust testing capabilities, handle gRPC communication, and interact with Flipt's internal APIs and SDKs.

## Configuration
The tests use the `integration.TestOpts` structure to configure the test environment. This structure is passed to the `Common` function and likely includes settings such as:

- Authentication tokens
- Server endpoints
- Test-specific configurations

The exact fields of `integration.TestOpts` are not visible in the provided code, but they are crucial for setting up the test environment consistently across different test runs and environments.

Here's an example of how the `Common` function uses these options:

```go
func Common(t *testing.T, opts integration.TestOpts) {
    client, err := opts.ClientWithToken("token")
    require.NoError(t, err)
    // ... rest of the test setup and execution
}
```

This structure allows for flexible configuration of the test environment, making it easier to run these integration tests in different scenarios or with different Flipt configurations.