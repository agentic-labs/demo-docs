---
title: "ChatPopup.tsx"
---

## High-level description
This code defines a `ChatPopup` component in React that implements a chat interface for interacting with document chunks. It allows users to send messages, receive responses, and view related document chunks. The component manages the chat state, handles message streaming, and provides functionality to fetch completions from an API.

## Code Structure
The main `ChatPopup` component contains several interconnected functions and state variables. It uses the `DatasetAndUserContext` for accessing dataset information and the `AfMessage` component for rendering individual messages. The component also manages the chat state, handles message input, and interacts with an API for fetching completions.

## Symbols

### ChatPopup
#### Description
The main component that renders the chat interface and manages the chat functionality.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| selectedIds | Accessor&lt;string[]&gt; | An accessor for the selected chunk IDs |
| chunks | Accessor&lt;ScoreChunkDTO[]&gt; | An accessor for the available chunks |
| groupChunks | Accessor&lt;GroupScoreChunkDTO[]&gt; | An optional accessor for group chunks |
| setOpenChat | Setter&lt;boolean&gt; | A setter function to control the chat popup visibility |

#### Internal Logic
1. Initializes state variables for messages, loading state, and streaming state.
2. Implements functions for handling text area resizing, fetching completions, and managing the chat flow.
3. Uses `createEffect` to fetch messages and update the UI based on state changes.
4. Renders the chat interface with messages, input area, and control buttons.

### fetchCompletion
#### Description
Fetches a completion from the API based on the current chat context and user input.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| new_message_content | string | The content of the new message to be sent |

#### Internal Logic
1. Prepares the messages for the API request.
2. Sends a POST request to the API with the current chat context and selected chunk IDs.
3. Handles the streaming response and updates the messages state accordingly.

### handleReader
#### Description
Handles the streaming response from the API and updates the messages state.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| reader | ReadableStreamDefaultReader&lt;Uint8Array&gt; | The reader for the streaming response |

#### Internal Logic
1. Reads chunks from the stream and decodes them.
2. Updates the messages state with the new content.
3. Handles the completion of the stream.

## Side Effects
- The component uses `localStorage` to store and retrieve previous messages.
- It interacts with the DOM to resize the textarea and manage focus.

## Dependencies
- SolidJS for reactive programming and component rendering.
- Various utility types and components from the project's codebase.

## Error Handling
The component implements basic error handling for API requests and displays error messages using a custom event system.

This documentation provides a comprehensive overview of the `ChatPopup` component and its main functionalities. The component is designed to create an interactive chat interface for document-based conversations, with features like message streaming and chunk selection.