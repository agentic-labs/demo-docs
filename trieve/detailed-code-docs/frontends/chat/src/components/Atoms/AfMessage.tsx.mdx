---
title: "AfMessage.tsx"
---

## High-level description
The `AfMessage` component is a complex React component that renders a message in a chat-like interface. It supports different roles (user, assistant, system), allows editing of messages, and displays metadata and citations for assistant messages. The component also includes features like code highlighting, markdown rendering, and resizable panels for the message content and citations.

## Code Structure
The main `AfMessage` component is defined as a function that takes `AfMessageProps` as input. It uses various Solid.js primitives like `createSignal`, `createEffect`, and `createMemo` to manage its state and side effects. The component is composed of several nested components and conditional renders based on the message role and content.

## Symbols

### AfMessage
#### Description
The main component that renders a message in the chat interface.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| props | AfMessageProps | Properties for the message, including role, content, and callbacks |

#### Internal Logic
1. Sets up various signals for managing component state (editing, content, metadata, etc.)
2. Uses `createEffect` to synchronize heights of left and right columns
3. Processes the message content to extract metadata and citations
4. Renders the message content with markdown support and code highlighting
5. Handles editing of user messages
6. Renders citations and metadata for assistant messages

### displayMessage
#### Description
A memoized function that processes the message content and extracts metadata.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| content | string | Processed message content |
| chunkMetadatas | ChunkMetadataWithVotes[] | Extracted metadata for citations |

### resizeTextarea
#### Description
A function to automatically resize the textarea for editing messages.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| textarea | HTMLTextAreaElement | The textarea element to resize |

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| solid-js | Core library for reactive UI components |
| solid-icons | Icon components |
| solid-markdown | Markdown rendering |
| @corvu/resizable | Resizable panel component |
| remark-gfm, remark-breaks, rehype-sanitize | Markdown processing plugins |

## Performance Considerations
The component uses memoization and effects to optimize rendering and processing of message content. The resizable panels and dynamic height synchronization may impact performance for large messages or frequent updates.

## Error Handling
The component includes basic error handling for edge cases, such as malformed message content or missing metadata. However, more robust error handling could be implemented for production use.

## TODOs
- Consider implementing more robust error handling for edge cases
- Optimize performance for large messages or frequent updates
- Improve accessibility of the component, especially for the code highlighting and markdown rendering parts