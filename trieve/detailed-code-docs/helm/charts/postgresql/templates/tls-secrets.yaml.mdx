---
title: "tls-secrets.yaml"
---

## High-level description
This Kubernetes YAML file defines a Secret object that contains TLS certificates and keys for a PostgreSQL deployment. It generates a self-signed CA certificate, a server certificate signed by the CA, and stores them along with their respective keys in the secret.

## Code Structure
The code first checks if TLS secret creation is enabled. If enabled, it generates a CA and server certificate, then defines a Kubernetes Secret object containing these certificates and their keys.

## Symbols
### `tls-secrets.yaml`
#### Description
This code defines a Kubernetes Secret containing TLS certificates and keys for a PostgreSQL deployment. It generates a self-signed CA, a server certificate signed by the CA, and stores them in the secret.

#### Inputs
This code snippet doesn't have explicit inputs, but it relies on values from the Helm chart context, including:

| Name | Description |
|:-----|:------------|
| `.Release.Namespace` | The namespace where the secret will be created. |
| `.Values.clusterDomain` | The cluster domain used for generating certificate Subject Alternative Names. |
| `.Values.commonLabels` | Common labels to apply to the secret. |
| `.Values.commonAnnotations` | Common annotations to apply to the secret. |

#### Outputs
The code outputs a Kubernetes YAML definition for a Secret object.

#### Internal Logic
1. **Conditional Creation:** The code first checks if TLS secret creation is enabled using `{{- if (include "postgresql.v1.createTlsSecret" . ) }}`.
2. **Secret Name Generation:** It generates a secret name using the release name and "-crt" suffix: `{{- $secretName := printf "%s-crt" (include "common.names.fullname" .) }}`.
3. **CA Generation:** It generates a self-signed CA certificate with a validity of 365 days: `{{- $ca := genCA "postgresql-ca" 365 }}`.
4. **Certificate Subject Alternative Names:** It constructs a list of Subject Alternative Names for the server certificate, including various combinations of the release name, namespace, cluster domain, and service names: `{{- $altNames := ... }}`.
5. **Server Certificate Generation:** It generates a server certificate signed by the generated CA, with the specified Subject Alternative Names and a validity of 365 days: `{{- $cert := genSignedCert $fullname nil $altNames 365 $ca }}`.
6. **Secret Definition:** It defines a Kubernetes Secret object with the generated name, namespace, labels, and annotations.
7. **Secret Data:** It populates the secret data with the server certificate (`tls.crt`), server key (`tls.key`), and CA certificate (`ca.crt`). It uses the `include "common.secrets.lookup"` function to allow overriding these values from other secrets.

## Dependencies
This code depends on the following Helm functions:

| Dependency | Purpose |
|:-----------|:--------|
| `include` | Includes other templates or functions. |
| `genCA` | Generates a CA certificate. |
| `genSignedCert` | Generates a signed certificate. |
| `printf` | Formats strings. |
| `list` | Creates a list. |

## Error Handling
This code doesn't implement specific error handling. Any errors during template rendering will be handled by Helm.
