---
title: "secrets.yaml"
---

## High-level description
This code defines a Kubernetes Secret resource that stores sensitive information for a PostgreSQL database. It includes passwords for various users (postgres, custom user, replication user) and potentially LDAP credentials. It also defines Service Binding secrets for both the 'postgres' user and a custom user, facilitating secure access to the database.

## Code Structure
The code first defines several variables using Helm template language to fetch values from various sources like values file, default values, and generated secrets. These variables hold information like hostnames, passwords, usernames, etc. Then, it conditionally creates Kubernetes Secret resources based on the provided configuration values. It creates a primary secret for storing database credentials and optionally creates additional secrets for service bindings.

## References
This code references several Helm functions and variables, including:
- `include`: Includes a template and returns its output.
- `postgresql.v1.primary.fullname`: Returns the full name of the primary PostgreSQL instance.
- `postgresql.v1.service.port`: Returns the service port for PostgreSQL.
- `common.secrets.lookup`: Retrieves a secret value from a specified secret.
- `common.secrets.passwords.manage`: Generates or retrieves a password.
- `common.names.fullname`: Returns the full name of the release.
- `common.labels.standard`: Returns standard labels for the release.
- `common.tplvalues.render`: Renders a template with provided values.

## Symbols

### `secrets.yaml`
#### Description
This code defines a Kubernetes Secret resource that stores sensitive information for a PostgreSQL database. It includes passwords for various users (postgres, custom user, replication user) and potentially LDAP credentials. It also defines Service Binding secrets for both the 'postgres' user and a custom user, facilitating secure access to the database.

#### Inputs
This code snippet doesn't have explicit input parameters. It relies on values passed to it through the Helm templating engine. These values are typically defined in `values.yaml` or provided during Helm installation.

#### Outputs
This code generates Kubernetes YAML manifests for Secret resources. The output depends on the configuration values provided. It can generate:
- A Secret resource containing database credentials.
- Additional Secret resources for service bindings if enabled.

#### Internal Logic
1. **Define variables:** The code starts by defining several variables using Helm template language. These variables store values like hostnames, passwords, usernames, etc., retrieved from various sources like values file, default values, and generated secrets.
2. **Create primary Secret:** It conditionally creates a Kubernetes Secret resource named using `common.names.fullname`. This secret stores the following data:
    - `postgres-password`: Password for the 'postgres' user.
    - `password`: Password for the custom user.
    - `replication-password`: Password for the replication user (if replication is enabled).
    - `ldap-password`: LDAP bind password (if LDAP is enabled).
3. **Create Service Binding Secrets:** If `serviceBindings.enabled` is true, the code generates two additional Secret resources:
    - One for the 'postgres' user, containing connection details for the 'postgres' user and database.
    - One for the custom user, containing connection details for the custom user and database.

#### Side Effects
This code generates Kubernetes Secret resources, which are then applied to the cluster.

## Dependencies
This code depends on the following Helm libraries:
| Dependency | Purpose |
|:-----------|:--------|
| `common.secrets.lookup` | Retrieves a secret value from a specified secret. |
| `common.secrets.passwords.manage` | Generates or retrieves a password. |
| `common.names.fullname` | Returns the full name of the release. |
| `common.labels.standard` | Returns standard labels for the release. |
| `common.tplvalues.render` | Renders a template with provided values. |

## Configuration
This code relies on configuration values passed through the Helm templating engine. These values are typically defined in `values.yaml` or provided during Helm installation. Some key configuration options include:
- `architecture`: PostgreSQL architecture (standalone or replication).
- `auth`: Authentication configuration, including passwords for various users.
- `serviceBindings.enabled`: Enables/disables service bindings.

## Error Handling
This code doesn't implement specific error handling beyond basic exception raising.

## Logging
This code doesn't implement logging.
