---
title: "svc-headless.yaml"
---

## High-level description
This YAML file defines a headless Kubernetes Service for the primary PostgreSQL instance in a Helm chart. It's designed to allow direct communication between PostgreSQL pods, which is crucial for their initialization and operation.

## Symbols

### Service
#### Description
This Kubernetes Service resource is of type ClusterIP with `clusterIP: None`, making it a headless service. It's specifically tailored for the primary PostgreSQL instance, enabling pod-to-pod communication within the StatefulSet.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| .Release.Namespace | String | The Kubernetes namespace where the service will be deployed |
| .Values.commonLabels | Map | Common labels to be applied to the service |
| .Values.primary.service.headless.annotations | Map | Annotations specific to the headless service |
| .Values.commonAnnotations | Map | Common annotations to be applied to the service |
| .Values.primary.podLabels | Map | Labels to be applied to the primary PostgreSQL pods |

#### Internal Logic
1. Sets the service name using a template function `postgresql.v1.primary.svc.headless`.
2. Applies labels using the `common.labels.standard` helper, including a component label for the primary.
3. Merges and applies annotations from `.Values.primary.service.headless.annotations` and `.Values.commonAnnotations`.
4. Adds a specific annotation to tolerate unready endpoints due to a Kubernetes issue.
5. Configures the service as headless (`clusterIP: None`) and enables `publishNotReadyAddresses`.
6. Defines a single port for PostgreSQL traffic.
7. Sets the selector to match primary PostgreSQL pods using merged labels.

## Side Effects
- Creates a headless Kubernetes Service resource in the specified namespace.
- Enables communication between PostgreSQL pods before they're fully ready.

## Configuration
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| .Values.primary.service.headless.annotations | Map | - | Custom annotations for the headless service |
| .Values.commonAnnotations | Map | - | Common annotations applied to all resources |
| .Values.primary.podLabels | Map | - | Labels applied to primary PostgreSQL pods |
| .Values.commonLabels | Map | - | Common labels applied to all resources |

## Notes
1. The service uses `publishNotReadyAddresses: true` to allow communication between pods even when they're not ready.
2. A specific annotation (`service.alpha.kubernetes.io/tolerate-unready-endpoints: "true"`) is added to address a Kubernetes issue with unready endpoints.
3. The service port is set using a template function `postgresql.v1.service.port`.

This headless service is crucial for the proper functioning of a PostgreSQL cluster, as it allows the pods to discover and communicate with each other during initialization and normal operation.