---
title: "networkpolicy.yaml"
---

## High-level description
This code defines a Kubernetes NetworkPolicy for the primary instance of a PostgreSQL database deployed using a Helm chart. It controls network traffic to and from the primary PostgreSQL pod, allowing communication from specific sources like read replicas and potentially clients with specific labels.

## Code Structure
The code uses conditional logic based on Helm values to define a NetworkPolicy resource. It sets up rules for ingress and egress traffic based on configuration options like allowing external access or communication with read replicas.

## References
* `postgresql.v1.primary.fullname`: This likely refers to a Helm template that generates the full name of the primary PostgreSQL instance.
* `common.labels.standard`, `common.labels.matchLabels`: These likely refer to Helm templates that manage standard labels for the PostgreSQL deployment.
* `common.tplvalues.render`, `common.tplvalues.merge`: These likely refer to Helm templates that handle rendering and merging of values.
* `common.names.namespace`: This likely refers to a Helm template that defines the namespace for the deployment.
* `common.capabilities.networkPolicy.apiVersion`: This likely refers to a Helm template that determines the appropriate API version for NetworkPolicy based on Kubernetes cluster capabilities.

## Symbols
### `helm/charts/postgresql/templates/primary/networkpolicy.yaml`
#### Description
This code defines a Kubernetes NetworkPolicy resource for the primary PostgreSQL instance. It controls network traffic to and from the pod based on various configuration options.

#### Inputs
This code snippet doesn't have explicit input parameters. It relies on Helm values passed to the template. Some key values influencing the NetworkPolicy definition include:

| Name | Type | Description |
|:-----|:-----|:------------|
| `.Values.primary.networkPolicy.enabled` | boolean | Enables or disables the NetworkPolicy. |
| `.Values.primary.networkPolicy.allowExternalEgress` | boolean | If true, allows all outbound traffic from the primary PostgreSQL pod. |
| `.Values.primary.networkPolicy.allowExternal` | boolean | If true, allows ingress traffic from any source. |
| `.Values.primary.networkPolicy.extraEgress` | list | Allows defining additional egress rules. |
| `.Values.primary.networkPolicy.extraIngress` | list | Allows defining additional ingress rules. |
| `.Values.primary.networkPolicy.ingressNSMatchLabels` | map | Allows specifying namespace labels for ingress traffic. |
| `.Values.primary.networkPolicy.ingressNSPodMatchLabels` | map | Allows specifying pod labels within the selected namespaces for ingress traffic. |
| `.Values.containerPorts.postgresql` | integer | Defines the PostgreSQL container port. |
| `.Values.metrics.enabled` | boolean | Enables or disables metrics exposure. |
| `.Values.metrics.containerPorts.metrics` | integer | Defines the metrics container port. |
| `.Values.primary.podLabels` | map | Defines labels for the primary PostgreSQL pod. |
| `.Values.commonLabels` | map | Defines common labels for the deployment. |
| `.Values.commonAnnotations` | map | Defines common annotations for the deployment. |

#### Outputs
This code defines a Kubernetes NetworkPolicy resource in YAML format.

#### Internal Logic
1. **Conditional Creation:** The NetworkPolicy is created only if `.Values.primary.networkPolicy.enabled` is true.
2. **Metadata:** Sets standard metadata like name, namespace, and labels for the NetworkPolicy.
3. **Pod Selector:** Defines which pods the NetworkPolicy applies to, using labels to select the primary PostgreSQL pod.
4. **Egress Rules:**
   - If `.Values.primary.networkPolicy.allowExternalEgress` is true, allows all outbound traffic.
   - Otherwise, allows DNS resolution (port 53 UDP/TCP) and connections to read replicas on the PostgreSQL port.
   - Includes additional egress rules defined in `.Values.primary.networkPolicy.extraEgress`.
5. **Ingress Rules:**
   - Allows traffic on the PostgreSQL port and the metrics port if enabled.
   - If `.Values.primary.networkPolicy.allowExternal` is false, restricts ingress traffic to:
     - Pods with matching labels.
     - Pods with the label `{{ template "postgresql.v1.primary.fullname" . }}-client: "true"`.
     - Pods within namespaces matching labels defined in `.Values.primary.networkPolicy.ingressNSMatchLabels`, optionally further filtered by pod labels in `.Values.primary.networkPolicy.ingressNSPodMatchLabels`.
   - Includes additional ingress rules defined in `.Values.primary.networkPolicy.extraIngress`.

## Dependencies
This code depends on Helm for template rendering and value substitution. It also relies on Kubernetes APIs for the NetworkPolicy resource.

## Configuration
This code relies heavily on Helm values for configuration. See the "Inputs" section for a detailed list of configurable options.
