---
title: "metrics-svc.yaml"
---

## High-level description
This Kubernetes YAML file defines a Service resource named `&lt;release-name&gt;-postgresql-metrics` that exposes metrics from the primary PostgreSQL instance. It uses a ClusterIP type by default and allows customization of ports, session affinity, and annotations.

## Code Structure
This code snippet defines a Kubernetes Service resource using a YAML template. It leverages conditional logic (`if`) and includes other templates to generate the final resource definition.

## References
* `postgresql.v1.primary.fullname`: This template likely defines the full name of the primary PostgreSQL instance.
* `common.labels.standard`: This template likely defines standard labels to be applied to the service.
* `common.tplvalues.merge`: This template likely merges multiple values into a single dictionary.
* `common.tplvalues.render`: This template likely renders values into a string representation.
* `common.labels.matchLabels`: This template likely generates label selectors for the service.

## Symbols
### `helm/charts/postgresql/templates/primary/metrics-svc.yaml`
#### Description
This code defines a Kubernetes Service resource for exposing metrics from the primary PostgreSQL instance. It uses a ClusterIP type by default and allows customization of ports, session affinity, and annotations.

#### Inputs
This code snippet doesn't have explicit input parameters. It relies on values passed from the Helm chart or parent templates.

#### Outputs
A Kubernetes YAML definition for a Service resource.

#### Internal Logic
1. **Conditional Creation:** The service is created only if `.Values.metrics.enabled` is true.
2. **Name and Namespace:** The service name is generated using the release name and `-postgresql-metrics` suffix. The namespace is taken from `.Release.Namespace`.
3. **Labels:** Standard labels are applied using the `common.labels.standard` template. An additional label `app.kubernetes.io/component: metrics` is added.
4. **Annotations:**  Annotations are added from `.Values.metrics.service.annotations` and `.Values.commonAnnotations` using the `common.tplvalues.merge` and `common.tplvalues.render` templates.
5. **Spec:**
    * `type`: Set to `ClusterIP` by default.
    * `sessionAffinity`: Configured using `.Values.metrics.service.sessionAffinity`.
    * `clusterIP`: Can be set to a specific IP using `.Values.metrics.service.clusterIP`.
    * `ports`: Defines a port named `http-metrics` with the port number from `.Values.metrics.service.ports.metrics`.
    * `selector`: Selects pods with labels matching those defined in `.Values.primary.podLabels` and `.Values.commonLabels` using the `common.labels.matchLabels` template. The selector also includes `app.kubernetes.io/component: primary`.

## Dependencies
This code snippet depends on the following Helm templates:

| Dependency | Purpose |
|:-----------|:--------|
| `postgresql.v1.primary.fullname` | Provides the full name of the primary PostgreSQL instance. |
| `common.labels.standard` | Provides standard labels for the service. |
| `common.tplvalues.merge` | Merges multiple values into a single dictionary. |
| `common.tplvalues.render` | Renders values into a string representation. |
| `common.labels.matchLabels` | Generates label selectors for the service. | 
