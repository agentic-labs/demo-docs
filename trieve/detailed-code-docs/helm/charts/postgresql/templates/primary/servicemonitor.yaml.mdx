---
title: "servicemonitor.yaml"
---

## High-level description
This code defines a Kubernetes ServiceMonitor resource for a PostgreSQL primary instance using the Prometheus Operator. It sets up monitoring of the PostgreSQL instance by specifying how Prometheus should scrape metrics from the service.

## Code Structure
The code is a single YAML template that defines a ServiceMonitor resource. It uses conditional logic to include or exclude certain sections based on values provided in the `Values` object.

## References
This template references several helper templates from the `common` directory, including:
- `postgresql.v1.primary.fullname`: Generates the full name of the PostgreSQL primary service.
- `common.tplvalues.merge`: Merges multiple label sets.
- `common.labels.standard`: Generates standard labels for the resource.
- `common.tplvalues.render`: Renders a value from the `Values` object.
- `common.labels.matchLabels`: Generates matchLabels selectors from a label set.

## Symbols
### `helm/charts/postgresql/templates/primary/servicemonitor.yaml`
#### Description
This YAML template defines a ServiceMonitor resource for monitoring a PostgreSQL primary instance using Prometheus.

#### Inputs
This template uses values from the `Values` object passed to the Helm chart. The relevant values are:
| Name | Type | Description |
|:-----|:-----|:------------|
| `.Values.metrics.enabled` | bool | Enables/disables metrics collection. |
| `.Values.metrics.serviceMonitor.enabled` | bool | Enables/disables the ServiceMonitor resource. |
| `.Values.metrics.serviceMonitor.namespace` | string | Namespace where the ServiceMonitor should be deployed. |
| `.Values.metrics.serviceMonitor.labels` | map[string]string | Custom labels to add to the ServiceMonitor. |
| `.Values.commonLabels` | map[string]string | Common labels to add to the ServiceMonitor. |
| `.Values.commonAnnotations` | map[string]string | Common annotations to add to the ServiceMonitor. |
| `.Values.metrics.serviceMonitor.jobLabel` | string | Job label to use for the ServiceMonitor. |
| `.Values.metrics.serviceMonitor.selector` | map[string]string | Labels to select the PostgreSQL service for monitoring. |
| `.Values.metrics.serviceMonitor.interval` | string | Interval at which Prometheus should scrape metrics. |
| `.Values.metrics.serviceMonitor.scrapeTimeout` | string | Timeout for scraping metrics. |
| `.Values.metrics.serviceMonitor.relabelings` | list | Relabeling rules for the ServiceMonitor. |
| `.Values.metrics.serviceMonitor.metricRelabelings` | list | Metric relabeling rules for the ServiceMonitor. |
| `.Values.metrics.serviceMonitor.honorLabels` | bool | Whether to honor existing labels on the scraped metrics. |

#### Outputs
This template renders a YAML manifest for a ServiceMonitor resource.

#### Internal Logic
The template uses conditional logic (`{{- if ... }}`) to include or exclude certain sections based on the values provided in the `Values` object. 

- It checks if metrics and the ServiceMonitor are enabled.
- It sets the metadata for the ServiceMonitor, including name, namespace, and labels.
- It configures the selector to target the PostgreSQL service based on labels.
- It defines an endpoint for scraping metrics on the `http-metrics` port.
- It allows customization of scraping interval, timeout, relabeling rules, and honorLabels behavior.
- It sets the namespace selector to match the current release namespace.

## Dependencies
This template depends on the Prometheus Operator being installed in the Kubernetes cluster.

## Configuration
This template uses values from the `Values` object passed to the Helm chart for configuration. See the "Inputs" section for a detailed description of the configurable values.
