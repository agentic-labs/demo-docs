---
title: "svc.yaml"
---

## High-level description
This code defines a Kubernetes Service for PostgreSQL read replicas. It is applied only when the `architecture` value is set to `replication`. The service exposes the PostgreSQL read replicas on a configurable port and allows access to them based on the selected service type.

## Code Structure
The code uses a series of nested `if` statements to conditionally define different parts of the service based on the provided values. 

- The outermost `if` block checks for `replication` architecture.
- Inside, it defines the service with configurable `type`, `externalTrafficPolicy`, `loadBalancerSourceRanges`, `loadBalancerIP`, `clusterIP`, `sessionAffinity`, and `sessionAffinityConfig`.
- It defines a `tcp-postgresql` port and allows defining `extraPorts`.
- Finally, it sets up selectors to target pods with the `app.kubernetes.io/component: read` label.

## References
This code references several values from `values.yaml`:
- `.Values.architecture`
- `.Values.commonLabels`
- `.Values.readReplicas.service`
- `.Values.readReplicas.podLabels`

## Symbols
### `helm/charts/postgresql/templates/read/svc.yaml`
#### Description
This code defines a Kubernetes Service resource for PostgreSQL read replicas. It allows configuring various aspects of the service, including its type, load balancing options, session affinity, and port mappings.

#### Inputs
This code snippet doesn't have explicit input parameters. It relies on values provided through Helm's templating system, primarily from a `values.yaml` file.

#### Outputs
This code generates a Kubernetes YAML manifest for a Service object.

#### Internal Logic
1. **Check for Replication Architecture:** The code first checks if the `architecture` value is set to `replication`. If not, the service definition is skipped.
2. **Define Service Metadata:** It sets the service name, namespace, and labels based on provided values.
3. **Configure Service Spec:**
    - **Type:** Sets the service type (e.g., `ClusterIP`, `NodePort`, `LoadBalancer`).
    - **External Traffic Policy:** Configures how external traffic is routed to the service endpoints.
    - **Load Balancing:** Sets load balancer options like source ranges and IP addresses.
    - **Session Affinity:** Configures session affinity for the service.
    - **Ports:** Defines the ports exposed by the service, including the main PostgreSQL port and any extra ports.
4. **Define Selectors:** Sets selectors to target pods with specific labels, ensuring the service routes traffic to the correct pods.

## Dependencies
This code depends on the Kubernetes API version `v1` for defining the Service resource.

## Configuration
This code relies heavily on configuration values provided through Helm. Key configuration options include:

| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| `architecture` | string |  | Determines if the service is created (must be set to `replication`). |
| `commonLabels` | object |  | Common labels applied to the service. |
| `readReplicas.service.type` | string |  | Type of the service (e.g., `ClusterIP`, `NodePort`, `LoadBalancer`). |
| `readReplicas.service.externalTrafficPolicy` | string |  | Policy for routing external traffic. |
| `readReplicas.service.loadBalancerSourceRanges` | list |  | Allowed IP address ranges for accessing the load balancer. |
| `readReplicas.service.loadBalancerIP` | string |  | Static IP address for the load balancer. |
| `readReplicas.service.sessionAffinity` | string |  | Type of session affinity to use. |
| `readReplicas.service.sessionAffinityConfig` | object |  | Configuration for session affinity. |
| `readReplicas.service.nodePorts.postgresql` | integer |  | Node port to use for the PostgreSQL service. |
| `readReplicas.service.extraPorts` | list |  | Additional ports to expose through the service. |
| `readReplicas.podLabels` | object |  | Labels used to select the PostgreSQL read replica pods. | 
