---
title: "statefulset.yaml"
---

## High-level description
This code defines a Kubernetes StatefulSet for deploying read replicas of a PostgreSQL database in a replication architecture. It specifies the replica count, service name, pod template, container configurations, volumes, and other settings for the read replicas.

## Code Structure
The code defines a single Kubernetes StatefulSet resource. It uses various conditional statements (`{{- if ... }}`) to include or exclude specific configurations based on the provided values. The code is heavily templated and relies on external functions and variables (e.g., `include`, `toYaml`, `.Values`) to generate the final resource definition.

## References
- `postgresql.v1.readReplica.fullname`: Returns the full name of the read replica StatefulSet.
- `postgresql.v1.readReplica.svc.headless`: Returns the headless service name for the read replicas.
- `postgresql.v1.serviceAccountName`: Returns the service account name for the PostgreSQL pods.
- `postgresql.v1.image`: Returns the Docker image for the PostgreSQL container.
- `postgresql.v1.metrics.image`: Returns the Docker image for the PostgreSQL metrics exporter container.
- `postgresql.v1.primary.fullname`: Returns the full name of the primary PostgreSQL instance.
- `postgresql.v1.service.port`: Returns the service port for the PostgreSQL instances.
- `postgresql.v1.secretName`: Returns the secret name for PostgreSQL credentials.
- `postgresql.v1.adminPasswordKey`: Returns the key for the admin password in the secret.
- `postgresql.v1.userPasswordKey`: Returns the key for the user password in the secret.
- `postgresql.v1.replicationPasswordKey`: Returns the key for the replication password in the secret.
- `postgresql.v1.tlsCert`: Returns the path to the TLS certificate file.
- `postgresql.v1.tlsCertKey`: Returns the path to the TLS certificate key file.
- `postgresql.v1.tlsCACert`: Returns the path to the TLS CA certificate file.
- `postgresql.v1.tlsCRL`: Returns the path to the TLS CRL file.
- `postgresql.v1.readinessProbeCommand`: Returns the command for the readiness probe.
- `postgresql.v1.readReplicas.extendedConfigmapName`: Returns the ConfigMap name for extended configuration.
- `postgresql.v1.tlsSecretName`: Returns the secret name for TLS certificates.
- `common.capabilities.statefulset.apiVersion`: Returns the appropriate API version for StatefulSet.
- `common.tplvalues.merge`: Merges multiple values into a single dictionary.
- `common.labels.standard`: Generates standard labels for the resource.
- `common.labels.matchLabels`: Generates matchLabels for the pod selector.
- `common.affinities.pods`: Generates pod affinity and anti-affinity rules.
- `common.affinities.nodes`: Generates node affinity rules.
- `common.compatibility.renderSecurityContext`: Renders the security context configuration.
- `common.resources.preset`: Returns resource requests and limits based on a preset.
- `common.tplvalues.render`: Renders a template with provided values.
- `common.storage.class`: Determines and sets the storage class for persistent volumes.

## Symbols

### `helm/charts/postgresql/templates/read/statefulset.yaml`
#### Description
This code defines a Kubernetes StatefulSet for deploying read replicas of a PostgreSQL database in a replication architecture. It specifies the replica count, service name, pod template, container configurations, volumes, and other settings for the read replicas.

#### Inputs
This code snippet doesn't have explicit input parameters. It relies on values passed to the Helm chart during deployment. These values are accessible through the `.` object and its properties (e.g., `.Values.readReplicas.replicaCount`).

#### Outputs
This code generates a Kubernetes YAML manifest for a StatefulSet object.

#### Internal Logic
The code uses various conditional statements (`{{- if ... }}`) to include or exclude specific configurations based on the provided values. For example:
- It checks if the `architecture` value is set to `replication` before defining the StatefulSet.
- It includes the `updateStrategy` section only if the `readReplicas.updateStrategy` value is defined.
- It mounts the `postgresql-password` volume only if `auth.usePasswordFiles` is set to `true`.

The code also utilizes several Helm template functions and variables:
- `include`: Includes external template files or functions.
- `toYaml`: Converts a Go object to YAML format.
- `.Values`: Accesses values passed to the Helm chart.

The StatefulSet definition includes:
- `replicas`: Specifies the number of read replica pods.
- `serviceName`: Sets the headless service name for the replicas.
- `selector`: Defines labels to select pods managed by the StatefulSet.
- `template`: Specifies the pod template for the replicas, including:
    - `metadata`: Defines labels and annotations for the pods.
    - `spec`: Configures the pod's specifications, such as:
        - `serviceAccountName`: Sets the service account for the pod.
        - `initContainers`: Defines init containers for tasks like copying certificates or setting permissions.
        - `containers`: Specifies the main containers for the pod, including:
            - `postgresql`: Runs the PostgreSQL database as a read replica.
            - `metrics`: Optionally runs a metrics exporter sidecar.
        - `volumes`: Defines volumes used by the containers.

## Dependencies
This code depends on the following external libraries or modules:
| Dependency | Purpose |
|:-----------|:--------|
| Helm template functions | Provides functions for templating and value manipulation. |

### Configuration
This code relies on various configuration options passed to the Helm chart. These options are accessible through the `.Values` object and its properties. Refer to the `values.schema.json` file for a complete list of configurable options and their descriptions.

## Error Handling
This code snippet doesn't implement specific error handling beyond basic exception raising.

## Logging
This code snippet doesn't implement logging.
