---
title: "networkpolicy.yaml"
---

## High-level description
This Kubernetes NetworkPolicy resource defines network access rules for PostgreSQL read replicas in a replication architecture. It controls both ingress and egress traffic for the read replica pods, ensuring secure communication within the cluster.

## Code Structure
The file is a Helm template for a Kubernetes NetworkPolicy, with conditional blocks that customize the policy based on various configuration values. It defines rules for both ingress and egress traffic, with options to allow or restrict external access.

## Symbols

### NetworkPolicy Resource
#### Description
Defines a Kubernetes NetworkPolicy resource to control network traffic for PostgreSQL read replicas.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| .Values.architecture | string | The PostgreSQL deployment architecture |
| .Values.readReplicas.networkPolicy.enabled | boolean | Whether the network policy is enabled |
| .Values.readReplicas.networkPolicy.allowExternalEgress | boolean | Whether to allow unrestricted egress traffic |
| .Values.containerPorts.postgresql | number | The PostgreSQL container port |
| .Values.metrics.enabled | boolean | Whether metrics are enabled |
| .Values.metrics.containerPorts.metrics | number | The metrics container port |
| .Values.readReplicas.networkPolicy.allowExternal | boolean | Whether to allow external ingress traffic |
| .Values.readReplicas.networkPolicy.ingressNSMatchLabels | map | Namespace labels to match for ingress |
| .Values.readReplicas.networkPolicy.ingressNSPodMatchLabels | map | Pod labels to match for ingress |
| .Values.readReplicas.networkPolicy.extraEgress | list | Additional egress rules |
| .Values.readReplicas.networkPolicy.extraIngress | list | Additional ingress rules |

#### Internal Logic
1. Checks if the architecture is "replication" and network policy is enabled.
2. Defines metadata for the NetworkPolicy, including name, namespace, labels, and annotations.
3. Specifies pod selector for the policy using merged pod labels.
4. Sets policy types to both Ingress and Egress.
5. Configures egress rules:
   - Allows DNS resolution (UDP and TCP on port 53).
   - Permits outbound connections to the primary PostgreSQL instance.
   - Includes any extra egress rules if specified.
6. Configures ingress rules:
   - Allows incoming traffic on the PostgreSQL port and metrics port (if enabled).
   - Restricts ingress to specific pods and namespaces based on labels if external access is not allowed.
   - Includes any extra ingress rules if specified.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| common.capabilities.networkPolicy.apiVersion | Determines the appropriate NetworkPolicy API version |
| common.names.namespace | Provides the namespace name |
| common.labels.standard | Generates standard Kubernetes labels |
| common.tplvalues.render | Renders template values |
| common.tplvalues.merge | Merges multiple sets of values |
| common.labels.matchLabels | Generates label selectors for pod matching |

## Configuration
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| .Values.architecture | string | N/A | PostgreSQL deployment architecture |
| .Values.readReplicas.networkPolicy.enabled | boolean | N/A | Enables/disables the network policy |
| .Values.readReplicas.networkPolicy.allowExternalEgress | boolean | N/A | Allows/restricts external egress traffic |
| .Values.readReplicas.networkPolicy.allowExternal | boolean | N/A | Allows/restricts external ingress traffic |

Note: Default values are not specified in this template file.