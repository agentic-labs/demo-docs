---
title: "metrics-svc.yaml"
---

## High-level description
This code defines a Kubernetes Service named `[REPLICA_NAME]-metrics` in the `helm/charts/postgresql/templates/read` directory. This service exposes metrics from read replicas in a PostgreSQL replication setup. 

This service is only created if metrics are enabled (`Values.metrics.enabled`) and the architecture is set to `replication`.

## Code Structure
This code uses Helm templating to dynamically generate a Kubernetes Service definition. It leverages several Helm functions like `include`, `printf`, `eq`, `and`, `or`, `list`, `dict`, and `nindent` to construct the service definition based on provided values.

## References
* `postgresql.v1.readReplica.fullname`: This likely refers to a Helm template that defines the full name of a read replica.
* `common.labels.standard`: This likely refers to a Helm template that defines standard labels for Kubernetes objects.
* `common.tplvalues.merge`: This likely refers to a Helm template that merges multiple values together.
* `common.tplvalues.render`: This likely refers to a Helm template that renders values into a string.
* `common.labels.matchLabels`: This likely refers to a Helm template that generates label selectors for Kubernetes objects.

## Symbols
### `metrics-svc.yaml`
#### Description
This file defines a Kubernetes Service that exposes metrics from PostgreSQL read replicas.

#### Inputs
This template uses values from `Values`, which is a Helm structure containing configuration options. Relevant values include:
* `Values.metrics.enabled`: Boolean indicating whether metrics are enabled.
* `Values.architecture`: String indicating the PostgreSQL deployment architecture.
* `Values.metrics.service`: Structure containing service-specific configuration like annotations, session affinity, clusterIP, and ports.
* `Values.readReplicas.podLabels`: Labels specific to read replica pods.
* `Values.commonLabels`: Common labels applied to all resources.

#### Outputs
This template outputs a Kubernetes Service definition in YAML format.

#### Internal Logic
1. **Conditional Creation:** The service is created only if `Values.metrics.enabled` is true and `Values.architecture` is set to `replication`.
2. **Name and Namespace:** The service name is constructed using the name of the read replica and the namespace is taken from `Release.Namespace`.
3. **Labels and Annotations:** The service is labeled for easy identification and discovery. It also merges and applies annotations from `Values.metrics.service.annotations` and `Values.commonAnnotations`.
4. **Service Specification:**
    * `type`: Set to `ClusterIP`.
    * `sessionAffinity`: Configured based on `Values.metrics.service.sessionAffinity`.
    * `clusterIP`: Optionally set from `Values.metrics.service.clusterIP`.
    * `ports`: Defines a port named `http-metrics` with the port number specified in `Values.metrics.service.ports.metrics`.
5. **Pod Selector:** The service targets pods with labels matching those defined in `Values.readReplicas.podLabels` and `Values.commonLabels`, ensuring it routes traffic to the read replicas.

## Dependencies
This code depends on the Helm templating engine for its functionality. It also relies on several other Helm templates for common tasks like label generation and value merging.

### Configuration
This template relies on various configuration options provided through Helm values. These options control aspects like enabling metrics, service annotations, session affinity, clusterIP, and port numbers.
