---
title: "health-configmap.yaml"
---

## High-level description
This YAML file defines a Kubernetes ConfigMap for Redis health checks. It contains shell scripts for checking the readiness and liveness of Redis instances, including local instances, master instances, and Sentinel instances (if enabled). These scripts use `redis-cli` to ping Redis servers and verify their responses.

## Code Structure
The ConfigMap is structured with metadata and data sections. The data section contains multiple shell scripts for different health check scenarios, including TLS support and authentication handling.

## Symbols

### ConfigMap
#### Description
This Kubernetes ConfigMap is named using the pattern `&lt;fullname&gt;-health` and is placed in the specified namespace. It includes labels and optional annotations.

#### Data
The ConfigMap contains several shell scripts as data:

1. `ping_readiness_local.sh`: Checks readiness of local Redis instance
2. `ping_liveness_local.sh`: Checks liveness of local Redis instance
3. `ping_sentinel.sh`: Checks Sentinel instance (if enabled)
4. `parse_sentinels.awk`: AWK script for parsing Sentinel information
5. `ping_readiness_master.sh`: Checks readiness of Redis master instance
6. `ping_liveness_master.sh`: Checks liveness of Redis master instance
7. `ping_readiness_local_and_master.sh`: Checks readiness of both local and master instances
8. `ping_liveness_local_and_master.sh`: Checks liveness of both local and master instances

### Shell Scripts
#### Description
Each shell script performs a health check by pinging a Redis instance and verifying the response.

#### Internal Logic
1. Set up authentication if required
2. Use `redis-cli` to ping the Redis instance with appropriate parameters (host, port, TLS settings)
3. Check for timeout
4. Verify the response (expecting "PONG" for readiness, allowing "LOADING" or "MASTERDOWN" for liveness in some cases)
5. Exit with appropriate status code

#### Performance Considerations
The scripts use a timeout mechanism to prevent hanging in case of unresponsive Redis instances.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| redis-cli | Used to ping Redis instances and check their health |

## Configuration
The ConfigMap uses several template functions and values from the Helm chart:

| Option | Description |
|:-------|:------------|
| .Values.commonLabels | Custom labels to be added to the ConfigMap |
| .Values.commonAnnotations | Custom annotations to be added to the ConfigMap |
| .Values.tls.enabled | Enables TLS configuration for Redis connections |
| .Values.tls.authClients | Enables client authentication for TLS |
| .Values.sentinel.enabled | Enables Redis Sentinel configuration |

## Error Handling
The scripts handle various error scenarios:
1. Timeout: If the Redis instance doesn't respond within the specified time
2. Unexpected responses: If the response is not "PONG" (with some exceptions for liveness checks)
3. Authentication failures: Implicitly handled by using the provided passwords

## Notes
- The ConfigMap includes conditional logic for TLS support and Sentinel configuration.
- The scripts handle both password-based and TLS-based authentication methods.
- The `parse_sentinels.awk` script is included for parsing Sentinel information when Sentinel is enabled.