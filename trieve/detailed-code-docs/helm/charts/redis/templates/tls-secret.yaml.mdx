---
title: "tls-secret.yaml"
---

## High-level description
This code defines a Kubernetes Secret containing TLS certificates and keys for Redis. It generates a self-signed CA, server certificate, and key, then stores them in the Secret. The Secret is only created if the `redis.createTlsSecret` condition is true.

## Code Structure
The code first checks for a condition before defining the Secret. It then defines several variables used for generating the certificates and keys, including the CA, certificate subject and alternative names, and validity period. Finally, it defines the Secret resource with the generated certificates and keys.

## References
- `redis.createTlsSecret`: This appears to be a Helm template function or variable that determines whether to create the TLS secret.
- `common.names.fullname`: This likely refers to a Helm template function that generates the full name for the Redis deployment.
- `genCA`: This function likely generates a Certificate Authority (CA) certificate.
- `common.names.namespace`: This likely refers to a Helm template function that retrieves the namespace for the deployment.
- `genSignedCert`: This function likely generates a signed certificate using the provided CA.
- `common.labels.standard`: This likely refers to a Helm template function that generates standard labels for the deployment.
- `common.tplvalues.render`: This likely refers to a Helm template function that renders template values.
- `common.secrets.lookup`: This likely refers to a Helm template function that retrieves secrets.

## Symbols
### `tls-secret.yaml`
#### Description
This code defines a Kubernetes Secret resource containing TLS certificates and keys for Redis.

#### Inputs
This code block doesn't have explicit inputs, but it uses values from the Helm context, including:
- `.Values.clusterDomain`: The cluster domain name.
- `.Values.commonLabels`: Custom labels to apply to the Secret.
- `.Values.commonAnnotations`: Custom annotations to apply to the Secret.

#### Outputs
This code block defines a Kubernetes Secret resource with the following structure:
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: &lt;release-name&gt;-redis-crt
  namespace: &lt;release-namespace&gt;
  labels:
    # ... standard labels
  annotations:
    # ... common annotations
type: kubernetes.io/tls
data:
  tls.crt: &lt;base64 encoded TLS certificate&gt;
  tls.key: &lt;base64 encoded TLS key&gt;
  ca.crt: &lt;base64 encoded CA certificate&gt;
```

#### Internal Logic
1. **Check Condition:** The code first checks if `redis.createTlsSecret` is true. If not, the Secret is not created.
2. **Define Variables:** Several variables are defined for generating the certificates:
    - `$secretName`: The name of the Secret.
    - `$ca`: The generated CA certificate.
    - `$releaseNamespace`: The namespace for the deployment.
    - `$clusterDomain`: The cluster domain name.
    - `$fullname`: The full name of the Redis deployment.
    - `$serviceName`, `$headlessServiceName`, `$masterServiceName`: Different service names related to the Redis deployment.
    - `$altNames`: A list of alternative DNS names for the certificate.
    - `$cert`: The generated server certificate.
3. **Generate Certificates:**
    - `genCA` is called to generate a CA certificate.
    - `genSignedCert` is called to generate a signed server certificate using the generated CA, subject name, alternative names, and validity period.
4. **Define Secret:** A Kubernetes Secret resource is defined with the following:
    - `metadata`:
        - `name`: Set to `$secretName`.
        - `namespace`: Set to `$releaseNamespace`.
        - `labels`: Includes standard labels and any custom labels provided in `.Values.commonLabels`.
        - `annotations`: Includes any custom annotations provided in `.Values.commonAnnotations`.
    - `type`: Set to `kubernetes.io/tls`.
    - `data`:
        - `tls.crt`: The generated server certificate (`$cert.Cert`).
        - `tls.key`: The generated server key (`$cert.Key`).
        - `ca.crt`: The generated CA certificate (`$ca.Cert`).

## Side Effects
This code creates a new Kubernetes Secret in the specified namespace.

## Dependencies
This code depends on the following Helm template functions:
- `include`: Used to include other templates or values.
- `printf`: Used for string formatting.
- `genCA`: Used to generate a CA certificate.
- `genSignedCert`: Used to generate a signed certificate.

## Configuration
This code uses the following configuration options from the Helm context:
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| `redis.createTlsSecret` | boolean |  | Whether to create the TLS Secret. |
| `.Values.clusterDomain` | string |  | The cluster domain name. |
| `.Values.commonLabels` | map |  | Custom labels to apply to the Secret. |
| `.Values.commonAnnotations` | map |  | Custom annotations to apply to the Secret. |
