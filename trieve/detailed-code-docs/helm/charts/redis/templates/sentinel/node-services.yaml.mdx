---
title: "node-services.yaml"
---

## High-level description
This code defines a Kubernetes Service resource for each Redis Sentinel node in a Redis replication architecture. These services expose the Sentinel and Redis ports on each node, allowing for communication within the cluster and external access.

## Code Structure
The code uses a range loop to iterate over the desired number of replicas. For each replica, it creates a Service resource with specific port mappings for Sentinel and Redis. The service type is set to `NodePort` to allow external access.

## References
* `common.names.fullname`: Used to generate the full name of the service.
* `common.names.namespace`: Used to get the namespace where the service will be created.
* `common.labels.standard`: Used to apply standard labels to the service.
* `common.tplvalues.merge`: Used to merge annotations.
* `common.tplvalues.render`: Used to render the annotations.

## Symbols
### `node-services.yaml`
#### Description
This code snippet defines a Kubernetes Service for each Redis Sentinel node in a replication setup. It exposes the Sentinel and Redis ports via NodePort, enabling communication within the cluster and external access. The service dynamically fetches port numbers from a ConfigMap if it exists, otherwise, it uses default values.

#### Inputs
This code snippet doesn't have explicit input parameters. It relies on values passed from the parent chart, including:

* `.Values.architecture`: Defines the Redis architecture, should be "replication" for this code to execute.
* `.Values.sentinel.enabled`: Determines if Sentinel is enabled.
* `.Values.sentinel.service.type`: Defines the service type, should be "NodePort" for this code to execute.
* `.Values.sentinel.service.nodePorts.redis`: User-specified NodePort for Redis.
* `.Values.sentinel.service.nodePorts.sentinel`: User-specified NodePort for Sentinel.
* `.Values.replica.replicaCount`: Number of replicas in the Redis setup.
* `.Values.sentinel.containerPorts.sentinel`: Default Sentinel port within the container.
* `.Values.replica.containerPorts.redis`: Default Redis port within the container.
* `.Release.IsUpgrade`: Indicates if the chart is being upgraded.

#### Outputs
The code outputs a Kubernetes Service resource for each Redis Sentinel node.

#### Internal Logic
1. **Conditional Rendering:** The code first checks if the Redis architecture is "replication", Sentinel is enabled, the service type is "NodePort", and either it's an upgrade or a user-specified NodePort for Redis exists. If any of these conditions are false, the code doesn't render any service.
2. **Looping through Replicas:** It iterates through the desired number of replicas using a range loop.
3. **Fetching Ports from ConfigMap:** For each replica, it attempts to fetch the Sentinel and Redis port numbers from a ConfigMap named "&lt;release-name&gt;-ports-configmap".
4. **Defining Service:** It defines a Service resource with the name "&lt;release-name&gt;-node-&lt;replica-index&gt;".
5. **Setting Service Type and Ports:** The service type is set to "NodePort". It defines four ports:
    * `sentinel`: Exposes the Sentinel port. It uses the user-specified NodePort if provided, otherwise, it uses the value fetched from the ConfigMap or a default value.
    * `redis`: Exposes the Redis port. It uses the user-specified NodePort if provided, otherwise, it uses the value fetched from the ConfigMap or a default value.
    * `sentinel-internal`: Exposes the Sentinel port for internal communication within the cluster.
    * `redis-internal`: Exposes the Redis port for internal communication within the cluster.
6. **Setting Selector:** The service selector is set to target pods with the label "statefulset.kubernetes.io/pod-name=&lt;release-name&gt;-node-&lt;replica-index&gt;".

## Side Effects
This code creates Kubernetes Service resources, which expose the Sentinel and Redis ports of each node in the cluster.

## Dependencies
* Kubernetes API (v1)

## Configuration
This code snippet doesn't define any specific configuration options. It relies on values passed from the parent chart.
