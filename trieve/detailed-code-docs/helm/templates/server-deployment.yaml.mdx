---
title: "server-deployment.yaml"
---

## High-level description
This code defines a Kubernetes Deployment for a server application named "server". It specifies the container image, port mappings, environment variables, resource requests, and other configurations for deploying and running the server. It also includes logic for using a Cloud SQL proxy when deploying to Google Cloud and leverages Helm templating for dynamic configuration.

## Code Structure
The code defines a Kubernetes Deployment resource using YAML syntax. It includes metadata for the deployment, specifications for selecting pods, and a template for creating pods. The template further specifies metadata for the pods, service account configuration, container specifications (including image, ports, and environment variables), and optional configurations for a Cloud SQL proxy.

## References
This code references various Helm values from `values.yaml` file, including:
- `.Release.Name`: The name of the Helm release.
- `.Values.environment`: The deployment environment (e.g., "gcloud", "local").
- `.Values.containers.server.tag`: The Docker tag for the server image.
- `.Values.config.*`: Various configuration options for the server and its dependencies.
- `.Values.postgres.*`: Configuration options for the PostgreSQL database.
- `.Values.qdrant.*`: Configuration options for the Qdrant vector database.

## Symbols
### `server` Deployment
#### Description
This symbol defines a Kubernetes Deployment named "server" responsible for deploying the server application.

#### Inputs
This symbol uses Helm values provided during deployment.

#### Outputs
A deployed server application running in a Kubernetes cluster.

#### Internal Logic
1. **Deployment Metadata:** Defines metadata like name and labels for the deployment.
2. **Pod Selector:** Specifies how to select pods belonging to this deployment using labels.
3. **Pod Template:** Defines a template for creating pods.
    - **Pod Metadata:** Sets labels for the pods.
    - **Service Account:** Configures the service account for the pod, using "cloud-postgres-service-account" when the environment is "gcloud".
    - **Containers:** Defines the containers to run within the pod.
        - **`server` Container:**
            - **Resources:** Requests 1 CPU for the container.
            - **Image:** Builds the Docker image name based on the environment and specified tag.
            - **Ports:** Exposes container port 8090.
            - **Environment Variables:** Sets various environment variables using values from the Helm chart, including configuration options, API keys, and database connection details.
        - **`cloud-sql-proxy` Container (Conditional):
            - This container is included only when deploying to Google Cloud (`eq $.Values.environment "gcloud"`).
            - It sets up a Cloud SQL proxy to connect to the Cloud SQL instance.
            - It configures the proxy with arguments for structured logs, automatic IAM authentication, port, and the Cloud SQL instance connection name.
            - It sets up a security context to run the container as a non-root user.
            - It defines resource requests for memory and CPU.

## Side Effects
This code, when deployed, will:
- Create a Kubernetes Deployment named "server".
- Deploy pods running the server application containerized within Docker.
- Create and configure a Cloud SQL proxy when deploying to Google Cloud.

## Dependencies
This code depends on:
- Kubernetes: For deploying and managing the application.
- Docker: For containerizing the server application.
- Helm: For templating and packaging the deployment configuration.

## Configuration
This code relies on various configuration options provided through Helm values. Refer to the `values.yaml` file for available options and their descriptions.

## Error Handling
This code does not implement specific error handling mechanisms beyond the standard Kubernetes error handling.

## Logging
This code does not explicitly define logging mechanisms. Logging configurations would likely be managed within the server application itself.
