---
title: "ingest-deployment.yaml"
---

## High-level description
This Kubernetes YAML file defines a Deployment named "ingest" for the Trieve application. It specifies the container image, environment variables, and service account for the ingest service, which is responsible for processing and ingesting data into the Trieve system. The configuration is tailored for different environments (local, gcloud) using conditional logic.

## Code Structure
The code defines a single Kubernetes Deployment resource. It includes specifications for the deployment's metadata, selector, template, and container. The container section defines the environment variables and conditional logic for different environments.

## References
This code references values from a `values.yaml` file, which is likely used to configure the deployment. It uses these values to set environment variables, container image tags, and service account names.

## Symbols
### `ingest`
#### Description
This symbol defines a Kubernetes Deployment named "ingest". It specifies the configuration for deploying the ingest service of the Trieve application.

#### Inputs
This symbol does not have explicit inputs. It relies on values from a `values.yaml` file for configuration.

#### Outputs
This symbol does not have explicit outputs. It defines a Kubernetes Deployment resource that will be deployed to the cluster.

#### Internal Logic
The deployment uses a template to define the pod specifications. The template includes labels for identifying the pod and a container named "ingest". The container image is dynamically constructed based on the environment.

The code uses conditional logic (`{{- if ... }}`) to tailor the configuration for different environments:

* **gcloud:** Sets the service account to "cloud-postgres-service-account" and includes a sidecar container named "cloud-sql-proxy" for connecting to Cloud SQL.
* **local:** Uses a different container image path and does not include the "cloud-sql-proxy" container.

The container defines a large number of environment variables that are used to configure the ingest service. These variables are populated from the `values.yaml` file and include settings for:

* API keys (admin, OpenAI, LLM)
* Server URLs (base, Redis, Qdrant, Tika, OpenAI, GPU, Sparse, Embedding, Reranker)
* Database connection string (PostgreSQL)
* SMTP settings
* Secret key and salt
* S3 storage settings
* Cookie security
* Stripe settings
* OIDC settings
* Feature flags (unlimited, bulkPgQueue, useAnalytics)
* Analytics settings (ClickHouse)

## Side Effects
This code, when applied to a Kubernetes cluster, will create a deployment named "ingest". This will result in the creation of pods running the ingest service with the specified configuration.

## Dependencies
This code depends on Kubernetes and the `values.yaml` file for configuration. It also uses the following container images:

| Dependency | Purpose |
|:-----------|:--------|
| `trieve/ingest` or `localhost:5001/ingest` | Ingest service container image |
| `gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.8.0` | Cloud SQL Proxy container image (for gcloud environment) |

## Configuration
The configuration of the deployment is driven by the `values.yaml` file. This file likely contains values for all the environment variables defined in the container specification.

## Error Handling
This code does not implement specific error handling mechanisms. It relies on Kubernetes for managing deployment and pod failures.

## Logging
This code does not implement specific logging mechanisms. It relies on the logging mechanisms of the ingest service container image.
