---
title: "push-clickhouse.yml"
---

## High-level description
This GitHub Actions workflow automates the process of building and pushing a Docker image for ClickHouse to Docker Hub when changes are pushed to the `main` branch or specifically to the `analytics/clickhouse/` directory. 

The workflow leverages various GitHub Actions to streamline the process, including checking out the repository, setting up buildx for building multi-platform images, logging into Docker Hub, and finally building and pushing the image with appropriate tags and labels.

## Code Structure
The code defines a single workflow named `clickhouse_image` triggered on push events to the `main` branch or the `analytics/clickhouse/` path. This workflow consists of a single job, also named `clickhouse_image`, which runs on a specific runner type (`blacksmith-2vcpu-ubuntu-2204`). The job comprises several steps executed sequentially, each utilizing a specific GitHub Action for tasks like checking out the code, setting up build tools, logging into Docker Hub, and building/pushing the Docker image.

## Symbols
### `name: Create Clickhouse image`
#### Description
Defines the name of the workflow displayed in the GitHub Actions interface.

#### Internal Logic
This line sets the name of the workflow to "Create Clickhouse image".

### `concurrency`
#### Description
This section configures concurrency for the workflow, ensuring that only one workflow run is active for a given branch at a time.

#### Internal Logic
- `group`: Defines the concurrency group using the workflow name and branch name. Runs from the same workflow and branch will be grouped.
- `cancel-in-progress`: If set to `true`, it cancels any in-progress workflow runs within the same concurrency group.

### `on`
#### Description
Specifies the events that trigger the workflow.

#### Internal Logic
- `workflow_dispatch`: Allows the workflow to be triggered manually from the GitHub Actions interface.
- `push`: Triggers the workflow on push events to the repository.
    - `branches`: Filters push events to only include those on the `main` branch.
    - `paths`: Further filters push events to only include those affecting files within the `analytics/clickhouse/` directory.

### `jobs`
#### Description
Defines the jobs that run within the workflow.

#### Internal Logic
This section contains a single job named `clickhouse_image`.

### `clickhouse_image`
#### Description
This is the main job of the workflow responsible for building and pushing the ClickHouse Docker image.

#### Internal Logic
- `name`: Sets the display name of the job as "Push Clickhosue Image".
- `runs-on`: Specifies the type of runner to use for this job, which is `blacksmith-2vcpu-ubuntu-2204`.
- `steps`: Defines the individual steps that are executed sequentially within the job.

### `steps`
#### Description
A sequence of steps that are executed as part of the `clickhouse_image` job.

#### Internal Logic
This section outlines the steps involved in building and pushing the Docker image:
1. **Checkout the repo**: Uses the `actions/checkout@v4` action to checkout the repository's code.
2. **Setup buildx**: Utilizes the `docker/setup-buildx-action@v3` action to set up the `buildx` tool for building multi-platform Docker images.
3. **Login to Docker Hub**: Uses the `docker/login-action@v3` action to log in to Docker Hub using credentials stored in GitHub secrets.
4. **Docker meta**: Employs the `docker/metadata-action@v5` action to generate Docker image tags and labels based on the repository and workflow context.
5. **Build and push Docker image**: Utilizes the `docker/build-push-action@v5` action to build and push the Docker image to Docker Hub. It uses the `Dockerfile` located in the `analytics/clickhouse/` directory and tags the image based on the output of the `docker/metadata-action@v5` step.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| actions/checkout@v4 | Checks out the repository's code. |
| docker/setup-buildx-action@v3 | Sets up the `buildx` tool for building multi-platform Docker images. |
| docker/login-action@v3 | Logs into Docker Hub using provided credentials. |
| docker/metadata-action@v5 | Generates Docker image tags and labels. |
| docker/build-push-action@v5 | Builds and pushes the Docker image to Docker Hub. | 
