---
title: "push-collapse-query-script.yml"
---

## High-level description
This code defines a GitHub Actions workflow named "Create Clickhouse Search Query Collapsing Script" that builds and pushes a Docker image for a Clickhouse search query collapsing script whenever changes are pushed to the 'main' branch or the 'docker/collapse-query-script/**' path. The workflow utilizes Docker Buildx for building and pushing the image to Docker Hub.

## Code Structure
The code defines a single job named `build_collapse_query_script` which consists of several steps executed sequentially. These steps involve checking out the repository, setting up Docker Buildx, logging in to Docker Hub, extracting image metadata, and finally building and pushing the Docker image.

## Symbols
### `name: Create Clickhouse Search Query Collapsing Script`
#### Description
This line defines the name of the GitHub Actions workflow as "Create Clickhouse Search Query Collapsing Script".

### `concurrency`
#### Description
This section configures concurrency for the workflow, ensuring that only one workflow run is active for the same workflow and branch/head ref combination.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| group | string |  The concurrency group. It uses the expression `${{ github.workflow }}-${{ github.head_ref }}` to create a group based on the workflow name and the head ref. |
| cancel-in-progress | boolean | If set to `true`, it cancels any in-progress workflow runs that are part of the same concurrency group. |

### `on: workflow_dispatch`
#### Description
This line specifies that the workflow can be triggered manually using the GitHub Actions workflow dispatch event.

### `on: push`
#### Description
This section defines the trigger for the workflow, which is a push event to the 'main' branch or any path matching 'docker/collapse-query-script/**'.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| branches | string array | Specifies the branches that trigger the workflow on push events. In this case, it's only the 'main' branch. |
| paths | string array | Specifies the paths that trigger the workflow on push events. In this case, it's any path matching 'docker/collapse-query-script/**'. |

### `jobs: build_collapse_query_script`
#### Description
This section defines a single job named `build_collapse_query_script` within the workflow.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| name | string | The name of the job, displayed in the GitHub Actions workflow run log. |
| runs-on | string | Specifies the runner type to use for the job. In this case, it's `blacksmith-2vcpu-ubuntu-2204`. |
| steps | list | A list of steps to be executed sequentially within the job. |

### `steps`
#### Description
This section lists the steps that are executed sequentially within the `build_collapse_query_script` job.

#### Internal Logic
1. **Checkout the repo:** This step uses the `actions/checkout@v4` action to check out the repository's code.
2. **Setup buildx:** This step uses the `docker/setup-buildx-action@v3` action to set up Docker Buildx for building multi-platform images.
3. **Login to Docker Hub:** This step uses the `docker/login-action@v3` action to log in to Docker Hub using the provided username and password from the `DOCKER_USERNAME` and `DOCKER_PASSWORD` secrets.
4. **Docker meta:** This step uses the `docker/metadata-action@v5` action to generate Docker image metadata based on the provided configuration. It extracts tags and labels for the image.
5. **Build and push Docker image:** This step uses the `docker/build-push-action@v5` action to build and push the Docker image. It uses the context, Dockerfile path, tags, and labels from previous steps to build and push the image to Docker Hub.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| actions/checkout | Used to check out the repository's code. |
| docker/setup-buildx-action | Used to set up Docker Buildx for building multi-platform images. |
| docker/login-action | Used to log in to Docker Hub. |
| docker/metadata-action | Used to generate Docker image metadata. |
| docker/build-push-action | Used to build and push the Docker image. |

## Configuration
The workflow is configured through various inputs and settings:

* **`concurrency`**: Defines the concurrency group and cancellation behavior for the workflow.
* **`on`**: Specifies the events that trigger the workflow.
* **`jobs.&lt;job_id&gt;.runs-on`**: Defines the runner type for the job.
* **`steps`**: Lists the steps to be executed within the job, including actions and their configurations.
* **Environment variables**: The workflow uses secrets `DOCKER_USERNAME` and `DOCKER_PASSWORD` for logging into Docker Hub.

## Error Handling
The workflow relies on the error handling mechanisms of the used GitHub Actions. If any step fails, the workflow run will be marked as failed, and the logs will contain information about the error.

## Logging
The workflow steps, especially the actions used, provide logging information that is captured in the GitHub Actions workflow run logs. This information can be used to debug and troubleshoot issues with the workflow.
