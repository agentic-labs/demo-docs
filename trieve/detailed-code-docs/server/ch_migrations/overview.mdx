---
title: "Overview"
---

## High-level description
This directory contains SQL migration scripts for a ClickHouse database, focusing on creating, modifying, and managing tables related to dataset events, search queries, recommendations, and other analytics-related data. The migrations are organized chronologically and include both "up" and "down" scripts for applying and reverting changes.

## What does it do?
The migration scripts in this directory perform various database schema modifications:

1. Create initial tables for storing dataset events, search queries, cluster topics, search cluster memberships, RAG queries, and recommendations.
2. Add and remove columns for tracking duplicates, CTR (Click-Through Rate) data, and query ratings.
3. Recreate the recommendations table with a new structure.
4. Remove and add back TTL (Time-To-Live) settings for data retention management.
5. Add user identification to relevant tables.

These changes enable the system to store, track, and analyze various aspects of user interactions, search behaviors, and recommendation performance.

## Key Files

1. Migration scripts (e.g., `1720668303_create_inital_tables`, `1721414235_last_row_processed_for_collapse`, etc.):
   Each migration directory contains `up.sql` and `down.sql` files for applying and reverting changes respectively.

2. `chm.toml`:
   Configuration file for connecting to the ClickHouse database, specifying URL, user credentials, and default database.

## Dependencies
The migration scripts are designed for ClickHouse, a column-oriented database management system. They rely on ClickHouse-specific features such as:

- MergeTree and ReplacingMergeTree storage engines
- Support for UUID data type
- Array data types
- TTL (Time-To-Live) functionality
- Partitioning and ordering capabilities

## Configuration
The `chm.toml` file contains the following configuration for connecting to the ClickHouse database:

```toml
url = "http://localhost:8123"
user = "clickhouse"
password = "password"
database = "default"
```

These settings specify the connection details for the ClickHouse server, including the URL, user credentials, and default database.

Additionally, many of the migration scripts contain configurable aspects within the SQL commands, such as:

1. TTL settings: Most tables initially had a 30-day TTL, which was later removed and can be added back.
2. Partitioning: Tables are often partitioned by month and dataset_id.
3. Ordering: The columns used for ordering in each table are chosen to optimize common query patterns.

## Performance Considerations
1. The use of MergeTree and ReplacingMergeTree engines optimizes for efficient read and write operations on large datasets.
2. Partitioning and ordering strategies are implemented to improve query performance.
3. TTL settings (when used) help manage table sizes by automatically removing old data.
4. Adding or removing columns and changing table structures may temporarily impact database performance during migration execution.

When applying these migrations, especially in a production environment, it's crucial to:
- Run migrations during low-traffic periods to minimize disruptions.
- Test migrations in a non-production environment first.
- Monitor table sizes and query performance after applying changes.
- Have a plan for managing data growth, especially after removing TTL settings.

## Security Considerations
The `chm.toml` file contains database credentials in plain text. In a production environment, it would be advisable to use environment variables or a secure secret management system to handle sensitive information like passwords.

Overall, these migration scripts provide a comprehensive system for managing the evolution of a ClickHouse database schema, enabling the development team to track and analyze user interactions, search behaviors, and recommendation performance in a structured and efficient manner.