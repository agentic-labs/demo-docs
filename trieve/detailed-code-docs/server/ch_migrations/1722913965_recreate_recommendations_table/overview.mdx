---
title: "Overview"
---

## High-level description
This directory contains SQL migration scripts for recreating the `recommendations` table in a ClickHouse database. It consists of two files: `up.sql` for creating the table and `down.sql` for dropping it. These scripts are part of a database migration system, allowing for version control and easy management of database schema changes.

## What does it do?
The migration scripts in this directory perform the following actions:

1. The `up.sql` script creates a new `recommendations` table in the ClickHouse database. This table is designed to store various attributes of recommendations, including unique identifiers, recommendation types, positive and negative IDs, request parameters, results, and associated metadata. The table uses the MergeTree engine, which is optimized for efficient data storage and retrieval.

2. The `down.sql` script provides a way to revert the changes made by the `up.sql` script. It drops the `recommendations` table if it exists, effectively removing it from the database schema.

These scripts allow developers to easily apply or roll back changes to the database schema, ensuring consistency across different environments and facilitating collaborative development.

## Key Files

1. `up.sql`:
   - Creates the `recommendations` table with a complex structure.
   - Uses the MergeTree engine for optimized performance.
   - Implements partitioning, ordering, and TTL (Time To Live) features.

2. `down.sql`:
   - Drops the `recommendations` table if it exists.
   - Provides a clean way to revert the changes made by the `up.sql` script.

## Dependencies
The migration scripts are designed specifically for ClickHouse, a column-oriented database management system. They use ClickHouse-specific syntax and features, such as:

- MergeTree engine
- Array data types
- ClickHouse-specific functions (e.g., `toYYYYMM`)

## Configuration
The `recommendations` table created by the `up.sql` script has the following configuration:

- Engine: MergeTree
- Ordering: `(id, created_at)`
- Partitioning: `(toYYYYMM(created_at), dataset_id)`
- TTL: `created_at + INTERVAL 30 DAY`

The table structure includes the following columns:

```sql
CREATE TABLE recommendations
(
    id UUID,
    recommendation_type String,
    positive_ids Array(String),
    negative_ids Array(String),
    positive_tracking_ids Array(String),
    negative_tracking_ids Array(String),
    request_params String,
    results Array(String),
    top_score Float32,
    dataset_id UUID,
    created_at DateTime
)
ENGINE = MergeTree()
ORDER BY (id, created_at)
PARTITION BY (toYYYYMM(created_at), dataset_id)
TTL created_at + INTERVAL 30 DAY
```

This configuration allows for efficient data storage, retrieval, and automatic data cleanup after 30 days.

The `down.sql` script doesn't require any specific configuration as it simply drops the table:

```sql
DROP TABLE IF EXISTS recommendations;
```

These migration scripts provide a robust way to manage the `recommendations` table in the ClickHouse database, allowing for easy schema updates and rollbacks as needed.