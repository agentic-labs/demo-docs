---
title: "Overview"
---

## High-level description
This directory contains SQL migration scripts for a ClickHouse database, specifically focusing on creating and managing a table called `last_collapsed_dataset`. The migration is identified by the timestamp 1721414235 and is related to tracking the last row processed for a collapse operation.

## What does it do?
These migration scripts manage a database table that keeps track of when datasets were last collapsed. This is useful for maintaining the state of data processing operations, particularly in scenarios where large datasets are periodically condensed or summarized.

The "up" migration creates a new table with columns for identifying the dataset, recording when it was last collapsed, and when the record was created. The "down" migration provides a way to remove this table if needed, allowing for easy rollback of the changes.

## Key Files

1. `up.sql`: This file contains the SQL commands to create the `last_collapsed_dataset` table. It sets up a structure to store information about collapsed datasets using ClickHouse's ReplacingMergeTree engine.

2. `down.sql`: This file contains the SQL command to drop the `last_collapsed_dataset` table, effectively reversing the changes made by the up migration.

## Dependencies
The scripts are designed specifically for ClickHouse, a column-oriented database management system. They utilize ClickHouse-specific features such as the ReplacingMergeTree engine and partitioning schemes.

## Configuration
The migration scripts don't require explicit configuration files or environment variables. However, they assume that:

1. The ClickHouse database is properly set up and accessible.
2. The executing user has sufficient privileges to create and drop tables in the target database.

Here's a detailed breakdown of the `last_collapsed_dataset` table structure created by the `up.sql` script:

```sql
CREATE TABLE last_collapsed_dataset
(
    id UUID,
    last_collapsed DateTime,
    dataset_id UUID,
    created_at DateTime
)
ENGINE = ReplacingMergeTree(created_at)
PARTITION BY (toYYYYMM(created_at), dataset_id)
ORDER BY dataset_id
```

Key points about this table:

1. It uses UUID for `id` and `dataset_id`, allowing for unique identification of records and datasets.
2. The `last_collapsed` field stores the timestamp of when a dataset was last collapsed.
3. The `created_at` field serves both as a record creation timestamp and as the version column for the ReplacingMergeTree engine.
4. The table is partitioned by month (derived from `created_at`) and `dataset_id`, which can improve query performance for large datasets.
5. The data is ordered by `dataset_id`, facilitating efficient lookups and range queries on this column.

The ReplacingMergeTree engine is particularly useful here as it automatically handles updates to existing records. When a new record is inserted with the same `dataset_id` as an existing record, the engine will replace the old record with the new one during the next merge operation.

The `down.sql` script is straightforward:

```sql
DROP TABLE IF EXISTS last_collapsed_dataset
```

This command will remove the `last_collapsed_dataset` table if it exists, providing a clean way to revert the changes made by the up migration.

These migration scripts provide a robust way to manage the lifecycle of the `last_collapsed_dataset` table, allowing for easy creation and removal as needed during development or deployment processes.