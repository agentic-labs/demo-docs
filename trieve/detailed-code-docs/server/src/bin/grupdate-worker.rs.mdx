---
title: "grupdate-worker.rs"
---

## High-level description
The code defines a worker process named `grupdate-worker` that listens to a Redis queue for messages containing instructions to update chunk groups. It processes these messages, updates the corresponding chunk groups in the database, and manages potential errors during the process.

## Code Structure
The code consists of two main functions: `main` and `grupdate_worker`. The `main` function initializes the application, sets up logging and monitoring, establishes connections to the database and Redis, and starts the `grupdate_worker` function in a separate thread. The `grupdate_worker` function continuously listens to the Redis queue, processes messages, and updates the database accordingly.

## References
- `update_grouped_chunks_query`: A function responsible for updating chunk groups in the database.
- `get_dataset_by_id_query`: A function that retrieves a dataset by its ID.
- `readd_group_error_to_queue`: A function that handles errors during group update and re-adds the message to the queue for retry.

## Symbols

### `main`
#### Description
Initializes the application, sets up logging and monitoring, establishes connections to the database and Redis, and starts the `grupdate_worker` function in a separate thread.

#### Inputs
None

#### Outputs
None

#### Internal Logic
1. Loads environment variables from a `.env` file.
2. Initializes Sentry monitoring if the `SENTRY_URL` environment variable is set.
3. Sets up tracing subscriber for logging.
4. Establishes a connection pool to the PostgreSQL database using `diesel_async`.
5. Creates a connection pool to Redis using `bb8_redis`.
6. Initializes an `EventQueue` for analytics if the `USE_ANALYTICS` environment variable is set to `true`.
7. Registers a signal handler for `SIGTERM` to gracefully shut down the worker.
8. Starts the `grupdate_worker` function in a separate thread, passing the termination signal, Redis pool, database pool, and event queue as arguments.

### `grupdate_worker`
#### Description
Continuously listens to the Redis queue for messages containing instructions to update chunk groups, processes these messages, and updates the database accordingly.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| should_terminate | Arc&lt;AtomicBool&gt; | A shared atomic boolean flag indicating whether the worker should terminate. |
| redis_pool | actix_web::web::Data&lt;models::RedisPool&gt; | A shared Redis connection pool. |
| web_pool | actix_web::web::Data&lt;models::Pool&gt; | A shared database connection pool. |
| event_queue | actix_web::web::Data&lt;EventQueue&gt; | A shared event queue for analytics. |

#### Outputs
None

#### Internal Logic
1. Establishes a connection to Redis.
2. Enters an infinite loop that continues until the `should_terminate` flag is set.
3. Retrieves a message from the `group_update_queue` in Redis using the `brpoplpush` command, which atomically moves the message to the `group_update_processing` queue.
4. Deserializes the message into a `GroupUpdateMessage` struct.
5. Retrieves the dataset associated with the group from the database using `get_dataset_by_id_query`.
6. Updates the chunk group in the database using `update_grouped_chunks_query`.
7. If the update is successful, logs a success message, sends an analytics event to the `event_queue`, and removes the message from the `group_update_processing` queue.
8. If the update fails, logs an error message, calls `readd_group_error_to_queue` to handle the error, and continues to the next message.

### `readd_group_error_to_queue`
#### Description
Handles errors during group update and re-adds the message to the queue for retry.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| payload | GroupUpdateMessage | The message containing the group update instructions. |
| error | ServiceError | The error encountered during the update. |
| redis_pool | actix_web::web::Data&lt;models::RedisPool&gt; | A shared Redis connection pool. |
| event_queue | actix_web::web::Data&lt;EventQueue&gt; | A shared event queue for analytics. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;(), ServiceError&gt; | Indicates whether the message was successfully re-added to the queue. |

#### Internal Logic
1. Increments the `attempt_number` in the `payload`.
2. Removes the original message from the `group_update_processing` queue.
3. If the `attempt_number` reaches 3, logs an error message, sends an analytics event to the `event_queue`, adds the message to the `dead_letters_group` queue, and returns an error.
4. Serializes the updated `payload` back into a JSON string.
5. Re-adds the message to the `group_update_queue` for retry.

## Side Effects
- Modifies data in the PostgreSQL database.
- Modifies data in Redis queues.
- Sends analytics events to ClickHouse if analytics is enabled.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| diesel_async | Asynchronous database access for PostgreSQL. |
| bb8_redis | Asynchronous connection pool for Redis. |
| sentry | Error monitoring and reporting. |
| tracing_subscriber | Logging framework. |
| trieve_server | Internal crate containing application logic. |
| clickhouse | ClickHouse client library for analytics. |
| signal_hook | Signal handling library. |

## Error Handling
The `grupdate_worker` function handles errors by calling `readd_group_error_to_queue`, which attempts to re-add the message to the queue for retry. If the message fails to be processed after 3 attempts, it is added to the `dead_letters_group` queue and an error is logged.

## Logging
The code uses the `tracing_subscriber` crate for logging. The log level is set to `INFO` by default and can be configured using the `RUST_LOG` environment variable. If Sentry monitoring is enabled, errors are also reported to Sentry.

## TODOs
None
