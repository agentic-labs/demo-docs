---
title: "Overview"
---

## High-level description
This directory contains middleware components for a server application built with Actix Web framework in Rust. The middleware modules handle API versioning, authentication, and JSON content type processing. These components are designed to intercept and process HTTP requests and responses, adding crucial functionality to the server's request-response cycle.

## What does it do?
The middleware in this directory performs several important functions:

1. API Versioning: It determines the appropriate API version for each request based on headers, dataset creation dates, or environment variables. This allows the server to support multiple API versions simultaneously.

2. Authentication and Authorization: It handles user authentication using either session data or API keys. It also performs role-based access control for different endpoints and manages dataset and organization-specific authentication requirements.

3. JSON Content Type Handling: It ensures that the Content-Type header is set to "application/json" for incoming requests if not already specified, which is particularly useful for API services expecting JSON data.

These middleware components work together to enhance the server's capabilities, ensuring proper versioning, security, and data format consistency across the application.

## Key Files

1. `api_version.rs`: 
   - Implements API versioning middleware.
   - Defines `APIVersion` enum and `ApiVersionMiddleware` struct.
   - Determines API version based on headers, dataset creation dates, or environment variables.

2. `auth_middleware.rs`:
   - Implements authentication and authorization middleware.
   - Defines `AuthenticationMiddleware` struct and various helper functions.
   - Handles user authentication, API key validation, and role-based access control.

3. `json_middleware.rs`:
   - Implements JSON content type middleware.
   - Defines `JsonMiddleware` and `JsonMiddlewareFactory` structs.
   - Ensures "application/json" Content-Type header for incoming requests.

4. `mod.rs`:
   - Acts as the entry point for the middleware module.
   - Declares and exposes the three submodules: `api_version`, `auth_middleware`, and `json_middleware`.

## Dependencies
The middleware components rely on several external libraries and frameworks:

1. Actix Web (actix_web): The primary web framework used for building the server application.
2. Actix HTTP (actix_http): Provides HTTP-related types and constants.
3. Chrono: Used for date and time handling in API versioning.
4. Sentry: Integrated for error tracking and logging.
5. Redis: Used for caching in the authentication middleware.
6. UUID: Employed for unique identifier generation and handling.

## Configuration
The API versioning middleware uses an environment variable `V2_VERSIONING_DATE` to determine the cutoff date for V2 API version. If not set, it defaults to "2024-07-14".

The authentication middleware likely relies on configuration for database connections, Redis caching, and possibly JWT secret keys (though not explicitly mentioned in the provided summaries).

## Error Handling
The middleware components use a `ServiceError` enum for error handling, which is converted into appropriate HTTP responses. Various error cases are handled, such as unauthorized access, forbidden actions, and bad requests.

In summary, this middleware directory contains essential components that enhance the server's functionality by providing API versioning, robust authentication and authorization, and consistent JSON handling. These middleware modules work together to ensure that the server can efficiently process requests, maintain security, and provide a consistent API experience across different versions.