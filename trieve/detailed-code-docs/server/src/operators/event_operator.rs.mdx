---
title: "event_operator.rs"
---

## High-level description
This code defines the `get_events_query` function, which retrieves events from a ClickHouse database for a specific dataset. It also includes the `EventReturn` struct, which represents the structure of the returned event data.

## Code Structure
The main function `get_events_query` interacts with the ClickHouse database to fetch events based on the provided parameters. The `EventReturn` struct is used to structure the response data.

## Symbols

### `EventReturn`
#### Description
A struct that represents the structure of the event data returned by the query.

#### Fields
| Name | Type | Description |
|:-----|:-----|:------------|
| events | Vec&lt;WorkerEvent&gt; | A vector of WorkerEvent objects |
| page_count | i32 | The total number of pages |

### `get_events_query`
#### Description
An asynchronous function that queries the ClickHouse database for events based on the provided parameters.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| dataset_id | uuid::Uuid | The ID of the dataset |
| page | i64 | The page number |
| page_size | i64 | The number of items per page |
| event_types | Vec&lt;EventTypeRequest&gt; | The types of events to retrieve |
| clickhouse_client | web::Data&lt;clickhouse::Client&gt; | The ClickHouse client |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;EventReturn, ServiceError&gt; | Result | The query result or an error |

#### Internal Logic
1. Constructs a SQL query to fetch events from the ClickHouse database.
2. Executes the query to retrieve the events.
3. Constructs another SQL query to count the total number of events.
4. Executes the count query to get the total page count.
5. Returns the events and page count in an `EventReturn` struct.

## Error Handling
The function uses the `ServiceError` enum to handle and return errors. It specifically handles errors related to fetching events and counting events.

## Logging
The function uses the `#[tracing::instrument]` attribute for logging, which will log the function call with its parameters (except for the `clickhouse_client`).

## Dependencies
- `actix_web`: For web-related types like `web::Data`.
- `serde`: For serialization and deserialization of data structures.
- `utoipa`: For API documentation.
- `uuid`: For handling UUIDs.
- `clickhouse`: For interacting with the ClickHouse database.

This code is part of a larger system that handles event retrieval for datasets, likely in a web application context. It provides a paginated query mechanism for fetching events from a ClickHouse database, with filtering capabilities based on event types.