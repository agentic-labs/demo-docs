---
title: "user_operator.rs"
---

Here's a detailed documentation of the `user_operator.rs` file:

## High-level description
This file contains functions for managing user-related operations in the Trieve API. It includes functions for querying users, managing user organizations, handling API keys, and performing user-related database operations.

## Code Structure
The file defines several functions that interact with the database to perform user-related operations. These functions are used by other parts of the application, particularly the handlers, to implement user management features.

## Symbols

### `get_user_by_id_query`
#### Description
Retrieves a user and their associated organizations and roles from the database based on the user's ID.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| user_id | &uuid::Uuid | The ID of the user to retrieve |
| pool | web::Data&lt;Pool&gt; | The database connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result | Result&lt;(User, Vec&lt;UserOrganization&gt;, Vec&lt;Organization&gt;), ServiceError&gt; | A tuple containing the user, their organizations, and the organizations' details |

#### Internal Logic
1. Joins the users, user_organizations, and organizations tables.
2. Filters by the given user ID and non-deleted organizations.
3. If no results, attempts to fetch the user alone.
4. Returns the user with their organizations and roles.

### `add_existing_user_to_org`
#### Description
Adds an existing user to an organization based on their email address.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| email | String | The email of the user to add |
| organization_id | uuid::Uuid | The ID of the organization to add the user to |
| user_role | UserRole | The role to assign to the user in the organization |
| pool | web::Data&lt;Pool&gt; | The database connection pool |
| redis_pool | web::Data&lt;RedisPool&gt; | The Redis connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result | Result&lt;bool, ServiceError&gt; | True if the user was added, false if the user doesn't exist |

#### Internal Logic
1. Searches for the user by email.
2. If found, adds the user to the organization with the specified role.
3. Returns true if successful, false if the user doesn't exist.

### `update_user_org_role_query`
#### Description
Updates a user's role within an organization.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| user_id | uuid::Uuid | The ID of the user |
| organization_id | uuid::Uuid | The ID of the organization |
| role | UserRole | The new role to assign |
| pool | web::Data&lt;Pool&gt; | The database connection pool |
| redis_pool | web::Data&lt;RedisPool&gt; | The Redis connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result | Result&lt;(), ServiceError&gt; | Ok if successful, Error otherwise |

#### Internal Logic
1. Updates the user's role in the user_organizations table.
2. Deletes the user's cached data from Redis to ensure it's refreshed.

### `generate_api_key`
#### Description
Generates a new API key with a specific format.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| String | String | A newly generated API key |

#### Internal Logic
1. Uses a random number generator to create a 32-character alphanumeric string.
2. Prefixes the string with "tr-" to form the API key.

### `hash_argon2_api_key`
#### Description
Hashes an API key using the Argon2 algorithm.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| password | &str | The API key to hash |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result | Result&lt;String, ServiceError&gt; | The hashed API key |

### `hash_api_key`
#### Description
Hashes an API key using the BLAKE3 algorithm.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| password | &str | The API key to hash |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| String | String | The hashed API key |

### `set_user_api_key_query`
#### Description
Creates a new API key for a user and stores it in the database.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| user_id | uuid::Uuid | The ID of the user |
| name | String | A name for the API key |
| role | ApiKeyRole | The role assigned to the API key |
| dataset_ids | Option&lt;Vec&lt;uuid::Uuid&gt;&gt; | Optional list of dataset IDs the key has access to |
| organization_ids | Option&lt;Vec&lt;uuid::Uuid&gt;&gt; | Optional list of organization IDs the key has access to |
| scopes | Option&lt;Vec&lt;String&gt;&gt; | Optional list of scopes (permissions) for the key |
| pool | web::Data&lt;Pool&gt; | The database connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result | Result&lt;String, ServiceError&gt; | The newly created API key |

#### Internal Logic
1. Generates a new API key.
2. Hashes the API key.
3. Creates a UserApiKey struct with the provided details.
4. Inserts the new API key into the database.
5. Returns the raw (unhashed) API key.

### `get_user_from_api_key_query`
#### Description
Retrieves a user and their API key details based on an API key.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| api_key | &str | The API key to look up |
| pool | web::Data&lt;Pool&gt; | The database connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result | Result&lt;(SlimUser, UserApiKey), ServiceError&gt; | The user and their API key details |

#### Internal Logic
1. Hashes the provided API key.
2. Searches for the API key in the database.
3. If found, retrieves the associated user and their organizations.
4. If not found, tries to find the key using an older hashing method (Argon2).
5. If found with the older method, updates the key to use the new hashing method.
6. Returns the user and API key details.

### `get_user_api_keys_query`
#### Description
Retrieves all API keys associated with a user.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| user_id | uuid::Uuid | The ID of the user |
| pool | web::Data&lt;Pool&gt; | The database connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result | Result&lt;Vec&lt;ApiKeyRespBody&gt;, ServiceError&gt; | A list of API key response bodies |

#### Internal Logic
1. Queries the database for all API keys associated with the user ID.
2. Converts the results into ApiKeyRespBody structs.
3. Returns the list of API key response bodies.

### `delete_user_api_keys_query`
#### Description
Deletes a specific API key for a user.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| user_id | uuid::Uuid | The ID of the user |
| api_key_id | uuid::Uuid | The ID of the API key to delete |
| pool | web::Data&lt;Pool&gt; | The database connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result | Result&lt;(), ServiceError&gt; | Ok if successful, Error otherwise |

#### Internal Logic
1. Deletes the specified API key from the database for the given user.

### `create_user_query`
#### Description
Creates a new user in the database.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| user_id | uuid::Uuid | The ID for the new user |
| email | String | The email of the new user |
| name | Option&lt;String&gt; | The optional name of the new user |
| role | UserRole | The role of the user in the organization |
| org_id | uuid::Uuid | The ID of the organization to add the user to |
| pool | web::Data&lt;Pool&gt; | The database connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result | Result&lt;(User, Vec&lt;UserOrganization&gt;, Vec&lt;Organization&gt;), ServiceError&gt; | The created user and their organization details |

#### Internal Logic
1. Creates a new User struct.
2. Creates a new UserOrganization struct.
3. Inserts both into the database within a transaction.
4. Retrieves the full user details including organizations.
5. Returns the created user with organization details.

### `add_user_to_organization`
#### Description
Adds a user to an organization.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| req | Option&lt;&HttpRequest&gt; | Optional HTTP request |
| calling_user_id | Option&lt;uuid::Uuid&gt; | Optional ID of the user making the request |
| user_org | UserOrganization | The user-organization relationship to add |
| pool | web::Data&lt;Pool&gt; | The database connection pool |
| redis_pool | web::Data&lt;RedisPool&gt; | The Redis connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result | Result&lt;(), ServiceError&gt; | Ok if successful, Error otherwise |

#### Internal Logic
1. Inserts the new user-organization relationship into the database.
2. Deletes the user's cached data from Redis to ensure it's refreshed.

### `create_default_user`
#### Description
Creates a default user and organization if they don't already exist.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| api_key | &str | The API key for the default user |
| pool | web::Data&lt;Pool&gt; | The database connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result | Result&lt;(), ServiceError&gt; | Ok if successful, Error otherwise |

#### Internal Logic
1. Attempts to create a default user with a specific UUID.
2. If successful, creates a default organization.
3. Associates the user with the organization as an owner.
4. Creates an API key for the default user.

### `remove_user_from_org_query`
#### Description
Removes a user from an organization.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| user_id | uuid::Uuid | The ID of the user to remove |
| max_allowed_role | UserRole | The maximum role allowed to be removed |
| organization_id | uuid::Uuid | The ID of the organization |
| pool | web::Data&lt;Pool&gt; | The database connection pool |
| redis_pool | web::Data&lt;RedisPool&gt; | The Redis connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result | Result&lt;(), ServiceError&gt; | Ok if successful, Error otherwise |

#### Internal Logic
1. Checks if the user's role is allowed to be removed.
2. Removes the user-organization relationship from the database.
3. Deletes the user's cached data from Redis to ensure it's refreshed.

## Dependencies
- `uuid`: For handling UUIDs
- `argon2`: For password hashing
- `blake3`: For API key hashing
- `rand`: For generating random API keys
- `redis`: For Redis operations
- `diesel`: For database operations
- `actix_web`: For web-related types

## Error Handling
The functions in this file use the `ServiceError` enum for error handling, which is likely defined elsewhere in the project. Errors are propagCertainly! Continuing the documentation:

## Error Handling (continued)
The functions in this file use the `ServiceError` enum for error handling, which is likely defined elsewhere in the project. Errors are propagated up the call stack using the `?` operator, allowing the calling functions to handle them appropriately. Common error types include:

- `ServiceError::BadRequest`: For invalid input or operations
- `ServiceError::InternalServerError`: For unexpected database or internal errors
- `ServiceError::Unauthorized`: For authentication failures
- `ServiceError::Forbidden`: For authorization failures

## Logging
The file uses the `tracing` crate for instrumentation, as evidenced by the `#[tracing::instrument]` attributes on several functions. This allows for detailed logging and tracing of function calls and their parameters throughout the application.

## Performance Considerations
- The use of connection pools (`Pool` and `RedisPool`) helps manage database and Redis connections efficiently.
- Caching user data in Redis is implemented to reduce database load for frequent user lookups.
- The `hash_api_key` function uses BLAKE3, which is known for its high performance in hashing operations.

## Security Considerations
- API keys are hashed before storage, with support for both Argon2 (legacy) and BLAKE3 (current) hashing methods.
- The `SECRET_KEY` and `SALT` used in Argon2 hashing are loaded from environment variables, allowing for secure configuration.
- Role-based access control is implemented through the `UserRole` and `ApiKeyRole` enums.

## Configuration
The file uses environment variables for configuration, particularly for the `SECRET_KEY` and `SALT` used in API key hashing. These are loaded using a custom `get_env!` macro, which likely provides fallback values if the environment variables are not set.

## TODOs
There are several TODO comments in the code indicating areas for future improvement:
1. Caching the API key in Redis for faster lookups.
2. Implementing path-scoped API keys using the path field of the `HTTPRequest` struct.

## Additional Notes
- The file implements both user management and API key management functionalities, which are closely related but could potentially be split into separate modules for better organization as the codebase grows.
- The `create_default_user` function suggests that the application has a concept of a default user and organization, which might be used for initial setup or testing purposes.
- The use of `diesel_async` indicates that the application is using asynchronous database operations, which is beneficial for scalability.

This file plays a crucial role in the user management and authentication system of the Trieve API, handling core operations like user creation, organization management, and API key handling. It's designed to work with both SQL databases (via Diesel) and Redis for caching, providing a robust and scalable solution for user-related operations.