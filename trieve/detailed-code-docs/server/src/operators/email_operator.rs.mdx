---
title: "email_operator.rs"
---

## High-level description
This code defines an email operator module for a Rust server application. It provides functionality to send emails using SMTP, including retrieving SMTP credentials and sending HTML-formatted emails.

## Symbols

### `get_smtp_creds`
#### Description
This function retrieves SMTP credentials from environment variables.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| - | Credentials | SMTP credentials |

#### Internal Logic
1. Retrieves SMTP username and password from environment variables.
2. Creates and returns a new `Credentials` object with the retrieved values.

### `send_email`
#### Description
This function sends an HTML-formatted email using SMTP.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| html_email_body | String | The HTML content of the email |
| to_address | String | The recipient's email address |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| - | Result&lt;(), ServiceError&gt; | Ok(()) if successful, ServiceError if failed |

#### Internal Logic
1. Retrieves SMTP relay and email address from environment variables.
2. Gets SMTP credentials using `get_smtp_creds()`.
3. Creates an SMTP transport with the retrieved credentials.
4. Builds an email message with the provided HTML body and recipient address.
5. Sends the email using the SMTP transport.
6. Returns Ok(()) if successful, or a ServiceError if there's an error.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| lettre | For email functionality (SMTP, message building) |
| tracing | For instrumenting functions with tracing |

## Error Handling
The code uses the `ServiceError` enum from the `errors` module to handle and return errors. Specifically, it returns a `ServiceError::BadRequest` with an error message if there's an issue sending the email.

## Logging
The code uses the `log` crate to log errors when sending emails fails.

## Configuration
The code relies on several environment variables for configuration:
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| SMTP_USERNAME | String | - | SMTP username for authentication |
| SMTP_PASSWORD | String | - | SMTP password for authentication |
| SMTP_RELAY | String | - | SMTP relay server address |
| SMTP_EMAIL_ADDRESS | String | - | Email address used as the sender |

These environment variables are accessed using the `get_env!` macro, which is likely defined elsewhere in the project.

## Performance Considerations
The `send_email` function is marked with `#[tracing::instrument]`, which suggests that its performance is being monitored or traced. This could be useful for identifying bottlenecks or issues related to email sending.