---
title: "organization_operator.rs"
---

Here's a high-level description and documentation of the `organization_operator.rs` file:

## High-level description

This file contains functions for managing organizations within the Trieve system. It includes operations such as creating, updating, and deleting organizations, as well as managing user associations and retrieving organization-related data. The functions interact with the database using Diesel ORM and handle various organization-related queries.

## Code Structure

The file consists of several asynchronous functions that perform different operations on organizations. These functions typically take input parameters, interact with the database using Diesel queries, and return results or errors. Many functions also involve Redis operations for caching or managing user sessions.

## Symbols

### create_organization_query
#### Description
Creates a new organization with the given name.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| name | &str | The name of the organization to create |
| pool | web::Data&lt;Pool&gt; | Database connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;Organization, ServiceError&gt; | Result | The created organization or an error |

### update_organization_query
#### Description
Updates an existing organization's name and handles related Redis operations.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| id | uuid::Uuid | The ID of the organization to update |
| name | &str | The new name for the organization |
| pool | web::Data&lt;Pool&gt; | Database connection pool |
| redis_pool | web::Data&lt;RedisPool&gt; | Redis connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;Organization, ServiceError&gt; | Result | The updated organization or an error |

### delete_organization_query
#### Description
Soft deletes an organization and its associated data, including datasets and subscriptions.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| req | Option&lt;&HttpRequest&gt; | Optional HTTP request |
| calling_user_id | Option&lt;uuid::Uuid&gt; | Optional ID of the user making the request |
| org_id | uuid::Uuid | The ID of the organization to delete |
| pool | web::Data&lt;Pool&gt; | Database connection pool |
| redis_pool | web::Data&lt;RedisPool&gt; | Redis connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;(), ServiceError&gt; | Result | Success or an error |

### get_org_from_id_query
#### Description
Retrieves an organization along with its associated subscription and plan information.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| organization_id | uuid::Uuid | The ID of the organization to retrieve |
| pool | web::Data&lt;Pool&gt; | Database connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;OrganizationWithSubAndPlan, ServiceError&gt; | Result | The organization with subscription and plan info, or an error |

### get_org_id_from_subscription_id_query
#### Description
Retrieves the organization ID associated with a given subscription ID.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| subscription_id | String | The subscription ID to look up |
| pool | web::Data&lt;Pool&gt; | Database connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;uuid::Uuid, ServiceError&gt; | Result | The organization ID or an error |

### get_org_dataset_count
#### Description
Retrieves the count of datasets for a given organization.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| organization_id | uuid::Uuid | The ID of the organization |
| pool | web::Data&lt;Pool&gt; | Database connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;i32, ServiceError&gt; | Result | The count of datasets or an error |

### get_user_org_count
#### Description
Retrieves the count of users for a given organization.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| organization_id | uuid::Uuid | The ID of the organization |
| pool | web::Data&lt;Pool&gt; | Database connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;i32, ServiceError&gt; | Result | The count of users or an error |

### get_message_org_count
#### Description
Retrieves the count of messages for a given organization.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| organization_id | uuid::Uuid | The ID of the organization |
| pool | web::Data&lt;Pool&gt; | Database connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;i32, ServiceError&gt; | Result | The count of messages or an error |

### get_file_size_sum_org
#### Description
Retrieves the sum of file sizes for a given organization.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| organization_id | uuid::Uuid | The ID of the organization |
| pool | web::Data&lt;Pool&gt; | Database connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;i64, ServiceError&gt; | Result | The sum of file sizes or an error |

### get_org_usage_by_id_query
#### Description
Retrieves usage statistics for a given organization.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| org_id | uuid::Uuid | The ID of the organization |
| pool | web::Data&lt;Pool&gt; | Database connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;OrganizationUsageCount, ServiceError&gt; | Result | The organization usage statistics or an error |

### get_org_users_by_id_query
#### Description
Retrieves a list of users associated with a given organization.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| org_id | uuid::Uuid | The ID of the organization |
| pool | web::Data&lt;Pool&gt; | Database connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;Vec&lt;SlimUser&gt;, ServiceError&gt; | Result | A list of users or an error |

### get_arbitrary_org_owner_from_org_id
#### Description
Retrieves an arbitrary owner-level user for a given organization.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| org_id | uuid::Uuid | The ID of the organization |
| pool | web::Data&lt;Pool&gt; | Database connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;SlimUser, ServiceError&gt; | Result | An owner-level user or an error |

### get_arbitrary_org_owner_from_dataset_id
#### Description
Retrieves an arbitrary owner-level user for the organization associated with a given dataset.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| dataset_id | uuid::Uuid | The ID of the dataset |
| pool | web::Data&lt;Pool&gt; | Database connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;SlimUser, ServiceError&gt; | Result | An owner-level user or an error |

### get_soft_deleted_datasets_for_organization
#### Description
Retrieves a list of soft-deleted datasets for a given organization.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| organization_id | uuid::Uuid | The ID of the organization |
| pool | web::Data&lt;Pool&gt; | Database connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;Vec&lt;Dataset&gt;, ServiceError&gt; | Result | A list of soft-deleted datasets or an error |

### delete_actual_organization_query
#### Description
Permanently deletes an organization from the database.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| org_id | uuid::Uuid | The ID of the organization to delete |
| pool | web::Data&lt;Pool&gt; | Database connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;(), ServiceError&gt; | Result | Success or an error |

### update_all_org_dataset_configs_query
#### Description
Updates the configuration for all datasets belonging to a given organization.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| org_id | uuid::Uuid | The ID of the organization |
| new_config | serde_json::Value | The new configuration to apply |
| pool | web::Data&lt;Pool&gt; | Database connection pool |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Result&lt;(), ServiceError&gt; | Result | Success or an error |

## Error Handling
The functions in this file use the `ServiceError` enum for error handling, which includes various error types such as `BadRequest`, `NotFound`, and `InternalServerError`.

## Dependencies
- `diesel`: For database operations
- `redis`: For caching and session management
- `uuid`: For handling UUIDs
- `serde_json`: For JSON serialization/deserialization
- `actix_web`: For web-related types

This file is crucial for managing organizations within the Trieve system, handling various database operations, and maintaining consistency across different aspects of the application related to organizations.