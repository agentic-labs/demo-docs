---
title: "parse_operator.rs"
---

Here's a detailed explanation of the `parse_operator.rs` file:

## High-level description
This file contains utility functions for parsing and processing text data. It includes functions for converting HTML to plain text, chunking text, building regular expressions for splitting text, and averaging embeddings.

## Code Structure
The file defines several public functions that operate on text data. These functions are independent and can be used separately, but some may be used together in a pipeline for text processing tasks.

## Symbols

### `convert_html_to_text`
#### Description
Converts HTML content to plain text by parsing the HTML and extracting the text content.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| html | &str | The HTML content to be converted |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| text | String | The extracted plain text |

#### Internal Logic
Uses the `scraper` crate to parse the HTML and extract the text content.

### `coarse_remove_large_chunks`
#### Description
Splits large chunks of text into smaller pieces to ensure no chunk exceeds a maximum length.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| cur_chunks | Vec&lt;String&gt; | The current chunks of text |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| new_chunks | Vec&lt;String&gt; | The processed chunks, split if necessary |

#### Internal Logic
Iterates through the input chunks, splitting any that exceed the maximum length (10,000 characters) into smaller pieces.

### `build_chunking_regex`
#### Description
Builds a regular expression for splitting text based on provided delimiters.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| delimiters | Vec&lt;String&gt; | The delimiters to use for splitting |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| re | Regex | The compiled regular expression |

#### Internal Logic
Escapes the delimiters and joins them into a single pattern, then compiles the regex.

### `coarse_doc_chunker`
#### Description
Splits a document into chunks based on a given pattern or default delimiters.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| document | String | The document to be chunked |
| split_pattern | Option&lt;Regex&gt; | Optional custom split pattern |
| rebalance_chunks | bool | Whether to rebalance chunks |
| target_splits_per_chunk | usize | Target number of splits per chunk |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| groups | Vec&lt;String&gt; | The resulting chunks |

#### Internal Logic
Cleans the input text, splits it using the provided or default pattern, and groups the splits into chunks. It then rebalances the chunks if required and removes any that are too large.

### `average_embeddings`
#### Description
Calculates the average of a set of embeddings.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| embeddings | Vec&lt;Vec&lt;f32&gt;&gt; | The embeddings to average |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| average | Vec&lt;f32&gt; | The averaged embedding |

#### Internal Logic
Uses the `ndarray` crate to convert the embeddings into a 2D array, sum along the first axis, and divide by the number of embeddings.

## Dependencies
- `ndarray`: For numerical operations on arrays
- `regex`: For regular expression operations
- `scraper`: For HTML parsing
- `serde`: For serialization and deserialization
- `utoipa`: For API documentation

## Error Handling
The functions return `Result` types to handle potential errors, such as invalid regular expressions or embedding calculation errors.

## Testing
The file includes a test module with a unit test for the `average_embeddings` function.

This file provides essential text processing utilities that can be used in various parts of the application, particularly for preparing text data for further analysis or embedding.