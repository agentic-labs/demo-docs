---
title: "qdrant_operator.rs"
---

Here's a high-level description of the `qdrant_operator.rs` file:

The `qdrant_operator.rs` file contains functions for interacting with the Qdrant vector database. It provides operations for connecting to Qdrant, creating collections, inserting and updating points, searching, and managing dataset configurations. This module serves as an interface between the application's data models and the Qdrant database, handling vector operations for semantic search and similarity-based retrieval.

## Code Structure

The file defines several functions that interact with Qdrant:

1. Connection functions:
   - `get_qdrant_connection`: Establishes a connection to the Qdrant server.

2. Collection management:
   - `get_qdrant_collection_from_dataset_config`: Determines the appropriate Qdrant collection name based on dataset configuration.
   - `create_new_qdrant_collection_query`: Creates new Qdrant collections with specified parameters.

3. Point operations:
   - `bulk_upsert_qdrant_points_query`: Inserts or updates multiple points in Qdrant.
   - `create_new_qdrant_point_query`: Creates a new point in Qdrant.
   - `update_qdrant_point_query`: Updates an existing point in Qdrant.
   - `add_bookmark_to_qdrant_query`: Adds a bookmark to a Qdrant point.
   - `remove_bookmark_from_qdrant_query`: Removes a bookmark from a Qdrant point.

4. Search and retrieval:
   - `search_over_groups_query`: Performs a search over groups of points.
   - `recommend_qdrant_query`: Recommends points based on positive and negative examples.
   - `recommend_qdrant_groups_query`: Recommends groups of points.
   - `point_ids_exists_in_qdrant`: Checks if specific point IDs exist in Qdrant.
   - `scroll_qdrant_collection_ids`: Retrieves point IDs from a collection using pagination.

5. Deletion:
   - `delete_points_from_qdrant`: Deletes points from Qdrant.

6. Utility functions:
   - `get_qdrant_collections`: Retrieves a list of all Qdrant collections.
   - `count_qdrant_query`: Counts the number of points matching a query.
   - `update_group_tag_sets_in_qdrant_query`: Updates tag sets for groups in Qdrant.

These functions work together to provide a comprehensive interface for managing vector data in Qdrant, supporting the application's search and recommendation features.

## Symbols

### get_qdrant_connection

#### Description
Establishes a connection to the Qdrant server using provided or environment-based configuration.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| qdrant_url | Option&lt;&str&gt; | Optional URL for the Qdrant server |
| qdrant_api_key | Option&lt;&str&gt; | Optional API key for authentication |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| - | Result&lt;Qdrant, ServiceError&gt; | A Qdrant client instance or an error |

#### Internal Logic
1. Retrieves Qdrant URL and API key from parameters or environment variables.
2. Builds a Qdrant client with the provided configuration.
3. Sets a timeout of 60 seconds for the connection.

### create_new_qdrant_collection_query

#### Description
Creates new Qdrant collections with specified parameters for vector storage and indexing.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| qdrant_url | Option&lt;&str&gt; | Optional URL for the Qdrant server |
| qdrant_api_key | Option&lt;&str&gt; | Optional API key for authentication |
| quantize | bool | Whether to use vector quantization |
| recreate_indexes | bool | Whether to recreate existing indexes |
| replication_factor | u32 | Replication factor for the collection |
| accepted_vectors | Vec&lt;u64&gt; | Vector sizes to create collections for |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| - | Result&lt;(), ServiceError&gt; | Success or error result |

#### Internal Logic
1. Establishes a connection to Qdrant.
2. Generates collection names based on vector sizes and distance metrics.
3. For each collection:
   - Checks if the collection exists.
   - If not, creates the collection with specified parameters (vector size, distance metric, etc.).
   - Sets up sparse vector configurations.
   - Configures quantization if enabled.
4. Creates field indexes for various metadata fields.

### bulk_upsert_qdrant_points_query

#### Description
Inserts or updates multiple points in a Qdrant collection.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| points | Vec&lt;PointStruct&gt; | Vector of points to upsert |
| dataset_config | DatasetConfiguration | Configuration for the dataset |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| - | Result&lt;(), ServiceError&gt; | Success or error result |

#### Internal Logic
1. Checks if the points vector is empty and returns an error if so.
2. Determines the Qdrant collection name from the dataset configuration.
3. Establishes a connection to Qdrant.
4. Uses the Qdrant client to upsert the points into the specified collection.

### search_over_groups_query

#### Description
Performs a search over groups of points in Qdrant.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| page | u64 | Page number for pagination |
| filter | Filter | Qdrant filter for the search |
| limit | u64 | Number of results per page |
| score_threshold | Option&lt;f32&gt; | Minimum score threshold for results |
| group_size | u32 | Size of each group in the results |
| vector | VectorType | Vector to search with |
| dataset_config | DatasetConfiguration | Configuration for the dataset |
| get_total_pages | bool | Whether to retrieve the total number of pages |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| - | Result&lt;(Vec&lt;GroupSearchResults&gt;, u64), ServiceError&gt; | Search results and total count |

#### Internal Logic
1. Determines the Qdrant collection name from the dataset configuration.
2. Constructs a `SearchPointGroups` query based on the input parameters.
3. Executes the search query on Qdrant.
4. Processes the results into `GroupSearchResults` structures.
5. Calculates the total number of pages if requested.

## Dependencies
The module relies on several external crates and internal modules:

- `qdrant_client`: For interacting with the Qdrant vector database.
- `actix_web`: For web-related functionalities.
- `serde`: For serialization and deserialization.
- `uuid`: For handling UUIDs.
- Internal modules: `data::models`, `errors::ServiceError`, and various operator modules.

## Error Handling
The module uses the `ServiceError` type for error handling, which is likely defined in the `errors` module. Most functions return `Result&lt;T, ServiceError&gt;` to propagate errors up the call stack.

## Performance Considerations
- The module uses asynchronous programming with `async/await` for non-blocking I/O operations.
- Bulk operations are used where possible (e.g., `bulk_upsert_qdrant_points_query`) to minimize network round-trips.
- The `scroll_qdrant_collection_ids` function implements pagination to handle large datasets efficiently.

This module is crucial for the application's vector search capabilities, providing a high-level interface to Qdrant's functionality while abstracting away the complexities of direct vector database interactions.