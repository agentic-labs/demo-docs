---
title: "auth_handler.rs"
---

Here's a high-level description of the `auth_handler.rs` file:

The `auth_handler.rs` file is responsible for handling authentication and authorization-related operations in the Trieve API. It defines various structs and functions for user authentication, session management, and role-based access control. The file includes implementations for OAuth 2.0 authentication flow, API key management, and user information retrieval.

## Code Structure

The file is organized into several main sections:

1. Struct definitions for user types (LoggedUser, OrganizationRole, AdminOnly, OwnerOnly)
2. OpenID Connect (OIDC) client configuration and setup
3. Authentication routes (login, logout, callback)
4. User information retrieval (get_me)
5. Health check endpoint

## Symbols

### `LoggedUser`
- Description: Represents an authenticated user with minimal information.
- Inputs: Extracted from HTTP request extensions.
- Outputs: A LoggedUser instance.

### `OrganizationRole`
- Description: Represents a user's role within an organization.
- Inputs: SlimUser and UserRole.
- Outputs: An OrganizationRole instance.

### `AdminOnly`
- Description: Represents a user with admin privileges.
- Inputs: Extracted from HTTP request extensions.
- Outputs: An AdminOnly instance.

### `OwnerOnly`
- Description: Represents a user with owner privileges.
- Inputs: Extracted from HTTP request extensions.
- Outputs: An OwnerOnly instance.

### `build_oidc_client`
- Description: Builds and configures the OpenID Connect client.
- Outputs: A CoreClient instance for OIDC operations.

### `login`
- Description: Handles user login by initiating the OIDC authentication flow.
- Inputs: HTTP request, session, query parameters, and OIDC client.
- Outputs: HTTP response with a redirect to the OIDC provider.

### `logout`
- Description: Handles user logout by invalidating the current auth credential.
- Inputs: Identity, query parameters, and HTTP request.
- Outputs: HTTP response with logout confirmation and logout URL.

### `callback`
- Description: Handles the OIDC callback after successful authentication.
- Inputs: HTTP request, session, OIDC client, Redis pool, and database pool.
- Outputs: HTTP response with user information and redirect.

### `get_me`
- Description: Retrieves the current authenticated user's information.
- Inputs: LoggedUser and database pool.
- Outputs: HTTP response with user details.

### `health_check`
- Description: Simple health check endpoint to verify service status.
- Outputs: HTTP response indicating service health.

## Dependencies
The file relies on several external crates and internal modules, including:
- `actix_web` for web server functionality
- `oauth2` and `openidconnect` for OIDC implementation
- `diesel` for database operations
- `redis` for caching
- Custom error handling and data models from the project's modules

This file plays a crucial role in managing user authentication and authorization within the Trieve API, providing the necessary endpoints and logic for secure user interactions.