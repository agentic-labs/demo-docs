---
title: "chunk_handler.rs"
---

## High-level description
The `chunk_handler.rs` file defines API endpoints for managing and interacting with chunks of data within a dataset. It handles operations like creating, updating, deleting, searching, and recommending chunks, as well as generating responses based on specified chunks using a language model.

## Code Structure
The code defines several structs for request payloads, response bodies, and internal data structures. It then implements a series of functions, each corresponding to a specific API endpoint, to handle various chunk-related operations. These functions interact with database operators and external services like Qdrant and OpenAI to perform the requested actions.

## References
This file references several other modules and data structures within the codebase, including:
- `auth_handler`: For authentication and authorization of API requests.
- `data::models`: For data models representing chunks, datasets, and other entities.
- `operators`: For database, Qdrant, and OpenAI interaction logic.

## Symbols

### `create_chunk`
#### Description
This function handles the creation of new chunk(s) within a dataset. It checks for plan limits, creates chunk metadata, queues ingestion messages for processing, and returns the created chunk(s) along with their position in the ingestion queue.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `create_chunk_data` | `web::Json&lt;CreateChunkReqPayloadEnum&gt;` | JSON payload containing chunk data for single or batch creation. |
| `pool` | `web::Data&lt;Pool&gt;` | Database connection pool. |
| `_user` | `AdminOnly` | Authenticated user with admin or owner role. |
| `dataset_org_plan_sub` | `DatasetAndOrgWithSubAndPlan` | Dataset, organization, plan, and subscription information. |
| `redis_pool` | `web::Data&lt;RedisPool&gt;` | Redis connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `HttpResponse` | `Result&lt;HttpResponse, actix_web::Error&gt;` | HTTP response indicating success or failure. |

#### Internal Logic
1. Extract chunk data from the request payload.
2. Check if the organization's chunk count limit is exceeded.
3. Create chunk metadata for both upsert and non-upsert chunks.
4. Queue ingestion messages for processing in Redis.
5. Return the created chunk(s) and their position in the queue.

### `delete_chunk`
#### Description
This function handles the deletion of a chunk by its ID. It retrieves the dataset configuration, marks the chunk as deleted in the database, and removes it from Qdrant.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `chunk_id` | `web::Path&lt;uuid::Uuid&gt;` | ID of the chunk to delete. |
| `pool` | `web::Data&lt;Pool&gt;` | Database connection pool. |
| `_user` | `AdminOnly` | Authenticated user with admin or owner role. |
| `dataset_org_plan_sub` | `DatasetAndOrgWithSubAndPlan` | Dataset, organization, plan, and subscription information. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `HttpResponse` | `Result&lt;HttpResponse, actix_web::Error&gt;` | HTTP response indicating success or failure. |

#### Internal Logic
1. Retrieve the dataset configuration.
2. Mark the chunk as deleted in the database.
3. Remove the chunk from Qdrant.
4. Return a NoContent response.

### `delete_chunk_by_tracking_id`
#### Description
This function handles the deletion of a chunk by its tracking ID. It retrieves the chunk metadata, marks the chunk as deleted in the database, and removes it from Qdrant.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `tracking_id` | `web::Path&lt;String&gt;` | Tracking ID of the chunk to delete. |
| `pool` | `web::Data&lt;Pool&gt;` | Database connection pool. |
| `_user` | `AdminOnly` | Authenticated user with admin or owner role. |
| `dataset_org_plan_sub` | `DatasetAndOrgWithSubAndPlan` | Dataset, organization, plan, and subscription information. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `HttpResponse` | `Result&lt;HttpResponse, actix_web::Error&gt;` | HTTP response indicating success or failure. |

#### Internal Logic
1. Retrieve the chunk metadata using the tracking ID.
2. Mark the chunk as deleted in the database.
3. Remove the chunk from Qdrant.
4. Return a NoContent response.

### `update_chunk`
#### Description
This function handles the update of an existing chunk. It retrieves the chunk metadata, updates the relevant fields, queues an ingestion message for processing, and returns a NoContent response.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `update_chunk_data` | `web::Json&lt;UpdateChunkReqPayload&gt;` | JSON payload containing chunk update data. |
| `pool` | `web::Data&lt;Pool&gt;` | Database connection pool. |
| `redis_pool` | `web::Data&lt;RedisPool&gt;` | Redis connection pool. |
| `_user` | `AdminOnly` | Authenticated user with admin or owner role. |
| `dataset_org_plan_sub` | `DatasetAndOrgWithSubAndPlan` | Dataset, organization, plan, and subscription information. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `HttpResponse` | `Result&lt;HttpResponse, actix_web::Error&gt;` | HTTP response indicating success or failure. |

#### Internal Logic
1. Retrieve the chunk metadata using either the chunk ID or tracking ID.
2. Update the chunk metadata with the provided data.
3. Queue an ingestion message for processing in Redis.
4. Return a NoContent response.

### `update_chunk_by_tracking_id`
#### Description
This function is deprecated and handles the update of an existing chunk by its tracking ID. It retrieves the chunk metadata, updates the relevant fields, queues an ingestion message for processing, and returns a NoContent response.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `update_chunk_data` | `web::Json&lt;UpdateChunkByTrackingIdData&gt;` | JSON payload containing chunk update data. |
| `pool` | `web::Data&lt;Pool&gt;` | Database connection pool. |
| `redis_pool` | `web::Data&lt;RedisPool&gt;` | Redis connection pool. |
| `_user` | `AdminOnly` | Authenticated user with admin or owner role. |
| `dataset_org_plan_sub` | `DatasetAndOrgWithSubAndPlan` | Dataset, organization, plan, and subscription information. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `HttpResponse` | `Result&lt;HttpResponse, actix_web::Error&gt;` | HTTP response indicating success or failure. |

#### Internal Logic
1. Retrieve the chunk metadata using the tracking ID.
2. Update the chunk metadata with the provided data.
3. Queue an ingestion message for processing in Redis.
4. Return a NoContent response.

### `search_chunks`
#### Description
This function handles the primary search functionality for chunks. It supports semantic, full-text, and hybrid search methods, applies filters, sorts results, and highlights matching text.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `data` | `web::Json&lt;SearchChunksReqPayload&gt;` | JSON payload containing search parameters. |
| `_user` | `LoggedUser` | Authenticated user. |
| `pool` | `web::Data&lt;Pool&gt;` | Database connection pool. |
| `event_queue` | `web::Data&lt;EventQueue&gt;` | ClickHouse event queue. |
| `api_version` | `APIVersion` | API version to use for the response. |
| `dataset_org_plan_sub` | `DatasetAndOrgWithSubAndPlan` | Dataset, organization, plan, and subscription information. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `HttpResponse` | `Result&lt;HttpResponse, actix_web::Error&gt;` | HTTP response containing search results. |

#### Internal Logic
1. Parse the search query and apply stop word removal and quote/negated term parsing.
2. Perform the search based on the specified search type (semantic, full-text, or hybrid).
3. Apply filters, sort results, and highlight matching text.
4. Send a search query event to ClickHouse for analytics.
5. Return the search results in the appropriate API version format.

### `autocomplete`
#### Description
This function handles the autocomplete functionality for chunks. It prioritizes prefix matching with semantic or full-text search and can extend results to include non-exact matches.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `data` | `web::Json&lt;AutocompleteReqPayload&gt;` | JSON payload containing autocomplete parameters. |
| `_user` | `LoggedUser` | Authenticated user. |
| `pool` | `web::Data&lt;Pool&gt;` | Database connection pool. |
| `event_queue` | `web::Data&lt;EventQueue&gt;` | ClickHouse event queue. |
| `api_version` | `APIVersion` | API version to use for the response. |
| `dataset_org_plan_sub` | `DatasetAndOrgWithSubAndPlan` | Dataset, organization, plan, and subscription information. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `HttpResponse` | `Result&lt;HttpResponse, actix_web::Error&gt;` | HTTP response containing autocomplete results. |

#### Internal Logic
1. Parse the search query and apply stop word removal and quote/negated term parsing.
2. Perform the autocomplete search based on the specified search type (semantic or full-text).
3. Apply filters, sort results, and highlight matching text.
4. Send a search query event to ClickHouse for analytics.
5. Return the autocomplete results in the appropriate API version format.

### `scroll_dataset_chunks`
#### Description
This function handles the retrieval of paginated chunks from a dataset with filters and custom sorting.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `data` | `web::Json&lt;ScrollChunksReqPayload&gt;` | JSON payload containing scroll parameters. |
| `_user` | `LoggedUser` | Authenticated user. |
| `dataset_org_plan_sub` | `DatasetAndOrgWithSubAndPlan` | Dataset, organization, plan, and subscription information. |
| `pool` | `web::Data&lt;Pool&gt;` | Database connection pool. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `HttpResponse` | `Result&lt;HttpResponse, actix_web::Error&gt;` | HTTP response containing paginated chunks. |

#### Internal Logic
1. Assemble a Qdrant filter based on the provided filters.
2. Retrieve Qdrant point IDs based on the scroll parameters, filter, and sort options.
3. Retrieve chunk metadata from the point IDs.
4. Order the chunks based on the retrieved point IDs.
5. Return the paginated chunks.

### `get_chunk_by_id`
#### Description
This function handles the retrieval of a single chunk by its ID.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `chunk_id` | `web::Path&lt;uuid::Uuid&gt;` | ID of the chunk to retrieve. |
| `_user` | `LoggedUser` | Authenticated user. |
| `pool` | `web::Data&lt;Pool&gt;` | Database connection pool. |
| `api_version` | `APIVersion` | API version to use for the response. |
| `dataset_org_plan_sub` | `DatasetAndOrgWithSubAndPlan` | Dataset, organization, plan, and subscription information. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `Result&lt;HttpResponse, ServiceError&gt;` |  | HTTP response containing the chunk or an error. |

#### Internal Logic
1. Retrieve the chunk metadata from the database.
2. Check if the chunk exists in Qdrant.
3. Return the chunk in the appropriate API version format.

### `count_chunks`
#### Description
This function handles the counting of chunks that match a search query, including score threshold and filters.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `data` | `web::Json&lt;CountChunksReqPayload&gt;` | JSON payload containing count parameters. |
| `_user` | `LoggedUser` | Authenticated user. |
| `pool` | `web::Data&lt;Pool&gt;` | Database connection pool. |
| `dataset_org_plan_sub` | `DatasetAndOrgWithSubAndPlan` | Dataset, organization, plan, and subscription information. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| `HttpResponse` | `Result&lt;HttpResponse, actix_web::Error&gt;` | HTTP response containing the chunk count. |

####