---
title: "stripe_handler.rs"
---

## High-level description
The `stripe_handler.rs` file defines handlers for interacting with the Stripe API, primarily for managing subscriptions and plans. It includes functions for creating and canceling subscriptions, updating subscription plans, retrieving plans and invoices, and handling Stripe webhooks.

## Code Structure
The code defines several functions, each responsible for a specific interaction with the Stripe API. These functions are independent of each other and do not share any internal state.

## References
This file references several operators from the `stripe_operator` module, such as `create_stripe_subscription_query`, `cancel_stripe_subscription`, `update_stripe_subscription`, etc. These operators handle the actual interaction with the Stripe API and database.

## Symbols

### `webhook`
#### Description
This function handles incoming webhooks from Stripe. It verifies the webhook signature, parses the event type, and performs corresponding actions based on the event data.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| req | HttpRequest | The incoming HTTP request containing the webhook payload and signature. |
| payload | web::Bytes | The raw bytes of the webhook payload. |
| pool | web::Data&lt;Pool&gt; | A connection pool for the database. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| HttpResponse | actix_web::Error | An HTTP response indicating the success or failure of the webhook processing. |

#### Internal Logic
1. **Verify Signature:** The function first verifies the signature of the incoming webhook using the `Stripe-Signature` header and the `STRIPE_WEBHOOK_SECRET` environment variable.
2. **Parse Event:** If the signature is valid, the function parses the webhook payload into a `stripe::Event` object.
3. **Handle Event:** Based on the event type, the function performs different actions:
    - `CheckoutSessionCompleted`: If the checkout session is in `Setup` mode, it retrieves the setup intent and updates the subscription's payment method. Otherwise, it creates a new subscription and invoice in the database.
    - `PlanCreated`: Creates a new plan in the database based on the plan data from Stripe.
    - `CustomerSubscriptionDeleted`: Updates the subscription's `current_period_end` in the database.
    - `InvoicePaid`: Creates a new invoice in the database based on the invoice data from Stripe.

### `direct_to_payment_link`
#### Description
This function generates a Stripe payment link for a specific plan and organization and redirects the user to the Stripe checkout page.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| path_data | web::Path&lt;GetDirectPaymentLinkData&gt; | Path parameters containing the plan ID and organization ID. |
| pool | web::Data&lt;Pool&gt; | A connection pool for the database. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| HttpResponse | actix_web::Error | An HTTP response with a 303 SeeOther redirect to the Stripe checkout page. |

#### Internal Logic
1. **Check Existing Subscription:** The function checks if the organization already has an active subscription. If so, it returns a 409 Conflict response.
2. **Retrieve Plan and Organization:** Retrieves the plan and organization data from the database based on the provided IDs.
3. **Create Payment Link:** Calls the `create_stripe_payment_link` function to generate a payment link for the plan and organization.
4. **Redirect:** Returns a 303 SeeOther response with the payment link in the `Location` header, redirecting the user to the Stripe checkout page.

### `cancel_subscription`
#### Description
This function cancels a Stripe subscription by its ID.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| subscription_id | web::Path&lt;uuid::Uuid&gt; | The ID of the subscription to cancel. |
| user | OwnerOnly | The authenticated user, verified to be the owner of the organization associated with the subscription. |
| pool | web::Data&lt;Pool&gt; | A connection pool for the database. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| HttpResponse | actix_web::Error | An HTTP response indicating the success or failure of the cancellation. |

#### Internal Logic
1. **Verify Ownership:** The function verifies that the authenticated user is the owner of the organization associated with the subscription.
2. **Cancel Subscription:** Calls the `cancel_stripe_subscription` function to cancel the subscription on Stripe.
3. **Return Response:** Returns a 200 OK response if the cancellation was successful.

### `update_subscription_plan`
#### Description
This function updates a Stripe subscription to a new plan.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| path_data | web::Path&lt;UpdateSubscriptionData&gt; | Path parameters containing the subscription ID and plan ID. |
| user | OwnerOnly | The authenticated user, verified to be the owner of the organization associated with the subscription. |
| pool | web::Data&lt;Pool&gt; | A connection pool for the database. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| HttpResponse | actix_web::Error | An HTTP response indicating the success or failure of the update. |

#### Internal Logic
1. **Verify Ownership:** The function verifies that the authenticated user is the owner of the organization associated with the subscription.
2. **Retrieve Subscription and Plan:** Retrieves the subscription and plan data from the database based on the provided IDs.
3. **Update Subscription:** Calls the `update_stripe_subscription` function to update the subscription on Stripe.
4. **Update Database:** Updates the subscription's plan ID in the database.
5. **Return Response:** Returns a 200 OK response if the update was successful.

### `get_all_plans`
#### Description
This function retrieves a list of all Stripe plans from the database.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| pool | web::Data&lt;Pool&gt; | A connection pool for the database. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| HttpResponse | actix_web::Error | An HTTP response containing a JSON array of `StripePlan` objects. |

#### Internal Logic
1. **Retrieve Plans:** Calls the `get_all_plans_query` function to retrieve all plans from the database.
2. **Return Response:** Returns a 200 OK response with the retrieved plans as a JSON array.

### `get_all_invoices`
#### Description
This function retrieves a list of all Stripe invoices for a specific organization from the database.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| pool | web::Data&lt;Pool&gt; | A connection pool for the database. |
| user | OwnerOnly | The authenticated user, verified to be the owner of the organization. |
| path_data | web::Path&lt;uuid::Uuid&gt; | The ID of the organization. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| HttpResponse | actix_web::Error | An HTTP response containing a JSON array of `StripeInvoice` objects. |

#### Internal Logic
1. **Retrieve Invoices:** Calls the `get_invoices_for_org_query` function to retrieve all invoices for the organization from the database.
2. **Return Response:** Returns a 200 OK response with the retrieved invoices as a JSON array.

### `create_setup_checkout_session`
#### Description
This function creates a Stripe checkout session for setting up a payment method for an existing subscription.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| pool | web::Data&lt;Pool&gt; | A connection pool for the database. |
| user | OwnerOnly | The authenticated user, verified to be the owner of the organization. |
| path_data | web::Path&lt;uuid::Uuid&gt; | The ID of the organization. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| HttpResponse | actix_web::Error | An HTTP response containing a JSON object with the checkout session URL. |

#### Internal Logic
1. **Retrieve Subscription:** Retrieves the subscription for the organization from the database.
2. **Create Checkout Session:** Calls the `create_stripe_setup_checkout_session` function to create a checkout session on Stripe.
3. **Return Response:** Returns a 200 OK response with the checkout session URL in a JSON object.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| stripe | Interacting with the Stripe API. |
| reqwest | Making HTTP requests to the Stripe API. |
| diesel | Interacting with the PostgreSQL database. |
| redis | Interacting with the Redis cache. |

## Error Handling
The functions in this file use the `ServiceError` enum to represent different error conditions. These errors are converted into HTTP responses with appropriate status codes and error messages using the `ResponseError` implementation for `ServiceError`.
