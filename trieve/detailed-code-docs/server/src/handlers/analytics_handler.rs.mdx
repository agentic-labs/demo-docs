---
title: "analytics_handler.rs"
---

## High-level description
This file contains handlers for analytics-related operations in a server application. It defines various endpoints for retrieving and managing analytics data, such as search queries, cluster analytics, RAG (Retrieval-Augmented Generation) analytics, recommendation analytics, and CTR (Click-Through Rate) data. The handlers interact with a ClickHouse database to fetch and store analytics information.

## Code Structure
The main symbols in this code are handler functions that correspond to different API endpoints. These functions typically take input parameters, interact with the ClickHouse database using the `clickhouse_client`, and return structured responses. The code also defines several response structures used to format the data returned by these handlers.

## Symbols

### `get_cluster_analytics`
#### Description
Retrieves cluster analytics for a dataset.

#### Inputs
- `data`: JSON payload containing filter information
- `_user`: AdminOnly user authentication
- `clickhouse_client`: ClickHouse database client
- `dataset_org_plan_sub`: Dataset and organization information

#### Outputs
- `Result&lt;HttpResponse, ServiceError&gt;`: HTTP response with cluster analytics or an error

#### Internal Logic
- Matches the input data to determine the type of cluster analytics requested
- Calls the appropriate query function (`get_clusters_query` or `get_queries_for_cluster_query`)
- Returns the result as a JSON response

### `set_query_rating`
#### Description
Rates a query.

#### Inputs
- `data`: JSON payload containing rating information
- `_user`: AdminOnly user authentication
- `clickhouse_client`: ClickHouse database client
- `dataset_org_plan_sub`: Dataset and organization information

#### Outputs
- `Result&lt;HttpResponse, ServiceError&gt;`: HTTP response indicating success or an error

#### Internal Logic
- Calls `set_query_rating_query` to update the rating in the database
- Returns a no-content response on success

### `get_search_analytics`
#### Description
Retrieves various types of search analytics for a dataset.

#### Inputs
- `data`: JSON payload specifying the type of search analytics requested
- `_user`: AdminOnly user authentication
- `clickhouse_client`: ClickHouse database client
- `dataset_org_plan_sub`: Dataset and organization information

#### Outputs
- `Result&lt;HttpResponse, ServiceError&gt;`: HTTP response with search analytics or an error

#### Internal Logic
- Matches the input data to determine the type of search analytics requested
- Calls the appropriate query function (e.g., `get_latency_graph_query`, `get_search_usage_graph_query`, etc.)
- Returns the result as a JSON response

### `get_rag_analytics`
#### Description
Retrieves RAG (Retrieval-Augmented Generation) analytics for a dataset.

#### Inputs
- `data`: JSON payload specifying the type of RAG analytics requested
- `_user`: AdminOnly user authentication
- `clickhouse_client`: ClickHouse database client
- `pool`: Database connection pool
- `dataset_org_plan_sub`: Dataset and organization information

#### Outputs
- `Result&lt;HttpResponse, ServiceError&gt;`: HTTP response with RAG analytics or an error

#### Internal Logic
- Matches the input data to determine the type of RAG analytics requested
- Calls the appropriate query function (e.g., `get_rag_usage_query`, `get_rag_queries_query`, etc.)
- Returns the result as a JSON response

### `get_recommendation_analytics`
#### Description
Retrieves recommendation analytics for a dataset.

#### Inputs
- `data`: JSON payload specifying the type of recommendation analytics requested
- `_user`: AdminOnly user authentication
- `clickhouse_client`: ClickHouse database client
- `dataset_org_plan_sub`: Dataset and organization information

#### Outputs
- `Result&lt;HttpResponse, ServiceError&gt;`: HTTP response with recommendation analytics or an error

#### Internal Logic
- Matches the input data to determine the type of recommendation analytics requested
- Calls the appropriate query function (e.g., `get_low_confidence_recommendations_query`, `get_recommendation_queries_query`)
- Returns the result as a JSON response

### `send_ctr_data`
#### Description
Sends CTR (Click-Through Rate) data to the system.

#### Inputs
- `_user`: AdminOnly user authentication
- `data`: JSON payload containing CTR data
- `clickhouse_client`: ClickHouse database client
- `pool`: Database connection pool
- `dataset_org_plan_sub`: Dataset and organization information

#### Outputs
- `Result&lt;HttpResponse, ServiceError&gt;`: HTTP response indicating success or an error

#### Internal Logic
- Calls `send_ctr_data_query` to store the CTR data in the database
- Returns a no-content response on success

### `get_ctr_analytics`
#### Description
Retrieves CTR analytics for a dataset.

#### Inputs
- `_user`: AdminOnly user authentication
- `data`: JSON payload specifying the type of CTR analytics requested
- `clickhouse_client`: ClickHouse database client
- `pool`: Database connection pool
- `dataset_org_plan_sub`: Dataset and organization information

#### Outputs
- `Result&lt;HttpResponse, ServiceError&gt;`: HTTP response with CTR analytics or an error

#### Internal Logic
- Matches the input data to determine the type of CTR analytics requested
- Calls the appropriate query function (e.g., `get_search_ctr_metrics_query`, `get_searches_with_clicks_query`, etc.)
- Returns the result as a JSON response

## Dependencies
- `actix_web`: Web framework for handling HTTP requests and responses
- `clickhouse`: Client for interacting with the ClickHouse database
- `serde`: Serialization and deserialization of data structures
- `utoipa`: API documentation generation
- Custom error types and models from the application's codebase

This file is part of a larger analytics system, focusing on the HTTP handlers that serve as the entry points for various analytics-related operations. It relies heavily on query functions defined elsewhere (likely in the `analytics_operator.rs` file) to interact with the ClickHouse database and process the data.