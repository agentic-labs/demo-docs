---
title: "Overview"
---

## High-level description
This directory contains SQL migration files for adding a user-organization relation to the database schema. It includes two files: `up.sql` for applying the changes and `down.sql` for reverting them. The migration adds an `organization_id` column to the `users` table and establishes a foreign key relationship with the `organizations` table.

## What does it do?
This migration modifies the database structure to create a relationship between users and organizations. Here's what it does in simple terms:

1. It adds a new column called `organization_id` to the table that stores user information.
2. This new column is set up to contain a unique identifier (UUID) for an organization.
3. It creates a link (foreign key) between the user table and the organization table, ensuring that each user belongs to a valid organization.
4. If needed, it also provides a way to undo these changes by removing the new column and the link between users and organizations.

This change allows the system to associate each user with a specific organization, which can be useful for features like user management, access control, or organization-specific data handling.

## Key Files

1. `up.sql`:
   - Purpose: Applies the database changes to add the user-organization relation.
   - Contents:
     ```sql
     ALTER TABLE users ADD COLUMN organization_id UUID NOT NULL;
     ALTER TABLE users ADD CONSTRAINT users_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES organizations(id);
     ```
   - This file adds the `organization_id` column to the `users` table and creates a foreign key constraint linking it to the `organizations` table.

2. `down.sql`:
   - Purpose: Reverts the changes made by `up.sql`.
   - Contents:
     ```sql
     ALTER TABLE users DROP COLUMN IF EXISTS organization_id;
     ```
   - This file removes the `organization_id` column from the `users` table if it exists.

## Configuration
This migration does not require any specific configuration files or environment variables. However, it assumes the existence of the following database tables:

| Table Name | Description |
|:-----------|:------------|
| `users` | The table storing user information, which will be modified |
| `organizations` | The table storing organization information, which will be referenced by the new foreign key |

## Side Effects and Performance Considerations

1. Data Integrity:
   - The `NOT NULL` constraint on `organization_id` ensures that every user must be associated with an organization.
   - The foreign key constraint prevents users from being associated with non-existent organizations.

2. Existing Data:
   - If the `users` table already contains data, you'll need to ensure that valid `organization_id` values are assigned to existing rows when applying this migration.

3. Performance:
   - Adding a new column and constraint may temporarily lock the `users` table during migration.
   - The foreign key constraint may slightly impact the performance of insert and update operations on the `users` table.

4. Reversibility:
   - Running the `down.sql` migration will remove the `organization_id` column and its data, which is not recoverable unless backed up separately.

5. Database Operations:
   - After applying this migration, operations that insert or update user records will need to provide a valid `organization_id`.
   - Deleting organizations may be restricted if there are associated users, depending on the foreign key delete rule (not specified in these scripts).

When applying or reverting this migration, consider its impact on existing data and any application code that interacts with the `users` table. Ensure that your application is updated to handle the new column and relationship appropriately.