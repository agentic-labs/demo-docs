---
title: "Overview"
---

## High-level description
This directory contains SQL migration scripts for creating and managing a `user_collection_counts` table in the database. The migration is designed to track the number of collections each user has and keep this count updated automatically. The directory includes two SQL files: `up.sql` for applying the changes and `down.sql` for reverting them.

## What does it do?
The migration scripts in this directory accomplish the following:

1. Create a new table called `user_collection_counts` to store the number of collections for each user.
2. Set up an automatic system (using a trigger and function) to keep the collection count up-to-date whenever collections are added or removed.
3. Initialize the new table with existing data from the `card_collection` table.
4. Provide a way to undo these changes if needed, returning the database to its previous state.

This functionality allows the application to efficiently track and query the number of collections each user has without the need for expensive count operations on the `card_collection` table every time this information is needed.

## Key Files

### up.sql
This file contains the SQL commands to apply the migration:

1. Creates the `user_collection_counts` table with columns:
   - `id` (UUID): Primary key
   - `user_id` (UUID): Foreign key referencing the `users` table
   - `collection_count` (INTEGER): Number of collections for the user

2. Defines a function `update_collection_counts` that updates the `user_collection_counts` table when changes occur in the `card_collection` table.

3. Creates a trigger `update_collection_counts_trigger` on the `card_collection` table that calls the `update_collection_counts` function after inserts, updates, or deletes.

4. Initializes the `user_collection_counts` table with existing data from the `card_collection` table.

Here's a snippet of the trigger function:

```sql
CREATE OR REPLACE FUNCTION update_collection_counts() RETURNS TRIGGER AS $$
BEGIN
    IF (TG_OP = 'INSERT') THEN
        INSERT INTO user_collection_counts (id, user_id, collection_count)
        VALUES (gen_random_uuid(), NEW.author_id, 1)
        ON CONFLICT (user_id) DO UPDATE SET collection_count = user_collection_counts.collection_count + 1;
    ELSIF (TG_OP = 'DELETE') THEN
        UPDATE user_collection_counts
        SET collection_count = collection_count - 1
        WHERE user_id = OLD.author_id;
    END IF;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql;
```

### down.sql
This file contains the SQL commands to revert the migration:

1. Drops the `update_collection_counts_trigger` trigger from the `card_collection` table.
2. Drops the `update_collection_counts` function.
3. Drops the `user_collection_counts` table.

Here's the content of `down.sql`:

```sql
DROP TRIGGER IF EXISTS update_collection_counts_trigger ON card_collection;
DROP FUNCTION IF EXISTS update_collection_counts;
DROP TABLE IF EXISTS user_collection_counts;
```

## Dependencies
The migration scripts assume the existence of:
- A `users` table with an `id` column of type UUID.
- A `card_collection` table with `id` and `author_id` columns.

The scripts use PostgreSQL-specific features such as:
- `gen_random_uuid()` function for generating UUIDs.
- `ON CONFLICT` clause for handling potential conflicts during inserts.

## Configuration
These migration scripts don't require any specific configuration. They are designed to be run as part of a database migration process, typically managed by an ORM or migration tool in the application's backend.

The naming convention of the directory (2023-08-07-071924_create-user-collection-count-table) suggests that this migration was created on August 7, 2023, at 07:19:24, and its purpose is to create the user collection count table.