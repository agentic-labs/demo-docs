---
title: "Overview"
---

## High-level description
This directory contains SQL migration files for modifying the `users` table in a database. The migration adds new columns for username, website, and email visibility, and provides a way to revert these changes if needed.

## What does it do?
The migration scripts in this directory perform the following actions:

1. Add new columns to the `users` table:
   - `username`: A unique, optional text field for storing user's chosen username.
   - `website`: An optional text field for storing the user's website URL.
   - `visible_email`: A boolean field to control whether a user's email is visible to others.

2. Set a default value for the email visibility for existing users.

3. Provide a way to undo these changes by removing the newly added columns if needed.

These changes allow the application to store additional user information and provide more control over email visibility settings.

## Key Files

### up.sql
This file contains the SQL commands to apply the migration:

```sql
ALTER TABLE users
ADD COLUMN username TEXT UNIQUE,
ADD COLUMN website TEXT,
ADD COLUMN visible_email BOOLEAN NOT NULL DEFAULT false;

UPDATE users SET visible_email = true;
```

It adds the new columns to the `users` table and sets the `visible_email` to true for all existing users.

### down.sql
This file contains the SQL commands to revert the migration:

```sql
ALTER TABLE users
DROP COLUMN username,
DROP COLUMN website,
DROP COLUMN visible_email;
```

It removes the columns added by the `up.sql` script, effectively undoing the changes made to the `users` table.

## Dependencies
This migration likely depends on a database migration system, possibly using tools like Diesel for Rust or other similar ORM (Object-Relational Mapping) libraries that support database migrations.

## Configuration
The migration is identified by its timestamp: `2023-05-27-192000`. This timestamp is used to order migrations and ensure they are applied in the correct sequence.

## Performance Considerations
1. The `ALTER TABLE` operations in both `up.sql` and `down.sql` may temporarily lock the `users` table during execution. This could impact database performance, especially if the table is large.
2. The `UPDATE` statement in `up.sql` affects all existing rows in the `users` table, which could be resource-intensive for tables with a large number of records.

## TODOs
There is a potential inconsistency in the `up.sql` script:
1. The `visible_email` column is added with a DEFAULT value of false.
2. However, the subsequent UPDATE statement sets `visible_email` to true for all existing rows.

This discrepancy should be reviewed to ensure it aligns with the intended behavior for email visibility settings.