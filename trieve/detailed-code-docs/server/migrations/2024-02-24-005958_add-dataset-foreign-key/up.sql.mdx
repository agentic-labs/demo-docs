---
title: "up.sql"
---

## High-level description
This SQL script applies a database migration to add foreign key constraints to several tables, linking them to the `datasets` table. This ensures referential integrity by enforcing that entries in these tables have a corresponding dataset in the `datasets` table.

## Code Structure
This script consists of a series of SQL `ALTER TABLE` statements. Each statement either drops an existing foreign key constraint or adds a new one. All new constraints reference the `datasets` table, establishing a relationship between datasets and other entities like events, files, and messages.

## Symbols
### `ALTER TABLE dataset_usage_counts`
#### Description
This statement modifies the `dataset_usage_counts` table. It first attempts to drop a foreign key constraint named `dataset_usage_counts_dataset_id_fkey` if it exists. Then, it adds a new foreign key constraint with the same name, referencing the `id` column of the `datasets` table. The `ON UPDATE CASCADE` and `ON DELETE CASCADE` clauses ensure that any updates or deletions to the `datasets` table are cascaded to the `dataset_usage_counts` table.

#### Internal Logic
1. **Drop existing constraint (if exists):** `DROP CONSTRAINT if exists dataset_usage_counts_dataset_id_fkey;`
2. **Add new constraint:** `ADD CONSTRAINT dataset_usage_counts_dataset_id_fkey FOREIGN KEY (dataset_id) REFERENCES datasets(id) ON UPDATE CASCADE ON DELETE CASCADE;`

### `ALTER TABLE events`
#### Description
This statement modifies the `events` table. It first attempts to drop a foreign key constraint named `notifications_dataset_id_fkey` if it exists. Then, it adds a new foreign key constraint named `events_dataset_id_fkey`, referencing the `id` column of the `datasets` table. The `ON UPDATE CASCADE` and `ON DELETE CASCADE` clauses ensure cascading updates and deletions.

#### Internal Logic
1. **Drop existing constraint (if exists):** `DROP CONSTRAINT if exists notifications_dataset_id_fkey;`
2. **Add new constraint:** `ADD CONSTRAINT events_dataset_id_fkey FOREIGN KEY (dataset_id) REFERENCES datasets(id) ON UPDATE CASCADE ON DELETE CASCADE;`

### `ALTER TABLE chunk_metadata`
#### Description
This statement modifies the `chunk_metadata` table. It first attempts to drop a foreign key constraint named `card_metadata_dataset_id_fkey` if it exists. Then, it adds a new foreign key constraint named `chunk_metadata_dataset_id_fkey`, referencing the `id` column of the `datasets` table. The `ON UPDATE CASCADE` and `ON DELETE CASCADE` clauses ensure cascading updates and deletions.

#### Internal Logic
1. **Drop existing constraint (if exists):** `DROP CONSTRAINT if exists card_metadata_dataset_id_fkey;`
2. **Add new constraint:** `ADD CONSTRAINT chunk_metadata_dataset_id_fkey FOREIGN KEY (dataset_id) REFERENCES datasets(id) ON UPDATE CASCADE ON DELETE CASCADE;`

### `ALTER TABLE chunk_group`
#### Description
This statement modifies the `chunk_group` table. It first attempts to drop a foreign key constraint named `card_collection_dataset_id_fkey` if it exists. Then, it adds a new foreign key constraint named `chunk_group_dataset_id_fkey`, referencing the `id` column of the `datasets` table. The `ON UPDATE CASCADE` and `ON DELETE CASCADE` clauses ensure cascading updates and deletions.

#### Internal Logic
1. **Drop existing constraint (if exists):** `DROP CONSTRAINT if exists card_collection_dataset_id_fkey;`
2. **Add new constraint:** `ADD CONSTRAINT chunk_group_dataset_id_fkey FOREIGN KEY (dataset_id) REFERENCES datasets(id) ON UPDATE CASCADE ON DELETE CASCADE;`

### `ALTER TABLE files`
#### Description
This statement modifies the `files` table. It first attempts to drop a foreign key constraint named `files_dataset_id_fkey` if it exists. Then, it adds a new foreign key constraint with the same name, referencing the `id` column of the `datasets` table. The `ON UPDATE CASCADE` and `ON DELETE CASCADE` clauses ensure cascading updates and deletions.

#### Internal Logic
1. **Drop existing constraint (if exists):** `DROP CONSTRAINT if exists files_dataset_id_fkey;`
2. **Add new constraint:** `ADD CONSTRAINT files_dataset_id_fkey FOREIGN KEY (dataset_id) REFERENCES datasets(id) ON UPDATE CASCADE ON DELETE CASCADE;`

### `ALTER TABLE chunk_files -&gt; files`
#### Description
This statement modifies the `chunk_files` table. It first attempts to drop a foreign key constraint named `card_files_file_id_fkey` if it exists. Then, it adds a new foreign key constraint named `chunk_files_file_id_fkey`, referencing the `id` column of the `files` table. The `ON UPDATE CASCADE` and `ON DELETE CASCADE` clauses ensure cascading updates and deletions.

#### Internal Logic
1. **Drop existing constraint (if exists):** `DROP CONSTRAINT if exists card_files_file_id_fkey;`
2. **Add new constraint:** `ADD CONSTRAINT chunk_files_file_id_fkey FOREIGN KEY (file_id) REFERENCES files(id) ON UPDATE CASCADE ON DELETE CASCADE;`

### `ALTER TABLE chunk_files -&gt; chunks`
#### Description
This statement modifies the `chunk_files` table. It first attempts to drop a foreign key constraint named `card_files_card_id_fkey` if it exists. Then, it adds a new foreign key constraint named `chunk_files_chunk_id_fkey`, referencing the `id` column of the `chunk_metadata` table. The `ON UPDATE CASCADE` and `ON DELETE CASCADE` clauses ensure cascading updates and deletions.

#### Internal Logic
1. **Drop existing constraint (if exists):** `DROP CONSTRAINT if exists card_files_card_id_fkey;`
2. **Add new constraint:** `ADD CONSTRAINT chunk_files_chunk_id_fkey FOREIGN KEY (chunk_id) REFERENCES chunk_metadata(id) ON UPDATE CASCADE ON DELETE CASCADE;`

### `ALTER TABLE messages`
#### Description
This statement modifies the `messages` table. It first attempts to drop a foreign key constraint named `messages_dataset_id_fkey` if it exists. Then, it adds a new foreign key constraint with the same name, referencing the `id` column of the `datasets` table. The `ON UPDATE CASCADE` and `ON DELETE CASCADE` clauses ensure cascading updates and deletions.

#### Internal Logic
1. **Drop existing constraint (if exists):** `DROP CONSTRAINT if exists messages_dataset_id_fkey;`
2. **Add new constraint:** `ADD CONSTRAINT messages_dataset_id_fkey FOREIGN KEY (dataset_id) REFERENCES datasets(id) ON UPDATE CASCADE ON DELETE CASCADE;`

### `ALTER TABLE topics`
#### Description
This statement modifies the `topics` table. It first attempts to drop a foreign key constraint named `topics_dataset_id_fkey` if it exists. Then, it adds a new foreign key constraint with the same name, referencing the `id` column of the `datasets` table. The `ON UPDATE CASCADE` and `ON DELETE CASCADE` clauses ensure cascading updates and deletions.

#### Internal Logic
1. **Drop existing constraint (if exists):** `DROP CONSTRAINT if exists topics_dataset_id_fkey;`
2. **Add new constraint:** `ADD CONSTRAINT topics_dataset_id_fkey FOREIGN KEY (dataset_id) REFERENCES datasets(id) ON UPDATE CASCADE ON DELETE CASCADE;`
