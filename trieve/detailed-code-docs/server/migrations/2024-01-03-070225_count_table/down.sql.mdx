---
title: "down.sql"
---

## High-level description
This SQL migration script reverts the changes introduced by the `up.sql` migration for the "count_table" feature. It removes triggers, functions, and tables related to usage counts for datasets and organizations, and instead creates a table and trigger for tracking chunk metadata counts.

## Symbols

### `DROP TRIGGER IF EXISTS update_dataset_counts_trigger ON dataset_usage_counts`
#### Description
This statement attempts to drop a trigger named `update_dataset_counts_trigger` on the `dataset_usage_counts` table if it exists. This suggests that the `up.sql` migration likely created this trigger.

#### Internal Logic
- It uses `DROP TRIGGER IF EXISTS` to avoid errors if the trigger doesn't exist.
- `ON dataset_usage_counts` specifies the table associated with the trigger.

### `DROP TRIGGER IF EXISTS update_organization_counts_trigger ON organization_usage_counts`
#### Description
Similar to the previous statement, this one attempts to drop a trigger named `update_organization_counts_trigger` on the `organization_usage_counts` table if it exists.

### `DROP FUNCTION IF EXISTS update_dataset_counts()`
#### Description
This statement drops a function named `update_dataset_counts` if it exists. The empty parentheses indicate that the function takes no arguments.

### `DROP FUNCTION IF EXISTS update_organization_counts()`
#### Description
This statement drops a function named `update_organization_counts` if it exists. Like the previous function, it also takes no arguments.

### `DROP TABLE IF EXISTS dataset_usage_counts`
#### Description
This statement drops a table named `dataset_usage_counts` if it exists.

### `DROP TABLE IF EXISTS organization_usage_counts`
#### Description
This statement drops a table named `organization_usage_counts` if it exists.

### `CREATE TABLE IF NOT EXISTS chunk_metadata_counts`
#### Description
This statement creates a table named `chunk_metadata_counts` if it doesn't already exist. The table has the following columns:

| Column | Type | Description |
|:-----|:-----|:------------|
| id | UUID | Primary key with a default value generated by `gen_random_uuid()` |
| dataset_id | UUID | Foreign key referencing the `datasets` table, indicating the dataset to which the chunk belongs |
| total_rows | BIGINT | Stores the total number of rows in the chunk |

#### Internal Logic
- `CREATE TABLE IF NOT EXISTS` ensures that the statement doesn't fail if the table already exists.
- `FOREIGN KEY (dataset_id) REFERENCES datasets(id)` establishes a foreign key constraint, ensuring data integrity between the `chunk_metadata_counts` and `datasets` tables.

### `CREATE OR REPLACE FUNCTION update_chunk_metadata_count()`
#### Description
This statement creates or replaces a function named `update_chunk_metadata_count`. This function is designed to be used as a trigger, updating the `chunk_metadata_counts` table whenever rows are inserted into or deleted from another table (likely related to chunk metadata).

#### Outputs
- Returns `NULL`.

#### Internal Logic
- It uses `CREATE OR REPLACE FUNCTION` to either create a new function or replace an existing one with the same name.
- The function is defined as a trigger using `RETURNS TRIGGER`.
- Inside the function:
    - `IF TG_OP = 'INSERT' THEN`: This block executes when a new row is inserted.
        - It inserts a new row into `card_metadata_counts` with the `dataset_id` from the inserted row and a `total_rows` value of 1.
        - If a row with the same `dataset_id` already exists, it increments the `card_metadata_count` by 1.
    - `ELSIF TG_OP = 'DELETE' THEN`: This block executes when a row is deleted.
        - It updates the `card_metadata_counts` table, decrementing the `total_rows` for the corresponding `dataset_id`.
- `RETURN NULL` indicates that the trigger function doesn't return any specific value.

## Side Effects
- Drops triggers, functions, and tables related to dataset and organization usage counts.
- Creates a table and trigger for tracking chunk metadata counts.

## Error Handling
- Uses `IF EXISTS` clauses in `DROP` statements to prevent errors if the objects don't exist.
- Implements `ON CONFLICT DO UPDATE` in the `INSERT` statement within the trigger function to handle cases where a row with the same `dataset_id` already exists.
