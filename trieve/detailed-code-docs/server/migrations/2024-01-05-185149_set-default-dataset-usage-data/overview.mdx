---
title: "Overview"
---

## High-level description
This directory contains SQL migration scripts for setting default dataset usage data in a database. It includes two files: `up.sql` for applying the changes and `down.sql` for reverting them. The migration creates a function and a trigger to automatically insert a default record into the `dataset_usage_counts` table whenever a new dataset is added to the `datasets` table.

## What does it do?
The migration accomplishes the following:

1. Creates a function called `set_default_dataset_usage_data` that inserts a new record into the `dataset_usage_counts` table for a newly inserted dataset.
2. Sets up a trigger named `set_default_dataset_usage_data_trigger` on the `datasets` table that automatically executes the function after each new dataset insertion.
3. Provides a way to revert these changes by dropping the created function and trigger.

This ensures that every new dataset automatically gets a corresponding entry in the usage counts table, even if the initial usage count is zero. This can be useful for tracking and reporting purposes, ensuring that all datasets are accounted for in usage statistics from the moment they are created.

## Key Files

### up.sql
This file contains the SQL commands to apply the migration:

```sql
CREATE OR REPLACE FUNCTION set_default_dataset_usage_data()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO dataset_usage_counts (dataset_id)
  VALUES (NEW.id)
  ON CONFLICT (dataset_id) DO NOTHING;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER set_default_dataset_usage_data_trigger
AFTER INSERT ON datasets
FOR EACH ROW
EXECUTE FUNCTION set_default_dataset_usage_data();
```

The function `set_default_dataset_usage_data` inserts a new record into the `dataset_usage_counts` table using the ID of the newly inserted dataset. It uses `ON CONFLICT DO NOTHING` to handle potential duplicate entries.

The trigger `set_default_dataset_usage_data_trigger` is set to execute this function automatically after each new row insertion in the `datasets` table.

### down.sql
This file contains the SQL commands to revert the migration:

```sql
DROP TRIGGER IF EXISTS set_default_dataset_usage_data_trigger ON datasets;
DROP FUNCTION IF EXISTS set_default_dataset_usage_data;
```

It drops the trigger and function created by the `up.sql` script. The `IF EXISTS` clauses ensure that the statements don't fail if the objects don't exist, making it safe to run even if the migration was not fully applied.

## Dependencies
This migration relies on the existence of two tables in the database:
1. `datasets`: The table where new datasets are inserted.
2. `dataset_usage_counts`: The table where usage counts for datasets are stored.

It also assumes that the database system supports PL/pgSQL, as the function is written in this language.

## Configuration
No specific configuration is required for this migration. However, it's important to note that:

1. The migration assumes that the `datasets` table has an `id` column that serves as the primary key.
2. The `dataset_usage_counts` table is expected to have a `dataset_id` column that can be used to uniquely identify records.

When applying this migration, database administrators should ensure that these assumptions hold true in their database schema. If the table structures differ, the migration scripts may need to be adjusted accordingly.