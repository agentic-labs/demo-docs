---
title: "Overview"
---

## High-level description
This directory contains SQL migration scripts for setting default dataset usage data in a database. It includes two files: `up.sql` for applying the changes and `down.sql` for reverting them. The migration creates a function and a trigger to automatically insert a new record into the `dataset_usage_counts` table whenever a new dataset is added to the `datasets` table.

## What does it do?
The migration accomplishes the following:

1. Creates a function called `set_default_dataset_usage_data` that inserts a new row into the `dataset_usage_counts` table with the `dataset_id` of a newly inserted dataset.
2. Sets up a trigger named `set_default_dataset_usage_data_trigger` that automatically executes the above function after a new row is inserted into the `datasets` table.
3. Provides a way to revert these changes by dropping the created function and trigger.

This automation ensures that every time a new dataset is added to the system, a corresponding usage count record is initialized, allowing for easier tracking and management of dataset usage.

## Key Files

### up.sql
This file contains the SQL commands to apply the migration:

1. It defines the `set_default_dataset_usage_data` function:

```sql
CREATE OR REPLACE FUNCTION set_default_dataset_usage_data()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO dataset_usage_counts (dataset_id)
    VALUES (NEW.id)
    ON CONFLICT (dataset_id) DO NOTHING;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

2. It creates the `set_default_dataset_usage_data_trigger`:

```sql
CREATE TRIGGER set_default_dataset_usage_data_trigger
AFTER INSERT ON datasets
FOR EACH ROW
EXECUTE FUNCTION set_default_dataset_usage_data();
```

### down.sql
This file contains the SQL commands to revert the migration:

```sql
DROP TRIGGER IF EXISTS set_default_dataset_usage_data_trigger ON datasets;
DROP FUNCTION IF EXISTS set_default_dataset_usage_data;
```

These commands remove the trigger and function created by the `up.sql` script.

## Configuration
This migration does not require any specific configuration files or environment variables. However, it assumes the existence of two tables in the database:

1. `datasets`: The table where new datasets are inserted.
2. `dataset_usage_counts`: The table where usage counts for datasets are stored.

The migration also assumes that the `dataset_usage_counts` table has a `dataset_id` column that can be used as a unique identifier.

In conclusion, this migration sets up an automated system to initialize usage count records for new datasets, improving data consistency and simplifying dataset usage tracking in the application.