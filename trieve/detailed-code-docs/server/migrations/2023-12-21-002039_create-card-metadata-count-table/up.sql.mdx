---
title: "up.sql"
---

## High-level description
This SQL script creates a new table `card_metadata_counts` to store metadata count information for datasets. It also defines a trigger function and a trigger to automatically update the count when card metadata is inserted or deleted.

## Symbols

### Table: `card_metadata_counts`
#### Description
This table stores the total count of card metadata rows for each dataset.

#### Columns
| Name | Type | Description |
|:-----|:-----|:------------|
| id | UUID | Primary key, automatically generated |
| dataset_id | UUID | Foreign key referencing the datasets table |
| total_rows | BIGINT | The total number of card metadata rows for the dataset |

### Function: `update_card_metadata_count()`
#### Description
This is a trigger function that updates the `card_metadata_counts` table when card metadata is inserted or deleted.

#### Inputs
This function doesn't take explicit inputs but operates on the `NEW` and `OLD` row data provided by the trigger context.

#### Outputs
This function doesn't return a value (returns NULL).

#### Internal Logic
1. For INSERT operations:
   - Inserts a new row into `card_metadata_counts` with the dataset_id and a count of 1
   - If a row already exists for the dataset_id, it increments the existing count
2. For DELETE operations:
   - Decrements the count for the corresponding dataset_id

### Trigger: `card_metadata_count_trigger`
#### Description
This trigger is attached to the `card_metadata` table and fires after INSERT or DELETE operations.

#### Internal Logic
- Executes the `update_card_metadata_count()` function for each affected row

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| datasets table | Referenced by the foreign key in `card_metadata_counts` |
| card_metadata table | The table on which the trigger is created |

## Notes
1. The script uses PostgreSQL-specific functions like `gen_random_uuid()` for generating UUIDs.
2. The trigger function uses the `plpgsql` language.
3. The script assumes the existence of a `datasets` table and a `card_metadata` table.
4. The `ON CONFLICT` clause in the INSERT operation of the trigger function suggests that `dataset_id` should be unique in the `card_metadata_counts` table, but this constraint is not explicitly defined in the table creation.