---
title: "Overview"
---

## High-level description
This directory contains SQL migration scripts for creating and managing a `card_metadata_counts` table in a database. The migration introduces a new table to store counts of card metadata entries associated with each dataset, along with a trigger function to automatically update these counts when the `card_metadata` table is modified.

## What does it do?
The migration scripts in this directory set up a system to maintain an up-to-date count of card metadata entries for each dataset. Here's a breakdown of the workflow:

1. A new table called `card_metadata_counts` is created to store the total number of card metadata entries for each dataset.
2. A trigger function named `update_card_metadata_count` is defined. This function automatically updates the count in the `card_metadata_counts` table whenever a row is inserted or deleted in the `card_metadata` table.
3. A trigger named `card_metadata_count_trigger` is set up on the `card_metadata` table. This trigger calls the `update_card_metadata_count` function after each INSERT or DELETE operation.

This setup ensures that the `card_metadata_counts` table always reflects the current number of card metadata entries for each dataset without requiring manual updates.

## Key Files

### up.sql
This file contains the SQL commands to set up the new table, function, and trigger:

1. Creates the `card_metadata_counts` table with columns:
   - `id`: A UUID primary key
   - `dataset_id`: A UUID foreign key referencing the `datasets` table
   - `total_rows`: A BIGINT to store the count of card metadata entries

2. Defines the `update_card_metadata_count` function:
   - Handles both INSERT and DELETE operations on the `card_metadata` table
   - For INSERTs: It either creates a new row in `card_metadata_counts` or increments an existing count
   - For DELETEs: It decrements the count in `card_metadata_counts`

3. Creates the `card_metadata_count_trigger` on the `card_metadata` table:
   - Executes after each INSERT or DELETE operation
   - Calls the `update_card_metadata_count` function

Here's a snippet of the trigger function:

```sql
CREATE OR REPLACE FUNCTION update_card_metadata_count() RETURNS TRIGGER AS $$
BEGIN
    IF (TG_OP = 'INSERT') THEN
        INSERT INTO card_metadata_counts (dataset_id, total_rows)
        VALUES (NEW.dataset_id, 1)
        ON CONFLICT (dataset_id) DO UPDATE
        SET total_rows = card_metadata_counts.total_rows + 1;
    ELSIF (TG_OP = 'DELETE') THEN
        UPDATE card_metadata_counts
        SET total_rows = total_rows - 1
        WHERE dataset_id = OLD.dataset_id;
    END IF;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql;
```

### down.sql
This file contains the SQL commands to revert the changes made by the up.sql script:

1. Drops the `card_metadata_count_trigger` from the `card_metadata` table
2. Drops the `update_card_metadata_count` function
3. Drops the `card_metadata_counts` table

Here's the content of down.sql:

```sql
DROP TRIGGER card_metadata_count_trigger ON card_metadata;
DROP FUNCTION update_card_metadata_count();
DROP TABLE card_metadata_counts;
```

## Dependencies
This migration relies on the existence of two tables in the database:

1. `card_metadata`: The main table storing card metadata entries
2. `datasets`: A table referenced by the foreign key in `card_metadata_counts`

The migration uses PostgreSQL-specific features, including:

- UUID data type
- Trigger functions
- ON CONFLICT clause for upsert operations

## Configuration
This migration doesn't require any specific configuration. However, it's important to note that:

1. The migration assumes the existence of a `card_metadata` table and a `datasets` table.
2. The `card_metadata` table should have a `dataset_id` column of UUID type.
3. The database should support UUID, trigger functions, and the specific PostgreSQL syntax used in the scripts.

When applying this migration, ensure that the database user has sufficient privileges to create tables, functions, and triggers.