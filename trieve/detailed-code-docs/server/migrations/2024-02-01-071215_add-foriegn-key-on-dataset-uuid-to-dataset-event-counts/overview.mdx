---
title: "Overview"
---

## High-level description
This directory contains SQL migration scripts for modifying the `dataset_event_counts` table in a database. The migration adds a foreign key constraint and a unique constraint on the `dataset_uuid` column, as well as making it non-nullable. The purpose is to ensure data integrity and establish a relationship between the `dataset_event_counts` table and a `datasets` table.

## What does it do?
The migration scripts in this directory perform the following actions:

1. In the "up" direction (applying the migration):
   - Adds a foreign key constraint on the `dataset_uuid` column in the `dataset_event_counts` table, referencing the `id` column in the `datasets` table.
   - Sets up cascading updates and deletes, so changes in the `datasets` table are reflected in `dataset_event_counts`.
   - Adds a unique constraint on the `dataset_uuid` column to ensure each dataset UUID is unique in the `dataset_event_counts` table.
   - Makes the `dataset_uuid` column non-nullable, ensuring every row has a valid dataset UUID.

2. In the "down" direction (reverting the migration):
   - Removes the foreign key constraint `dataset_event_counts_dataset_uuid_fkey`.
   - Removes the unique constraint `dataset_event_counts_dataset_uuid_unique`.

These changes improve data consistency and establish a clear relationship between datasets and their event counts.

## Key Files

1. `up.sql`: This file contains the SQL commands to apply the migration. It adds the foreign key constraint, unique constraint, and modifies the `dataset_uuid` column to be non-nullable.

   ```sql
   ALTER TABLE dataset_event_counts
   ADD CONSTRAINT dataset_event_counts_dataset_uuid_fkey
   FOREIGN KEY (dataset_uuid) REFERENCES datasets(id)
   ON UPDATE CASCADE
   ON DELETE CASCADE,
   ADD CONSTRAINT dataset_event_counts_dataset_uuid_unique
   UNIQUE (dataset_uuid),
   ALTER COLUMN dataset_uuid SET NOT NULL;
   ```

2. `down.sql`: This file contains the SQL commands to revert the migration. It removes the constraints added by the `up.sql` script.

   ```sql
   ALTER TABLE dataset_event_counts
   DROP CONSTRAINT dataset_event_counts_dataset_uuid_fkey,
   DROP CONSTRAINT dataset_event_counts_dataset_uuid_unique;
   ```

These files work together to provide a reversible database migration, allowing for easy application and rollback of the changes to the database schema.

## Configuration
The migration is identified by its timestamp: `2024-02-01-071215`. This timestamp is likely used by a migration tool to track which migrations have been applied and in what order.

No additional configuration files or environment variables are required for this specific migration. However, the database connection details and migration tool configuration would typically be managed at a higher level in the project structure.