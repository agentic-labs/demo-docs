---
title: "up.sql"
---

## High-level description
This SQL script defines a database migration that creates a new table named `user_api_key` to store API keys associated with users. It also removes the `api_key_hash` column from the `users` table.

## Code Structure
This SQL script performs two main actions: creating the `user_api_key` table and altering the `users` table. The `user_api_key` table is defined with columns for storing the API key ID, user ID, API key hash, name, creation timestamp, update timestamp, and a foreign key constraint referencing the `users` table. The `ALTER TABLE` statement removes the `api_key_hash` column from the `users` table.

## Symbols

### `CREATE TABLE user_api_key`
#### Description
This statement creates a new table named `user_api_key` to store API keys for users.

#### Internal Logic
The table definition includes the following columns:

*   `id`: A UUID serving as the primary key for the table, automatically generated using `gen_random_uuid()`.
*   `user_id`: A UUID representing the user associated with the API key, referencing the `id` column of the `users` table. This column is marked as `NOT NULL`, enforcing that each API key must be associated with a user.
*   `api_key_hash`: A text field storing the hashed value of the API key. This column is marked as both `NOT NULL` and `UNIQUE`, ensuring that each API key hash is unique and non-empty.
*   `name`: A text field for storing a user-defined name for the API key. It defaults to 'default'.
*   `created_at`: A timestamp field recording the creation time of the API key, defaulting to the current timestamp.
*   `updated_at`: A timestamp field recording the last update time of the API key, defaulting to the current timestamp.
*   `FOREIGN KEY (user_id)`: This constraint establishes a foreign key relationship between the `user_id` column of this table and the `id` column of the `users` table. The `ON DELETE CASCADE` clause ensures that deleting a user will automatically delete all associated API keys.

### `ALTER TABLE users DROP COLUMN api_key_hash`
#### Description
This statement modifies the existing `users` table by removing the `api_key_hash` column.

#### Internal Logic
This operation removes the column that previously stored the API key hash directly within the `users` table. This change, in conjunction with the creation of the `user_api_key` table, suggests a shift towards a more scalable and manageable approach for handling API keys by separating them into a dedicated table.
