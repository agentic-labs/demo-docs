---
title: "Overview"
---

## High-level description
This directory contains SQL migration scripts for modifying the `dataset_tags` table in a database. The migration introduces a unique constraint on the combination of `dataset_id` and `tag` columns, while removing previously existing constraints. The directory includes both `up.sql` and `down.sql` scripts to apply and revert the changes, respectively.

## What does it do?
These migration scripts modify the structure of the `dataset_tags` table to enforce data integrity rules. The main changes are:

1. In the "up" direction (applying the migration):
   - It removes existing constraints on the `tag` column and the combination of `id` and `dataset_id`.
   - It adds a new constraint ensuring that each combination of `dataset_id` and `tag` is unique in the table.

2. In the "down" direction (reverting the migration):
   - It removes the newly added constraint on `dataset_id` and `tag`.
   - It reintroduces the previously existing constraints on `id` and `dataset_id` combination, and on the `tag` column.

These changes affect how data can be inserted or updated in the `dataset_tags` table. After applying the "up" migration, the database will not allow duplicate combinations of `dataset_id` and `tag`, ensuring that each dataset has unique tags. If attempting to revert the changes, the "down" migration will restore the previous constraints, allowing duplicate tags across different datasets but ensuring uniqueness of the `id` and `dataset_id` combination, as well as the `tag` itself.

## Key Files

### up.sql
This file contains the SQL commands to apply the new constraint:

```sql
ALTER TABLE dataset_tags DROP CONSTRAINT IF EXISTS dataset_tags_tag;
ALTER TABLE dataset_tags DROP CONSTRAINT IF EXISTS dataset_tags_id_dataset_id;
ALTER TABLE dataset_tags ADD CONSTRAINT dataset_tags_dataset_id_tag_key UNIQUE (dataset_id, tag);
```

It first drops any existing constraints that might conflict with the new one, then adds the new unique constraint on `dataset_id` and `tag`.

### down.sql
This file contains the SQL commands to revert the changes made by `up.sql`:

```sql
ALTER TABLE dataset_tags DROP CONSTRAINT IF EXISTS dataset_tags_dataset_id_tag_key;
ALTER TABLE dataset_tags ADD CONSTRAINT dataset_tags_id_dataset_id UNIQUE(id, dataset_id);
ALTER TABLE dataset_tags ADD CONSTRAINT dataset_tags_tag UNIQUE(tag);
```

It drops the constraint added by the "up" migration and reintroduces the previously existing constraints.

## Configuration
The migration scripts do not rely on any external configuration files or environment variables. They are designed to be run as part of a database migration process, typically managed by an ORM (Object-Relational Mapping) tool or a migration framework.

The naming convention of the directory (2024-06-08-003433_unique-dataset-tag-constraint) suggests that this migration was created on June 8, 2024, at 00:34:33, and its purpose is to add a unique constraint to dataset tags.

When applying these migrations, it's important to ensure that:
1. The `dataset_tags` table exists in the database.
2. The columns `id`, `dataset_id`, and `tag` exist in the `dataset_tags` table.
3. There are no existing data conflicts that would violate the new unique constraint when applying the "up" migration.
4. The database user executing these scripts has the necessary permissions to alter table constraints.

These migration scripts provide a way to version control database schema changes, allowing for easy application and rollback of structural modifications to the `dataset_tags` table.