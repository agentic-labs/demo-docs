---
title: "Overview"
---

## High-level description

This directory contains SQL migration scripts for renaming and restructuring a database table. The migration transforms a specific `file_upload_completed_notifications` table into a more generic `events` table, allowing for different types of events with associated data. The directory includes both `up.sql` and `down.sql` scripts to apply and revert the changes, respectively.

## What does it do?

The migration scripts in this directory perform the following actions:

1. Rename the `file_upload_completed_notifications` table to `events`.
2. Remove specific columns related to file upload notifications (`user_read` and `group_uuid`).
3. Add new columns to support a more generic event structure (`event_type` and `event_data`).

These changes allow the database to store various types of events instead of being limited to file upload notifications. The new structure can accommodate different event types and store associated data in a flexible JSON format.

The `down.sql` script provides a way to revert these changes, restoring the original table structure if needed.

## Key Files

1. `up.sql`: This file contains the SQL commands to apply the migration, transforming the `file_upload_completed_notifications` table into the `events` table.

   ```sql
   ALTER TABLE file_upload_completed_notifications RENAME TO events;
   ALTER TABLE events DROP COLUMN user_read;
   ALTER TABLE events DROP COLUMN group_uuid;
   ALTER TABLE events ADD COLUMN event_type VARCHAR(255);
   ALTER TABLE events ADD COLUMN event_data JSONB;
   ```

2. `down.sql`: This file contains the SQL commands to revert the migration, restoring the original table structure.

   ```sql
   ALTER TABLE events DROP COLUMN event_type;
   ALTER TABLE events DROP COLUMN event_data;
   ALTER TABLE events ADD COLUMN user_read BOOLEAN NOT NULL DEFAULT false;
   ALTER TABLE events ADD COLUMN collection_id UUID;
   ALTER TABLE events RENAME TO file_upload_completed_notifications;
   ```

## Configuration

The migration scripts do not rely on any external configuration files or environment variables. However, they assume the existence of a `file_upload_completed_notifications` table in the database before applying the `up.sql` migration.

## Side Effects

Applying these migrations will have the following side effects:

1. The `file_upload_completed_notifications` table will be renamed to `events`.
2. Existing data in the `user_read` and `group_uuid` columns will be permanently deleted.
3. The table structure will change, potentially affecting any queries or application code that relies on the old structure.
4. New columns `event_type` and `event_data` will be added, allowing for more flexible event storage.

When reverting the migration using `down.sql`:

1. The `events` table will be renamed back to `file_upload_completed_notifications`.
2. Data in the `event_type` and `event_data` columns will be lost.
3. New columns `user_read` and `collection_id` will be added, potentially affecting existing queries or application logic.

## Performance Considerations

1. Renaming tables is generally a quick operation in most databases.
2. Dropping columns is usually fast but may take longer if there are many rows or indexes on those columns.
3. Adding new columns can be slower, especially for large tables, as the database needs to update all existing rows.
4. The JSONB data type for `event_data` allows for efficient storage and querying of JSON data but may have performance implications for very large JSON objects.
5. Adding columns with a NOT NULL constraint (like `user_read` in the `down.sql` script) might require a full table scan to set the default value for existing rows.

## TODOs

1. Consider adding appropriate indexes on the new `event_type` and `event_data` columns to optimize query performance, depending on how these columns will be used in the application.
2. Ensure that any application code or queries that relied on the old table structure are updated to work with the new `events` table.
3. Review and update any foreign key constraints or references to the renamed table in other parts of the database schema.
4. Test the migration thoroughly in a staging environment before applying it to the production database to ensure data integrity and application compatibility.
5. Update any data access layer or ORM configurations in the application code to reflect the new table structure.
6. Consider creating a data migration script to populate the new `event_type` and `event_data` columns with appropriate values based on the existing data, if applicable.
7. Review and update any database backup and restore procedures to account for the new table structure.
8. Document the changes in the database schema for future reference and to inform other developers working on the project.