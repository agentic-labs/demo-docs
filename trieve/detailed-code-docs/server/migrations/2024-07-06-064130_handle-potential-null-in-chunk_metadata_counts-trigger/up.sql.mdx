---
title: "up.sql"
---

## High-level description
This SQL script defines a function `update_chunk_metadata_counts` and two triggers, `increase_chunk_metadata_counts_trigger` and `delete_chunk_metadata_counts_trigger`, to maintain the accuracy of chunk counts in the `dataset_usage_counts` table when chunk metadata is inserted or deleted. It handles potential null values in the `dataset_id` column of the `modified` table.

## Code Structure
The code first drops existing triggers and a function with the same names if they exist. Then it defines a new function `update_chunk_metadata_counts` which is used by both triggers. Finally, it creates two triggers `increase_chunk_metadata_counts_trigger` and `delete_chunk_metadata_counts_trigger` that call the function after insert and delete operations on the `chunk_metadata` table respectively.

### Symbols
### `update_chunk_metadata_counts`
#### Description
This function updates the `chunk_count` in the `dataset_usage_counts` table based on insert or delete operations on the `chunk_metadata` table. It handles cases where the `dataset_id` in the `modified` table might be null.

#### Inputs
This function takes no direct inputs. It accesses data from the `modified` and `dataset_usage_counts` tables.

#### Outputs
This function does not return any values. It modifies the `dataset_usage_counts` table.

#### Internal Logic
1. **Retrieve `dataset_id`:** Selects the `dataset_id` from the `modified` table where it is not null. If no such `dataset_id` is found, the function exits.
2. **Calculate `new_count`:** Counts the number of rows in the `modified` table.
3. **Handle INSERT operation:** If the triggering event is an INSERT, it inserts a new row into `dataset_usage_counts` with the `dataset_id` and `new_count` or updates the existing row by adding the `new_count` to the current `chunk_count`.
4. **Handle DELETE operation:** If the triggering event is a DELETE, it updates the `dataset_usage_counts` table by subtracting the `new_count` from the `chunk_count` for the corresponding `dataset_id`.

### `increase_chunk_metadata_counts_trigger`
#### Description
This trigger calls the `update_chunk_metadata_counts` function after each INSERT operation on the `chunk_metadata` table.

#### Inputs
This trigger implicitly uses the data from the `NEW TABLE` referenced as `modified`.

#### Outputs
This trigger does not return any values. It indirectly modifies the `dataset_usage_counts` table through the function call.

### `delete_chunk_metadata_counts_trigger`
#### Description
This trigger calls the `update_chunk_metadata_counts` function after each DELETE operation on the `chunk_metadata` table.

#### Inputs
This trigger implicitly uses the data from the `OLD TABLE` referenced as `modified`.

#### Outputs
This trigger does not return any values. It indirectly modifies the `dataset_usage_counts` table through the function call.
