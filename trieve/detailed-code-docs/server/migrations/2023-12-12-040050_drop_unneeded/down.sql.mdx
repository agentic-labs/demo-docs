---
title: "down.sql"
---

## High-level description
This SQL script reverts the database changes made by the corresponding `up.sql` migration file. It recreates the `invitations` and `password_resets` tables and adds a full-text search index to the `card_metadata` table.

## Code Structure
The script first defines the structure for the `invitations` and `password_resets` tables. Then, it adds a `card_metadata_tsvector` column to the `card_metadata` table and defines a trigger function `update_tsvector()` to keep this column updated with a tsvector representation of the `content` column. Finally, it creates a trigger `update_tsvector_trigger` to execute the `update_tsvector()` function before inserting new rows into the `card_metadata` table.

## Symbols

### `invitations` table
#### Description
This table stores information about invitations sent to users.

#### Inputs
N/A - This is a table definition, not a function.

#### Outputs
N/A - This is a table definition, not a function.

#### Internal Logic
The table has the following columns:
- `id`: A unique identifier for the invitation.
- `email`: The email address the invitation was sent to.
- `expires_at`: The date and time when the invitation expires.
- `created_at`: The date and time when the invitation was created.
- `updated_at`: The date and time when the invitation was last updated.

### `password_resets` table
#### Description
This table stores information about password reset requests.

#### Inputs
N/A - This is a table definition, not a function.

#### Outputs
N/A - This is a table definition, not a function.

#### Internal Logic
The table has the following columns:
- `id`: A unique identifier for the password reset request.
- `email`: The email address associated with the password reset request.
- `expires_at`: The date and time when the password reset request expires.
- `created_at`: The date and time when the password reset request was created.
- `updated_at`: The date and time when the password reset request was last updated.

### `card_metadata_tsvector` column
#### Description
This column stores a tsvector representation of the `content` column in the `card_metadata` table, used for full-text search.

#### Inputs
N/A - This is a column definition, not a function.

#### Outputs
N/A - This is a column definition, not a function.

### `update_tsvector()` function
#### Description
This function updates the `card_metadata_tsvector` column with a tsvector representation of the `content` column.

#### Inputs
N/A - This function is triggered by changes in the `card_metadata` table.

#### Outputs
- Returns the updated row (`NEW`) with the updated `card_metadata_tsvector` value.

#### Internal Logic
The function uses the `to_tsvector()` function to generate a tsvector representation of the `content` column and assigns it to the `card_metadata_tsvector` column of the `NEW` row (representing the row being inserted or updated).

### `update_tsvector_trigger` trigger
#### Description
This trigger executes the `update_tsvector()` function before inserting new rows into the `card_metadata` table.

#### Inputs
N/A - This trigger is automatically invoked before inserts on the `card_metadata` table.

#### Outputs
N/A - This trigger ensures the `card_metadata_tsvector` column is updated before the insert operation.

#### Internal Logic
The trigger is set to execute the `update_tsvector()` function for each row being inserted into the `card_metadata` table. This ensures that the `card_metadata_tsvector` column is populated with the correct tsvector representation of the `content` column for every new row.
