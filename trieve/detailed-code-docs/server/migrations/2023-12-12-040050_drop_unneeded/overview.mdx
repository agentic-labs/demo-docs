---
title: "Overview"
---

## High-level description
This directory contains SQL migration scripts for a database schema update. The migration is identified by the timestamp 2023-12-12-040050 and is named "drop_unneeded". It consists of two files: `up.sql` and `down.sql`, which handle the forward migration and its reversal, respectively.

## What does it do?
The migration performs the following actions:

1. Forward migration (`up.sql`):
   - Removes a column named `card_metadata_tsvector` from the `card_metadata` table.
   - Drops two tables: `invitations` and `password_resets`.
   - Removes a trigger named `update_tsvector_trigger` from the `card_metadata` table.
   - Deletes a function called `update_tsvector()`.

2. Reverse migration (`down.sql`):
   - Recreates the `invitations` and `password_resets` tables with their original structure.
   - Adds the `card_metadata_tsvector` column back to the `card_metadata` table.
   - Recreates the `update_tsvector()` function to maintain the tsvector representation of the `content` column.
   - Reestablishes the `update_tsvector_trigger` on the `card_metadata` table.

This migration essentially removes features related to invitations, password resets, and full-text search capabilities on the `card_metadata` table. The reverse migration restores these features if needed.

## Key Files

### up.sql
This file contains the SQL statements for the forward migration. It removes database objects that are no longer needed in the application. The file uses `IF EXISTS` clauses to ensure that the operations don't fail if the objects have already been removed.

Key operations:
```sql
ALTER TABLE card_metadata DROP COLUMN IF EXISTS card_metadata_tsvector;
DROP TABLE IF EXISTS invitations;
DROP TABLE IF EXISTS password_resets;
DROP TRIGGER IF EXISTS update_tsvector_trigger ON card_metadata;
DROP FUNCTION IF EXISTS update_tsvector();
```

### down.sql
This file contains the SQL statements to reverse the changes made by the forward migration. It recreates the dropped tables and reestablishes the full-text search functionality on the `card_metadata` table.

Key operations:
1. Recreate `invitations` and `password_resets` tables:
```sql
CREATE TABLE invitations (
    id UUID PRIMARY KEY,
    email TEXT NOT NULL,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL
);

CREATE TABLE password_resets (
    id UUID PRIMARY KEY,
    email TEXT NOT NULL,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL
);
```

2. Add `card_metadata_tsvector` column and create function and trigger for full-text search:
```sql
ALTER TABLE card_metadata ADD COLUMN card_metadata_tsvector tsvector;

CREATE OR REPLACE FUNCTION update_tsvector() RETURNS trigger AS $$
BEGIN
  NEW.card_metadata_tsvector := to_tsvector('english', NEW.content);
  RETURN NEW;
END
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_tsvector_trigger
BEFORE INSERT ON card_metadata
FOR EACH ROW
EXECUTE FUNCTION update_tsvector();
```

## Configuration
This migration does not use any external configuration files or environment variables. The changes are hardcoded in the SQL scripts.

The migration relies on the existing database schema and assumes the presence of a `card_metadata` table with a `content` column. The timestamp in the directory name (2023-12-12-040050) is likely used by a migration management system to track the order and execution of migrations.