---
title: "Overview"
---

## High-level description
This directory contains SQL migration scripts for adding a `dataset_id` column to the `file_upload_completed_notifications`, `topics`, and `messages` tables, as well as establishing foreign key relationships between these tables and the `datasets` table. The migration is dated 2023-12-11 and includes both "up" and "down" scripts to apply and revert the changes, respectively.

## What does it do?
The migration scripts in this directory modify the database schema to introduce a new relationship between datasets and various entities (notifications, topics, and messages) in the system. Here's what the migration accomplishes:

1. It adds a new column called `dataset_id` to three tables: `file_upload_completed_notifications`, `topics`, and `messages`.
2. This new column is of type UUID and is set as NOT NULL, meaning every record in these tables must have a dataset associated with it.
3. It creates foreign key constraints that link the `dataset_id` in each of these tables to the `id` column in the `datasets` table.
4. The "down" script provides a way to undo these changes by removing the foreign key constraints and dropping the `dataset_id` columns.

This change allows the system to associate notifications, topics, and messages with specific datasets, enabling more granular organization and potentially supporting features like dataset-specific notifications or filtering messages by dataset.

## Key Files

1. `up.sql`:
   - This file contains the SQL commands to apply the migration.
   - It adds the `dataset_id` column to the specified tables and creates the foreign key constraints.
   - Example of a key operation:
     ```sql
     ALTER TABLE file_upload_completed_notifications
     ADD COLUMN dataset_id UUID NOT NULL,
     ADD CONSTRAINT notifications_dataset_id_fkey
     FOREIGN KEY (dataset_id) REFERENCES datasets(id);
     ```

2. `down.sql`:
   - This file contains the SQL commands to revert the migration.
   - It removes the foreign key constraints and drops the `dataset_id` columns from the specified tables.
   - Example of a key operation:
     ```sql
     ALTER TABLE file_upload_completed_notifications
     DROP CONSTRAINT notifications_dataset_id_fkey,
     DROP COLUMN dataset_id;
     ```

## Dependencies
The migration scripts depend on the existence of the following database tables:
- `file_upload_completed_notifications`
- `topics`
- `messages`
- `datasets`

The scripts assume these tables are present in the database schema. If any of these tables are missing, the migration will fail to execute properly.

## Configuration
There are no specific configuration files or environment variables associated with this migration. However, it's important to note:

1. The migration is timestamped (2023-12-11-205317), which likely determines the order of execution in relation to other migrations.
2. The use of UUID for `dataset_id` suggests that the system uses UUIDs for primary keys in the `datasets` table.

## Side Effects and Performance Considerations
1. Data Integrity: The new foreign key constraints will enforce referential integrity between the modified tables and the `datasets` table. This means you cannot insert or update records in the modified tables with a `dataset_id` that doesn't exist in the `datasets` table.

2. Existing Data: If the tables already contain data, adding a NOT NULL column (`dataset_id`) may require careful handling. The migration script doesn't provide a default value or a way to populate this column for existing records, which could cause issues if not addressed separately.

3. Performance Impact:
   - The new foreign key constraints may slightly impact the performance of insert and update operations on the modified tables due to the additional integrity checks.
   - Queries joining these tables with the `datasets` table may see improved performance due to the explicit relationship.

4. Data Loss Risk: The "down" migration (`down.sql`) will remove the `dataset_id` column from the specified tables. If this migration is applied after data has been added to these columns, that data will be permanently lost.

5. Application Code: Any application code interacting with these tables will need to be updated to handle the new `dataset_id` column, including insert and update operations, as well as any queries that might benefit from this new relationship.

In conclusion, this migration represents a significant change to the data model, associating datasets with notifications, topics, and messages. It provides a more structured approach to organizing these entities within the system but requires careful consideration of existing data and potential impacts on application code.