---
title: "Overview"
---

## High-level description
This directory contains SQL migration scripts for fixing and maintaining the integrity of the `chunk_count` column in the `organization_usage_counts` table. The migration is designed to address inconsistencies in the data, implement constraints, and set up a trigger system for automatic updates.

## What does it do?
The migration performs several key tasks:

1. It updates any NULL values in the `chunk_count` column of the `organization_usage_counts` table to 0.
2. It alters the `chunk_count` column to be NOT NULL, ensuring all future entries have a value.
3. It recalculates the `chunk_count` for each organization based on the sum of chunk counts from related datasets.
4. It creates a trigger function and a corresponding trigger that automatically updates the `chunk_count` in the `organization_usage_counts` table whenever there are changes in the `dataset_usage_counts` table.

These changes ensure that the `chunk_count` in the `organization_usage_counts` table accurately reflects the total number of chunks across all datasets belonging to each organization, and that this count is automatically maintained as datasets are modified.

## Key Files

### up.sql
This file contains the SQL statements to implement the migration. It performs the following operations:
1. Updates NULL `chunk_count` values to 0 in `organization_usage_counts`.
2. Alters the `chunk_count` column to be NOT NULL.
3. Recalculates `chunk_count` based on the sum of related counts from `dataset_usage_counts`.
4. Creates a trigger function `update_organization_chunk_count()` to maintain data consistency.
5. Sets up a trigger `update_organization_chunk_count_trigger` on the `dataset_usage_counts` table.

Here's a snippet of the trigger function creation:

```sql
CREATE OR REPLACE FUNCTION update_organization_chunk_count()
RETURNS TRIGGER AS $$
BEGIN
    UPDATE organization_usage_counts o
    SET chunk_count = (
        SELECT COALESCE(SUM(duc.chunk_count), 0)
        FROM dataset_usage_counts duc
        JOIN datasets d ON duc.dataset_id = d.id
        WHERE d.organization_id = o.organization_id
    )
    WHERE o.organization_id = (
        SELECT organization_id
        FROM datasets
        WHERE id = NEW.dataset_id OR id = OLD.dataset_id
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### down.sql
This file contains the SQL statements to revert the changes made by the migration. It performs the following operations:
1. Removes the NOT NULL constraint from the `chunk_count` column.
2. Drops the `update_organization_chunk_count` function.

Here's a key part of the down migration:

```sql
ALTER TABLE organization_usage_counts ALTER COLUMN chunk_count DROP NOT NULL;
DROP FUNCTION IF EXISTS update_organization_chunk_count;
```

## Configuration
This migration does not rely on any external configuration files or environment variables. All necessary changes are defined within the SQL scripts themselves.

The migration is identified by its timestamp: `2024-07-02-205044`, which likely represents the date and time when the migration was created (July 2, 2024, at 20:50:44).

## Dependencies
This migration depends on the existence of the following database tables:
- `organization_usage_counts`
- `dataset_usage_counts`
- `datasets`

It assumes that these tables have the necessary columns and relationships to perform the required operations.

The migration uses PostgreSQL-specific syntax and features, such as the `COALESCE` function and PL/pgSQL for the trigger function. Therefore, it requires a PostgreSQL database system to execute successfully.