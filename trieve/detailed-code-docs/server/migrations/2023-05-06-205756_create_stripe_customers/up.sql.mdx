---
title: "up.sql"
---

## High-level description
This SQL script creates a new table named `stripe_customers` to store information about customers associated with Stripe, a popular payment processing platform. The table is designed to maintain a relationship between the application's users and their corresponding Stripe customer records.

## Symbols

### `stripe_customers` table
#### Description
The `stripe_customers` table is created to store essential information about Stripe customers. It includes fields for unique identifiers, email, and timestamps for record management.

#### Internal Logic
The table is created with the following columns and constraints:

1. `id`: A UUID (Universally Unique Identifier) serving as the primary key for the table.
2. `stripe_id`: A unique text field to store the Stripe-specific customer identifier.
3. `email`: A varchar field to store the customer's email address, which can be null and is unique.
4. `created_at`: A timestamp to record when the customer record was created.
5. `updated_at`: A timestamp to record when the customer record was last updated.

The table also includes the following constraints:
- The `id` column is set as the primary key and must be unique.
- The `stripe_id` column must be unique.
- The `email` column is set as unique and can be null.
- A foreign key constraint is added to the `email` column, referencing the `email` column in the `users` table.

## Dependencies
This migration script depends on the existence of a `users` table in the database, specifically referencing its `email` column.

## Performance Considerations
The use of UUID as the primary key and the addition of unique constraints on `stripe_id` and `email` columns will create implicit indexes, which can help with query performance when searching by these fields. However, it's worth noting that UUID primary keys may have slightly lower performance compared to auto-incrementing integer keys for insertions and joins.

## Error Handling
The SQL script includes constraints that will cause errors if violated:
- Attempting to insert a duplicate `id`, `stripe_id`, or non-null `email` will result in a unique constraint violation.
- Inserting an `email` that doesn't exist in the `users` table will result in a foreign key constraint violation.

These constraints help maintain data integrity but require proper error handling in the application layer when inserting or updating records.