---
title: "Overview"
---

## High-level description
This directory contains SQL migration scripts for creating and managing tag-related tables in a database. It includes two files: `up.sql` for creating the tables and `down.sql` for reverting the changes. The migration is focused on implementing a tagging system for datasets and chunk metadata.

## What does it do?
The migration scripts in this directory set up a database structure for tagging datasets and chunk metadata. Here's a simplified explanation of what these scripts do:

1. The `up.sql` script creates two new tables:
   - `dataset_tags`: This table stores unique tags for datasets. Each tag is associated with a specific dataset.
   - `chunk_metadata_tags`: This table links tags from the `dataset_tags` table to specific chunk metadata entries.

2. The `down.sql` script provides a way to undo these changes by dropping both tables if they exist.

This tagging system allows users to organize and categorize datasets and their associated chunk metadata using custom tags. It enables easier searching, filtering, and management of data within the application.

## Key Files

### up.sql
This file contains the SQL commands to create the new tables and set up their relationships. Here's a breakdown of its main components:

1. Creation of the `dataset_tags` table:
   ```sql
   CREATE TABLE dataset_tags (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     dataset_id UUID NOT NULL,
     tag TEXT NOT NULL,
     UNIQUE(id, dataset_id),
     FOREIGN KEY (dataset_id) REFERENCES datasets(id) ON UPDATE CASCADE ON DELETE CASCADE
   );
   ```
   This table stores unique tags for each dataset. The `UNIQUE` constraint ensures that each tag is unique within a dataset.

2. Creation of the `chunk_metadata_tags` table:
   ```sql
   CREATE TABLE chunk_metadata_tags (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     chunk_metadata_id UUID NOT NULL,
     tag_id UUID NOT NULL,
     UNIQUE(chunk_metadata_id, tag_id),
     FOREIGN KEY (chunk_metadata_id) REFERENCES chunk_metadata(id) ON UPDATE CASCADE ON DELETE CASCADE,
     FOREIGN KEY (tag_id) REFERENCES dataset_tags(id) ON UPDATE CASCADE ON DELETE CASCADE
   );
   ```
   This table links tags from the `dataset_tags` table to specific chunk metadata entries. The `UNIQUE` constraint prevents duplicate tag assignments to the same chunk metadata.

### down.sql
This file contains the SQL commands to revert the changes made by `up.sql`:

```sql
DROP TABLE IF EXISTS chunk_metadata_tags;
DROP TABLE IF EXISTS dataset_tags;
```

These commands drop the tables created by the `up.sql` script, effectively undoing the migration.

## Dependencies
This migration relies on existing tables in the database:
- `datasets`: Referenced by the `dataset_tags` table
- `chunk_metadata`: Referenced by the `chunk_metadata_tags` table

The migration also uses the `gen_random_uuid()` function for generating UUIDs, which suggests that the PostgreSQL extension `pgcrypto` might be in use.

## Configuration
While there are no explicit configuration files or environment variables used in these migration scripts, it's important to note that the database connection details and migration execution are likely managed by an external tool or framework (such as Diesel for Rust applications).

The naming convention of the directory (2024-06-06-031312_create-tag-set-table) suggests that this migration is part of a versioned migration system, where the timestamp in the directory name indicates when the migration was created and helps maintain the order of migrations.