---
title: "up.sql"
---

## High-level description
This SQL script creates a PostgreSQL function named `update_notification_count()`. The function is designed to maintain an accurate count of notifications for each user by incrementing the count when a new notification is inserted and decrementing it when a notification is deleted.

## Symbols

### `update_notification_count()`
#### Description
This is a PostgreSQL function that serves as a trigger function to automatically update the notification count for users when notifications are inserted or deleted.

#### Inputs
This function doesn't explicitly take any inputs. It operates on the `NEW` and `OLD` pseudo-records provided by the trigger context.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| RETURN | TRIGGER | Returns the `NEW` record as required by trigger functions |

#### Internal Logic
1. The function checks the operation type (`TG_OP`):
   - For 'INSERT' operations:
     - It attempts to insert a new record into the `user_notification_counts` table with a count of 1.
     - If a record for the user already exists, it updates the existing record by incrementing the `notification_count` by 1.
   - For 'DELETE' operations:
     - It updates the `user_notification_counts` table, decrementing the `notification_count` by 1 for the corresponding user.
2. Finally, it returns the `NEW` record, which is required for trigger functions.

## Side Effects
This function modifies the `user_notification_counts` table, either by inserting new records or updating existing ones.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| plpgsql | The function is written in PL/pgSQL language |

## Error Handling
The function doesn't implement explicit error handling. It relies on PostgreSQL's default error handling mechanisms.

## Performance Considerations
- The function uses an `INSERT ... ON CONFLICT DO UPDATE` statement for INSERT operations, which is an efficient way to handle potential conflicts without separate existence checks.
- For large-scale systems with frequent notifications, the constant updating of the count might become a performance bottleneck. In such cases, consider alternative designs like periodic batch updates or eventual consistency models.

## TODOs
- Consider adding error handling for unexpected operation types.
- Evaluate if additional indexes on the `user_notification_counts` table might be beneficial for performance, especially on the `user_uuid` column.
- Consider adding a check to ensure the notification count doesn't go below zero on DELETE operations.