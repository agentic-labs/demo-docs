---
title: "Overview"
---

## High-level description
This directory contains SQL migration scripts for creating and managing a "user notification counts" feature in a database. The migration introduces a new table to store the count of unread notifications for each user and sets up triggers to automatically update this count when notifications are added or removed from related tables.

## What does it do?
The migration scripts in this directory implement a system to track the number of unread notifications for each user in a database. Here's a breakdown of what it does:

1. Creates a new table called `user_notification_counts` to store the count of unread notifications for each user.
2. Sets up a function that updates the notification count when notifications are added or removed.
3. Creates triggers on existing notification tables (`verification_notifications` and `file_upload_completed_notifications`) to automatically call the update function when notifications change.
4. Initializes the new table with existing notification data from the database.
5. Provides a way to roll back these changes if needed.

This system allows for efficient querying of a user's unread notification count without having to recalculate it every time, which can be beneficial for performance in applications with a large number of users and notifications.

## Key Files

### up.sql
This file contains the SQL commands to set up the new feature. It:
1. Creates the `user_notification_counts` table.
2. Defines the `update_notification_count()` function.
3. Creates triggers on `verification_notifications` and `file_upload_completed_notifications` tables.
4. Initializes the `user_notification_counts` table with existing data.

Here's a snippet of the table creation:

```sql
CREATE TABLE user_notification_counts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_uuid UUID UNIQUE NOT NULL REFERENCES users(id),
    notification_count INTEGER NOT NULL DEFAULT 0
);
```

And here's a part of the trigger function:

```sql
CREATE OR REPLACE FUNCTION update_notification_count() RETURNS TRIGGER AS $$
BEGIN
    IF (TG_OP = 'INSERT') THEN
        INSERT INTO user_notification_counts (user_uuid, notification_count)
        VALUES (NEW.user_uuid, 1)
        ON CONFLICT (user_uuid) DO UPDATE SET notification_count = user_notification_counts.notification_count + 1;
        RETURN NEW;
    ELSIF (TG_OP = 'DELETE') THEN
        UPDATE user_notification_counts
        SET notification_count = notification_count - 1
        WHERE user_uuid = OLD.user_uuid;
        RETURN OLD;
    END IF;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql;
```

### down.sql
This file contains the SQL commands to roll back the changes made by `up.sql`. It:
1. Drops the triggers created on the notification tables.
2. Drops the `update_notification_count()` function.
3. Drops the `user_notification_counts` table.

Here's a snippet from `down.sql`:

```sql
DROP TRIGGER IF EXISTS update_verification_notification_count ON verification_notifications;
DROP TRIGGER IF EXISTS update_file_upload_notification_count ON file_upload_completed_notifications;
DROP FUNCTION IF EXISTS update_notification_count();
DROP TABLE IF EXISTS user_notification_counts;
```

## Dependencies
This migration relies on the existence of the following database objects:
- `users` table
- `verification_notifications` table
- `file_upload_completed_notifications` table

It also uses PostgreSQL-specific features such as:
- `gen_random_uuid()` function for UUID generation
- `plpgsql` language for writing the trigger function

## Configuration
This migration doesn't require any specific configuration. However, it's important to note that the migration assumes certain table structures and relationships:

1. The `users` table should have an `id` column of type UUID.
2. Both `verification_notifications` and `file_upload_completed_notifications` tables should have a `user_uuid` column referencing the `users` table.

When applying this migration, ensure that these assumptions hold true in your database schema. If they don't, you may need to modify the migration scripts accordingly.

In conclusion, this migration introduces a robust system for tracking user notification counts, which can significantly improve performance for applications dealing with large numbers of notifications. The use of triggers ensures that the counts are always up-to-date, eliminating the need for manual updates or periodic recalculations.