---
title: "down.sql"
---

## High-level description
This SQL script is designed to undo the changes made in the corresponding `up.sql` file. It recreates the `card_metadata_count` table, initializes it with the current count of rows in the `card_metadata` table, and sets up a trigger to automatically update this count when rows are inserted or deleted from the `card_metadata` table.

## Symbols

### `card_metadata_count` table
#### Description
This table is created to store the total number of rows in the `card_metadata` table.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| id | UUID | Primary key, automatically generated |
| total_rows | BIGINT | The total number of rows in the `card_metadata` table |

### `update_card_metadata_count()` function
#### Description
This is a trigger function that updates the `total_rows` count in the `card_metadata_count` table whenever a row is inserted or deleted from the `card_metadata` table.

#### Internal Logic
1. If the operation is an INSERT, increment the `total_rows` count by 1.
2. If the operation is a DELETE, decrement the `total_rows` count by 1.

### `card_metadata_count_trigger` trigger
#### Description
This trigger is set up to call the `update_card_metadata_count()` function after each INSERT or DELETE operation on the `card_metadata` table.

## Side Effects
- Creates a new table `card_metadata_count`.
- Inserts an initial row into `card_metadata_count` with the current count of rows in `card_metadata`.
- Creates a new trigger function `update_card_metadata_count()`.
- Sets up a new trigger `card_metadata_count_trigger` on the `card_metadata` table.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| card_metadata | The main table whose row count is being tracked |

## Error Handling
This script does not implement explicit error handling. Any SQL errors that occur during execution will be handled by the database system's default error handling mechanisms.