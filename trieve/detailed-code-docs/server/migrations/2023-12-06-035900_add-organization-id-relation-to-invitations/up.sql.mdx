---
title: "up.sql"
---

## High-level description
This SQL migration script modifies the `invitations` table by adding an `organization_id` column with a foreign key constraint referencing the `organizations` table, and removes the `referral_tokens` column.

## Symbols

### SQL Migration Script
#### Description
This script performs three main operations on the `invitations` table:
1. Adds a new column `organization_id` of type UUID.
2. Creates a foreign key constraint for the new `organization_id` column.
3. Removes the existing `referral_tokens` column.

#### Internal Logic
1. The script first alters the `invitations` table to add a new column named `organization_id` of type UUID. This column is set as NOT NULL, indicating that every invitation must be associated with an organization.

2. It then adds a foreign key constraint named `invitations_organization_id_fkey` to the `organization_id` column. This constraint references the `id` column in the `organizations` table, ensuring referential integrity between invitations and organizations.

3. Finally, the script removes the `referral_tokens` column from the `invitations` table. This suggests that the system is moving away from using referral tokens for invitations, possibly in favor of the new organization-based invitation system.

## Side Effects
- The `invitations` table structure is permanently modified.
- Any existing data in the `referral_tokens` column will be lost when it's dropped.
- All future invitations must be associated with an organization due to the NOT NULL constraint on `organization_id`.
- The relationship between invitations and organizations is now enforced at the database level.

## Performance Considerations
- Adding a new column and constraint to an existing table may temporarily lock the table, which could impact performance if the table is large or frequently accessed.
- Removing the `referral_tokens` column will free up some storage space, potentially improving query performance.

## Error Handling
This script does not include explicit error handling. If any part of the script fails (e.g., if the `organizations` table doesn't exist or if there are existing NULL values in the `organization_id` column), the entire migration will likely fail and need to be rolled back.

## TODOs
- Ensure that there's a corresponding "down" migration script to reverse these changes if needed.
- Verify that all application code that interacts with the `invitations` table is updated to handle the new `organization_id` column and the absence of `referral_tokens`.
- Consider adding a data migration step to populate the `organization_id` column with valid data before setting it to NOT NULL if there are existing records in the `invitations` table.