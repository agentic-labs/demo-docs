---
title: "up.sql"
---

## High-level description
This SQL migration script creates a new table called `stripe_customers` and adds a unique constraint to the `email` column in the existing `users` table. The purpose is to establish a link between users and their corresponding Stripe customer information, ensuring data integrity and uniqueness.

## Symbols

### ALTER TABLE users
#### Description
This SQL statement adds a unique constraint to the `email` column in the `users` table.

#### Internal Logic
- Adds a unique constraint named `users_email_unique` to the `email` column of the `users` table.
- This ensures that each email address in the `users` table is unique, preventing duplicate user entries with the same email.

### CREATE TABLE stripe_customers
#### Description
This SQL statement creates a new table called `stripe_customers` to store Stripe-related customer information.

#### Internal Logic
The table is created with the following columns:
1. `id`: A UUID (Universally Unique Identifier) serving as the primary key.
2. `stripe_id`: A unique text field to store the Stripe customer ID.
3. `email`: A unique text field to store the customer's email address.
4. `created_at`: A timestamp to record when the entry was created.
5. `updated_at`: A timestamp to record when the entry was last updated.

The table also includes the following constraints:
- `id` is set as the primary key and must be unique.
- `stripe_id` must be unique.
- `email` must be unique.
- A foreign key constraint is added to the `email` column, referencing the `email` column in the `users` table.

## Dependencies
This migration script depends on the existence of a `users` table with an `email` column.

## Error Handling
The script does not include explicit error handling. However, the database system will enforce the constraints defined in the script:
- It will prevent duplicate email addresses in both the `users` and `stripe_customers` tables.
- It will ensure that every `email` in the `stripe_customers` table corresponds to an existing `email` in the `users` table.

## Side Effects
- Adding the unique constraint to the `users` table may fail if there are existing duplicate email addresses.
- The creation of the `stripe_customers` table will allow the application to store and manage Stripe customer information separately from the main user data.