---
title: "down.sql"
---

## High-level description
This SQL script is designed to revert changes made in a corresponding `up.sql` file. It drops newly created triggers and functions, then recreates the original function and trigger for managing chunk metadata counts in a PostgreSQL database.

## Symbols

### `update_chunk_metadata_counts()`
#### Description
This function is a trigger function that updates the `dataset_usage_counts` table when rows are inserted into or deleted from the `chunk_metadata` table.

#### Inputs
This function doesn't take explicit inputs but operates on the `NEW` and `OLD` special variables provided by the trigger context.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| NULL | NULL | The function always returns NULL as it's a trigger function |

#### Internal Logic
1. For INSERT operations:
   - Attempts to insert a new row into `dataset_usage_counts` with the dataset_id and a count of 1
   - If a row with the dataset_id already exists, it increments the existing count by 1
2. For DELETE operations:
   - Decrements the `chunk_count` for the corresponding dataset_id in `dataset_usage_counts`
   - Ensures the count never goes below 0

### `update_chunk_metadata_counts_trigger`
#### Description
This is a trigger that calls the `update_chunk_metadata_counts()` function after INSERT or DELETE operations on the `chunk_metadata` table.

#### Internal Logic
- Executes for each row affected by INSERT or DELETE operations
- Calls the `update_chunk_metadata_counts()` function

## Side Effects
- Modifies the `dataset_usage_counts` table by inserting new rows or updating existing ones
- Affects the `chunk_metadata` table indirectly through the trigger

## Error Handling
The script doesn't implement explicit error handling, relying on PostgreSQL's default error handling mechanisms.

## TODOs
The comment "This file should undo anything in `up.sql`" suggests that this script is meant to revert changes made by a corresponding `up.sql` migration file. Developers should ensure that this script accurately undoes all changes made in the `up.sql` file.