---
title: "Overview"
---

## High-level description
This directory contains SQL migration scripts for fixing message counts in a database system. The migration is designed to maintain accurate message counts for organizations by updating the `organization_usage_counts` table whenever messages are inserted or deleted from the `messages` table.

## What does it do?
The migration scripts implement a mechanism to automatically keep track of the number of messages associated with each organization. When a new message is added to the system, it increases the message count for the corresponding organization. Similarly, when a message is deleted, it decreases the count. This ensures that the organization's usage statistics are always up-to-date without requiring manual intervention.

## Key Files
The directory contains two main SQL files:

1. `up.sql`: This file creates the necessary function and trigger to implement the message count tracking mechanism.

2. `down.sql`: This file contains the reverse operations to undo the changes made by `up.sql`, effectively removing the message count tracking mechanism.

Both files define a function called `update_messages_counts` and a trigger named `update_messages_counts_trigger`. The function is responsible for updating the message counts, while the trigger ensures that the function is called automatically when messages are inserted or deleted.

## Configuration
The migration relies on the existing database structure, particularly the following tables:

- `messages`: The table where individual messages are stored.
- `datasets`: A table that links messages to organizations.
- `organization_usage_counts`: A table that stores usage statistics for organizations, including the message count.

The migration scripts assume these tables already exist in the database schema.

Here's a more detailed explanation of the `update_messages_counts` function:

```sql
CREATE OR REPLACE FUNCTION update_messages_counts() RETURNS TRIGGER AS $$
BEGIN
    IF (TG_OP = 'INSERT') THEN
        INSERT INTO organization_usage_counts (org_id, message_count)
        VALUES (
            (SELECT organization_id FROM datasets WHERE id = NEW.dataset_id),
            1
        )
        ON CONFLICT (org_id) DO UPDATE SET message_count = organization_usage_counts.message_count + 1;
        RETURN NEW;
    ELSIF (TG_OP = 'DELETE') THEN
        UPDATE organization_usage_counts
        SET message_count = GREATEST(message_count - 1, 0)
        WHERE org_id = (SELECT organization_id FROM datasets WHERE id = OLD.dataset_id);
        RETURN OLD;
    END IF;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql;
```

This function:
1. Checks if the operation is an INSERT or DELETE.
2. For INSERT:
   - It finds the organization ID associated with the new message's dataset.
   - It then either inserts a new row with a count of 1 or increments an existing count.
3. For DELETE:
   - It finds the organization ID associated with the deleted message's dataset.
   - It then decrements the message count, ensuring it doesn't go below zero.

The trigger is set up to call this function after each INSERT or DELETE operation on the `messages` table:

```sql
CREATE TRIGGER update_messages_counts_trigger
AFTER INSERT OR DELETE ON messages
FOR EACH ROW
EXECUTE FUNCTION update_messages_counts();
```

This migration ensures that the `organization_usage_counts` table always reflects the accurate number of messages for each organization, providing reliable usage statistics for the system.