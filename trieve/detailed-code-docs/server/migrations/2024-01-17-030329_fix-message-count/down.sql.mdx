---
title: "down.sql"
---

## High-level description
This code defines a PostgreSQL function `update_messages_counts` and a trigger `update_messages_counts_trigger` that work together to maintain a count of messages associated with each organization in a table named `organization_usage_counts`. The function is triggered after an INSERT or DELETE operation on the `messages` table.

## Code Structure
The code defines two main symbols:
- `update_messages_counts` function: This function is responsible for updating the message count in the `organization_usage_counts` table.
- `update_messages_counts_trigger` trigger: This trigger calls the `update_messages_counts` function after each INSERT or DELETE operation on the `messages` table.

## Symbols

### `update_messages_counts`
#### Description
This function updates the `message_count` for an organization in the `organization_usage_counts` table based on INSERT or DELETE operations on the `messages` table. 

#### Inputs
This function implicitly takes the `OLD` row from the `messages` table as input through the trigger.

#### Outputs
The function returns `NEW` which represents the row being inserted or deleted in the `messages` table. This is a standard practice for triggers in PostgreSQL.

#### Internal Logic
1. **Determine operation type:** Checks if the triggering event is an INSERT or DELETE operation using `TG_OP`.
2. **INSERT case:** If it's an INSERT:
    - It inserts a new row into `organization_usage_counts` with `message_count` set to 1 if the organization doesn't exist yet.
    - If the organization already exists, it increments the `message_count` by 1.
3. **DELETE case:** If it's a DELETE:
    - It decrements the `message_count` by 1 for the corresponding organization.
    - It ensures that `message_count` doesn't go below 0.
4. **Return value:** Returns the `NEW` row, which is the row being inserted or deleted from the `messages` table.

### `update_messages_counts_trigger`
#### Description
This trigger calls the `update_messages_counts` function after each INSERT or DELETE operation on the `messages` table.

#### Inputs
This trigger implicitly uses the `OLD` and `NEW` rows from the `messages` table.

#### Outputs
This trigger doesn't have any explicit outputs. It indirectly updates the `organization_usage_counts` table through the `update_messages_counts` function.

#### Internal Logic
1. **Trigger activation:** This trigger activates after every INSERT or DELETE operation on the `messages` table for each affected row.
2. **Function execution:** It executes the `update_messages_counts` function.

## Side Effects
- **Modifies `organization_usage_counts` table:** This code modifies the `organization_usage_counts` table by inserting new rows or updating existing rows based on the operations performed on the `messages` table. 

## Error Handling
- The code includes a basic form of error handling by using `ON CONFLICT DO UPDATE` to handle cases where a row for the organization already exists in the `organization_usage_counts` table during an INSERT operation.
- It also prevents the `message_count` from going below zero in the DELETE case. 
- However, it doesn't explicitly handle other potential errors, such as database connection issues or foreign key constraint violations.
