---
title: "Overview"
---

## High-level description
This directory contains SQL migration files for creating and managing the `chunk_count` column in the `organization_usage_counts` table. The migration is designed to add a new column to store aggregated chunk counts for organizations and populate it with data calculated from related datasets.

## What does it do?
The migration performs two main tasks:

1. It adds a new column called `chunk_count` to the `organization_usage_counts` table. This column is designed to store the total number of chunks associated with each organization.

2. It calculates the total chunk count for each organization by summing up the chunk counts from all datasets belonging to that organization. This aggregated data is then used to populate the newly added `chunk_count` column.

The purpose of this migration is to provide a quick and efficient way to retrieve the total chunk count for an organization without having to perform complex queries or calculations each time this information is needed. This can improve performance and simplify data retrieval in the application.

## Key Files

### up.sql
This file contains the SQL commands to perform the migration:

1. It alters the `organization_usage_counts` table to add the `chunk_count` column:

```sql
ALTER TABLE organization_usage_counts
ADD COLUMN chunk_count INT DEFAULT 0;
```

2. It uses a Common Table Expression (CTE) to calculate the total chunk count for each organization:

```sql
WITH AggregatedCounts AS (
    SELECT d.organization_id, SUM(duc.chunk_count) as total_chunk_count
    FROM dataset_usage_counts duc
    JOIN datasets d ON duc.dataset_id = d.id
    GROUP BY d.organization_id
)
```

3. It updates the `organization_usage_counts` table with the calculated values:

```sql
UPDATE organization_usage_counts ouc
SET chunk_count = ac.total_chunk_count
FROM AggregatedCounts ac
WHERE ouc.org_id = ac.organization_id;
```

### down.sql
This file contains the SQL command to revert the changes made by the `up.sql` file:

```sql
ALTER TABLE organization_usage_counts
DROP COLUMN chunk_count;
```

This command removes the `chunk_count` column from the `organization_usage_counts` table, effectively undoing the migration.

## Dependencies
This migration depends on the existence of the following database objects:

1. `organization_usage_counts` table
2. `dataset_usage_counts` table
3. `datasets` table

The migration assumes that these tables are already present in the database and have the necessary relationships established between them.

## Performance Considerations
The migration involves joining and aggregating data from potentially large tables (`dataset_usage_counts` and `datasets`). For organizations with a large number of datasets or chunks, this operation could be computationally expensive and may take some time to complete. It's advisable to run this migration during off-peak hours or maintenance windows to minimize impact on system performance.

## Error Handling
The migration scripts do not include explicit error handling. If any of the required tables or columns are missing, or if there are data integrity issues, the database system will likely raise an error during the migration process. It's important to thoroughly test the migration in a staging environment before applying it to the production database.

## TODOs
The comment in the `up.sql` file suggests that there might be a plan for a potential rollback mechanism:

```sql
-- This will update the chunk_count column in the organization_usage_counts table, but keep the old table so that we can rollback if needed
```

This could be a reminder for the development team to implement a more sophisticated rollback strategy if needed, beyond the simple column removal provided in the `down.sql` file.