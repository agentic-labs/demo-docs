---
title: "up.sql"
---

## High-level description
This SQL migration script adds a new column to the `organization_usage_counts` table to store aggregated chunk counts for organizations. It then calculates the total chunk count for each organization by summing up the chunk counts from related datasets and updates the new column with these aggregated values.

## Symbols

### ALTER TABLE organization_usage_counts
#### Description
This SQL command adds a new column named `chunk_count` to the `organization_usage_counts` table.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| chunk_count | INT | The new column to store aggregated chunk counts |

#### Internal Logic
- Adds the `chunk_count` column with a default value of 0.

### WITH AggregatedCounts AS (...)
#### Description
This Common Table Expression (CTE) calculates the total chunk count for each organization by summing up the chunk counts from related datasets.

#### Internal Logic
1. Joins the `dataset_usage_counts` table with the `datasets` table using the `dataset_id`.
2. Groups the results by `organization_id`.
3. Calculates the sum of `chunk_count` for each organization.

### UPDATE organization_usage_counts
#### Description
This SQL command updates the newly added `chunk_count` column in the `organization_usage_counts` table with the aggregated values calculated in the CTE.

#### Internal Logic
1. Uses the results from the `AggregatedCounts` CTE.
2. Matches the `org_id` in the `organization_usage_counts` table with the `organization_id` from the CTE.
3. Sets the `chunk_count` column to the calculated `total_chunk_count` for each matching organization.

## Side Effects
- Modifies the structure of the `organization_usage_counts` table by adding a new column.
- Updates the `chunk_count` values in the `organization_usage_counts` table based on aggregated data from related tables.

## Performance Considerations
- The script performs a join between `dataset_usage_counts` and `datasets` tables, which could be potentially expensive for large datasets.
- The aggregation operation (SUM) is performed on potentially large datasets, which might impact performance for organizations with many datasets.

## TODOs
The comment "-- This will update the chunk_count column in the organization_usage_counts table, but keep the old table so that we can rollback if needed" suggests that there might be a plan for a potential rollback mechanism, which is not implemented in this script. This could be a future consideration or a reminder for the development team.