---
title: "Overview"
---

## High-level description
This directory contains SQL migration scripts for moving collections from being associated with users to being associated with datasets. It includes two files: `up.sql` for applying the changes and `down.sql` for reverting them. The migration modifies the database schema to reflect this new association and updates related tables and functions accordingly.

## What does it do?
This migration changes how collections are organized in the database. Previously, collections were directly linked to users. After this migration, collections are associated with datasets instead. Here's what happens:

1. The system removes the direct link between collections and users by dropping the `author_id` column from the `chunk_collections` table.
2. It renames the `user_collection_counts` table to `dataset_collection_counts` to reflect the new association with datasets.
3. The system updates the `update_collection_counts` function to work with datasets instead of users.
4. If needed, these changes can be undone using the `down.sql` script, which reverses all the modifications.

This change likely allows for more flexible organization of collections within datasets, potentially enabling multiple users to collaborate on the same dataset's collections.

## Key Files

### up.sql
This file contains the SQL statements to implement the migration:

1. Removes the `author_id` column from the `chunk_collection` table:
   ```sql
   ALTER TABLE chunk_collection DROP COLUMN author_id;
   ```

2. Modifies the `user_collection_counts` table to work with datasets:
   ```sql
   ALTER TABLE user_collection_counts DROP COLUMN user_id;
   ALTER TABLE user_collection_counts ADD COLUMN dataset_id uuid;
   ALTER TABLE user_collection_counts RENAME TO dataset_collection_counts;
   ```

3. Updates the `update_collection_counts` function:
   ```sql
   CREATE OR REPLACE FUNCTION public.update_collection_counts()
    RETURNS trigger
    LANGUAGE plpgsql
   AS $function$
   BEGIN
     IF (TG_OP = 'INSERT' OR TG_OP = 'UPDATE') THEN
       INSERT INTO dataset_collection_counts (dataset_id, user_id, collection_count)
       VALUES (NEW.dataset_id, NEW.user_id, 1)
       ON CONFLICT (dataset_id, user_id)
       DO UPDATE SET collection_count = dataset_collection_counts.collection_count + 1;
     ELSIF (TG_OP = 'DELETE') THEN
       UPDATE dataset_collection_counts
       SET collection_count = dataset_collection_counts.collection_count - 1
       WHERE dataset_id = OLD.dataset_id AND user_id = OLD.user_id;
     END IF;
     RETURN NULL;
   END;
   $function$
   ```

### down.sql
This file contains the SQL statements to revert the migration:

1. Adds back the `author_id` column to the `chunk_collections` table:
   ```sql
   ALTER TABLE chunk_collections ADD COLUMN author_id uuid;
   ```

2. Adds back the `user_id` column to the `user_collection_counts` table:
   ```sql
   ALTER TABLE user_collection_counts ADD COLUMN user_id uuid;
   ```

3. Removes the `dataset_id` column from the `chunk_collections` table:
   ```sql
   ALTER TABLE chunk_collections DROP COLUMN dataset_id;
   ```

4. Renames the `dataset_collection_counts` table back to `user_collection_counts`:
   ```sql
   ALTER TABLE dataset_collection_counts RENAME TO user_collection_counts;
   ```

## Configuration
This migration does not require any specific configuration files or environment variables. However, it's important to note that the migration is timestamped (2024-01-26-190229), which suggests that it uses a migration framework that relies on timestamps for ordering migrations.

When applying this migration, database administrators should ensure that:
1. All previous migrations have been successfully applied.
2. The database is backed up before applying this migration.
3. The application code is updated to work with the new schema before deploying this migration to production.

## Dependencies
This migration appears to be written for a PostgreSQL database, as evidenced by the use of PostgreSQL-specific syntax (e.g., `ON CONFLICT` clause in the `update_collection_counts` function). The exact version of PostgreSQL is not specified, but it should be compatible with PostgreSQL 9.5 or later, which introduced the `ON CONFLICT` clause.

No external libraries or frameworks are directly referenced in these SQL scripts. However, the migration is likely managed by a database migration tool or framework in the larger application context, possibly something like Flyway, Liquibase, or a custom solution built into the application's ORM.