---
title: "up.sql"
---

## High-level description
This SQL script migrates the database schema to move collections from being associated with users to being associated with datasets. It removes the `author_id` column from `chunk_collection`, renames `user_collection_counts` to `dataset_collection_counts`, and updates the trigger function `update_collection_counts` accordingly.

## Symbols

### `ALTER TABLE chunk_collection`
#### Description
This statement removes the `author_id` column from the `chunk_collection` table, indicating that collections are no longer directly associated with users.

### `ALTER TABLE user_collection_counts DROP COLUMN user_id`
#### Description
This statement removes the `user_id` column from the `user_collection_counts` table as part of the migration process.

### `ALTER TABLE user_collection_counts ADD COLUMN dataset_id uuid`
#### Description
This statement adds a new column `dataset_id` of type `uuid` to the `user_collection_counts` table. This column will store the association between datasets and collections.

### `ALTER TABLE user_collection_counts RENAME TO dataset_collection_counts`
#### Description
This statement renames the table `user_collection_counts` to `dataset_collection_counts` to reflect the new schema where collections are associated with datasets.

### `CREATE OR REPLACE FUNCTION public.update_collection_counts()`
#### Description
This statement creates or replaces a trigger function named `update_collection_counts`. This function is triggered on INSERT, UPDATE, and DELETE operations on a table (not explicitly specified in the provided code).

#### Internal Logic
The function checks the type of operation (`TG_OP`) being performed:
- **INSERT/UPDATE:** Inserts a new row into `dataset_collection_counts` with the `dataset_id`, `user_id`, and an initial `collection_count` of 1. If a row with the same `user_id` already exists, it increments the `collection_count` by 1.
- **DELETE:** Decrements the `collection_count` in `dataset_collection_counts` for the corresponding `user_id`.

The function always returns `NULL` as it is a trigger function and does not directly modify the data being inserted, updated, or deleted.
