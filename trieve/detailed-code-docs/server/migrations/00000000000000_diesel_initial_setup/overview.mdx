---
title: "Overview"
---

## High-level description
This directory contains SQL migration scripts for setting up and tearing down the initial Diesel ORM configuration in a PostgreSQL database. The scripts define and remove helper functions used by Diesel to manage automatic updating of `updated_at` timestamps in database tables.

## What does it do?
The migration scripts in this directory set up and remove a system for automatically updating `updated_at` timestamps in database tables. This is a common requirement in many applications to track when records were last modified.

When applied, the "up" migration creates two functions:
1. `diesel_manage_updated_at`: This function sets up a trigger on a specified table to automatically update the `updated_at` column whenever a row is modified.
2. `diesel_set_updated_at`: This function is called by the trigger and does the actual work of updating the `updated_at` column.

The "down" migration removes these functions, effectively undoing the setup.

This automatic timestamp management is particularly useful in applications where you want to track the last modification time of records without having to manually update this information in your application code every time you make a change.

## Key Files

### up.sql
This file contains the SQL commands to create the `diesel_manage_updated_at` and `diesel_set_updated_at` functions.

The `diesel_manage_updated_at` function takes a table name as an argument and creates a trigger on that table. This trigger will call `diesel_set_updated_at` before any UPDATE operation on the table.

The `diesel_set_updated_at` function is the one actually called by the trigger. It checks if the `updated_at` column was explicitly modified in the update operation. If not, it sets the `updated_at` column to the current timestamp.

Here's a simplified version of the `diesel_set_updated_at` function:

```sql
CREATE OR REPLACE FUNCTION diesel_set_updated_at() RETURNS trigger AS $$
BEGIN
    IF (
        NEW IS DISTINCT FROM OLD AND
        NEW.updated_at IS NOT DISTINCT FROM OLD.updated_at
    ) THEN
        NEW.updated_at := current_timestamp;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### down.sql
This file contains the SQL commands to remove the functions created by up.sql. It's very straightforward:

```sql
DROP FUNCTION IF EXISTS diesel_manage_updated_at(_tbl regclass);
DROP FUNCTION IF EXISTS diesel_set_updated_at();
```

These commands will remove the functions if they exist, allowing for a clean rollback of the migration.

## Configuration
This migration doesn't require any specific configuration. However, it's important to note that these functions are designed to work with tables that have an `updated_at` column. Any table that you want to use this automatic timestamp updating with should have this column.

Also, after applying this migration, you would need to call `diesel_manage_updated_at` for each table where you want to enable automatic `updated_at` updates. This would typically be done in subsequent migrations or as part of your table creation scripts.

For example:

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT current_timestamp,
    updated_at TIMESTAMP NOT NULL DEFAULT current_timestamp
);

SELECT diesel_manage_updated_at('users');
```

This setup allows for a flexible and reusable way to manage `updated_at` timestamps across multiple tables in your database, which is a common requirement in many applications.