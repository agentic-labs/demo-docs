---
title: "Overview"
---

## High-level description
This directory contains SQL migration scripts for adding an `organization_id` column to the `datasets` table in a database. The migration establishes a relationship between the `datasets` and `organizations` tables, allowing datasets to be associated with specific organizations.

## What does it do?
The migration performs the following actions:
1. Adds a new `organization_id` column to the `datasets` table.
2. Updates existing datasets to belong to a 'DEFAULT' organization.
3. Makes the `organization_id` column non-nullable.
4. Establishes a foreign key relationship between `datasets` and `organizations` tables.
5. Provides a way to revert these changes if needed.

This migration enables the system to track which organization each dataset belongs to, allowing for better data organization and access control based on organizational boundaries.

## Key Files

### up.sql
This file contains the SQL statements to perform the migration:

1. Add the `organization_id` column:
   ```sql
   ALTER TABLE datasets ADD COLUMN organization_id UUID DEFAULT NULL;
   ```

2. Update existing datasets to belong to the 'DEFAULT' organization:
   ```sql
   UPDATE datasets SET organization_id = organizations.id 
   FROM organizations WHERE organizations.name = 'DEFAULT';
   ```

3. Make the `organization_id` column non-nullable:
   ```sql
   ALTER TABLE datasets ALTER COLUMN organization_id SET NOT NULL;
   ```

4. Add a foreign key constraint:
   ```sql
   ALTER TABLE datasets ADD CONSTRAINT datasets_organization_id_fkey 
   FOREIGN KEY (organization_id) REFERENCES organizations(id);
   ```

### down.sql
This file contains the SQL statement to revert the migration:

```sql
ALTER TABLE datasets DROP COLUMN IF EXISTS organization_id;
```

This statement removes the `organization_id` column from the `datasets` table if it exists, effectively undoing the changes made by the `up.sql` script.

## Dependencies
This migration relies on the existence of the `datasets` and `organizations` tables in the database. It assumes that there is a 'DEFAULT' organization present in the `organizations` table.

## Configuration
No specific configuration is required for this migration. However, it's important to note that the migration assumes the presence of a 'DEFAULT' organization in the `organizations` table. If this organization doesn't exist, the migration may fail or result in unexpected behavior.

The migration uses UUID as the data type for the `organization_id` column, which suggests that the system uses UUIDs for unique identifiers across tables.

When applying this migration, database administrators should be aware of the following:

1. The migration will modify existing data by assigning all current datasets to the 'DEFAULT' organization.
2. After the migration, all datasets must be associated with an organization due to the `NOT NULL` constraint.
3. The foreign key constraint will prevent the deletion of organizations that have associated datasets, ensuring referential integrity.

This migration is part of a larger system that likely manages datasets within the context of different organizations, possibly for multi-tenancy or organizational data segregation purposes.