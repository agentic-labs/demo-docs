---
title: "Overview"
---

## High-level description
The `backend/chainlit/haystack` directory contains code for integrating the Chainlit framework with the Haystack library, specifically focusing on Haystack Agents. This integration provides functionality to track, manage, and stream the execution steps of Haystack Agents within the Chainlit environment.

## What does it do?
This directory implements a bridge between Chainlit and Haystack, enabling developers to use Haystack Agents within Chainlit applications. It performs the following key functions:

1. Version Compatibility Check: Ensures that the installed version of Haystack meets the minimum required version for compatibility with Chainlit.

2. Agent Execution Tracking: Implements a callback handler that monitors and manages the execution steps of Haystack Agents, including agent steps, tool usage, and token streaming.

3. Step Management: Uses a stack-based approach to track and manage the hierarchical structure of agent execution steps.

4. Event Handling: Provides methods to handle various events during the agent's operation, such as agent start/finish, tool start/finish, and error handling.

5. Token Streaming: Supports streaming of tokens generated by the agent, allowing for real-time output in Chainlit applications.

## Key Files

1. `__init__.py`:
   - Performs a version check for Haystack compatibility.
   - Raises a ValueError if the installed Haystack version is below the required version (1.18.0).

2. `callbacks.py`:
   - Contains the `HaystackAgentCallbackHandler` class, which is the core of the Haystack integration.
   - Implements a generic `Stack` data structure for managing execution steps.
   - Provides methods for handling various agent and tool events.
   - Supports token streaming for real-time output.

## Dependencies
- Haystack (version &gt;= 1.18.0): The main library being integrated, providing the Agent and Tool classes.
- Chainlit: The framework this integration is built for, providing context, step management, and synchronization utilities.
- literalai.helper: Provides utility functions (specific purpose not detailed in the provided summary).

## Configuration
The `HaystackAgentCallbackHandler` class accepts the following configuration options:
- `agent`: The Haystack Agent to attach the callback handler to.
- `stream_final_answer`: A boolean indicating whether to stream the final answer.
- `stream_final_answer_agent_name`: The name to use for the agent when streaming the final answer.

## Code Examples

Here's an example of how the `HaystackAgentCallbackHandler` might be used:

```python
from haystack.agents import Agent
from chainlit.haystack.callbacks import HaystackAgentCallbackHandler

# Create a Haystack Agent
agent = Agent(...)

# Create and attach the callback handler
callback_handler = HaystackAgentCallbackHandler(
    agent=agent,
    stream_final_answer=True,
    stream_final_answer_agent_name="MyAgent"
)

# The callback handler is now attached to the agent and will track its execution
```

The `HaystackAgentCallbackHandler` uses a stack to manage steps. Here's a simplified example of how it might handle an agent step:

```python
def on_agent_step(self, agent_step):
    step = Step(
        name=agent_step.prompt,
        type="agent",
        parent_id=self.stack.peek().id if self.stack else None,
    )
    self.stack.push(step)
    cl.run_sync(step.send)

    # Process the agent step...

    cl.run_sync(step.update)
    self.stack.pop()
```

This code creates a new Step object for each agent step, sends it to Chainlit, processes the step, updates it, and then removes it from the stack.

In summary, the `backend/chainlit/haystack` directory provides a crucial integration between Chainlit and Haystack, enabling developers to leverage Haystack Agents within Chainlit applications while benefiting from Chainlit's step tracking and streaming capabilities. This integration enhances the ability to create interactive, real-time AI applications that combine the strengths of both frameworks.