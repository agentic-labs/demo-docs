---
title: "callbacks.py"
---

Here's a detailed documentation of the `backend/chainlit/haystack/callbacks.py` file:

## High-level description
This file implements a callback handler for the Haystack library, specifically for Haystack Agents. It provides functionality to track and manage the execution steps of a Haystack Agent, including handling agent steps, tool usage, and token streaming.

## Code Structure
The main class `HaystackAgentCallbackHandler` is the core of this file. It uses a `Stack` data structure to manage steps and implements various callback methods to handle different events in the Haystack Agent's execution process.

## Symbols

### `Stack`
#### Description
A generic stack data structure implementation.

#### Methods
- `__init__`: Initializes an empty stack.
- `__len__`: Returns the number of items in the stack.
- `push`: Adds an item to the top of the stack.
- `pop`: Removes and returns the top item from the stack.
- `peek`: Returns the top item without removing it.
- `clear`: Removes all items from the stack.

### `HaystackAgentCallbackHandler`
#### Description
A callback handler for Haystack Agents that manages the execution steps and provides methods for handling various events during the agent's operation.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| agent | Agent | The Haystack Agent to attach the callback handler to |
| stream_final_answer | bool | Whether to stream the final answer |
| stream_final_answer_agent_name | str | The name to use for the agent when streaming the final answer |

#### Internal Logic
1. Initializes the handler and attaches various callback methods to the agent's callback manager.
2. Manages a stack of `Step` objects to track the execution flow.
3. Handles agent start, step, and finish events.
4. Manages tool start, finish, and error events.
5. Implements token streaming for the agent's output.

#### Methods

##### `on_agent_start`
Handles the start of the agent's execution.

##### `on_agent_finish`
Handles the completion of the agent's execution.

##### `on_agent_step`
Manages individual steps of the agent's execution.

##### `on_new_token`
Handles new tokens generated by the agent, supporting streaming output.

##### `on_tool_start`
Manages the start of a tool's execution.

##### `on_tool_finish`
Handles the completion of a tool's execution.

##### `on_tool_error`
Manages errors that occur during tool execution.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| chainlit.context | Provides context for the current execution |
| chainlit.step | Defines the Step class used for tracking execution steps |
| chainlit.sync | Provides synchronization utilities |
| haystack.agents | Imports Agent and Tool classes from Haystack |
| literalai.helper | Provides utility functions |
| chainlit | Imports Message class |

## Error Handling
The class implements error handling for tool execution in the `on_tool_error` method, which creates an error step and updates it with the exception information.

## Logging
The file doesn't implement explicit logging, but it uses the Chainlit framework's built-in step tracking and updating mechanism, which may include logging functionality.

This callback handler is designed to integrate Haystack Agents with the Chainlit framework, providing detailed tracking and management of the agent's execution process, including support for streaming outputs and handling various events during the agent's operation.