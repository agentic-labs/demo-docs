---
title: "test_context.py"
---

## High-level description
This file contains unit tests for the `ChainlitContext` class and related functions in the `chainlit.context` module. The tests cover the initialization of contexts, retrieval of contexts, and various properties and methods of the `ChainlitContext` class.

## Code Structure
The test file is organized into several test functions, each focusing on a specific aspect of the `ChainlitContext` class or related functions. The tests use pytest fixtures to set up mock objects for websocket sessions, HTTP sessions, and emitters.

## Symbols

### `test_chainlit_context_init_with_websocket`
#### Description
Tests the initialization of a `ChainlitContext` object with a websocket session.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| mock_websocket_session | Mock | A mock WebsocketSession object |
| mock_emitter | Mock | A mock BaseChainlitEmitter object |

#### Internal Logic
1. Creates a `ChainlitContext` instance with the mock websocket session and emitter.
2. Asserts that the emitter is an instance of `BaseChainlitEmitter`.
3. Checks if the session and active_steps attributes are correctly set.

### `test_chainlit_context_init_with_http`
#### Description
Tests the initialization of a `ChainlitContext` object with an HTTP session.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| mock_http_session | Mock | A mock HTTPSession object |

#### Internal Logic
1. Creates a `ChainlitContext` instance with the mock HTTP session.
2. Asserts that the emitter is an instance of `BaseChainlitEmitter`.
3. Checks if the session and active_steps attributes are correctly set.

### `test_init_ws_context`
#### Description
Tests the `init_ws_context` function for initializing a websocket context.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| mock_websocket_session | Mock | A mock WebsocketSession object |

#### Internal Logic
1. Calls `init_ws_context` with the mock websocket session.
2. Asserts that the returned context is an instance of `ChainlitContext`.
3. Checks if the session and emitter attributes are correctly set.

### `test_init_http_context`
#### Description
Tests the `init_http_context` function for initializing an HTTP context.

#### Internal Logic
1. Calls `init_http_context`.
2. Asserts that the returned context is an instance of `ChainlitContext`.
3. Checks if the session and emitter attributes are correctly set.

### `test_get_context`
#### Description
Tests the `get_context` function for retrieving the current context.

#### Internal Logic
1. Attempts to get the context without initialization, expecting a `ChainlitContextException`.
2. Initializes an HTTP context.
3. Retrieves the context and asserts it's an instance of `ChainlitContext`.

### `test_current_step_and_run`
#### Description
Tests the `current_step` and `current_run` properties of the `ChainlitContext` class.

#### Internal Logic
1. Initializes an HTTP context.
2. Checks that `current_step` and `current_run` are initially None.
3. Adds a mock step to the `active_steps` list.
4. Verifies that `current_step` and `current_run` now return the mock step.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| unittest.mock | Provides mocking capabilities for testing |
| pytest | Testing framework |
| chainlit.context | Module under test |
| chainlit.emitter | Provides emitter classes used in context |
| chainlit.session | Provides session classes used in context |

## Error Handling
The tests include error handling checks, such as verifying that `get_context()` raises a `ChainlitContextException` when no context is initialized.