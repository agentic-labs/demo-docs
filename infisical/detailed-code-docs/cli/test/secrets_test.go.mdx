---
title: "secrets_test.go"
---

## High-level description
This file contains unit tests for the secrets retrieval functionality of the Infisical CLI. It tests various scenarios including different authentication methods (Service Token, Universal Auth, and User Auth), different command options (with/without imports, recursive/non-recursive), and error cases.

## Code Structure
The file consists of multiple test functions, each testing a specific scenario of the `secrets` command. These functions use helper functions like `ExecuteCliCommand` and `MachineIdentityLoginCmd` to set up and execute the tests.

## Symbols

### TestServiceToken_SecretsGetWithImportsAndRecursiveCmd
#### Description
Tests the `secrets` command using a service token, with imports and recursive options enabled.

#### Internal Logic
1. Executes the CLI command with specific parameters.
2. Checks for errors in command execution.
3. Uses cupaloy to snapshot test the output.

### TestServiceToken_SecretsGetWithoutImportsAndWithoutRecursiveCmd
#### Description
Tests the `secrets` command using a service token, without imports and recursive options.

#### Internal Logic
Similar to the previous test, but with different command options.

### TestUniversalAuth_SecretsGetWithImportsAndRecursiveCmd
#### Description
Tests the `secrets` command using Universal Auth, with imports and recursive options enabled.

#### Internal Logic
1. Calls `MachineIdentityLoginCmd` to set up Universal Auth.
2. Executes the CLI command with specific parameters.
3. Checks for errors and performs snapshot testing.

### TestUniversalAuth_SecretsGetWithoutImportsAndWithoutRecursiveCmd
#### Description
Tests the `secrets` command using Universal Auth, without imports and recursive options.

#### Internal Logic
Similar to the previous Universal Auth test, but with different command options.

### TestUniversalAuth_SecretsGetWrongEnvironment
#### Description
Tests the `secrets` command using Universal Auth with an invalid environment.

#### Internal Logic
1. Sets up Universal Auth.
2. Executes the command with an invalid environment.
3. Performs snapshot testing on the output (expected to be an error message).

### TestUserAuth_SecretsGetAll
#### Description
Tests the `secrets` command using User Authentication to retrieve all secrets.

#### Internal Logic
1. Executes the CLI command with user authentication.
2. Performs snapshot testing on the output.

### testUserAuth_SecretsGetAllWithoutConnection
#### Description
Tests the `secrets` command using User Authentication when the server is unreachable.

#### Internal Logic
1. Modifies the config file to use an unreachable URL.
2. Executes the CLI command.
3. Restores the original config file.
4. Performs snapshot testing on the output.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| testing | Go's testing framework |
| github.com/Infisical/infisical-merge/packages/util | Utility functions for Infisical |
| github.com/bradleyjkemp/cupaloy/v2 | Snapshot testing library |

## Error Handling
The tests use `t.Fatalf` to report errors, which will cause the test to fail immediately if an error occurs during command execution or snapshot comparison.