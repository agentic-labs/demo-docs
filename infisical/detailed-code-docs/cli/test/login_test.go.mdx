---
title: "login_test.go"
---

## High-level description
This file contains test functions for the login functionality of a CLI tool, likely for an application called Infisical. It includes tests for user initialization, user login, and machine identity login using various authentication methods.

## Code Structure
The file defines three main functions: `UserInitCmd()`, `UserLoginCmd()`, and `MachineIdentityLoginCmd()`. These functions simulate user interactions with the CLI tool for different login scenarios.

## Symbols

### UserInitCmd
#### Description
This function simulates the initialization process for a user in the CLI tool. It uses a pseudo-terminal to interact with the CLI, selecting default options for organization and project.

#### Internal Logic
1. Starts the CLI command "init" using a pseudo-terminal.
2. Sets up a goroutine to read terminal output and detect specific prompts.
3. Responds to prompts by sending newline characters, effectively selecting default options.

### UserLoginCmd
#### Description
This function simulates the login process for a user in the CLI tool. It sets the vault to use a file storage and then interacts with the CLI to perform a login.

#### Internal Logic
1. Sets the vault to use file storage.
2. Starts the CLI command "login --interactive" using a pseudo-terminal.
3. Sets up a goroutine to read terminal output and detect specific prompts.
4. Responds to prompts by sending appropriate inputs (email, password, etc.).

### MachineIdentityLoginCmd
#### Description
This function tests the machine identity login process using universal authentication.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| t | *testing.T | Testing object for assertions and failure reporting |

#### Internal Logic
1. Checks if a UAAccessToken already exists, skipping the test if it does.
2. Defines a regex pattern for JWT tokens.
3. Executes the CLI command for login with universal auth method.
4. Asserts that the output matches the JWT pattern.
5. Stores the output as the UAAccessToken.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| log | For logging fatal errors |
| os/exec | For executing CLI commands |
| strings | For string manipulation and searching |
| testing | For running tests and assertions |
| github.com/creack/pty | For creating pseudo-terminals |
| github.com/stretchr/testify/assert | For test assertions |

## Error Handling
The code uses log.Fatalf for handling critical errors during command execution or pseudo-terminal operations.

## Performance Considerations
The use of goroutines for reading terminal output allows for non-blocking interaction with the CLI, improving the efficiency of the tests.