---
title: "20231222092113_project-bot.ts"
---

## High-level description
This code defines a database migration script using Knex.js to create and manage the `ProjectBot` table in a PostgreSQL database. It handles both upgrading (creating or modifying the table) and downgrading (reverting the changes) operations.

## References
- `TableName`: An enum-like object that probably defines string constants for database table names.
- `createOnUpdateTrigger`: A utility function to create a trigger that updates the `updatedAt` column on row updates.
- `dropOnUpdateTrigger`: A utility function to drop the update trigger.

## Symbols

### `up`
#### Description
This asynchronous function defines the steps to upgrade the database schema by creating the `ProjectBot` table if it doesn't exist.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| knex | Knex | A Knex.js instance connected to the database. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Promise\&lt;void\&gt; | Promise | A promise that resolves when the migration is complete. |

#### Internal Logic
1. Checks if the `ProjectBot` table already exists using `knex.schema.hasTable`.
2. If the table doesn't exist, it creates the table with the specified columns and constraints:
    - `id`: UUID primary key, generated by the database.
    - `name`: Required string field.
    - `isActive`: Boolean field with a default value of `false`.
    - `encryptedPrivateKey`, `publicKey`, `iv`, `tag`, `algorithm`, `keyEncoding`: Text fields related to encryption.
    - `encryptedProjectKey`, `encryptedProjectKeyNonce`: Text fields potentially used for project-specific encryption.
    - `projectId`: Required, unique string field referencing the `Project` table, enforcing a one-to-one relationship with cascading deletes.
    - `senderId`: Nullable UUID field referencing the `Users` table, allowing for soft deletes.
    - `createdAt`, `updatedAt`, `deletedAt`: Timestamp fields for tracking creation, modification, and soft deletion.
3. Creates an `onUpdate` trigger using the `createOnUpdateTrigger` utility function to automatically update the `updatedAt` column on row modifications.

### `down`
#### Description
This asynchronous function defines the steps to downgrade the database schema by reverting the changes made in the `up` function.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| knex | Knex | A Knex.js instance connected to the database. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Promise\&lt;void\&gt; | Promise | A promise that resolves when the migration is complete. |

#### Internal Logic
1. Drops the `ProjectBot` table if it exists using `knex.schema.dropTableIfExists`.
2. Drops the `onUpdate` trigger created in the `up` function using the `dropOnUpdateTrigger` utility function.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| knex      | Provides the query builder and schema building functionalities for interacting with the PostgreSQL database. | 
