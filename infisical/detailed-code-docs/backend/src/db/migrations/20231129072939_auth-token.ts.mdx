---
title: "20231129072939_auth-token.ts"
---

## High-level description
This code defines a database migration script using Knex.js to create a table named "auth_tokens" for storing authentication tokens. It includes columns for token details, user association, and timestamps.

## References
- `TableName`: This symbol is referenced but not defined in the provided code. It's assumed to be an enum or constant defining table names used in the application's database schema.

## Symbols

### `up`
#### Description
This asynchronous function is executed when running database migrations to apply changes. It checks if the "auth_tokens" table exists and creates it if it doesn't, defining its columns and constraints.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| knex | Knex | A Knex.js instance providing database connection and schema building capabilities. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Promise\&lt;void\&gt; | Promise | A promise that resolves when the migration is complete. |

#### Internal Logic
1. Checks if a table named `auth_tokens` exists in the database.
2. If the table doesn't exist, it creates the table with the following columns:
    - `id`: A UUID primary key column with a default value generated by the database.
    - `type`: A string column for storing the token type (not nullable).
    - `phoneNumber`: A string column for storing the associated phone number.
    - `tokenHash`: A string column for storing the hashed token value (not nullable).
    - `triesLeft`: An integer column for tracking remaining login attempts.
    - `expiresAt`: A datetime column indicating the token's expiration time (not nullable).
    - `created_at`, `updated_at`, `deleted_at`: Timestamp columns for tracking creation, modification, and soft deletion.
    - `userId`: A UUID column referencing the `id` column in the `users` table, establishing a foreign key relationship with cascade deletion.

### `down`
#### Description
This asynchronous function is executed when rolling back database migrations to revert changes. It drops the "auth_tokens" table if it exists.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| knex | Knex | A Knex.js instance providing database connection and schema building capabilities. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Promise\&lt;void\&gt; | Promise | A promise that resolves when the migration rollback is complete. |

#### Internal Logic
1. Drops the `auth_tokens` table if it exists in the database.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| knex | Provides database connection and schema building capabilities for running migrations. |
