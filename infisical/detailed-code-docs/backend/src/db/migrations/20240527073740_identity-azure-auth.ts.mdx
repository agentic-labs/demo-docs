---
title: "20240527073740_identity-azure-auth.ts"
---

## High-level description
This code defines database migration scripts for managing the `IdentityAzureAuth` table in a PostgreSQL database using Knex.js. The `up` function creates the table and associated triggers if they don't exist, while the `down` function drops the table and triggers.

## References
- `TableName`: An enum likely defining all table names in the database schema.
- `createOnUpdateTrigger`: A utility function to create a trigger for updating the `updatedAt` column on row updates.
- `dropOnUpdateTrigger`: A utility function to drop the trigger created by `createOnUpdateTrigger`.

## Symbols

### `up`
#### Description
Creates the `IdentityAzureAuth` table if it doesn't exist and sets up an update trigger for the `updatedAt` column.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| knex | Knex | A Knex.js instance connected to the database. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| void | void | This function does not return a value. |

#### Internal Logic
1. Checks if the `IdentityAzureAuth` table already exists.
2. If not, creates the table with the following columns:
    - `id`: UUID primary key with a default value generated by the database.
    - `accessTokenTTL`, `accessTokenMaxTTL`, `accessTokenNumUsesLimit`: Big integer columns for access token settings.
    - `accessTokenTrustedIps`: JSONB column for storing trusted IP addresses.
    - `createdAt`, `updatedAt`: Timestamp columns for tracking creation and modification times.
    - `identityId`: UUID foreign key referencing the `Identity` table, ensuring data integrity.
    - `tenantId`, `resource`, `allowedServicePrincipalIds`: String columns for Azure AD authentication details.
3. Calls `createOnUpdateTrigger` to set up a trigger for automatically updating the `updatedAt` column on row modifications.

### `down`
#### Description
Drops the `IdentityAzureAuth` table and its associated update trigger if they exist.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| knex | Knex | A Knex.js instance connected to the database. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| void | void | This function does not return a value. |

#### Internal Logic
1. Calls `knex.schema.dropTableIfExists` to safely drop the `IdentityAzureAuth` table if it exists.
2. Calls `dropOnUpdateTrigger` to remove the update trigger associated with the table.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| knex      | Provides a connection to the PostgreSQL database and facilitates schema migration. |

## Side Effects
- Modifies the database schema by creating or dropping the `IdentityAzureAuth` table and its associated trigger.
