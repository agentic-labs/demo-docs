---
title: "20240503101144_audit-log-stream.ts"
---

## High-level description
This code defines a database migration script using Knex.js to create a table named `AuditLogStream` for storing audit log data, including encrypted headers and organization ID. It also sets up an "on update" trigger for the table.

## References
- `TableName`: An enum or object defining table names, likely imported from `../schemas`.
- `createOnUpdateTrigger`, `dropOnUpdateTrigger`: Utility functions for managing triggers, imported from `../utils`.

## Symbols
### `up`
#### Description
This asynchronous function defines the actions to perform when applying the migration. It checks if the `AuditLogStream` table exists and creates it if not, defining columns for ID, URL, encrypted headers (ciphertext, IV, tag, algorithm, key encoding), organization ID (with a foreign key constraint), and timestamps. It then sets up an "on update" trigger for the table.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| knex | Knex | A Knex.js instance for interacting with the database. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Promise\&lt;void\&gt; | Promise | A promise that resolves when the migration is applied. |

#### Internal Logic
1. Checks if the `AuditLogStream` table exists using `knex.schema.hasTable`.
2. If the table doesn't exist, creates it using `knex.schema.createTable` with the defined columns and constraints.
3. Calls `createOnUpdateTrigger` to set up the "on update" trigger for the table.

### `down`
#### Description
This asynchronous function defines the actions to perform when reverting the migration. It drops the "on update" trigger associated with the `AuditLogStream` table and then drops the table itself.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| knex | Knex | A Knex.js instance for interacting with the database. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Promise\&lt;void\&gt; | Promise | A promise that resolves when the migration is reverted. |

#### Internal Logic
1. Calls `dropOnUpdateTrigger` to remove the "on update" trigger from the table.
2. Drops the `AuditLogStream` table using `knex.schema.dropTableIfExists`.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| knex | Provides database interaction functionality for creating tables and managing migrations. |

## Error Handling
The code relies on the error handling mechanisms provided by Knex.js. If any database operation fails, Knex will throw an error, which can be caught and handled by the calling code.
