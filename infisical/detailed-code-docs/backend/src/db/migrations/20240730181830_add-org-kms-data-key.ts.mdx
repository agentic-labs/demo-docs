---
title: "20240730181830_add-org-kms-data-key.ts"
---

## High-level description
This code defines a database migration script that adds a new column named `kmsEncryptedDataKey` to the `Organization` table if it doesn't already exist. This column likely stores an encrypted data key used for encrypting sensitive data related to an organization.

## References
- `TableName`: This symbol is likely an enum or a constant that defines the names of database tables used in the application.

## Symbols
### `up`
#### Description
This function defines the actions to be performed when applying the migration. It checks if the `kmsEncryptedDataKey` column already exists in the `Organization` table. If not, it adds the column as a binary data type.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| knex | Knex | A Knex.js connection object used to interact with the database. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Promise&lt;void&gt; | Promise | A promise that resolves when the migration is applied successfully. |

#### Internal Logic
1. Checks if the `kmsEncryptedDataKey` column exists in the `Organization` table using `knex.schema.hasColumn`.
2. If the column doesn't exist, it adds the column to the table using `knex.schema.alterTable` and `tb.binary`.

### `down`
#### Description
This function defines the actions to be performed when reverting the migration. It checks if the `kmsEncryptedDataKey` column exists in the `Organization` table. If it does, it drops the column.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| knex | Knex | A Knex.js connection object used to interact with the database. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Promise&lt;void&gt; | Promise | A promise that resolves when the migration is reverted successfully. |

#### Internal Logic
1. Checks if the `kmsEncryptedDataKey` column exists in the `Organization` table using `knex.schema.hasColumn`.
2. If the column exists, it drops the column from the table using `knex.schema.alterTable` and `t.dropColumn`.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| Knex | A SQL query builder for Node.js used to interact with the database. |
