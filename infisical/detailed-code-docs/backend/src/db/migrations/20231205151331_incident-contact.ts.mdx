---
title: "20231205151331_incident-contact.ts"
---

## High-level description
This code defines a database migration script using Knex.js to manage changes to the database schema. Specifically, it creates a new table named "IncidentContact" if it doesn't exist, defines its columns and constraints, and sets up an update trigger. It also handles the rollback of these changes during a migration downgrade.

## References
- `TableName`: An enum or object defining table names used in the database schema.
- `createOnUpdateTrigger`: A utility function to create a trigger that updates timestamps on row updates.
- `dropOnUpdateTrigger`: A utility function to drop the update trigger.

## Symbols
### `up`
#### Description
This asynchronous function defines the actions to perform when applying the migration (moving the database schema up). It checks if the "IncidentContact" table exists and creates it if not, defining its columns and constraints. It also sets up an update trigger for the table.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| knex | Knex | An instance of Knex.js, providing database connection and schema building capabilities. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Promise&lt;void&gt; | Promise | A promise that resolves when the migration is applied successfully. |

#### Internal Logic
1. Checks if the "IncidentContact" table exists using `knex.schema.hasTable`.
2. If the table doesn't exist:
    - Creates the table using `knex.schema.createTable`.
    - Defines columns for `id`, `email`, `createdAt`, `updatedAt`, and `orgId`.
    - Sets the `id` column as a UUID primary key with a default value generated by `knex.fn.uuid()`.
    - Sets the `email` column as a non-nullable string.
    - Sets up timestamps for `createdAt` and `updatedAt` with automatic tracking.
    - Defines `orgId` as a UUID and sets a foreign key constraint referencing the `id` column in the `Organization` table with cascade delete behavior.
3. Calls `createOnUpdateTrigger` to set up an update trigger for the "IncidentContact" table.

### `down`
#### Description
This asynchronous function defines the actions to perform when rolling back the migration (reverting the database schema). It drops the "IncidentContact" table if it exists and removes the associated update trigger.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| knex | Knex | An instance of Knex.js, providing database connection and schema building capabilities. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Promise&lt;void&gt; | Promise | A promise that resolves when the migration rollback is complete. |

#### Internal Logic
1. Drops the "IncidentContact" table if it exists using `knex.schema.dropTableIfExists`.
2. Calls `dropOnUpdateTrigger` to remove the update trigger associated with the "IncidentContact" table.
