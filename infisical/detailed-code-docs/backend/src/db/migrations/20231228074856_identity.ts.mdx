---
title: "20231228074856_identity.ts"
---

## High-level description
This code defines a database migration script using Knex.js to manage changes to the database schema. Specifically, it handles the creation and deletion of the "Identity" table, which seems to store information about user identities and their authentication methods.

## References
- `TableName`: This likely refers to an enum or constant that defines the names of different tables in the database schema.
- `createOnUpdateTrigger`: This function is likely defined elsewhere and is responsible for creating a database trigger that updates a timestamp whenever a row in the "Identity" table is updated.
- `dropOnUpdateTrigger`: This function is likely defined elsewhere and is responsible for dropping the update trigger associated with the "Identity" table.

## Symbols

### `up`
#### Description
This asynchronous function defines the actions to perform when upgrading the database schema (running the migration). It checks if the "Identity" table exists and creates it if it doesn't. It also sets up an update trigger on the table.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| knex | Knex | A Knex.js instance providing database connection and schema building capabilities. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
|  | Promise\&lt;void\&gt; | A promise that resolves when the migration is complete. |

#### Internal Logic
1. Checks if the "Identity" table exists using `knex.schema.hasTable`.
2. If the table doesn't exist, creates it using `knex.schema.createTable` with the following columns:
    - `id`: A UUID primary key with a default value generated by the database.
    - `name`: A string column that is not nullable.
    - `authMethod`: A string column that likely stores the authentication method used.
    - `created_at`, `updated_at`, `deleted_at`: Timestamp columns for tracking creation, updates, and soft deletions.
3. Calls `createOnUpdateTrigger` to set up the update trigger on the "Identity" table.

### `down`
#### Description
This asynchronous function defines the actions to perform when rolling back the database schema (reverting the migration). It drops the "Identity" table if it exists and removes the associated update trigger.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| knex | Knex | A Knex.js instance providing database connection and schema building capabilities. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
|  | Promise\&lt;void\&gt; | A promise that resolves when the migration rollback is complete. |

#### Internal Logic
1. Drops the "Identity" table if it exists using `knex.schema.dropTableIfExists`.
2. Calls `dropOnUpdateTrigger` to remove the update trigger associated with the "Identity" table.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| knex | Provides database connection and schema building capabilities for the migration. |
