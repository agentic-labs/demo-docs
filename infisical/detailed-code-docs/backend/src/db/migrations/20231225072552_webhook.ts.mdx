---
title: "20231225072552_webhook.ts"
---

## High-level description
This code defines database migration scripts for managing the `Webhook` table. It includes functions for both upgrading (`up`) and downgrading (`down`) the table schema. The `Webhook` table stores information about webhooks, including their URL, security settings, and status.

## References
This code references the following symbols from other files:

* `TableName`: An enum or object that likely defines table names used in the application.
* `createOnUpdateTrigger`: A function that probably sets up a database trigger to automatically update timestamps on row changes.
* `dropOnUpdateTrigger`: A function that likely drops the previously mentioned update trigger.

## Symbols

### `up`
#### Description
This asynchronous function defines the steps to upgrade the database schema to include the `Webhook` table. If the table doesn't exist, it's created with the specified columns. It also sets up an update trigger for the table.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| knex | Knex | A Knex client instance for interacting with the database. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| None | void | This function does not return any value. |

#### Internal Logic
1. Checks if the `Webhook` table already exists using `knex.schema.hasTable`.
2. If the table doesn't exist, it creates it using `knex.schema.createTable` with the following columns:
    - `id`: A UUID primary key with a default value generated by the database.
    - `secretPath`: A string representing a secret path, not nullable, defaults to "/".
    - `url`: A string representing the webhook URL, not nullable.
    - `lastStatus`: A string representing the last status of the webhook.
    - `lastRunErrorMessage`: Text field for storing the last error message.
    - `isDisabled`: A boolean indicating if the webhook is disabled, defaults to false, not nullable.
    - `encryptedSecretKey`, `iv`, `tag`, `algorithm`, `keyEncoding`: Fields related to webhook signature and encryption.
    - `createdAt`, `updatedAt`, `deletedAt`: Timestamps for tracking creation, updates, and deletion.
    - `envId`: A UUID representing the environment ID, not nullable, references the `Environment` table with a cascading delete constraint.
3. Calls `createOnUpdateTrigger` to set up an update trigger for the `Webhook` table.

### `down`
#### Description
This asynchronous function defines the steps to downgrade the database schema by reverting the changes made in the `up` function. It drops the `Webhook` table if it exists and removes the associated update trigger.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| knex | Knex | A Knex client instance for interacting with the database. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| None | void | This function does not return any value. |

#### Internal Logic
1. Drops the `Webhook` table if it exists using `knex.schema.dropTableIfExists`.
2. Calls `dropOnUpdateTrigger` to remove the update trigger associated with the `Webhook` table.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| knex       | Provides a connection to the database and methods for schema migration. |
