---
title: "20240111051011_secret-scanning.ts"
---

## High-level description
This code defines a database migration script using Knex. It creates three tables related to secret scanning, Git app installations, and organizations if they don't exist. It also sets up triggers to update timestamps on these tables.

## Code Structure
The code defines two asynchronous functions, `up` and `down`, responsible for migrating the database schema up or down, respectively. Both functions utilize Knex to interact with the database and perform operations like creating tables, defining columns, and setting up foreign key constraints.

## References
This code references several symbols from other files:
- `Knex`:  Likely a type definition for the Knex query builder.
- `TableName`: An enum or object defining database table names.
- `createOnUpdateTrigger`: A utility function to create a trigger for updating timestamps on table updates.
- `dropOnUpdateTrigger`: A utility function to drop the update timestamp trigger.

## Symbols
### `up`
#### Description
This asynchronous function is responsible for applying the migration to the database. It creates three tables (`GitAppInstallSession`, `GitAppOrg`, and `SecretScanningGitRisk`) if they don't exist and sets up triggers for updating timestamps on these tables.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| knex | Knex | An instance of the Knex query builder. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| - | Promise&lt;void&gt; | A promise that resolves when the migration is complete. |

#### Internal Logic
1. **Check for Table Existence:** It first checks if each table already exists in the database using `knex.schema.hasTable`.
2. **Create Tables:** If a table doesn't exist, it creates it using `knex.schema.createTable` and defines its columns and constraints.
3. **Create Triggers:** After creating each table, it calls `createOnUpdateTrigger` to set up a trigger for updating timestamps on updates to that table.

### `down`
#### Description
This asynchronous function is responsible for reverting the migration. It drops the three tables created by the `up` function and removes the associated update timestamp triggers.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| knex | Knex | An instance of the Knex query builder. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| - | Promise&lt;void&gt; | A promise that resolves when the migration is reverted. |

#### Internal Logic
1. **Drop Tables:** It attempts to drop each of the three tables using `knex.schema.dropTableIfExists`.
2. **Drop Triggers:** It calls `dropOnUpdateTrigger` for each table to remove the associated update timestamp triggers.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| knex       | Provides the query builder for interacting with the database. |

## Error Handling
The code does not implement specific error handling beyond what Knex provides. Any errors during the migration process will likely be thrown and need to be handled by the calling code.
