---
title: "user-dal.ts"
---

## High-level description
The `user-dal.ts` file defines a factory function `userDALFactory` that creates a Data Access Layer (DAL) for interacting with user-related data in the database. This DAL provides functions for finding, creating, and updating user information, as well as managing user encryption keys and actions.

## Code Structure
The `userDALFactory` function returns an object containing various functions that interact with the database using Knex.js. These functions are grouped logically based on their functionality, such as finding users, managing encryption keys, and handling user actions.

## Symbols
### `userDALFactory`
#### Description
This factory function creates and returns a user DAL object with functions for accessing and managing user data in the database.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| db | `TDbClient` | A Knex.js database client instance. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| userDAL | `TUserDALFactory` | An object containing functions for interacting with user data. |

#### Internal Logic
The function initializes an ORM instance for the `Users` table and defines several asynchronous functions for:
- Finding users by username.
- Getting users based on filter criteria (limit, offset, search term, sort by).
- Finding user encryption keys by username, user IDs (batch and single), and project membership ID.
- Finding users by project membership IDs.
- Creating and updating user encryption keys.
- Upserting user encryption keys.
- Finding, creating, and updating user actions.

Each function uses Knex.js to query the database and returns the result. Error handling is implemented using `DatabaseError` for database-related errors.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| knex | Database query builder. |
| @app/db | Database schemas and types. |
| @app/lib/errors | Custom error classes. |
| @app/lib/knex | Utility functions for Knex.js. |

## Error Handling
The code uses the `DatabaseError` class from `@app/lib/errors` to wrap database-related errors and provide more context.
