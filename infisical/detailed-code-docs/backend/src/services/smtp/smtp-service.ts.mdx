---
title: "smtp-service.ts"
---

## High-level description
The `smtp-service.ts` file defines a factory function `smtpServiceFactory` that creates an SMTP service for sending emails. It uses the `nodemailer` library to handle email sending and `handlebars` for templating. The service can be configured to use different SMTP providers and supports sending various types of emails based on predefined templates.

## Code Structure
The code defines several types and enums related to SMTP configuration and email sending. The `smtpServiceFactory` function takes an SMTP configuration object as input and returns an object with a `sendMail` function. The `sendMail` function handles template rendering, email composition, and sending using the configured SMTP transport.

## Symbols

### `TSmtpConfig`
#### Description
A type alias for the `nodemailer` SMTP transport options. It defines the configuration for the SMTP server.

#### Inputs
None

#### Outputs
None

### `TSmtpSendMail`
#### Description
A type that defines the data required to send an email.

#### Inputs
None

#### Outputs
None

### `TSmtpService`
#### Description
A type alias for the return type of the `smtpServiceFactory` function. It represents the SMTP service object.

#### Inputs
None

#### Outputs
None

### `SmtpTemplates`
#### Description
An enum that defines the available email templates.

#### Inputs
None

#### Outputs
None

### `SmtpHost`
#### Description
An enum that defines the supported SMTP host providers.

#### Inputs
None

#### Outputs
None

### `smtpServiceFactory`
#### Description
A factory function that creates an SMTP service object. It takes an SMTP configuration object as input and returns an object with a `sendMail` function.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| cfg | `TSmtpConfig` | The SMTP configuration object. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| sendMail | `function` | A function that sends an email. |

#### Internal Logic
1. Creates a `nodemailer` SMTP transport using the provided configuration.
2. Defines a `sendMail` function that takes an object of type `TSmtpSendMail` as input.
3. Reads the specified email template from the `templates` directory.
4. Compiles the template using `handlebars`.
5. Renders the template with the provided substitutions.
6. Sends the email using the configured SMTP transport if SMTP is enabled.
7. If SMTP is not enabled, logs the email details to the console.

### `sendMail`
#### Description
A function that sends an email using the configured SMTP transport.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| substitutions | `object` | An object containing the substitutions for the email template. |
| recipients | `string[]` | An array of recipient email addresses. |
| template | `SmtpTemplates` | The email template to use. |
| subjectLine | `string` | The subject line of the email. |

#### Outputs
None

#### Internal Logic
1. Reads the specified email template from the `templates` directory.
2. Compiles the template using `handlebars`.
3. Renders the template with the provided substitutions.
4. Sends the email using the configured SMTP transport if SMTP is enabled.
5. If SMTP is not enabled, logs the email details to the console.

## Side Effects
The `sendMail` function sends an email using the configured SMTP transport.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| `node:fs/promises` | Used for reading email templates from the file system. |
| `node:path` | Used for resolving file paths. |
| `handlebars` | Used for templating email content. |
| `nodemailer` | Used for sending emails. |
| `@app/lib/config/env` | Used for retrieving application configuration. |
| `@app/lib/logger` | Used for logging. |

```

```