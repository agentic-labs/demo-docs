---
title: "secret-import-service.ts"
---

## High-level description
This file defines the `secretImportServiceFactory`, which creates a service for managing secret imports in a project. It handles operations like creating, updating, deleting, and retrieving secret imports, as well as managing secret replication and synchronization.

## Code Structure
The `secretImportServiceFactory` function takes various dependencies as input and returns an object with methods for different secret import operations. These methods interact with multiple DAL (Data Access Layer) objects and other services to perform their tasks.

## Symbols

### secretImportServiceFactory
#### Description
This function creates and returns a service object for managing secret imports.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| secretImportDAL | TSecretImportDALFactory | Data access layer for secret imports |
| projectEnvDAL | TProjectEnvDALFactory | Data access layer for project environments |
| permissionService | Pick&lt;TPermissionServiceFactory, "getProjectPermission"&gt; | Service for handling permissions |
| folderDAL | TSecretFolderDALFactory | Data access layer for secret folders |
| projectDAL | Pick&lt;TProjectDALFactory, "checkProjectUpgradeStatus"&gt; | Data access layer for projects |
| secretDAL | Pick&lt;TSecretDALFactory, "find"&gt; | Data access layer for secrets |
| secretQueueService | Pick&lt;TSecretQueueFactory, "syncSecrets" \| "replicateSecrets"&gt; | Service for secret queue operations |
| licenseService | Pick&lt;TLicenseServiceFactory, "getPlan"&gt; | Service for license-related operations |
| projectBotService | Pick&lt;TProjectBotServiceFactory, "getBotKey"&gt; | Service for project bot operations |
| secretV2BridgeDAL | Pick&lt;TSecretV2BridgeDALFactory, "find"&gt; | Data access layer for secret v2 bridge |
| kmsService | Pick&lt;TKmsServiceFactory, "createCipherPairWithDataKey"&gt; | Service for KMS operations |

#### Outputs
Returns an object with methods for managing secret imports:
- createImport
- updateImport
- deleteImport
- getImports
- getSecretsFromImports
- getRawSecretsFromImports
- resyncSecretImportReplication
- fnSecretsFromImports

#### Internal Logic
The factory function sets up various methods that handle different aspects of secret import management. These methods typically involve:
1. Checking permissions
2. Validating input data
3. Interacting with the database through DAL objects
4. Performing necessary operations (e.g., creating, updating, or deleting imports)
5. Triggering related actions (e.g., syncing or replicating secrets)

### createImport
#### Description
Creates a new secret import.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| environment | string | The environment for the import |
| data | object | Import data including path and environment |
| actor | string | The actor performing the action |
| actorId | string | The ID of the actor |
| actorOrgId | string | The organization ID of the actor |
| actorAuthMethod | string | The authentication method of the actor |
| projectId | string | The project ID |
| isReplication | boolean | Whether this is a replication import |
| path | string | The path for the import |

#### Outputs
Returns the created secret import object.

#### Internal Logic
1. Checks permissions for creating imports
2. Validates the project upgrade status
3. Finds the relevant folder and environment
4. Creates the import in the database
5. Triggers secret replication or synchronization based on the import type

### updateImport
#### Description
Updates an existing secret import.

#### Inputs
Similar to createImport, with additional `id` parameter for the import to update.

#### Outputs
Returns the updated secret import object.

#### Internal Logic
1. Checks permissions for updating imports
2. Finds the relevant folder and import
3. Validates for cyclic imports
4. Updates the import in the database
5. Adjusts positions of other imports if necessary

### deleteImport
#### Description
Deletes a secret import.

#### Inputs
Similar to updateImport, but only requires `id`, `path`, `environment`, `projectId`, and actor information.

#### Outputs
Returns the deleted secret import object.

#### Internal Logic
1. Checks permissions for deleting imports
2. Finds the relevant folder and import
3. Deletes the import from the database
4. Adjusts positions of other imports
5. Triggers secret synchronization

### getImports, getSecretsFromImports, getRawSecretsFromImports
These methods retrieve secret imports or secrets from imports, with varying levels of detail and processing.

## Dependencies
The service relies on various DAL objects and other services, including permission service, license service, and queue service.

## Error Handling
The service uses custom error classes like `BadRequestError` and `ForbiddenError` for handling and throwing specific error scenarios.

## Performance Considerations
The service includes transaction handling for database operations that require multiple steps, ensuring data consistency.