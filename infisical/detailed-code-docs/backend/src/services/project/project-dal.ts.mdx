---
title: "project-dal.ts"
---

## High-level description
The `project-dal.ts` file defines a factory function `projectDALFactory` that creates a Data Access Layer (DAL) for interacting with project-related data in the database. This DAL provides methods for retrieving, updating, and managing project data, including associated environments and organization information.

## Code Structure
The `projectDALFactory` function returns an object containing various functions that interact with the database using Knex.js. These functions include methods for finding projects based on different criteria, setting project upgrade status, and retrieving project details.

## References
This code references the following symbols from other files:

- `TDbClient` from `@app/db`
- `ProjectsSchema`, `ProjectUpgradeStatus`, `ProjectVersion`, `TableName`, `TProjectsUpdate` from `@app/db/schemas`
- `BadRequestError`, `DatabaseError` from `@app/lib/errors`
- `ormify`, `selectAllTableCols`, `sqlNestRelationships` from `@app/lib/knex`
- `Filter`, `ProjectFilterType` from "./project-types"

## Symbols

### `projectDALFactory`
#### Description
This factory function creates and returns a Project DAL object, which encapsulates database operations related to projects.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| db | `TDbClient` | A Knex.js database client instance. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| projectDAL | `TProjectDALFactory` | An object containing functions for interacting with project data in the database. |

#### Internal Logic
The function initializes an ORM instance for the `Project` table and defines several asynchronous functions for various database operations:

- `findAllProjects`: Retrieves all projects associated with a given user ID, including their environments.
- `findProjectGhostUser`: Finds the ghost user associated with a specific project.
- `setProjectUpgradeStatus`: Updates the upgrade status of a project.
- `findAllProjectsByIdentity`: Retrieves all projects associated with a given identity ID.
- `findProjectById`: Retrieves a project by its ID, including its environments.
- `findProjectBySlug`: Retrieves a project by its slug and organization ID, including its environments.
- `findProjectByFilter`: Retrieves a project based on a provided filter, which can be by ID or slug.
- `checkProjectUpgradeStatus`: Checks the upgrade status of a project and throws an error if an upgrade is in progress.
- `findProjectWithOrg`: Retrieves a project by its ID, including its organization information.

Each function uses Knex.js to query the database and returns the retrieved data, often after parsing it using Zod schemas and nesting relationships using the `sqlNestRelationships` utility. Error handling is implemented using try-catch blocks, throwing `DatabaseError` or `BadRequestError` as appropriate.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| knex | Database query builder and client |
| @app/db | Database client and schema definitions |
| @app/lib/errors | Custom error classes |
| @app/lib/knex | Knex.js utility functions |

## Error Handling
The code utilizes try-catch blocks within each function to handle potential database errors. If an error occurs during a database operation, a `DatabaseError` is thrown, providing context about the failed operation. Additionally, `BadRequestError` is used to handle invalid input or conditions, such as missing organization ID when querying by slug.
