---
title: "Overview"
---

## High-level description
This directory contains the implementation of the Identity Universal Authentication (UA) service for the backend. It provides functionality for managing user authentication, including client secrets, access tokens, and identity-related operations. The service is responsible for handling login, attaching/updating/revoking Universal Auth to identities, and managing client secrets associated with Universal Auth.

## What does it do?
The Identity UA service performs several key functions:

1. User Authentication: It allows users to log in using a client ID and secret, verifying credentials and managing access tokens.

2. Identity Management: The service enables attaching, updating, and revoking Universal Auth configurations for identities.

3. Client Secret Management: It provides functionality to create, retrieve, and revoke client secrets associated with Universal Auth identities.

4. Access Control: The service implements various authorization checks to ensure that only authorized actors can perform certain operations.

5. IP Management: It handles IP allowlisting and blocklisting for both client secrets and access tokens.

6. Database Interactions: The service interacts with multiple database tables to store and retrieve identity, authentication, and organization-related data.

7. License and Permission Checks: It integrates with license and permission services to enforce plan-specific features and access controls.

## Entry points
The main entry point for this service is the `identityUaServiceFactory` function in the `identity-ua-service.ts` file. This factory function creates and returns an object containing various methods for interacting with the Identity UA service. These methods include:

- `login`: Authenticates a user and generates an access token
- `attachUniversalAuth`: Adds Universal Auth configuration to an existing identity
- `updateUniversalAuth`: Modifies existing Universal Auth settings for an identity
- `getIdentityUniversalAuth`: Retrieves Universal Auth configuration for an identity
- `revokeIdentityUniversalAuth`: Removes Universal Auth configuration from an identity
- `createUniversalAuthClientSecret`: Generates a new client secret for a Universal Auth identity
- `getUniversalAuthClientSecrets`: Retrieves all client secrets for a Universal Auth identity
- `revokeUniversalAuthClientSecret`: Revokes a specific client secret
- `getUniversalAuthClientSecretById`: Retrieves a specific client secret by its ID

The service relies on several Data Access Layer (DAL) factories to interact with the database:

- `identityUaDALFactory`: Manages the `IdentityUniversalAuth` table
- `identityUaClientSecretDALFactory`: Handles operations related to client secrets

## Key Files
1. `identity-ua-service.ts`: Contains the main service logic, including the `identityUaServiceFactory` function.

2. `identity-ua-dal.ts`: Defines the data access layer for the `IdentityUniversalAuth` table.

3. `identity-ua-client-secret-dal.ts`: Implements the data access layer for managing client secrets, including functions for incrementing usage counts and removing expired secrets.

4. `identity-ua-types.ts`: Defines TypeScript types used throughout the service, including DTOs for various operations.

## Dependencies
The Identity UA service relies on several external libraries and internal modules:

1. Knex: Used for database interactions and query building.
2. @app/lib/casl: Provides the `isAtLeastAsPrivileged` function for authorization checks.
3. @app/lib/config/env: Used to access application configuration.
4. @app/lib/errors: Defines custom error classes used in the service.
5. @app/lib/ip: Provides IP address utility functions.
6. @app/ee/services/license/license-service: Used for license-related checks.
7. @app/ee/services/permission/permission-service: Handles permission-related operations.

Internal dependencies include various DAL factories and types from related services such as identity, identity access token, and identity organization membership.

## Configuration
The service uses configuration values from the application's environment, accessed through the `getConfig` function. Key configuration items include:

- Maximum access token TTL
- IP allowlisting settings (determined by the license plan)
- Database-related settings (implicitly used through the DAL factories)

The service also relies on configuration from the license service to determine feature availability based on the organization's plan.

In summary, the Identity UA service provides a comprehensive solution for managing user authentication and identity-related operations in the backend, integrating with various other services and enforcing security and access control measures.