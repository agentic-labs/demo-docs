---
title: "secret-scanning-queue.ts"
---

## High-level description
This code defines a factory function `secretScanningQueueFactory` that creates and manages queues for scanning GitHub repositories for secrets. It uses two queues: `SecretPushEventScan` for scanning individual pushes and `SecretFullRepoScan` for scanning entire repositories. 

The factory sets up queue listeners that process jobs, scan code using `scanContentAndGetFindings` and `scanFullRepoContentAndGetFindings`, store findings in the database, and send email notifications if secrets are found.

## Code Structure
The `secretScanningQueueFactory` function takes dependencies as an argument and returns an object with two functions: `startFullRepoScan` and `startPushEventScan`. These functions enqueue jobs for full repository scans and push event scans, respectively. The factory also sets up listeners for both queues that process jobs, perform secret scanning, and handle results.

## References
- `@app/queue`: Provides queue-related functionalities like `QueueJobs`, `QueueName`, and `TQueueServiceFactory`.
- `@app/services/secret-scanning/secret-scanning-dal`: Provides data access layer functions for secret scanning, accessed via `TSecretScanningDALFactory`.
- `@app/services/smtp/smtp-service`: Provides email sending functionality via `TSmtpService`.
- `@app/services/telemetry/telemetry-service`: Provides telemetry tracking functionality via `TTelemetryServiceFactory`.
- `./secret-scanning-fns`: Provides functions for scanning code content for secrets: `scanContentAndGetFindings` and `scanFullRepoContentAndGetFindings`.

## Symbols

### `secretScanningQueueFactory`
#### Description
This factory function initializes and configures queues for secret scanning. It sets up listeners for processing jobs, scanning code, storing findings, and sending notifications.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| queueService | `TQueueServiceFactory` | Factory for creating and managing queues. |
| secretScanningDAL | `TSecretScanningDALFactory` | Factory for accessing the secret scanning data access layer. |
| smtpService | `Pick&lt;TSmtpService, "sendMail"&gt;` | Service for sending email notifications. |
| orgMembershipDAL | `Pick&lt;TOrgDALFactory, "findMembership"&gt;` | Data access layer for organization memberships. |
| telemetryService | `Pick&lt;TTelemetryServiceFactory, "sendPostHogEvents"&gt;` | Service for sending telemetry events. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| startFullRepoScan | `(payload: TScanFullRepoEventPayload) =&gt; Promise&lt;void&gt;` | Function to enqueue a full repository scan job. |
| startPushEventScan | `(payload: TScanPushEventPayload) =&gt; Promise&lt;void&gt;` | Function to enqueue a push event scan job. |

#### Internal Logic
1. **Queue Setup:** Defines two queues using `queueService`: `SecretPushEventScan` and `SecretFullRepoScan`.
2. **Listeners:** Sets up listeners for both queues using `queueService.start` and `queueService.listen`.
3. **Job Processing:** 
    - Retrieves job data containing repository information, installation ID, etc.
    - Uses `scanContentAndGetFindings` or `scanFullRepoContentAndGetFindings` to scan code for secrets.
    - Stores findings in the database using `secretScanningDAL`.
    - Sends email notifications to organization admins and the pusher if secrets are found using `smtpService`.
    - Sends telemetry events using `telemetryService`.

### `startFullRepoScan`
#### Description
Enqueues a job to perform a full scan of a GitHub repository for secrets.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| payload | `TScanFullRepoEventPayload` | Data for the full repository scan job, including organization ID, repository information, and installation ID. |

#### Outputs
This function does not return any value.

#### Internal Logic
1. Enqueues a job with the provided `payload` into the `SecretFullRepoScan` queue using `queueService.queue`.
2. Sets up retry attempts, backoff strategy, and removal policies for the job.

### `startPushEventScan`
#### Description
Enqueues a job to scan a specific push event in a GitHub repository for secrets.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| payload | `TScanPushEventPayload` | Data for the push event scan job, including organization ID, commits, pusher information, repository information, and installation ID. |

#### Outputs
This function does not return any value.

#### Internal Logic
1. Enqueues a job with the provided `payload` into the `SecretPushEventScan` queue using `queueService.queue`.
2. Sets up retry attempts, backoff strategy, and removal policies for the job.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| `@app/db/schemas` | Provides database schema definitions, including `OrgMembershipRole`. |
| `@app/lib/config/env` | Provides access to environment configuration using `getConfig`. |
| `@app/lib/logger` | Provides logging functionality via the `logger` object. |
| `@app/queue` | Provides queue-related functionalities like `QueueJobs`, `QueueName`, and `TQueueServiceFactory`. |
| `@app/services/org/org-dal` | Provides data access layer functions for organizations, accessed via `TOrgDALFactory`. |
| `@app/services/smtp/smtp-service` | Provides email sending functionality via `TSmtpService`. |
| `@app/services/telemetry/telemetry-service` | Provides telemetry tracking functionality via `TTelemetryServiceFactory`. |
| `@app/services/telemetry/telemetry-types` | Defines telemetry event types, including `PostHogEventTypes`. |
| `probot` | Provides the `ProbotOctokit` class for interacting with the GitHub API. |

## Error Handling
The code implements basic error handling by listening for `failed` events on both queues. When a job fails, it logs the error and job data using the `logger.error` function.

## Logging
The code uses the `logger` object from `@app/lib/logger` to log errors encountered during queue processing. 

## TODOs
There are no TODOs or other notes left in the code.
