---
title: "secret-scanning-fns.ts"
---

## High-level description
The code defines utility functions for interacting with the file system, executing shell commands, and scanning code for secrets using the Infisical CLI. These functions are used to clone repositories, write data to files, run the Infisical scan, and process the findings.

## Code Structure
The code consists of a set of independent utility functions that can be used together to perform secret scanning on a repository or a piece of text content. 

## Symbols
### `createTempFolder`
#### Description
Creates a temporary folder in the operating system's temporary directory.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| tempFolderPath | `Promise&lt;string&gt;` | A promise that resolves with the path to the created temporary folder. |

#### Internal Logic
The function generates a random folder name, creates a directory at the specified path using `mkdir`, and resolves with the path to the created folder.

### `writeTextToFile`
#### Description
Writes the given text content to a file at the specified path.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| filePath | `string` | The path to the file to write to. |
| content | `string` | The text content to write to the file. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
|  | `Promise&lt;void&gt;` | A promise that resolves when the file is written successfully. |

#### Internal Logic
The function uses `writeFile` to write the content to the file and resolves the promise when the write operation is complete.

### `cloneRepo`
#### Description
Clones a git repository from GitHub using an installation access token.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| installationAcccessToken | `string` | The GitHub installation access token. |
| repositoryFullName | `string` | The full name of the repository in the format `owner/repo`. |
| repoPath | `string` | The local path to clone the repository to. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
|  | `Promise&lt;void&gt;` | A promise that resolves when the repository is cloned successfully. |

#### Internal Logic
The function constructs the clone URL using the provided access token and repository name. It then executes the `git clone` command using `child_process.exec` and resolves the promise when the command completes successfully.

### `runInfisicalScanOnRepo`
#### Description
Runs the Infisical CLI scan command on a cloned repository.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| repoPath | `string` | The path to the cloned repository. |
| outputPath | `string` | The path to the output file for the scan findings. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
|  | `Promise&lt;void&gt;` | A promise that resolves when the scan is complete. |

#### Internal Logic
The function constructs the Infisical CLI command to run the scan on the repository and writes the output to the specified file. It uses `child_process.exec` to execute the command and resolves the promise when the command completes successfully. The function expects the Infisical CLI to return an exit code of 77 if secrets are found.

### `runInfisicalScan`
#### Description
Runs the Infisical CLI scan command on a text input.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| inputPath | `string` | The path to the file containing the text to scan. |
| outputPath | `string` | The path to the output file for the scan findings. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
|  | `Promise&lt;void&gt;` | A promise that resolves when the scan is complete. |

#### Internal Logic
The function constructs the Infisical CLI command to run the scan on the input text and writes the output to the specified file. It uses `child_process.exec` to execute the command and resolves the promise when the command completes successfully. The function expects the Infisical CLI to return an exit code of 77 if secrets are found.

### `readFindingsFile`
#### Description
Reads the contents of the Infisical scan findings file.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| filePath | `string` | The path to the findings file. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
|  | `Promise&lt;string&gt;` | A promise that resolves with the contents of the findings file. |

#### Internal Logic
The function uses `fs.readFile` to read the contents of the file and resolves the promise with the file data.

### `deleteTempFolder`
#### Description
Deletes the temporary folder and its contents.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| folderPath | `string` | The path to the temporary folder. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
|  | `Promise&lt;void&gt;` | A promise that resolves when the folder is deleted. |

#### Internal Logic
The function uses `fs.rm` with the `recursive` option to delete the folder and its contents.

### `convertKeysToLowercase`
#### Description
Converts the keys of an object to lowercase.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| obj | `T` | The object to convert the keys of. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
|  | `T` | The object with lowercase keys. |

#### Internal Logic
The function iterates over the object's keys and creates a new object with lowercase keys and the same values.

### `scanFullRepoContentAndGetFindings`
#### Description
Clones a repository from GitHub, runs the Infisical scan on it, and returns the findings.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| octokit | `Octokit` | An authenticated Octokit instance for interacting with the GitHub API. |
| installationId | `string` | The installation ID of the GitHub App. |
| repositoryFullName | `string` | The full name of the repository in the format `owner/repo`. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
|  | `Promise&lt;SecretMatch[]&gt;` | A promise that resolves with an array of `SecretMatch` objects representing the scan findings. |

#### Internal Logic
The function first creates a temporary folder, then retrieves an installation access token from GitHub. It then clones the repository to the temporary folder, runs the Infisical scan on the cloned repository, reads the findings file, and finally deletes the temporary folder.

### `scanContentAndGetFindings`
#### Description
Scans a given text content for secrets using the Infisical CLI and returns the findings.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| textContent | `string` | The text content to scan. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
|  | `Promise&lt;SecretMatch[]&gt;` | A promise that resolves with an array of `SecretMatch` objects representing the scan findings. |

#### Internal Logic
The function creates a temporary folder, writes the text content to a file in the temporary folder, runs the Infisical scan on the file, reads the findings file, and finally deletes the temporary folder.
