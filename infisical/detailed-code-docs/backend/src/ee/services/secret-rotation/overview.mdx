---
title: "Overview"
---

## High-level description
This directory contains the implementation of a secret rotation service for the Infisical backend. It provides functionality for automatically updating and rotating secrets for various providers, including databases (MySQL, PostgreSQL), HTTP services (Sendgrid), and AWS IAM. The service manages the creation, execution, and management of secret rotation jobs using a queue system, and includes templates for different rotation scenarios.

## What does it do?
The secret rotation service automates the process of updating and rotating secrets in a secure manner. Here's a simplified explanation of its workflow:

1. It maintains a queue of secret rotation jobs.
2. For each job, it determines the type of secret (database, AWS, HTTP) and the specific rotation steps required based on predefined templates.
3. It creates new credentials or secrets as needed.
4. It updates the necessary systems or services with the new secrets.
5. It verifies that the new secrets are working correctly.
6. Finally, it updates the stored secrets in the Infisical system.

This process helps maintain security by regularly changing sensitive information like passwords and access keys, reducing the risk of unauthorized access due to compromised credentials.

## Entry points
The main entry point for the secret rotation service is the `secretRotationServiceFactory` function in `secret-rotation-service.ts`. This factory function creates the service object with methods for managing secret rotations, including:

- `getProviderTemplates`: Retrieves available provider templates
- `createRotation`: Creates a new secret rotation
- `getByProjectId`: Lists secret rotations for a project
- `restartById`: Restarts a specific secret rotation
- `deleteById`: Deletes a specific secret rotation

The service interacts with other components:

1. `secret-rotation-dal.ts`: Provides data access layer functions for secret rotation operations.
2. `secret-rotation-queue` directory: Implements the queue system for managing rotation jobs.
3. `templates` directory: Contains templates for different types of secret rotations.

## Key Files

1. `secret-rotation-service.ts`: The core service file that orchestrates secret rotation operations.

2. `secret-rotation-dal.ts`: Data Access Layer for secret rotation operations, handling database interactions.

3. `secret-rotation-queue/secret-rotation-queue.ts`: Implements the queue system for managing secret rotation jobs.

4. `secret-rotation-queue/secret-rotation-queue-fn.ts`: Provides utility functions for specific tasks in the secret rotation process.

5. `templates/index.ts`: Combines all rotation templates into a single array for easy access.

6. `templates/aws-iam.ts`, `templates/mysql.ts`, `templates/postgres.ts`, `templates/sendgrid.ts`: Define templates for rotating secrets in specific services.

7. `secret-rotation-types.ts`: Defines TypeScript types used throughout the secret rotation implementation.

## Dependencies
The secret rotation service relies on several external libraries and internal services:

- axios (^1.4.0): Used for making HTTP requests in secret rotation operations.
- jmespath (^0.10.0): Used for querying JSON data in HTTP-based secret rotation operations.
- knex (^2.4.2): Used as a query builder and for database connections in database-related secret rotation tasks.
- @aws-sdk/client-iam: Used for interacting with AWS IAM for AWS-related secret rotations.
- @casl/ability: Used for handling permissions in the secret rotation service.
- Ajv: Used for JSON schema validation in the secret rotation service.

Internal dependencies include various services and data access layers, such as:
- Queue service
- Secret rotation data access layer
- Project bot service
- Secret data access layer
- Key management service
- Telemetry service
- Permission service
- License service
- Project data access layer
- Folder data access layer
- Secret V2 bridge data access layer

## Configuration
The secret rotation service uses environment variables for configuration, accessed through the `@app/lib/config/env` module. Key configurations include:

- Database connection details
- AWS region for IAM operations
- Timeouts for HTTP requests and database operations

The service also uses configuration from the secret rotation templates, which define the specific steps and operations for different types of secret rotations. These templates are stored in the `templates` directory and include configurations for:

- AWS IAM
- MySQL
- PostgreSQL
- Sendgrid

Each template specifies the required inputs, expected outputs, and the structure of API calls or database operations needed for secret rotation.

In summary, this directory implements a crucial security feature for the Infisical backend, providing automated secret rotation capabilities across various types of systems and services. It's designed to be flexible, handling different secret types and rotation scenarios, while maintaining security and consistency throughout the rotation process.