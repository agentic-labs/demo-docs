---
title: "group-dal.ts"
---

## High-level description
This code defines a factory function `groupDALFactory` that creates a data access layer (DAL) for managing groups in a database. It provides methods for finding, creating, and manipulating group data, including operations related to group members.

## Code Structure
The main function `groupDALFactory` takes a database client as input and returns an object with various methods for interacting with group data. It uses the `ormify` function to create basic CRUD operations and extends them with custom query methods.

## Symbols

### `groupDALFactory`
#### Description
A factory function that creates a data access layer for group operations.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| db | TDbClient | The database client used for executing queries |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Object | TGroupDALFactory | An object containing methods for group data operations |

#### Internal Logic
1. Creates a group ORM using the `ormify` function.
2. Defines custom methods for finding groups and group members.
3. Returns an object combining the ORM methods and custom methods.

### `findGroups`
#### Description
Finds groups based on the provided filter and options.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| filter | TFindFilter&lt;TGroups&gt; | Filter criteria for finding groups |
| options | TFindOpt&lt;TGroups&gt; | Options for pagination, sorting, and transaction |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Array | TGroups[] | An array of group objects matching the filter criteria |

#### Internal Logic
1. Constructs a database query using the provided filter and options.
2. Applies pagination and sorting if specified.
3. Executes the query and returns the results.

### `findByOrgId`
#### Description
Finds groups for a specific organization, including custom role information.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| orgId | string | The ID of the organization |
| tx | Knex (optional) | Transaction object for database operations |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Array | Object[] | An array of group objects with custom role information |

#### Internal Logic
1. Constructs a query to join groups with organization roles.
2. Retrieves group data along with custom role information.
3. Transforms the result to include custom role data in each group object.

### `findAllGroupMembers`
#### Description
Finds all members of a specific group within an organization.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| orgId | string | The ID of the organization |
| groupId | string | The ID of the group |
| offset | number (optional) | Pagination offset |
| limit | number (optional) | Pagination limit |
| username | string (optional) | Username filter |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| Array | Object[] | An array of user objects representing group members |

#### Internal Logic
1. Constructs a complex query joining organization memberships, users, and user group memberships.
2. Applies filtering, pagination, and optional username search.
3. Transforms the result to include user information and group membership status.

## Error Handling
The code uses a `DatabaseError` class to wrap and throw any database-related errors that occur during query execution.

## Dependencies
- `@app/db`: Provides database schema and client types
- `@app/lib/errors`: Provides the `DatabaseError` class
- `@app/lib/knex`: Provides utility functions for building queries

This code is part of a larger system for managing groups and memberships within an organization, likely used in conjunction with other services and routes in the application.