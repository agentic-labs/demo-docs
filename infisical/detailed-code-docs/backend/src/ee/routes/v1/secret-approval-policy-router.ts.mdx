---
title: "secret-approval-policy-router.ts"
---

## High-level description
This file defines the router for managing Secret Approval Policies (SAP) in a FastifyZod server. It includes routes for creating, updating, deleting, and retrieving SAPs, with appropriate authentication and rate limiting.

## Code Structure
The file exports a single function `registerSecretApprovalPolicyRouter` that sets up five routes on the server: POST /, PATCH /:sapId, DELETE /:sapId, GET /, and GET /board. Each route is defined with its URL, method, rate limit, schema, authentication, and handler.

## References
- `@app/lib/fn`: For `removeTrailingSlash` function
- `@app/lib/types`: For `EnforcementLevel` enum
- `@app/server/config/rateLimiter`: For `readLimit` and `writeLimit`
- `@app/server/plugins/auth/verify-auth`: For `verifyAuth` function
- `@app/server/routes/sanitizedSchemas`: For `sapPubSchema`
- `@app/services/auth/auth-type`: For `AuthMode` enum

## Symbols

### `registerSecretApprovalPolicyRouter`
#### Description
This async function registers routes for managing Secret Approval Policies on the provided FastifyZod server.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| server | FastifyZodProvider | The server instance to register routes on |

#### Internal Logic
1. Defines five routes: POST /, PATCH /:sapId, DELETE /:sapId, GET /, and GET /board
2. Each route is configured with:
   - URL and HTTP method
   - Rate limiting
   - Request/response schema validation using Zod
   - Authentication using JWT
   - A handler function that calls the appropriate service method

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| nanoid | Generating unique IDs |
| zod | Schema validation |
| @app/lib/fn | Utility functions |
| @app/lib/types | Type definitions |
| @app/server/config/rateLimiter | Rate limiting configuration |
| @app/server/plugins/auth/verify-auth | Authentication middleware |
| @app/server/routes/sanitizedSchemas | Sanitized response schemas |
| @app/services/auth/auth-type | Authentication type definitions |

## Error Handling
The code uses Zod for input validation, which will throw errors for invalid inputs. The `verifyAuth` middleware handles authentication errors.

## API/Interface Reference
| Endpoint | Method | Request | Response | Description |
|:---------|:-------|:--------|:---------|:------------|
| / | POST | SAP creation data | Created SAP | Create a new Secret Approval Policy |
| /:sapId | PATCH | SAP update data | Updated SAP | Update an existing Secret Approval Policy |
| /:sapId | DELETE | sapId in params | Deleted SAP | Delete a Secret Approval Policy |
| / | GET | workspaceId in query | Array of SAPs | Get all SAPs for a workspace |
| /board | GET | workspaceId, environment, secretPath in query | SAP (if exists) | Get SAP for a specific folder |

Each route uses JWT authentication and has rate limiting applied. The schemas for request bodies and responses are defined using Zod, ensuring type safety and validation.