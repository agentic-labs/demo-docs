---
title: "ldap-router.ts"
---

## High-level description
This code defines a router for LDAP (Lightweight Directory Access Protocol) authentication and configuration in a FastifyZodProvider server. It implements routes for LDAP login, configuration management, group mapping, and connection testing.

## Code Structure
The code is structured as a module that exports a single function `registerLdapRouter`. This function sets up various routes related to LDAP functionality, including authentication, configuration management, and group mapping.

## Symbols

### `registerLdapRouter`
#### Description
This is the main function that registers all LDAP-related routes with the FastifyZodProvider server.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| server | FastifyZodProvider | The Fastify server instance with Zod schema validation |

#### Internal Logic
1. Initializes Passport for LDAP authentication
2. Sets up LDAP strategy for authentication
3. Defines routes for LDAP login, configuration management, and group mapping
4. Implements rate limiting and authentication checks for routes

### LDAP Login Route
#### Description
Handles LDAP authentication and login process.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| organizationSlug | string | The organization slug for LDAP configuration |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| nextUrl | string | URL for the next step in the authentication process |

### LDAP Configuration Routes
#### Description
Implements CRUD operations for LDAP configurations.

#### Endpoints
1. GET `/config`: Retrieve LDAP configuration
2. POST `/config`: Create new LDAP configuration
3. PATCH `/config`: Update existing LDAP configuration

### LDAP Group Mapping Routes
#### Description
Manages LDAP group mappings.

#### Endpoints
1. GET `/config/:configId/group-maps`: Retrieve group mappings
2. POST `/config/:configId/group-maps`: Create new group mapping
3. DELETE `/config/:configId/group-maps/:groupMapId`: Delete group mapping

### Test LDAP Connection Route
#### Description
Tests the LDAP connection using the provided configuration.

#### Endpoint
POST `/config/:configId/test-connection`

## Dependencies
- @fastify/passport: For LDAP authentication
- @fastify/session: For session management
- passport-ldapauth: LDAP strategy for Passport
- zod: For schema validation

## Error Handling
The code uses try-catch blocks and FastifyZodProvider's built-in error handling. Specific errors like `BadRequestError` are used for invalid requests.

## Logging
The code uses a `logger` object for error logging, particularly in the LDAP authentication strategy.

## API/Interface Reference
The module exposes a single function `registerLdapRouter` which should be called with a FastifyZodProvider server instance to set up all LDAP-related routes.