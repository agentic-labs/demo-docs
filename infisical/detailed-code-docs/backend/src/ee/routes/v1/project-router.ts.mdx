---
title: "project-router.ts"
---

## High-level description
This code defines a router for project-related operations in a FastifyZod server. It includes routes for managing secret snapshots, audit logs, KMS (Key Management Service) operations, and project migration. The router implements various endpoints with authentication, rate limiting, and input validation.

## Code Structure
The main function `registerProjectRouter` sets up multiple routes on the provided server instance. Each route is defined with its HTTP method, URL, rate limiting, schema validation, authentication, and handler function. The routes interact with various services like snapshot, auditLog, and project to perform operations.

## References
- `@app/db/schemas`: AuditLogsSchema, SecretSnapshotsSchema
- `@app/ee/services/audit-log/audit-log-types`: EventType, UserAgentType
- `@app/lib/api-docs`: AUDIT_LOGS, PROJECTS
- `@app/lib/fn`: getLastMidnightDateISO, removeTrailingSlash
- `@app/server/config/rateLimiter`: readLimit, writeLimit
- `@app/server/plugins/auth/verify-auth`: verifyAuth
- `@app/services/auth/auth-type`: AuthMode
- `@app/services/kms/kms-types`: KmsType

## Symbols

### `registerProjectRouter`
#### Description
This async function registers multiple routes related to project operations on the provided FastifyZod server instance.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| server | FastifyZodProvider | The server instance to register routes on |

#### Internal Logic
1. Defines multiple routes using `server.route()` method
2. Each route specifies HTTP method, URL, rate limiting, schema validation, authentication, and handler function
3. Routes interact with various services (snapshot, auditLog, project) to perform operations

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| zod | Schema validation for request parameters, query strings, and responses |
| @fastify/rate-limit | Rate limiting for API endpoints |

## Error Handling
Error handling is not explicitly implemented in this file. It relies on Fastify's built-in error handling mechanisms and any global error handlers that might be set up elsewhere in the application.

## API/Interface Reference
| Endpoint | Method | Description |
|:---------|:-------|:------------|
| /:workspaceId/secret-snapshots | GET | Retrieve project secret snapshots |
| /:workspaceId/secret-snapshots/count | GET | Get count of project secret snapshots |
| /:workspaceId/audit-logs | GET | Retrieve audit logs for a project |
| /:workspaceId/audit-logs/filters/actors | GET | Get actors for audit log filtering |
| /:workspaceId/kms | GET | Retrieve KMS key information for a project |
| /:workspaceId/kms | PATCH | Update KMS key for a project |
| /:workspaceId/kms/backup | GET | Get KMS backup for a project |
| /:workspaceId/kms/backup | POST | Load KMS backup for a project |
| /:workspaceId/migrate-v3 | POST | Start secret migration to v3 for a project |

Each endpoint has specific schema validation for request parameters, query strings, and responses, as well as authentication and rate limiting configurations.