---
title: "secret-scanner.ts"
---

## High-level description
This code registers a GitHub App using Probot that listens for specific webhook events related to secret scanning. It handles events like installation, repository deletion, and pushes to repositories. 

The app verifies incoming webhooks from GitHub and processes them using the appropriate service methods from the `server.services.secretScanning` object.

## Code Structure
The code defines a single asynchronous function `registerSecretScannerGhApp` which takes a `FastifyZodProvider` instance as input. Inside this function, it defines a Probot app and configures its behavior for different GitHub webhook events. It also sets up a webhook route to receive and verify incoming webhooks from GitHub.

## References
- `server.services.secretScanning`: This object appears to provide methods for handling secret scanning events.
- `getConfig()`: This function likely retrieves configuration settings for the application.

## Symbols

### `registerSecretScannerGhApp`
#### Description
This asynchronous function registers a GitHub App that listens for specific webhook events related to secret scanning and processes them.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| server | FastifyZodProvider | An instance of FastifyZodProvider, likely providing access to the server and its services. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| (implicit) | Promise&lt;void&gt; | A promise that resolves when the GitHub app is successfully registered and the webhook route is set up. |

#### Internal Logic
1. **Check if secret scanning is configured:** Retrieves the application configuration using `getConfig()` and checks if the `isSecretScanningConfigured` flag is set. If not, the function exits early.
2. **Initialize Probot app:** Creates a new Probot instance with the app ID, private key, and webhook secret from the configuration.
3. **Configure webhook proxy for development:** If running in a development environment, sets up a Smee client to proxy incoming webhooks from GitHub to the local development server.
4. **Load Probot app with event handlers:** Loads the Probot app with event handlers defined in the `probotApp` function.
5. **Register webhook route:** Defines a POST route at the root path ("/") to receive incoming webhooks from GitHub.
    - Sets a rate limit for the route using `writeLimit`.
    - Extracts event details (event name, signature, delivery ID) from the request headers.
    - Verifies the webhook signature using `probot.webhooks.verifyAndReceive`.
    - Processes the webhook payload using the appropriate event handler defined in the Probot app.
    - Sends an "ok" response back to GitHub.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| @octokit/webhooks-types | Provides types for GitHub webhook events. |
| probot | Framework for building GitHub Apps. |
| smee-client |  A client for the Smee.io webhook proxy service. |
| @app/lib/config/env | Provides access to application configuration settings. |
| @app/lib/logger | Provides logging functionality. |
| @app/server/config/rateLimiter | Provides rate limiting configuration. |

## Error Handling
The code does not implement specific error handling beyond basic exception raising. Any errors during webhook verification or processing will likely result in exceptions being thrown.

## Logging
The code logs an informational message when the secret scanner is installed to a repository.

## API/Interface Reference
This code defines a single POST endpoint for receiving webhooks from GitHub:

| Endpoint | Method | Request | Response | Description |
|:---------|:-------|:--------|:---------|:------------|
| / | POST | Webhook payload from GitHub | `ok` | Receives and processes incoming webhooks related to secret scanning events. |

The endpoint expects the following headers:
- `x-github-event`: The name of the GitHub event.
- `x-hub-signature-256`: The SHA256 signature of the webhook payload.
- `x-github-delivery`: The delivery ID of the webhook.
