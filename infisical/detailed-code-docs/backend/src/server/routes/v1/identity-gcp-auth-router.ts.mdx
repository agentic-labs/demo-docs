---
title: "identity-gcp-auth-router.ts"
---

## High-level description
This code defines an express router that handles routes related to GCP authentication for identities. It includes routes for logging in with GCP auth, attaching, updating, retrieving, and revoking GCP auth configurations for identities.

## Code Structure
The `registerIdentityGcpAuthRouter` function takes a FastifyZodProvider instance and registers multiple routes related to GCP authentication. Each route is defined using the `server.route` method and handles a specific HTTP method and URL pattern. The routes interact with the `server.services.identityGcpAuth` service to perform operations like login, attach, update, get, and revoke GCP auth configurations. Additionally, the routes utilize the `server.services.auditLog` service to record audit logs for each operation.

## References
- `IdentityGcpAuthsSchema`: Used to validate and define the schema for GCP Auth configuration.
- `EventType`: Used to specify the type of event being logged in the audit log.
- `GCP_AUTH`: Contains API documentation details for GCP Auth routes.
- `readLimit`, `writeLimit`: Rate limit configurations for read and write operations.
- `verifyAuth`: Middleware for verifying authentication and authorization.
- `AuthMode`: Defines different authentication modes.
- `TIdentityTrustedIp`: Defines the type for trusted IP addresses.
- `validateGcpAuthField`: A validation function for GCP Auth fields.

## Symbols

### `registerIdentityGcpAuthRouter`
#### Description
This function registers routes for managing GCP authentication for identities. It defines routes for login, attaching, updating, retrieving, and revoking GCP auth configurations.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| server | FastifyZodProvider | An instance of FastifyZodProvider |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| void | void | The function does not return any value |

#### Internal Logic
The function defines multiple routes using `server.route` for different GCP auth operations. Each route handler interacts with the `server.services.identityGcpAuth` and `server.services.auditLog` services to perform the requested operation and log the event.

#### Side Effects
- Registers multiple routes on the provided FastifyZodProvider instance.
- Creates audit logs for each GCP auth operation.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| z | Used for schema validation using Zod |
| @app/db/schemas | Provides the `IdentityGcpAuthsSchema` |
| @app/ee/services/audit-log/audit-log-types | Provides the `EventType` enum |
| @app/lib/api-docs | Provides API documentation details |
| @app/server/config/rateLimiter | Provides rate limit configurations |
| @app/server/plugins/auth/verify-auth | Provides authentication middleware |
| @app/services/auth/auth-type | Provides the `AuthMode` enum |
| @app/services/identity/identity-types | Provides the `TIdentityTrustedIp` type |
| @app/services/identity-gcp-auth/identity-gcp-auth-validators | Provides the `validateGcpAuthField` function |

## Error Handling
The code does not implement specific error handling beyond basic exception raising.

## Logging
The code utilizes the `server.services.auditLog` service to create audit logs for each GCP auth operation. The logs include the event type, metadata about the operation, and information about the actor performing the operation.
