---
title: "secret-tag-router.ts"
---

## High-level description
This code defines API routes for managing secret tags within a project. It allows users to list, retrieve, create, update, and delete tags, enforcing authorization and rate limits for each operation.

## Code Structure
The code defines a single function `registerSecretTagRouter` which takes a `FastifyZodProvider` instance as input. This function sets up multiple routes for handling different HTTP methods and endpoints related to secret tags. Each route is defined using `server.route` and includes schema validation, authentication checks, and a handler function to process the request.

## References
- `SecretTagsSchema`: Defines the schema for secret tag objects.
- `SECRET_TAGS`: Likely contains API documentation constants for describing the routes.
- `readLimit`, `writeLimit`: Rate limit configurations for read and write operations.
- `verifyAuth`: Middleware for verifying user authentication and authorization.
- `AuthMode`: Enum for different authentication methods.

## Symbols
### `registerSecretTagRouter`
#### Description
Registers API routes for managing secret tags within a project.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| server | FastifyZodProvider | An instance of the Fastify server with Zod validation. |

#### Outputs
This function does not return any value.

#### Internal Logic
The function defines multiple routes using `server.route` for the following operations:
- **GET /:projectId/tags**: Lists all tags for a given project.
- **GET /:projectId/tags/:tagId**: Retrieves a tag by its ID.
- **GET /:projectId/tags/slug/:tagSlug**: Retrieves a tag by its slug.
- **POST /:projectId/tags**: Creates a new tag.
- **PATCH /:projectId/tags/:tagId**: Updates an existing tag.
- **DELETE /:projectId/tags/:tagId**: Deletes a tag.

Each route definition includes:
- **method**: HTTP method for the route.
- **url**: Route path.
- **config**: Optional configuration, including rate limits.
- **schema**: Zod schema for validating request parameters, body, and response.
- **onRequest**: Middleware for authentication, using `verifyAuth`.
- **handler**: Asynchronous function to handle the request, interacting with the `server.services.secretTag` service to perform the requested operation.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| "@sindresorhus/slugify" | Used for slugifying tag names. |
| "zod" | Used for schema validation. |
| "@app/db/schemas" | Provides the `SecretTagsSchema` for data validation. |
| "@app/lib/api-docs" | Likely contains API documentation constants. |
| "@app/server/config/rateLimiter" | Provides rate limit configurations. |
| "@app/server/plugins/auth/verify-auth" | Provides authentication middleware. |
| "@app/services/auth/auth-type" | Provides the `AuthMode` enum. |

## Error Handling
The code relies on Fastify's built-in error handling mechanism. Zod schemas validate incoming requests, and any validation errors will result in a 400 Bad Request response. Authentication failures will result in a 401 Unauthorized response. Other errors during processing will likely result in a 500 Internal Server Error response.

## API/Interface Reference
This code defines a REST API for managing secret tags.

| Endpoint | Method | Request | Response | Description |
|:---------|:-------|:--------|:---------|:------------|
| /:projectId/tags | GET |  | `200 OK`: Array of `SecretTagsSchema` | Lists all tags for a project. |
| /:projectId/tags/:tagId | GET |  | `200 OK`: `SecretTagsSchema` | Retrieves a tag by ID. |
| /:projectId/tags/slug/:tagSlug | GET |  | `200 OK`: `SecretTagsSchema` | Retrieves a tag by slug. |
| /:projectId/tags | POST | `body`: `{ slug: string, color: string }` | `200 OK`: Created `SecretTagsSchema` | Creates a new tag. |
| /:projectId/tags/:tagId | PATCH | `body`: `{ slug: string, color: string }` | `200 OK`: Updated `SecretTagsSchema` | Updates an existing tag. |
| /:projectId/tags/:tagId | DELETE |  | `200 OK`: Deleted `SecretTagsSchema` | Deletes a tag. |

All endpoints require authentication using either JWT or Identity Access Token.
