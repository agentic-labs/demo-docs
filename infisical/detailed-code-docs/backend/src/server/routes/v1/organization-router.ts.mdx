---
title: "organization-router.ts"
---

## High-level description
This code defines the API routes for managing organizations within the application. It handles requests related to retrieving, updating, and interacting with organization data, including users, incident contacts, and groups. 

The routes are secured using JWT authentication and implement rate limiting to prevent abuse.

## Code Structure
The `registerOrgRouter` function registers multiple routes related to organization management. Each route is defined using the `server.route` method and includes a method, URL, schema, authentication requirements, and a handler function. The handler functions interact with the application's services to perform the requested actions.

## References
- `@app/db/schemas`: This module likely contains the Zod schemas used for validating request and response data.
- `@app/lib/api-docs`: This module likely contains documentation strings used for generating API documentation.
- `@app/server/config/rateLimiter`: This module likely defines the rate limiting configuration for the API routes.
- `@app/server/plugins/auth/verify-auth`: This module likely contains the authentication middleware used to verify user access.
- `@app/services/auth/auth-type`: This module likely defines the different authentication modes supported by the application.

## Symbols

### `registerOrgRouter`
#### Description
This function registers all the API routes related to organization management. It defines the routes for retrieving, updating, and interacting with organization data.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| server | FastifyZodProvider | The Fastify server instance with Zod validation plugin. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| None | void | This function does not return any value. |

#### Internal Logic
The function defines multiple routes using `server.route` method. Each route definition includes:
- **method**: HTTP method for the route (GET, POST, PATCH, DELETE).
- **url**: The URL path for the route.
- **config**: Configuration options for the route, such as rate limiting.
- **schema**: Zod schemas for validating request parameters, body, and response data.
- **onRequest**: Middleware functions executed before the handler, such as authentication.
- **handler**: The function executed to handle the request.

The handler functions typically interact with the application's services to perform actions like retrieving data from the database, updating records, or performing business logic.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| z | Zod library for schema validation. |
| FastifyZodProvider | Fastify plugin for Zod integration. |
| @app/db/schemas | Module containing database schemas. |
| @app/lib/api-docs | Module containing API documentation strings. |
| @app/server/config/rateLimiter | Module defining rate limiting configuration. |
| @app/server/plugins/auth/verify-auth | Module containing authentication middleware. |
| @app/services/auth/auth-type | Module defining authentication modes. |

## Error Handling
The code does not explicitly define error handling mechanisms. It's assumed that the underlying services and middleware handle errors appropriately, potentially by throwing exceptions that are caught and processed by Fastify's error handling mechanism.

## Logging
The code does not include explicit logging statements. It's assumed that logging is handled by the underlying services or middleware.

## API/Interface Reference
This code defines the following API endpoints for managing organizations:

| Endpoint | Method | Request | Response | Description |
|:---------|:-------|:--------|:---------|:------------|
| / | GET | None | `{ organizations: Organization[] }` | Retrieves all organizations the authenticated user is a member of. |
| /:organizationId | GET | None | `{ organization: Organization }` | Retrieves a specific organization by ID. |
| /:organizationId/users | GET | None | `{ users: (OrgMembership & { user: User })[] }` | Retrieves all users belonging to a specific organization. |
| /:organizationId | PATCH | `{ name?: string, slug?: string, authEnforced?: boolean, scimEnabled?: boolean }` | `{ message: string, organization: Organization }` | Updates a specific organization's information. |
| /:organizationId/incidentContactOrg | GET | None | `{ incidentContactsOrg: IncidentContact[] }` | Retrieves incident contacts for a specific organization. |
| /:organizationId/incidentContactOrg | POST | `{ email: string }` | `{ incidentContactsOrg: IncidentContact }` | Creates a new incident contact for a specific organization. |
| /:organizationId/incidentContactOrg/:incidentContactId | DELETE | None | `{ incidentContactsOrg: IncidentContact }` | Deletes an incident contact from a specific organization. |
| /:organizationId/groups | GET | None | `{ groups: (Group & { customRole?: OrgRole })[] }` | Retrieves all groups belonging to a specific organization. |

**Note:** All endpoints require JWT authentication. The specific permissions required for each endpoint are not explicitly defined in the code.
