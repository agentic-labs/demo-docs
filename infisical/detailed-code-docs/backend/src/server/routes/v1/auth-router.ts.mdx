---
title: "auth-router.ts"
---

## High-level description
The code defines routes for user authentication and authorization using JWT (JSON Web Tokens). It handles user logout, token refresh, and authentication checks.

## Code Structure
The `registerAuthRoutes` function takes a Fastify server instance as input and defines several routes related to authentication: `/logout`, `/checkAuth`, and `/token`. Each route handler interacts with services like `login` and `authToken` to perform authentication-related tasks.

## References
- `getConfig`: A function to retrieve application configuration.
- `BadRequestError`, `UnauthorizedError`: Custom error classes for HTTP errors.
- `authRateLimit`, `writeLimit`: Rate limiting configurations.
- `verifyAuth`: An authentication middleware.
- `AuthMode`, `AuthModeRefreshJwtTokenPayload`, `AuthTokenType`: Enums and types related to authentication.

## Symbols
### `registerAuthRoutes`
#### Description
This function registers routes related to user authentication and authorization on the Fastify server.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| server | FastifyZodProvider | An instance of the Fastify server with Zod validation. |

#### Outputs
This function does not return any value.

#### Internal Logic
1. **`/logout` Route (POST):**
    - Requires JWT authentication.
    - Logs the user out by clearing the JWT token cookie and invalidating the token in the database.
2. **`/checkAuth` Route (POST):**
    - Requires JWT authentication.
    - Returns a success message if the user is authenticated.
3. **`/token` Route (POST):**
    - Refreshes the access token using the refresh token provided in the `jid` cookie.
    - Verifies the refresh token, retrieves token version information, and generates a new access token.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| `jwt` | Used for JWT token generation and verification. |
| `zod` | Used for request/response validation. |
| `@app/lib/config/env` | Provides access to application configuration. |
| `@app/lib/errors` | Provides custom error classes. |
| `@app/server/config/rateLimiter` | Provides rate limiting configurations. |
| `@app/server/plugins/auth/verify-auth` | Provides authentication middleware. |
| `@app/services/auth/auth-type` | Provides enums and types related to authentication. |

## Error Handling
The code uses custom error classes `BadRequestError` and `UnauthorizedError` to handle invalid requests and unauthorized access attempts.

## API/Interface Reference
| Endpoint | Method | Request | Response | Description |
|:---------|:-------|:--------|:---------|:------------|
| /logout | POST | None | `{ "message": "Successfully logged out" }` | Logs the user out and clears the authentication cookie. Requires JWT authentication. |
| /checkAuth | POST | None | `{ "message": "Authenticated" }` | Checks if the user is authenticated. Requires JWT authentication. |
| /token | POST | None | `{ "token": "string" }` | Refreshes the access token using the refresh token provided in the `jid` cookie. |
