---
title: "secret-router.ts"
---

## High-level description
This code defines a set of API routes for managing secrets within a project. It handles operations like creating, retrieving, updating, deleting, and moving secrets, both individually and in batches. The routes implement authentication, authorization, rate limiting, audit logging, and telemetry.

## Code Structure
The code defines a single function `registerSecretRouter` which takes a `FastifyZodProvider` instance as input. This function then defines various routes using the `server.route` method. Each route is associated with a specific HTTP method, URL, and handler function. The routes are responsible for handling different secret management operations.

## References
This code references several other modules and services:
- `@app/db/schemas`: Used for data validation and schema definitions.
- `@app/ee/services/audit-log/audit-log-types`: Used for audit logging events and metadata.
- `@app/lib/api-docs`: Used for API documentation strings.
- `@app/lib/errors`: Used for custom error handling.
- `@app/lib/fn`: Used for utility functions.
- `@app/server/config/rateLimiter`: Used for rate limiting configurations.
- `@app/server/lib/telemetry`: Used for telemetry data collection.
- `@app/server/plugins/audit-log`: Used for audit logging functionality.
- `@app/server/plugins/auth/verify-auth`: Used for authentication and authorization.
- `@app/services/auth/auth-type`: Used for authentication types and modes.
- `@app/services/project/project-types`: Used for project filtering options.
- `@app/services/secret/secret-types`: Used for secret operation types and protection levels.
- `@app/services/telemetry/telemetry-types`: Used for telemetry event types.

## Symbols

### `registerSecretRouter`
#### Description
This function registers all the API routes related to secret management. It defines routes for creating, retrieving, updating, deleting, and moving secrets. It also handles authentication, authorization, rate limiting, audit logging, and telemetry for each route.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| server | FastifyZodProvider | An instance of FastifyZodProvider, which is used to define routes and their schemas. |

#### Outputs
This function does not return any value.

#### Internal Logic
The function iterates through various route definitions, each with its own HTTP method, URL, schema, and handler. Each route handler interacts with the `server.services` object to perform operations like database interactions, audit logging, and telemetry.

## Side Effects
- **Database Modifications:** The routes can create, update, and delete secrets in the database.
- **Audit Logs:** Each route generates audit logs for the corresponding secret operation.
- **Telemetry Events:** The routes send telemetry events to track secret operations.

## Dependencies
- `picomatch`: Used for glob pattern matching.
- `zod`: Used for data validation and schema definitions.
- `fastify`: Used for creating the API server and defining routes.

## Error Handling
The code uses custom error classes like `BadRequestError` to handle invalid requests and other error scenarios.

## Logging
The code utilizes the `server.services.auditLog` service to create audit logs for each secret operation.

## API/Interface Reference
This code defines a REST API for managing secrets. The API endpoints, methods, and request/response formats are defined within the `server.route` definitions. The API uses bearer token authentication for security.
