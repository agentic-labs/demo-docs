---
title: "issueBackupKey.ts"
---

## High-level description
This code implements a function `issueBackupKey` that generates and issues a backup key for a user. It uses the Secure Remote Password (SRP) protocol for authentication and AES-256-GCM encryption to secure the user's private key.

## Code Structure
The main function `issueBackupKey` orchestrates the process of generating and issuing a backup key. It uses the `jsrp` library for SRP authentication, `crypto` for generating random bytes, and custom `Aes256Gcm` encryption. The function also interacts with API endpoints for SRP authentication and issuing the backup key.

## References
- `@app/hooks/api/auth/queries`: Used for API calls (`srp1`, `issueBackupPrivateKey`)
- `../generateBackupPDF`: Used to generate a PDF with the backup key information
- `./aes-256-gcm`: Used for AES-256-GCM encryption

## Symbols

### issueBackupKey
#### Description
This asynchronous function handles the process of issuing a backup key for a user. It performs SRP authentication, generates a new key, encrypts the user's private key, and issues the backup key through an API call.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| email | string | User's email address |
| password | string | User's current password |
| personalName | string | User's personal name |
| setBackupKeyError | function | Function to set error state |
| setBackupKeyIssued | function | Function to set success state |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | boolean | Always returns true |

#### Internal Logic
1. Initialize SRP client with user credentials
2. Perform SRP1 authentication
3. Generate a new random key
4. Create a new SRP verifier with the generated key
5. Encrypt the user's private key using AES-256-GCM
6. Issue the backup private key through an API call
7. Generate a backup PDF with key information
8. Update state based on success or failure

## Side Effects
- Modifies state through `setBackupKeyError` and `setBackupKeyIssued` functions
- Generates a PDF file with backup key information
- Makes API calls for SRP authentication and issuing backup key

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| crypto | For generating random bytes |
| jsrp | For Secure Remote Password (SRP) protocol implementation |
| @app/hooks/api/auth/queries | For API calls related to authentication |
| ../generateBackupPDF | For generating a PDF with backup key information |
| ./aes-256-gcm | For AES-256-GCM encryption |

## Error Handling
The function uses try-catch blocks to handle errors. If an error occurs, it sets the error state using `setBackupKeyError(true)` and logs the error to the console.

## Performance Considerations
The function involves cryptographic operations and API calls, which can be computationally intensive and time-consuming. It's important to consider the impact on user experience, especially on less powerful devices or slow network connections.